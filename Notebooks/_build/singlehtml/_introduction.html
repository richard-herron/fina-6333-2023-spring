

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>FINA 6333</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_introduction';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="#">
  
  
  
  
    
    
      
    
    
    <img src="_static/DMSB_100th_LogoMark_CMYK_Horiz.jpg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/DMSB_100th_LogoMark_CMYK_Horiz.jpg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures and Practice</span></p>
<ul class="nav bd-sidenav">














</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quizzes</span></p>
<ul class="nav bd-sidenav">







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul class="nav bd-sidenav">





</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/richard-herron/fina-6333-2023-spring" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/richard-herron/fina-6333-2023-spring/issues/new?title=Issue%20on%20page%20%2F_introduction.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Introduction</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures and Practice</span></p>
<ul class="visible nav section-nav flex-column">
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_lecture">McKinney Chapter 2 - Python Language Basics, IPython, and Jupyter Notebooks</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_practice">McKinney Chapter 2 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_practice_03">McKinney Chapter 2 - Practice (Section 3, Monday 2:45 PM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_practice_04">McKinney Chapter 2 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_practice_02">McKinney Chapter 2 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_03_lecture">McKinney Chapter 3 - Built-In Data Structures, Functions, and Files</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_03_practice">McKinney Chapter 3 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_03_practice_04">McKinney Chapter 3 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_03_practice_02">McKinney Chapter 3 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_lecture">McKinney Chapter 4 - NumPy Basics: Arrays and Vectorized Computation</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_practice">McKinney Chapter 4 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_practice_03">McKinney Chapter 4 - Practice (Section 3, Monday 2:45 PM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_practice_04">McKinney Chapter 4 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_practice_02">McKinney Chapter 4 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_lecture">McKinney Chapter 5 - Getting Started with pandas</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_practice">McKinney Chapter 5 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_practice_03">McKinney Chapter 5 - Practice (Section 3, Monday 2:45 PM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_practice_04">McKinney Chapter 5 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_practice_02">McKinney Chapter 5 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_lecture">Herron Topic 1 - Web Data, Log and Simple Returns, and Portfolio Math</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_practice">Herron Topic 1 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_practice_03">Herron Topic 1 - Practice (Section 3, Monday 2:45 PM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_practice_04">Herron Topic 1 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_practice_02">Herron Topic 1 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_lecture">McKinney Chapter 8 - Data Wrangling: Join, Combine, and Reshape</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_practice">McKinney Chapter 8 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_practice_03">McKinney Chapter 8 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_practice_04">McKinney Chapter 8 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_practice_02">McKinney Chapter 8 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_10_lecture">McKinney Chapter 10 - Data Aggregation and Group Operations</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_10_practice">McKinney Chapter 10 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_10_practice_all">McKinney Chapter 10 - Practice (All Sections)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_lecture">McKinney Chapter 11 - Time Series</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_practice">McKinney Chapter 11 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_practice_03">McKinney Chapter 11 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_practice_04">McKinney Chapter 11 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_practice_02">McKinney Chapter 11 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_lecture">Herron Topic 2 - Trading Strategies</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_practice">Herron Topic 2 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_practice_03">Herron Topic 2 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_practice_04">Herron Topic 2 - Practice (Monday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_practice_02">Herron Topic 2 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_lecture">Herron Topic 3 - Multifactor Models</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_practice">Herron Topic 3 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_practice_03">Herron Topic 3 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_practice_04">Herron Topic 3 - Practice (Monday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_practice_02">Herron Topic 3 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_lecture">Herron Topic 4 - Portfolio Optimization</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_practice">Herron Topic 4 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_practice_03">Herron Topic 4 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_practice_04">Herron Topic 4 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_practice_02">Herron Topic 4 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_lecture">Herron Topic 5 - Simulations</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_practice">Herron Topic 5 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_practice_03">Herron Topic 5 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_practice_04">Herron Topic 5 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_practice_02">Herron Topic 5 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_lecture">Herron Topic 6 - Size, Value, and Momentum Investing</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_practice">Herron Topic 6 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_practice_03">Herron Topic 6 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_practice_04">Herron Topic 6 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_practice_02">Herron Topic 6 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_lecture">Herron Topic 7 - Five Stylized Facts of Asset Returns</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_practice">Herron Topic 7 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_practice_03">Herron Topic 7 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_practice_04">Herron Topic 7 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_practice_02">Herron Topic 7 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quizzes</span></p>
<ul class="nav section-nav flex-column">
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_01">Quiz 1</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_02">Quiz 2</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_03">Quiz 3</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_04">Quiz 4</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_05">Quiz 5</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_06">Quiz 6</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_07">Quiz 7</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul class="nav section-nav flex-column">
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-project_01">Project 1</a><ul class="nav section-nav flex-column">
<li class="toctree-l2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-project_01_solution">Project 1 Solution</a></li>
<li class="toctree-l2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#purpose">Purpose</a></li>
<li class="toctree-l2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#tasks">Tasks</a></li>
<li class="toctree-l2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#criteria">Criteria</a></li>
</ul>
</li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-project_02">Project 2</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#purpose">Purpose</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#tasks">Tasks</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#criteria">Criteria</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h1>
<p>Welcome to FINA 6333 for Spring 2023!</p>
<section id="website">
<h2>Website<a class="headerlink" href="#website" title="Permalink to this heading">#</a></h2>
<p>I will maintain our notebooks on this website because Canvas does not render notebooks.
This website renders our notebooks and offers several ways to interact:</p>
<ol class="arabic simple">
<li><p>Open and run them on an <em>ad hoc</em> JupyterLab server by clicking the rocket in the upper-right corner of each page (this page is not a notebook, so you cannot open and run it)</p></li>
<li><p>Download them by clicking the down arrow in the upper-right corner of each page</p></li>
<li><p>Visit their GitHub repository by clicking the cat in the upper-right corner of each page</p></li>
</ol>
<p>This GitHub repository (<a class="github reference external" href="https://github.com/richard-herron/fina-6333-2023-spring">richard-herron/fina-6333-2023-spring</a>) also generates this website.
If GitHub intimidates you, you can ignore our GitHub repository and download our notebooks one at a time, as I describe above in option 1.
If GitHub does not intimidate you, you can use our GitHub repository in a few ways:</p>
<ol class="arabic simple">
<li><p>Fork it and maintain a personal repository that you update throughout the semester</p></li>
<li><p>Create issues for each notebook when you have questions and comments</p></li>
</ol>
</section>
<section id="notebooks">
<h2>Notebooks<a class="headerlink" href="#notebooks" title="Permalink to this heading">#</a></h2>
<p>Each course topic has one notebook for its lecture and one for its practice exercises.
So we will typically have one notebook per chapter in <span id="id1">McKinney [<a class="reference internal" href="#id4" title="Wes McKinney. Python for Data Analysis. O'Reilly Media, Inc., third edition, 2022. https://wesmckinney.com/book/.">McK22</a>]</span> and <span id="id2">Welch [<a class="reference internal" href="#id5" title="Ivo Welch. Corporate Finance. Ivo Welch, fifth edition, 2022. https://book.ivo-welch.info/home/.">Wel22</a>]</span>.
I plan to “flip the classroom” this semester, which means:</p>
<ol class="arabic simple">
<li><p>Each week, I will record a short lecture based on the lecture notebook</p></li>
<li><p>Before class, you will watch this short lecture, review the lecture notebook, and read the textbook</p></li>
<li><p>During class, we will work through the practice exercise notebook together</p></li>
<li><p>After class, I will update and post these notebooks, and you will complete DataCamp courses, quizzes, and projects to reinforce what we learn</p></li>
</ol>
<p>I will maintain these notebooks on this website but everything else on Canvas (and Gradescope).</p>
</section>
<section id="jupyterlab">
<h2>JupyterLab<a class="headerlink" href="#jupyterlab" title="Permalink to this heading">#</a></h2>
<p>I suggest you run JupyterLab on Research Computing’s Open OnDemand (OOD) service: <a class="reference external" href="https://ood.discovery.neu.edu">https://ood.discovery.neu.edu</a>.
This service is fast, reliable, available everywhere, and can access a shared folder of course notebooks.
You can log into OOD with your Northeastern username and password and start a JupyterLab session under “My Interactive Sessions”.</p>
<p>You can also install Anaconda on your laptop to run JupyterLab or use DataCamp Workspaces.
There are more ways to run JupyterLab and even more ways to interact with Python, and I am happy to help you during office hours.
However, we will only use JupyterLab in class, and OOD is the easiest way to use JupyterLab.</p>
<p><em><strong>Update:</strong></em> Halfway through the semester, OOD has proven to be slow and unreliable at the scale of this course.
Instead, I suggest you install Anaconda on your laptop or use DataCamp Workspaces.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<div class="docutils container" id="id3">
<div class="citation" id="id4" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">McK22</a><span class="fn-bracket">]</span></span>
<p>Wes McKinney. <em>Python for Data Analysis</em>. O'Reilly Media, Inc., third edition, 2022. <a class="reference external" href="https://wesmckinney.com/book/">https://wesmckinney.com/book/</a>.</p>
</div>
<div class="citation" id="id5" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">Wel22</a><span class="fn-bracket">]</span></span>
<p>Ivo Welch. <em>Corporate Finance</em>. Ivo Welch, fifth edition, 2022. <a class="reference external" href="https://book.ivo-welch.info/home/">https://book.ivo-welch.info/home/</a>.</p>
</div>
</div>
</div>
</section>
<div class="toctree-wrapper compound">
<span id="document-mckinney_02_lecture"></span><section id="mckinney-chapter-2-python-language-basics-ipython-and-jupyter-notebooks">
<h2>McKinney Chapter 2 - Python Language Basics, IPython, and Jupyter Notebooks<a class="headerlink" href="#mckinney-chapter-2-python-language-basics-ipython-and-jupyter-notebooks" title="Permalink to this heading">#</a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h3>
<p>We must understand the basics of Python before we can use it to analyze financial data.
Chapter 2 of Wes McKinney’s <a class="reference external" href="https://wesmckinney.com/book/"><em>Python for Data Analysis</em></a> provides a crash course in Python’s syntax, and chapter 3 provides a crash course in Python’s built-in data structures.
This notebook focuses on the “Python Language Basics” in section 2.3, which covers language semantics, scalar types, and control flow.</p>
<p><em><strong>Note:</strong></em>
Indented block quotes are from McKinney unless otherwise indicated.
The section numbers here differ from McKinney because we will only discuss some topics.</p>
</section>
<section id="language-semantics">
<h3>Language Semantics<a class="headerlink" href="#language-semantics" title="Permalink to this heading">#</a></h3>
<section id="indentation-not-braces">
<h4>Indentation, not braces<a class="headerlink" href="#indentation-not-braces" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>Python uses whitespace (tabs or spaces) to structure code instead of using braces as in many other languages like R, C++, Java, and Perl.</p>
</div></blockquote>
<p><em><strong>So, spaces are more than cosmetic in Python.</strong></em>
For non-Python programmers, white space is often Python’s defining feature.
Here is a for loop with an if block that shows how Python uses white space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">pivot</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">less</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">greater</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">pivot</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> is less than </span><span class="si">{</span><span class="n">pivot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">less</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> is NOT less than </span><span class="si">{</span><span class="n">pivot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">greater</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 is less than 2
2 is NOT less than 2
3 is NOT less than 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">less</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">greater</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2, 3]
</pre></div>
</div>
</div>
</div>
<p><em><strong>Note:</strong></em>
We will use f-string print statements wherever we can.
These f-string print statements are easy to use, and I do not want to teach old approaches when the new ones are better.</p>
</section>
<section id="comments">
<h4>Comments<a class="headerlink" href="#comments" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>Any text preceded by the hash mark (pound sign) # is ignored by the Python interpreter. This is often used to add comments to code. At times you may also want to exclude certain blocks of code without deleting them.</p>
</div></blockquote>
<p>The Python interpreter ignores any code after a hash mark <code class="docutils literal notranslate"><span class="pre">#</span></code> on a given line.
We can quickly comment/un-comment lines of code with the <code class="docutils literal notranslate"><span class="pre">&lt;Ctrl&gt;-/</span></code> shortcut.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 5 + 5</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="function-and-object-method-calls">
<h4>Function and object method calls<a class="headerlink" href="#function-and-object-method-calls" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>You call functions using parentheses and passing zero or more arguments, optionally assigning the returned value to a variable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>Almost every object in Python has attached functions, known as methods, that have access to the object’s internal contents. You can call them using the following &gt; syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">obj</span><span class="o">.</span><span class="n">some_method</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
<p>Functions can take both positional and keyword arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>More on this later.</p>
</div></blockquote>
<p>We can write a function that adds two numbers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_numbers</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">add_numbers</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10
</pre></div>
</div>
</div>
</div>
<p>We can write a function that adds two strings separated by a space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_strings</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">add_strings</span><span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;5 5&#39;
</pre></div>
</div>
</div>
</div>
<p><em><strong>What is the difference between <code class="docutils literal notranslate"><span class="pre">print()</span></code> and <code class="docutils literal notranslate"><span class="pre">return</span></code>?</strong></em>
<code class="docutils literal notranslate"><span class="pre">print()</span></code> returns its arguments to the console or “standard output”, whereas <code class="docutils literal notranslate"><span class="pre">return</span></code> returns its argument as an output we can assign to variables.
In the example below, we use the <code class="docutils literal notranslate"><span class="pre">return</span></code> line to assign the output of <code class="docutils literal notranslate"><span class="pre">add_string_2()</span></code> to the variable <code class="docutils literal notranslate"><span class="pre">return_from_add_strings_2</span></code>.
The <code class="docutils literal notranslate"><span class="pre">print()</span></code> line prints to the console or “standard output”, but its output is not assigned or captured.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_strings_2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">string_to_print</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="s1">&#39; (this is from the print statement)&#39;</span>
    <span class="n">string_to_return</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="s1">&#39; (this is from the return statement)&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">string_to_print</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string_to_return</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returned</span> <span class="o">=</span> <span class="n">add_strings_2</span><span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5 5 (this is from the print statement)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returned</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;5 5 (this is from the return statement)&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="variables-and-argument-passing">
<h4>Variables and argument passing<a class="headerlink" href="#variables-and-argument-passing" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>When assigning a variable (or name) in Python, you are creating a reference to the object on the righthand side of the equals sign.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3]
</pre></div>
</div>
</div>
</div>
<p>If we assign <code class="docutils literal notranslate"><span class="pre">a</span></code> to a new variable <code class="docutils literal notranslate"><span class="pre">b</span></code>, both <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> refer to the <em>same</em> object.
This same object is the list <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code>.
If we change <code class="docutils literal notranslate"><span class="pre">a</span></code>, we also change <code class="docutils literal notranslate"><span class="pre">b</span></code>, because these variables or names refer to the <em>same</em> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3]
</pre></div>
</div>
</div>
</div>
<p><em><strong>Variables <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> refer to the same object, a list <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code>.</strong></em>
We will learn more about lists (and tuples and dictionaries) in chapter 3 of McKinney.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p><em><strong>If we modify <code class="docutils literal notranslate"><span class="pre">a</span></code> by appending a 4, we change <code class="docutils literal notranslate"><span class="pre">b</span></code> because <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> refer to the same list.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4]
</pre></div>
</div>
</div>
</div>
<p><em><strong>Likewise, if we modify <code class="docutils literal notranslate"><span class="pre">b</span></code> by appending a 5, we change <code class="docutils literal notranslate"><span class="pre">a</span></code>, too!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5]
</pre></div>
</div>
</div>
</div>
<p>The behavior is useful but a double-edged sword!
<a class="reference external" href="https://nedbatchelder.com/text/names.html">Here</a> is a deeper discussion of this behavior.</p>
</section>
<section id="dynamic-references-strong-types">
<h4>Dynamic references, strong types<a class="headerlink" href="#dynamic-references-strong-types" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>In contrast with many compiled languages, such as Java and C++, object references in Python have no type associated with them.</p>
</div></blockquote>
<p>In Python,</p>
<ol class="arabic simple">
<li><p>We do not declare variables and their types</p></li>
<li><p>We can change variables’ types because variables are only names that refer to objects</p></li>
</ol>
<p><em>Dynamic references</em> mean we can reassign a variable to a new object in Python.
For example, we can reassign <code class="docutils literal notranslate"><span class="pre">a</span></code> from a list to an integer to a string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>list
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
<span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>int
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
<span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>str
</pre></div>
</div>
</div>
</div>
<p><em>Strong types</em> mean Python typically will not convert object types.
For example, the code  returns either <code class="docutils literal notranslate"><span class="pre">'55'</span></code> as a string or <code class="docutils literal notranslate"><span class="pre">10</span></code> as an integer in many programming languages.
However, <code class="docutils literal notranslate"><span class="pre">'5'</span> <span class="pre">+</span> <span class="pre">5</span></code> returns an error in Python.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># &#39;5&#39; + 5</span>
</pre></div>
</div>
</div>
</div>
<p>However, Python implicitly converts integers to floats.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mf">4.5</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s1">, b is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a is &lt;class &#39;float&#39;&gt;, b is &lt;class &#39;int&#39;&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.25
</pre></div>
</div>
</div>
</div>
<p>In the previous code cell:</p>
<ol class="arabic simple">
<li><p>The ‘a is …’ output prints because of the explicit <code class="docutils literal notranslate"><span class="pre">print()</span></code> function call</p></li>
<li><p>The output of <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">/</span> <span class="pre">b</span></code> prints (or displays) because it is the last line in the code cell</p></li>
</ol>
<p>If we want integer division (or floor division), we have to use <code class="docutils literal notranslate"><span class="pre">//</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">5</span> <span class="o">//</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">5</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.5
</pre></div>
</div>
</div>
</div>
</section>
<section id="attributes-and-methods">
<h4>Attributes and methods<a class="headerlink" href="#attributes-and-methods" title="Permalink to this heading">#</a></h4>
<p>We can use tab completion to list attributes (characteristics stored inside objects) and methods (functions associated with objects).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Foo&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="imports">
<h4>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>In Python a module is simply a file with the .py extension containing Python code.</p>
</div></blockquote>
<p>We can import with <code class="docutils literal notranslate"><span class="pre">import</span></code> statements, which have several syntaxes.
The basic syntax uses the module name as the prefix to separate module items from our current namespace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">as</span></code> syntax lets us define an abbreviated prefix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<p>We can also import one or more items from a package into our namespace with the following syntaxes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span> <span class="k">as</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="binary-operators-and-comparisons">
<h4>Binary operators and comparisons<a class="headerlink" href="#binary-operators-and-comparisons" title="Permalink to this heading">#</a></h4>
<p>Binary operators work like Excel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">5</span> <span class="o">-</span> <span class="mi">7</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">12</span> <span class="o">+</span> <span class="mf">21.5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>33.5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">5</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p>We can operate during an assignment to avoid two names referring to the same object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="ow">is</span> <span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">c</span></code> have the same <em>values</em> but are not the same object!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">==</span> <span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>In Python, <code class="docutils literal notranslate"><span class="pre">=</span></code> is the assignment operator, <code class="docutils literal notranslate"><span class="pre">==</span></code> tests equality, and <code class="docutils literal notranslate"><span class="pre">!=</span></code> tests inequality.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">==</span> <span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">!=</span> <span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">c</span></code> have the same values but reference different objects in memory.</p>
<p><em><strong>Table 2-1</strong></em> from McKinney summarizes the binary operators.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code> : Add a and b</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-</span> <span class="pre">b</span></code> : Subtract b from a</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">*</span> <span class="pre">b</span></code> : Multiply a by b</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">/</span> <span class="pre">b</span></code> : Divide a by b</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">//</span> <span class="pre">b</span></code> : Floor-divide a by b, dropping any fractional remainder</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">**</span> <span class="pre">b</span></code> : Raise a to the b power</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&amp;</span> <span class="pre">b</span></code> : True if both a and b are True; for integers, take the bitwise AND</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">|</span> <span class="pre">b</span></code> : True if either a or b is True; for integers, take the bitwise OR</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">^</span> <span class="pre">b</span></code> : For booleans, True if a or b is True , but not both; for integers, take the bitwise EXCLUSIVE-OR</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">b</span></code> : True if a equals b</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">!=</span> <span class="pre">b</span></code>: True if a is not equal to b</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&lt;=</span> <span class="pre">b,</span> <span class="pre">a</span> <span class="pre">&lt;</span> <span class="pre">b</span></code> : True if a is less than (less than or equal) to b</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&gt;</span> <span class="pre">b,</span> <span class="pre">a</span> <span class="pre">&gt;=</span> <span class="pre">b</span></code>: True if a is greater than (greater than or equal) to b</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">is</span> <span class="pre">b</span></code> : True if a and b reference the same Python object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">b</span></code> : True if a and b reference different Python objects</p></li>
</ul>
</section>
<section id="mutable-and-immutable-objects">
<h4>Mutable and immutable objects<a class="headerlink" href="#mutable-and-immutable-objects" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>Most objects in Python, such as lists, dicts, NumPy arrays, and most user-defined
types (classes), are mutable. This means that the object or values that they contain can
be modified.</p>
</div></blockquote>
<p>Lists are mutable, so we can modify them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>Python is zero-indexed! The first element has a zero subscript <code class="docutils literal notranslate"><span class="pre">[0]</span></code>!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;foo&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[4, 5]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Tuples are <em>immutable</em>, so we cannot modify them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The Python interpreter returns an error if we try to modify <code class="docutils literal notranslate"><span class="pre">a_tuple</span></code> because tuples are immutable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># a_tuple[1] = &#39;four&#39;</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>Note:</strong></em>
Tuples do not require <code class="docutils literal notranslate"><span class="pre">()</span></code>, but <code class="docutils literal notranslate"><span class="pre">()</span></code> improve readability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tuple
</pre></div>
</div>
</div>
</div>
<p>We will learn more about Python’s built-in data structures in McKinney chapter 3.</p>
</section>
</section>
<section id="scalar-types">
<h3>Scalar Types<a class="headerlink" href="#scalar-types" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>Python along with its standard library has a small set of built-in types for handling numerical data, strings, boolean ( True or False ) values, and dates and time. These “single value” types are sometimes called scalar types and we refer to them in this book as scalars. See Table 2-4 for a list of the main scalar types. Date and time handling will be discussed separately, as these are provided by the datetime module in the standard  library.</p>
</div></blockquote>
<p><em><strong>Table 2-2</strong></em> from McKinney lists the standard scalar types.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code>: The Python “null” value (only one instance of the None object exists)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">str</span></code>: String type; holds Unicode (UTF-8 encoded) strings</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bytes</span></code>: Raw ASCII bytes (or Unicode encoded as bytes)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">float</span></code>: Double-precision (64-bit) floating-point number (note there is no separate double type)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bool</span></code>: A True or False value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">int</span></code>: Arbitrary precision signed integer</p></li>
</ul>
<section id="numeric-types">
<h4>Numeric types<a class="headerlink" href="#numeric-types" title="Permalink to this heading">#</a></h4>
<p>In Python, integers are unbounded, and <code class="docutils literal notranslate"><span class="pre">**</span></code> raises numbers to a power.
So, <code class="docutils literal notranslate"><span class="pre">ival</span> <span class="pre">**</span> <span class="pre">6</span></code> is $17239781^6$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ival</span> <span class="o">=</span> <span class="mi">17239871</span>
<span class="n">ival</span> <span class="o">**</span> <span class="mi">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>26254519291092456596965462913230729701102721
</pre></div>
</div>
</div>
</div>
<p>Floats (decimal numbers) are 64-bit in Python.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fval</span> <span class="o">=</span> <span class="mf">7.243</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">fval</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>float
</pre></div>
</div>
</div>
</div>
<p>Dividing integers yields a float, if necessary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.5
</pre></div>
</div>
</div>
</div>
<p>We have to use <code class="docutils literal notranslate"><span class="pre">//</span></code> if we want C-style integer division (i.e., $3 / 2 = 1$).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span> <span class="o">//</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
</section>
<section id="booleans">
<h4>Booleans<a class="headerlink" href="#booleans" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>The two Boolean values in Python are written as True and False. Comparisons and other conditional expressions evaluate to either True or False. Boolean values are combined with the and and or keywords.</p>
</div></blockquote>
<p>Python is case sensitive, so we must type Booleans as <code class="docutils literal notranslate"><span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kc">True</span> <span class="ow">and</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">5</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">10</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kc">False</span> <span class="ow">or</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">5</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">10</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>We can substitute <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> for <code class="docutils literal notranslate"><span class="pre">and</span></code> and <code class="docutils literal notranslate"><span class="pre">|</span></code> for <code class="docutils literal notranslate"><span class="pre">or</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kc">True</span> <span class="o">&amp;</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kc">False</span> <span class="o">|</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="type-casting">
<h4>Type casting<a class="headerlink" href="#type-casting" title="Permalink to this heading">#</a></h4>
<p>We can “recast” variables to change their types.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;3.14159&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>str
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.14159
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">fval</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>float
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span><span class="p">(</span><span class="n">fval</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<p>Zero is Boolean <code class="docutils literal notranslate"><span class="pre">False</span></code>, and all other values are Boolean <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>We can recast the string <code class="docutils literal notranslate"><span class="pre">'5'</span></code> to an integer or the integer <code class="docutils literal notranslate"><span class="pre">5</span></code> to a string to prevent the <code class="docutils literal notranslate"><span class="pre">5</span> <span class="pre">+</span> <span class="pre">'5'</span></code> error above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">5</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;5&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;55&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="none">
<h4>None<a class="headerlink" href="#none" title="Permalink to this heading">#</a></h4>
<p>In Python, <code class="docutils literal notranslate"><span class="pre">None</span></code> is null.
<code class="docutils literal notranslate"><span class="pre">None</span></code> is like <code class="docutils literal notranslate"><span class="pre">#N/A</span></code> or <code class="docutils literal notranslate"><span class="pre">=na()</span></code> in Excel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NoneType
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="control-flow">
<h3>Control Flow<a class="headerlink" href="#control-flow" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>Python has several built-in keywords for conditional logic, loops, and other standard control flow concepts found in other programming languages.</p>
</div></blockquote>
<p>If you understand Excel’s <code class="docutils literal notranslate"><span class="pre">if()</span></code>, then you understand Python’s <code class="docutils literal notranslate"><span class="pre">if</span></code>, <code class="docutils literal notranslate"><span class="pre">elif</span></code>, and <code class="docutils literal notranslate"><span class="pre">else</span></code>.</p>
<section id="if-elif-and-else">
<h4>if, elif, and else<a class="headerlink" href="#if-elif-and-else" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>int
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It&#39;s negative&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>It&#39;s negative
</pre></div>
</div>
</div>
</div>
<p>Single quotes and double quotes (<code class="docutils literal notranslate"><span class="pre">'</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;</span></code>) are equivalent in Python.
However, in the previous code cell, we use double quotes to differentiate between the enclosing quotes and the apostrophe in <code class="docutils literal notranslate"><span class="pre">&quot;It's&quot;</span></code>.</p>
<p>Python’s <code class="docutils literal notranslate"><span class="pre">elif</span></code> avoids Excel’s nested <code class="docutils literal notranslate"><span class="pre">if()</span></code>s.
<code class="docutils literal notranslate"><span class="pre">elif</span></code> continues an <code class="docutils literal notranslate"><span class="pre">if</span></code> block, and <code class="docutils literal notranslate"><span class="pre">else</span></code> runs if the other conditions are not met.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It&#39;s negative&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Equal to zero&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Positive but smaller than 5&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Positive and larger than or equal to 5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Positive and larger than or equal to 5
</pre></div>
</div>
</div>
</div>
<p>We can combine comparisons with <code class="docutils literal notranslate"><span class="pre">and</span></code> and <code class="docutils literal notranslate"><span class="pre">or</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">4</span>
<span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Made it&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Made it
</pre></div>
</div>
</div>
</div>
</section>
<section id="for-loops">
<h4>for loops<a class="headerlink" href="#for-loops" title="Permalink to this heading">#</a></h4>
<p>We use <code class="docutils literal notranslate"><span class="pre">for</span></code> loops to loop over a collection, like a list or tuple.
The <code class="docutils literal notranslate"><span class="pre">continue</span></code> keyword skips the remainder of the <code class="docutils literal notranslate"><span class="pre">if</span></code> block for that loop iteration.</p>
<p>The following example assigns values with <code class="docutils literal notranslate"><span class="pre">+=</span></code>, where <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+=</span> <span class="pre">5</span></code> is an abbreviation for <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">5</span></code>.
There are equivalent abbreviations for subtraction, multiplication, and division (<code class="docutils literal notranslate"><span class="pre">-=</span></code>, <code class="docutils literal notranslate"><span class="pre">*=</span></code>, and <code class="docutils literal notranslate"><span class="pre">/=</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Alex&#39;</span><span class="p">]</span>
<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">value</span> <span class="c1"># the += operator is equivalent to &quot;total = total + value&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">break</span></code> keyword exits the loop altogether.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">total_until_5</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">total_until_5</span> <span class="o">+=</span> <span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_until_5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13
</pre></div>
</div>
</div>
</div>
</section>
<section id="range">
<h4>range<a class="headerlink" href="#range" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>The range function returns an iterator that yields a sequence of evenly spaced
integers.</p>
</div></blockquote>
<ul class="simple">
<li><p>With one argument, <code class="docutils literal notranslate"><span class="pre">range()</span></code> creates an iterator from 0 to that number <em>but excludes that number</em> (so <code class="docutils literal notranslate"><span class="pre">range(10)</span></code> is an interator with a length of 10 that starts at 0)</p></li>
<li><p>With two arguments, the first argument is the <em>inclusive</em> starting value, and the second argument is the <em>exclusive</em> ending value</p></li>
<li><p>With three arguments, the third argument is the iterator step size</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>range(0, 10)
</pre></div>
</div>
</div>
</div>
<p>We can cast a range to a list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5, 6, 7, 8, 9]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5, 6, 7, 8, 9]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]
</pre></div>
</div>
</div>
</div>
<p>Python intervals are “closed” (inclusive) on the left and “open” (exclusive) on the right.
The following is an empty list because we cannot count from 5 to 0 by steps of +1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>However, we can count from 5 to 0 in steps of -1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[5, 4, 3, 2, 1]
</pre></div>
</div>
</div>
</div>
<p>For loops have the following syntax in many other programming languages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>However, in Python, we can directly loop over the list <code class="docutils literal notranslate"><span class="pre">seq</span></code>.
The following code cell is equivalent to the previous code cell and more “Pythonic”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">i</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ternary-expressions">
<h4>Ternary expressions<a class="headerlink" href="#ternary-expressions" title="Permalink to this heading">#</a></h4>
<p>We said above that Python <code class="docutils literal notranslate"><span class="pre">if</span></code> and <code class="docutils literal notranslate"><span class="pre">else</span></code> is cumbersome relative to Excel’s <code class="docutils literal notranslate"><span class="pre">if()</span></code>.
We can complete simple comparisons on one line in Python.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Non-negative&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Negative&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-mckinney_02_practice"></span><section id="mckinney-chapter-2-practice-blank">
<h3>McKinney Chapter 2 - Practice (Blank)<a class="headerlink" href="#mckinney-chapter-2-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="extract-the-year-month-and-day-from-an-integer-8-digit-date-i-e-yyyymmdd-format-using-integer-division-and-modulo-division">
<h5>Extract the year, month, and day from an integer 8-digit date (i.e., YYYYMMDD format) using <code class="docutils literal notranslate"><span class="pre">//</span></code> (integer division) and <code class="docutils literal notranslate"><span class="pre">%</span></code> (modulo division).<a class="headerlink" href="#extract-the-year-month-and-day-from-an-integer-8-digit-date-i-e-yyyymmdd-format-using-integer-division-and-modulo-division" title="Permalink to this heading">#</a></h5>
<p>Try <code class="docutils literal notranslate"><span class="pre">20080915</span></code>.</p>
</section>
<section id="use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e-g-return-year-month-date">
<h5>Use your answer above to write a function <code class="docutils literal notranslate"><span class="pre">date</span></code> that accepts an integer 8-digit date argument and returns a tuple of the year, month, and date (e.g., <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">(year,</span> <span class="pre">month,</span> <span class="pre">date)</span></code>).<a class="headerlink" href="#use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e-g-return-year-month-date" title="Permalink to this heading">#</a></h5>
</section>
<section id="rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string">
<h5>Rewrite <code class="docutils literal notranslate"><span class="pre">date</span></code> to accept an 8-digit date as an integer or string.<a class="headerlink" href="#rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string" title="Permalink to this heading">#</a></h5>
</section>
<section id="finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings">
<h5>Finally, rewrite <code class="docutils literal notranslate"><span class="pre">date</span></code> to accept a list of 8-digit dates as integers or strings.<a class="headerlink" href="#finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings" title="Permalink to this heading">#</a></h5>
<p>Return a list of tuples of year, month, and date.</p>
</section>
<section id="write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10">
<h5>Write a for loop that prints the squares of integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
</section>
<section id="write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10">
<h5>Write a for loop that prints the squares of <em>even</em> integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
</section>
<section id="write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10">
<h5>Write a for loop that sums the squares of integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
</section>
<section id="write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50">
<h5>Write a for loop that sums the squares of integers from 1 to 10 but stops before the sum exceeds 50.<a class="headerlink" href="#write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50" title="Permalink to this heading">#</a></h5>
</section>
<section id="fizzbuzz">
<h5>FizzBuzz<a class="headerlink" href="#fizzbuzz" title="Permalink to this heading">#</a></h5>
<p>Write a for loop that prints the numbers from 1 to 100.
For multiples of three print “Fizz” instead of the number.
For multiples of five print “Buzz”.
For numbers that are multiples of both three and five print “FizzBuzz”.
More <a class="reference external" href="https://blog.codinghorror.com/why-cant-programmers-program/">here</a>.</p>
</section>
<section id="use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact">
<h5>Use ternary expressions to make your FizzBuzz code more compact.<a class="headerlink" href="#use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact" title="Permalink to this heading">#</a></h5>
</section>
<section id="triangle">
<h5>Triangle<a class="headerlink" href="#triangle" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">triangle</span></code> that accepts a positive integer $N$ and prints a numerical triangle of height $N-1$.
For example, <code class="docutils literal notranslate"><span class="pre">triangle(N=6)</span></code> should print:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span>
<span class="mi">22</span>
<span class="mi">333</span>
<span class="mi">4444</span>
<span class="mi">55555</span>
</pre></div>
</div>
</section>
<section id="two-sum">
<h5>Two Sum<a class="headerlink" href="#two-sum" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">two_sum</span></code> that does the following.</p>
<p>Given an array of integers <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">target</span></code>, return the indices of the two numbers that add up to target.</p>
<p>You may assume that each input would have exactly one solution, and you may not use the same element twice.</p>
<p>You can return the answer in any order.</p>
<p>Here are some examples:</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[2,7,11,15]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">9</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code> <br />
Explanation: Because <code class="docutils literal notranslate"><span class="pre">nums[0]</span> <span class="pre">+</span> <span class="pre">nums[1]</span> <span class="pre">==</span> <span class="pre">9</span></code>, we return <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>.</p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,4]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">6</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1,2]</span></code> \</p>
<p>Example 3:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,3]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">6</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code> \</p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/two-sum/description/">LeetCode</a>.</p>
</section>
<section id="best-time">
<h5>Best Time<a class="headerlink" href="#best-time" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">best_time</span></code> that solves the following.</p>
<p>You are given an array <code class="docutils literal notranslate"><span class="pre">prices</span></code> where <code class="docutils literal notranslate"><span class="pre">prices[i]</span></code> is the price of a given stock on the $i^{th}$ day.</p>
<p>You want to maximize your profit by choosing a single day to buy one stock and choosing a different day in the future to sell that stock.</p>
<p>Return the maximum profit you can achieve from this transaction. If you cannot achieve any profit, return 0.</p>
<p>Here are some examples:</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">prices</span> <span class="pre">=</span> <span class="pre">[7,1,5,3,6,4]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">5</span></code> <br />
Explanation: Buy on day 2 (price = 1) and sell on day 5 (price = 6), profit = 6-1 = 5.
Note that buying on day 2 and selling on day 1 is not allowed because you must buy before you sell.</p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">prices</span> <span class="pre">=</span> <span class="pre">[7,6,4,3,1]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">0</span></code> <br />
Explanation: In this case, no transactions are done and the max profit = 0.</p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock/">LeetCode</a>.</p>
</section>
</section>
</section>
<span id="document-mckinney_02_practice_03"></span><section id="mckinney-chapter-2-practice-section-3-monday-2-45-pm">
<h3>McKinney Chapter 2 - Practice (Section 3, Monday 2:45 PM)<a class="headerlink" href="#mckinney-chapter-2-practice-section-3-monday-2-45-pm" title="Permalink to this heading">#</a></h3>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="extract-the-year-month-and-day-from-an-integer-8-digit-date-i-e-yyyymmdd-format-using-integer-division-and-modulo-division">
<h5>Extract the year, month, and day from an integer 8-digit date (i.e., YYYYMMDD format) using <code class="docutils literal notranslate"><span class="pre">//</span></code> (integer division) and <code class="docutils literal notranslate"><span class="pre">%</span></code> (modulo division).<a class="headerlink" href="#extract-the-year-month-and-day-from-an-integer-8-digit-date-i-e-yyyymmdd-format-using-integer-division-and-modulo-division" title="Permalink to this heading">#</a></h5>
<p>Try <code class="docutils literal notranslate"><span class="pre">20080915</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ymd</span> <span class="o">=</span> <span class="mi">20080915</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ymd</span> <span class="o">//</span> <span class="mi">10000</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2008
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ymd</span> <span class="o">%</span> <span class="mi">10000</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>915
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10000</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e-g-return-year-month-date">
<h5>Use your answer above to write a function <code class="docutils literal notranslate"><span class="pre">date</span></code> that accepts an integer 8-digit date argument and returns a tuple of the year, month, and date (e.g., <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">(year,</span> <span class="pre">month,</span> <span class="pre">date)</span></code>).<a class="headerlink" href="#use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e-g-return-year-month-date" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">ymd</span><span class="p">):</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10000</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="mi">20080915</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string">
<h5>Rewrite <code class="docutils literal notranslate"><span class="pre">date</span></code> to accept an 8-digit date as an integer or string.<a class="headerlink" href="#rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">ymd</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ymd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10000</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="mi">20080915</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
</section>
<section id="finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings">
<h5>Finally, rewrite <code class="docutils literal notranslate"><span class="pre">date</span></code> to accept a list of 8-digit dates as integers or strings.<a class="headerlink" href="#finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">ymd</span><span class="p">):</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">ymd</span> <span class="o">=</span> <span class="p">[</span><span class="n">ymd</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ymd</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">10000</span>
        <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span>
        <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dates</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="mi">20080915</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(2008, 9, 15)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">([</span><span class="mi">20080915</span><span class="p">,</span> <span class="s1">&#39;20080915&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(2008, 9, 15), (2008, 9, 15)]
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10">
<h5>Write a for loop that prints the squares of integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 4 9 16 25 36 49 64 81 100 
</pre></div>
</div>
</div>
</div>
<p>Above, I change the <code class="docutils literal notranslate"><span class="pre">end</span></code> argument from the default ‘\n’ to ‘ ‘.
The default ‘\n’ inserts a new line after value, making the output too long.</p>
</section>
<section id="write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10">
<h5>Write a for loop that prints the squares of <em>even</em> integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4 16 36 64 100 
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10">
<h5>Write a for loop that sums the squares of integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>385
</pre></div>
</div>
</div>
</div>
<p>Above, I use <code class="docutils literal notranslate"><span class="pre">total</span> <span class="pre">+=</span> <span class="pre">i</span></code>, which is equivalent to <code class="docutils literal notranslate"><span class="pre">total</span> <span class="pre">=</span> <span class="pre">total</span> <span class="pre">+</span> <span class="pre">i</span></code>.</p>
</section>
<section id="write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50">
<h5>Write a for loop that sums the squares of integers from 1 to 10 but stops before the sum exceeds 50.<a class="headerlink" href="#write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30
</pre></div>
</div>
</div>
</div>
</section>
<section id="fizzbuzz">
<h5>FizzBuzz<a class="headerlink" href="#fizzbuzz" title="Permalink to this heading">#</a></h5>
<p>Write a for loop that prints the numbers from 1 to 100.
For multiples of three print “Fizz” instead of the number.
For multiples of five print “Buzz”.
For numbers that are multiples of both three and five print “FizzBuzz”.
More <a class="reference external" href="https://blog.codinghorror.com/why-cant-programmers-program/">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
    <span class="n">is_mult_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">is_mult_5</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_mult_3</span> <span class="ow">and</span> <span class="n">is_mult_5</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FizzBuzz&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_mult_3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fizz&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_mult_5</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Buzz&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact">
<h5>Use ternary expressions to make your FizzBuzz code more compact.<a class="headerlink" href="#use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
    <span class="n">is_mult_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">is_mult_5</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fizz&#39;</span><span class="o">*</span><span class="n">is_mult_3</span> <span class="o">+</span> <span class="s1">&#39;Buzz&#39;</span><span class="o">*</span><span class="n">is_mult_5</span> <span class="k">if</span> <span class="n">is_mult_3</span> <span class="ow">or</span> <span class="n">is_mult_5</span> <span class="k">else</span> <span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
</pre></div>
</div>
</div>
</div>
<p>The solution above is shorter and uses from neat tricks, but I consider the previous solution easier to read and troubleshoot.</p>
</section>
<section id="triangle">
<h5>Triangle<a class="headerlink" href="#triangle" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">triangle</span></code> that accepts a positive integer $N$ and prints a numerical triangle of height $N-1$.
For example, <code class="docutils literal notranslate"><span class="pre">triangle(N=6)</span></code> should print:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span>
<span class="mi">22</span>
<span class="mi">333</span>
<span class="mi">4444</span>
<span class="mi">55555</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">triangle</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">triangle</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
22
333
4444
55555
</pre></div>
</div>
</div>
</div>
<p>The solution above works because a multiplying a string by <code class="docutils literal notranslate"><span class="pre">i</span></code> concatenates <code class="docutils literal notranslate"><span class="pre">i</span></code> copies of the string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Test&#39;</span> <span class="o">+</span> <span class="s1">&#39;Test&#39;</span> <span class="o">+</span> <span class="s1">&#39;Test&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;TestTestTest&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Test&#39;</span> <span class="o">*</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;TestTestTest&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="two-sum">
<h5>Two Sum<a class="headerlink" href="#two-sum" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">two_sum</span></code> that does the following.</p>
<p>Given an array of integers <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">target</span></code>, return the indices of the two numbers that add up to target.</p>
<p>You may assume that each input would have exactly one solution, and you may not use the same element twice.</p>
<p>You can return the answer in any order.</p>
<p>Here are some examples:</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[2,7,11,15]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">9</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code> <br />
Explanation: Because <code class="docutils literal notranslate"><span class="pre">nums[0]</span> <span class="pre">+</span> <span class="pre">nums[1]</span> <span class="pre">==</span> <span class="pre">9</span></code>, we return <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>.</p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,4]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">6</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1,2]</span></code> \</p>
<p>Example 3:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,3]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">6</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code> \</p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/two-sum/description/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">two_sum</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_sum</span><span class="p">(</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_sum</span><span class="p">(</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_sum</span><span class="p">(</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1]
</pre></div>
</div>
</div>
</div>
<p>We can write more efficient code once we learn other data structures in chapter 3 of McKinney!</p>
</section>
<section id="best-time">
<h5>Best Time<a class="headerlink" href="#best-time" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">best_time</span></code> that solves the following.</p>
<p>You are given an array <code class="docutils literal notranslate"><span class="pre">prices</span></code> where <code class="docutils literal notranslate"><span class="pre">prices[i]</span></code> is the price of a given stock on the $i^{th}$ day.</p>
<p>You want to maximize your profit by choosing a single day to buy one stock and choosing a different day in the future to sell that stock.</p>
<p>Return the maximum profit you can achieve from this transaction. If you cannot achieve any profit, return 0.</p>
<p>Here are some examples:</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">prices</span> <span class="pre">=</span> <span class="pre">[7,1,5,3,6,4]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">5</span></code> <br />
Explanation: Buy on day 2 (price = 1) and sell on day 5 (price = 6), profit = 6-1 = 5.
Note that buying on day 2 and selling on day 1 is not allowed because you must buy before you sell.</p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">prices</span> <span class="pre">=</span> <span class="pre">[7,6,4,3,1]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">0</span></code> <br />
Explanation: In this case, no transactions are done and the max profit = 0.</p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">max_profit</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
        <span class="n">min_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_profit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
            <span class="n">min_price</span> <span class="o">=</span> <span class="n">price</span> <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">min_price</span> <span class="k">else</span> <span class="n">min_price</span>
            <span class="n">profit</span> <span class="o">=</span> <span class="n">price</span> <span class="o">-</span> <span class="n">min_price</span>
            <span class="n">max_profit</span> <span class="o">=</span> <span class="n">profit</span> <span class="k">if</span> <span class="n">profit</span> <span class="o">&gt;</span> <span class="n">max_profit</span> <span class="k">else</span> <span class="n">max_profit</span>
        <span class="k">return</span> <span class="n">max_profit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_profit</span><span class="p">(</span><span class="n">prices</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_profit</span><span class="p">(</span><span class="n">prices</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_02_practice_04"></span><section id="mckinney-chapter-2-practice-section-4-wednesday-11-45-am">
<h3>McKinney Chapter 2 - Practice (Section 4, Wednesday 11:45 AM)<a class="headerlink" href="#mckinney-chapter-2-practice-section-4-wednesday-11-45-am" title="Permalink to this heading">#</a></h3>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="extract-the-year-month-and-day-from-an-integer-8-digit-date-i-e-yyyymmdd-format-using-integer-division-and-modulo-division">
<h5>Extract the year, month, and day from an integer 8-digit date (i.e., YYYYMMDD format) using <code class="docutils literal notranslate"><span class="pre">//</span></code> (integer division) and <code class="docutils literal notranslate"><span class="pre">%</span></code> (modulo division).<a class="headerlink" href="#extract-the-year-month-and-day-from-an-integer-8-digit-date-i-e-yyyymmdd-format-using-integer-division-and-modulo-division" title="Permalink to this heading">#</a></h5>
<p>Try <code class="docutils literal notranslate"><span class="pre">20080915</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1234</span> <span class="o">/</span> <span class="mi">100</span> <span class="c1"># &quot;regular&quot; division</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.34
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1234</span> <span class="o">//</span> <span class="mi">100</span> <span class="c1"># integer or floor division gives us the integer portion</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1234</span> <span class="o">%</span> <span class="mi">100</span> <span class="c1"># modulo division gives us the remainder</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>34
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ymd</span> <span class="o">=</span> <span class="mi">20080915</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10_000</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">%</span> <span class="mi">10_000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e-g-return-year-month-date">
<h5>Use your answer above to write a function <code class="docutils literal notranslate"><span class="pre">date</span></code> that accepts an integer 8-digit date argument and returns a tuple of the year, month, and date (e.g., <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">(year,</span> <span class="pre">month,</span> <span class="pre">date)</span></code>).<a class="headerlink" href="#use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e-g-return-year-month-date" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">ymd</span><span class="p">):</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10_000</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">%</span> <span class="mi">10_000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="n">ymd</span><span class="o">=</span><span class="mi">20080915</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string">
<h5>Rewrite <code class="docutils literal notranslate"><span class="pre">date</span></code> to accept an 8-digit date as an integer or string.<a class="headerlink" href="#rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">ymd</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ymd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10_000</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">%</span> <span class="mi">10_000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="n">ymd</span><span class="o">=</span><span class="s1">&#39;20080915&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
</section>
<section id="finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings">
<h5>Finally, rewrite <code class="docutils literal notranslate"><span class="pre">date</span></code> to accept a list of 8-digit dates as integers or strings.<a class="headerlink" href="#finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ymds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20080915</span><span class="p">,</span> <span class="s1">&#39;20080915&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">ymds</span><span class="p">):</span>
    <span class="n">ymds_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ymds</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">ymds</span> <span class="o">=</span> <span class="p">[</span><span class="n">ymds</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ymd</span> <span class="ow">in</span> <span class="n">ymds</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ymd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10_000</span>
        <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">%</span> <span class="mi">10_000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
        <span class="n">ymds_out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ymds_out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="n">ymds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(2008, 9, 15), (2008, 9, 15)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="mi">20080915</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(2008, 9, 15)]
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10">
<h5>Write a for loop that prints the squares of integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 4 9 16 25 36 49 64 81 100 
</pre></div>
</div>
</div>
</div>
<p>Above, I change the <code class="docutils literal notranslate"><span class="pre">end</span></code> argument from the default ‘\n’ to ‘ ‘.
The default ‘\n’ inserts a new line after value, making the output too long.</p>
</section>
<section id="write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10">
<h5>Write a for loop that prints the squares of <em>even</em> integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4 16 36 64 100 
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10">
<h5>Write a for loop that sums the squares of integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>385
</pre></div>
</div>
</div>
</div>
<p>Above, I use <code class="docutils literal notranslate"><span class="pre">total</span> <span class="pre">+=</span> <span class="pre">i</span></code>, which is equivalent to <code class="docutils literal notranslate"><span class="pre">total</span> <span class="pre">=</span> <span class="pre">total</span> <span class="pre">+</span> <span class="pre">i</span></code>.</p>
</section>
<section id="write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50">
<h5>Write a for loop that sums the squares of integers from 1 to 10 but stops before the sum exceeds 50.<a class="headerlink" href="#write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30
</pre></div>
</div>
</div>
</div>
</section>
<section id="fizzbuzz">
<h5>FizzBuzz<a class="headerlink" href="#fizzbuzz" title="Permalink to this heading">#</a></h5>
<p>Write a for loop that prints the numbers from 1 to 100.
For multiples of three print “Fizz” instead of the number.
For multiples of five print “Buzz”.
For numbers that are multiples of both three and five print “FizzBuzz”.
More <a class="reference external" href="https://blog.codinghorror.com/why-cant-programmers-program/">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">4</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
    <span class="n">is_mult_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">is_mult_5</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_mult_3</span> <span class="ow">and</span> <span class="n">is_mult_5</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FizzBuzz&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_mult_3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fizz&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_mult_5</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Buzz&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact">
<h5>Use ternary expressions to make your FizzBuzz code more compact.<a class="headerlink" href="#use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
    <span class="n">is_mult_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">is_mult_5</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fizz&#39;</span><span class="o">*</span><span class="n">is_mult_3</span> <span class="o">+</span> <span class="s1">&#39;Buzz&#39;</span><span class="o">*</span><span class="n">is_mult_5</span> <span class="k">if</span> <span class="n">is_mult_3</span> <span class="ow">or</span> <span class="n">is_mult_5</span> <span class="k">else</span> <span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
</pre></div>
</div>
</div>
</div>
<p>The solution above is shorter and uses from neat tricks, but I consider the previous solution easier to read and troubleshoot.</p>
</section>
<section id="triangle">
<h5>Triangle<a class="headerlink" href="#triangle" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">triangle</span></code> that accepts a positive integer $N$ and prints a numerical triangle of height $N-1$.
For example, <code class="docutils literal notranslate"><span class="pre">triangle(N=6)</span></code> should print:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span>
<span class="mi">22</span>
<span class="mi">333</span>
<span class="mi">4444</span>
<span class="mi">55555</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">triangle</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">triangle</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
22
333
4444
55555
</pre></div>
</div>
</div>
</div>
<p>The solution above works because a multiplying a string by <code class="docutils literal notranslate"><span class="pre">i</span></code> concatenates <code class="docutils literal notranslate"><span class="pre">i</span></code> copies of the string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Test&#39;</span> <span class="o">+</span> <span class="s1">&#39;Test&#39;</span> <span class="o">+</span> <span class="s1">&#39;Test&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;TestTestTest&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Test&#39;</span> <span class="o">*</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;TestTestTest&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="two-sum">
<h5>Two Sum<a class="headerlink" href="#two-sum" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">two_sum</span></code> that does the following.</p>
<p>Given an array of integers <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">target</span></code>, return the indices of the two numbers that add up to target.</p>
<p>You may assume that each input would have exactly one solution, and you may not use the same element twice.</p>
<p>You can return the answer in any order.</p>
<p>Here are some examples:</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[2,7,11,15]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">9</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code> <br />
Explanation: Because <code class="docutils literal notranslate"><span class="pre">nums[0]</span> <span class="pre">+</span> <span class="pre">nums[1]</span> <span class="pre">==</span> <span class="pre">9</span></code>, we return <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>.</p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,4]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">6</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1,2]</span></code> \</p>
<p>Example 3:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,3]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">6</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code> \</p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/two-sum/description/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">two_sum</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_sum</span><span class="p">(</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_sum</span><span class="p">(</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_sum</span><span class="p">(</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1]
</pre></div>
</div>
</div>
</div>
<p>We can write more efficient code once we learn other data structures in chapter 3 of McKinney!</p>
</section>
<section id="best-time">
<h5>Best Time<a class="headerlink" href="#best-time" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">best_time</span></code> that solves the following.</p>
<p>You are given an array <code class="docutils literal notranslate"><span class="pre">prices</span></code> where <code class="docutils literal notranslate"><span class="pre">prices[i]</span></code> is the price of a given stock on the $i^{th}$ day.</p>
<p>You want to maximize your profit by choosing a single day to buy one stock and choosing a different day in the future to sell that stock.</p>
<p>Return the maximum profit you can achieve from this transaction. If you cannot achieve any profit, return 0.</p>
<p>Here are some examples:</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">prices</span> <span class="pre">=</span> <span class="pre">[7,1,5,3,6,4]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">5</span></code> <br />
Explanation: Buy on day 2 (price = 1) and sell on day 5 (price = 6), profit = 6-1 = 5.
Note that buying on day 2 and selling on day 1 is not allowed because you must buy before you sell.</p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">prices</span> <span class="pre">=</span> <span class="pre">[7,6,4,3,1]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">0</span></code> <br />
Explanation: In this case, no transactions are done and the max profit = 0.</p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">max_profit</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
        <span class="n">min_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_profit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
            <span class="n">min_price</span> <span class="o">=</span> <span class="n">price</span> <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">min_price</span> <span class="k">else</span> <span class="n">min_price</span>
            <span class="n">profit</span> <span class="o">=</span> <span class="n">price</span> <span class="o">-</span> <span class="n">min_price</span>
            <span class="n">max_profit</span> <span class="o">=</span> <span class="n">profit</span> <span class="k">if</span> <span class="n">profit</span> <span class="o">&gt;</span> <span class="n">max_profit</span> <span class="k">else</span> <span class="n">max_profit</span>
        <span class="k">return</span> <span class="n">max_profit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_profit</span><span class="p">(</span><span class="n">prices</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_profit</span><span class="p">(</span><span class="n">prices</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_02_practice_02"></span><section id="mckinney-chapter-2-practice-section-2-wednesday-2-45-pm">
<h3>McKinney Chapter 2 - Practice (Section 2, Wednesday 2:45 PM)<a class="headerlink" href="#mckinney-chapter-2-practice-section-2-wednesday-2-45-pm" title="Permalink to this heading">#</a></h3>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="extract-the-year-month-and-day-from-an-integer-8-digit-date-i-e-yyyymmdd-format-using-integer-division-and-modulo-division">
<h5>Extract the year, month, and day from an integer 8-digit date (i.e., YYYYMMDD format) using <code class="docutils literal notranslate"><span class="pre">//</span></code> (integer division) and <code class="docutils literal notranslate"><span class="pre">%</span></code> (modulo division).<a class="headerlink" href="#extract-the-year-month-and-day-from-an-integer-8-digit-date-i-e-yyyymmdd-format-using-integer-division-and-modulo-division" title="Permalink to this heading">#</a></h5>
<p>Try <code class="docutils literal notranslate"><span class="pre">20080915</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1234</span> <span class="o">/</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.34
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1234</span> <span class="o">//</span> <span class="mi">100</span> <span class="c1"># // is integer division</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1234</span> <span class="o">%</span> <span class="mi">100</span> <span class="c1"># % is modulo (or remainder) division</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>34
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ymd</span> <span class="o">=</span> <span class="mi">20080915</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10_000</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">%</span> <span class="mi">10_000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2008 9 15
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2008/9/15
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;year is </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">, month is </span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">, day is </span><span class="si">{</span><span class="n">day</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year is 2008, month is 9, day is 15
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e-g-return-year-month-date">
<h5>Use your answer above to write a function <code class="docutils literal notranslate"><span class="pre">date</span></code> that accepts an integer 8-digit date argument and returns a tuple of the year, month, and date (e.g., <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">(year,</span> <span class="pre">month,</span> <span class="pre">date)</span></code>).<a class="headerlink" href="#use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e-g-return-year-month-date" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">ymd</span><span class="p">):</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10_000</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">%</span> <span class="mi">10_000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parsed_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">20080915</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parsed_date</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string">
<h5>Rewrite <code class="docutils literal notranslate"><span class="pre">date</span></code> to accept an 8-digit date as an integer or string.<a class="headerlink" href="#rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">ymd</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ymd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10_000</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">%</span> <span class="mi">10_000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="s1">&#39;20080915&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="mi">20080915</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2008, 9, 15)
</pre></div>
</div>
</div>
</div>
</section>
<section id="finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings">
<h5>Finally, rewrite <code class="docutils literal notranslate"><span class="pre">date</span></code> to accept a list of 8-digit dates as integers or strings.<a class="headerlink" href="#finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings" title="Permalink to this heading">#</a></h5>
<p>Return a list of tuples of year, month, and date.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ymds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20080915</span><span class="p">,</span> <span class="s1">&#39;20080916&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ymds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20080915
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ymds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;20080916&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ymd</span> <span class="ow">in</span> <span class="n">ymds</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20080915
20080916
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">ymds</span><span class="p">):</span>
    <span class="n">parsed_dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ymd</span> <span class="ow">in</span> <span class="n">ymds</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ymd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymd</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">//</span> <span class="mi">10_000</span>
        <span class="n">month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymd</span> <span class="o">%</span> <span class="mi">10_000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">ymd</span> <span class="o">%</span> <span class="mi">100</span>
        <span class="n">parsed_dates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">parsed_dates</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="p">(</span><span class="n">ymds</span><span class="o">=</span><span class="n">ymds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(2008, 9, 15), (2008, 9, 16)]
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10">
<h5>Write a for loop that prints the squares of integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 4 9 16 25 36 49 64 81 100 
</pre></div>
</div>
</div>
</div>
<p>Above, I change the <code class="docutils literal notranslate"><span class="pre">end</span></code> argument from the default ‘\n’ to ‘ ‘.
The default ‘\n’ inserts a new line after value, making the output too long.</p>
</section>
<section id="write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10">
<h5>Write a for loop that prints the squares of <em>even</em> integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4 16 36 64 100 
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10">
<h5>Write a for loop that sums the squares of integers from 1 to 10.<a class="headerlink" href="#write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>385
</pre></div>
</div>
</div>
</div>
<p>Above, I use <code class="docutils literal notranslate"><span class="pre">total</span> <span class="pre">+=</span> <span class="pre">i</span></code>, which is equivalent to <code class="docutils literal notranslate"><span class="pre">total</span> <span class="pre">=</span> <span class="pre">total</span> <span class="pre">+</span> <span class="pre">i</span></code>.</p>
</section>
<section id="write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50">
<h5>Write a for loop that sums the squares of integers from 1 to 10 but stops before the sum exceeds 50.<a class="headerlink" href="#write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30
</pre></div>
</div>
</div>
</div>
</section>
<section id="fizzbuzz">
<h5>FizzBuzz<a class="headerlink" href="#fizzbuzz" title="Permalink to this heading">#</a></h5>
<p>Write a for loop that prints the numbers from 1 to 100.
For multiples of three print “Fizz” instead of the number.
For multiples of five print “Buzz”.
For numbers that are multiples of both three and five print “FizzBuzz”.
More <a class="reference external" href="https://blog.codinghorror.com/why-cant-programmers-program/">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">6</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
    <span class="n">is_mult_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">is_mult_5</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_mult_3</span> <span class="ow">and</span> <span class="n">is_mult_5</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FizzBuzz&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_mult_3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fizz&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_mult_5</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Buzz&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact">
<h5>Use ternary expressions to make your FizzBuzz code more compact.<a class="headerlink" href="#use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
    <span class="n">is_mult_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">is_mult_5</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fizz&#39;</span><span class="o">*</span><span class="n">is_mult_3</span> <span class="o">+</span> <span class="s1">&#39;Buzz&#39;</span><span class="o">*</span><span class="n">is_mult_5</span> <span class="k">if</span> <span class="n">is_mult_3</span> <span class="ow">or</span> <span class="n">is_mult_5</span> <span class="k">else</span> <span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
</pre></div>
</div>
</div>
</div>
<p>The solution above is shorter and uses from neat tricks, but I consider the previous solution easier to read and troubleshoot.</p>
</section>
<section id="triangle">
<h5>Triangle<a class="headerlink" href="#triangle" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">triangle</span></code> that accepts a positive integer $N$ and prints a numerical triangle of height $N-1$.
For example, <code class="docutils literal notranslate"><span class="pre">triangle(N=6)</span></code> should print:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span>
<span class="mi">22</span>
<span class="mi">333</span>
<span class="mi">4444</span>
<span class="mi">55555</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">triangle</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">triangle</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
22
333
4444
55555
</pre></div>
</div>
</div>
</div>
<p>The solution above works because a multiplying a string by <code class="docutils literal notranslate"><span class="pre">i</span></code> concatenates <code class="docutils literal notranslate"><span class="pre">i</span></code> copies of the string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Test&#39;</span> <span class="o">+</span> <span class="s1">&#39;Test&#39;</span> <span class="o">+</span> <span class="s1">&#39;Test&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;TestTestTest&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Test&#39;</span> <span class="o">*</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;TestTestTest&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="two-sum">
<h5>Two Sum<a class="headerlink" href="#two-sum" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">two_sum</span></code> that does the following.</p>
<p>Given an array of integers <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">target</span></code>, return the indices of the two numbers that add up to target.</p>
<p>You may assume that each input would have exactly one solution, and you may not use the same element twice.</p>
<p>You can return the answer in any order.</p>
<p>Here are some examples:</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[2,7,11,15]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">9</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code> <br />
Explanation: Because <code class="docutils literal notranslate"><span class="pre">nums[0]</span> <span class="pre">+</span> <span class="pre">nums[1]</span> <span class="pre">==</span> <span class="pre">9</span></code>, we return <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>.</p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,4]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">6</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1,2]</span></code> \</p>
<p>Example 3:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,3]</span></code>, <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">=</span> <span class="pre">6</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code> \</p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/two-sum/description/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">two_sum</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_sum</span><span class="p">(</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_sum</span><span class="p">(</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_sum</span><span class="p">(</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1]
</pre></div>
</div>
</div>
</div>
<p>We can write more efficient code once we learn other data structures in chapter 3 of McKinney!</p>
</section>
<section id="best-time">
<h5>Best Time<a class="headerlink" href="#best-time" title="Permalink to this heading">#</a></h5>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">best_time</span></code> that solves the following.</p>
<p>You are given an array <code class="docutils literal notranslate"><span class="pre">prices</span></code> where <code class="docutils literal notranslate"><span class="pre">prices[i]</span></code> is the price of a given stock on the $i^{th}$ day.</p>
<p>You want to maximize your profit by choosing a single day to buy one stock and choosing a different day in the future to sell that stock.</p>
<p>Return the maximum profit you can achieve from this transaction. If you cannot achieve any profit, return 0.</p>
<p>Here are some examples:</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">prices</span> <span class="pre">=</span> <span class="pre">[7,1,5,3,6,4]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">5</span></code> <br />
Explanation: Buy on day 2 (price = 1) and sell on day 5 (price = 6), profit = 6-1 = 5.
Note that buying on day 2 and selling on day 1 is not allowed because you must buy before you sell.</p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">prices</span> <span class="pre">=</span> <span class="pre">[7,6,4,3,1]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">0</span></code> <br />
Explanation: In this case, no transactions are done and the max profit = 0.</p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">max_profit</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
        <span class="n">min_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_profit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
            <span class="n">min_price</span> <span class="o">=</span> <span class="n">price</span> <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">min_price</span> <span class="k">else</span> <span class="n">min_price</span>
            <span class="n">profit</span> <span class="o">=</span> <span class="n">price</span> <span class="o">-</span> <span class="n">min_price</span>
            <span class="n">max_profit</span> <span class="o">=</span> <span class="n">profit</span> <span class="k">if</span> <span class="n">profit</span> <span class="o">&gt;</span> <span class="n">max_profit</span> <span class="k">else</span> <span class="n">max_profit</span>
        <span class="k">return</span> <span class="n">max_profit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_profit</span><span class="p">(</span><span class="n">prices</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_profit</span><span class="p">(</span><span class="n">prices</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-mckinney_03_lecture"></span><section id="mckinney-chapter-3-built-in-data-structures-functions-and-files">
<h2>McKinney Chapter 3 - Built-In Data Structures, Functions, and Files<a class="headerlink" href="#mckinney-chapter-3-built-in-data-structures-functions-and-files" title="Permalink to this heading">#</a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h3>
<p>We must understand Python’s core functionality to fully use NumPy and pandas.
Chapter 3 of Wes McKinney’s <a class="reference external" href="https://wesmckinney.com/book/"><em>Python for Data Analysis</em></a> discusses Python’s core functionality.
We will focus on the following:</p>
<ol class="arabic simple">
<li><p>Data structures</p>
<ol class="arabic simple">
<li><p>tuples</p></li>
<li><p>lists</p></li>
<li><p>dicts (also known as dictionaries)</p></li>
<li><p><em>we will ignore sets</em></p></li>
</ol>
</li>
<li><p>List comprehensions</p></li>
<li><p>Functions</p>
<ol class="arabic simple">
<li><p>Returning multiple values</p></li>
<li><p>Using anonymous functions</p></li>
</ol>
</li>
</ol>
<p><em><strong>Note:</strong></em>
Indented block quotes are from McKinney unless otherwise indicated.
The section numbers here differ from McKinney because we will only discuss some topics.</p>
</section>
<section id="data-structures-and-sequences">
<h3>Data Structures and Sequences<a class="headerlink" href="#data-structures-and-sequences" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>Python’s data structures are simple but powerful. Mastering their use is a critical part
of becoming a proficient Python programmer.</p>
</div></blockquote>
<section id="tuple">
<h4>Tuple<a class="headerlink" href="#tuple" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>A tuple is a fixed-length, immutable sequence of Python objects.</p>
</div></blockquote>
<p>We cannot change a tuple after we create it because tuples are immutable.
A tuple is ordered, so we can subset or slice it with a numerical index.
We will surround tuples with parentheses but the parentheses are not always required.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>Python is zero-indexed, so zero accesses the first element in <code class="docutils literal notranslate"><span class="pre">tup</span></code>!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nested_tup</span> <span class="o">=</span> <span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>Python is zero-indexed!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nested_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(4, 5, 6)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nested_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;s&#39;, &#39;t&#39;, &#39;r&#39;, &#39;i&#39;, &#39;n&#39;, &#39;g&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;s&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="kc">True</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;foo&#39;, [1, 2], True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tup[2] = False # gives an error, because tuples are immutable (unchangeable)</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>If an object inside a tuple is mutable, such as a list, you can modify it in-place.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;foo&#39;, [1, 2], True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;foo&#39;, [1, 2, 3], True)
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>You can concatenate tuples using the + operator to produce longer tuples:</p>
</div></blockquote>
<p>Tuples are immutable, but we can combine two tuples into a new tuple.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1, 2, 1, 2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(4, None, &#39;foo&#39;, 6, 0, &#39;bar&#39;)
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Multiplying a tuple by an integer, as with lists, has the effect of concatenating together
that many copies of the tuple:</p>
</div></blockquote>
<p>This multiplication behavior is the logical extension of the addition behavior above.
The output of <code class="docutils literal notranslate"><span class="pre">tup</span> <span class="pre">+</span> <span class="pre">tup</span></code> should be the same as the output of <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">tup</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;foo&#39;, &#39;bar&#39;, &#39;foo&#39;, &#39;bar&#39;, &#39;foo&#39;, &#39;bar&#39;, &#39;foo&#39;, &#39;bar&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;foo&#39;, &#39;bar&#39;, &#39;foo&#39;, &#39;bar&#39;, &#39;foo&#39;, &#39;bar&#39;, &#39;foo&#39;, &#39;bar&#39;)
</pre></div>
</div>
</div>
</div>
<section id="unpacking-tuples">
<h5>Unpacking tuples<a class="headerlink" href="#unpacking-tuples" title="Permalink to this heading">#</a></h5>
<blockquote>
<div><p>If you try to assign to a tuple-like expression of variables, Python will attempt to
unpack the value on the righthand side of the equals sign.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">tup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="c1"># the parentheses are optional but helpful!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">e</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># g, h = 10, 11, 12 # ValueError: too many values to unpack (expected 2)</span>
</pre></div>
</div>
</div>
</div>
<p>We can unpack nested tuples!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7
</pre></div>
</div>
</div>
</div>
</section>
<section id="tuple-methods">
<h5>Tuple methods<a class="headerlink" href="#tuple-methods" title="Permalink to this heading">#</a></h5>
<blockquote>
<div><p>Since the size and contents of a tuple cannot be modified, it is very light on instance
methods. A particularly useful one (also available on lists) is count, which counts the
number of occurrences of a value.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="list">
<h4>List<a class="headerlink" href="#list" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>In contrast with tuples, lists are variable-length and their contents can be modified in-place. You can define them using square brackets [ ] or using the list type function.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span>
<span class="n">b_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2, 3, 7, None]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;foo&#39;, &#39;bar&#39;, &#39;baz&#39;]
</pre></div>
</div>
</div>
</div>
<p><em><strong>Pyhon is zero-indexed!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<section id="adding-and-removing-elements">
<h5>Adding and removing elements<a class="headerlink" href="#adding-and-removing-elements" title="Permalink to this heading">#</a></h5>
<blockquote>
<div><p>Elements can be appended to the end of the list with the append method.</p>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">.append()</span></code> method appends an element to the list <em>in place</em> without reassigning the list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;dwarf&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;foo&#39;, &#39;bar&#39;, &#39;baz&#39;, &#39;dwarf&#39;]
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Using insert you can insert an element at a specific location in the list.
The insertion index must be between 0 and the length of the list, inclusive.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;foo&#39;, &#39;red&#39;, &#39;bar&#39;, &#39;baz&#39;, &#39;dwarf&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span><span class="p">[</span><span class="n">b_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;foo&#39;, &#39;blue&#39;, &#39;bar&#39;, &#39;baz&#39;, &#39;dwarf&#39;]
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>The inverse operation to insert is pop, which removes and returns an element at a
particular index.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;bar&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;foo&#39;, &#39;blue&#39;, &#39;baz&#39;, &#39;dwarf&#39;]
</pre></div>
</div>
</div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">.pop(2)</span></code> removes the 2 element.
If we do not want to remove the 2 element, we should use <code class="docutils literal notranslate"><span class="pre">[2]</span></code> to access an element without removing it.</p>
<blockquote>
<div><p>Elements can be removed by value with remove, which locates the first such value and removes it from the list.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;foo&#39;, &#39;blue&#39;, &#39;baz&#39;, &#39;dwarf&#39;, &#39;foo&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;blue&#39;, &#39;baz&#39;, &#39;dwarf&#39;, &#39;foo&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;dwarf&#39;</span> <span class="ow">in</span> <span class="n">b_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;dwarf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
</section>
<section id="concatenating-and-combining-lists">
<h5>Concatenating and combining lists<a class="headerlink" href="#concatenating-and-combining-lists" title="Permalink to this heading">#</a></h5>
<blockquote>
<div><p>Similar to tuples, adding two lists together with + concatenates them.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[4, None, &#39;foo&#39;, 7, 8, (2, 3)]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.append()</span></code> method adds its argument as the last element in a list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">]</span>
<span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xx</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[4, None, &#39;foo&#39;, [7, 8, (2, 3)]]
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>If you have a list already defined, you can append multiple elements to it using the extend method.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">]</span>
<span class="n">x</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[4, None, &#39;foo&#39;, 7, 8, (2, 3)]
</pre></div>
</div>
</div>
</div>
<p><em><strong>Check your output! It will take you time to understand all these methods!</strong></em></p>
</section>
<section id="sorting">
<h5>Sorting<a class="headerlink" href="#sorting" title="Permalink to this heading">#</a></h5>
<blockquote>
<div><p>You can sort a list in-place (without creating a new object) by calling its sort function.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">a</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 5, 7]
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>sort has a few options that will occasionally come in handy. One is the ability to pass a secondary sort key—that is, a function that produces a value to use to sort the objects. For example, we could sort a collection of strings by their lengths.</p>
</div></blockquote>
<p>Before you write your own solution to a problem, read the docstring (help file) of the built-in function.
The built-in function may already solve your problem faster with fewer bugs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;saw&#39;</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;He&#39;</span><span class="p">,</span> <span class="s1">&#39;foxes&#39;</span><span class="p">,</span> <span class="s1">&#39;six&#39;</span><span class="p">]</span>
<span class="n">b</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="c1"># Python is case sensitive, so &quot;He&quot; sorts before &quot;foxes&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;He&#39;, &#39;foxes&#39;, &#39;saw&#39;, &#39;six&#39;, &#39;small&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;He&#39;, &#39;saw&#39;, &#39;six&#39;, &#39;foxes&#39;, &#39;small&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="slicing">
<h5>Slicing<a class="headerlink" href="#slicing" title="Permalink to this heading">#</a></h5>
<p><em><strong>Slicing is very important!</strong></em></p>
<blockquote>
<div><p>You can select sections of most sequence types by using slice notation, which in its basic form consists of start:stop passed to the indexing operator [ ].</p>
</div></blockquote>
<p>Recall that Python is zero-indexed, so the first element has an index of 0.
The necessary consequence of zero-indexing is that start:stop is inclusive on the left edge (start) and exclusive on the right edge (stop).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">seq</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7, 2, 3, 7, 5, 6, 0, 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7, 2, 3, 7, 5]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2, 3, 7, 5]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7, 5]
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Either the start or stop can be omitted, in which case they default to the start of the sequence and the end of the sequence, respectively.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7, 2, 3, 7, 5]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7, 5, 6, 0, 1]
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Negative indices slice the sequence relative to the end.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7, 2, 3, 7, 5, 6, 0, 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[5, 6, 0, 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[5, 6, 0]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[3, 7, 5, 6]
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>A step can also be used after a second colon to, say, take every other element.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7, 2, 3, 7, 5, 6, 0, 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7, 3, 5, 0]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2, 7, 6, 1]
</pre></div>
</div>
</div>
</div>
<p>I remember the trick above as <code class="docutils literal notranslate"><span class="pre">:2</span></code> is “count by 2”.</p>
<blockquote>
<div><p>A clever use of this is to pass -1, which has the useful effect of reversing a list or tuple.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seq</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 0, 6, 5, 7, 3, 2, 7]
</pre></div>
</div>
</div>
</div>
<p>We will use slicing (subsetting) all semester, so it is worth a few minutes to understand the examples above.</p>
</section>
</section>
<section id="dict">
<h4>dict<a class="headerlink" href="#dict" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>dict is likely the most important built-in Python data structure. A more common
name for it is hash map or associative array. It is a flexibly sized collection of key-value
pairs, where key and value are Python objects. One approach for creating one is to use
curly braces {} and colons to separate keys and values.</p>
</div></blockquote>
<p>Elements in dictionaries have names, while elements in tuples and lists have numerical indices.
Dictionaries are handy for passing named arguments and returning named results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">empty_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">empty_dict</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{}
</pre></div>
</div>
</div>
</div>
<p>A dictionary is a set of key-value pairs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;some value&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;some value&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;an integer&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: &#39;some value&#39;, &#39;b&#39;: [1, 2, 3, 4], 7: &#39;an integer&#39;}
</pre></div>
</div>
</div>
</div>
<p>We access dictionary values by key names instead of key positions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">d1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>You can delete values either using the del keyword or the pop method (which simultaneously returns the value and deletes the key).</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;some value&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;another value&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: &#39;some value&#39;,
 &#39;b&#39;: [1, 2, 3, 4],
 7: &#39;an integer&#39;,
 5: &#39;some value&#39;,
 &#39;dummy&#39;: &#39;another value&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">d1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: &#39;some value&#39;,
 &#39;b&#39;: [1, 2, 3, 4],
 7: &#39;an integer&#39;,
 &#39;dummy&#39;: &#39;another value&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dummy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;another value&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: &#39;some value&#39;, &#39;b&#39;: [1, 2, 3, 4], 7: &#39;an integer&#39;}
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>The keys and values method give you iterators of the dict’s keys and values, respectively. While the key-value pairs are not in any particular order, these functions output the keys and values in the same order.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;a&#39;, &#39;b&#39;, 7])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_values([&#39;some value&#39;, [1, 2, 3, 4], &#39;an integer&#39;])
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>You can merge one dict into another using the update method.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: &#39;some value&#39;, &#39;b&#39;: [1, 2, 3, 4], 7: &#39;an integer&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: &#39;some value&#39;, &#39;b&#39;: &#39;foo&#39;, 7: &#39;an integer&#39;, &#39;c&#39;: 12}
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="list-set-and-dict-comprehensions">
<h3>List, Set, and Dict Comprehensions<a class="headerlink" href="#list-set-and-dict-comprehensions" title="Permalink to this heading">#</a></h3>
<p>We will focus on list comprehensions.</p>
<blockquote>
<div><p>List comprehensions are one of the most-loved Python language features. They allow you to concisely form a new list by filtering the elements of a collection, transforming the elements passing the filter in one concise expression. They take the basic form:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">expr</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">collection</span> <span class="k">if</span> <span class="n">condition</span><span class="p">]</span>
</pre></div>
</div>
<p>This is equivalent to the following for loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</pre></div>
</div>
<p>The filter condition can be omitted, leaving only the expression.</p>
</div></blockquote>
<p>List comprehensions are very <a class="reference external" href="https://blog.startifact.com/posts/older/what-is-pythonic.html">Pythonic</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;bat&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">,</span> <span class="s1">&#39;dove&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We could use a for loop to capitalize the strings in <code class="docutils literal notranslate"><span class="pre">strings</span></code> and keep only strings with lengths greater than two.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">caps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">caps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

<span class="n">caps</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;BAT&#39;, &#39;CAR&#39;, &#39;DOVE&#39;, &#39;PYTHON&#39;]
</pre></div>
</div>
</div>
</div>
<p>A list comprehension is a more Pythonic solution and replaces four lines of code with one.
The general format for a list comprehension is <code class="docutils literal notranslate"><span class="pre">[operation</span> <span class="pre">on</span> <span class="pre">x</span> <span class="pre">for</span> <span class="pre">x</span> <span class="pre">in</span> <span class="pre">list</span> <span class="pre">if</span> <span class="pre">condition]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;BAT&#39;, &#39;CAR&#39;, &#39;DOVE&#39;, &#39;PYTHON&#39;]
</pre></div>
</div>
</div>
</div>
<p>Here is another example.
Write a for-loop and the equivalent list comprehension that squares the integers from 1 to 10.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">squares</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="n">squares</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    
<span class="n">squares</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]
</pre></div>
</div>
</div>
</div>
</section>
<section id="functions">
<h3>Functions<a class="headerlink" href="#functions" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>Functions are the primary and most important method of code organization and reuse in Python. As a rule of thumb, if you anticipate needing to repeat the same or very similar code more than once, it may be worth writing a reusable function. Functions can also help make your code more readable by giving a name to a group of Python statements.</p>
<p>Functions are declared with the def keyword and returned from with the return keyword:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">z</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">z</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>There is no issue with having multiple return statements. If Python reaches the end of a function without encountering a return statement, None is returned automatically.</p>
<p>Each function can have positional arguments and keyword arguments. Keyword arguments are most commonly used to specify default values or optional arguments. In the preceding function, x and y are positional arguments while z is a keyword argument. This means that the function can be called in any of these ways:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="n">my_function</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
 <span class="n">my_function</span><span class="p">(</span><span class="mf">3.14</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
 <span class="n">my_function</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>The main restriction on function arguments is that the keyword arguments must follow the positional arguments (if any). You can specify keyword arguments in any order; this frees you from having to remember which order the function arguments were specified in and only what their names are.</p>
</div></blockquote>
<p>Here is the basic syntax for a function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mult_by_two</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<section id="returning-multiple-values">
<h4>Returning Multiple Values<a class="headerlink" href="#returning-multiple-values" title="Permalink to this heading">#</a></h4>
<p>We can write Python functions that return multiple objects.
In reality, the function <code class="docutils literal notranslate"><span class="pre">f()</span></code> below returns one object, a tuple, that we can unpack to multiple objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5, 6, 7)
</pre></div>
</div>
</div>
</div>
<p>If we want to return multiple objects with names or labels, we can return a dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span> <span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span> <span class="p">:</span> <span class="n">c</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: 5, &#39;b&#39;: 6, &#39;c&#39;: 7}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">()[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
</section>
<section id="anonymous-lambda-functions">
<h4>Anonymous (Lambda) Functions<a class="headerlink" href="#anonymous-lambda-functions" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>Python has support for so-called anonymous or lambda functions, which are a way of writing functions consisting of a single statement, the result of which is the return value. They are defined with the lambda keyword, which has no meaning other than “we are declaring an anonymous function.”</p>
</div></blockquote>
<blockquote>
<div><p>I usually refer to these as lambda functions in the rest of the book. They are especially convenient in data analysis because, as you’ll see, there are many cases where data transformation functions will take functions as arguments. It’s often less typing (and clearer) to pass a lambda function as opposed to writing a full-out function declaration or even assigning the lambda function to a local variable.</p>
</div></blockquote>
<p>Lambda functions are very Pythonic and let us to write simple functions on the fly.
For example, we could use a lambda function to sort <code class="docutils literal notranslate"><span class="pre">strings</span></code> by the number of unique letters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;card&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;aaaa&#39;</span><span class="p">,</span> <span class="s1">&#39;abab&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="n">strings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;aaaa&#39;, &#39;abab&#39;, &#39;bar&#39;, &#39;card&#39;, &#39;foo&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
<span class="n">strings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;bar&#39;, &#39;foo&#39;, &#39;aaaa&#39;, &#39;abab&#39;, &#39;card&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">strings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;aaaa&#39;, &#39;abab&#39;, &#39;card&#39;, &#39;foo&#39;, &#39;bar&#39;]
</pre></div>
</div>
</div>
</div>
<p>How can I sort by the <em>second</em> letter in each string?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;aaaa&#39;, &#39;abab&#39;, &#39;card&#39;, &#39;foo&#39;, &#39;bar&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;card&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;a&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">strings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;aaaa&#39;, &#39;card&#39;, &#39;bar&#39;, &#39;abab&#39;, &#39;foo&#39;]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-mckinney_03_practice"></span><section id="mckinney-chapter-3-practice-blank">
<h3>McKinney Chapter 3 - Practice (Blank)<a class="headerlink" href="#mckinney-chapter-3-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="swap-the-values-assigned-to-a-and-b-using-a-third-variable-c">
<h5>Swap the values assigned to <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> using a third variable <code class="docutils literal notranslate"><span class="pre">c</span></code>.<a class="headerlink" href="#swap-the-values-assigned-to-a-and-b-using-a-third-variable-c" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c">
<h5>Swap the values assigned to <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> <em><strong>without</strong></em> using a third variable <code class="docutils literal notranslate"><span class="pre">c</span></code>.<a class="headerlink" href="#swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-is-the-output-of-the-following-code-and-why">
<h5>What is the output of the following code and why?<a class="headerlink" href="#what-is-the-output-of-the-following-code-and-why" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1, 1, False)
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-list-l1-of-integers-from-1-to-100">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l1</span></code> of integers from 1 to 100.<a class="headerlink" href="#create-a-list-l1-of-integers-from-1-to-100" title="Permalink to this heading">#</a></h5>
</section>
<section id="slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive">
<h5>Slice <code class="docutils literal notranslate"><span class="pre">l1</span></code> to create a list of integers from 60 to 50 (inclusive).<a class="headerlink" href="#slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive" title="Permalink to this heading">#</a></h5>
<p>Name this list <code class="docutils literal notranslate"><span class="pre">l2</span></code>.</p>
</section>
<section id="create-a-list-l3-of-odd-integers-from-1-to-21">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l3</span></code> of odd integers from 1 to 21.<a class="headerlink" href="#create-a-list-l3-of-odd-integers-from-1-to-21" title="Permalink to this heading">#</a></h5>
</section>
<section id="create-a-list-l4-of-the-squares-of-integers-from-1-to-100">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l4</span></code> of the squares of integers from 1 to 100.<a class="headerlink" href="#create-a-list-l4-of-the-squares-of-integers-from-1-to-100" title="Permalink to this heading">#</a></h5>
</section>
<section id="create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l5</span></code> that contains the squares of <em><strong>odd</strong></em> integers from 1 to 100.<a class="headerlink" href="#create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100" title="Permalink to this heading">#</a></h5>
</section>
<section id="use-a-lambda-function-to-sort-strings-by-the-last-letter">
<h5>Use a lambda function to sort <code class="docutils literal notranslate"><span class="pre">strings</span></code> by the last letter.<a class="headerlink" href="#use-a-lambda-function-to-sort-strings-by-the-last-letter" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;card&#39;</span><span class="p">,</span> <span class="s1">&#39;aaaa&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;abab&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="given-an-integer-array-nums-and-an-integer-k-return-the-k-th-largest-element-in-the-array">
<h5>Given an integer array <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">k</span></code>, return the $k^{th}$ largest element in the array.<a class="headerlink" href="#given-an-integer-array-nums-and-an-integer-k-return-the-k-th-largest-element-in-the-array" title="Permalink to this heading">#</a></h5>
<p>Note that it is the $k^{th}$ largest element in the sorted order, not the $k^{th}$ distinct element.</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,1,5,6,4]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">2</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">5</span></code></p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,3,1,2,4,5,5,6]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">4</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">4</span></code></p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/kth-largest-element-in-an-array/">LeetCode</a>.</p>
</section>
<section id="given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements">
<h5>Given an integer array <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">k</span></code>, return the <code class="docutils literal notranslate"><span class="pre">k</span></code> most frequent elements.<a class="headerlink" href="#given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements" title="Permalink to this heading">#</a></h5>
<p>You may return the answer in any order.</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[1,1,1,2,2,3]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">2</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1,2]</span></code></p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[1]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">1</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1]</span></code></p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/top-k-frequent-elements/">LeetCode</a>.</p>
</section>
<section id="test-whether-the-given-strings-are-palindromes">
<h5>Test whether the given strings are palindromes.<a class="headerlink" href="#test-whether-the-given-strings-are-palindromes" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">[&quot;aba&quot;,</span> <span class="pre">&quot;no&quot;]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[True,</span> <span class="pre">False]</span></code></p>
</section>
<section id="write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> that accepts lists of prices and dividends and returns a list of returns.<a class="headerlink" href="#write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">]</span>
<span class="n">dividends</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields">
<h5>Rewrite the function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> so it returns lists of returns, capital gains yields, and dividend yields.<a class="headerlink" href="#rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields" title="Permalink to this heading">#</a></h5>
</section>
<section id="rescale-and-shift-numbers-so-that-they-cover-the-range-0-1">
<h5>Rescale and shift numbers so that they cover the range <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>.<a class="headerlink" href="#rescale-and-shift-numbers-so-that-they-cover-the-range-0-1" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">[18.5,</span> <span class="pre">17.0,</span> <span class="pre">18.0,</span> <span class="pre">19.0,</span> <span class="pre">18.0]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0.75,</span> <span class="pre">0.0,</span> <span class="pre">0.5,</span> <span class="pre">1.0,</span> <span class="pre">0.5]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mf">18.5</span><span class="p">,</span> <span class="mf">17.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_03_practice_04"></span><section id="mckinney-chapter-3-practice-section-4-wednesday-11-45-am">
<h3>McKinney Chapter 3 - Practice (Section 4, Wednesday 11:45 AM)<a class="headerlink" href="#mckinney-chapter-3-practice-section-4-wednesday-11-45-am" title="Permalink to this heading">#</a></h3>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="swap-the-values-assigned-to-a-and-b-using-a-third-variable-c">
<h5>Swap the values assigned to <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> using a third variable <code class="docutils literal notranslate"><span class="pre">c</span></code>.<a class="headerlink" href="#swap-the-values-assigned-to-a-and-b-using-a-third-variable-c" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1"> and b is </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a is 1 and b is 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">==</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="ow">is</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1"> and b is </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a is 2 and b is 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">who</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a	 b	 c	 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">c</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">who</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a	 b	 
</pre></div>
</div>
</div>
</div>
</section>
<section id="swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c">
<h5>Swap the values assigned to <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> <em><strong>without</strong></em> using a third variable <code class="docutils literal notranslate"><span class="pre">c</span></code>.<a class="headerlink" href="#swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1"> and b is </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a is 1 and b is 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tuple
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1"> and b is </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a is 2 and b is 1
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-is-the-output-of-the-following-code-and-why">
<h5>What is the output of the following code and why?<a class="headerlink" href="#what-is-the-output-of-the-following-code-and-why" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1, 1, False)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1, False)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(False, 1, 1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1, 1, True, 1, 1)
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-list-l1-of-integers-from-1-to-100">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l1</span></code> of integers from 1 to 100.<a class="headerlink" href="#create-a-list-l1-of-integers-from-1-to-100" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[6, 7, 8, 9, 10]
</pre></div>
</div>
</div>
</div>
</section>
<section id="slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive">
<h5>Slice <code class="docutils literal notranslate"><span class="pre">l1</span></code> to create a list of integers from 60 to 50 (inclusive).<a class="headerlink" href="#slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive" title="Permalink to this heading">#</a></h5>
<p>Name this list <code class="docutils literal notranslate"><span class="pre">l2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l2</span> <span class="o">=</span> <span class="n">l1</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">60</span><span class="p">]</span>
<span class="n">l2</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">[</span><span class="mi">59</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">60</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l2</span> <span class="o">=</span> <span class="n">l1</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">60</span><span class="p">]</span>
<span class="n">l2</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
<span class="n">l2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-list-l3-of-odd-integers-from-1-to-21">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l3</span></code> of odd integers from 1 to 21.<a class="headerlink" href="#create-a-list-l3-of-odd-integers-from-1-to-21" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-list-l4-of-the-squares-of-integers-from-1-to-100">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l4</span></code> of the squares of integers from 1 to 100.<a class="headerlink" href="#create-a-list-l4-of-the-squares-of-integers-from-1-to-100" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l4</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l4_quiz1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
    <span class="n">l4_quiz1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l4</span> <span class="o">==</span> <span class="n">l4_quiz1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>New question: Can we use ternary expressions (i.e., inline <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">else</span></code>) with a list comprehension?</p>
<p>I suggest writing a function to make this more obvious, but here is an example.
We can try squaring <code class="docutils literal notranslate"><span class="pre">x</span></code> if <code class="docutils literal notranslate"><span class="pre">x</span></code> is even, but cubing <code class="docutils literal notranslate"><span class="pre">x</span></code> if <code class="docutils literal notranslate"><span class="pre">x</span></code> is odd.
This case is an excellent application of “ternary” statements, which have the form “TrueValue if True else FalseValue”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l4_new_question</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">%</span><span class="k">2</span> == 0) else x**3 for x in range(1, 101)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">l4_new_question</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 4, 27, 16, 125, 36, 343, 64, 729, 100, 1331, 144, 2197, 196, 3375, 256, 4913, 324, 6859, 400, 9261, 484, 12167, 576, 15625, 676, 19683, 784, 24389, 900, 29791, 1024, 35937, 1156, 42875, 1296, 50653, 1444, 59319, 1600, 68921, 1764, 79507, 1936, 91125, 2116, 103823, 2304, 117649, 2500, 132651, 2704, 148877, 2916, 166375, 3136, 185193, 3364, 205379, 3600, 226981, 3844, 250047, 4096, 274625, 4356, 300763, 4624, 328509, 4900, 357911, 5184, 389017, 5476, 421875, 5776, 456533, 6084, 493039, 6400, 531441, 6724, 571787, 7056, 614125, 7396, 658503, 7744, 704969, 8100, 753571, 8464, 804357, 8836, 857375, 9216, 912673, 9604, 970299, 10000]
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l5</span></code> that contains the squares of <em><strong>odd</strong></em> integers from 1 to 100.<a class="headerlink" href="#create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l5</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">l5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 9, 25, 49, 81, 121, 169, 225, 289, 361, 441, 529, 625, 729, 841, 961, 1089, 1225, 1369, 1521, 1681, 1849, 2025, 2209, 2401, 2601, 2809, 3025, 3249, 3481, 3721, 3969, 4225, 4489, 4761, 5041, 5329, 5625, 5929, 6241, 6561, 6889, 7225, 7569, 7921, 8281, 8649, 9025, 9409, 9801]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l5_alt</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">%</span><span class="k">2</span> != 0]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l5</span> <span class="o">==</span> <span class="n">l5_alt</span><span class="p">[</span><span class="o">-</span><span class="mi">41</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-a-lambda-function-to-sort-strings-by-the-last-letter">
<h5>Use a lambda function to sort <code class="docutils literal notranslate"><span class="pre">strings</span></code> by the last letter.<a class="headerlink" href="#use-a-lambda-function-to-sort-strings-by-the-last-letter" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;card&#39;</span><span class="p">,</span> <span class="s1">&#39;aaaa&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;abab&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">strings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;aaaa&#39;, &#39;abab&#39;, &#39;card&#39;, &#39;foo&#39;, &#39;bar&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="given-an-integer-array-nums-and-an-integer-k-return-the-k-th-largest-element-in-the-array">
<h5>Given an integer array <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">k</span></code>, return the $k^{th}$ largest element in the array.<a class="headerlink" href="#given-an-integer-array-nums-and-an-integer-k-return-the-k-th-largest-element-in-the-array" title="Permalink to this heading">#</a></h5>
<p>Note that it is the $k^{th}$ largest element in the sorted order, not the $k^{th}$ distinct element.</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,1,5,6,4]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">2</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">5</span></code></p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,3,1,2,4,5,5,6]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">4</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">4</span></code></p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/kth-largest-element-in-an-array/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nums</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x_copy</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x_copy</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x_copy</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nums</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
</section>
<section id="given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements">
<h5>Given an integer array <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">k</span></code>, return the <code class="docutils literal notranslate"><span class="pre">k</span></code> most frequent elements.<a class="headerlink" href="#given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements" title="Permalink to this heading">#</a></h5>
<p>You may return the answer in any order.</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[1,1,1,2,2,3]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">2</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1,2]</span></code></p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[1]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">1</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1]</span></code></p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/top-k-frequent-elements/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nums</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">k</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nums</span><span class="p">(</span><span class="n">nums</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2]
</pre></div>
</div>
</div>
</div>
</section>
<section id="test-whether-the-given-strings-are-palindromes">
<h5>Test whether the given strings are palindromes.<a class="headerlink" href="#test-whether-the-given-strings-are-palindromes" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">[&quot;aba&quot;,</span> <span class="pre">&quot;no&quot;]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[True,</span> <span class="pre">False]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_palindrome</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">is_palindrome</span><span class="p">([</span><span class="s2">&quot;aba&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[True, False]
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> that accepts lists of prices and dividends and returns a list of returns.<a class="headerlink" href="#write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">]</span>
<span class="n">dividends</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">rts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span> <span class="c1"># start at t=1 b/c need 2 prices to calculate a return</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">ptm1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span> <span class="o">-</span> <span class="n">ptm1</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="n">ptm1</span>
        <span class="n">rts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[None, 0.51, -0.32666666666666666, -0.49, 1.04, 0.52, -0.32, 0.52]
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields">
<h5>Rewrite the function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> so it returns lists of returns, capital gains yields, and dividend yields.<a class="headerlink" href="#rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">rts</span><span class="p">,</span> <span class="n">cgs</span><span class="p">,</span> <span class="n">dys</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span> <span class="c1"># start at t=1 b/c need 2 prices to calculate a return</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">ptm1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">ptm1</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span> <span class="o">-</span> <span class="n">ptm1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ptm1</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">cg</span>
        <span class="n">rts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
        <span class="n">dys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
        <span class="n">cgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cg</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;rt&#39;</span><span class="p">:</span><span class="n">rts</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">:</span><span class="n">dys</span><span class="p">,</span> <span class="s1">&#39;cg&#39;</span><span class="p">:</span><span class="n">cgs</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;rt&#39;: [None, 0.51, -0.32666666666666666, -0.49, 1.04, 0.52, -0.32, 0.52],
 &#39;dy&#39;: [None,
  0.01,
  0.006666666666666667,
  0.01,
  0.04,
  0.02,
  0.013333333333333334,
  0.02],
 &#39;cg&#39;: [None,
  0.5,
  -0.3333333333333333,
  -0.5,
  1.0,
  0.5,
  -0.3333333333333333,
  0.5]}
</pre></div>
</div>
</div>
</div>
</section>
<section id="rescale-and-shift-numbers-so-that-they-cover-the-range-0-1">
<h5>Rescale and shift numbers so that they cover the range <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>.<a class="headerlink" href="#rescale-and-shift-numbers-so-that-they-cover-the-range-0-1" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">[18.5,</span> <span class="pre">17.0,</span> <span class="pre">18.0,</span> <span class="pre">19.0,</span> <span class="pre">18.0]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0.75,</span> <span class="pre">0.0,</span> <span class="pre">0.5,</span> <span class="pre">1.0,</span> <span class="pre">0.5]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mf">18.5</span><span class="p">,</span> <span class="mf">17.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescale</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.75, 0.0, 0.5, 1.0, 0.5]
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_03_practice_02"></span><section id="mckinney-chapter-3-practice-section-2-wednesday-2-45-pm">
<h3>McKinney Chapter 3 - Practice (Section 2, Wednesday 2:45 PM)<a class="headerlink" href="#mckinney-chapter-3-practice-section-2-wednesday-2-45-pm" title="Permalink to this heading">#</a></h3>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="swap-the-values-assigned-to-a-and-b-using-a-third-variable-c">
<h5>Swap the values assigned to <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> using a third variable <code class="docutils literal notranslate"><span class="pre">c</span></code>.<a class="headerlink" href="#swap-the-values-assigned-to-a-and-b-using-a-third-variable-c" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1"> and b is </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a is 1 and b is 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">==</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="ow">is</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1"> and b is </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a is 2 and b is 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">who</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a	 b	 c	 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">c</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">who</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a	 b	 
</pre></div>
</div>
</div>
</div>
</section>
<section id="swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c">
<h5>Swap the values assigned to <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> <em><strong>without</strong></em> using a third variable <code class="docutils literal notranslate"><span class="pre">c</span></code>.<a class="headerlink" href="#swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1"> and b is </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a is 1 and b is 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tuple
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a is </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1"> and b is </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a is 2 and b is 1
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>Here is a trap:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tuple
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">d</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;e is </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> and f is </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>e is 2 and f is 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ValueError: not enough values to unpack (expected 3, got 2)</span>
<span class="c1"># g, h, i = d</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="what-is-the-output-of-the-following-code-and-why">
<h5>What is the output of the following code and why?<a class="headerlink" href="#what-is-the-output-of-the-following-code-and-why" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1, 1, False)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1, False)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(False, 1, 1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1, 1, True, 1, 1)
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-list-l1-of-integers-from-1-to-100">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l1</span></code> of integers from 1 to 100.<a class="headerlink" href="#create-a-list-l1-of-integers-from-1-to-100" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[6, 7, 8, 9, 10]
</pre></div>
</div>
</div>
</div>
</section>
<section id="slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive">
<h5>Slice <code class="docutils literal notranslate"><span class="pre">l1</span></code> to create a list of integers from 60 to 50 (inclusive).<a class="headerlink" href="#slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive" title="Permalink to this heading">#</a></h5>
<p>Name this list <code class="docutils literal notranslate"><span class="pre">l2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l2</span> <span class="o">=</span> <span class="n">l1</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">60</span><span class="p">]</span>
<span class="n">l2</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">[</span><span class="mi">59</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">60</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l2</span> <span class="o">=</span> <span class="n">l1</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">60</span><span class="p">]</span>
<span class="n">l2</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
<span class="n">l2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-list-l3-of-odd-integers-from-1-to-21">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l3</span></code> of odd integers from 1 to 21.<a class="headerlink" href="#create-a-list-l3-of-odd-integers-from-1-to-21" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">l3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-list-l4-of-the-squares-of-integers-from-1-to-100">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l4</span></code> of the squares of integers from 1 to 100.<a class="headerlink" href="#create-a-list-l4-of-the-squares-of-integers-from-1-to-100" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">l4</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
    <span class="n">l4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16 µs ± 91.2 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
</pre></div>
</div>
</div>
</div>
<p>A list comprehension is easier to write and read and considered “more Pythonic”.
Here is the pseudo code for a list comprehension:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">some</span> <span class="nb">range</span> <span class="k">if</span> <span class="n">some</span> <span class="n">condition</span><span class="p">]</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">l4</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15.1 µs ± 24.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100">
<h5>Create a list <code class="docutils literal notranslate"><span class="pre">l5</span></code> that contains the squares of <em><strong>odd</strong></em> integers from 1 to 100.<a class="headerlink" href="#create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l5</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 9, 25, 49, 81, 121, 169, 225, 289, 361, 441, 529, 625, 729, 841, 961, 1089, 1225, 1369, 1521, 1681, 1849, 2025, 2209, 2401, 2601, 2809, 3025, 3249, 3481, 3721, 3969, 4225, 4489, 4761, 5041, 5329, 5625, 5929, 6241, 6561, 6889, 7225, 7569, 7921, 8281, 8649, 9025, 9409, 9801]
</pre></div>
</div>
</div>
</div>
<p>Here is a less efficient solution that uses the <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">some</span> <span class="pre">condition</span></code> part of list comprehensions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">([</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">%</span><span class="k">2</span> != 0])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 9, 25, 49, 81, 121, 169, 225, 289, 361, 441, 529, 625, 729, 841, 961, 1089, 1225, 1369, 1521, 1681, 1849, 2025, 2209, 2401, 2601, 2809, 3025, 3249, 3481, 3721, 3969, 4225, 4489, 4761, 5041, 5329, 5625, 5929, 6241, 6561, 6889, 7225, 7569, 7921, 8281, 8649, 9025, 9409, 9801]
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-a-lambda-function-to-sort-strings-by-the-last-letter">
<h5>Use a lambda function to sort <code class="docutils literal notranslate"><span class="pre">strings</span></code> by the last letter.<a class="headerlink" href="#use-a-lambda-function-to-sort-strings-by-the-last-letter" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;card&#39;</span><span class="p">,</span> <span class="s1">&#39;aaaa&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;abab&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;aaaa&#39;, &#39;abab&#39;, &#39;card&#39;, &#39;foo&#39;, &#39;bar&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="given-an-integer-array-nums-and-an-integer-k-return-the-k-th-largest-element-in-the-array">
<h5>Given an integer array <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">k</span></code>, return the $k^{th}$ largest element in the array.<a class="headerlink" href="#given-an-integer-array-nums-and-an-integer-k-return-the-k-th-largest-element-in-the-array" title="Permalink to this heading">#</a></h5>
<p>Note that it is the $k^{th}$ largest element in the sorted order, not the $k^{th}$ distinct element.</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,1,5,6,4]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">2</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">5</span></code></p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[3,2,3,1,2,4,5,5,6]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">4</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">4</span></code></p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/kth-largest-element-in-an-array/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nums</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x_copy</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x_copy</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x_copy</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nums</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
</section>
<section id="given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements">
<h5>Given an integer array <code class="docutils literal notranslate"><span class="pre">nums</span></code> and an integer <code class="docutils literal notranslate"><span class="pre">k</span></code>, return the <code class="docutils literal notranslate"><span class="pre">k</span></code> most frequent elements.<a class="headerlink" href="#given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements" title="Permalink to this heading">#</a></h5>
<p>You may return the answer in any order.</p>
<p>Example 1:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[1,1,1,2,2,3]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">2</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1,2]</span></code></p>
<p>Example 2:</p>
<p>Input: <code class="docutils literal notranslate"><span class="pre">nums</span> <span class="pre">=</span> <span class="pre">[1]</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">1</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[1]</span></code></p>
<p>I saw this question on <a class="reference external" href="https://leetcode.com/problems/top-k-frequent-elements/">LeetCode</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nums</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">k</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nums</span><span class="p">(</span><span class="n">nums</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2]
</pre></div>
</div>
</div>
</div>
</section>
<section id="test-whether-the-given-strings-are-palindromes">
<h5>Test whether the given strings are palindromes.<a class="headerlink" href="#test-whether-the-given-strings-are-palindromes" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">[&quot;aba&quot;,</span> <span class="pre">&quot;no&quot;]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[True,</span> <span class="pre">False]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_palindrome</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">is_palindrome</span><span class="p">([</span><span class="s2">&quot;aba&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[True, False]
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> that accepts lists of prices and dividends and returns a list of returns.<a class="headerlink" href="#write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">]</span>
<span class="n">dividends</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">ptm1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span> <span class="o">-</span> <span class="n">ptm1</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="n">ptm1</span>
        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">r</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[None, 0.51, -0.32666666666666666, -0.49, 1.04, 0.52, -0.32, 0.52]
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields">
<h5>Rewrite the function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> so it returns lists of returns, capital gains yields, and dividend yields.<a class="headerlink" href="#rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">cg</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">ptm1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">cgt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span> <span class="o">-</span> <span class="n">ptm1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ptm1</span>
        <span class="n">dyt</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">ptm1</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">cgt</span> <span class="o">+</span> <span class="n">dyt</span>
        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cgt</span><span class="p">)</span>
        <span class="n">dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dyt</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;cg&#39;</span><span class="p">:</span> <span class="n">cg</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="n">dy</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;r&#39;: [None, 0.51, -0.32666666666666666, -0.49, 1.04, 0.52, -0.32, 0.52],
 &#39;cg&#39;: [None,
  0.5,
  -0.3333333333333333,
  -0.5,
  1.0,
  0.5,
  -0.3333333333333333,
  0.5],
 &#39;dy&#39;: [None,
  0.01,
  0.006666666666666667,
  0.01,
  0.04,
  0.02,
  0.013333333333333334,
  0.02]}
</pre></div>
</div>
</div>
</div>
</section>
<section id="rescale-and-shift-numbers-so-that-they-cover-the-range-0-1">
<h5>Rescale and shift numbers so that they cover the range <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>.<a class="headerlink" href="#rescale-and-shift-numbers-so-that-they-cover-the-range-0-1" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">[18.5,</span> <span class="pre">17.0,</span> <span class="pre">18.0,</span> <span class="pre">19.0,</span> <span class="pre">18.0]</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">[0.75,</span> <span class="pre">0.0,</span> <span class="pre">0.5,</span> <span class="pre">1.0,</span> <span class="pre">0.5]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mf">18.5</span><span class="p">,</span> <span class="mf">17.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescale</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.75, 0.0, 0.5, 1.0, 0.5]
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-mckinney_04_lecture"></span><section id="mckinney-chapter-4-numpy-basics-arrays-and-vectorized-computation">
<h2>McKinney Chapter 4 - NumPy Basics: Arrays and Vectorized Computation<a class="headerlink" href="#mckinney-chapter-4-numpy-basics-arrays-and-vectorized-computation" title="Permalink to this heading">#</a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h3>
<p>Chapter 4 of Wes McKinney’s <a class="reference external" href="https://wesmckinney.com/book/"><em>Python for Data Analysis</em></a> discusses the NumPy package (an abbreviation of numerical Python), which is the foundation for numerical computing in Python, including pandas.</p>
<p>We will focus on:</p>
<ol class="arabic simple">
<li><p>Creating arrays</p></li>
<li><p>Slicing arrays</p></li>
<li><p>Applying functions and methods to arrays</p></li>
<li><p>Using conditional logic with arrays (i.e., <code class="docutils literal notranslate"><span class="pre">np.where()</span></code> and <code class="docutils literal notranslate"><span class="pre">np.select()</span></code>)</p></li>
</ol>
<p><em><strong>Note:</strong></em>
Indented block quotes are from McKinney unless otherwise indicated.
The section numbers here differ from McKinney because we will only discuss some topics.</p>
<p>The typical abbreviation for NumPy is <code class="docutils literal notranslate"><span class="pre">np</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<p>The “magic” function <code class="docutils literal notranslate"><span class="pre">%precision</span> <span class="pre">4</span></code> tells JupyterLab to print NumPy arrays to 4 decimals.
This magic function only changes the printed precision and does not change the stored precision of the underlying values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">precision</span> 4
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;%.4f&#39;
</pre></div>
</div>
</div>
</div>
<p>McKinney thoroughly discuesses the history on NumPy, as well as its technical advantages.
But here is a simple illustration of the speed and syntax advantages of NumPy of Python’s built-in data structures.
First, we create a list and array with values from 0 to 999,999.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_list</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1, 2, 3, 4]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_arr</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 1, 2, 3, 4])
</pre></div>
</div>
</div>
</div>
<p>If we want to double each value in <code class="docutils literal notranslate"><span class="pre">my_list</span></code> we have to use a for loop or a list comprehension.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">my_list</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># concatenates two copies of my_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># [2 * x for x in my_list] # list comprehension to double each value</span>
</pre></div>
</div>
</div>
</div>
<p>However, we can multiply <code class="docutils literal notranslate"><span class="pre">my_arr</span></code> by two because math “just works” with NumPy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_arr</span> <span class="o">*</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([      0,       2,       4, ..., 1999994, 1999996, 1999998])
</pre></div>
</div>
</div>
</div>
<p>We can use the “magic” function <code class="docutils literal notranslate"><span class="pre">%timeit</span></code> to time these two calculations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> [x * 2 for x in my_list]
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>29.1 ms ± 213 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> my_arr * 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>177 µs ± 3.28 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
</pre></div>
</div>
</div>
</div>
<p>The NumPy version is a hundred times faster than the list version.
The NumPy version is also faster to type, read, and troubleshoot, which are typically more important.
Our time is more valuable than the computer time!</p>
</section>
<section id="the-numpy-ndarray-a-multidimensional-array-object">
<h3>The NumPy ndarray: A Multidimensional Array Object<a class="headerlink" href="#the-numpy-ndarray-a-multidimensional-array-object" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>One of the key features of NumPy is its N-dimensional array object, or ndarray, which is a fast, flexible container for large datasets in Python. Arrays enable you to perform mathematical operations on whole blocks of data using similar syntax to the equivalent operations between scalar elements.</p>
</div></blockquote>
<p>We generate random data to explore NumPy arrays.
Whenever we generate random data, we should set the random number seed with <code class="docutils literal notranslate"><span class="pre">np.random.seed(42)</span></code>, which makes our random numbers repeatable.
If we use the same random number seed, our random numbers will be the same.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341]])
</pre></div>
</div>
</div>
</div>
<p>Multiplying <code class="docutils literal notranslate"><span class="pre">data</span></code> by 10 multiplies each element in <code class="docutils literal notranslate"><span class="pre">data</span></code> by 10, and adding <code class="docutils literal notranslate"><span class="pre">data</span></code> to itself adds each element to itself (i.e., element-wise addition).
To achieve this common-sense behavior, NumPy arrays must contain homogeneous data types (e.g., all floats or all integers).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">*</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 4.9671, -1.3826,  6.4769],
       [15.2303, -2.3415, -2.3414]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_2</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">data</span>
<span class="n">data_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.9934, -0.2765,  1.2954],
       [ 3.0461, -0.4683, -0.4683]])
</pre></div>
</div>
</div>
</div>
<p>NumPy arrays have attributes.
Recall that Jupyter Notebooks provides tab completion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2, 3)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype(&#39;float64&#39;)
</pre></div>
</div>
</div>
</div>
<p>We access or slice elements in a NumPy array using <code class="docutils literal notranslate"><span class="pre">[]</span></code>, the same as we slice lists and tuples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.4967, -0.1383,  0.6477])
</pre></div>
</div>
</div>
</div>
<p>As with list and tuples, we can chain <code class="docutils literal notranslate"><span class="pre">[]</span></code>s.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4967
</pre></div>
</div>
</div>
</div>
<p>However, with NumPy arrays. we can replace $n$ chained <code class="docutils literal notranslate"><span class="pre">[]</span></code>s with one pair of <code class="docutils literal notranslate"><span class="pre">[]</span></code>s containing $n$ values separated by commas.
For example, <code class="docutils literal notranslate"><span class="pre">[i][j]</span></code> becomes <code class="docutils literal notranslate"><span class="pre">[i,</span> <span class="pre">j]</span></code>, <code class="docutils literal notranslate"><span class="pre">[i][j][k]</span></code> becomes <code class="docutils literal notranslate"><span class="pre">[i,</span> <span class="pre">j,</span> <span class="pre">k]</span></code>.
This abbreviated notation is similar to what you see in your math and econometrics courses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># zero row, zero column</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4967
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<section id="creating-ndarrays">
<h4>Creating ndarrays<a class="headerlink" href="#creating-ndarrays" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>The easiest way to create an array is to use the array function. This accepts any sequence-like object (including other arrays) and produces a new NumPy array containing the passed data</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">arr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span>
<span class="n">arr1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([6. , 7.5, 8. , 0. , 1. ])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr1</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype(&#39;float64&#39;)
</pre></div>
</div>
</div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">np.array()</span></code> casts the values in <code class="docutils literal notranslate"><span class="pre">data1</span></code> to floats becuase NumPy arrays must have homogenous data types.
We could coerce these values to integers but would lose information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([6, 7, 8, 0, 1])
</pre></div>
</div>
</div>
</div>
<p>We can coerce or cast a list-of-lists to a two-dimensional NumPy array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data2</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>
<span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span>
<span class="n">arr2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1, 2, 3, 4],
       [5, 6, 7, 8]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr2</span><span class="o">.</span><span class="n">ndim</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr2</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2, 4)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr2</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype(&#39;int64&#39;)
</pre></div>
</div>
</div>
</div>
<p>There are several other ways to create NumPy arrays.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0.])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0., 0., 0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0.]])
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">np.arange()</span></code> function is similar to Python’s built-in <code class="docutils literal notranslate"><span class="pre">range()</span></code> but creates an array directly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14])
</pre></div>
</div>
</div>
</div>
<p><em><strong>Table 4-1</strong></em> from McKinney lists some NumPy array creation functions.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">array</span></code>: Convert input data (list, tuple, array, or other sequence type) to an ndarray either by inferring a dtype or explicitly specifying a dtype; copies the input data by default</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">asarray</span></code>:  Convert input to ndarray, but do not copy if the input is already an ndarray</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">arange</span></code>:  Like the built-in range but returns an ndarray instead of a list</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ones</span></code>, <code class="docutils literal notranslate"><span class="pre">ones_like</span></code>:  Produce an array of all 1s with the given shape and dtype; <code class="docutils literal notranslate"><span class="pre">ones_like</span></code> takes another array and produces a <code class="docutils literal notranslate"><span class="pre">ones</span></code> array of the - same shape and dtype</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zeros</span></code>, <code class="docutils literal notranslate"><span class="pre">zeros_like</span></code>:  Like <code class="docutils literal notranslate"><span class="pre">ones</span></code> and <code class="docutils literal notranslate"><span class="pre">ones_like</span></code> but producing arrays of 0s instead</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">empty</span></code>, <code class="docutils literal notranslate"><span class="pre">empty_like</span></code>:  Create new arrays by allocating new memory, but do not populate with any values like ones and zeros</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">full</span></code>, <code class="docutils literal notranslate"><span class="pre">full_like</span></code>:  Produce an array of the given shape and dtype with all values set to the indicated “fill value”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eye</span></code>, <code class="docutils literal notranslate"><span class="pre">identity</span></code>:  Create a square N-by-N identity matrix (1s on the diagonal and 0s elsewhere)</p></li>
</ul>
</section>
<section id="arithmetic-with-numpy-arrays">
<h4>Arithmetic with NumPy Arrays<a class="headerlink" href="#arithmetic-with-numpy-arrays" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>Arrays are important because they enable you to express batch operations on data without writing any for loops. NumPy users call this vectorization. Any arithmetic operations between equal-size arrays applies the operation element-wise</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]])</span>
<span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1., 2., 3.],
       [4., 5., 6.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2, 3)
</pre></div>
</div>
</div>
</div>
<p>NumPy array addition is elementwise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">+</span> <span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 2.,  4.,  6.],
       [ 8., 10., 12.]])
</pre></div>
</div>
</div>
</div>
<p>NumPy array multiplication is elementwise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">*</span> <span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.,  4.,  9.],
       [16., 25., 36.]])
</pre></div>
</div>
</div>
</div>
<p>NumPy array division is elementwise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">/</span> <span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1.    , 0.5   , 0.3333],
       [0.25  , 0.2   , 0.1667]])
</pre></div>
</div>
</div>
</div>
<p>NumPy powers are elementwise, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.,  4.,  9.],
       [16., 25., 36.]])
</pre></div>
</div>
</div>
</div>
<p>We can also raise a single value to an array!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span> <span class="o">**</span> <span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 2.,  4.,  8.],
       [16., 32., 64.]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="basic-indexing-and-slicing">
<h4>Basic Indexing and Slicing<a class="headerlink" href="#basic-indexing-and-slicing" title="Permalink to this heading">#</a></h4>
<p>One-dimensional array index and slice the same as lists.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([5, 6, 7])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">equiv_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">equiv_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">equiv_list</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[5, 6, 7]
</pre></div>
</div>
</div>
</div>
<p>We have to jump through some hoops if we want to replace elements 5, 6, and 7 in <code class="docutils literal notranslate"><span class="pre">equiv_list</span></code> with the value 12.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TypeError: can only assign an iterable</span>
<span class="c1"># equiv_list[5:8] = 12</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">equiv_list</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
<span class="n">equiv_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1, 2, 3, 4, 12, 12, 12, 8, 9]
</pre></div>
</div>
</div>
</div>
<p>However, this operation is easy with the NumPy array <code class="docutils literal notranslate"><span class="pre">arr</span></code>!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4, 12, 12, 12,  8,  9])
</pre></div>
</div>
</div>
</div>
<p>“Broadcasting” is the name for this behavior.</p>
<blockquote>
<div><p>As you can see, if you assign a scalar value to a slice, as in <code class="docutils literal notranslate"><span class="pre">arr[5:8]</span> <span class="pre">=</span> <span class="pre">12</span></code>, the value is propagated (or broadcasted henceforth) to the entire selection. An important first distinction from Python’s built-in lists is that array slices are views on the original array. This means that the data is not copied, and any modifications to the view will be reflected in the source array.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr_slice</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
<span class="n">arr_slice</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([12, 12, 12])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">arr_slice</span>
<span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([12, 12, 12])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="ow">is</span> <span class="n">arr_slice</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="ow">is</span> <span class="n">arr_slice</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12345</span>
<span class="n">arr_slice</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([   12, 12345,    12])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([    0,     1,     2,     3,     4,    12, 12345,    12,     8,
           9])
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">:</span></code> slices every element in <code class="docutils literal notranslate"><span class="pre">arr_slice</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr_slice</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">arr_slice</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([64, 64, 64])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4, 64, 64, 64,  8,  9])
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>If you want a copy of a slice of an ndarray instead of a view, you will need to explicitly copy the array-for example, <code class="docutils literal notranslate"><span class="pre">arr[5:8].copy()</span></code>.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr_slice_2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">arr_slice_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([64, 64, 64])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr_slice_2</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">2001</span>
<span class="n">arr_slice_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([2001, 2001, 2001])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4, 64, 64, 64,  8,  9])
</pre></div>
</div>
</div>
</div>
</section>
<section id="indexing-with-slices">
<h4>Indexing with slices<a class="headerlink" href="#indexing-with-slices" title="Permalink to this heading">#</a></h4>
<p>We can slice across two or more dimensions, including the <code class="docutils literal notranslate"><span class="pre">[i,</span> <span class="pre">j]</span></code> notation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]])</span>
<span class="n">arr2d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1, 2, 3],
       [4, 5, 6],
       [7, 8, 9]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr2d</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1, 2, 3],
       [4, 5, 6]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr2d</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[2, 3],
       [5, 6]])
</pre></div>
</div>
</div>
</div>
<p>A colon (<code class="docutils literal notranslate"><span class="pre">:</span></code>) by itself selects the entire dimension and is necessary to slice higher dimensions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr2d</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1],
       [4],
       [7]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr2d</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">arr2d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1, 0, 0],
       [4, 0, 0],
       [7, 8, 9]])
</pre></div>
</div>
</div>
</div>
<p>Slicing multi-dimension arrays is tricky!
<em><strong>Always check your output!</strong></em></p>
</section>
<section id="boolean-indexing">
<h4>Boolean Indexing<a class="headerlink" href="#boolean-indexing" title="Permalink to this heading">#</a></h4>
<p>We can use Booleans (<code class="docutils literal notranslate"><span class="pre">True</span></code>s and <code class="docutils literal notranslate"><span class="pre">False</span></code>s) to slice arrays, too.
Boolean indexing in Python is like combining <code class="docutils literal notranslate"><span class="pre">index()</span></code> and <code class="docutils literal notranslate"><span class="pre">match()</span></code> in Excel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="s1">&#39;Joe&#39;</span><span class="p">,</span> <span class="s1">&#39;Will&#39;</span><span class="p">,</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="s1">&#39;Will&#39;</span><span class="p">,</span> <span class="s1">&#39;Joe&#39;</span><span class="p">,</span> <span class="s1">&#39;Joe&#39;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;Bob&#39;, &#39;Joe&#39;, &#39;Will&#39;, &#39;Bob&#39;, &#39;Will&#39;, &#39;Joe&#39;, &#39;Joe&#39;], dtype=&#39;&lt;U4&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623],
       [-1.0128,  0.3142, -0.908 , -1.4123],
       [ 1.4656, -0.2258,  0.0675, -1.4247],
       [-0.5444,  0.1109, -1.151 ,  0.3757]])
</pre></div>
</div>
</div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">names</span></code> provides seven names for the seven rows in <code class="docutils literal notranslate"><span class="pre">data</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">==</span> <span class="s1">&#39;Bob&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ True, False, False,  True, False, False, False])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="n">names</span> <span class="o">==</span> <span class="s1">&#39;Bob&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [ 0.242 , -1.9133, -1.7249, -0.5623]])
</pre></div>
</div>
</div>
</div>
<p>We can combine Boolean slicing with <code class="docutils literal notranslate"><span class="pre">:</span></code> slicing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="n">names</span> <span class="o">==</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.6477,  1.523 ],
       [-1.7249, -0.5623]])
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">~</span></code> to invert a Boolean.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cond</span> <span class="o">=</span> <span class="n">names</span> <span class="o">==</span> <span class="s1">&#39;Bob&#39;</span>
<span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">cond</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [-1.0128,  0.3142, -0.908 , -1.4123],
       [ 1.4656, -0.2258,  0.0675, -1.4247],
       [-0.5444,  0.1109, -1.151 ,  0.3757]])
</pre></div>
</div>
</div>
</div>
<p>For NumPy arrays, we must use <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> and <code class="docutils literal notranslate"><span class="pre">|</span></code> instead of <code class="docutils literal notranslate"><span class="pre">and</span></code> and <code class="docutils literal notranslate"><span class="pre">or</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">names</span> <span class="o">==</span> <span class="s1">&#39;Bob&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">names</span> <span class="o">==</span> <span class="s1">&#39;Will&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623],
       [-1.0128,  0.3142, -0.908 , -1.4123]])
</pre></div>
</div>
</div>
</div>
<p>We can also create a Boolean for each element.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[False,  True, False, False],
       [ True,  True, False, False],
       [ True, False,  True,  True],
       [False,  True,  True,  True],
       [ True, False,  True,  True],
       [False,  True, False,  True],
       [ True, False,  True, False]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.4967, 0.    , 0.6477, 1.523 ],
       [0.    , 0.    , 1.5792, 0.7674],
       [0.    , 0.5426, 0.    , 0.    ],
       [0.242 , 0.    , 0.    , 0.    ],
       [0.    , 0.3142, 0.    , 0.    ],
       [1.4656, 0.    , 0.0675, 0.    ],
       [0.    , 0.1109, 0.    , 0.3757]])
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="universal-functions-fast-element-wise-array-functions">
<h3>Universal Functions: Fast Element-Wise Array Functions<a class="headerlink" href="#universal-functions-fast-element-wise-array-functions" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>A universal function, or ufunc, is a function that performs element-wise operations on data in ndarrays. You can think of them as fast vectorized wrappers for simple functions that take one or more scalar values and produce one or more scalar results.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.    , 1.    , 1.4142, 1.7321, 2.    , 2.2361, 2.4495, 2.6458,
       2.8284, 3.    ])
</pre></div>
</div>
</div>
</div>
<p>Like above, we can raise a single value to a NumPy array of powers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span><span class="o">**</span><span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([  1,   2,   4,   8,  16,  32,  64, 128, 256, 512])
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">np.exp(x)</span></code> is $e^x$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.0000e+00, 2.7183e+00, 7.3891e+00, 2.0086e+01, 5.4598e+01,
       1.4841e+02, 4.0343e+02, 1.0966e+03, 2.9810e+03, 8.1031e+03])
</pre></div>
</div>
</div>
</div>
<p>The functions above accept one argument.
These “unary” functions operate on one array and return a new array with the same shape.
There are also “binary” functions that operate on two arrays and return one array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.4967, -0.1383,  0.6477,  1.523 , -0.2342, -0.2341,  1.5792,
        0.7674])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.4695,  0.5426, -0.4634, -0.4657,  0.242 , -1.9133, -1.7249,
       -0.5623])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.4967,  0.5426,  0.6477,  1.523 ,  0.242 , -0.2341,  1.5792,
        0.7674])
</pre></div>
</div>
</div>
</div>
<p><em><strong>Be careful!
Function names are not the whole story.
Check your output and read the docstring!</strong></em>
For example, <code class="docutils literal notranslate"><span class="pre">np.max()</span></code> returns the maximum of an array, instead of the elementwise maximum of two arrays for <code class="docutils literal notranslate"><span class="pre">np.maximum()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.5792
</pre></div>
</div>
</div>
</div>
<p><em><strong>Table 4-4</strong></em> from McKinney lists some fast, element-wise unary functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">abs</span></code>, <code class="docutils literal notranslate"><span class="pre">fabs</span></code>: Compute the absolute value element-wise for integer, oating-point, or complex values</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sqrt</span></code>: Compute the square root of each element (equivalent to arr ** 0.5)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">square</span></code>: Compute the square of each element (equivalent to arr ** 2)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exp</span></code>: Compute the exponent $e^x$ of each element</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log</span></code>, <code class="docutils literal notranslate"><span class="pre">log10</span></code>, <code class="docutils literal notranslate"><span class="pre">log2</span></code>, <code class="docutils literal notranslate"><span class="pre">log1p</span></code>: Natural logarithm (base e), log base 10, log base 2, and log(1 + x), respectively</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sign</span></code>: Compute the sign of each element: 1 (positive), 0 (zero), or –1 (negative)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ceil</span></code>: Compute the ceiling of each element (i.e., the smallest integer greater than or equal to thatnumber)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">floor</span></code>: Compute the oor of each element (i.e., the largest integer less than or equal to each element)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rint</span></code>: Round elements to the nearest integer, preserving the dtype</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modf</span></code>: Return fractional and integral parts of array as a separate array</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">isnan</span></code>: Return boolean array indicating whether each value is NaN (Not a Number)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">isfinite</span></code>, <code class="docutils literal notranslate"><span class="pre">isinf</span></code>: Return boolean array indicating whether each element is finite (non-inf, non-NaN) or infinite, respectively</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cos</span></code>, <code class="docutils literal notranslate"><span class="pre">cosh</span></code>, <code class="docutils literal notranslate"><span class="pre">sin</span></code>, <code class="docutils literal notranslate"><span class="pre">sinh</span></code>, <code class="docutils literal notranslate"><span class="pre">tan</span></code>, <code class="docutils literal notranslate"><span class="pre">tanh</span></code>: Regular and hyperbolic trigonometric functions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">arccos</span></code>, <code class="docutils literal notranslate"><span class="pre">arccosh</span></code>, <code class="docutils literal notranslate"><span class="pre">arcsin</span></code>, <code class="docutils literal notranslate"><span class="pre">arcsinh</span></code>, <code class="docutils literal notranslate"><span class="pre">arctan</span></code>, <code class="docutils literal notranslate"><span class="pre">arctanh</span></code>: Inverse trigonometric functions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logical_not</span></code>: Compute truth value of not x element-wise (equivalent to ~arr).</p></li>
</ul>
<p><em><strong>Table 4-5</strong></em> from McKinney lists some fast, element-wise binary functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add</span></code>: Add corresponding elements in arrays</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">subtract</span></code>: Subtract elements in second array from first array</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">multiply</span></code>: Multiply array elements</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">divide</span></code>, <code class="docutils literal notranslate"><span class="pre">floor_divide</span></code>: Divide or floor divide (truncating the remainder)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">power</span></code>: Raise elements in first array to powers indicated in second array</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maximum</span></code>, <code class="docutils literal notranslate"><span class="pre">fmax</span></code>: Element-wise maximum; <code class="docutils literal notranslate"><span class="pre">fmax</span></code> ignores <code class="docutils literal notranslate"><span class="pre">NaN</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minimum</span></code>, <code class="docutils literal notranslate"><span class="pre">fmin</span></code>: Element-wise minimum; <code class="docutils literal notranslate"><span class="pre">fmin</span></code> ignores <code class="docutils literal notranslate"><span class="pre">NaN</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mod</span></code>: Element-wise modulus (remainder of division)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">copysign</span></code>: Copy sign of values in second argument to values in first argument</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">greater</span></code>, <code class="docutils literal notranslate"><span class="pre">greater_equal</span></code>, <code class="docutils literal notranslate"><span class="pre">less</span></code>, <code class="docutils literal notranslate"><span class="pre">less_equal</span></code>, <code class="docutils literal notranslate"><span class="pre">equal</span></code>, <code class="docutils literal notranslate"><span class="pre">not_equal</span></code>: Perform element-wise comparison, yielding boolean array (equivalent to infix operators &gt;, &gt;=, &lt;, &lt;=, ==, !=)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logical_and</span></code>, <code class="docutils literal notranslate"><span class="pre">logical_or</span></code>, <code class="docutils literal notranslate"><span class="pre">logical_xor</span></code>: Compute element-wise truth value of logical operation (equivalent to infix operators &amp; |, ^)</p></li>
</ul>
</section>
<section id="array-oriented-programming-with-arrays">
<h3>Array-Oriented Programming with Arrays<a class="headerlink" href="#array-oriented-programming-with-arrays" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>Using NumPy arrays enables you to express many kinds of data processing tasks as concise array expressions that might otherwise require writing loops. This practice of replacing explicit loops with array expressions is commonly referred to as vectorization. In general, vectorized array operations will often be one or two (or more) orders of magnitude faster than their pure Python equivalents, with the biggest impact in any kind of numerical computations. Later, in Appendix A, I explain broadcasting, a powerful method for vectorizing computations.</p>
</div></blockquote>
<section id="expressing-conditional-logic-as-array-operations">
<h4>Expressing Conditional Logic as Array Operations<a class="headerlink" href="#expressing-conditional-logic-as-array-operations" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>The numpy.where function is a vectorized version of the ternary expression x if condition else y.</p>
</div></blockquote>
<p>NumPy’s <code class="docutils literal notranslate"><span class="pre">where()</span></code> is an if-else statement that operates like Excel’s <code class="docutils literal notranslate"><span class="pre">if()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>
<span class="n">yarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">])</span>
<span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.1, 2.2, 1.3, 1.4, 2.5])
</pre></div>
</div>
</div>
</div>
<p>We could use a list comprehension, instead, but the list comprehension is takes longer to type, read, and troubleshoot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">x</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">,</span> <span class="n">cond</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.1, 2.2, 1.3, 1.4, 2.5])
</pre></div>
</div>
</div>
</div>
<p>We could also use <code class="docutils literal notranslate"><span class="pre">np.select()</span></code> here, but it is overkill to test one condition.
<code class="docutils literal notranslate"><span class="pre">np.select()</span></code> lets us test more more than one condition and provides a default value if no condition is met.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">cond</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span> <span class="n">cond</span><span class="o">==</span><span class="kc">False</span><span class="p">],</span>
    <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.1, 2.2, 1.3, 1.4, 2.5])
</pre></div>
</div>
</div>
</div>
</section>
<section id="mathematical-and-statistical-methods">
<h4>Mathematical and Statistical Methods<a class="headerlink" href="#mathematical-and-statistical-methods" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>A set of mathematical functions that compute statistics about an entire array or about the data along an axis are accessible as methods of the array class. You can use aggregations (often called reductions) like sum, mean, and std (standard deviation) either by calling the array instance method or using the top-level NumPy function.</p>
</div></blockquote>
<p>We will use these aggregations extensively in pandas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623],
       [-1.0128,  0.3142, -0.908 , -1.4123]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.1713
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-3.4260
</pre></div>
</div>
</div>
</div>
<p>The aggregation methods above aggregated the whole array.
We can use the <code class="docutils literal notranslate"><span class="pre">axis</span></code> argument to aggregate columns (<code class="docutils literal notranslate"><span class="pre">axis=0</span></code>) and rows (<code class="docutils literal notranslate"><span class="pre">axis=1</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.6323,  0.4696, -0.214 , -0.9896, -0.7547])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.6323
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.1956, -0.2858, -0.1739, -0.03  ])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.1956
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> method returns the sum of all previous elements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">arr</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  3,  6, 10, 15, 21, 28])
</pre></div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> method along the axis of a multi-dimension array, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]])</span>
<span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0, 1, 2],
       [3, 4, 5],
       [6, 7, 8]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0,  1,  2],
       [ 3,  5,  7],
       [ 9, 12, 15]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[  0,   0,   0],
       [  3,  12,  60],
       [  6,  42, 336]])
</pre></div>
</div>
</div>
</div>
<p><em><strong>Table 4-6</strong></em> from McKinney lists some basic statistical methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sum</span></code>: Sum of all the elements in the array or along an axis; zero-length arrays have sum 0</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mean</span></code>: Arithmetic mean; zero-length arrays have NaN mean</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">std</span></code>, <code class="docutils literal notranslate"><span class="pre">var</span></code>: Standard deviation and variance, respectively, with optional degrees of freedom adjustment (default denominator $n$)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code>: Minimum and maximum</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">argmin</span></code>, <code class="docutils literal notranslate"><span class="pre">argmax</span></code>: Indices of minimum and maximum elements, respectively</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cumsum</span></code>: Cumulative sum of elements starting from 0</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cumprod</span></code>: Cumulative product of elements starting from 1</p></li>
</ul>
</section>
<section id="methods-for-boolean-arrays">
<h4>Methods for Boolean Arrays<a class="headerlink" href="#methods-for-boolean-arrays" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.4967, -0.1383,  0.6477,  1.523 , -0.2342, -0.2341,  1.5792,
        0.7674, -0.4695,  0.5426, -0.4634, -0.4657,  0.242 , -1.9133,
       -1.7249, -0.5623, -1.0128,  0.3142, -0.908 , -1.4123,  1.4656,
       -0.2258,  0.0675, -1.4247, -0.5444,  0.1109, -1.151 ,  0.3757,
       -0.6006, -0.2917, -0.6017,  1.8523, -0.0135, -1.0577,  0.8225,
       -1.2208,  0.2089, -1.9597, -1.3282,  0.1969,  0.7385,  0.1714,
       -0.1156, -0.3011, -1.4785, -0.7198, -0.4606,  1.0571,  0.3436,
       -1.763 ,  0.3241, -0.3851, -0.6769,  0.6117,  1.031 ,  0.9313,
       -0.8392, -0.3092,  0.3313,  0.9755, -0.4792, -0.1857, -1.1063,
       -1.1962,  0.8125,  1.3562, -0.072 ,  1.0035,  0.3616, -0.6451,
        0.3614,  1.538 , -0.0358,  1.5646, -2.6197,  0.8219,  0.087 ,
       -0.299 ,  0.0918, -1.9876, -0.2197,  0.3571,  1.4779, -0.5183,
       -0.8085, -0.5018,  0.9154,  0.3288, -0.5298,  0.5133,  0.0971,
        0.9686, -0.7021, -0.3277, -0.3921, -1.4635,  0.2961,  0.2611,
        0.0051, -0.2346])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ True, False,  True,  True, False, False,  True,  True, False,
        True, False, False,  True, False, False, False, False,  True,
       False, False,  True, False,  True, False, False,  True, False,
        True, False, False, False,  True, False, False,  True, False,
        True, False, False,  True,  True,  True, False, False, False,
       False, False,  True,  True, False,  True, False, False,  True,
        True,  True, False, False,  True,  True, False, False, False,
       False,  True,  True, False,  True,  True, False,  True,  True,
       False,  True, False,  True,  True, False,  True, False, False,
        True,  True, False, False, False,  True,  True, False,  True,
        True,  True, False, False, False, False,  True,  True,  True,
       False])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># Number of positive values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>46
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># percentage of positive values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4600
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bools</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
<span class="n">bools</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([False, False,  True, False])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bools</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bools</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-mckinney_04_practice"></span><section id="mckinney-chapter-4-practice-blank">
<h3>McKinney Chapter 4 - Practice (Blank)<a class="headerlink" href="#mckinney-chapter-4-practice-blank" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">%</span><span class="k">precision</span> 4
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;%.4f&#39;
</pre></div>
</div>
</div>
</div>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1">
<h5>Create a 1-dimensional array named <code class="docutils literal notranslate"><span class="pre">a1</span></code> that counts from 0 to 24 by 1.<a class="headerlink" href="#create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1" title="Permalink to this heading">#</a></h5>
</section>
<section id="create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3">
<h5>Create a 1-dimentional array named <code class="docutils literal notranslate"><span class="pre">a2</span></code> that counts from 0 to 24 by 3.<a class="headerlink" href="#create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3" title="Permalink to this heading">#</a></h5>
</section>
<section id="create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-and-5">
<h5>Create a 1-dimentional array named <code class="docutils literal notranslate"><span class="pre">a3</span></code> that counts from 0 to 100 by multiples of 3 and 5.<a class="headerlink" href="#create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-and-5" title="Permalink to this heading">#</a></h5>
</section>
<section id="create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100-000">
<h5>Create a 1-dimensional array <code class="docutils literal notranslate"><span class="pre">a3</span></code> that contains the squares of the even integers through 100,000.<a class="headerlink" href="#create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100-000" title="Permalink to this heading">#</a></h5>
<p>How much faster is the NumPy version than the list comprehension version?</p>
</section>
<section id="write-a-function-that-mimic-excel-s-pv-function">
<h5>Write a function that mimic Excel’s <code class="docutils literal notranslate"><span class="pre">pv</span></code> function.<a class="headerlink" href="#write-a-function-that-mimic-excel-s-pv-function" title="Permalink to this heading">#</a></h5>
</section>
<section id="write-a-function-that-mimic-excel-s-fv-function">
<h5>Write a function that mimic Excel’s <code class="docutils literal notranslate"><span class="pre">fv</span></code> function.<a class="headerlink" href="#write-a-function-that-mimic-excel-s-fv-function" title="Permalink to this heading">#</a></h5>
</section>
<section id="replace-the-negative-values-in-data-with-1-and-positive-values-with-1">
<h5>Replace the negative values in <code class="docutils literal notranslate"><span class="pre">data</span></code> with -1 and positive values with +1.<a class="headerlink" href="#replace-the-negative-values-in-data-with-1-and-positive-values-with-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477,  1.523 , -0.2342, -0.2341,  1.5792],
       [ 0.7674, -0.4695,  0.5426, -0.4634, -0.4657,  0.242 , -1.9133],
       [-1.7249, -0.5623, -1.0128,  0.3142, -0.908 , -1.4123,  1.4656],
       [-0.2258,  0.0675, -1.4247, -0.5444,  0.1109, -1.151 ,  0.3757],
       [-0.6006, -0.2917, -0.6017,  1.8523, -0.0135, -1.0577,  0.8225],
       [-1.2208,  0.2089, -1.9597, -1.3282,  0.1969,  0.7385,  0.1714],
       [-0.1156, -0.3011, -1.4785, -0.7198, -0.4606,  1.0571,  0.3436]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">npmts()</span></code> that calculates the number of payments that generate $x%$ of the present value of a perpetuity.<a class="headerlink" href="#write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity" title="Permalink to this heading">#</a></h5>
<p>Your <code class="docutils literal notranslate"><span class="pre">npmts()</span></code> should accept arguments <code class="docutils literal notranslate"><span class="pre">c1</span></code>, <code class="docutils literal notranslate"><span class="pre">r</span></code>, and <code class="docutils literal notranslate"><span class="pre">g</span></code> that represent  $C_1$, $r$, and $g$.
The present value of a growing perpetuity is $PV = \frac{C_1}{r - g}$, and the present value of a growing annuity is $PV = \frac{C_1}{r - g}\left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]$.</p>
</section>
<section id="write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows">
<h5>Write a function that calculates the internal rate of return given a NumPy array of cash flows.<a class="headerlink" href="#write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows" title="Permalink to this heading">#</a></h5>
</section>
<section id="write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> that accepts <em>NumPy arrays</em> of prices and dividends and returns a <em>NumPy array</em> of returns.<a class="headerlink" href="#write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">])</span>
<span class="n">dividends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields">
<h5>Rewrite the function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> so it returns <em>NumPy arrays</em> of returns, capital gains yields, and dividend yields.<a class="headerlink" href="#rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields" title="Permalink to this heading">#</a></h5>
</section>
<section id="rescale-and-shift-numbers-so-that-they-cover-the-range-0-1">
<h5>Rescale and shift numbers so that they cover the range [0, 1]<a class="headerlink" href="#rescale-and-shift-numbers-so-that-they-cover-the-range-0-1" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">np.array([18.5,</span> <span class="pre">17.0,</span> <span class="pre">18.0,</span> <span class="pre">19.0,</span> <span class="pre">18.0])</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">np.array([0.75,</span> <span class="pre">0.0,</span> <span class="pre">0.5,</span> <span class="pre">1.0,</span> <span class="pre">0.5])</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">18.5</span><span class="p">,</span> <span class="mf">17.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-functions-var-and-std-that-calculate-variance-and-standard-deviation">
<h5>Write functions <code class="docutils literal notranslate"><span class="pre">var()</span></code> and <code class="docutils literal notranslate"><span class="pre">std()</span></code> that calculate variance and standard deviation.<a class="headerlink" href="#write-functions-var-and-std-that-calculate-variance-and-standard-deviation" title="Permalink to this heading">#</a></h5>
<p>NumPy’s <code class="docutils literal notranslate"><span class="pre">.var()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods return <em>population</em> statistics (i.e., denominators of $n$).
The pandas equivalents return <em>sample</em> statistics (denominators of $n-1$), which are more appropriate for financial data analysis where we have a sample instead of a population.</p>
<p>Both function should have an argument <code class="docutils literal notranslate"><span class="pre">sample</span></code> that is <code class="docutils literal notranslate"><span class="pre">True</span></code> by default so both functions return sample statistics by default.</p>
<p>Use the output of <code class="docutils literal notranslate"><span class="pre">returns()</span></code> to compare your functions with NumPy’s <code class="docutils literal notranslate"><span class="pre">.var()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods.</p>
</section>
</section>
</section>
<span id="document-mckinney_04_practice_03"></span><section id="mckinney-chapter-4-practice-section-3-monday-2-45-pm">
<h3>McKinney Chapter 4 - Practice (Section 3, Monday 2:45 PM)<a class="headerlink" href="#mckinney-chapter-4-practice-section-3-monday-2-45-pm" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">%</span><span class="k">precision</span> 4
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;%.4f&#39;
</pre></div>
</div>
</div>
</div>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1">
<h5>Create a 1-dimensional array named <code class="docutils literal notranslate"><span class="pre">a1</span></code> that counts from 0 to 24 by 1.<a class="headerlink" href="#create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="n">a1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24
</pre></div>
</div>
</div>
</div>
<p>How can we quickly slice the first five elements in <code class="docutils literal notranslate"><span class="pre">a1</span></code>? The next five elements in <code class="docutils literal notranslate"><span class="pre">a1</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 1, 2, 3, 4])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([5, 6, 7, 8, 9])
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3">
<h5>Create a 1-dimentional array named <code class="docutils literal notranslate"><span class="pre">a2</span></code> that counts from 0 to 24 by 3.<a class="headerlink" href="#create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  3,  6,  9, 12, 15, 18, 21, 24])
</pre></div>
</div>
</div>
</div>
<p>Here is the “Zen of Python”, which is an easter egg about the philosophy of Python.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">this</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The Zen of Python, by Tim Peters

Beautiful is better than ugly.
Explicit is better than implicit.
Simple is better than complex.
Complex is better than complicated.
Flat is better than nested.
Sparse is better than dense.
Readability counts.
Special cases aren&#39;t special enough to break the rules.
Although practicality beats purity.
Errors should never pass silently.
Unless explicitly silenced.
In the face of ambiguity, refuse the temptation to guess.
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you&#39;re Dutch.
Now is better than never.
Although never is often better than *right* now.
If the implementation is hard to explain, it&#39;s a bad idea.
If the implementation is easy to explain, it may be a good idea.
Namespaces are one honking great idea -- let&#39;s do more of those!
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-and-5">
<h5>Create a 1-dimentional array named <code class="docutils literal notranslate"><span class="pre">a3</span></code> that counts from 0 to 100 by multiples of 3 and 5.<a class="headerlink" href="#create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-and-5" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a3</span> <span class="o">=</span> <span class="n">a3</span><span class="p">[(</span><span class="n">a3</span><span class="o">%</span><span class="k">3</span>==0) | (a3%5==0)]
<span class="n">a3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  3,  5,  6,  9, 10, 12, 15, 18, 20, 21, 24, 25, 27, 30, 33, 35,
       36, 39, 40, 42, 45, 48, 50, 51, 54, 55, 57, 60, 63, 65, 66, 69, 70,
       72, 75, 78, 80, 81, 84, 85, 87, 90, 93, 95, 96, 99])
</pre></div>
</div>
</div>
</div>
<p>We can also use a list comprehension, then cast the results to be an array.
List comprehensions look like: <code class="docutils literal notranslate"><span class="pre">[function(i)</span> <span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">range(x)</span> <span class="pre">if</span> <span class="pre">condition</span> <span class="pre">on</span> <span class="pre">i]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">3</span>==0) | (i%5==0)])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  3,  5,  6,  9, 10, 12, 15, 18, 20, 21, 24, 25, 27, 30, 33, 35,
       36, 39, 40, 42, 45, 48, 50, 51, 54, 55, 57, 60, 63, 65, 66, 69, 70,
       72, 75, 78, 80, 81, 84, 85, 87, 90, 93, 95, 96, 99])
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100-000">
<h5>Create a 1-dimensional array <code class="docutils literal notranslate"><span class="pre">a3</span></code> that contains the squares of the even integers through 100,000.<a class="headerlink" href="#create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100-000" title="Permalink to this heading">#</a></h5>
<p>How much faster is the NumPy version than the list comprehension version?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> np.array([i**2 for i in range(0, 100_000, 2)])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.91 ms ± 42.5 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> np.arange(0, 100_000, 2)**2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>19.5 µs ± 144 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p><em><strong>Note:</strong></em>
On some platforms, <code class="docutils literal notranslate"><span class="pre">np.arange(0,</span> <span class="pre">100_001,</span> <span class="pre">2)</span></code> returns an array of 32-bit integers.
If we square this array of 32-bit integers, we get the wrong answer because the large values (e.g., $100,000^2$) are too large to represent as 32-bit integers.
Since we know that we need 54-bit integers for this calculation, we should explcitly set either <code class="docutils literal notranslate"><span class="pre">dtype='int64'</span></code> or <code class="docutils literal notranslate"><span class="pre">dtype=np.int64</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100_001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100_001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000])
</pre></div>
</div>
</div>
</div>
<p>This <a class="reference external" href="https://stackoverflow.com/a/1970697/334755">StackOverflow answer</a> is this best explanation I have found of this behavior.</p>
</section>
<hr class="docutils" />
<section id="write-a-function-that-mimic-excel-s-pv-function">
<h5>Write a function that mimic Excel’s <code class="docutils literal notranslate"><span class="pre">pv</span></code> function.<a class="headerlink" href="#write-a-function-that-mimic-excel-s-pv-function" title="Permalink to this heading">#</a></h5>
<p>Here is how we call Excel’s <code class="docutils literal notranslate"><span class="pre">pv</span></code> function:
<code class="docutils literal notranslate"><span class="pre">=PV(rate,</span> <span class="pre">nper,</span> <span class="pre">pmt,</span> <span class="pre">[fv],</span> <span class="pre">[type])</span></code>
We can use the annuity and lump sum present value formulas.</p>
<p>Present value of an annuity payment <code class="docutils literal notranslate"><span class="pre">pmt</span></code>:
$PV_{pmt} = \frac{pmt}{rate} \times \left(1 - \frac{1}{(1+rate)^{nper}} \right)$</p>
<p>Present value of a lump sum <code class="docutils literal notranslate"><span class="pre">fv</span></code>:
$PV_{fv} = \frac{fv}{(1+rate)^{nper}}$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pv</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">nper</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;END&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of pmt, if given</span>
        <span class="n">pv_pmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmt</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">nper</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pv_pmt</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">fv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of fv, if given</span>
        <span class="n">pv_fv</span> <span class="o">=</span> <span class="n">fv</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="n">nper</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pv_fv</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;END&#39;</span><span class="p">:</span> <span class="c1"># as-is if end of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">pv_pmt</span> <span class="o">+</span> <span class="n">pv_fv</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;BGN&#39;</span><span class="p">:</span> <span class="c1"># undo one period of discounting if bgn of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">pv_pmt</span> <span class="o">+</span> <span class="n">pv_fv</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># otherwise, ask use to specify end or bgn of period payments</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please enter END or BGN for the type argument&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pv</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nper</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fv</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1000.0000
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-that-mimic-excel-s-fv-function">
<h5>Write a function that mimic Excel’s <code class="docutils literal notranslate"><span class="pre">fv</span></code> function.<a class="headerlink" href="#write-a-function-that-mimic-excel-s-fv-function" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fv</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">nper</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;END&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of pmt, if given</span>
        <span class="n">fv_pmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmt</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="n">nper</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fv_pmt</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">fv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of fv, if given</span>
        <span class="n">fv_pv</span> <span class="o">=</span> <span class="n">pv</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="n">nper</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fv_fv</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;END&#39;</span><span class="p">:</span> <span class="c1"># as-is if end of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">fv_pmt</span> <span class="o">+</span> <span class="n">fv_pv</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;BGN&#39;</span><span class="p">:</span> <span class="c1"># undo one period of discounting if bgn of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">fv_pmt</span> <span class="o">+</span> <span class="n">fv_pv</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># otherwise, ask use to specify end or bgn of period payments</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please enter END or BGN for the type argument&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fv</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nper</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pv</span><span class="o">=-</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1000.0000
</pre></div>
</div>
</div>
</div>
</section>
<section id="replace-the-negative-values-in-data-with-1-and-positive-values-with-1">
<h5>Replace the negative values in <code class="docutils literal notranslate"><span class="pre">data</span></code> with -1 and positive values with +1.<a class="headerlink" href="#replace-the-negative-values-in-data-with-1-and-positive-values-with-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477,  1.523 , -0.2342, -0.2341,  1.5792],
       [ 0.7674, -0.4695,  0.5426, -0.4634, -0.4657,  0.242 , -1.9133],
       [-1.7249, -0.5623, -1.0128,  0.3142, -0.908 , -1.4123,  1.4656],
       [-0.2258,  0.0675, -1.4247, -0.5444,  0.1109, -1.151 ,  0.3757],
       [-0.6006, -0.2917, -0.6017,  1.8523, -0.0135, -1.0577,  0.8225],
       [-1.2208,  0.2089, -1.9597, -1.3282,  0.1969,  0.7385,  0.1714],
       [-0.1156, -0.3011, -1.4785, -0.7198, -0.4606,  1.0571,  0.3436]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data2</span><span class="p">[</span><span class="n">data2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">data2</span><span class="p">[</span><span class="n">data2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
<span class="n">data2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1., -1.,  1.,  1., -1., -1.,  1.],
       [ 1., -1.,  1., -1., -1.,  1., -1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1., -1.,  1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1.,  1.,  1.],
       [-1., -1., -1., -1., -1.,  1.,  1.]])
</pre></div>
</div>
</div>
</div>
<p>We could also use <code class="docutils literal notranslate"><span class="pre">np.select()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
<span class="n">data3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1, -1,  1,  1, -1, -1,  1],
       [ 1, -1,  1, -1, -1,  1, -1],
       [-1, -1, -1,  1, -1, -1,  1],
       [-1,  1, -1, -1,  1, -1,  1],
       [-1, -1, -1,  1, -1, -1,  1],
       [-1,  1, -1, -1,  1,  1,  1],
       [-1, -1, -1, -1, -1,  1,  1]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">data3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">npmts()</span></code> that calculates the number of payments that generate $x%$ of the present value of a perpetuity.<a class="headerlink" href="#write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity" title="Permalink to this heading">#</a></h5>
<p>Your <code class="docutils literal notranslate"><span class="pre">npmts()</span></code> should accept arguments <code class="docutils literal notranslate"><span class="pre">c1</span></code>, <code class="docutils literal notranslate"><span class="pre">r</span></code>, and <code class="docutils literal notranslate"><span class="pre">g</span></code> that represent  $C_1$, $r$, and $g$.
The present value of a growing perpetuity is $PV = \frac{C_1}{r - g}$, and the present value of a growing annuity is $PV = \frac{C_1}{r - g}\left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]$.</p>
<p>We can use the growing annuity and perpetuity formulas to show: $x = \left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]$.</p>
<p>Then: $1 - x = \left( \frac{1 + g}{1 + r} \right)^t$.</p>
<p>Finally: $t = \frac{\log(1-x)}{\log\left(\frac{1 + g}{1 + r}\right)}$</p>
<p><em><strong>We do not need to accept an argument <code class="docutils literal notranslate"><span class="pre">c1</span></code> because $C_1$ cancels out!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">npmts</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">npmts</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14.899977377480532
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows">
<h5>Write a function that calculates the internal rate of return given a NumPy array of cash flows.<a class="headerlink" href="#write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows" title="Permalink to this heading">#</a></h5>
<p>Here are some data where the $IRR$ is obvious!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">])</span>
<span class="n">irr</span> <span class="o">=</span> <span class="mf">0.1</span>
</pre></div>
</div>
</div>
</div>
<p>We want to replicate the following calculation with NumPy:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="mi">0</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.4210854715202004e-14
</pre></div>
</div>
</div>
</div>
<p>The following NumPy code calculates the present value interest factor for each cash flow:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="c1"># present value interest factor</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.    , 0.9091])
</pre></div>
</div>
</div>
</div>
<p>The following NumPy code calculates the present value for each cash flow:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="c1"># present value of each cash flow</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-100.,  100.])
</pre></div>
</div>
</div>
</div>
<p>We sum these present values of each cash flow to calculate the net present value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.4210854715202004e-14
</pre></div>
</div>
</div>
</div>
<p>The $IRR$ is the discount rate where $NPV=0$.
We can can use the NumPy code above to try different discount rates until $NPV=0$.
The following code is crude, but sufficient for week three of our class and highlights two tools:</p>
<ol class="arabic simple">
<li><p>Using a <code class="docutils literal notranslate"><span class="pre">while</span></code> to try different discount rates until our answer is within some tolerance</p></li>
<li><p>Using NumPy to perform repetitive calculations without a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">irr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
    <span class="n">npv</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">irr</span> <span class="o">=</span> <span class="n">guess</span>
    <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">npv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">irr</span> <span class="o">+=</span> <span class="n">inc</span>
        <span class="n">npv</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">irr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">irr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1000
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> that accepts <em>NumPy arrays</em> of prices and dividends and returns a <em>NumPy array</em> of returns.<a class="headerlink" href="#write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">])</span>
<span class="n">dividends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ])
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields">
<h5>Rewrite the function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> so it returns <em>NumPy arrays</em> of returns, capital gains yields, and dividend yields.<a class="headerlink" href="#rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">cg</span> <span class="o">+</span> <span class="n">dy</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;cg&#39;</span><span class="p">:</span> <span class="n">cg</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="n">dy</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;r&#39;: array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ]),
 &#39;cg&#39;: array([ 0.5   , -0.3333, -0.5   ,  1.    ,  0.5   , -0.3333,  0.5   ]),
 &#39;dy&#39;: array([0.01  , 0.0067, 0.01  , 0.04  , 0.02  , 0.0133, 0.02  ])}
</pre></div>
</div>
</div>
</div>
</section>
<section id="rescale-and-shift-numbers-so-that-they-cover-the-range-0-1">
<h5>Rescale and shift numbers so that they cover the range [0, 1]<a class="headerlink" href="#rescale-and-shift-numbers-so-that-they-cover-the-range-0-1" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">np.array([18.5,</span> <span class="pre">17.0,</span> <span class="pre">18.0,</span> <span class="pre">19.0,</span> <span class="pre">18.0])</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">np.array([0.75,</span> <span class="pre">0.0,</span> <span class="pre">0.5,</span> <span class="pre">1.0,</span> <span class="pre">0.5])</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">18.5</span><span class="p">,</span> <span class="mf">17.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">numbers</span> <span class="o">-</span> <span class="n">numbers</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">numbers</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.75, 0.  , 0.5 , 1.  , 0.5 ])
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-functions-var-and-std-that-calculate-variance-and-standard-deviation">
<h5>Write functions <code class="docutils literal notranslate"><span class="pre">var()</span></code> and <code class="docutils literal notranslate"><span class="pre">std()</span></code> that calculate variance and standard deviation.<a class="headerlink" href="#write-functions-var-and-std-that-calculate-variance-and-standard-deviation" title="Permalink to this heading">#</a></h5>
<p>NumPy’s <code class="docutils literal notranslate"><span class="pre">.var()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods return <em>population</em> statistics (i.e., denominators of $n$).
The pandas equivalents return <em>sample</em> statistics (denominators of $n-1$), which are more appropriate for financial data analysis where we have a sample instead of a population.</p>
<p>Both function should have an argument <code class="docutils literal notranslate"><span class="pre">sample</span></code> that is <code class="docutils literal notranslate"><span class="pre">True</span></code> by default so both functions return sample statistics by default.</p>
<p>Use the output of <code class="docutils literal notranslate"><span class="pre">returns()</span></code> to compare your functions with NumPy’s <code class="docutils literal notranslate"><span class="pre">.var()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span>
<span class="n">r</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.4967, -0.1383,  0.6477, ..., -0.113 ,  1.4691,  0.4764])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">ddof</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0003761089673018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0003761089673018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">var</span><span class="p">(),</span> <span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="n">ddof</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.000188036804731
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.000188036804731
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_04_practice_04"></span><section id="mckinney-chapter-4-practice-section-4-wednesday-11-45-am">
<h3>McKinney Chapter 4 - Practice (Section 4, Wednesday 11:45 AM)<a class="headerlink" href="#mckinney-chapter-4-practice-section-4-wednesday-11-45-am" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">%</span><span class="k">precision</span> 4
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;%.4f&#39;
</pre></div>
</div>
</div>
</div>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1">
<h5>Create a 1-dimensional array named <code class="docutils literal notranslate"><span class="pre">a1</span></code> that counts from 0 to 24 by 1.<a class="headerlink" href="#create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="n">a1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3">
<h5>Create a 1-dimentional array named <code class="docutils literal notranslate"><span class="pre">a2</span></code> that counts from 0 to 24 by 3.<a class="headerlink" href="#create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">a2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  3,  6,  9, 12, 15, 18, 21, 24])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  3,  6,  9, 12, 15, 18, 21, 24])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  3,  6,  9, 12, 15, 18, 21, 24])
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-or-5">
<h5>Create a 1-dimentional array named <code class="docutils literal notranslate"><span class="pre">a3</span></code> that counts from 0 to 100 by multiples of 3 or 5.<a class="headerlink" href="#create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-or-5" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
<span class="n">a3</span> <span class="o">=</span> <span class="n">a3</span><span class="p">[(</span><span class="n">a3</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a3</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
<span class="n">a3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
</pre></div>
</div>
</div>
</div>
<p>We can also create <code class="docutils literal notranslate"><span class="pre">a3</span></code> with a list comprehension.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a3_lc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">3</span>==0) or (i%5==0)])
<span class="n">a3_lc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a3</span> <span class="o">==</span> <span class="n">a3_lc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">a3</span> <span class="o">==</span> <span class="n">a3_lc</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a3</span> <span class="ow">is</span> <span class="n">a3_lc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100-000">
<h5>Create a 1-dimensional array <code class="docutils literal notranslate"><span class="pre">a3</span></code> that contains the squares of the even integers through 100,000.<a class="headerlink" href="#create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100-000" title="Permalink to this heading">#</a></h5>
<p>How much faster is the NumPy version than the list comprehension version?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> np.array([i**2 for i in range(100_001) if i%2==0])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.8 ms ± 21.5 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> np.array([i**2 for i in range(0, 100_001, 2)])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 ms ± 89 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> np.arange(0, 100_001, 2, dtype=np.int64)**2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20.4 µs ± 262 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p><em><strong>Note:</strong></em>
On some platforms, <code class="docutils literal notranslate"><span class="pre">np.arange(0,</span> <span class="pre">100_001,</span> <span class="pre">2)</span></code> returns an array of 32-bit integers.
If we square this array of 32-bit integers, we get the wrong answer because the large values (e.g., $100,000^2$) are too large to represent as 32-bit integers.
Since we know that we need 54-bit integers for this calculation, we should explcitly set either <code class="docutils literal notranslate"><span class="pre">dtype='int64'</span></code> or <code class="docutils literal notranslate"><span class="pre">dtype=np.int64</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100_001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100_001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000])
</pre></div>
</div>
</div>
</div>
<p>This <a class="reference external" href="https://stackoverflow.com/a/1970697/334755">StackOverflow answer</a> is this best explanation I have found of this behavior.</p>
</section>
<hr class="docutils" />
<section id="write-a-function-that-mimic-excel-s-pv-function">
<h5>Write a function that mimic Excel’s <code class="docutils literal notranslate"><span class="pre">pv</span></code> function.<a class="headerlink" href="#write-a-function-that-mimic-excel-s-pv-function" title="Permalink to this heading">#</a></h5>
<p>Here is how we call Excel’s <code class="docutils literal notranslate"><span class="pre">pv</span></code> function:
<code class="docutils literal notranslate"><span class="pre">=PV(rate,</span> <span class="pre">nper,</span> <span class="pre">pmt,</span> <span class="pre">[fv],</span> <span class="pre">[type])</span></code>
We can use the annuity and lump sum present value formulas.</p>
<p>Present value of an annuity payment <code class="docutils literal notranslate"><span class="pre">pmt</span></code>:
$PV_{pmt} = \frac{pmt}{rate} \times \left(1 - \frac{1}{(1+rate)^{nper}} \right)$</p>
<p>Present value of a lump sum <code class="docutils literal notranslate"><span class="pre">fv</span></code>:
$PV_{fv} = \frac{fv}{(1+rate)^{nper}}$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pv</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">nper</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;END&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pv_pmt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pv_pmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmt</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">nper</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">fv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pv_fv</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pv_fv</span> <span class="o">=</span> <span class="n">fv</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="n">nper</span>

    <span class="n">pv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">pv_pmt</span> <span class="o">+</span> <span class="n">pv_fv</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;END&#39;</span><span class="p">:</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">pv</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;BGN&#39;</span><span class="p">:</span>
        <span class="n">pv</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Enter END or BGN for type argument&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">pv</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pv</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nper</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fv</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1000.0000
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-that-mimic-excel-s-fv-function">
<h5>Write a function that mimic Excel’s <code class="docutils literal notranslate"><span class="pre">fv</span></code> function.<a class="headerlink" href="#write-a-function-that-mimic-excel-s-fv-function" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fv</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">nper</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;END&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of pmt, if given</span>
        <span class="n">fv_pmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmt</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="n">nper</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fv_pmt</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">fv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of fv, if given</span>
        <span class="n">fv_pv</span> <span class="o">=</span> <span class="n">pv</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="n">nper</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fv_fv</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;END&#39;</span><span class="p">:</span> <span class="c1"># as-is if end of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">fv_pmt</span> <span class="o">+</span> <span class="n">fv_pv</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;BGN&#39;</span><span class="p">:</span> <span class="c1"># undo one period of discounting if bgn of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">fv_pmt</span> <span class="o">+</span> <span class="n">fv_pv</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># otherwise, ask use to specify end or bgn of period payments</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please enter END or BGN for the type argument&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fv</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nper</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pv</span><span class="o">=-</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1000.0000
</pre></div>
</div>
</div>
</div>
</section>
<section id="replace-the-negative-values-in-data-with-1-and-positive-values-with-1">
<h5>Replace the negative values in <code class="docutils literal notranslate"><span class="pre">data</span></code> with -1 and positive values with +1.<a class="headerlink" href="#replace-the-negative-values-in-data-with-1-and-positive-values-with-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477,  1.523 , -0.2342, -0.2341,  1.5792],
       [ 0.7674, -0.4695,  0.5426, -0.4634, -0.4657,  0.242 , -1.9133],
       [-1.7249, -0.5623, -1.0128,  0.3142, -0.908 , -1.4123,  1.4656],
       [-0.2258,  0.0675, -1.4247, -0.5444,  0.1109, -1.151 ,  0.3757],
       [-0.6006, -0.2917, -0.6017,  1.8523, -0.0135, -1.0577,  0.8225],
       [-1.2208,  0.2089, -1.9597, -1.3282,  0.1969,  0.7385,  0.1714],
       [-0.1156, -0.3011, -1.4785, -0.7198, -0.4606,  1.0571,  0.3436]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_c</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_c</span><span class="p">[</span><span class="n">data_c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">data_c</span><span class="p">[</span><span class="n">data_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

<span class="n">data_c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1., -1.,  1.,  1., -1., -1.,  1.],
       [ 1., -1.,  1., -1., -1.,  1., -1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1., -1.,  1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1.,  1.,  1.],
       [-1., -1., -1., -1., -1.,  1.,  1.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477,  1.523 , -0.2342, -0.2341,  1.5792],
       [ 0.7674, -0.4695,  0.5426, -0.4634, -0.4657,  0.242 , -1.9133],
       [-1.7249, -0.5623, -1.0128,  0.3142, -0.908 , -1.4123,  1.4656],
       [-0.2258,  0.0675, -1.4247, -0.5444,  0.1109, -1.151 ,  0.3757],
       [-0.6006, -0.2917, -0.6017,  1.8523, -0.0135, -1.0577,  0.8225],
       [-1.2208,  0.2089, -1.9597, -1.3282,  0.1969,  0.7385,  0.1714],
       [-0.1156, -0.3011, -1.4785, -0.7198, -0.4606,  1.0571,  0.3436]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1., -1.,  1.,  1., -1., -1.,  1.],
       [ 1., -1.,  1., -1., -1.,  1., -1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1., -1.,  1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1.,  1.,  1.],
       [-1., -1., -1., -1., -1.,  1.,  1.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1, -1,  1,  1, -1, -1,  1],
       [ 1, -1,  1, -1, -1,  1, -1],
       [-1, -1, -1,  1, -1, -1,  1],
       [-1,  1, -1, -1,  1, -1,  1],
       [-1, -1, -1,  1, -1, -1,  1],
       [-1,  1, -1, -1,  1,  1,  1],
       [-1, -1, -1, -1, -1,  1,  1]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">npmts()</span></code> that calculates the number of payments that generate $x%$ of the present value of a perpetuity.<a class="headerlink" href="#write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity" title="Permalink to this heading">#</a></h5>
<p>Your <code class="docutils literal notranslate"><span class="pre">npmts()</span></code> should accept arguments <code class="docutils literal notranslate"><span class="pre">c1</span></code>, <code class="docutils literal notranslate"><span class="pre">r</span></code>, and <code class="docutils literal notranslate"><span class="pre">g</span></code> that represent  $C_1$, $r$, and $g$.
The present value of a growing perpetuity is $PV = \frac{C_1}{r - g}$, and the present value of a growing annuity is $PV = \frac{C_1}{r - g}\left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]$.</p>
<p>We can use the growing annuity and perpetuity formulas to show: $x = \left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]$.</p>
<p>Then: $1 - x = \left( \frac{1 + g}{1 + r} \right)^t$.</p>
<p>Finally: $t = \frac{\log(1-x)}{\log\left(\frac{1 + g}{1 + r}\right)}$</p>
<p><em><strong>We do not need to accept an argument <code class="docutils literal notranslate"><span class="pre">c1</span></code> because $C_1$ cancels out!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">npmts</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">npmts</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14.899977377480532
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows">
<h5>Write a function that calculates the internal rate of return given a NumPy array of cash flows.<a class="headerlink" href="#write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows" title="Permalink to this heading">#</a></h5>
<p>Here are some data where the $IRR$ is obvious!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">])</span>
<span class="n">irr</span> <span class="o">=</span> <span class="mf">0.1</span>
</pre></div>
</div>
</div>
</div>
<p>We want to replicate the following calculation with NumPy:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="mi">0</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.4210854715202004e-14
</pre></div>
</div>
</div>
</div>
<p>The following NumPy code calculates the present value interest factor for each cash flow:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="c1"># present value interest factor</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.    , 0.9091])
</pre></div>
</div>
</div>
</div>
<p>The following NumPy code calculates the present value for each cash flow:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="c1"># present value of each cash flow</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-100.,  100.])
</pre></div>
</div>
</div>
</div>
<p>We sum these present values of each cash flow to calculate the net present value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.4210854715202004e-14
</pre></div>
</div>
</div>
</div>
<p>The $IRR$ is the discount rate where $NPV=0$.
We can can use the NumPy code above to try different discount rates until $NPV=0$.
The following code is crude, but sufficient for week three of our class and highlights two tools:</p>
<ol class="arabic simple">
<li><p>Using a <code class="docutils literal notranslate"><span class="pre">while</span></code> to try different discount rates until our answer is within some tolerance</p></li>
<li><p>Using NumPy to perform repetitive calculations without a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">irr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
    <span class="n">npv</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">irr</span> <span class="o">=</span> <span class="n">guess</span>
    <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">npv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">irr</span> <span class="o">+=</span> <span class="n">inc</span>
        <span class="n">npv</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">irr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">irr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1000
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> that accepts <em>NumPy arrays</em> of prices and dividends and returns a <em>NumPy array</em> of returns.<a class="headerlink" href="#write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">])</span>
<span class="n">dividends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ])
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields">
<h5>Rewrite the function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> so it returns <em>NumPy arrays</em> of returns, capital gains yields, and dividend yields.<a class="headerlink" href="#rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">cg</span> <span class="o">+</span> <span class="n">dy</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;cg&#39;</span><span class="p">:</span> <span class="n">cg</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="n">dy</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;r&#39;: array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ]),
 &#39;cg&#39;: array([ 0.5   , -0.3333, -0.5   ,  1.    ,  0.5   , -0.3333,  0.5   ]),
 &#39;dy&#39;: array([0.01  , 0.0067, 0.01  , 0.04  , 0.02  , 0.0133, 0.02  ])}
</pre></div>
</div>
</div>
</div>
</section>
<section id="rescale-and-shift-numbers-so-that-they-cover-the-range-0-1">
<h5>Rescale and shift numbers so that they cover the range [0, 1]<a class="headerlink" href="#rescale-and-shift-numbers-so-that-they-cover-the-range-0-1" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">np.array([18.5,</span> <span class="pre">17.0,</span> <span class="pre">18.0,</span> <span class="pre">19.0,</span> <span class="pre">18.0])</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">np.array([0.75,</span> <span class="pre">0.0,</span> <span class="pre">0.5,</span> <span class="pre">1.0,</span> <span class="pre">0.5])</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">18.5</span><span class="p">,</span> <span class="mf">17.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">numbers</span> <span class="o">-</span> <span class="n">numbers</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">numbers</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.75, 0.  , 0.5 , 1.  , 0.5 ])
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-functions-var-and-std-that-calculate-variance-and-standard-deviation">
<h5>Write functions <code class="docutils literal notranslate"><span class="pre">var()</span></code> and <code class="docutils literal notranslate"><span class="pre">std()</span></code> that calculate variance and standard deviation.<a class="headerlink" href="#write-functions-var-and-std-that-calculate-variance-and-standard-deviation" title="Permalink to this heading">#</a></h5>
<p>NumPy’s <code class="docutils literal notranslate"><span class="pre">.var()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods return <em>population</em> statistics (i.e., denominators of $n$).
The pandas equivalents return <em>sample</em> statistics (denominators of $n-1$), which are more appropriate for financial data analysis where we have a sample instead of a population.</p>
<p>Both function should have an argument <code class="docutils literal notranslate"><span class="pre">sample</span></code> that is <code class="docutils literal notranslate"><span class="pre">True</span></code> by default so both functions return sample statistics by default.</p>
<p>Use the output of <code class="docutils literal notranslate"><span class="pre">returns()</span></code> to compare your functions with NumPy’s <code class="docutils literal notranslate"><span class="pre">.var()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span>
<span class="n">r</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.4967, -0.1383,  0.6477, ..., -0.113 ,  1.4691,  0.4764])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">ddof</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0003761089673018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0003761089673018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">var</span><span class="p">(),</span> <span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="n">ddof</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.000188036804731
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.000188036804731
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_04_practice_02"></span><section id="mckinney-chapter-4-practice-section-2-wednesday-2-45-pm">
<h3>McKinney Chapter 4 - Practice (Section 2, Wednesday 2:45 PM)<a class="headerlink" href="#mckinney-chapter-4-practice-section-2-wednesday-2-45-pm" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">%</span><span class="k">precision</span> 4
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;%.4f&#39;
</pre></div>
</div>
</div>
</div>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1">
<h5>Create a 1-dimensional array named <code class="docutils literal notranslate"><span class="pre">a1</span></code> that counts from 0 to 24 by 1.<a class="headerlink" href="#create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3">
<h5>Create a 1-dimentional array named <code class="docutils literal notranslate"><span class="pre">a2</span></code> that counts from 0 to 24 by 3.<a class="headerlink" href="#create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">a2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  3,  6,  9, 12, 15, 18, 21, 24])
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-or-5">
<h5>Create a 1-dimentional array named <code class="docutils literal notranslate"><span class="pre">a3</span></code> that counts from 0 to 100 by multiples of 3 or 5.<a class="headerlink" href="#create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-or-5" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">3</span>==0) or (i%5==0)])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
<span class="n">a3</span> <span class="o">=</span> <span class="n">a3</span><span class="p">[(</span><span class="n">a3</span><span class="o">%</span><span class="k">3</span>==0) | (a3%5==0)] # NumPy only accepts &amp; for &quot;and&quot; and | for &quot;or&quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100-000">
<h5>Create a 1-dimensional array <code class="docutils literal notranslate"><span class="pre">a3</span></code> that contains the squares of the even integers through 100,000.<a class="headerlink" href="#create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100-000" title="Permalink to this heading">#</a></h5>
<p>How much faster is the NumPy version than the list comprehension version?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100_001</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">2</span>==0)])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100_001</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100_001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p><em><strong>Note:</strong></em>
On some platforms, <code class="docutils literal notranslate"><span class="pre">np.arange(0,</span> <span class="pre">100_001,</span> <span class="pre">2)</span></code> returns an array of 32-bit integers.
If we square this array of 32-bit integers, we get the wrong answer because the large values (e.g., $100,000^2$) are too large to represent as 32-bit integers.
Since we know that we need 54-bit integers for this calculation, we should explcitly set either <code class="docutils literal notranslate"><span class="pre">dtype='int64'</span></code> or <code class="docutils literal notranslate"><span class="pre">dtype=np.int64</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100_001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100_001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000])
</pre></div>
</div>
</div>
</div>
<p>This <a class="reference external" href="https://stackoverflow.com/a/1970697/334755">StackOverflow answer</a> is this best explanation I have found of this behavior.</p>
</section>
<hr class="docutils" />
<section id="write-a-function-that-mimic-excel-s-pv-function">
<h5>Write a function that mimic Excel’s <code class="docutils literal notranslate"><span class="pre">pv</span></code> function.<a class="headerlink" href="#write-a-function-that-mimic-excel-s-pv-function" title="Permalink to this heading">#</a></h5>
<p>Here is how we call Excel’s <code class="docutils literal notranslate"><span class="pre">pv</span></code> function:
<code class="docutils literal notranslate"><span class="pre">=PV(rate,</span> <span class="pre">nper,</span> <span class="pre">pmt,</span> <span class="pre">[fv],</span> <span class="pre">[type])</span></code>
We can use the annuity and lump sum present value formulas.</p>
<p>Present value of an annuity payment <code class="docutils literal notranslate"><span class="pre">pmt</span></code>:
$PV_{pmt} = \frac{pmt}{rate} \times \left(1 - \frac{1}{(1+rate)^{nper}} \right)$</p>
<p>Present value of a lump sum <code class="docutils literal notranslate"><span class="pre">fv</span></code>:
$PV_{fv} = \frac{fv}{(1+rate)^{nper}}$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pv</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">nper</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;END&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of pmt, if given</span>
        <span class="n">pv_pmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmt</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">nper</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pv_pmt</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">fv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of fv, if given</span>
        <span class="n">pv_fv</span> <span class="o">=</span> <span class="n">fv</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="n">nper</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pv_fv</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;END&#39;</span><span class="p">:</span> <span class="c1"># as-is if end of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">pv_pmt</span> <span class="o">+</span> <span class="n">pv_fv</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;BGN&#39;</span><span class="p">:</span> <span class="c1"># undo one period of discounting if bgn of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">pv_pmt</span> <span class="o">+</span> <span class="n">pv_fv</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># otherwise, ask use to specify end or bgn of period payments</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please enter END or BGN for the type argument&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pv</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nper</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fv</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1000.0000
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-that-mimic-excel-s-fv-function">
<h5>Write a function that mimic Excel’s <code class="docutils literal notranslate"><span class="pre">fv</span></code> function.<a class="headerlink" href="#write-a-function-that-mimic-excel-s-fv-function" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fv</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">nper</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;END&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of pmt, if given</span>
        <span class="n">fv_pmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmt</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="n">nper</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fv_pmt</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">fv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># calculate PV of fv, if given</span>
        <span class="n">fv_pv</span> <span class="o">=</span> <span class="n">pv</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span><span class="o">**</span><span class="n">nper</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fv_fv</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;END&#39;</span><span class="p">:</span> <span class="c1"># as-is if end of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">fv_pmt</span> <span class="o">+</span> <span class="n">fv_pv</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;BGN&#39;</span><span class="p">:</span> <span class="c1"># undo one period of discounting if bgn of period payments</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">fv_pmt</span> <span class="o">+</span> <span class="n">fv_pv</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># otherwise, ask use to specify end or bgn of period payments</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please enter END or BGN for the type argument&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fv</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nper</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pmt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pv</span><span class="o">=-</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1000.0000
</pre></div>
</div>
</div>
</div>
</section>
<section id="replace-the-negative-values-in-data-with-1-and-positive-values-with-1">
<h5>Replace the negative values in <code class="docutils literal notranslate"><span class="pre">data</span></code> with -1 and positive values with +1.<a class="headerlink" href="#replace-the-negative-values-in-data-with-1-and-positive-values-with-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.4967, -0.1383,  0.6477,  1.523 , -0.2342, -0.2341,  1.5792],
       [ 0.7674, -0.4695,  0.5426, -0.4634, -0.4657,  0.242 , -1.9133],
       [-1.7249, -0.5623, -1.0128,  0.3142, -0.908 , -1.4123,  1.4656],
       [-0.2258,  0.0675, -1.4247, -0.5444,  0.1109, -1.151 ,  0.3757],
       [-0.6006, -0.2917, -0.6017,  1.8523, -0.0135, -1.0577,  0.8225],
       [-1.2208,  0.2089, -1.9597, -1.3282,  0.1969,  0.7385,  0.1714],
       [-0.1156, -0.3011, -1.4785, -0.7198, -0.4606,  1.0571,  0.3436]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_c</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_c</span><span class="p">[</span><span class="n">data_c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">data_c</span><span class="p">[</span><span class="n">data_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
<span class="n">data_c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1., -1.,  1.,  1., -1., -1.,  1.],
       [ 1., -1.,  1., -1., -1.,  1., -1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1., -1.,  1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1.,  1.,  1.],
       [-1., -1., -1., -1., -1.,  1.,  1.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1., -1.,  1.,  1., -1., -1.,  1.],
       [ 1., -1.,  1., -1., -1.,  1., -1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1., -1.,  1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1.,  1.,  1.],
       [-1., -1., -1., -1., -1.,  1.,  1.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">)),</span> <span class="n">data_c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="n">data</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1., -1.,  1.,  1., -1., -1.,  1.],
       [ 1., -1.,  1., -1., -1.,  1., -1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1., -1.,  1.],
       [-1., -1., -1.,  1., -1., -1.,  1.],
       [-1.,  1., -1., -1.,  1.,  1.,  1.],
       [-1., -1., -1., -1., -1.,  1.,  1.]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">npmts()</span></code> that calculates the number of payments that generate $x%$ of the present value of a perpetuity.<a class="headerlink" href="#write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity" title="Permalink to this heading">#</a></h5>
<p>Your <code class="docutils literal notranslate"><span class="pre">npmts()</span></code> should accept arguments <code class="docutils literal notranslate"><span class="pre">c1</span></code>, <code class="docutils literal notranslate"><span class="pre">r</span></code>, and <code class="docutils literal notranslate"><span class="pre">g</span></code> that represent  $C_1$, $r$, and $g$.
The present value of a growing perpetuity is $PV = \frac{C_1}{r - g}$, and the present value of a growing annuity is $PV = \frac{C_1}{r - g}\left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]$.</p>
<p>We can use the growing annuity and perpetuity formulas to show: $x = \left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]$.</p>
<p>Then: $1 - x = \left( \frac{1 + g}{1 + r} \right)^t$.</p>
<p>Finally: $t = \frac{\log(1-x)}{\log\left(\frac{1 + g}{1 + r}\right)}$</p>
<p><em><strong>We do not need to accept an argument <code class="docutils literal notranslate"><span class="pre">c1</span></code> because $C_1$ cancels out!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">npmts</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">npmts</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14.899977377480532
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows">
<h5>Write a function that calculates the internal rate of return given a NumPy array of cash flows.<a class="headerlink" href="#write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows" title="Permalink to this heading">#</a></h5>
<p>Here are some data where the $IRR$ is obvious!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">])</span>
<span class="n">irr</span> <span class="o">=</span> <span class="mf">0.1</span>
</pre></div>
</div>
</div>
</div>
<p>We want to replicate the following calculation with NumPy:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="mi">0</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.4210854715202004e-14
</pre></div>
</div>
</div>
</div>
<p>The following NumPy code calculates the present value interest factor for each cash flow:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="c1"># present value interest factor</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.    , 0.9091])
</pre></div>
</div>
</div>
</div>
<p>The following NumPy code calculates the present value for each cash flow:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="c1"># present value of each cash flow</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-100.,  100.])
</pre></div>
</div>
</div>
</div>
<p>We sum these present values of each cash flow to calculate the net present value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.4210854715202004e-14
</pre></div>
</div>
</div>
</div>
<p>The $IRR$ is the discount rate where $NPV=0$.
We can can use the NumPy code above to try different discount rates until $NPV=0$.
The following code is crude, but sufficient for week three of our class and highlights two tools:</p>
<ol class="arabic simple">
<li><p>Using a <code class="docutils literal notranslate"><span class="pre">while</span></code> to try different discount rates until our answer is within some tolerance</p></li>
<li><p>Using NumPy to perform repetitive calculations without a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">irr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
    <span class="n">npv</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">irr</span> <span class="o">=</span> <span class="n">guess</span>
    <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">npv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">irr</span> <span class="o">+=</span> <span class="n">inc</span>
        <span class="n">npv</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">irr</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">irr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">irr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1000
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> that accepts <em>NumPy arrays</em> of prices and dividends and returns a <em>NumPy array</em> of returns.<a class="headerlink" href="#write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">])</span>
<span class="n">dividends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ])
</pre></div>
</div>
</div>
</div>
</section>
<section id="rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields">
<h5>Rewrite the function <code class="docutils literal notranslate"><span class="pre">returns()</span></code> so it returns <em>NumPy arrays</em> of returns, capital gains yields, and dividend yields.<a class="headerlink" href="#rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">cg</span> <span class="o">+</span> <span class="n">dy</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;cg&#39;</span><span class="p">:</span> <span class="n">cg</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="n">dy</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dividends</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;r&#39;: array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ]),
 &#39;cg&#39;: array([ 0.5   , -0.3333, -0.5   ,  1.    ,  0.5   , -0.3333,  0.5   ]),
 &#39;dy&#39;: array([0.01  , 0.0067, 0.01  , 0.04  , 0.02  , 0.0133, 0.02  ])}
</pre></div>
</div>
</div>
</div>
</section>
<section id="rescale-and-shift-numbers-so-that-they-cover-the-range-0-1">
<h5>Rescale and shift numbers so that they cover the range [0, 1]<a class="headerlink" href="#rescale-and-shift-numbers-so-that-they-cover-the-range-0-1" title="Permalink to this heading">#</a></h5>
<p>Input: <code class="docutils literal notranslate"><span class="pre">np.array([18.5,</span> <span class="pre">17.0,</span> <span class="pre">18.0,</span> <span class="pre">19.0,</span> <span class="pre">18.0])</span></code> <br />
Output: <code class="docutils literal notranslate"><span class="pre">np.array([0.75,</span> <span class="pre">0.0,</span> <span class="pre">0.5,</span> <span class="pre">1.0,</span> <span class="pre">0.5])</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">18.5</span><span class="p">,</span> <span class="mf">17.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">numbers</span> <span class="o">-</span> <span class="n">numbers</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">numbers</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.75, 0.  , 0.5 , 1.  , 0.5 ])
</pre></div>
</div>
</div>
</div>
</section>
<section id="write-functions-var-and-std-that-calculate-variance-and-standard-deviation">
<h5>Write functions <code class="docutils literal notranslate"><span class="pre">var()</span></code> and <code class="docutils literal notranslate"><span class="pre">std()</span></code> that calculate variance and standard deviation.<a class="headerlink" href="#write-functions-var-and-std-that-calculate-variance-and-standard-deviation" title="Permalink to this heading">#</a></h5>
<p>NumPy’s <code class="docutils literal notranslate"><span class="pre">.var()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods return <em>population</em> statistics (i.e., denominators of $n$).
The pandas equivalents return <em>sample</em> statistics (denominators of $n-1$), which are more appropriate for financial data analysis where we have a sample instead of a population.</p>
<p>Both function should have an argument <code class="docutils literal notranslate"><span class="pre">sample</span></code> that is <code class="docutils literal notranslate"><span class="pre">True</span></code> by default so both functions return sample statistics by default.</p>
<p>Use the output of <code class="docutils literal notranslate"><span class="pre">returns()</span></code> to compare your functions with NumPy’s <code class="docutils literal notranslate"><span class="pre">.var()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span>
<span class="n">r</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.4967, -0.1383,  0.6477, ..., -0.113 ,  1.4691,  0.4764])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">ddof</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0003761089673018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0003761089673018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">var</span><span class="p">(),</span> <span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="n">ddof</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.000188036804731
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.000188036804731
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-mckinney_05_lecture"></span><section id="mckinney-chapter-5-getting-started-with-pandas">
<h2>McKinney Chapter 5 - Getting Started with pandas<a class="headerlink" href="#mckinney-chapter-5-getting-started-with-pandas" title="Permalink to this heading">#</a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h3>
<p>Chapter 5 of Wes McKinney’s <a class="reference external" href="https://wesmckinney.com/book/"><em>Python for Data Analysis</em></a> discusses the fundamentals of pandas, which will be our main tool for the rest of the semester.
pandas is an abbrviation for <em>pan</em>el <em>da</em>ta, which provide time-stamped data for multiple individuals or firms.</p>
<p><em><strong>Note:</strong></em>
Indented block quotes are from McKinney unless otherwise indicated.
The section numbers here differ from McKinney because we will only discuss some topics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>pandas will be a major tool of interest throughout much of the rest of the book. It contains data structures and data manipulation tools designed to make data cleaning and analysis fast and easy in Python. pandas is often used in tandem with numerical computing tools like NumPy and SciPy, analytical libraries like statsmodels and scikit-learn, and data visualization libraries like matplotlib. pandas adopts significant parts of NumPy’s idiomatic style of array-based computing, especially array-based functions and a preference for data processing without for loops.</p>
<p>While pandas adopts many coding idioms from NumPy, the biggest difference is that pandas is designed for working with tabular or heterogeneous data. NumPy, by contrast, is best suited for working with homogeneous numerical array data.</p>
</div></blockquote>
<p>We will use pandas—a wrapper for NumPy that helps us manipulate and combine data—every day for the rest of the course.</p>
</section>
<section id="introduction-to-pandas-data-structures">
<h3>Introduction to pandas Data Structures<a class="headerlink" href="#introduction-to-pandas-data-structures" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>To get started with pandas, you will need to get comfortable with its two workhorse data structures: Series and DataFrame. While they are not a universal solution for every problem, they provide a solid, easy-to-use basis for most applications.</p>
</div></blockquote>
<section id="series">
<h4>Series<a class="headerlink" href="#series" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>A Series is a one-dimensional array-like object containing a sequence of values (of similar types to NumPy types) and an associated array of data labels, called its index. The simplest Series is formed from only an array of data.</p>
</div></blockquote>
<p>The early examples use integer and string labels, but date-time labels are most useful.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">obj</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    4
1    7
2   -5
3    3
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Contrast <code class="docutils literal notranslate"><span class="pre">obj</span></code> with a NumPy array equivalent:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 4,  7, -5,  3])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 4,  7, -5,  3])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="o">.</span><span class="n">index</span>  <span class="c1"># similar to range(4)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RangeIndex(start=0, stop=4, step=1)
</pre></div>
</div>
</div>
</div>
<p>We did not explicitly assign an index to <code class="docutils literal notranslate"><span class="pre">obj</span></code>, so <code class="docutils literal notranslate"><span class="pre">obj</span></code> has an integer index that starts at 0.
We can explicitly assign an index with the <code class="docutils literal notranslate"><span class="pre">index=</span></code> argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
<span class="n">obj2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>d    4
b    7
a   -5
c    3
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj2</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;d&#39;, &#39;b&#39;, &#39;a&#39;, &#39;c&#39;], dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj2</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj2</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">obj2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>d    6
b    7
a   -5
c    3
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj2</span><span class="p">[[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c    3
a   -5
d    6
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>A pandas series behaves like a NumPy array.
We can use Boolean filters and perform vectorized mathematical operations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj2</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>d     True
b     True
a    False
c     True
dtype: bool
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj2</span><span class="p">[</span><span class="n">obj2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>d    6
b    7
c    3
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj2</span> <span class="o">*</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>d    12
b    14
a   -10
c     6
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">obj2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;e&#39;</span> <span class="ow">in</span> <span class="n">obj2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p>We can create a pandas series from a dictionary.
The dictionary labels become the series index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sdata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Ohio&#39;</span><span class="p">:</span> <span class="mi">35000</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">:</span> <span class="mi">71000</span><span class="p">,</span> <span class="s1">&#39;Oregon&#39;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">,</span> <span class="s1">&#39;Utah&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">}</span>
<span class="n">obj3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sdata</span><span class="p">)</span>
<span class="n">obj3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ohio      35000
Texas     71000
Oregon    16000
Utah       5000
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>We can create a pandas series from a list, too.
Note that pandas respects the order of the assigned index.
Also, pandas keeps California with <code class="docutils literal notranslate"><span class="pre">NaN</span></code> (not a number or missing value) and drops Utah because it was not in the index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;California&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Oregon&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">]</span>
<span class="n">obj4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
<span class="n">obj4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>California          NaN
Ohio         35000.0000
Oregon       16000.0000
Texas        71000.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Indices are one of pandas’ super powers.
When we perform mathematical operations, pandas aligns series by their indices.
Here <code class="docutils literal notranslate"><span class="pre">NaN</span></code> is “not a number”, which indicates missing values.
<code class="docutils literal notranslate"><span class="pre">NaN</span></code> is considered a float, so the data type switches from int64 to float64.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj3</span> <span class="o">+</span> <span class="n">obj4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>California           NaN
Ohio          70000.0000
Oregon        32000.0000
Texas        142000.0000
Utah                 NaN
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="dataframe">
<h4>DataFrame<a class="headerlink" href="#dataframe" title="Permalink to this heading">#</a></h4>
<p>A pandas data frame is like a worksheet in an Excel workbook with row and columns that provide fast indexing.</p>
<blockquote>
<div><p>A DataFrame represents a rectangular table of data and contains an ordered collection of columns, each of which can be a different value type (numeric, string, boolean, etc.). The DataFrame has both a row and column index; it can be thought of as a dict of Series all sharing the same index. Under the hood, the data is stored as one or more two-dimensional blocks rather than a list, dict, or some other collection of one-dimensional arrays. The exact details of DataFrame’s internals are outside the scope of this book.</p>
<p>There are many ways to construct a DataFrame, though one of the most common is from a dict of equal-length lists or NumPy arrays:</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Nevada&#39;</span><span class="p">,</span> <span class="s1">&#39;Nevada&#39;</span><span class="p">,</span> <span class="s1">&#39;Nevada&#39;</span><span class="p">],</span>
    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">2002</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">2002</span><span class="p">,</span> <span class="mi">2003</span><span class="p">],</span>
    <span class="s1">&#39;pop&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">2.9</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">frame</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>year</th>
      <th>pop</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Ohio</td>
      <td>2000</td>
      <td>1.5000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ohio</td>
      <td>2001</td>
      <td>1.7000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Ohio</td>
      <td>2002</td>
      <td>3.6000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Nevada</td>
      <td>2001</td>
      <td>2.4000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Nevada</td>
      <td>2002</td>
      <td>2.9000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Nevada</td>
      <td>2003</td>
      <td>3.2000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We did not specify an index, so <code class="docutils literal notranslate"><span class="pre">frame</span></code> has the default index of integers starting at 0.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> 
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s1">&#39;debt&#39;</span><span class="p">],</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;four&#39;</span><span class="p">,</span> <span class="s1">&#39;five&#39;</span><span class="p">,</span> <span class="s1">&#39;six&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">frame2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>state</th>
      <th>pop</th>
      <th>debt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>2000</td>
      <td>Ohio</td>
      <td>1.5000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>two</th>
      <td>2001</td>
      <td>Ohio</td>
      <td>1.7000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>three</th>
      <td>2002</td>
      <td>Ohio</td>
      <td>3.6000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>four</th>
      <td>2001</td>
      <td>Nevada</td>
      <td>2.4000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>five</th>
      <td>2002</td>
      <td>Nevada</td>
      <td>2.9000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>six</th>
      <td>2003</td>
      <td>Nevada</td>
      <td>3.2000</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>If we extract one column, via either <code class="docutils literal notranslate"><span class="pre">df.column</span></code> or <code class="docutils literal notranslate"><span class="pre">df['column']</span></code>, the result is a series.
We can use either the <code class="docutils literal notranslate"><span class="pre">df.colname</span></code> or the <code class="docutils literal notranslate"><span class="pre">df['colname']</span></code> syntax to <em>extract</em> a column from a data frame as a series.
<em><strong>However, we must use the <code class="docutils literal notranslate"><span class="pre">df['colname']</span></code> syntax to <em>add</em> a column to a data frame.</strong></em>
Also, we must use the <code class="docutils literal notranslate"><span class="pre">df['colname']</span></code> syntax to extract or add a column whose name contains a whitespace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>one        Ohio
two        Ohio
three      Ohio
four     Nevada
five     Nevada
six      Nevada
Name: state, dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="o">.</span><span class="n">state</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>one        Ohio
two        Ohio
three      Ohio
four     Nevada
five     Nevada
six      Nevada
Name: state, dtype: object
</pre></div>
</div>
</div>
</div>
<p>Similarly, if we extract one row. via either <code class="docutils literal notranslate"><span class="pre">df.loc['rowlabel']</span></code> or <code class="docutils literal notranslate"><span class="pre">df.iloc[rownumber]</span></code>, the result is a series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year      2000
state     Ohio
pop     1.5000
debt       NaN
Name: one, dtype: object
</pre></div>
</div>
</div>
</div>
<p>Data frame have two dimensions, so we have to slice data frames more precisely than series.</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">.loc[]</span></code> method slices by row labels and column names</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">.iloc[]</span></code> method slices by <em>integer</em> row and label indices</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;three&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year      2002
state     Ohio
pop     3.6000
debt       NaN
Name: three, dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year      2002
state     Ohio
pop     3.6000
debt       NaN
Name: three, dtype: object
</pre></div>
</div>
</div>
</div>
<p>We can use NumPy’s <code class="docutils literal notranslate"><span class="pre">[row,</span> <span class="pre">column]</span></code> syntanx with <code class="docutils literal notranslate"><span class="pre">.loc[]</span></code> and <code class="docutils literal notranslate"><span class="pre">.iloc[]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="c1"># row, column</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Ohio&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">]]</span> <span class="c1"># row, column</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>state     Ohio
pop     3.6000
Name: three, dtype: object
</pre></div>
</div>
</div>
</div>
<p>We can assign either scalars or arrays to data frame columns.</p>
<ol class="arabic simple">
<li><p>Scalars will broadcast to every row in the data frame</p></li>
<li><p>Arrays must have the same length as the column</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="p">[</span><span class="s1">&#39;debt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">16.5</span>
<span class="n">frame2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>state</th>
      <th>pop</th>
      <th>debt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>2000</td>
      <td>Ohio</td>
      <td>1.5000</td>
      <td>16.5000</td>
    </tr>
    <tr>
      <th>two</th>
      <td>2001</td>
      <td>Ohio</td>
      <td>1.7000</td>
      <td>16.5000</td>
    </tr>
    <tr>
      <th>three</th>
      <td>2002</td>
      <td>Ohio</td>
      <td>3.6000</td>
      <td>16.5000</td>
    </tr>
    <tr>
      <th>four</th>
      <td>2001</td>
      <td>Nevada</td>
      <td>2.4000</td>
      <td>16.5000</td>
    </tr>
    <tr>
      <th>five</th>
      <td>2002</td>
      <td>Nevada</td>
      <td>2.9000</td>
      <td>16.5000</td>
    </tr>
    <tr>
      <th>six</th>
      <td>2003</td>
      <td>Nevada</td>
      <td>3.2000</td>
      <td>16.5000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="p">[</span><span class="s1">&#39;debt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">6.</span><span class="p">)</span>
<span class="n">frame2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>state</th>
      <th>pop</th>
      <th>debt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>2000</td>
      <td>Ohio</td>
      <td>1.5000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>two</th>
      <td>2001</td>
      <td>Ohio</td>
      <td>1.7000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>three</th>
      <td>2002</td>
      <td>Ohio</td>
      <td>3.6000</td>
      <td>2.0000</td>
    </tr>
    <tr>
      <th>four</th>
      <td>2001</td>
      <td>Nevada</td>
      <td>2.4000</td>
      <td>3.0000</td>
    </tr>
    <tr>
      <th>five</th>
      <td>2002</td>
      <td>Nevada</td>
      <td>2.9000</td>
      <td>4.0000</td>
    </tr>
    <tr>
      <th>six</th>
      <td>2003</td>
      <td>Nevada</td>
      <td>3.2000</td>
      <td>5.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>If we assign a series to a data frame column, pandas will use the index to align it with the data frame.
Data frame rows not in the series will be missing values <code class="docutils literal notranslate"><span class="pre">NaN</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;four&#39;</span><span class="p">,</span> <span class="s1">&#39;five&#39;</span><span class="p">])</span>
<span class="n">val</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>two    -1.2000
four   -1.5000
five   -1.7000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="p">[</span><span class="s1">&#39;debt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
<span class="n">frame2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>state</th>
      <th>pop</th>
      <th>debt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>2000</td>
      <td>Ohio</td>
      <td>1.5000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>two</th>
      <td>2001</td>
      <td>Ohio</td>
      <td>1.7000</td>
      <td>-1.2000</td>
    </tr>
    <tr>
      <th>three</th>
      <td>2002</td>
      <td>Ohio</td>
      <td>3.6000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>four</th>
      <td>2001</td>
      <td>Nevada</td>
      <td>2.4000</td>
      <td>-1.5000</td>
    </tr>
    <tr>
      <th>five</th>
      <td>2002</td>
      <td>Nevada</td>
      <td>2.9000</td>
      <td>-1.7000</td>
    </tr>
    <tr>
      <th>six</th>
      <td>2003</td>
      <td>Nevada</td>
      <td>3.2000</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can add columns to our data frame, then delete them with <code class="docutils literal notranslate"><span class="pre">del</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="p">[</span><span class="s1">&#39;eastern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame2</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">)</span>
<span class="n">frame2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>state</th>
      <th>pop</th>
      <th>debt</th>
      <th>eastern</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>2000</td>
      <td>Ohio</td>
      <td>1.5000</td>
      <td>NaN</td>
      <td>True</td>
    </tr>
    <tr>
      <th>two</th>
      <td>2001</td>
      <td>Ohio</td>
      <td>1.7000</td>
      <td>-1.2000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>three</th>
      <td>2002</td>
      <td>Ohio</td>
      <td>3.6000</td>
      <td>NaN</td>
      <td>True</td>
    </tr>
    <tr>
      <th>four</th>
      <td>2001</td>
      <td>Nevada</td>
      <td>2.4000</td>
      <td>-1.5000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>five</th>
      <td>2002</td>
      <td>Nevada</td>
      <td>2.9000</td>
      <td>-1.7000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>six</th>
      <td>2003</td>
      <td>Nevada</td>
      <td>3.2000</td>
      <td>NaN</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">frame2</span><span class="p">[</span><span class="s1">&#39;eastern&#39;</span><span class="p">]</span>
<span class="n">frame2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>state</th>
      <th>pop</th>
      <th>debt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>2000</td>
      <td>Ohio</td>
      <td>1.5000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>two</th>
      <td>2001</td>
      <td>Ohio</td>
      <td>1.7000</td>
      <td>-1.2000</td>
    </tr>
    <tr>
      <th>three</th>
      <td>2002</td>
      <td>Ohio</td>
      <td>3.6000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>four</th>
      <td>2001</td>
      <td>Nevada</td>
      <td>2.4000</td>
      <td>-1.5000</td>
    </tr>
    <tr>
      <th>five</th>
      <td>2002</td>
      <td>Nevada</td>
      <td>2.9000</td>
      <td>-1.7000</td>
    </tr>
    <tr>
      <th>six</th>
      <td>2003</td>
      <td>Nevada</td>
      <td>3.2000</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="index-objects">
<h4>Index Objects<a class="headerlink" href="#index-objects" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;b&#39;, &#39;c&#39;], dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<p>Index objects are immutable!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># index[1] = &#39;d&#39;  # TypeError: Index does not support mutable operations</span>
</pre></div>
</div>
</div>
</div>
<p>Indices can contain duplicates, so an index does not guarantee our data are duplicate-free.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dup_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="essential-functionality">
<h3>Essential Functionality<a class="headerlink" href="#essential-functionality" title="Permalink to this heading">#</a></h3>
<p>This section provides the most import pandas operations.
It is difficult to provide an exhaustive reference, but this section provides a head start on the core pandas functionality.</p>
<section id="dropping-entries-from-an-axis">
<h4>Dropping Entries from an Axis<a class="headerlink" href="#dropping-entries-from-an-axis" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>Dropping one or more entries from an axis is easy if you already have an index array or list without those entries. As that can require a bit of munging and set logic, the  drop method will return a new object with the indicated value or values deleted from an axis.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">5.</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">])</span>
<span class="n">obj</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a   0.0000
b   1.0000
c   2.0000
d   3.0000
e   4.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj_without_d_and_c</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
<span class="n">obj_without_d_and_c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a   0.0000
b   1.0000
e   4.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.drop()</span></code> method works on data frames, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;Utah&#39;</span><span class="p">,</span> <span class="s1">&#39;New York&#39;</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;four&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>4</td>
      <td>5</td>
      <td>6</td>
      <td>7</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>8</td>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>12</td>
      <td>13</td>
      <td>14</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">])</span> <span class="c1"># implied &quot;, axis=0&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>8</td>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>12</td>
      <td>13</td>
      <td>14</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>8</td>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>12</td>
      <td>13</td>
      <td>14</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>8</td>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>12</td>
      <td>13</td>
      <td>14</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.drop()</span></code> method accepts an <code class="docutils literal notranslate"><span class="pre">axis</span></code> argument and the default is <code class="docutils literal notranslate"><span class="pre">axis=0</span></code> to drop rows based on labels.
To drop columns, we use <code class="docutils literal notranslate"><span class="pre">axis=1</span></code> or <code class="docutils literal notranslate"><span class="pre">axis='columns'</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>4</td>
      <td>6</td>
      <td>7</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>8</td>
      <td>10</td>
      <td>11</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>12</td>
      <td>14</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;two&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>4</td>
      <td>6</td>
      <td>7</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>8</td>
      <td>10</td>
      <td>11</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>12</td>
      <td>14</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="indexing-selection-and-filtering">
<h4>Indexing, Selection, and Filtering<a class="headerlink" href="#indexing-selection-and-filtering" title="Permalink to this heading">#</a></h4>
<p>Indexing, selecting, and filtering will be among our most-used pandas features.</p>
<blockquote>
<div><p>Series indexing (obj[…]) works analogously to NumPy array indexing, except you can use the Series’s index values instead of only integers.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">4.</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">])</span>
<span class="n">obj</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a   0.0000
b   1.0000
c   2.0000
d   3.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<p>The code directly above works.
However, I prefer to be explicit and use <code class="docutils literal notranslate"><span class="pre">.iloc[]</span></code> when I index or slice by integers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b   1.0000
c   2.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>When we slice with labels, the left and right endpoints are inclusive.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b   1.0000
c   2.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">obj</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a   0.0000
b   5.0000
c   5.0000
d   3.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;Utah&#39;</span><span class="p">,</span> <span class="s1">&#39;New York&#39;</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;four&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>4</td>
      <td>5</td>
      <td>6</td>
      <td>7</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>8</td>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>12</td>
      <td>13</td>
      <td>14</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Indexing one column returns a series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;two&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ohio         1
Colorado     5
Utah         9
New York    13
Name: two, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Indexing two or more columns returns a data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>three</th>
      <th>one</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>6</td>
      <td>4</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>10</td>
      <td>8</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>14</td>
      <td>12</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>If we want a one-column data frame, we can use <code class="docutils literal notranslate"><span class="pre">[[]]</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;three&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ohio         2
Colorado     6
Utah        10
New York    14
Name: three, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;three&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>three</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>2</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>6</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>10</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>When we slice with integer indices with <code class="docutils literal notranslate"><span class="pre">[]</span></code>, we slice rows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>4</td>
      <td>5</td>
      <td>6</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>When I slice rows, I prefer to use <code class="docutils literal notranslate"><span class="pre">.loc[]</span></code> or <code class="docutils literal notranslate"><span class="pre">.iloc[]</span></code> to avoid confusion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>4</td>
      <td>5</td>
      <td>6</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can index a data frame with Booleans, as we did with NumPy arrays.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>0</td>
      <td>5</td>
      <td>6</td>
      <td>7</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>8</td>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>12</td>
      <td>13</td>
      <td>14</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Finally, we can chain slices.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">][</span><span class="n">data</span><span class="o">.</span><span class="n">three</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Colorado</th>
      <td>0</td>
      <td>5</td>
      <td>6</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>8</td>
      <td>9</td>
      <td>10</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>12</td>
      <td>13</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><em><strong>Table 5-4</strong></em> summarizes data frame indexing and slicing options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">df[val]</span></code>: Select single column or sequence of columns from the DataFrame; special case conveniences: boolean array (filter rows), slice (slice rows), or boolean DataFrame (set values based on some criterion)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">df.loc[val]</span></code>: Selects single row or subset of rows from the DataFrame by label</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">df.loc[:,</span> <span class="pre">val]</span></code>: Selects single column or subset of columns by label</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">df.loc[val1,</span> <span class="pre">val2]</span></code>: Select both rows and columns by label</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">df.iloc[where]</span></code>: Selects single row or subset of rows from the DataFrame by integer position</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">df.iloc[:,</span> <span class="pre">where]</span></code>: Selects single column or subset of columns by integer position</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">df.iloc[where_i,</span> <span class="pre">where_j]</span></code>: Select both rows and columns by integer position</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">df.at[label_i,</span> <span class="pre">label_j]</span></code>: Select a single scalar value by row and column label</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">df.iat[i,</span> <span class="pre">j]</span></code>: Select a single scalar value by row and column position (integers) reindex method Select either rows or columns by labels</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_value</span></code>, <code class="docutils literal notranslate"><span class="pre">set_value</span></code> methods: Select single value by row and column label</p></li>
</ul>
<p>pandas is powerful and these options can be overwhelming!
We will typically use <code class="docutils literal notranslate"><span class="pre">df[val]</span></code> to select columns (here <code class="docutils literal notranslate"><span class="pre">val</span></code> is either a string or list of strings), <code class="docutils literal notranslate"><span class="pre">df.loc[val]</span></code> to select rows (here <code class="docutils literal notranslate"><span class="pre">val</span></code> is a row label), and <code class="docutils literal notranslate"><span class="pre">df.loc[val1,</span> <span class="pre">val2]</span></code> to select both rows and columns.
The other options add flexibility, and we may occasionally use them.
However, our data will be large enough that counting row and column number will be tedious, making <code class="docutils literal notranslate"><span class="pre">.iloc[]</span></code> impractical.</p>
</section>
<section id="integer-indexes">
<h4>Integer Indexes<a class="headerlink" href="#integer-indexes" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">3.</span><span class="p">))</span>
<span class="n">ser</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0   0.0000
1   1.0000
2   2.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The following indexing yields an error because the series cannot fall back to NumPy array indexing.
Falling back to NumPy array indexing here would generate many subtle bugs elsewhere.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ser[-1]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ser</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<p>However, the following indexing works fine because with string labels there is no ambiguity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ser2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">3.</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
<span class="n">ser2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a   0.0000
b   1.0000
c   2.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ser2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ser2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<p>In practice, these errors will not be an issue because we will index or slice with stock identifiers and dates instead of integers.
To avoid condusion, we should use <code class="docutils literal notranslate"><span class="pre">.iloc[]</span></code> to index or slice with integers.</p>
</section>
<section id="arithmetic-and-data-alignment">
<h4>Arithmetic and Data Alignment<a class="headerlink" href="#arithmetic-and-data-alignment" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>An important pandas feature for some applications is the behavior of arithmetic between objects with different indexes. When you are adding together objects, if any index pairs are not the same, the respective index in the result will be the union of the index pairs. For users with database experience, this is similar to an automatic outer join on the index labels.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mf">7.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">])</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="o">-</span><span class="mf">2.1</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a    7.3000
c   -2.5000
d    3.4000
e    1.5000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a   -2.1000
c    3.6000
e   -1.5000
f    4.0000
g    3.1000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span> <span class="o">+</span> <span class="n">s2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a   5.2000
c   1.1000
d      NaN
e   0.0000
f      NaN
g      NaN
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">9.</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;bcd&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">,</span> <span class="s1">&#39;Colorado&#39;</span><span class="p">])</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">12.</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;bde&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Utah&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">,</span> <span class="s1">&#39;Oregon&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0.0000</td>
      <td>1.0000</td>
      <td>2.0000</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>3.0000</td>
      <td>4.0000</td>
      <td>5.0000</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>6.0000</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>0.0000</td>
      <td>1.0000</td>
      <td>2.0000</td>
    </tr>
    <tr>
      <th>Ohio</th>
      <td>3.0000</td>
      <td>4.0000</td>
      <td>5.0000</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>6.0000</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
    <tr>
      <th>Oregon</th>
      <td>9.0000</td>
      <td>10.0000</td>
      <td>11.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">+</span> <span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Colorado</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Ohio</th>
      <td>3.0000</td>
      <td>NaN</td>
      <td>6.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Oregon</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>9.0000</td>
      <td>NaN</td>
      <td>12.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Utah</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">-</span> <span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="arithmetic-methods-with-fill-values">
<h5>Arithmetic methods with fill values<a class="headerlink" href="#arithmetic-methods-with-fill-values" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">12.</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;abcd&#39;</span><span class="p">))</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">20.</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;abcde&#39;</span><span class="p">))</span>
<span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0000</td>
      <td>1.0000</td>
      <td>2.0000</td>
      <td>3.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4.0000</td>
      <td>5.0000</td>
      <td>6.0000</td>
      <td>7.0000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.0000</td>
      <td>9.0000</td>
      <td>10.0000</td>
      <td>11.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0000</td>
      <td>1.0000</td>
      <td>2.0000</td>
      <td>3.0000</td>
      <td>4.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5.0000</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>8.0000</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10.0000</td>
      <td>11.0000</td>
      <td>12.0000</td>
      <td>13.0000</td>
      <td>14.0000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>15.0000</td>
      <td>16.0000</td>
      <td>17.0000</td>
      <td>18.0000</td>
      <td>19.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">+</span> <span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0000</td>
      <td>2.0000</td>
      <td>4.0000</td>
      <td>6.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9.0000</td>
      <td>NaN</td>
      <td>13.0000</td>
      <td>15.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18.0000</td>
      <td>20.0000</td>
      <td>22.0000</td>
      <td>24.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can specify a fill value for <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values.
Note that pandas fills would-be <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values in each data frame <em>before</em> the arithmetic operation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0000</td>
      <td>2.0000</td>
      <td>4.0000</td>
      <td>6.0000</td>
      <td>4.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9.0000</td>
      <td>5.0000</td>
      <td>13.0000</td>
      <td>15.0000</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18.0000</td>
      <td>20.0000</td>
      <td>22.0000</td>
      <td>24.0000</td>
      <td>14.0000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>15.0000</td>
      <td>16.0000</td>
      <td>17.0000</td>
      <td>18.0000</td>
      <td>19.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="operations-between-dataframe-and-series">
<h5>Operations between DataFrame and Series<a class="headerlink" href="#operations-between-dataframe-and-series" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">12.</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.,  1.,  2.,  3.],
       [ 4.,  5.,  6.,  7.],
       [ 8.,  9., 10., 11.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0., 1., 2., 3.])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">-</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0., 0., 0., 0.],
       [4., 4., 4., 4.],
       [8., 8., 8., 8.]])
</pre></div>
</div>
</div>
</div>
<p>Arithmetic operations between series and data frames behave the same as the example above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">12.</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;bde&#39;</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Utah&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">,</span> <span class="s1">&#39;Oregon&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>0.0000</td>
      <td>1.0000</td>
      <td>2.0000</td>
    </tr>
    <tr>
      <th>Ohio</th>
      <td>3.0000</td>
      <td>4.0000</td>
      <td>5.0000</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>6.0000</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
    <tr>
      <th>Oregon</th>
      <td>9.0000</td>
      <td>10.0000</td>
      <td>11.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">series</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b   0.0000
d   1.0000
e   2.0000
Name: Utah, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span> <span class="o">-</span> <span class="n">series</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>Ohio</th>
      <td>3.0000</td>
      <td>3.0000</td>
      <td>3.0000</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>6.0000</td>
      <td>6.0000</td>
      <td>6.0000</td>
    </tr>
    <tr>
      <th>Oregon</th>
      <td>9.0000</td>
      <td>9.0000</td>
      <td>9.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">series2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>0.0000</td>
      <td>1.0000</td>
      <td>2.0000</td>
    </tr>
    <tr>
      <th>Ohio</th>
      <td>3.0000</td>
      <td>4.0000</td>
      <td>5.0000</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>6.0000</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
    <tr>
      <th>Oregon</th>
      <td>9.0000</td>
      <td>10.0000</td>
      <td>11.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">series2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b    0
e    1
f    2
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span> <span class="o">+</span> <span class="n">series2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>d</th>
      <th>e</th>
      <th>f</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>0.0000</td>
      <td>NaN</td>
      <td>3.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Ohio</th>
      <td>3.0000</td>
      <td>NaN</td>
      <td>6.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>6.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Oregon</th>
      <td>9.0000</td>
      <td>NaN</td>
      <td>12.0000</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">series3</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">series3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>-1.0000</td>
      <td>0.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>Ohio</th>
      <td>-1.0000</td>
      <td>0.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>-1.0000</td>
      <td>0.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>Oregon</th>
      <td>-1.0000</td>
      <td>0.0000</td>
      <td>1.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="function-application-and-mapping">
<h4>Function Application and Mapping<a class="headerlink" href="#function-application-and-mapping" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> 
    <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;bde&#39;</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Utah&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">,</span> <span class="s1">&#39;Oregon&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">frame</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
    </tr>
    <tr>
      <th>Ohio</th>
      <td>1.5230</td>
      <td>-0.2342</td>
      <td>-0.2341</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>1.5792</td>
      <td>0.7674</td>
      <td>-0.4695</td>
    </tr>
    <tr>
      <th>Oregon</th>
      <td>0.5426</td>
      <td>-0.4634</td>
      <td>-0.4657</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Utah</th>
      <td>0.4967</td>
      <td>0.1383</td>
      <td>0.6477</td>
    </tr>
    <tr>
      <th>Ohio</th>
      <td>1.5230</td>
      <td>0.2342</td>
      <td>0.2341</td>
    </tr>
    <tr>
      <th>Texas</th>
      <td>1.5792</td>
      <td>0.7674</td>
      <td>0.4695</td>
    </tr>
    <tr>
      <th>Oregon</th>
      <td>0.5426</td>
      <td>0.4634</td>
      <td>0.4657</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<blockquote>
<div><p>Another frequent operation is applying a function on one-dimensional arrays to each column or row. DataFrame’s apply method does exactly this:</p>
</div></blockquote>
<p>Note that we can use anonymous (lambda) functions “on the fly”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b   1.0825
d   1.2309
e   1.1172
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Utah     0.7860
Ohio     1.7572
Texas    2.0487
Oregon   1.0083
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>However, under the hood, the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> is basically a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop and much slowly than optimized, built-in methods.
Here is an example of the speed costs of <code class="docutils literal notranslate"><span class="pre">.apply()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> frame[&#39;e&#39;].abs()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.13 µs ± 112 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> frame[&#39;e&#39;].apply(np.abs)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>26.3 µs ± 989 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="summarizing-and-computing-descriptive-statistics">
<h3>Summarizing and Computing Descriptive Statistics<a class="headerlink" href="#summarizing-and-computing-descriptive-statistics" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[[</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.5</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3</span><span class="p">]],</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.4000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>b</th>
      <td>7.1000</td>
      <td>-4.5000</td>
    </tr>
    <tr>
      <th>c</th>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>d</th>
      <td>0.7500</td>
      <td>-1.3000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>one    9.2500
two   -5.8000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a    1.4000
b    2.6000
c    0.0000
d   -0.5500
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a       NaN
b    1.3000
c       NaN
d   -0.2750
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.idxmax()</span></code> method returns the label for the maximum observation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>one    b
two    d
dtype: object
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.describe()</span></code> returns summary statistics for each numerical column in a data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>3.0000</td>
      <td>2.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>3.0833</td>
      <td>-2.9000</td>
    </tr>
    <tr>
      <th>std</th>
      <td>3.4937</td>
      <td>2.2627</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.7500</td>
      <td>-4.5000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.0750</td>
      <td>-3.7000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1.4000</td>
      <td>-2.9000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>4.2500</td>
      <td>-2.1000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>7.1000</td>
      <td>-1.3000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For non-numerical data, <code class="docutils literal notranslate"><span class="pre">.describe()</span></code> returns alternative summary statistics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">obj</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count     16
unique     3
top        a
freq       8
dtype: object
</pre></div>
</div>
</div>
</div>
<section id="correlation-and-covariance">
<h4>Correlation and Covariance<a class="headerlink" href="#correlation-and-covariance" title="Permalink to this heading">#</a></h4>
<p>To explore correlation and covariance methods, we can use Yahoo! Finance stock data.
We can use the yfinance package to import these data.
We can use the requests-cache package to cache our data requests, which avoid unnecessarily re-downloading data.</p>
<p>We can install these two functions with the <code class="docutils literal notranslate"><span class="pre">%pip</span></code> magic:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %pip install yfinance requests-cache</span>
</pre></div>
</div>
</div>
</div>
<p>If we are running Python locally, we only need to run the <code class="docutils literal notranslate"><span class="pre">%pip</span></code> magic once.
If we are running Python in the cloud, we may need to run the <code class="docutils literal notranslate"><span class="pre">%pip</span></code> magic once <em>per login</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">(</span><span class="n">expire_after</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="s1">&#39;AAPL IBM MSFT GOOG&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  4 of 4 completed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>GOOG</th>
      <th>IBM</th>
      <th>MSFT</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1962-01-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.6330</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1962-01-03</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.6473</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1962-01-04</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.6309</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1962-01-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.5988</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1962-01-08</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.5688</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-01-20</th>
      <td>137.8700</td>
      <td>99.2800</td>
      <td>141.2000</td>
      <td>240.2200</td>
    </tr>
    <tr>
      <th>2023-01-23</th>
      <td>141.1100</td>
      <td>101.2100</td>
      <td>141.8600</td>
      <td>242.5800</td>
    </tr>
    <tr>
      <th>2023-01-24</th>
      <td>142.5300</td>
      <td>99.2100</td>
      <td>141.4900</td>
      <td>242.0400</td>
    </tr>
    <tr>
      <th>2023-01-25</th>
      <td>141.8600</td>
      <td>96.7300</td>
      <td>140.7600</td>
      <td>240.6100</td>
    </tr>
    <tr>
      <th>2023-01-26</th>
      <td>143.6300</td>
      <td>98.1800</td>
      <td>135.1350</td>
      <td>245.1400</td>
    </tr>
  </tbody>
</table>
<p>15373 rows × 4 columns</p>
</div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">prices</span></code> data frames contains daily data for AAPL, IBM, MSFT, and GOOG.
The <code class="docutils literal notranslate"><span class="pre">Adj</span> <span class="pre">Close</span></code> column provides a reverse-engineered daily closing price that accounts for dividends paid and stock splits (and reverse splits).
As a result, the <code class="docutils literal notranslate"><span class="pre">.pct_change()</span></code> in <code class="docutils literal notranslate"><span class="pre">Adj</span> <span class="pre">Close</span></code> considers both price changes (i.e., capital gains) and dividends, so $R_t = \frac{(P_t + D_t) - P_{t-1}}{P_{t-1}} = \frac{\text{Adj Close}<em>t - \text{Adj Close}</em>{t-1}}{\text{Adj Close}_{t-1}}.$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>GOOG</th>
      <th>IBM</th>
      <th>MSFT</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2004-08-20</th>
      <td>0.0029</td>
      <td>0.0794</td>
      <td>0.0042</td>
      <td>0.0029</td>
    </tr>
    <tr>
      <th>2004-08-23</th>
      <td>0.0091</td>
      <td>0.0101</td>
      <td>-0.0070</td>
      <td>0.0044</td>
    </tr>
    <tr>
      <th>2004-08-24</th>
      <td>0.0280</td>
      <td>-0.0414</td>
      <td>0.0007</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2004-08-25</th>
      <td>0.0344</td>
      <td>0.0108</td>
      <td>0.0042</td>
      <td>0.0114</td>
    </tr>
    <tr>
      <th>2004-08-26</th>
      <td>0.0487</td>
      <td>0.0180</td>
      <td>-0.0045</td>
      <td>-0.0040</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-01-20</th>
      <td>0.0192</td>
      <td>0.0572</td>
      <td>0.0041</td>
      <td>0.0357</td>
    </tr>
    <tr>
      <th>2023-01-23</th>
      <td>0.0235</td>
      <td>0.0194</td>
      <td>0.0047</td>
      <td>0.0098</td>
    </tr>
    <tr>
      <th>2023-01-24</th>
      <td>0.0101</td>
      <td>-0.0198</td>
      <td>-0.0026</td>
      <td>-0.0022</td>
    </tr>
    <tr>
      <th>2023-01-25</th>
      <td>-0.0047</td>
      <td>-0.0250</td>
      <td>-0.0052</td>
      <td>-0.0059</td>
    </tr>
    <tr>
      <th>2023-01-26</th>
      <td>0.0125</td>
      <td>0.0150</td>
      <td>-0.0400</td>
      <td>0.0188</td>
    </tr>
  </tbody>
</table>
<p>4641 rows × 4 columns</p>
</div></div></div>
</div>
<p>We multiply by 252 to annualize mean daily returns because means grow linearly with time and there are (about) 252 trading days per year.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.3667
GOOG   0.2463
IBM    0.0822
MSFT   0.1820
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We multiply by $\sqrt{252}$ to annualize the standard deviation of daily returns because variances grow linearly with time, there are (about) 252 trading days per year, and the standard deviation is the square root of the variance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.3332
GOOG   0.3077
IBM    0.2294
MSFT   0.2738
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>The best explanation I have found on why stock return volatility (the standard deviation of stocks returns) grows with the square root of time is at the bottom of page 7 of <a class="reference external" href="https://book.ivo-welch.info/read/source5.mba/08-invchoice.pdf">chapter 8 of Ivo Welch’s free corporate finance textbook</a>.</strong></em></p>
<p>We can calculate pairwise correlations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;IBM&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.5076061163270416
</pre></div>
</div>
</div>
</div>
<p>We can also calculate correlation matrices.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>GOOG</th>
      <th>IBM</th>
      <th>MSFT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AAPL</th>
      <td>1.0000</td>
      <td>0.5204</td>
      <td>0.4345</td>
      <td>0.5237</td>
    </tr>
    <tr>
      <th>GOOG</th>
      <td>0.5204</td>
      <td>1.0000</td>
      <td>0.4068</td>
      <td>0.5650</td>
    </tr>
    <tr>
      <th>IBM</th>
      <td>0.4345</td>
      <td>0.4068</td>
      <td>1.0000</td>
      <td>0.5076</td>
    </tr>
    <tr>
      <th>MSFT</th>
      <td>0.5237</td>
      <td>0.5650</td>
      <td>0.5076</td>
      <td>1.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;IBM&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.5076061163270453
</pre></div>
</div>
</div>
</div>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-mckinney_05_practice"></span><section id="mckinney-chapter-5-practice-blank">
<h3>McKinney Chapter 5 - Practice (Blank)<a class="headerlink" href="#mckinney-chapter-5-practice-blank" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="s1">&#39;AAPL IBM MSFT GOOG&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  4 of 4 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>GOOG</th>
      <th>IBM</th>
      <th>MSFT</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2004-08-20</th>
      <td>0.0029</td>
      <td>0.0794</td>
      <td>0.0042</td>
      <td>0.0030</td>
    </tr>
    <tr>
      <th>2004-08-23</th>
      <td>0.0091</td>
      <td>0.0101</td>
      <td>-0.0070</td>
      <td>0.0044</td>
    </tr>
    <tr>
      <th>2004-08-24</th>
      <td>0.0280</td>
      <td>-0.0414</td>
      <td>0.0007</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2004-08-25</th>
      <td>0.0344</td>
      <td>0.0108</td>
      <td>0.0042</td>
      <td>0.0114</td>
    </tr>
    <tr>
      <th>2004-08-26</th>
      <td>0.0487</td>
      <td>0.0180</td>
      <td>-0.0045</td>
      <td>-0.0040</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-01-18</th>
      <td>-0.0054</td>
      <td>-0.0041</td>
      <td>-0.0329</td>
      <td>-0.0189</td>
    </tr>
    <tr>
      <th>2023-01-19</th>
      <td>0.0004</td>
      <td>0.0232</td>
      <td>0.0015</td>
      <td>-0.0165</td>
    </tr>
    <tr>
      <th>2023-01-20</th>
      <td>0.0192</td>
      <td>0.0572</td>
      <td>0.0041</td>
      <td>0.0357</td>
    </tr>
    <tr>
      <th>2023-01-23</th>
      <td>0.0235</td>
      <td>0.0194</td>
      <td>0.0047</td>
      <td>0.0098</td>
    </tr>
    <tr>
      <th>2023-01-24</th>
      <td>0.0109</td>
      <td>-0.0186</td>
      <td>-0.0029</td>
      <td>-0.0008</td>
    </tr>
  </tbody>
</table>
<p>4639 rows × 4 columns</p>
</div></div></div>
</div>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="what-are-the-mean-daily-returns-for-these-four-stocks">
<h5>What are the mean daily returns for these four stocks?<a class="headerlink" href="#what-are-the-mean-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
</section>
<section id="what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>What are the standard deviations of daily returns for these four stocks?<a class="headerlink" href="#what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
</section>
<section id="what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>What are the <em>annualized</em> means and standard deviations of daily returns for these four stocks?<a class="headerlink" href="#what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
</section>
<section id="plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>Plot <em>annualized</em> means versus standard deviations of daily returns for these four stocks<a class="headerlink" href="#plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<p>Use <code class="docutils literal notranslate"><span class="pre">plt.scatter()</span></code>, which expects arguments as <code class="docutils literal notranslate"><span class="pre">x</span></code> (standard deviations) then <code class="docutils literal notranslate"><span class="pre">y</span></code> (means).</p>
</section>
<section id="repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia">
<h5>Repeat the previous calculations and plot for the stocks in the Dow-Jones Industrial Index (DJIA)<a class="headerlink" href="#repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia" title="Permalink to this heading">#</a></h5>
<p>We can find the current DJIA stocks on <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">Wikipedia</a>.
We will need to download new data, into <code class="docutils literal notranslate"><span class="pre">tickers2</span></code>, <code class="docutils literal notranslate"><span class="pre">prices2</span></code>, and <code class="docutils literal notranslate"><span class="pre">returns2</span></code>.</p>
</section>
<section id="calculate-total-returns-for-the-stocks-in-the-djia">
<h5>Calculate total returns for the stocks in the DJIA<a class="headerlink" href="#calculate-total-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.prod()</span></code> method to compound returns as $1 + R_T = \prod_{t=1}^T (1 + R_t)$.
Technically, we should write $R_T$ as $R_{0,T}$, but we typically omit the subscript $0$.</p>
</section>
<section id="plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia">
<h5>Plot the distribution of total returns for the stocks in the DJIA<a class="headerlink" href="#plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can plot a histogram, using either the <code class="docutils literal notranslate"><span class="pre">plt.hist()</span></code> function or the <code class="docutils literal notranslate"><span class="pre">.plot(kind='hist')</span></code> method.</p>
</section>
<section id="which-stocks-have-the-minimum-and-maximum-total-returns">
<h5>Which stocks have the minimum and maximum total returns?<a class="headerlink" href="#which-stocks-have-the-minimum-and-maximum-total-returns" title="Permalink to this heading">#</a></h5>
</section>
<section id="plot-the-cumulative-returns-for-the-stocks-in-the-djia">
<h5>Plot the cumulative returns for the stocks in the DJIA<a class="headerlink" href="#plot-the-cumulative-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can use the cumulative product method <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> to calculate the right hand side of the formula above.</p>
</section>
<section id="repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns">
<h5>Repeat the plot above with only the minimum and maximum total returns<a class="headerlink" href="#repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns" title="Permalink to this heading">#</a></h5>
</section>
</section>
</section>
<span id="document-mckinney_05_practice_03"></span><section id="mckinney-chapter-5-practice-section-3-monday-2-45-pm">
<h3>McKinney Chapter 5 - Practice (Section 3, Monday 2:45 PM)<a class="headerlink" href="#mckinney-chapter-5-practice-section-3-monday-2-45-pm" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Due soon</p>
<ul>
<li><p>11:59 PM on Friday, 2/3: Quiz 2</p></li>
<li><p>11:59 PM on Friday, 2/3: 10,000 XP on DataCamp</p></li>
<li><p>Project groups</p>
<ul>
<li><p>9 AM on Monday, 2/6: I will open groups on Canvas</p></li>
<li><p>9 AM on Monday, 2/13: I will close groups and post project 1</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="s1">&#39;AAPL IBM MSFT GOOG&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span> <span class="c1"># initiates a tickers object</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># downloads history data</span>
<span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># removes time zone data from index</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="c1"># calculates returns and drops dates with missing returns</span>
<span class="n">returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  4 of 4 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>GOOG</th>
      <th>IBM</th>
      <th>MSFT</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2004-08-20</th>
      <td>0.0029</td>
      <td>0.0794</td>
      <td>0.0042</td>
      <td>0.0029</td>
    </tr>
    <tr>
      <th>2004-08-23</th>
      <td>0.0091</td>
      <td>0.0101</td>
      <td>-0.0070</td>
      <td>0.0044</td>
    </tr>
    <tr>
      <th>2004-08-24</th>
      <td>0.0280</td>
      <td>-0.0414</td>
      <td>0.0007</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2004-08-25</th>
      <td>0.0344</td>
      <td>0.0108</td>
      <td>0.0042</td>
      <td>0.0114</td>
    </tr>
    <tr>
      <th>2004-08-26</th>
      <td>0.0487</td>
      <td>0.0180</td>
      <td>-0.0045</td>
      <td>-0.0040</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-01-24</th>
      <td>0.0101</td>
      <td>-0.0198</td>
      <td>-0.0026</td>
      <td>-0.0022</td>
    </tr>
    <tr>
      <th>2023-01-25</th>
      <td>-0.0047</td>
      <td>-0.0250</td>
      <td>-0.0052</td>
      <td>-0.0059</td>
    </tr>
    <tr>
      <th>2023-01-26</th>
      <td>0.0148</td>
      <td>0.0251</td>
      <td>-0.0448</td>
      <td>0.0307</td>
    </tr>
    <tr>
      <th>2023-01-27</th>
      <td>0.0137</td>
      <td>0.0156</td>
      <td>-0.0004</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>2023-01-30</th>
      <td>-0.0201</td>
      <td>-0.0274</td>
      <td>0.0068</td>
      <td>-0.0220</td>
    </tr>
  </tbody>
</table>
<p>4643 rows × 4 columns</p>
</div></div></div>
</div>
<section id="what-are-the-mean-daily-returns-for-these-four-stocks">
<h5>What are the mean daily returns for these four stocks?<a class="headerlink" href="#what-are-the-mean-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> method calculates means up-and-down columns (i.e., <code class="docutils literal notranslate"><span class="pre">axis=0</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.0015
GOOG   0.0010
IBM    0.0003
MSFT   0.0007
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We set <code class="docutils literal notranslate"><span class="pre">axis=1</span></code> if we want to calculate means left-and-right across rows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Date
2004-08-20    0.0224
2004-08-23    0.0041
2004-08-24   -0.0032
2004-08-25    0.0152
2004-08-26    0.0146
               ...  
2023-01-24   -0.0036
2023-01-25   -0.0102
2023-01-26    0.0065
2023-01-27    0.0074
2023-01-30   -0.0157
Length: 4643, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>What are the standard deviations of daily returns for these four stocks?<a class="headerlink" href="#what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.0210
GOOG   0.0194
IBM    0.0145
MSFT   0.0173
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>And the <code class="docutils literal notranslate"><span class="pre">.describe()</span></code> is a great way to get common summary statistics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>GOOG</th>
      <th>IBM</th>
      <th>MSFT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>4643.0000</td>
      <td>4643.0000</td>
      <td>4643.0000</td>
      <td>4643.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0015</td>
      <td>0.0010</td>
      <td>0.0003</td>
      <td>0.0007</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0210</td>
      <td>0.0194</td>
      <td>0.0145</td>
      <td>0.0173</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.1792</td>
      <td>-0.1161</td>
      <td>-0.1285</td>
      <td>-0.1474</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0085</td>
      <td>-0.0077</td>
      <td>-0.0063</td>
      <td>-0.0071</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0011</td>
      <td>0.0007</td>
      <td>0.0004</td>
      <td>0.0004</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0121</td>
      <td>0.0100</td>
      <td>0.0074</td>
      <td>0.0087</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1390</td>
      <td>0.1999</td>
      <td>0.1151</td>
      <td>0.1860</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>What are the <em>annualized</em> means and standard deviations of daily returns for these four stocks?<a class="headerlink" href="#what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="c1"># multiply by the number of periods per year to annualize a mean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.3663
GOOG   0.2462
IBM    0.0823
MSFT   0.1814
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span> <span class="c1"># multiply by the SQUARE ROOT of the number of periods per year to annualize a std. dev.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.3331
GOOG   0.3077
IBM    0.2294
MSFT   0.2739
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>The best explanation I have found on why stock return volatility (the standard deviation of stocks returns) grows with the square root of time is at the bottom of page 7 of <a class="reference external" href="https://book.ivo-welch.info/read/source5.mba/08-invchoice.pdf">chapter 8 of Ivo Welch’s free corporate finance textbook</a>.</strong></em></p>
</section>
<section id="plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>Plot <em>annualized</em> means versus standard deviations of daily returns for these four stocks<a class="headerlink" href="#plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<p>Use <code class="docutils literal notranslate"><span class="pre">plt.scatter()</span></code>, which expects arguments as <code class="docutils literal notranslate"><span class="pre">x</span></code> (standard deviations) then <code class="docutils literal notranslate"><span class="pre">y</span></code> (means).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Std. Dev. (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Return Versus Risk</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> 
        <span class="n">y</span><span class="o">=</span><span class="n">returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> 
        <span class="n">s</span><span class="o">=</span><span class="n">i</span>
    <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2875f2309782841f48dc14a62c3a598a133e7e1912c3e75e2a0e3aa2c9985442.png" src="_images/2875f2309782841f48dc14a62c3a598a133e7e1912c3e75e2a0e3aa2c9985442.png" />
</div>
</div>
</section>
<section id="repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia">
<h5>Repeat the previous calculations and plot for the stocks in the Dow-Jones Industrial Index (DJIA)<a class="headerlink" href="#repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia" title="Permalink to this heading">#</a></h5>
<p>We can find the current DJIA stocks on <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">Wikipedia</a>.
We will need to download new data, into <code class="docutils literal notranslate"><span class="pre">tickers2</span></code>, <code class="docutils literal notranslate"><span class="pre">prices2</span></code>, and <code class="docutils literal notranslate"><span class="pre">returns2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symbols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers2</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">symbols</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">prices2</span> <span class="o">=</span> <span class="n">tickers2</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">prices2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">returns2</span> <span class="o">=</span> <span class="n">prices2</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="c1"># returns2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  30 of 30 completed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prices2</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DOW     3.8651
V      14.8532
CRM    18.5873
GS     23.7103
CSCO   32.9405
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">returns2</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">returns2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Std. Dev. (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Return Versus Risk for DJIA Stocks</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns2</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">returns2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> 
        <span class="n">y</span><span class="o">=</span><span class="n">returns2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> 
        <span class="n">s</span><span class="o">=</span><span class="n">i</span>
    <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/095ff443524cd98cda6c87e0c77715dc3ab47cc214a7122bfa318e6d2e4bd9f4.png" src="_images/095ff443524cd98cda6c87e0c77715dc3ab47cc214a7122bfa318e6d2e4bd9f4.png" />
</div>
</div>
</section>
<section id="calculate-total-returns-for-the-stocks-in-the-djia">
<h5>Calculate total returns for the stocks in the DJIA<a class="headerlink" href="#calculate-total-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.prod()</span></code> method to compound returns as $1 + R_T = \prod_{t=1}^T (1 + R_t)$.
Technically, we should write $R_T$ as $R_{0,T}$, but we typically omit the subscript $0$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns2_total</span> <span class="o">=</span> <span class="n">returns2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns2_total_alt</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>The two approaches above are correct and calculate the same values, as shown by <code class="docutils literal notranslate"><span class="pre">np.allclose()</span></code> below.
Still, I prefer the first approach because chained code is typically easier to write, read, and troubleshoot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">returns2_total</span><span class="p">,</span> <span class="n">returns2_total_alt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia">
<h5>Plot the distribution of total returns for the stocks in the DJIA<a class="headerlink" href="#plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can plot a histogram, using either the <code class="docutils literal notranslate"><span class="pre">plt.hist()</span></code> function or the <code class="docutils literal notranslate"><span class="pre">.plot(kind='hist')</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns2_total</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of Total Returns for DJIA Stocks</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to  </span><span class="si">{</span><span class="n">returns2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5ba2e63e7ebf5d5c1209cc0142d9a10e93fc841dc191f5e6dca377db1857db7a.png" src="_images/5ba2e63e7ebf5d5c1209cc0142d9a10e93fc841dc191f5e6dca377db1857db7a.png" />
</div>
</div>
</section>
<section id="which-stocks-have-the-minimum-and-maximum-total-returns">
<h5>Which stocks have the minimum and maximum total returns?<a class="headerlink" href="#which-stocks-have-the-minimum-and-maximum-total-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns2_total</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;BA&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns2_total</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;AAPL&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns2_total</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BA     -0.4292
AAPL    2.1362
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-cumulative-returns-for-the-stocks-in-the-djia">
<h5>Plot the cumulative returns for the stocks in the DJIA<a class="headerlink" href="#plot-the-cumulative-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can use the cumulative product method <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> to calculate the right hand side of the formula above.</p>
<p>The following code works, but the cumulative returns of 30 stocks is typically too much to digest.
Plus, the legend runs off the screen!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cumulative Returns for DJIA Stocks</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to  </span><span class="si">{</span><span class="n">returns2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/932637f2fa6b21aaca01438b7c5d1be51342964c320dcbe1edde20e556c7aa2f.png" src="_images/932637f2fa6b21aaca01438b7c5d1be51342964c320dcbe1edde20e556c7aa2f.png" />
</div>
</div>
</section>
<section id="repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns">
<h5>Repeat the plot above with only the minimum and maximum total returns<a class="headerlink" href="#repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns2_total</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;BA&#39;, &#39;AAPL&#39;], dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns2</span><span class="p">[</span> <span class="c1"># daily returns for DJIA stocks</span>
        <span class="n">returns2_total</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span> <span class="c1"># tickers of stocks with min and max total returns</span>
        <span class="c1"># returns2.add(1).prod().sort_values()[[0, -1]].index # </span>
    <span class="p">]</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># adds 1 to every daily return </span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="c1"># calculate cumulative returns for each stock</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># substracts 1 from every cumulative return</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># converts decimal to percent returns</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span> <span class="c1"># plots</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Minimum and Maximum Cumulative Returns DJIA Stocks</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to  </span><span class="si">{</span><span class="n">returns2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6d23d7e0b18057e2d9ffda8c7688dddaf35437be7f6112e9722f310dfaae07e0.png" src="_images/6d23d7e0b18057e2d9ffda8c7688dddaf35437be7f6112e9722f310dfaae07e0.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_05_practice_04"></span><section id="mckinney-chapter-5-practice-section-4-wednesday-11-45-am">
<h3>McKinney Chapter 5 - Practice (Section 4, Wednesday 11:45 AM)<a class="headerlink" href="#mckinney-chapter-5-practice-section-4-wednesday-11-45-am" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Due on Friday 2/3 at 11:59 PM</p>
<ul>
<li><p>10,000 Total XP, but <em><strong>submit a PDF of your home page with total XP to Gradescope</strong></em></p></li>
<li><p>quiz 2</p></li>
</ul>
</li>
<li><p>I will open project groups at 9 AM on Monday 2/6</p></li>
<li><p>I will close project groups at 9 AM on Monday 2/13 and randomly assign unassigned students</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="s1">&#39;AAPL IBM MSFT GOOG&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  4 of 4 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>GOOG</th>
      <th>IBM</th>
      <th>MSFT</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2004-08-20</th>
      <td>0.0029</td>
      <td>0.0794</td>
      <td>0.0042</td>
      <td>0.0029</td>
    </tr>
    <tr>
      <th>2004-08-23</th>
      <td>0.0091</td>
      <td>0.0101</td>
      <td>-0.0070</td>
      <td>0.0044</td>
    </tr>
    <tr>
      <th>2004-08-24</th>
      <td>0.0280</td>
      <td>-0.0414</td>
      <td>0.0007</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2004-08-25</th>
      <td>0.0344</td>
      <td>0.0108</td>
      <td>0.0042</td>
      <td>0.0114</td>
    </tr>
    <tr>
      <th>2004-08-26</th>
      <td>0.0487</td>
      <td>0.0180</td>
      <td>-0.0045</td>
      <td>-0.0040</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-01-26</th>
      <td>0.0148</td>
      <td>0.0251</td>
      <td>-0.0448</td>
      <td>0.0307</td>
    </tr>
    <tr>
      <th>2023-01-27</th>
      <td>0.0137</td>
      <td>0.0156</td>
      <td>-0.0004</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>2023-01-30</th>
      <td>-0.0201</td>
      <td>-0.0274</td>
      <td>0.0068</td>
      <td>-0.0220</td>
    </tr>
    <tr>
      <th>2023-01-31</th>
      <td>0.0090</td>
      <td>0.0196</td>
      <td>-0.0042</td>
      <td>0.0210</td>
    </tr>
    <tr>
      <th>2023-02-01</th>
      <td>0.0079</td>
      <td>0.0156</td>
      <td>0.0027</td>
      <td>0.0199</td>
    </tr>
  </tbody>
</table>
<p>4645 rows × 4 columns</p>
</div></div></div>
</div>
<section id="what-are-the-mean-daily-returns-for-these-four-stocks">
<h5>What are the mean daily returns for these four stocks?<a class="headerlink" href="#what-are-the-mean-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.0015
GOOG   0.0010
IBM    0.0003
MSFT   0.0007
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>What are the standard deviations of daily returns for these four stocks?<a class="headerlink" href="#what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.0210
GOOG   0.0194
IBM    0.0144
MSFT   0.0173
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>What are the <em>annualized</em> means and standard deviations of daily returns for these four stocks?<a class="headerlink" href="#what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.3670
GOOG   0.2480
IBM    0.0822
MSFT   0.1836
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   0.3331
GOOG   0.3077
IBM    0.2294
MSFT   0.2739
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>The best explanation I have found on why stock return volatility (the standard deviation of stocks returns) grows with the square root of time is at the bottom of page 7 of <a class="reference external" href="https://book.ivo-welch.info/read/source5.mba/08-invchoice.pdf">chapter 8 of Ivo Welch’s free corporate finance textbook</a>.</strong></em></p>
</section>
<section id="plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>Plot <em>annualized</em> means versus standard deviations of daily returns for these four stocks<a class="headerlink" href="#plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<p>Use <code class="docutils literal notranslate"><span class="pre">plt.scatter()</span></code>, which expects arguments as <code class="docutils literal notranslate"><span class="pre">x</span></code> (standard deviations) then <code class="docutils literal notranslate"><span class="pre">y</span></code> (means).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Standard Deviation of Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Return Versus Risk</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="n">i</span>
    <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/81068732707ee4fdae68ad79b1adb968a3deee5f7f285f4735c67dd5c51e8836.png" src="_images/81068732707ee4fdae68ad79b1adb968a3deee5f7f285f4735c67dd5c51e8836.png" />
</div>
</div>
</section>
<section id="repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia">
<h5>Repeat the previous calculations and plot for the stocks in the Dow-Jones Industrial Index (DJIA)<a class="headerlink" href="#repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia" title="Permalink to this heading">#</a></h5>
<p>We can find the current DJIA stocks on <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">Wikipedia</a>.
We will need to download new data, into <code class="docutils literal notranslate"><span class="pre">tickers2</span></code>, <code class="docutils literal notranslate"><span class="pre">prices2</span></code>, and <code class="docutils literal notranslate"><span class="pre">returns2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symbols</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers_2</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">symbols</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">prices_2</span> <span class="o">=</span> <span class="n">tickers_2</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">prices_2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices_2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">returns_2</span> <span class="o">=</span> <span class="n">prices_2</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Ticker&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  30 of 30 completed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">prices_2</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year of Complete Data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Data Availability for DJIA Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/48fb2a22953716a02201a516e7759521befddae5e9ed74bb3e1c29d8d84dd7be.png" src="_images/48fb2a22953716a02201a516e7759521befddae5e9ed74bb3e1c29d8d84dd7be.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">returns_2</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="n">returns_2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Standard Deviation of Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Return Versus Risk for DJIA Stocks</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns_2</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">returns_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">returns_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="n">i</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6fd5067bd58dfed5a5ffaafeb478cc7aeb32902edc501dcb17af22a18ca700d0.png" src="_images/6fd5067bd58dfed5a5ffaafeb478cc7aeb32902edc501dcb17af22a18ca700d0.png" />
</div>
</div>
<p><em><strong>THERE IS NO RELATION BETWEEN RETURNS AND RISK FOR SINGLE STOCKS!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1.    , 0.0186],
       [0.0186, 1.    ]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-total-returns-for-the-stocks-in-the-djia">
<h5>Calculate total returns for the stocks in the DJIA<a class="headerlink" href="#calculate-total-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.prod()</span></code> method to compound returns as $1 + R_T = \prod_{t=1}^T (1 + R_t)$.
Technically, we should write $R_T$ as $R_{0,T}$, but we typically omit the subscript $0$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Returns for DJIA Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8f75b4eb4a045ae4ad1adc453b75fd89f2400632de02b33ed1ed271f166bd17b.png" src="_images/8f75b4eb4a045ae4ad1adc453b75fd89f2400632de02b33ed1ed271f166bd17b.png" />
</div>
</div>
</section>
<section id="plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia">
<h5>Plot the distribution of total returns for the stocks in the DJIA<a class="headerlink" href="#plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can plot a histogram, using either the <code class="docutils literal notranslate"><span class="pre">plt.hist()</span></code> function or the <code class="docutils literal notranslate"><span class="pre">.plot(kind='hist')</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Total Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Returns for DJIA Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4d1080320a7838611340f073bba83ed55b27094ed4276f5cb3c2e5fd52438d19.png" src="_images/4d1080320a7838611340f073bba83ed55b27094ed4276f5cb3c2e5fd52438d19.png" />
</div>
</div>
</section>
<section id="which-stocks-have-the-minimum-and-maximum-total-returns">
<h5>Which stocks have the minimum and maximum total returns?<a class="headerlink" href="#which-stocks-have-the-minimum-and-maximum-total-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span> <span class="o">=</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;BA&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;AAPL&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
BA     -0.4154
INTC   -0.3986
MMM    -0.3630
WBA    -0.3114
VZ     -0.1284
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">nlargest</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL   2.1895
MSFT   1.2354
UNH    1.0982
CAT    1.0732
GS     1.0461
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
BA     -0.4154
AAPL    2.1895
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-cumulative-returns-for-the-stocks-in-the-djia">
<h5>Plot the cumulative returns for the stocks in the DJIA<a class="headerlink" href="#plot-the-cumulative-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can use the cumulative product method <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> to calculate the right hand side of the formula above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cumulative Returns for DJIA Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d020e2d07cb7d55860f0ae7dae944fd83b1b294ac778a3f118ffb032323ae46d.png" src="_images/d020e2d07cb7d55860f0ae7dae944fd83b1b294ac778a3f118ffb032323ae46d.png" />
</div>
</div>
</section>
<section id="repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns">
<h5>Repeat the plot above with only the minimum and maximum total returns<a class="headerlink" href="#repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2</span><span class="p">[</span> <span class="c1"># DJIA daily returns</span>
        <span class="n">returns_2_total</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span> <span class="c1"># slice min and mix total returns</span>
    <span class="p">]</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># add 1</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="c1"># calculate cumulative returns</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># sutract 1</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># convert to percent</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span> <span class="c1"># plot the time series</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cumulative Returns for Best and Worst DJIA Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/be3c0f9b2b801373f7fbac2dd6270c6aadd9beea7f3f5624459bd113e33a2128.png" src="_images/be3c0f9b2b801373f7fbac2dd6270c6aadd9beea7f3f5624459bd113e33a2128.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_05_practice_02"></span><section id="mckinney-chapter-5-practice-section-2-wednesday-2-45-pm">
<h3>McKinney Chapter 5 - Practice (Section 2, Wednesday 2:45 PM)<a class="headerlink" href="#mckinney-chapter-5-practice-section-2-wednesday-2-45-pm" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Due on Friday, 2/3, at 11:59 PM</p>
<ul>
<li><p>10,000 Total XP <em><strong>submited to Gradescope as a PDF</strong></em></p></li>
<li><p>Quiz 2</p></li>
</ul>
</li>
<li><p>On Monday, 2/6, at 9 AM I will open groups on Canvas</p></li>
<li><p>I will close the groups on Monday, 2/13, and randomly assign anyone left over</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="s1">&#39;AAPL IBM MSFT GOOG&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Ticker&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  4 of 4 completed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>GOOG</th>
      <th>IBM</th>
      <th>MSFT</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2004-08-20</th>
      <td>0.0029</td>
      <td>0.0794</td>
      <td>0.0042</td>
      <td>0.0029</td>
    </tr>
    <tr>
      <th>2004-08-23</th>
      <td>0.0091</td>
      <td>0.0101</td>
      <td>-0.0070</td>
      <td>0.0044</td>
    </tr>
    <tr>
      <th>2004-08-24</th>
      <td>0.0280</td>
      <td>-0.0414</td>
      <td>0.0007</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2004-08-25</th>
      <td>0.0344</td>
      <td>0.0108</td>
      <td>0.0042</td>
      <td>0.0114</td>
    </tr>
    <tr>
      <th>2004-08-26</th>
      <td>0.0487</td>
      <td>0.0180</td>
      <td>-0.0045</td>
      <td>-0.0040</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-01-26</th>
      <td>0.0148</td>
      <td>0.0251</td>
      <td>-0.0448</td>
      <td>0.0307</td>
    </tr>
    <tr>
      <th>2023-01-27</th>
      <td>0.0137</td>
      <td>0.0156</td>
      <td>-0.0004</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>2023-01-30</th>
      <td>-0.0201</td>
      <td>-0.0274</td>
      <td>0.0068</td>
      <td>-0.0220</td>
    </tr>
    <tr>
      <th>2023-01-31</th>
      <td>0.0090</td>
      <td>0.0196</td>
      <td>-0.0042</td>
      <td>0.0210</td>
    </tr>
    <tr>
      <th>2023-02-01</th>
      <td>0.0079</td>
      <td>0.0156</td>
      <td>0.0027</td>
      <td>0.0199</td>
    </tr>
  </tbody>
</table>
<p>4645 rows × 4 columns</p>
</div></div></div>
</div>
<section id="what-are-the-mean-daily-returns-for-these-four-stocks">
<h5>What are the mean daily returns for these four stocks?<a class="headerlink" href="#what-are-the-mean-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL   0.0015
GOOG   0.0010
IBM    0.0003
MSFT   0.0007
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>What are the standard deviations of daily returns for these four stocks?<a class="headerlink" href="#what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL   0.0210
GOOG   0.0194
IBM    0.0144
MSFT   0.0173
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>What are the <em>annualized</em> means and standard deviations of daily returns for these four stocks?<a class="headerlink" href="#what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL   0.3670
GOOG   0.2480
IBM    0.0822
MSFT   0.1836
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL   0.3331
GOOG   0.3077
IBM    0.2294
MSFT   0.2739
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>The best explanation I have found on why stock return volatility (the standard deviation of stocks returns) grows with the square root of time is at the bottom of page 7 of <a class="reference external" href="https://book.ivo-welch.info/read/source5.mba/08-invchoice.pdf">chapter 8 of Ivo Welch’s free corporate finance textbook</a>.</strong></em></p>
</section>
<section id="plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks">
<h5>Plot <em>annualized</em> means versus standard deviations of daily returns for these four stocks<a class="headerlink" href="#plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks" title="Permalink to this heading">#</a></h5>
<p>Use <code class="docutils literal notranslate"><span class="pre">plt.scatter()</span></code>, which expects arguments as <code class="docutils literal notranslate"><span class="pre">x</span></code> (standard deviations) then <code class="docutils literal notranslate"><span class="pre">y</span></code> (means).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Standard Deviation of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Returns Versus Risk</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="n">i</span>
    <span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/30b2057f4f3cf63067542362c499ec4756baf24fdae3566bbb139e16665497b5.png" src="_images/30b2057f4f3cf63067542362c499ec4756baf24fdae3566bbb139e16665497b5.png" />
</div>
</div>
</section>
<section id="repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-average-djia">
<h5>Repeat the previous calculations and plot for the stocks in the Dow-Jones Industrial Average (DJIA)<a class="headerlink" href="#repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-average-djia" title="Permalink to this heading">#</a></h5>
<p>We can find the current DJIA stocks on <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">Wikipedia</a>.
We will need to download new data, into <code class="docutils literal notranslate"><span class="pre">tickers2</span></code>, <code class="docutils literal notranslate"><span class="pre">prices2</span></code>, and <code class="docutils literal notranslate"><span class="pre">returns2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">returns_many</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Ticker&#39;</span>
    <span class="k">return</span> <span class="n">returns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_many</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Standard Deviation of Daily Returns (%)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Daily Returns (%)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Returns Versus Risk</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">i</span>
        <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2</span> <span class="o">=</span> <span class="n">returns_many</span><span class="p">(</span><span class="n">wiki</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  30 of 30 completed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_many</span><span class="p">(</span><span class="n">returns_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a0507d06845140f9e47a29056e6e1f9de8003cc4edbe1c180658ca8e60f00eb2.png" src="_images/a0507d06845140f9e47a29056e6e1f9de8003cc4edbe1c180658ca8e60f00eb2.png" />
</div>
</div>
<p><em><strong>THERE IS NO RELATION BETWEEN RETURNS AND RISK FOR SINGLE STOCKS!</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1.    , 0.0186],
       [0.0186, 1.    ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_many</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a0507d06845140f9e47a29056e6e1f9de8003cc4edbe1c180658ca8e60f00eb2.png" src="_images/a0507d06845140f9e47a29056e6e1f9de8003cc4edbe1c180658ca8e60f00eb2.png" />
</div>
</div>
</section>
<section id="calculate-total-returns-for-the-stocks-in-the-djia">
<h5>Calculate total returns for the stocks in the DJIA<a class="headerlink" href="#calculate-total-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.prod()</span></code> method to compound returns as $1 + R_T = \prod_{t=1}^T (1 + R_t)$.
Technically, we should write $R_T$ as $R_{0,T}$, but we typically omit the subscript $0$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Returns for DJIA Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8f75b4eb4a045ae4ad1adc453b75fd89f2400632de02b33ed1ed271f166bd17b.png" src="_images/8f75b4eb4a045ae4ad1adc453b75fd89f2400632de02b33ed1ed271f166bd17b.png" />
</div>
</div>
</section>
<section id="plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia">
<h5>Plot the distribution of total returns for the stocks in the DJIA<a class="headerlink" href="#plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can plot a histogram, using either the <code class="docutils literal notranslate"><span class="pre">plt.hist()</span></code> function or the <code class="docutils literal notranslate"><span class="pre">.plot(kind='hist')</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Total Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Returns for DJIA Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4d1080320a7838611340f073bba83ed55b27094ed4276f5cb3c2e5fd52438d19.png" src="_images/4d1080320a7838611340f073bba83ed55b27094ed4276f5cb3c2e5fd52438d19.png" />
</div>
</div>
</section>
<section id="which-stocks-have-the-minimum-and-maximum-total-returns">
<h5>Which stocks have the minimum and maximum total returns?<a class="headerlink" href="#which-stocks-have-the-minimum-and-maximum-total-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span> <span class="o">=</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.4154
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;BA&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.1895
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;AAPL&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
BA     -0.4154
AAPL    2.1895
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
BA     -0.4154
INTC   -0.3986
MMM    -0.3630
WBA    -0.3114
VZ     -0.1284
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">nlargest</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL   2.1895
MSFT   1.2354
UNH    1.0982
CAT    1.0732
GS     1.0461
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-cumulative-returns-for-the-stocks-in-the-djia">
<h5>Plot the cumulative returns for the stocks in the DJIA<a class="headerlink" href="#plot-the-cumulative-returns-for-the-stocks-in-the-djia" title="Permalink to this heading">#</a></h5>
<p>We can use the cumulative product method <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> to calculate the right hand side of the formula above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cumulative Returns for DJIA Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6076f301717c19a5969428bf65e6914c3e281e67c849ffba29596ab9e7107dfd.png" src="_images/6076f301717c19a5969428bf65e6914c3e281e67c849ffba29596ab9e7107dfd.png" />
</div>
</div>
</section>
<section id="repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns">
<h5>Repeat the plot above with only the minimum and maximum total returns<a class="headerlink" href="#repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2</span><span class="p">[[</span><span class="n">returns_2_total</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="n">returns_2_total</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]]</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cumulative Returns for Best and Worst DJIA Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3644cd3e0275e36ad55f6b74192242d07d74755ef718887c3641e324abe4866c.png" src="_images/3644cd3e0275e36ad55f6b74192242d07d74755ef718887c3641e324abe4866c.png" />
</div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-herron_01_lecture"></span><section id="herron-topic-1-web-data-log-and-simple-returns-and-portfolio-math">
<h2>Herron Topic 1 - Web Data, Log and Simple Returns, and Portfolio Math<a class="headerlink" href="#herron-topic-1-web-data-log-and-simple-returns-and-portfolio-math" title="Permalink to this heading">#</a></h2>
<p>This notebook covers three topics:</p>
<ol class="arabic simple">
<li><p>How to download web data with the yfinance, pandas-datareader, and requests-cache packages</p></li>
<li><p>How to calculate log and simple returns</p></li>
<li><p>How to calculate portfolio returns</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="web-data">
<h3>Web Data<a class="headerlink" href="#web-data" title="Permalink to this heading">#</a></h3>
<p>We will typically use the yfinance and pandas-datarader packages (combined with the requests-cache package) to download data from the web.</p>
<ul class="simple">
<li><p>If you followed my instructions to install Anaconda on your computer, you have already installed these packages</p></li>
<li><p>If you use DataCamp Workspace or Binder, I have already installed these packages</p></li>
<li><p>If you use Notheastern’s Open OnDemand, they are working on my request, and you will have to install these packages every login by running the following in a code cell: <code class="docutils literal notranslate"><span class="pre">%pip</span> <span class="pre">install</span> <span class="pre">yfinance</span> <span class="pre">pandas-datareader</span> <span class="pre">requests-cache</span></code></p></li>
</ul>
<section id="the-yfinance-package">
<h4>The yfinance Package<a class="headerlink" href="#the-yfinance-package" title="Permalink to this heading">#</a></h4>
<p>The <a class="reference external" href="https://github.com/ranaroussi/yfinance">yfinance package</a> provides “a reliable, threaded, and Pythonic way to download historical market data from Yahoo! finance.”
Other packages provide similar functionality, but yfinance is best.
We will use the <a class="reference external" href="https://github.com/requests-cache/requests-cache">requests-cache package</a> to cache our data downloads locally.
This local cache lets us reduce the number of times we ask the Yahoo! Finance application programming interface (API).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">(</span><span class="n">expire_after</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can download data for the MATANA stocks (Microsoft, Alphabet, Tesla, Amazon, Nvidia, and Apple).
We can pass tickers as either a space-delimited string or a list of strings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;MSFT GOOG TSLA AMZN NVDA AAPL&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">histories</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">histories</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">histories</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">histories</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="4" halign="left">Stock Splits</th>
      <th colspan="6" halign="left">Volume</th>
    </tr>
    <tr>
      <th></th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>...</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>0.0999</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>469033600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>0.0947</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1217</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>175884800</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>0.0877</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1127</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>105728000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.0899</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>86441600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.0925</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>73449600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-01-30</th>
      <td>143.0000</td>
      <td>100.5500</td>
      <td>97.9500</td>
      <td>242.7100</td>
      <td>191.6200</td>
      <td>166.6600</td>
      <td>143.0000</td>
      <td>100.5500</td>
      <td>97.9500</td>
      <td>242.7100</td>
      <td>...</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>64015300</td>
      <td>70691900.0000</td>
      <td>24365100.0000</td>
      <td>25867400.0000</td>
      <td>48861100.0000</td>
      <td>230878800.0000</td>
    </tr>
    <tr>
      <th>2023-01-31</th>
      <td>144.2900</td>
      <td>103.1300</td>
      <td>99.8700</td>
      <td>247.8100</td>
      <td>195.3700</td>
      <td>173.2200</td>
      <td>144.2900</td>
      <td>103.1300</td>
      <td>99.8700</td>
      <td>247.8100</td>
      <td>...</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>65874500</td>
      <td>66527300.0000</td>
      <td>22306800.0000</td>
      <td>26541100.0000</td>
      <td>49801700.0000</td>
      <td>196813500.0000</td>
    </tr>
    <tr>
      <th>2023-02-01</th>
      <td>145.4300</td>
      <td>105.1500</td>
      <td>101.4300</td>
      <td>252.7500</td>
      <td>209.4300</td>
      <td>181.4100</td>
      <td>145.4300</td>
      <td>105.1500</td>
      <td>101.4300</td>
      <td>252.7500</td>
      <td>...</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>77663600</td>
      <td>80450100.0000</td>
      <td>26392600.0000</td>
      <td>31259900.0000</td>
      <td>66047700.0000</td>
      <td>213806300.0000</td>
    </tr>
    <tr>
      <th>2023-02-02</th>
      <td>150.8200</td>
      <td>112.9100</td>
      <td>108.8000</td>
      <td>264.6000</td>
      <td>217.0900</td>
      <td>188.2700</td>
      <td>150.8200</td>
      <td>112.9100</td>
      <td>108.8000</td>
      <td>264.6000</td>
      <td>...</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>118339000</td>
      <td>158154200.0000</td>
      <td>46622600.0000</td>
      <td>39940400.0000</td>
      <td>56427600.0000</td>
      <td>217448300.0000</td>
    </tr>
    <tr>
      <th>2023-02-03</th>
      <td>154.8900</td>
      <td>103.2600</td>
      <td>105.0700</td>
      <td>258.3100</td>
      <td>210.5624</td>
      <td>NaN</td>
      <td>154.8900</td>
      <td>103.2600</td>
      <td>105.0700</td>
      <td>258.3100</td>
      <td>...</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>130069253</td>
      <td>118655627.0000</td>
      <td>29959465.0000</td>
      <td>20269785.0000</td>
      <td>36649525.0000</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>10626 rows × 48 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span> <span class="c1"># Python ignores line breaks and white space inside ()</span>
    <span class="n">histories</span> <span class="c1"># start with MATANA data frame</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="c1"># slice adjusted close columns</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="c1"># calculate simple returns</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span> <span class="c1"># select 2022 returns</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># add 1</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="c1"># compound cumulative returns</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># subtract 1</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># convert decimals to percent</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span> <span class="c1"># plot</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Year-to-Date Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Year-to-Date Returns for MATANA Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/61ce6f23b9e0a0d877336fe33293b48ace81e194642b157c516922e1ef9fe741.png" src="_images/61ce6f23b9e0a0d877336fe33293b48ace81e194642b157c516922e1ef9fe741.png" />
</div>
</div>
</section>
<section id="the-pandas-datareader-package">
<h4>The pandas-datareader package<a class="headerlink" href="#the-pandas-datareader-package" title="Permalink to this heading">#</a></h4>
<p>The <a class="reference external" href="https://pandas-datareader.readthedocs.io/en/latest/index.html">pandas-datareader</a> package provides easy access to various data sources, including <a class="reference external" href="https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/data_library.html">the Kenneth French Data Library</a> and <a class="reference external" href="https://fred.stlouisfed.org/">the Federal Reserve Economic Data (FRED)</a>.
The pandas-datareader package also downloads Yahoo! Finance data, but the yfinance package has better documentation.
We will use <code class="docutils literal notranslate"><span class="pre">pdr</span></code> as the abbreviated prefix for pandas-datareader.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
</pre></div>
</div>
</div>
</div>
<p>Here we download the daily benchmark factors from Ken French’s Data Library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdr</span><span class="o">.</span><span class="n">famafrench</span><span class="o">.</span><span class="n">get_available_datasets</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors&#39;,
 &#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;]
</pre></div>
</div>
</div>
</div>
<p>For Fama and French data, pandas-datareader returns the most recent five years of data unless we specify a <code class="docutils literal notranslate"><span class="pre">start</span></code> date.
French typically provides data back through the second half of 1926.
pandas-datareader returns dictionaries of data frames, and the <code class="docutils literal notranslate"><span class="pre">'DESCR'</span></code> value describes these data frames.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_all</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span> 
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ff_all</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>F-F Research Data Factors daily
-------------------------------

This file was created by CMPT_ME_BEME_RETS_DAILY using the 202212 CRSP database. The Tbill return is the simple daily rate that, over the number of trading days in the month, compounds to 1-month TBill rate from Ibbotson and Associates Inc. Copyright 2022 Kenneth R. French

  0 : (25399 rows x 4 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns for the Daily Benchmark Factors (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">StrMethodFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{x:,.0f}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/75ed8cf829f66de137a937463bb33050701a9e7f3fec815e3ffd36c7f1c1f458.png" src="_images/75ed8cf829f66de137a937463bb33050701a9e7f3fec815e3ffd36c7f1c1f458.png" />
</div>
</div>
</section>
</section>
<section id="log-and-simple-returns">
<h3>Log and Simple Returns<a class="headerlink" href="#log-and-simple-returns" title="Permalink to this heading">#</a></h3>
<p>We will typically use <em>simple</em> returns, calculated as $R_{simple,t} = \frac{P_t + D_t - P_{t-1}}{P_{t-1}} = \frac{P_t + D_t}{P_{t-1}} - 1$.
The simple return is the return that investors receive on invested dollars.
We can calculate simple returns from Yahoo Finance data with the <code class="docutils literal notranslate"><span class="pre">.pct_change()</span></code> method on the adjusted close column (i.e., <code class="docutils literal notranslate"><span class="pre">Adj</span> <span class="pre">Close</span></code>), which adjusts for dividends and splits.
The adjusted close column is a reverse-engineered close price (i.e., end-of-trading-day price) that incorporates dividends and splits, making simple return calculations easy.</p>
<p>However, we may see <em>log</em> returns elsewhere, which are the (natural) log of one plus simple returns:</p>
<p>$R_{log,t} = \log(1 + R_{simple,t}) = \log\left(1 +  \frac{P_t + D_t}{P_{t-1}} - 1 \right) = \log\left(\frac{P_t + D_t}{P_{t-1}} \right) = \log(P_t + D_t) - \log(P_{t-1})$</p>
<p>Therefore, we calculate log returns as either the log of one plus simple returns or the difference of the logs of the adjusted close column.
Log returns are also known as <em>continuously-compounded</em> returns.</p>
<p>We will typically use <em>simple</em> returns instead of <em>log</em> returns.
However, this section explains the differences between simple and log returns and where each is appropriate.</p>
<section id="simple-and-log-returns-are-similar-for-small-returns">
<h4>Simple and Log Returns are Similar for Small Returns<a class="headerlink" href="#simple-and-log-returns-are-similar-for-small-returns" title="Permalink to this heading">#</a></h4>
<p>$\log(1 + x) \approx x$ for small values of $x$, so simple returns and log returns are similar for small returns.
Returns are typically small at daily and monthly horizons, so the difference between simple and log returns is small at these horizons.
The following figure shows $R_{simple,t} \approx R_{log,t}$ for small $R$s.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">logR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">logR</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Simple Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Log Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Log Versus Simple Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Actual&#39;</span><span class="p">,</span> <span class="s1">&#39;If Log = Simple&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/be30c7d407a1dffdd992d58d2b7f0cc7045264ebe1c4c89f5e2750194df26c27.png" src="_images/be30c7d407a1dffdd992d58d2b7f0cc7045264ebe1c4c89f5e2750194df26c27.png" />
</div>
</div>
</section>
<section id="simple-return-advantage-portfolio-calculations">
<h4>Simple Return Advantage: Portfolio Calculations<a class="headerlink" href="#simple-return-advantage-portfolio-calculations" title="Permalink to this heading">#</a></h4>
<p>We can only perform portfolio calculations with simple returns.
For a portfolio of $N$ assets with portfolio weights $w_i$, the portfolio return $R_{p}$ is the weighted average of the returns of its assets, $R_{p} = \sum_{i=1}^N w_i R_{i}$.
For two stocks with portfolio weights of 50%, our portfolio return is $R_{portfolio} = 0.5 R_1 + 0.5 R_2 = \frac{R_1 + R_2}{2}$.
However, we cannot calculate portfolio returns with log returns because the sum of logs is the log of products.</p>
<p><em><strong>We cannot calculate portfolio returns as the weighted average of log returns.</strong></em></p>
</section>
<section id="log-return-advantage-log-returns-are-additive">
<h4>Log Return Advantage: Log Returns are Additive<a class="headerlink" href="#log-return-advantage-log-returns-are-additive" title="Permalink to this heading">#</a></h4>
<p>The advantage of log returns is that we can compound log returns with addition.
The additive property of log returns makes code simple, computations fast, and proofs easy when we compound returns over multiple periods.</p>
<p>We compound returns from $t=0$ to $t=T$ as follows:</p>
<p>$1 + R_{0, T} = (1 + R_1) \times (1 + R_2) \times \dots \times (1 + R_T)$</p>
<p>Next, we take the log of both sides of the previous equation and use the property that the log of products is the sum of logs:</p>
<p>$\log(1 + R_{0, T}) = \log((1 + R_1) \times (1 + R_2) \times \dots \times (1 + R_T)) = \log(1 + R_1) + \log(1 + R_2) + \dots + \log(1 + R_T) = \sum_{t=1}^T \log(1 + R_t)$</p>
<p>Next, we exponentiate both sides of the previous equation:</p>
<p>$e^{\log(1 + R_{0, T})} = e^{\sum_{t=0}^T \log(1 + R_t)}$</p>
<p>Next, we use the property that $e^{\log(x)} = x$ to simplify the previous equation:</p>
<p>$1 + R_{0,T} = e^{\sum_{t=0}^T \log(1 + R_t)}$</p>
<p>Finally, we subtract 1 from both sides:</p>
<p>$R_{0 ,T} = e^{\sum_{t=0}^T \log(1 + R_t)} - 1$</p>
<p>So, the return $R_{0,T}$ from $t=0$ to $t=T$ is the exponentiated sum of log returns.
The pandas developers assume users understand the math above and focus on optimizing sums.</p>
<p>The following code generates 10,000 random log returns.
The <code class="docutils literal notranslate"><span class="pre">np.random.randn()</span></code> call generates normally distributed random numbers.
To generate equivalent simple returns, we exponentiate these log returns, then subtract one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10000</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>R</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>10000.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.6529</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2.1918</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.9802</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.4896</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>-0.0026</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.9564</td>
    </tr>
    <tr>
      <th>max</th>
      <td>49.7158</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can time the calculation of 12-observation rolling returns.
We use <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> for the simple return version because <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> does not have a product method.
We find that <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> is slower with <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> than with <code class="docutils literal notranslate"><span class="pre">.sum()</span></code> by a factor of 2,000.
<em><strong>We will learn about <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> and <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> in a few weeks, but they provide the best example of when to use log returns.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;R12_via_simple&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>644 ms ± 8.23 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;R12_via_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>878 µs ± 16.8 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;R12_via_simple&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;R12_via_log&#39;</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>These two approaches calculate the same return, but the simple-return approach is 1,000 times slower than the log-return approach!</p>
<p><em><strong>We can use log returns to calculate total or holding period returns very quickly!</strong></em></p>
</section>
</section>
<section id="portfolio-math">
<h3>Portfolio Math<a class="headerlink" href="#portfolio-math" title="Permalink to this heading">#</a></h3>
<p>Portfolio return $R_{p}$ is the weighted average of its asset returns, so $R_{p} = \sum_{i=1}^N w_i R_{i}$.
Here $N$ is the number of assets, and $w_i$ is the weight on asset $i$.</p>
<section id="the-1-n-portfolio">
<h4>The 1/N Portfolio<a class="headerlink" href="#the-1-n-portfolio" title="Permalink to this heading">#</a></h4>
<p>The $\frac{1}{N}$ portfolio equally weights portfolio assets, so $w_1 = w_2 = \dots = w_N = \frac{1}{N}$.
We typically rebalance the $\frac{1}{N}$ portfolio every period.
If $w_i = \frac{1}{N}$, then $R_{p} = \sum_{i=1}^N \frac{1}{N} R_{i} = \frac{\sum_{i=1}^N R_i}{N} = \bar{R}$.
Therefore, we can use <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> to calculate $\frac{1}{N}$ portfolio returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-01-03</th>
      <td>0.0250</td>
      <td>0.0221</td>
      <td>0.0027</td>
      <td>-0.0047</td>
      <td>0.0241</td>
      <td>0.1353</td>
    </tr>
    <tr>
      <th>2022-01-04</th>
      <td>-0.0127</td>
      <td>-0.0169</td>
      <td>-0.0045</td>
      <td>-0.0171</td>
      <td>-0.0276</td>
      <td>-0.0418</td>
    </tr>
    <tr>
      <th>2022-01-05</th>
      <td>-0.0266</td>
      <td>-0.0189</td>
      <td>-0.0468</td>
      <td>-0.0384</td>
      <td>-0.0576</td>
      <td>-0.0535</td>
    </tr>
    <tr>
      <th>2022-01-06</th>
      <td>-0.0167</td>
      <td>-0.0067</td>
      <td>-0.0007</td>
      <td>-0.0079</td>
      <td>0.0208</td>
      <td>-0.0215</td>
    </tr>
    <tr>
      <th>2022-01-07</th>
      <td>0.0010</td>
      <td>-0.0043</td>
      <td>-0.0040</td>
      <td>0.0005</td>
      <td>-0.0330</td>
      <td>-0.0354</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-12-23</th>
      <td>-0.0028</td>
      <td>0.0174</td>
      <td>0.0176</td>
      <td>0.0023</td>
      <td>-0.0087</td>
      <td>-0.0176</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>-0.0139</td>
      <td>-0.0259</td>
      <td>-0.0209</td>
      <td>-0.0074</td>
      <td>-0.0714</td>
      <td>-0.1141</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>-0.0307</td>
      <td>-0.0147</td>
      <td>-0.0167</td>
      <td>-0.0103</td>
      <td>-0.0060</td>
      <td>0.0331</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>0.0283</td>
      <td>0.0288</td>
      <td>0.0288</td>
      <td>0.0276</td>
      <td>0.0404</td>
      <td>0.0808</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>0.0025</td>
      <td>-0.0021</td>
      <td>-0.0025</td>
      <td>-0.0049</td>
      <td>0.0008</td>
      <td>0.0112</td>
    </tr>
  </tbody>
</table>
<p>251 rows × 6 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AAPL   -0.0010
AMZN   -0.0022
GOOG   -0.0016
MSFT   -0.0011
NVDA   -0.0020
TSLA   -0.0033
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rp_1</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rp_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Date
2022-01-03    0.0341
2022-01-04   -0.0201
2022-01-05   -0.0403
2022-01-06   -0.0055
2022-01-07   -0.0125
               ...  
2022-12-23    0.0014
2022-12-27   -0.0423
2022-12-28   -0.0075
2022-12-29    0.0391
2022-12-30    0.0008
Length: 251, dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>Note that when we apply the same portfolio weights every period, we rebalance at the same frequency as the returns data.</strong></em>
If we have daily data, rebalance daily.
If we have monthly data, we rebalance monthly, and so on.</p>
</section>
<section id="a-more-general-solution">
<h4>A More General Solution<a class="headerlink" href="#a-more-general-solution" title="Permalink to this heading">#</a></h4>
<p>If we combine weights into vector $w$ and the time series of asset returns into matrix $\bf{R}$, then we can calculate the time series of portfolio returns as $R_p = w^T \bf{R}$.
The pandas version of this calculation is <code class="docutils literal notranslate"><span class="pre">R.dot(w)</span></code>, where <code class="docutils literal notranslate"><span class="pre">R</span></code> is a data frame of asset returns and <code class="docutils literal notranslate"><span class="pre">w</span></code> is a series of portfolio weights.
We can use this approach to calculate $\frac{1}{N}$ portfolio returns, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">weights</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rp_2</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="n">rp_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Date
2022-01-03    0.0341
2022-01-04   -0.0201
2022-01-05   -0.0403
2022-01-06   -0.0055
2022-01-07   -0.0125
               ...  
2022-12-23    0.0014
2022-12-27   -0.0423
2022-12-28   -0.0075
2022-12-29    0.0391
2022-12-30    0.0008
Length: 251, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Both approaches give the same answer!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">rp_1</span><span class="p">,</span> <span class="n">rp_2</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-herron_01_practice"></span><section id="herron-topic-1-practice-blank">
<h3>Herron Topic 1 - Practice (Blank)<a class="headerlink" href="#herron-topic-1-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">(</span><span class="n">expire_after</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-histories">
<h5>Download all available daily price data for tickers TSLA, F, AAPL, AMZN, and META to data frame <code class="docutils literal notranslate"><span class="pre">histories</span></code><a class="headerlink" href="#download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-histories" title="Permalink to this heading">#</a></h5>
<p>Remove time zone information from the index and use <code class="docutils literal notranslate"><span class="pre">histories.columns.names</span></code> to label the variables and tickers as <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">Ticker</span></code>.</p>
</section>
<section id="calculate-all-available-daily-returns-and-save-to-data-frame-returns">
<h5>Calculate all available daily returns and save to data frame <code class="docutils literal notranslate"><span class="pre">returns</span></code><a class="headerlink" href="#calculate-all-available-daily-returns-and-save-to-data-frame-returns" title="Permalink to this heading">#</a></h5>
</section>
<section id="slices-returns-for-the-2020s-and-assign-to-returns-2020s">
<h5>Slices returns for the 2020s and assign to <code class="docutils literal notranslate"><span class="pre">returns_2020s</span></code><a class="headerlink" href="#slices-returns-for-the-2020s-and-assign-to-returns-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff-all">
<h5>Download all available data for the Fama and French daily benchmark factors to dictionary <code class="docutils literal notranslate"><span class="pre">ff_all</span></code><a class="headerlink" href="#download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff-all" title="Permalink to this heading">#</a></h5>
<p>I often use the following code snippet to find the exact name for the the daily benchmark factors file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdr</span><span class="o">.</span><span class="n">famafrench</span><span class="o">.</span><span class="n">get_available_datasets</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors&#39;,
 &#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff">
<h5>Slice the daily benchmark factors, convert them to decimal returns, and assign to <code class="docutils literal notranslate"><span class="pre">ff</span></code><a class="headerlink" href="#slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff" title="Permalink to this heading">#</a></h5>
</section>
<section id="use-the-cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use the <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> method to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-the-cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="use-the-cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use the <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> method with log returns to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-the-cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use price data only to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="calculate-the-sharpe-ratio-for-tsla">
<h5>Calculate the Sharpe Ratio for TSLA<a class="headerlink" href="#calculate-the-sharpe-ratio-for-tsla" title="Permalink to this heading">#</a></h5>
<p>Calculate the Sharpe Ratio with all available returns and 2020s returns.
Recall the Sharpe Ratio is $\frac{\overline{R_i - R_f}}{\sigma_i}$, where $\sigma_i$ is the volatility of <em>excess</em> returns.</p>
<p><em><strong>I suggest you write a function named <code class="docutils literal notranslate"><span class="pre">sharpe()</span></code> to use for the rest of this notebook.</strong></em></p>
</section>
<section id="calculate-the-market-beta-for-tsla">
<h5>Calculate the market beta for TSLA<a class="headerlink" href="#calculate-the-market-beta-for-tsla" title="Permalink to this heading">#</a></h5>
<p>Calculate the market beta with all available returns and 2020s returns.
Recall we estimate market beta with the ordinary least squares (OLS) regression $R_i-R_f = \alpha + \beta (R_m-R_f) + \epsilon$.
We can estimate market beta with the covariance formula above for a univariate regression if we do not need goodness of fit statistics.</p>
<p><em><strong>I suggest you write a function named <code class="docutils literal notranslate"><span class="pre">beta()</span></code> to use for the rest of this notebook.</strong></em></p>
</section>
<section id="guess-the-sharpe-ratios-for-these-stocks-in-the-2020s">
<h5>Guess the Sharpe Ratios for these stocks in the 2020s<a class="headerlink" href="#guess-the-sharpe-ratios-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="guess-the-market-betas-for-these-stocks-in-the-2020s">
<h5>Guess the market betas for these stocks in the 2020s<a class="headerlink" href="#guess-the-market-betas-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s">
<h5>Calculate the Sharpe Ratios for these stocks in the 2020s<a class="headerlink" href="#calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>How good were your guesses?</p>
</section>
<section id="calculate-the-market-betas-for-these-stocks-in-the-2020s">
<h5>Calculate the market betas for these stocks in the 2020s<a class="headerlink" href="#calculate-the-market-betas-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>How good were your guesses?</p>
</section>
<section id="calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s">
<h5>Calculate the Sharpe Ratio for an <em>equally weighted</em> portfolio of these stocks in the 2020s<a class="headerlink" href="#calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>What do you notice?</p>
</section>
<section id="calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s">
<h5>Calculate the market beta for an <em>equally weighted</em> portfolio of these stocks in the 2020s<a class="headerlink" href="#calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>What do you notice?</p>
</section>
<section id="calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year">
<h5>Calculate the market betas for these stocks every calendar year for every possible year<a class="headerlink" href="#calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year" title="Permalink to this heading">#</a></h5>
<p>Save these market betas to data frame <code class="docutils literal notranslate"><span class="pre">betas</span></code>.
Our current Python knowledge limits us to a for-loop, but we will learn easier and faster approaches soon!</p>
</section>
<section id="plot-the-time-series-of-market-betas">
<h5>Plot the time series of market betas<a class="headerlink" href="#plot-the-time-series-of-market-betas" title="Permalink to this heading">#</a></h5>
</section>
</section>
</section>
<span id="document-herron_01_practice_03"></span><section id="herron-topic-1-practice-section-3-monday-2-45-pm">
<h3>Herron Topic 1 - Practice (Section 3, Monday 2:45 PM)<a class="headerlink" href="#herron-topic-1-practice-section-3-monday-2-45-pm" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 2 - mean was $\approx 90%$</p></li>
<li><p>Quiz 3 - due by 11:59 on Friday, 2/10</p></li>
<li><p>Project groups open on Canvas under People - please sign up!</p></li>
<li><p>Optional, anonymous survey on Canvas under “Quizzes” - I value your feedback</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<p>On Discovery, we need to install the following pacakges every time we log in:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %pip install yfinance pandas-datareader requests-cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">(</span><span class="n">expire_after</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-histories">
<h5>Download all available daily price data for tickers TSLA, F, AAPL, AMZN, and META to data frame <code class="docutils literal notranslate"><span class="pre">histories</span></code><a class="headerlink" href="#download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-histories" title="Permalink to this heading">#</a></h5>
<p>Remove time zone information from the index and use <code class="docutils literal notranslate"><span class="pre">histories.columns.names</span></code> to label the variables and tickers as <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">Ticker</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="s1">&#39;TSLA F AAPL AMZN META&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">histories</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">histories</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]</span>
<span class="n">histories</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">histories</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">histories</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  5 of 5 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="5" halign="left">Adj Close</th>
      <th colspan="5" halign="left">Close</th>
      <th>...</th>
      <th colspan="5" halign="left">Stock Splits</th>
      <th colspan="5" halign="left">Volume</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>...</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1972-06-01</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2673</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1532</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1091238</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2668</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1174468</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2668</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5209582</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2638</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1248</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1424158</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2623</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1127</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>675088</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 40 columns</p>
</div></div></div>
</div>
</section>
<section id="calculate-all-available-daily-returns-and-save-to-data-frame-returns">
<h5>Calculate all available daily returns and save to data frame <code class="docutils literal notranslate"><span class="pre">returns</span></code><a class="headerlink" href="#calculate-all-available-daily-returns-and-save-to-data-frame-returns" title="Permalink to this heading">#</a></h5>
<p><em><strong>The following code assumes data are chronologically ordered!</strong></em>
The yfinance package returns sorted data, and we can use <code class="docutils literal notranslate"><span class="pre">.sort_index()</span></code> to sort our data, if necessary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">returns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1972-06-01</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0019</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0113</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0057</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="slices-returns-for-the-2020s-and-assign-to-returns-2020s">
<h5>Slices returns for the 2020s and assign to <code class="docutils literal notranslate"><span class="pre">returns_2020s</span></code><a class="headerlink" href="#slices-returns-for-the-2020s-and-assign-to-returns-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:]</span>
<span class="n">returns_2020s</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>0.0228</td>
      <td>0.0272</td>
      <td>0.0129</td>
      <td>0.0221</td>
      <td>0.0285</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>-0.0097</td>
      <td>-0.0121</td>
      <td>-0.0223</td>
      <td>-0.0053</td>
      <td>0.0296</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>0.0080</td>
      <td>0.0149</td>
      <td>-0.0054</td>
      <td>0.0188</td>
      <td>0.0193</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>-0.0047</td>
      <td>0.0021</td>
      <td>0.0098</td>
      <td>0.0022</td>
      <td>0.0388</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>0.0161</td>
      <td>-0.0078</td>
      <td>0.0000</td>
      <td>0.0101</td>
      <td>0.0492</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff-all">
<h5>Download all available data for the Fama and French daily benchmark factors to dictionary <code class="docutils literal notranslate"><span class="pre">ff_all</span></code><a class="headerlink" href="#download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff-all" title="Permalink to this heading">#</a></h5>
<p>I often use the following code snippet to find the exact name for the the daily benchmark factors file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdr</span><span class="o">.</span><span class="n">famafrench</span><span class="o">.</span><span class="n">get_available_datasets</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors&#39;,
 &#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;]
</pre></div>
</div>
</div>
</div>
<p>Then I copy-and-paste that file name into <code class="docutils literal notranslate"><span class="pre">pdr.DataReader()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_all</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff">
<h5>Slice the daily benchmark factors, convert them to decimal returns, and assign to <code class="docutils literal notranslate"><span class="pre">ff</span></code><a class="headerlink" href="#slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="n">ff_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">ff</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07-01</th>
      <td>0.0010</td>
      <td>-0.0025</td>
      <td>-0.0027</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-02</th>
      <td>0.0045</td>
      <td>-0.0033</td>
      <td>-0.0006</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-06</th>
      <td>0.0017</td>
      <td>0.0030</td>
      <td>-0.0039</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-07</th>
      <td>0.0009</td>
      <td>-0.0058</td>
      <td>0.0002</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-08</th>
      <td>0.0021</td>
      <td>-0.0038</td>
      <td>0.0019</td>
      <td>0.0001</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="use-the-cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use the <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> method to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-the-cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumprod_solution</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">cumprod_solution</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cumulative Returns from </span><span class="si">{</span><span class="n">cumprod_solution</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">cumprod_solution</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8e5367d3e3e786a97bee08ca5e1fe6a6e208ae2f5e6e0813e814f2c2cb9f0bab.png" src="_images/8e5367d3e3e786a97bee08ca5e1fe6a6e208ae2f5e6e0813e814f2c2cb9f0bab.png" />
</div>
</div>
</section>
<section id="use-the-cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use the <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> method with log returns to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-the-cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumsum_solution</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">cumsum_solution</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cumulative Returns from </span><span class="si">{</span><span class="n">cumsum_solution</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">cumsum_solution</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8e5367d3e3e786a97bee08ca5e1fe6a6e208ae2f5e6e0813e814f2c2cb9f0bab.png" src="_images/8e5367d3e3e786a97bee08ca5e1fe6a6e208ae2f5e6e0813e814f2c2cb9f0bab.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> and  <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> solutions are the same!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cumprod_solution</span><span class="p">,</span> <span class="n">cumsum_solution</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>In this case, the <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> solution is faster than the <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> solution, but summing log returns is typically faster than compounding simple returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> returns_2020s.add(1).cumprod().sub(1)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>96.3 µs ± 719 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> returns_2020s.add(1).pipe(np.log).cumsum().pipe(np.exp).sub(1)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>168 µs ± 3.64 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use price data only to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>We can also calculate cumulative returns as the ratio of adjusted closed.
That is $R_{0,T} = \frac{AC_T}{AC_0} - 1$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adjclose_2019_last</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2019&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">adjclose_2019_last</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL    71.9206
AMZN    92.3920
F        8.8114
META   205.2500
TSLA    27.8887
Name: 2019-12-31 00:00:00, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adjclose_2020s</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:]</span>
<span class="n">adjclose_2020s</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>73.5615</td>
      <td>94.9005</td>
      <td>8.9251</td>
      <td>209.7800</td>
      <td>28.6840</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>72.8464</td>
      <td>93.7485</td>
      <td>8.7261</td>
      <td>208.6700</td>
      <td>29.5340</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>73.4268</td>
      <td>95.1440</td>
      <td>8.6788</td>
      <td>212.6000</td>
      <td>30.1027</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>73.0815</td>
      <td>95.3430</td>
      <td>8.7640</td>
      <td>213.0600</td>
      <td>31.2707</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>74.2571</td>
      <td>94.5985</td>
      <td>8.7640</td>
      <td>215.2200</td>
      <td>32.8093</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adjclose_solution</span> <span class="o">=</span> <span class="n">adjclose_2020s</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">adjclose_2019_last</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">adjclose_solution</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cumulative Returns from </span><span class="si">{</span><span class="n">cumsum_solution</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">cumsum_solution</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8e5367d3e3e786a97bee08ca5e1fe6a6e208ae2f5e6e0813e814f2c2cb9f0bab.png" src="_images/8e5367d3e3e786a97bee08ca5e1fe6a6e208ae2f5e6e0813e814f2c2cb9f0bab.png" />
</div>
</div>
<p>This solution is the same as the previous two!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cumprod_solution</span><span class="p">,</span> <span class="n">adjclose_solution</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>What should we make of these three options?</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> solution is the most intutive, and I use it most often</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> solution is typically faster than the <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> solution, and I use it when I need to calcualate millions of returns</p></li>
<li><p>The ratio of adjusted closes helps build understanding</p></li>
</ol>
</section>
<section id="calculate-the-sharpe-ratio-for-tsla">
<h5>Calculate the Sharpe Ratio for TSLA<a class="headerlink" href="#calculate-the-sharpe-ratio-for-tsla" title="Permalink to this heading">#</a></h5>
<p>Calculate the Sharpe Ratio with all available returns and 2020s returns.
Recall the Sharpe Ratio is $\frac{\overline{R_i - R_f}}{\sigma_i}$, where $\sigma_i$ is the volatility of <em>excess</em> returns.</p>
<p><em><strong>I suggest you write a function named <code class="docutils literal notranslate"><span class="pre">sharpe()</span></code> to use for the rest of this notebook.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpe</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0386986513828833
</pre></div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> method to chain the previous calculation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0386986513828833
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-beta-for-tsla">
<h5>Calculate the market beta for TSLA<a class="headerlink" href="#calculate-the-market-beta-for-tsla" title="Permalink to this heading">#</a></h5>
<p>Calculate the market beta with all available returns and 2020s returns.
Recall we estimate market beta with the ordinary least squares (OLS) regression $R_i-R_f = \alpha + \beta (R_m-R_f) + \epsilon$.
We can estimate market beta with the covariance formula (i.e., $\beta_i = \frac{Cov(R_i - R_f, R_m - R_f)}{Var(R_m-R_f)}$) for a univariate regression if we do not need goodness of fit statistics.</p>
<p><em><strong>I suggest you write a function named <code class="docutils literal notranslate"><span class="pre">beta()</span></code> to use for the rest of this notebook.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">rm_rf</span> <span class="o">=</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="c1"># use same peiod for stock and market</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.519561127968873
</pre></div>
</div>
</div>
</div>
<p>Again, we can <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> this calculation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.519561127968873
</pre></div>
</div>
</div>
</div>
</section>
<section id="guess-the-sharpe-ratios-for-these-stocks-in-the-2020s">
<h5>Guess the Sharpe Ratios for these stocks in the 2020s<a class="headerlink" href="#guess-the-sharpe-ratios-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="guess-the-market-betas-for-these-stocks-in-the-2020s">
<h5>Guess the market betas for these stocks in the 2020s<a class="headerlink" href="#guess-the-market-betas-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s">
<h5>Calculate the Sharpe Ratios for these stocks in the 2020s<a class="headerlink" href="#calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns_2020s</span><span class="p">:</span>
    <span class="n">sharpe_i</span> <span class="o">=</span> <span class="n">sharpe</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sharpe Ratio for </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">:</span><span class="se">\t</span><span class="s1"> </span><span class="si">{</span><span class="n">sharpe_i</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sharpe Ratio for AAPL:	 0.70
Sharpe Ratio for AMZN:	 0.10
Sharpe Ratio for F:	 0.42
Sharpe Ratio for META:	 -0.13
Sharpe Ratio for TSLA:	 1.04
</pre></div>
</div>
</div>
</div>
<p>We can also use pandas notation to vectorize this calculation.
First calculate <em>excess</em> returns as $R_i - R_f$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s_excess</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>0.0228</td>
      <td>0.0271</td>
      <td>0.0128</td>
      <td>0.0220</td>
      <td>0.0285</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>-0.0098</td>
      <td>-0.0122</td>
      <td>-0.0224</td>
      <td>-0.0054</td>
      <td>0.0296</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>0.0079</td>
      <td>0.0148</td>
      <td>-0.0055</td>
      <td>0.0188</td>
      <td>0.0192</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>-0.0048</td>
      <td>0.0020</td>
      <td>0.0098</td>
      <td>0.0021</td>
      <td>0.0387</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>0.0160</td>
      <td>-0.0079</td>
      <td>-0.0001</td>
      <td>0.0101</td>
      <td>0.0491</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Then use pandas notation to calculate means, standard deviations, and annualize.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL    0.7019
AMZN    0.0985
F       0.4199
META   -0.1257
TSLA    1.0387
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>Note:</strong></em>
In a few weeks we will learn the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method, which avoids the loop syntax.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL    0.7019
AMZN    0.0985
F       0.4199
META   -0.1257
TSLA    1.0387
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-betas-for-these-stocks-in-the-2020s">
<h5>Calculate the market betas for these stocks in the 2020s<a class="headerlink" href="#calculate-the-market-betas-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>We can loop over <code class="docutils literal notranslate"><span class="pre">returns_2020s</span></code>, but a loop solution is tedious.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns_2020s</span><span class="p">:</span>
    <span class="n">beta_i</span> <span class="o">=</span> <span class="n">beta</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beta for </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">:</span><span class="se">\t</span><span class="s1"> </span><span class="si">{</span><span class="n">beta_i</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Beta for AAPL:	 1.16
Beta for AMZN:	 1.00
Beta for F:	 1.21
Beta for META:	 1.23
Beta for TSLA:	 1.52
</pre></div>
</div>
</div>
</div>
<p>Or we can follow out approach above to vectorize this calculation.
First, we need to add a market excess return column to <code class="docutils literal notranslate"><span class="pre">returns_2020s_excess</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s_excess</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span>
<span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>Mkt-RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>0.0228</td>
      <td>0.0271</td>
      <td>0.0128</td>
      <td>0.0220</td>
      <td>0.0285</td>
      <td>0.0086</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>-0.0098</td>
      <td>-0.0122</td>
      <td>-0.0224</td>
      <td>-0.0054</td>
      <td>0.0296</td>
      <td>-0.0067</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>0.0079</td>
      <td>0.0148</td>
      <td>-0.0055</td>
      <td>0.0188</td>
      <td>0.0192</td>
      <td>0.0036</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>-0.0048</td>
      <td>0.0020</td>
      <td>0.0098</td>
      <td>0.0021</td>
      <td>0.0387</td>
      <td>-0.0019</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>0.0160</td>
      <td>-0.0079</td>
      <td>-0.0001</td>
      <td>0.0101</td>
      <td>0.0491</td>
      <td>0.0047</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vcv</span> <span class="o">=</span> <span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">vcv</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>Mkt-RF</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AAPL</th>
      <td>0.0005</td>
      <td>0.0004</td>
      <td>0.0003</td>
      <td>0.0004</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>AMZN</th>
      <td>0.0004</td>
      <td>0.0006</td>
      <td>0.0002</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>F</th>
      <td>0.0003</td>
      <td>0.0002</td>
      <td>0.0010</td>
      <td>0.0003</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>META</th>
      <td>0.0004</td>
      <td>0.0005</td>
      <td>0.0003</td>
      <td>0.0009</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>TSLA</th>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0021</td>
      <td>0.0004</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vcv</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">vcv</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span> <span class="s1">&#39;Mkt-RF&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;CAPM Beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;CAPM Betas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d524bdf4c2e8921865b8c16e8a2eeb26f16879dafc5aed2f7dd843d939fe75b6.png" src="_images/d524bdf4c2e8921865b8c16e8a2eeb26f16879dafc5aed2f7dd843d939fe75b6.png" />
</div>
</div>
<p><em><strong>Note:</strong></em>
In a few weeks we will learn the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method, which avoids the loop syntax.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL   1.1649
AMZN   1.0038
F      1.2078
META   1.2337
TSLA   1.5196
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s">
<h5>Calculate the Sharpe Ratio for an <em>equally weighted</em> portfolio of these stocks in the 2020s<a class="headerlink" href="#calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.6439557860929555
</pre></div>
</div>
</div>
</div>
<p>The Sharpe Ratio of the portfolio increases because diversification decreases the denominator (risk) more than the numerator (return)!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4267
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>During another class someone asked about the portfolio variance notation from investments class (i.e., $w^T \Sigma w$).
We typically will not use this formula because we can calculate the portfolio return series with <code class="docutils literal notranslate"><span class="pre">returns.dot(weights)</span></code>, then calculate the variance with <code class="docutils literal notranslate"><span class="pre">.var()</span></code>.
Here is a comparison.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">/</span> <span class="n">_</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">returns_2020s</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="c1"># from investments class</span>
    <span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="c1"># from this class</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s">
<h5>Calculate the market beta for an <em>equally weighted</em> portfolio of these stocks in the 2020s<a class="headerlink" href="#calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2259363845829498
</pre></div>
</div>
</div>
</div>
<p>The portfolio beta is the mean of the portfolio stock betas!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2259
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year">
<h5>Calculate the market betas for these stocks every calendar year for every possible year<a class="headerlink" href="#calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year" title="Permalink to this heading">#</a></h5>
<p>Save these market betas to data frame <code class="docutils literal notranslate"><span class="pre">betas</span></code>.
Our current Python knowledge limits us to a for-loop, but we will learn easier and faster approaches soon!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">betas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1973</span><span class="p">,</span> <span class="mi">2023</span><span class="p">))</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
    <span class="n">betas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
    
<span class="n">betas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">years</span><span class="p">)</span>
<span class="n">betas</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Ticker&#39;</span>
<span class="n">betas</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Year&#39;</span>
<span class="n">betas</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Year</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.2621</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1974</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.9625</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1975</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0576</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1976</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.3623</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1977</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.2652</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="plot-the-time-series-of-market-betas">
<h5>Plot the time series of market betas<a class="headerlink" href="#plot-the-time-series-of-market-betas" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">betas</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;CAPM Beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;CAPM Betas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f10a88212df6afe65bd859d405c330119b61cd550bc531334c3e22c41cd0b2bb.png" src="_images/f10a88212df6afe65bd859d405c330119b61cd550bc531334c3e22c41cd0b2bb.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-herron_01_practice_04"></span><section id="herron-topic-1-practice-section-4-wednesday-11-45-am">
<h3>Herron Topic 1 - Practice (Section 4, Wednesday 11:45 AM)<a class="headerlink" href="#herron-topic-1-practice-section-4-wednesday-11-45-am" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 2 - mean was $\approx 90%$</p></li>
<li><p>Quiz 3 - due by 11:59 on Friday, 2/10</p></li>
<li><p>Project groups open on Canvas under People - please sign up!</p></li>
<li><p>Optional, anonymous survey on Canvas under “Quizzes” - I value your feedback</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<p>On Discovery, we need to install the following pacakges every time we log in:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %pip install yfinance pandas-datareader requests-cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">(</span><span class="n">expire_after</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-histories">
<h5>Download all available daily price data for tickers TSLA, F, AAPL, AMZN, and META to data frame <code class="docutils literal notranslate"><span class="pre">histories</span></code><a class="headerlink" href="#download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-histories" title="Permalink to this heading">#</a></h5>
<p>Remove time zone information from the index and use <code class="docutils literal notranslate"><span class="pre">histories.columns.names</span></code> to label the variables and tickers as <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">Ticker</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="s1">&#39;TSLA F AAPL AMZN META&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">histories</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">histories</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">histories</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">histories</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]</span>
<span class="n">histories</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  5 of 5 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="5" halign="left">Adj Close</th>
      <th colspan="5" halign="left">Close</th>
      <th>...</th>
      <th colspan="5" halign="left">Stock Splits</th>
      <th colspan="5" halign="left">Volume</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>...</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1972-06-01</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2673</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1532</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1091238</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2668</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1174468</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2668</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5209582</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2638</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1248</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1424158</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2623</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1127</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>675088</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 40 columns</p>
</div></div></div>
</div>
<p>Here is another way to get the same data.
However, it less flexible because it does create a <code class="docutils literal notranslate"><span class="pre">Tickers</span></code> object that we can use to get other data (e.g., earnings per share).
I use <code class="docutils literal notranslate"><span class="pre">_</span></code> as a temporary vaiable for data that I will not need elsewhere in the notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;TSLA F AAPL AMZN META&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">_</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  5 of 5 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="5" halign="left">Adj Close</th>
      <th colspan="5" halign="left">Close</th>
      <th>...</th>
      <th colspan="5" halign="left">Open</th>
      <th colspan="5" halign="left">Volume</th>
    </tr>
    <tr>
      <th></th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>...</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1972-06-01 00:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2673</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1532</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1091238</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-02 00:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2668</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1532</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1174468</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-05 00:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2668</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5209582</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-06 00:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2638</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1248</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1424158</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-07 00:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2623</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1127</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1248</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>675088</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 30 columns</p>
</div></div></div>
</div>
</section>
<section id="calculate-all-available-daily-returns-and-save-to-data-frame-returns">
<h5>Calculate all available daily returns and save to data frame <code class="docutils literal notranslate"><span class="pre">returns</span></code><a class="headerlink" href="#calculate-all-available-daily-returns-and-save-to-data-frame-returns" title="Permalink to this heading">#</a></h5>
<p><em><strong>The following code assumes data are chronologically ordered!</strong></em>
The yfinance package returns sorted data, and we can use <code class="docutils literal notranslate"><span class="pre">.sort_index()</span></code> to sort our data, if necessary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">returns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1972-06-01</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0019</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0113</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0057</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="slices-returns-for-the-2020s-and-assign-to-returns-2020s">
<h5>Slices returns for the 2020s and assign to <code class="docutils literal notranslate"><span class="pre">returns_2020s</span></code><a class="headerlink" href="#slices-returns-for-the-2020s-and-assign-to-returns-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:]</span>
<span class="n">returns_2020s</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>0.0228</td>
      <td>0.0272</td>
      <td>0.0129</td>
      <td>0.0221</td>
      <td>0.0285</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>-0.0097</td>
      <td>-0.0121</td>
      <td>-0.0223</td>
      <td>-0.0053</td>
      <td>0.0296</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>0.0080</td>
      <td>0.0149</td>
      <td>-0.0054</td>
      <td>0.0188</td>
      <td>0.0193</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>-0.0047</td>
      <td>0.0021</td>
      <td>0.0098</td>
      <td>0.0022</td>
      <td>0.0388</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>0.0161</td>
      <td>-0.0078</td>
      <td>0.0000</td>
      <td>0.0101</td>
      <td>0.0492</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff-all">
<h5>Download all available data for the Fama and French daily benchmark factors to dictionary <code class="docutils literal notranslate"><span class="pre">ff_all</span></code><a class="headerlink" href="#download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff-all" title="Permalink to this heading">#</a></h5>
<p>I often use the following code snippet to find the exact name for the the daily benchmark factors file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdr</span><span class="o">.</span><span class="n">famafrench</span><span class="o">.</span><span class="n">get_available_datasets</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors&#39;,
 &#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;]
</pre></div>
</div>
</div>
</div>
<p>Then I copy-and-paste that file name into <code class="docutils literal notranslate"><span class="pre">pdr.DataReader()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_all</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff">
<h5>Slice the daily benchmark factors, convert them to decimal returns, and assign to <code class="docutils literal notranslate"><span class="pre">ff</span></code><a class="headerlink" href="#slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="n">ff_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ff</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07-01</th>
      <td>0.0010</td>
      <td>-0.0025</td>
      <td>-0.0027</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-02</th>
      <td>0.0045</td>
      <td>-0.0033</td>
      <td>-0.0006</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-06</th>
      <td>0.0017</td>
      <td>0.0030</td>
      <td>-0.0039</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-07</th>
      <td>0.0009</td>
      <td>-0.0058</td>
      <td>0.0002</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-08</th>
      <td>0.0021</td>
      <td>-0.0038</td>
      <td>0.0019</td>
      <td>0.0001</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="use-the-cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use the <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> method to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-the-cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_cumprod</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">cumret_cumprod</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c9c037e87e5c050ed4c2d1704286c907447145d5369901eab03a2dcd840021e6.png" src="_images/c9c037e87e5c050ed4c2d1704286c907447145d5369901eab03a2dcd840021e6.png" />
</div>
</div>
</section>
<section id="use-the-cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use the <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> method with log returns to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-the-cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_cumsum</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">cumret_cumsum</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c9c037e87e5c050ed4c2d1704286c907447145d5369901eab03a2dcd840021e6.png" src="_images/c9c037e87e5c050ed4c2d1704286c907447145d5369901eab03a2dcd840021e6.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> and  <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> solutions are the same!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cumret_cumprod</span><span class="p">,</span> <span class="n">cumret_cumsum</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use price data only to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>We can also calculate cumulative returns as the ratio of adjusted closed.
That is $R_{0,T} = \frac{AC_T}{AC_0} - 1$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">histories</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2019&#39;</span><span class="p">,</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL    71.9206
AMZN    92.3920
F        8.8114
META   205.2500
TSLA    27.8887
Name: 2019-12-31 00:00:00, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_prices</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span>
        <span class="n">histories</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2019&#39;</span><span class="p">,</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_prices</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c9c037e87e5c050ed4c2d1704286c907447145d5369901eab03a2dcd840021e6.png" src="_images/c9c037e87e5c050ed4c2d1704286c907447145d5369901eab03a2dcd840021e6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cumret_prices</span><span class="p">,</span> <span class="n">cumret_cumprod</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-sharpe-ratio-for-tsla">
<h5>Calculate the Sharpe Ratio for TSLA<a class="headerlink" href="#calculate-the-sharpe-ratio-for-tsla" title="Permalink to this heading">#</a></h5>
<p>Calculate the Sharpe Ratio with all available returns and 2020s returns.
Recall the Sharpe Ratio is $\frac{\overline{R_i - R_f}}{\sigma_i}$, where $\sigma_i$ is the volatility of <em>excess</em> returns.</p>
<p><em><strong>I suggest you write a function named <code class="docutils literal notranslate"><span class="pre">sharpe()</span></code> to use for the rest of this notebook.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ann_fac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ann_fac</span> <span class="o">*</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpe</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0386986513828833
</pre></div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> method to chain the previous calculation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0386986513828833
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-beta-for-tsla">
<h5>Calculate the market beta for TSLA<a class="headerlink" href="#calculate-the-market-beta-for-tsla" title="Permalink to this heading">#</a></h5>
<p>Calculate the market beta with all available returns and 2020s returns.
Recall we estimate market beta with the ordinary least squares (OLS) regression $R_i-R_f = \alpha + \beta (R_m-R_f) + \epsilon$.
We can estimate market beta with the covariance formula (i.e., $\beta_i = \frac{Cov(R_i - R_f, R_m - R_f)}{Var(R_m-R_f)}$) above for a univariate regression if we do not need goodness of fit statistics.</p>
<p><em><strong>I suggest you write a function named <code class="docutils literal notranslate"><span class="pre">beta()</span></code> to use for the rest of this notebook.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.519561127968873
</pre></div>
</div>
</div>
</div>
<p>Again, we can <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> this calculation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.519561127968873
</pre></div>
</div>
</div>
</div>
</section>
<section id="guess-the-sharpe-ratios-for-these-stocks-in-the-2020s">
<h5>Guess the Sharpe Ratios for these stocks in the 2020s<a class="headerlink" href="#guess-the-sharpe-ratios-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="guess-the-market-betas-for-these-stocks-in-the-2020s">
<h5>Guess the market betas for these stocks in the 2020s<a class="headerlink" href="#guess-the-market-betas-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s">
<h5>Calculate the Sharpe Ratios for these stocks in the 2020s<a class="headerlink" href="#calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns_2020s</span><span class="p">:</span>
    <span class="n">sharpe_i</span> <span class="o">=</span> <span class="n">sharpe</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sharpe Ratio for </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">:</span><span class="se">\t</span><span class="s1"> </span><span class="si">{</span><span class="n">sharpe_i</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sharpe Ratio for AAPL:	 0.70
Sharpe Ratio for AMZN:	 0.10
Sharpe Ratio for F:	 0.42
Sharpe Ratio for META:	 -0.13
Sharpe Ratio for TSLA:	 1.04
</pre></div>
</div>
</div>
</div>
<p>We can also use pandas notation to vectorize this calculation.
First calculate <em>excess</em> returns as $R_i - R_f$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s_excess</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>0.0228</td>
      <td>0.0271</td>
      <td>0.0128</td>
      <td>0.0220</td>
      <td>0.0285</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>-0.0098</td>
      <td>-0.0122</td>
      <td>-0.0224</td>
      <td>-0.0054</td>
      <td>0.0296</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>0.0079</td>
      <td>0.0148</td>
      <td>-0.0055</td>
      <td>0.0188</td>
      <td>0.0192</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>-0.0048</td>
      <td>0.0020</td>
      <td>0.0098</td>
      <td>0.0021</td>
      <td>0.0387</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>0.0160</td>
      <td>-0.0079</td>
      <td>-0.0001</td>
      <td>0.0101</td>
      <td>0.0491</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Then use pandas notation to calculate means, standard deviations, and annualize.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL    0.7019
AMZN    0.0985
F       0.4199
META   -0.1257
TSLA    1.0387
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>Note:</strong></em>
In a few weeks we will learn the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method, which avoids the loop syntax.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL    0.7019
AMZN    0.0985
F       0.4199
META   -0.1257
TSLA    1.0387
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-betas-for-these-stocks-in-the-2020s">
<h5>Calculate the market betas for these stocks in the 2020s<a class="headerlink" href="#calculate-the-market-betas-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>We can loop over <code class="docutils literal notranslate"><span class="pre">returns_2020s</span></code>, but a loop solution is tedious.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns_2020s</span><span class="p">:</span>
    <span class="n">beta_i</span> <span class="o">=</span> <span class="n">beta</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beta for </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">:</span><span class="se">\t</span><span class="s1"> </span><span class="si">{</span><span class="n">beta_i</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Beta for AAPL:	 1.16
Beta for AMZN:	 1.00
Beta for F:	 1.21
Beta for META:	 1.23
Beta for TSLA:	 1.52
</pre></div>
</div>
</div>
</div>
<p>Or we can follow out approach above to vectorize this calculation.
First, we need to add a market excess return column to <code class="docutils literal notranslate"><span class="pre">returns_2020s_excess</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s_excess</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span>
<span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>Mkt-RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>0.0228</td>
      <td>0.0271</td>
      <td>0.0128</td>
      <td>0.0220</td>
      <td>0.0285</td>
      <td>0.0086</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>-0.0098</td>
      <td>-0.0122</td>
      <td>-0.0224</td>
      <td>-0.0054</td>
      <td>0.0296</td>
      <td>-0.0067</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>0.0079</td>
      <td>0.0148</td>
      <td>-0.0055</td>
      <td>0.0188</td>
      <td>0.0192</td>
      <td>0.0036</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>-0.0048</td>
      <td>0.0020</td>
      <td>0.0098</td>
      <td>0.0021</td>
      <td>0.0387</td>
      <td>-0.0019</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>0.0160</td>
      <td>-0.0079</td>
      <td>-0.0001</td>
      <td>0.0101</td>
      <td>0.0491</td>
      <td>0.0047</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vcv</span> <span class="o">=</span> <span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">vcv</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>Mkt-RF</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AAPL</th>
      <td>0.0005</td>
      <td>0.0004</td>
      <td>0.0003</td>
      <td>0.0004</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>AMZN</th>
      <td>0.0004</td>
      <td>0.0006</td>
      <td>0.0002</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>F</th>
      <td>0.0003</td>
      <td>0.0002</td>
      <td>0.0010</td>
      <td>0.0003</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>META</th>
      <td>0.0004</td>
      <td>0.0005</td>
      <td>0.0003</td>
      <td>0.0009</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>TSLA</th>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0021</td>
      <td>0.0004</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vcv</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">vcv</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span> <span class="s1">&#39;Mkt-RF&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;CAPM Beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;CAPM Betas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d524bdf4c2e8921865b8c16e8a2eeb26f16879dafc5aed2f7dd843d939fe75b6.png" src="_images/d524bdf4c2e8921865b8c16e8a2eeb26f16879dafc5aed2f7dd843d939fe75b6.png" />
</div>
</div>
<p><em><strong>Note:</strong></em>
In a few weeks we will learn the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method, which avoids the loop syntax.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL   1.1649
AMZN   1.0038
F      1.2078
META   1.2337
TSLA   1.5196
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s">
<h5>Calculate the Sharpe Ratio for an <em>equally weighted</em> portfolio of these stocks in the 2020s<a class="headerlink" href="#calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.6439557637538056
</pre></div>
</div>
</div>
</div>
<p>Later, we will use the notation from investments class (i.e., $R_P = w^T \bf{R}$), but <code class="docutils literal notranslate"><span class="pre">.mean(axis=1)</span></code> is simpler for equally weighted returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">/</span> <span class="n">_</span>
<span class="n">weights</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.2, 0.2, 0.2, 0.2, 0.2])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>During class someone asked about the portfolio variance notation from investments class (i.e., $w^T \Sigma w$).
We typically will not use this formula because we can calculate the portfolio return series with <code class="docutils literal notranslate"><span class="pre">returns.dot(weights)</span></code>, then calculate the variance with <code class="docutils literal notranslate"><span class="pre">.var()</span></code>.
Here is a comparison.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">returns_2020s</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="c1"># from investments class</span>
    <span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="c1"># from this class</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>Because diversification reduces portfolio standard deviation less than the sum of its parts, the Sharpe Ratio of the equally weighted portfolio is less than the equally weighted mean of the single-stock Sharpe Ratios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4267
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s">
<h5>Calculate the market beta for an <em>equally weighted</em> portfolio of these stocks in the 2020s<a class="headerlink" href="#calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>Beta measures <em>non</em>diversifiable risk, so $\beta_P = \sum w_i \beta_i$!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2259364290960117
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2259
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year">
<h5>Calculate the market betas for these stocks every calendar year for every possible year<a class="headerlink" href="#calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year" title="Permalink to this heading">#</a></h5>
<p>Save these market betas to data frame <code class="docutils literal notranslate"><span class="pre">betas</span></code>.
Our current Python knowledge limits us to a for-loop, but we will learn easier and faster approaches soon!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">betas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1973</span><span class="p">,</span> <span class="mi">2023</span><span class="p">))</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
    <span class="n">betas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
    
<span class="n">betas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">years</span><span class="p">)</span>
<span class="n">betas</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Ticker&#39;</span>
<span class="n">betas</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Year&#39;</span>
<span class="n">betas</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Year</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.2621</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1974</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.9625</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1975</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0576</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1976</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.3623</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1977</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.2652</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="plot-the-time-series-of-market-betas">
<h5>Plot the time series of market betas<a class="headerlink" href="#plot-the-time-series-of-market-betas" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">betas</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;CAPM Beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;CAPM Betas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d94114b910b94e99ef2d660eac2fad2e98f74d666877f39a8d7ab07192471265.png" src="_images/d94114b910b94e99ef2d660eac2fad2e98f74d666877f39a8d7ab07192471265.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-herron_01_practice_02"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %pip install yfinance pandas-datareader requests-cache</span>
</pre></div>
</div>
</div>
</div>
<section id="herron-topic-1-practice-section-2-wednesday-2-45-pm">
<h3>Herron Topic 1 - Practice (Section 2, Wednesday 2:45 PM)<a class="headerlink" href="#herron-topic-1-practice-section-2-wednesday-2-45-pm" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 2 - mean was $\approx 90%$</p></li>
<li><p>Quiz 3 - due by 11:59 on Friday, 2/10</p></li>
<li><p>Project groups open on Canvas under People - please sign up!</p></li>
<li><p>Optional, anonymous survey on Canvas under “Quizzes” - I value your feedback</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<p>On Discovery, we need to install the following pacakges every time we log in:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %pip install yfinance pandas-datareader requests-cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">(</span><span class="n">expire_after</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-histories">
<h5>Download all available daily price data for tickers TSLA, F, AAPL, AMZN, and META to data frame <code class="docutils literal notranslate"><span class="pre">histories</span></code><a class="headerlink" href="#download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-histories" title="Permalink to this heading">#</a></h5>
<p>Remove time zone information from the index and use <code class="docutils literal notranslate"><span class="pre">histories.columns.names</span></code> to label the variables and tickers as <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">Ticker</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;TSLA F AAPL AMZN META&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">histories</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">histories</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">histories</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">histories</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]</span>
<span class="n">histories</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  5 of 5 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="5" halign="left">Adj Close</th>
      <th colspan="5" halign="left">Close</th>
      <th>...</th>
      <th colspan="5" halign="left">Stock Splits</th>
      <th colspan="5" halign="left">Volume</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>...</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1972-06-01</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2673</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1532</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1091238</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2668</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1174468</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2668</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1492</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5209582</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2638</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1248</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1424158</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.2623</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.1127</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>675088</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 40 columns</p>
</div></div></div>
</div>
</section>
<section id="calculate-all-available-daily-returns-and-save-to-data-frame-returns">
<h5>Calculate all available daily returns and save to data frame <code class="docutils literal notranslate"><span class="pre">returns</span></code><a class="headerlink" href="#calculate-all-available-daily-returns-and-save-to-data-frame-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">returns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1972-06-01</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0019</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0113</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1972-06-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0057</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="slices-returns-for-the-2020s-and-assign-to-returns-2020s">
<h5>Slices returns for the 2020s and assign to <code class="docutils literal notranslate"><span class="pre">returns_2020s</span></code><a class="headerlink" href="#slices-returns-for-the-2020s-and-assign-to-returns-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:]</span>
<span class="n">returns_2020s</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>0.0228</td>
      <td>0.0272</td>
      <td>0.0129</td>
      <td>0.0221</td>
      <td>0.0285</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>-0.0097</td>
      <td>-0.0121</td>
      <td>-0.0223</td>
      <td>-0.0053</td>
      <td>0.0296</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>0.0080</td>
      <td>0.0149</td>
      <td>-0.0054</td>
      <td>0.0188</td>
      <td>0.0193</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>-0.0047</td>
      <td>0.0021</td>
      <td>0.0098</td>
      <td>0.0022</td>
      <td>0.0388</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>0.0161</td>
      <td>-0.0078</td>
      <td>0.0000</td>
      <td>0.0101</td>
      <td>0.0492</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff-all">
<h5>Download all available data for the Fama and French daily benchmark factors to dictionary <code class="docutils literal notranslate"><span class="pre">ff_all</span></code><a class="headerlink" href="#download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff-all" title="Permalink to this heading">#</a></h5>
<p>I often use the following code snippet to find the exact name for the the daily benchmark factors file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdr</span><span class="o">.</span><span class="n">famafrench</span><span class="o">.</span><span class="n">get_available_datasets</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors&#39;,
 &#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;]
</pre></div>
</div>
</div>
</div>
<p>Then I copy-and-paste that file name into <code class="docutils literal notranslate"><span class="pre">pdr.DataReader()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_all</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff">
<h5>Slice the daily benchmark factors, convert them to decimal returns, and assign to <code class="docutils literal notranslate"><span class="pre">ff</span></code><a class="headerlink" href="#slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="n">ff_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ff</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07-01</th>
      <td>0.0010</td>
      <td>-0.0025</td>
      <td>-0.0027</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-02</th>
      <td>0.0045</td>
      <td>-0.0033</td>
      <td>-0.0006</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-06</th>
      <td>0.0017</td>
      <td>0.0030</td>
      <td>-0.0039</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-07</th>
      <td>0.0009</td>
      <td>-0.0058</td>
      <td>0.0002</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-08</th>
      <td>0.0021</td>
      <td>-0.0038</td>
      <td>0.0019</td>
      <td>0.0001</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="use-the-cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use the <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> method to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-the-cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_simple</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_simple</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a31f25ccc622788178cc4171eb517ac321ffbf3fb37cd0eaafdb85d13d771518.png" src="_images/a31f25ccc622788178cc4171eb517ac321ffbf3fb37cd0eaafdb85d13d771518.png" />
</div>
</div>
</section>
<section id="use-the-cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use the <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> method with log returns to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-the-cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_log</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns_2020s</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">)</span> <span class="c1"># creates log returns</span>
    <span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="c1"># compounds log returns by summing</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span> 
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># converts back to simple returns</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># converts from decimal to percent</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_log</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a31f25ccc622788178cc4171eb517ac321ffbf3fb37cd0eaafdb85d13d771518.png" src="_images/a31f25ccc622788178cc4171eb517ac321ffbf3fb37cd0eaafdb85d13d771518.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> and  <code class="docutils literal notranslate"><span class="pre">.cumsum()</span></code> solutions are the same!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cumret_log</span><span class="p">,</span> <span class="n">cumret_simple</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s">
<h5>Use price data only to plot cumulative returns for these stocks in the 2020s<a class="headerlink" href="#use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>We can also calculate cumulative returns as the ratio of adjusted closed.
That is $R_{0,T} = \frac{AC_T}{AC_0} - 1$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_prices</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">histories</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:,</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span>
        <span class="n">histories</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2019&#39;</span><span class="p">,</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumret_prices</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a31f25ccc622788178cc4171eb517ac321ffbf3fb37cd0eaafdb85d13d771518.png" src="_images/a31f25ccc622788178cc4171eb517ac321ffbf3fb37cd0eaafdb85d13d771518.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cumret_prices</span><span class="p">,</span> <span class="n">cumret_simple</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-sharpe-ratio-for-tsla">
<h5>Calculate the Sharpe Ratio for TSLA<a class="headerlink" href="#calculate-the-sharpe-ratio-for-tsla" title="Permalink to this heading">#</a></h5>
<p>Calculate the Sharpe Ratio with all available returns and 2020s returns.
Recall the Sharpe Ratio is $\frac{\overline{R_i - R_f}}{\sigma_i}$, where $\sigma_i$ is the volatility of <em>excess</em> returns.</p>
<p><em><strong>I suggest you write a function named <code class="docutils literal notranslate"><span class="pre">sharpe()</span></code> to use for the rest of this notebook.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ann_fac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ann_fac</span> <span class="o">*</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpe</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0386986513828833
</pre></div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> method to chain the previous calculation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0386986513828833
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-beta-for-tsla">
<h5>Calculate the market beta for TSLA<a class="headerlink" href="#calculate-the-market-beta-for-tsla" title="Permalink to this heading">#</a></h5>
<p>Calculate the market beta with all available returns and 2020s returns.
Recall we estimate market beta with the ordinary least squares (OLS) regression $R_i-R_f = \alpha + \beta (R_m-R_f) + \epsilon$.
We can estimate market beta with the covariance formula (i.e., $\beta_i = \frac{Cov(R_i-R_f, R_m-R_f)}{Var(R_m-R_f)}$) for a univariate regression if we do not need goodness of fit statistics.</p>
<p><em><strong>I suggest you write a function named <code class="docutils literal notranslate"><span class="pre">beta()</span></code> to use for the rest of this notebook.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta</span><span class="p">(</span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.519561127968873
</pre></div>
</div>
</div>
</div>
<p>Again, we can <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> this calculation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="p">[</span><span class="s1">&#39;TSLA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.519561127968873
</pre></div>
</div>
</div>
</div>
</section>
<section id="guess-the-sharpe-ratios-for-these-stocks-in-the-2020s">
<h5>Guess the Sharpe Ratios for these stocks in the 2020s<a class="headerlink" href="#guess-the-sharpe-ratios-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="guess-the-market-betas-for-these-stocks-in-the-2020s">
<h5>Guess the market betas for these stocks in the 2020s<a class="headerlink" href="#guess-the-market-betas-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
</section>
<section id="calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s">
<h5>Calculate the Sharpe Ratios for these stocks in the 2020s<a class="headerlink" href="#calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns_2020s</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sharpe Ratio for </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="se">\t</span><span class="si">{</span><span class="n">returns_2020s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sharpe Ratio for AAPL: 	0.7019
Sharpe Ratio for AMZN: 	0.0985
Sharpe Ratio for F: 	0.4199
Sharpe Ratio for META: 	-0.1257
Sharpe Ratio for TSLA: 	1.0387
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL    0.7019
AMZN    0.0985
F       0.4199
META   -0.1257
TSLA    1.0387
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We can also use pandas notation to vectorize this calculation.
First calculate <em>excess</em> returns as $R_i - R_f$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s_excess</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>0.0228</td>
      <td>0.0271</td>
      <td>0.0128</td>
      <td>0.0220</td>
      <td>0.0285</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>-0.0098</td>
      <td>-0.0122</td>
      <td>-0.0224</td>
      <td>-0.0054</td>
      <td>0.0296</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>0.0079</td>
      <td>0.0148</td>
      <td>-0.0055</td>
      <td>0.0188</td>
      <td>0.0192</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>-0.0048</td>
      <td>0.0020</td>
      <td>0.0098</td>
      <td>0.0021</td>
      <td>0.0387</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>0.0160</td>
      <td>-0.0079</td>
      <td>-0.0001</td>
      <td>0.0101</td>
      <td>0.0491</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Then use pandas notation to calculate means, standard deviations, and annualize.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL    0.7019
AMZN    0.0985
F       0.4199
META   -0.1257
TSLA    1.0387
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-betas-for-these-stocks-in-the-2020s">
<h5>Calculate the market betas for these stocks in the 2020s<a class="headerlink" href="#calculate-the-market-betas-for-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>We can loop over <code class="docutils literal notranslate"><span class="pre">returns_2020s</span></code>, but a loop solution is tedious.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns_2020s</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CAPM Beta for </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="se">\t</span><span class="si">{</span><span class="n">returns_2020s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CAPM Beta for AAPL: 	1.1649
CAPM Beta for AMZN: 	1.0038
CAPM Beta for F: 	1.2078
CAPM Beta for META: 	1.2337
CAPM Beta for TSLA: 	1.5196
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
AAPL   1.1649
AMZN   1.0038
F      1.2078
META   1.2337
TSLA   1.5196
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We can even calculate Sharpe Ratios and betas as the same time with the <code class="docutils literal notranslate"><span class="pre">.agg()</span></code> method.
More later in the course!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">beta</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sharpe</th>
      <td>0.7019</td>
      <td>0.0985</td>
      <td>0.4199</td>
      <td>-0.1257</td>
      <td>1.0387</td>
    </tr>
    <tr>
      <th>beta</th>
      <td>1.1649</td>
      <td>1.0038</td>
      <td>1.2078</td>
      <td>1.2337</td>
      <td>1.5196</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Or we can follow out approach above to vectorize this calculation.
First, we need to add a market excess return column to <code class="docutils literal notranslate"><span class="pre">returns_2020s_excess</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s_excess</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span>
<span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>Mkt-RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-02</th>
      <td>0.0228</td>
      <td>0.0271</td>
      <td>0.0128</td>
      <td>0.0220</td>
      <td>0.0285</td>
      <td>0.0086</td>
    </tr>
    <tr>
      <th>2020-01-03</th>
      <td>-0.0098</td>
      <td>-0.0122</td>
      <td>-0.0224</td>
      <td>-0.0054</td>
      <td>0.0296</td>
      <td>-0.0067</td>
    </tr>
    <tr>
      <th>2020-01-06</th>
      <td>0.0079</td>
      <td>0.0148</td>
      <td>-0.0055</td>
      <td>0.0188</td>
      <td>0.0192</td>
      <td>0.0036</td>
    </tr>
    <tr>
      <th>2020-01-07</th>
      <td>-0.0048</td>
      <td>0.0020</td>
      <td>0.0098</td>
      <td>0.0021</td>
      <td>0.0387</td>
      <td>-0.0019</td>
    </tr>
    <tr>
      <th>2020-01-08</th>
      <td>0.0160</td>
      <td>-0.0079</td>
      <td>-0.0001</td>
      <td>0.0101</td>
      <td>0.0491</td>
      <td>0.0047</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vcv</span> <span class="o">=</span> <span class="n">returns_2020s_excess</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">vcv</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
      <th>Mkt-RF</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AAPL</th>
      <td>0.0005</td>
      <td>0.0004</td>
      <td>0.0003</td>
      <td>0.0004</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>AMZN</th>
      <td>0.0004</td>
      <td>0.0006</td>
      <td>0.0002</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>F</th>
      <td>0.0003</td>
      <td>0.0002</td>
      <td>0.0010</td>
      <td>0.0003</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>META</th>
      <td>0.0004</td>
      <td>0.0005</td>
      <td>0.0003</td>
      <td>0.0009</td>
      <td>0.0005</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>TSLA</th>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0021</td>
      <td>0.0004</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vcv</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">vcv</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span> <span class="s1">&#39;Mkt-RF&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;CAPM Beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;CAPM Betas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d524bdf4c2e8921865b8c16e8a2eeb26f16879dafc5aed2f7dd843d939fe75b6.png" src="_images/d524bdf4c2e8921865b8c16e8a2eeb26f16879dafc5aed2f7dd843d939fe75b6.png" />
</div>
</div>
</section>
<section id="calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s">
<h5>Calculate the Sharpe Ratio for an <em>equally weighted</em> portfolio of these stocks in the 2020s<a class="headerlink" href="#calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.643955749303917
</pre></div>
</div>
</div>
</div>
<p>The Sharpe Ratio of the portfolio increases because diversification decreases the denominator (risk) more than the numerator (return)!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4267
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>During another class someone asked about the portfolio variance notation from investments class (i.e., $w^T \Sigma w$).
We typically will not use this formula because we can calculate the portfolio return series with <code class="docutils literal notranslate"><span class="pre">returns.dot(weights)</span></code>, then calculate the variance with <code class="docutils literal notranslate"><span class="pre">.var()</span></code>.
Here is a comparison.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">returns_2020s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">/</span> <span class="n">_</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">returns_2020s</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="c1"># from investments class</span>
    <span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="c1"># from this class</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s">
<h5>Calculate the market beta for an <em>equally weighted</em> portfolio of these stocks in the 2020s<a class="headerlink" href="#calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s" title="Permalink to this heading">#</a></h5>
<p>What do you notice?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2259364793423735
</pre></div>
</div>
</div>
</div>
<p>The portfolio beta is the mean of the portfolio stock betas!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2020s</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2259
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year">
<h5>Calculate the market betas for these stocks every calendar year for every possible year<a class="headerlink" href="#calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year" title="Permalink to this heading">#</a></h5>
<p>Save these market betas to data frame <code class="docutils literal notranslate"><span class="pre">betas</span></code>.
Our current Python knowledge limits us to a for-loop, but we will learn easier and faster approaches soon!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">betas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1973</span><span class="p">,</span> <span class="mi">2023</span><span class="p">))</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
    <span class="n">betas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
    
<span class="n">betas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">years</span><span class="p">)</span>
<span class="n">betas</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Ticker&#39;</span>
<span class="n">betas</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Year&#39;</span>
<span class="n">betas</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>F</th>
      <th>META</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Year</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.2621</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1974</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.9625</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1975</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0576</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1976</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.3623</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1977</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.2652</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="plot-the-time-series-of-market-betas">
<h5>Plot the time series of market betas<a class="headerlink" href="#plot-the-time-series-of-market-betas" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">betas</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;CAPM Beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;CAPM Betas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3b6edf1a2ac8f6a3754b09b614ccf28e78b921343dcac06b0f2dab9539896161.png" src="_images/3b6edf1a2ac8f6a3754b09b614ccf28e78b921343dcac06b0f2dab9539896161.png" />
</div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-mckinney_08_lecture"></span><section id="mckinney-chapter-8-data-wrangling-join-combine-and-reshape">
<h2>McKinney Chapter 8 - Data Wrangling: Join, Combine, and Reshape<a class="headerlink" href="#mckinney-chapter-8-data-wrangling-join-combine-and-reshape" title="Permalink to this heading">#</a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h3>
<p>Chapter 8 of Wes McKinney’s <a class="reference external" href="https://wesmckinney.com/book/"><em>Python for Data Analysis</em></a> introduces a few important pandas concepts:</p>
<ol class="arabic simple">
<li><p>Joining or merging is combining 2+ data frames on 1+ indexes or columns into 1 data frame</p></li>
<li><p>Reshaping is rearranging data frames so it has fewer columns and more rows (wide to long) or more columns and fewer rows (long to wide); we can also reshape a series to a data frame and vice versa</p></li>
</ol>
<p><em><strong>Note:</strong></em>
Indented block quotes are from McKinney unless otherwise indicated.
The section numbers here differ from McKinney because we will only discuss some topics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="hierarchical-indexing">
<h3>Hierarchical Indexing<a class="headerlink" href="#hierarchical-indexing" title="Permalink to this heading">#</a></h3>
<p>We need to learn about hierarchical indexing before we learn about combining and reshaping data.
A hierarchical index gives two or more index levels to an axis.
For example, we could index rows by ticker and date.
Or we could index columns by variable and ticker.
Hierarchical indexing helps us work with high-dimensional data in a low-dimensional form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a  1    0.4967
   2   -0.1383
   3    0.6477
b  1    1.5230
   3   -0.2342
c  1   -0.2341
   2    1.5792
d  2    0.7674
   3   -0.4695
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We can partially index this series to concisely subset data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1    1.5230
3   -0.2342
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b  1    1.5230
   3   -0.2342
c  1   -0.2341
   2    1.5792
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b  1    1.5230
   3   -0.2342
d  2    0.7674
   3   -0.4695
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We can subset on the index inner level, too.
Here the first <code class="docutils literal notranslate"><span class="pre">:</span></code> slices all values in the outer index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a   -0.1383
c    1.5792
d    0.7674
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">data</span></code> has a stacked format.
For each outer index level (the letters), we have multiple observations based on the inner index level (the numbers).
We can un-stack <code class="docutils literal notranslate"><span class="pre">data</span></code> to convert the inner index level to columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
    </tr>
    <tr>
      <th>b</th>
      <td>1.5230</td>
      <td>NaN</td>
      <td>-0.2342</td>
    </tr>
    <tr>
      <th>c</th>
      <td>-0.2341</td>
      <td>1.5792</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>d</th>
      <td>NaN</td>
      <td>0.7674</td>
      <td>-0.4695</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a  1    0.4967
   2   -0.1383
   3    0.6477
b  1    1.5230
   3   -0.2342
c  1   -0.2341
   2    1.5792
d  2    0.7674
   3   -0.4695
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We can create a data frame with hieracrhical indexes or multi-indexes on rows <em>and</em> columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Colorado&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Green&#39;</span><span class="p">,</span> <span class="s1">&#39;Red&#39;</span><span class="p">,</span> <span class="s1">&#39;Green&#39;</span><span class="p">]]</span>
<span class="p">)</span>
<span class="n">frame</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="2" halign="left">Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>Green</th>
      <th>Red</th>
      <th>Green</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>1</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can name these multi-indexes but names are not required.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">,</span> <span class="s1">&#39;key2&#39;</span><span class="p">]</span>
<span class="n">frame</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">]</span>
<span class="n">frame</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th colspan="2" halign="left">Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Red</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>1</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Recall that <code class="docutils literal notranslate"><span class="pre">df[val]</span></code> selects the <code class="docutils literal notranslate"><span class="pre">val</span></code> column.
Here <code class="docutils literal notranslate"><span class="pre">frame</span></code> has a multi-index for the columns, so <code class="docutils literal notranslate"><span class="pre">frame['Ohio']</span></code> selects all columns with Ohio as the outer index level.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="p">[</span><span class="s1">&#39;Ohio&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Red</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>1</th>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>1</th>
      <td>6</td>
      <td>7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can pass a tuple if we only want one column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="p">[[(</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Green&#39;</span><span class="p">)]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th>Ohio</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>1</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>1</th>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We have to do a more work to slice the inner level of the column index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;Green&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th>Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>1</th>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>1</th>
      <td>6</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">pd.IndexSlice[:,</span> <span class="pre">'Green']</span></code> an alternative to <code class="docutils literal notranslate"><span class="pre">(slice(None),</span> <span class="pre">'Green')</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[:,</span> <span class="s1">&#39;Green&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th>Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>1</th>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>1</th>
      <td>6</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="reordering-and-sorting-levels">
<h4>Reordering and Sorting Levels<a class="headerlink" href="#reordering-and-sorting-levels" title="Permalink to this heading">#</a></h4>
<p>We can swap index levels with the <code class="docutils literal notranslate"><span class="pre">.swaplevel()</span></code> method.
The default arguments are <code class="docutils literal notranslate"><span class="pre">i=-2</span></code> and <code class="docutils literal notranslate"><span class="pre">j=-1</span></code>, which swap the two innermost index levels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th colspan="2" halign="left">Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Red</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key2</th>
      <th>key1</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <th>a</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <th>a</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <th>b</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <th>b</th>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can use index <em>names</em>, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">,</span> <span class="s1">&#39;key2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th colspan="2" halign="left">Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Red</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key2</th>
      <th>key1</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <th>a</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <th>a</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <th>b</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <th>b</th>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can also sort on an index (or list of indexes).
After we swap levels, we may want to sort our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th colspan="2" halign="left">Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Red</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>1</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th colspan="2" halign="left">Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Red</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>b</th>
      <th>1</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>a</th>
      <th>2</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th>b</th>
      <th>2</th>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Again, we can give index <em>names</em>, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;key2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th colspan="2" halign="left">Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Red</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>b</th>
      <th>1</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>a</th>
      <th>2</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th>b</th>
      <th>2</th>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can sort by two or more index levels by passing a list of index levels or names.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th colspan="2" halign="left">Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Red</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>1</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can chain these methods, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>state</th>
      <th colspan="2" halign="left">Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th></th>
      <th>color</th>
      <th>Green</th>
      <th>Red</th>
      <th>Green</th>
    </tr>
    <tr>
      <th>key2</th>
      <th>key1</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">1</th>
      <th>a</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>b</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2</th>
      <th>a</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th>b</th>
      <td>9</td>
      <td>10</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="indexing-with-a-dataframe-s-columns">
<h4>Indexing with a DataFrame’s columns<a class="headerlink" href="#indexing-with-a-dataframe-s-columns" title="Permalink to this heading">#</a></h4>
<p>We can convert a column into an index and an index into a column with the <code class="docutils literal notranslate"><span class="pre">.set_index()</span></code> and <code class="docutils literal notranslate"><span class="pre">.reset_index()</span></code> methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> 
    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">],</span>
    <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="p">})</span>
<span class="n">frame</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>7</td>
      <td>one</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>6</td>
      <td>one</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>5</td>
      <td>one</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>4</td>
      <td>two</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>3</td>
      <td>two</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5</td>
      <td>2</td>
      <td>two</td>
      <td>2</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6</td>
      <td>1</td>
      <td>two</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.set_index()</span></code> method converts columns to indexes, and removes the columns from the data frame by default.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">])</span>
<span class="n">frame2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>a</th>
      <th>b</th>
    </tr>
    <tr>
      <th>c</th>
      <th>d</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">one</th>
      <th>0</th>
      <td>0</td>
      <td>7</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">two</th>
      <th>0</th>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.reset_index()</span></code> method removes the indexes, adds them as columns, and sets in integer index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>c</th>
      <th>d</th>
      <th>a</th>
      <th>b</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>one</td>
      <td>0</td>
      <td>0</td>
      <td>7</td>
    </tr>
    <tr>
      <th>1</th>
      <td>one</td>
      <td>1</td>
      <td>1</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>one</td>
      <td>2</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>two</td>
      <td>0</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>two</td>
      <td>1</td>
      <td>4</td>
      <td>3</td>
    </tr>
    <tr>
      <th>5</th>
      <td>two</td>
      <td>2</td>
      <td>5</td>
      <td>2</td>
    </tr>
    <tr>
      <th>6</th>
      <td>two</td>
      <td>3</td>
      <td>6</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="combining-and-merging-datasets">
<h3>Combining and Merging Datasets<a class="headerlink" href="#combining-and-merging-datasets" title="Permalink to this heading">#</a></h3>
<p>pandas provides several methods and functions to combine and merge data.
We can typically create the same output with any of these methods or functions, but one may be more efficient than the others.
If I want to combine data frames with similar indexes, I try the <code class="docutils literal notranslate"><span class="pre">.join()</span></code> method first.
The <code class="docutils literal notranslate"><span class="pre">.join()</span></code> also lets use can combine more than two data frames at once.
Otherwise, I try the <code class="docutils literal notranslate"><span class="pre">.merge()</span></code> method, which has a function <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code>, too.
The <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> function is more general than the <code class="docutils literal notranslate"><span class="pre">.join()</span></code> method, so we will start with <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code>.</p>
<p>The <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/merging.html#">pandas website</a> provides helpful visualizations.</p>
<section id="database-style-dataframe-joins">
<h4>Database-Style DataFrame Joins<a class="headerlink" href="#database-style-dataframe-joins" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>Merge or join operations combine datasets by linking rows using one or more keys. These operations are central to relational databases (e.g., SQL-based). The merge function in pandas is the main entry point for using these algorithms on your data.</p>
</div></blockquote>
<p>We will start with the <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> syntax, but pandas also has <code class="docutils literal notranslate"><span class="pre">.merge()</span></code> and <code class="docutils literal notranslate"><span class="pre">.join()</span></code> methods.
Learning these other syntaxes is easy once we understand the <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> syntax.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)})</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>a</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>c</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>a</td>
      <td>5</td>
    </tr>
    <tr>
      <th>6</th>
      <td>b</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>a</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>d</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b</td>
      <td>6</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>a</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>a</td>
      <td>5</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The default <code class="docutils literal notranslate"><span class="pre">how</span></code> is <code class="docutils literal notranslate"><span class="pre">how='inner'</span></code>, so <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> inner joins left and right data frames by default, keeping only rows that appear in both.
We can specify <code class="docutils literal notranslate"><span class="pre">how='outer'</span></code>, so <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> outer joins left and right data frames, keeping all rows that appear in either.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b</td>
      <td>6.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>a</td>
      <td>2.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>4.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>a</td>
      <td>5.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>c</td>
      <td>3.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>d</td>
      <td>NaN</td>
      <td>2.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>A left merge keeps only rows that appear in the left data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>a</td>
      <td>2</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>c</td>
      <td>3</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>4</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>a</td>
      <td>5</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>b</td>
      <td>6</td>
      <td>1.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>A rights merge keeps only rows that appear in the right data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>a</td>
      <td>2.0000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>a</td>
      <td>4.0000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>a</td>
      <td>5.0000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b</td>
      <td>0.0000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>b</td>
      <td>1.0000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>b</td>
      <td>6.0000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>d</td>
      <td>NaN</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>By default, <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> merges on all columns that appear in both data frames.</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">on</span></code> : label or list
Column or index level names to join on. These must be found in both
DataFrames. If <code class="docutils literal notranslate"><span class="pre">on</span></code> is None and not merging on indexes then this defaults
to the intersection of the columns in both DataFrames.</p>
</div></blockquote>
<p>Here <code class="docutils literal notranslate"><span class="pre">key</span></code> is the only common column between <code class="docutils literal notranslate"><span class="pre">df1</span></code> and <code class="docutils literal notranslate"><span class="pre">df2</span></code>.
We <em>should</em> specify <code class="docutils literal notranslate"><span class="pre">on</span></code> to avoid unexpected results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b</td>
      <td>6</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>a</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>a</td>
      <td>5</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We <em>must</em> specify <code class="docutils literal notranslate"><span class="pre">left_on</span></code> and <code class="docutils literal notranslate"><span class="pre">right_on</span></code> if our left and right data frames do not have a common column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;lkey&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)})</span>
<span class="n">df4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;rkey&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lkey</th>
      <th>data1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>a</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>c</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>a</td>
      <td>5</td>
    </tr>
    <tr>
      <th>6</th>
      <td>b</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rkey</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>a</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>d</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pd.merge(df3, df4) # this code fails/errors because there are not common columns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df3</span><span class="p">,</span> <span class="n">df4</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;lkey&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;rkey&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lkey</th>
      <th>data1</th>
      <th>rkey</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0</td>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b</td>
      <td>6</td>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>a</td>
      <td>2</td>
      <td>a</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>4</td>
      <td>a</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>a</td>
      <td>5</td>
      <td>a</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> dropped row <code class="docutils literal notranslate"><span class="pre">c</span></code> from <code class="docutils literal notranslate"><span class="pre">df3</span></code> and row <code class="docutils literal notranslate"><span class="pre">d</span></code> from <code class="docutils literal notranslate"><span class="pre">df4</span></code>.
Rows <code class="docutils literal notranslate"><span class="pre">c</span></code> and <code class="docutils literal notranslate"><span class="pre">d</span></code> dropped because <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> <em>inner</em> joins be default.
An inner join keeps the intersection of the left and right data frame keys.
Further, rows <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> from <code class="docutils literal notranslate"><span class="pre">df4</span></code> appear three times to match <code class="docutils literal notranslate"><span class="pre">df3</span></code>.
If we want to keep rows <code class="docutils literal notranslate"><span class="pre">c</span></code> and <code class="docutils literal notranslate"><span class="pre">d</span></code>, we can <em>outer</em> join <code class="docutils literal notranslate"><span class="pre">df3</span></code> and <code class="docutils literal notranslate"><span class="pre">df4</span></code> with <code class="docutils literal notranslate"><span class="pre">how='outer'</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b</td>
      <td>6.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>a</td>
      <td>2.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>4.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>a</td>
      <td>5.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>c</td>
      <td>3.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>d</td>
      <td>NaN</td>
      <td>2.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<blockquote>
<div><p>Many-to-many merges have well-defined, though not necessarily intuitive, behavior.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)})</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>a</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>c</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>b</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>a</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>a</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>d</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>b</td>
      <td>5</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>b</td>
      <td>5</td>
      <td>3</td>
    </tr>
    <tr>
      <th>6</th>
      <td>a</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>a</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>8</th>
      <td>a</td>
      <td>4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>a</td>
      <td>4</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<blockquote>
<div><p>Many-to-many joins form the Cartesian product of the rows. Since there were three <code class="docutils literal notranslate"><span class="pre">b</span></code> rows in the left DataFrame and two in the right one, there are six <code class="docutils literal notranslate"><span class="pre">b</span></code> rows in the result. The join method only affects the distinct key values appearing in the result.</p>
</div></blockquote>
<p>Be careful with many-to-many joins!
In finance, we do not expect many-to-many joins because we expect at least one of the data frames to have unique observations.
<em><strong>pandas will not warn us if we accidentally perform a many-to-many join instead of a one-to-one or many-to-one join.</strong></em></p>
<p>We can merge on more than one key.
For example, we may merge two data sets on ticker-date pairs or industry-date pairs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;key2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;lval&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]})</span>
<span class="n">right</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;key2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;rval&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key1</th>
      <th>key2</th>
      <th>lval</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>foo</td>
      <td>one</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>foo</td>
      <td>two</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>bar</td>
      <td>one</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">right</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key1</th>
      <th>key2</th>
      <th>rval</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>foo</td>
      <td>one</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>foo</td>
      <td>one</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>bar</td>
      <td>one</td>
      <td>6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>bar</td>
      <td>two</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">,</span> <span class="s1">&#39;key2&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key1</th>
      <th>key2</th>
      <th>lval</th>
      <th>rval</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>foo</td>
      <td>one</td>
      <td>1.0000</td>
      <td>4.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>foo</td>
      <td>one</td>
      <td>1.0000</td>
      <td>5.0000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>foo</td>
      <td>two</td>
      <td>2.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>bar</td>
      <td>one</td>
      <td>3.0000</td>
      <td>6.0000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>bar</td>
      <td>two</td>
      <td>NaN</td>
      <td>7.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>When column names overlap between the left and right data frames, <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> appends <code class="docutils literal notranslate"><span class="pre">_x</span></code> and <code class="docutils literal notranslate"><span class="pre">_y</span></code> to the left and right versions of the overlapping column names.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;key1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key1</th>
      <th>key2_x</th>
      <th>lval</th>
      <th>key2_y</th>
      <th>rval</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>foo</td>
      <td>one</td>
      <td>1</td>
      <td>one</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>foo</td>
      <td>one</td>
      <td>1</td>
      <td>one</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>foo</td>
      <td>two</td>
      <td>2</td>
      <td>one</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>foo</td>
      <td>two</td>
      <td>2</td>
      <td>one</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>bar</td>
      <td>one</td>
      <td>3</td>
      <td>one</td>
      <td>6</td>
    </tr>
    <tr>
      <th>5</th>
      <td>bar</td>
      <td>one</td>
      <td>3</td>
      <td>two</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>I typically specify suffixes to avoid later confusion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;key1&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_left&#39;</span><span class="p">,</span> <span class="s1">&#39;_right&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key1</th>
      <th>key2_left</th>
      <th>lval</th>
      <th>key2_right</th>
      <th>rval</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>foo</td>
      <td>one</td>
      <td>1</td>
      <td>one</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>foo</td>
      <td>one</td>
      <td>1</td>
      <td>one</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>foo</td>
      <td>two</td>
      <td>2</td>
      <td>one</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>foo</td>
      <td>two</td>
      <td>2</td>
      <td>one</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>bar</td>
      <td>one</td>
      <td>3</td>
      <td>one</td>
      <td>6</td>
    </tr>
    <tr>
      <th>5</th>
      <td>bar</td>
      <td>one</td>
      <td>3</td>
      <td>two</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>I read the <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> docstring whenever I am in doubt.
<em><strong>Table 8-2</strong></em> lists the most commonly used arguments for <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code>.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">left</span></code>: DataFrame to be merged on the left side.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">right</span></code>: DataFrame to be merged on the right side.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">how</span></code>: One of ‘inner’, ‘outer’, ‘left’, or ‘right’; defaults to ‘inner’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on</span></code>: Column names to join on. Must be found in both DataFrame objects. If not specified and no other join keys given will use the intersection of the column names in left and right as the join keys.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">left_on</span></code>: Columns in left DataFrame to use as join keys.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">right_on</span></code>: Analogous to left_on for left DataFrame.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">left_index</span></code>: Use row index in left as its join key (or keys, if a MultiIndex).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">right_index</span></code>: Analogous to left_index.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sort</span></code>: Sort merged data lexicographically by join keys; True by default (disable to get better performance in some cases on large datasets).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">suffixes</span></code>: Tuple of string values to append to column names in case of overlap; defaults to (‘_x’, ‘_y’) (e.g., if ‘data’ in both DataFrame objects, would appear as ‘data_x’ and ‘data_y’ in result).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">copy</span></code>: If False, avoid copying data into resulting data structure in some exceptional cases; by default always copies.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">indicator</span></code>: Adds a special column _merge that indicates the source of each row; values will be ‘left_only’, ‘right_only’, or ‘both’ based on the origin of the joined data in each row.</p></li>
</ul>
</div></blockquote>
</section>
<section id="merging-on-index">
<h4>Merging on Index<a class="headerlink" href="#merging-on-index" title="Permalink to this heading">#</a></h4>
<p>If we want to use <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> to join on row indexes, we can use the <code class="docutils literal notranslate"><span class="pre">left_index</span></code> and <code class="docutils literal notranslate"><span class="pre">right_index</span></code> arguments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)})</span>
<span class="n">right1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;group_val&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>a</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>a</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>a</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>b</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>c</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">right1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group_val</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>3.5000</td>
    </tr>
    <tr>
      <th>b</th>
      <td>7.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left1</span><span class="p">,</span> <span class="n">right1</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>value</th>
      <th>group_val</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>a</td>
      <td>0</td>
      <td>3.5000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>a</td>
      <td>2</td>
      <td>3.5000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>a</td>
      <td>3</td>
      <td>3.5000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b</td>
      <td>1</td>
      <td>7.0000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>b</td>
      <td>4</td>
      <td>7.0000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>c</td>
      <td>5</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The index arguments work for hierarchical indexes (multi indexes), too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lefth</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Nevada&#39;</span><span class="p">,</span> <span class="s1">&#39;Nevada&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;key2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">2002</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">2002</span><span class="p">],</span>
                      <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">5.</span><span class="p">)})</span>
<span class="n">righth</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                      <span class="n">index</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;Nevada&#39;</span><span class="p">,</span> <span class="s1">&#39;Nevada&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">],</span>
                             <span class="p">[</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">2002</span><span class="p">]],</span>
                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;event1&#39;</span><span class="p">,</span> <span class="s1">&#39;event2&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">lefth</span><span class="p">,</span> <span class="n">righth</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">,</span> <span class="s1">&#39;key2&#39;</span><span class="p">],</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key1</th>
      <th>key2</th>
      <th>data</th>
      <th>event1</th>
      <th>event2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Ohio</td>
      <td>2000</td>
      <td>0.0000</td>
      <td>4.0000</td>
      <td>5.0000</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Ohio</td>
      <td>2000</td>
      <td>0.0000</td>
      <td>6.0000</td>
      <td>7.0000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ohio</td>
      <td>2001</td>
      <td>1.0000</td>
      <td>8.0000</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Ohio</td>
      <td>2002</td>
      <td>2.0000</td>
      <td>10.0000</td>
      <td>11.0000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Nevada</td>
      <td>2001</td>
      <td>3.0000</td>
      <td>0.0000</td>
      <td>1.0000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Nevada</td>
      <td>2002</td>
      <td>4.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Nevada</td>
      <td>2000</td>
      <td>NaN</td>
      <td>2.0000</td>
      <td>3.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]],</span>
                     <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">],</span>
                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Nevada&#39;</span><span class="p">])</span>
<span class="n">right2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mf">7.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">],</span> <span class="p">[</span><span class="mf">9.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">],</span> <span class="p">[</span><span class="mf">11.</span><span class="p">,</span> <span class="mf">12.</span><span class="p">],</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">]],</span>
                      <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">],</span>
                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Missouri&#39;</span><span class="p">,</span> <span class="s1">&#39;Alabama&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>If we use both left and right indexes, <code class="docutils literal notranslate"><span class="pre">pd.merge()</span></code> will keep the index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left2</span><span class="p">,</span> <span class="n">right2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Ohio</th>
      <th>Nevada</th>
      <th>Missouri</th>
      <th>Alabama</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.0000</td>
      <td>2.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>b</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
    <tr>
      <th>c</th>
      <td>3.0000</td>
      <td>4.0000</td>
      <td>9.0000</td>
      <td>10.0000</td>
    </tr>
    <tr>
      <th>d</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>11.0000</td>
      <td>12.0000</td>
    </tr>
    <tr>
      <th>e</th>
      <td>5.0000</td>
      <td>6.0000</td>
      <td>13.0000</td>
      <td>14.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<blockquote>
<div><p>DataFrame has a convenient join instance for merging by index. It can also be used to combine together many DataFrame objects having the same or similar indexes but non-overlapping columns.</p>
</div></blockquote>
<p>If we have matching indexes on left and right, we can use <code class="docutils literal notranslate"><span class="pre">.join()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Ohio</th>
      <th>Nevada</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.0000</td>
      <td>2.0000</td>
    </tr>
    <tr>
      <th>c</th>
      <td>3.0000</td>
      <td>4.0000</td>
    </tr>
    <tr>
      <th>e</th>
      <td>5.0000</td>
      <td>6.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">right2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Missouri</th>
      <th>Alabama</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>b</th>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
    <tr>
      <th>c</th>
      <td>9.0000</td>
      <td>10.0000</td>
    </tr>
    <tr>
      <th>d</th>
      <td>11.0000</td>
      <td>12.0000</td>
    </tr>
    <tr>
      <th>e</th>
      <td>13.0000</td>
      <td>14.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left2</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Ohio</th>
      <th>Nevada</th>
      <th>Missouri</th>
      <th>Alabama</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.0000</td>
      <td>2.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>b</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
    <tr>
      <th>c</th>
      <td>3.0000</td>
      <td>4.0000</td>
      <td>9.0000</td>
      <td>10.0000</td>
    </tr>
    <tr>
      <th>d</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>11.0000</td>
      <td>12.0000</td>
    </tr>
    <tr>
      <th>e</th>
      <td>5.0000</td>
      <td>6.0000</td>
      <td>13.0000</td>
      <td>14.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.join()</span></code> method left joins by default.
The <code class="docutils literal notranslate"><span class="pre">.join()</span></code> method uses indexes, so it requires few arguments and accepts a list of data frames.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">another</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="mf">7.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">],</span> <span class="p">[</span><span class="mf">9.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">],</span> <span class="p">[</span><span class="mf">11.</span><span class="p">,</span> <span class="mf">12.</span><span class="p">],</span> <span class="p">[</span><span class="mf">16.</span><span class="p">,</span> <span class="mf">17.</span><span class="p">]],</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="s1">&#39;Oregon&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">another</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>New York</th>
      <th>Oregon</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
    <tr>
      <th>c</th>
      <td>9.0000</td>
      <td>10.0000</td>
    </tr>
    <tr>
      <th>e</th>
      <td>11.0000</td>
      <td>12.0000</td>
    </tr>
    <tr>
      <th>f</th>
      <td>16.0000</td>
      <td>17.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left2</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">right2</span><span class="p">,</span> <span class="n">another</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Ohio</th>
      <th>Nevada</th>
      <th>Missouri</th>
      <th>Alabama</th>
      <th>New York</th>
      <th>Oregon</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.0000</td>
      <td>2.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
    <tr>
      <th>c</th>
      <td>3.0000</td>
      <td>4.0000</td>
      <td>9.0000</td>
      <td>10.0000</td>
      <td>9.0000</td>
      <td>10.0000</td>
    </tr>
    <tr>
      <th>e</th>
      <td>5.0000</td>
      <td>6.0000</td>
      <td>13.0000</td>
      <td>14.0000</td>
      <td>11.0000</td>
      <td>12.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left2</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">right2</span><span class="p">,</span> <span class="n">another</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Ohio</th>
      <th>Nevada</th>
      <th>Missouri</th>
      <th>Alabama</th>
      <th>New York</th>
      <th>Oregon</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.0000</td>
      <td>2.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
    <tr>
      <th>c</th>
      <td>3.0000</td>
      <td>4.0000</td>
      <td>9.0000</td>
      <td>10.0000</td>
      <td>9.0000</td>
      <td>10.0000</td>
    </tr>
    <tr>
      <th>e</th>
      <td>5.0000</td>
      <td>6.0000</td>
      <td>13.0000</td>
      <td>14.0000</td>
      <td>11.0000</td>
      <td>12.0000</td>
    </tr>
    <tr>
      <th>b</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>d</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>11.0000</td>
      <td>12.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>f</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>16.0000</td>
      <td>17.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="concatenating-along-an-axis">
<h4>Concatenating Along an Axis<a class="headerlink" href="#concatenating-along-an-axis" title="Permalink to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code> function provides a flexible way to combine data frames and series along either axis.
I typically use <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code> to combine:</p>
<ol class="arabic simple">
<li><p>A list of data frames with similar layouts</p></li>
<li><p>A list of series because series do not have <code class="docutils literal notranslate"><span class="pre">.join()</span></code> or <code class="docutils literal notranslate"><span class="pre">.merge()</span></code> methods</p></li>
</ol>
<p>The first is handy if we have to read and combine a directory of .csv files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">])</span>
<span class="n">s3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a    0
b    1
c    2
d    3
e    4
f    5
g    6
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>b</th>
      <td>1.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>c</th>
      <td>NaN</td>
      <td>2.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>d</th>
      <td>NaN</td>
      <td>3.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>e</th>
      <td>NaN</td>
      <td>4.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>f</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>5.0000</td>
    </tr>
    <tr>
      <th>g</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">])</span>

<span class="n">result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>one    a    0
       b    1
two    c    2
       d    3
       e    4
three  f    5
       g    6
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
      <th>f</th>
      <th>g</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>0.0000</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>two</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.0000</td>
      <td>3.0000</td>
      <td>4.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>three</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5.0000</td>
      <td>6.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>b</th>
      <td>1.0000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>c</th>
      <td>NaN</td>
      <td>2.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>d</th>
      <td>NaN</td>
      <td>3.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>e</th>
      <td>NaN</td>
      <td>4.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>f</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>5.0000</td>
    </tr>
    <tr>
      <th>g</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">])</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;four&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;level1&#39;</span><span class="p">,</span> <span class="s1">&#39;level2&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left">level1</th>
      <th colspan="2" halign="left">level2</th>
    </tr>
    <tr>
      <th></th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0</td>
      <td>1</td>
      <td>5.0000</td>
      <td>6.0000</td>
    </tr>
    <tr>
      <th>b</th>
      <td>2</td>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>c</th>
      <td>4</td>
      <td>5</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;level1&#39;</span><span class="p">,</span> <span class="s1">&#39;level2&#39;</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>upper</th>
      <th colspan="2" halign="left">level1</th>
      <th colspan="2" halign="left">level2</th>
    </tr>
    <tr>
      <th>lower</th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
      <th>four</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0</td>
      <td>1</td>
      <td>5.0000</td>
      <td>6.0000</td>
    </tr>
    <tr>
      <th>b</th>
      <td>2</td>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>c</th>
      <td>4</td>
      <td>5</td>
      <td>7.0000</td>
      <td>8.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="reshaping-and-pivoting">
<h3>Reshaping and Pivoting<a class="headerlink" href="#reshaping-and-pivoting" title="Permalink to this heading">#</a></h3>
<p>Above, we briefly explore reshaping data with <code class="docutils literal notranslate"><span class="pre">.stack()</span></code> and <code class="docutils literal notranslate"><span class="pre">.unstack()</span></code>.
Here we explore reshaping data more deeply.</p>
<section id="reshaping-with-hierarchical-indexing">
<h4>Reshaping with Hierarchical Indexing<a class="headerlink" href="#reshaping-with-hierarchical-indexing" title="Permalink to this heading">#</a></h4>
<p>Hierarchical indexes (multi-indexes) help reshape data.</p>
<blockquote>
<div><p>There are two primary actions:</p>
<ul class="simple">
<li><p>stack: This “rotates” or pivots from the columns in the data to the rows</p></li>
<li><p>unstack: This pivots from the rows into the columns</p></li>
</ul>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;Colorado&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;state&#39;</span><span class="p">),</span>
                    <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">))</span>

<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>number</th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
    </tr>
    <tr>
      <th>state</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>

<span class="n">result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>state     number
Ohio      one       0
          two       1
          three     2
Colorado  one       3
          two       4
          three     5
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>number</th>
      <th>one</th>
      <th>two</th>
      <th>three</th>
    </tr>
    <tr>
      <th>state</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ohio</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>Colorado</th>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">])</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">])</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">])</span>

<span class="n">data2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>one  a    0
     b    1
     c    2
     d    3
two  c    4
     d    5
     e    6
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data2</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>0.0000</td>
      <td>1.0000</td>
      <td>2.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>two</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.0000</td>
      <td>5.0000</td>
      <td>6.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Un-stacking may introduce missing values because data frames are rectangular.</p>
<p>By default, stacking drops these missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data2</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>one  a   0.0000
     b   1.0000
     c   2.0000
     d   3.0000
two  c   4.0000
     d   5.0000
     e   6.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>However, we can keep missing values with <code class="docutils literal notranslate"><span class="pre">dropna=False</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data2</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>one  a   0.0000
     b   1.0000
     c   2.0000
     d   3.0000
     e      NaN
two  a      NaN
     b      NaN
     c   4.0000
     d   5.0000
     e   6.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span> 
    <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="n">result</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="p">},</span>
    <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;side&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>side</th>
      <th>left</th>
      <th>right</th>
    </tr>
    <tr>
      <th>state</th>
      <th>number</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">Ohio</th>
      <th>one</th>
      <td>0</td>
      <td>5</td>
    </tr>
    <tr>
      <th>two</th>
      <td>1</td>
      <td>6</td>
    </tr>
    <tr>
      <th>three</th>
      <td>2</td>
      <td>7</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Colorado</th>
      <th>one</th>
      <td>3</td>
      <td>8</td>
    </tr>
    <tr>
      <th>two</th>
      <td>4</td>
      <td>9</td>
    </tr>
    <tr>
      <th>three</th>
      <td>5</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>If we un-stack a data frame, the un-stacked level becomes the innermost level in the resulting index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>side</th>
      <th colspan="2" halign="left">left</th>
      <th colspan="2" halign="left">right</th>
    </tr>
    <tr>
      <th>state</th>
      <th>Ohio</th>
      <th>Colorado</th>
      <th>Ohio</th>
      <th>Colorado</th>
    </tr>
    <tr>
      <th>number</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>0</td>
      <td>3</td>
      <td>5</td>
      <td>8</td>
    </tr>
    <tr>
      <th>two</th>
      <td>1</td>
      <td>4</td>
      <td>6</td>
      <td>9</td>
    </tr>
    <tr>
      <th>three</th>
      <td>2</td>
      <td>5</td>
      <td>7</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can chain <code class="docutils literal notranslate"><span class="pre">.stack()</span></code> and <code class="docutils literal notranslate"><span class="pre">.unstack()</span></code> to rearrange our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;side&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>Colorado</th>
      <th>Ohio</th>
    </tr>
    <tr>
      <th>number</th>
      <th>side</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">one</th>
      <th>left</th>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>right</th>
      <td>8</td>
      <td>5</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">two</th>
      <th>left</th>
      <td>4</td>
      <td>1</td>
    </tr>
    <tr>
      <th>right</th>
      <td>9</td>
      <td>6</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">three</th>
      <th>left</th>
      <td>5</td>
      <td>2</td>
    </tr>
    <tr>
      <th>right</th>
      <td>10</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>McKinney provides two more subsections on reshaping data with the <code class="docutils literal notranslate"><span class="pre">.pivot()</span></code> and <code class="docutils literal notranslate"><span class="pre">.melt()</span></code> methods.
Unlike, the stacking methods, the pivoting methods can aggregate data and do not require an index.
We will skip these additional aggregation methods for now.</p>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-mckinney_08_practice"></span><section id="mckinney-chapter-8-practice-blank">
<h3>McKinney Chapter 8 - Practice (Blank)<a class="headerlink" href="#mckinney-chapter-8-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks">
<h5>Download data from Yahoo! Finance for BAC, C, GS, JPM, MS, and PNC and assign to data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>.<a class="headerlink" href="#download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks" title="Permalink to this heading">#</a></h5>
<p>Use <code class="docutils literal notranslate"><span class="pre">stocks.columns.names</span></code> to assign the names <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">Ticker</span></code> to the column multi index.</p>
</section>
<section id="reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks-long">
<h5>Reshape <code class="docutils literal notranslate"><span class="pre">stocks</span></code> from wide to long with dates and tickers as row indexes and assign to data frame <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks-long" title="Permalink to this heading">#</a></h5>
</section>
<section id="add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks-long">
<h5>Add daily returns for each stock to data frames <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks-long" title="Permalink to this heading">#</a></h5>
<p>Name the returns variable <code class="docutils literal notranslate"><span class="pre">Returns</span></code>, and maintain all multi indexes.
<em>Hint:</em> Use <code class="docutils literal notranslate"><span class="pre">pd.MultiIndex()</span></code> to create a multi index for the the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>.</p>
</section>
<section id="download-the-daily-benchmark-return-factors-from-ken-french-s-data-library">
<h5>Download the daily benchmark return factors from Ken French’s data library.<a class="headerlink" href="#download-the-daily-benchmark-return-factors-from-ken-french-s-data-library" title="Permalink to this heading">#</a></h5>
</section>
<section id="add-the-daily-benchmark-return-factors-to-stocks-and-stocks-long">
<h5>Add the daily benchmark return factors to <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#add-the-daily-benchmark-return-factors-to-stocks-and-stocks-long" title="Permalink to this heading">#</a></h5>
<p>For the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>, use the outer index name <code class="docutils literal notranslate"><span class="pre">Factors</span></code>.</p>
</section>
<section id="write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">download()</span></code> that accepts tickers and returns a wide data frame of returns with the daily benchmark return factors.<a class="headerlink" href="#write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors" title="Permalink to this heading">#</a></h5>
</section>
<section id="download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings">
<h5>Download earnings per share for the stocks in <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and combine to a long data frame <code class="docutils literal notranslate"><span class="pre">earnings</span></code>.<a class="headerlink" href="#download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings" title="Permalink to this heading">#</a></h5>
<p>Use the <code class="docutils literal notranslate"><span class="pre">.earnings_dates</span></code> method described <a class="reference external" href="https://pypi.org/project/yfinance/">here</a>.
Use <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code> to combine the result of each the <code class="docutils literal notranslate"><span class="pre">.earnings_date</span></code> data frames and assign them to a new data frame <code class="docutils literal notranslate"><span class="pre">earnings</span></code>.
Name the row indexes <code class="docutils literal notranslate"><span class="pre">Ticker</span></code> and <code class="docutils literal notranslate"><span class="pre">Date</span></code> and swap to match the order of the row index in <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># some students had to update yfinance to use the .earnings_dates atrtibute</span>
<span class="c1"># %pip install -U yfinance</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="combine-earnings-with-the-returns-from-stocks-long">
<h5>Combine <code class="docutils literal notranslate"><span class="pre">earnings</span></code> with the returns from <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#combine-earnings-with-the-returns-from-stocks-long" title="Permalink to this heading">#</a></h5>
<p><em><strong>It is easier to leave <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> as-is and work with slices <code class="docutils literal notranslate"><span class="pre">returns</span></code> and <code class="docutils literal notranslate"><span class="pre">returns_long</span></code>.</strong></em>
Use the <code class="docutils literal notranslate"><span class="pre">tz_localize('America/New_York')</span></code> method add time zone information back to <code class="docutils literal notranslate"><span class="pre">returns.index</span></code> and use <code class="docutils literal notranslate"><span class="pre">pd.to_timedelta(16,</span> <span class="pre">unit='h')</span></code> to set time to the market close in New York City.
Use <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_asof.html"><code class="docutils literal notranslate"><span class="pre">pd.merge_asof()</span></code></a> to match earnings announcement dates and times to appropriate return periods.
For example, if a firm announces earnings after the close at 5 PM on February 7, we want to match the return period from 4 PM on February 7 to 4 PM on February 8.</p>
</section>
<section id="plot-the-relation-between-daily-returns-and-earnings-surprises">
<h5>Plot the relation between daily returns and earnings surprises<a class="headerlink" href="#plot-the-relation-between-daily-returns-and-earnings-surprises" title="Permalink to this heading">#</a></h5>
<p>Three options in increasing difficulty:</p>
<ol class="arabic simple">
<li><p>Scatter plot</p></li>
<li><p>Scatter plot with a best-fit line using <code class="docutils literal notranslate"><span class="pre">regplot()</span></code> from the seaborn package</p></li>
<li><p>Bar plot using <code class="docutils literal notranslate"><span class="pre">barplot()</span></code> from the seaborn package after using <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> to form five groups on earnings surprises</p></li>
</ol>
</section>
<section id="repeat-the-earnings-exercise-with-the-s-p-100-stocks">
<h5>Repeat the earnings exercise with the S&amp;P 100 stocks<a class="headerlink" href="#repeat-the-earnings-exercise-with-the-s-p-100-stocks" title="Permalink to this heading">#</a></h5>
</section>
<section id="repeat-the-earnings-exercise-with-excess-returns-of-the-s-p-100-stocks">
<h5>Repeat the earnings exercise with <em>excess returns</em> of the S&amp;P 100 Stocks<a class="headerlink" href="#repeat-the-earnings-exercise-with-excess-returns-of-the-s-p-100-stocks" title="Permalink to this heading">#</a></h5>
<p>Excess returns are returns minus market returns.
We need to add a timezone and the closing time to the market return from Fama and French.</p>
</section>
<section id="improve-your-download-function-from-above">
<h5>Improve your <code class="docutils literal notranslate"><span class="pre">download()</span></code> function from above<a class="headerlink" href="#improve-your-download-function-from-above" title="Permalink to this heading">#</a></h5>
<p>Modify <code class="docutils literal notranslate"><span class="pre">download()</span></code> to accept one or more than one ticker.
Since we will not use the advanced functionality of the tickers object that <code class="docutils literal notranslate"><span class="pre">yf.Tickers()</span></code> creates, we will use <code class="docutils literal notranslate"><span class="pre">yf.download()</span></code>.
The current version of <code class="docutils literal notranslate"><span class="pre">yf.download()</span></code> does not accept a <code class="docutils literal notranslate"><span class="pre">session=</span></code> argument.</p>
</section>
</section>
</section>
<span id="document-mckinney_08_practice_03"></span><section id="mckinney-chapter-8-practice-monday-2-45-pm-section-3">
<h3>McKinney Chapter 8 - Practice (Monday 2:45 PM, Section 3)<a class="headerlink" href="#mckinney-chapter-8-practice-monday-2-45-pm-section-3" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ol class="arabic simple">
<li><p>Quiz 3 mean was $\approx 80%$</p></li>
<li><p>I posted project 1 to Canvas</p></li>
</ol>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks">
<h5>Download data from Yahoo! Finance for BAC, C, GS, JPM, MS, and PNC and assign to data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>.<a class="headerlink" href="#download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks" title="Permalink to this heading">#</a></h5>
<p>Use <code class="docutils literal notranslate"><span class="pre">stocks.columns.names</span></code> to assign the names <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">Ticker</span></code> to the column multi index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="s1">&#39;BAC C GS JPM MS PNC&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">stocks</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="4" halign="left">Stock Splits</th>
      <th colspan="6" halign="left">Volume</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>...</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>99200</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <td>1.6366</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6406</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>47200</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>133600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>24000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>41600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 48 columns</p>
</div></div></div>
</div>
</section>
<section id="reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks-long">
<h5>Reshape <code class="docutils literal notranslate"><span class="pre">stocks</span></code> from wide to long with dates and tickers as row indexes and assign to data frame <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks-long" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks_long</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="n">stocks_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>Dividends</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Stock Splits</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>99200.0000</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <th>BAC</th>
      <td>1.6366</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>47200.0000</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>133600.0000</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>24000.0000</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>41600.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks-long">
<h5>Add daily returns for each stock to data frames <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks-long" title="Permalink to this heading">#</a></h5>
<p>Name the returns variable <code class="docutils literal notranslate"><span class="pre">Returns</span></code>, and maintain all multi indexes.
<em>Hint:</em> Use <code class="docutils literal notranslate"><span class="pre">pd.MultiIndex()</span></code> to create a multi index for the the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="n">stocks</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="4" halign="left">Volume</th>
      <th colspan="6" halign="left">Returns</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>...</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <td>1.6366</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6406</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 54 columns</p>
</div></div></div>
</div>
<p>The easiest way to add returns to long data frame <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> is to <code class="docutils literal notranslate"><span class="pre">.stack()</span></code> wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>!
We could sort <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> by ticker and date (to sort chronologically within each ticker), then use <code class="docutils literal notranslate"><span class="pre">.pct_change()</span></code>.
However, this approach miscalculates the first return for every ticker except for the first ticker.
The easiest and safest solution is to <code class="docutils literal notranslate"><span class="pre">.stack()</span></code> the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># see that the first return for C is wrong</span>
<span class="c1"># stocks_long[&#39;Adj Close&#39;].sort_index(level=[&#39;Ticker&#39;, &#39;Date&#39;]).pct_change().loc[(slice(None), &#39;C&#39;)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks_long</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-the-daily-benchmark-return-factors-from-ken-french-s-data-library">
<h5>Download the daily benchmark return factors from Ken French’s data library.<a class="headerlink" href="#download-the-daily-benchmark-return-factors-from-ken-french-s-data-library" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdr</span><span class="o">.</span><span class="n">famafrench</span><span class="o">.</span><span class="n">get_available_datasets</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors&#39;,
 &#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="add-the-daily-benchmark-return-factors-to-stocks-and-stocks-long">
<h5>Add the daily benchmark return factors to <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#add-the-daily-benchmark-return-factors-to-stocks-and-stocks-long" title="Permalink to this heading">#</a></h5>
<p>For the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>, use the outer index name <code class="docutils literal notranslate"><span class="pre">Factors</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Factors&#39;</span><span class="p">],</span> <span class="n">ff</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="n">stocks</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="6" halign="left">Returns</th>
      <th colspan="4" halign="left">Factors</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>...</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0074</td>
      <td>-0.0039</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <td>1.6366</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6406</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0030</td>
      <td>-0.0037</td>
      <td>0.0022</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0108</td>
      <td>-0.0019</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0088</td>
      <td>-0.0050</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0115</td>
      <td>-0.0018</td>
      <td>0.0064</td>
      <td>0.0002</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 58 columns</p>
</div></div></div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">.join()</span></code> even though <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> has a multi index.
<em><strong>Note that re-running a “self join” can create duplicate columns.</strong></em>
We should be careful to run self joins only once!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks_long</span> <span class="o">=</span> <span class="n">stocks_long</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
<span class="n">stocks_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>Dividends</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Stock Splits</th>
      <th>Volume</th>
      <th>Returns</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>99200.0000</td>
      <td>NaN</td>
      <td>-0.0074</td>
      <td>-0.0039</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <th>BAC</th>
      <td>1.6366</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>47200.0000</td>
      <td>0.0034</td>
      <td>-0.0030</td>
      <td>-0.0037</td>
      <td>0.0022</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>133600.0000</td>
      <td>-0.0034</td>
      <td>-0.0108</td>
      <td>-0.0019</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>24000.0000</td>
      <td>0.0000</td>
      <td>-0.0088</td>
      <td>-0.0050</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>41600.0000</td>
      <td>0.0000</td>
      <td>-0.0115</td>
      <td>-0.0018</td>
      <td>0.0064</td>
      <td>0.0002</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">download()</span></code> that accepts tickers and returns a wide data frame of returns with the daily benchmark return factors.<a class="headerlink" href="#write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># get stocks data</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">stocks</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">stocks</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">stocks</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="n">stocks</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

    <span class="c1"># get factor data</span>
    <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># combine</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Factors&#39;</span><span class="p">],</span> <span class="n">ff</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="n">stocks</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span>

    <span class="k">return</span> <span class="n">stocks</span>
</pre></div>
</div>
</div>
</div>
<p>Below I will provide a more compact and flexible version of <code class="docutils literal notranslate"><span class="pre">download()</span></code>.</p>
</section>
<section id="download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings">
<h5>Download earnings per share for the stocks in <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and combine to a long data frame <code class="docutils literal notranslate"><span class="pre">earnings</span></code>.<a class="headerlink" href="#download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings" title="Permalink to this heading">#</a></h5>
<p>Use the <code class="docutils literal notranslate"><span class="pre">.earnings_dates</span></code> method described <a class="reference external" href="https://pypi.org/project/yfinance/">here</a>.
Use <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code> to combine the result of each the <code class="docutils literal notranslate"><span class="pre">.earnings_date</span></code> data frames and assign them to a new data frame <code class="docutils literal notranslate"><span class="pre">earnings</span></code>.
Name the row indexes <code class="docutils literal notranslate"><span class="pre">Ticker</span></code> and <code class="docutils literal notranslate"><span class="pre">Date</span></code> and swap to match the order of the row index in <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># some students had to update yfinance to use the .earnings_dates atrtibute</span>
<span class="c1"># %pip install -U yfinance</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="s1">&#39;BAC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
    </tr>
    <tr>
      <th>Earnings Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-01-11 08:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-10-17 08:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">earnings</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">earnings</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-01-11 08:00:00-05:00</th>
      <th>BAC</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-10-17 08:00:00-04:00</th>
      <th>BAC</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="combine-earnings-with-the-returns-from-stocks-long">
<h5>Combine <code class="docutils literal notranslate"><span class="pre">earnings</span></code> with the returns from <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#combine-earnings-with-the-returns-from-stocks-long" title="Permalink to this heading">#</a></h5>
<p><em><strong>It is easier to leave <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> as-is and work with slices <code class="docutils literal notranslate"><span class="pre">returns</span></code> and <code class="docutils literal notranslate"><span class="pre">returns_long</span></code>.</strong></em>
Use the <code class="docutils literal notranslate"><span class="pre">tz_localize('America/New_York')</span></code> method add time zone information back to <code class="docutils literal notranslate"><span class="pre">returns.index</span></code> and use <code class="docutils literal notranslate"><span class="pre">pd.to_timedelta(16,</span> <span class="pre">unit='h')</span></code> to set time to the market close in New York City.
Use <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_asof.html"><code class="docutils literal notranslate"><span class="pre">pd.merge_asof()</span></code></a> to match earnings announcement dates and times to appropriate return periods.
For example, if a firm announces earnings after the close at 5 PM on February 7, we want to match the return period from 4 PM on February 7 to 4 PM on February 8.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">]</span>
<span class="n">returns</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
<span class="n">returns_long</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span>
<span class="n">returns_long</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Variable&#39;</span>
<span class="n">returns_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Returns</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-22 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0034</td>
    </tr>
    <tr>
      <th>1973-02-23 16:00:00-05:00</th>
      <th>BAC</th>
      <td>-0.0034</td>
    </tr>
    <tr>
      <th>1973-02-26 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1973-02-27 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1973-02-28 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">earnings</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">returns_long</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
        <span class="n">allow_exact_matches</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">surprises</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
      <th>Returns</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-14 03:00:00-04:00</th>
      <th>GS</th>
      <td>10.2200</td>
      <td>18.6000</td>
      <td>0.8194</td>
      <td>0.0234</td>
    </tr>
    <tr>
      <th>2021-04-16 03:00:00-04:00</th>
      <th>MS</th>
      <td>1.7000</td>
      <td>2.1900</td>
      <td>0.2890</td>
      <td>-0.0276</td>
    </tr>
    <tr>
      <th>2021-07-13 03:00:00-04:00</th>
      <th>GS</th>
      <td>10.2400</td>
      <td>15.0200</td>
      <td>0.4668</td>
      <td>-0.0119</td>
    </tr>
    <tr>
      <th>2021-07-15 03:00:00-04:00</th>
      <th>MS</th>
      <td>1.6500</td>
      <td>1.8500</td>
      <td>0.1185</td>
      <td>0.0018</td>
    </tr>
    <tr>
      <th>2021-10-14 03:00:00-04:00</th>
      <th>MS</th>
      <td>1.6900</td>
      <td>1.9800</td>
      <td>0.1751</td>
      <td>0.0248</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
      <th>Returns</th>
    </tr>
    <tr>
      <th>Variable</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>EPS Estimate</th>
      <td>1.0000</td>
      <td>0.9444</td>
      <td>0.3620</td>
      <td>-0.2239</td>
    </tr>
    <tr>
      <th>Reported EPS</th>
      <td>0.9444</td>
      <td>1.0000</td>
      <td>0.6171</td>
      <td>-0.0615</td>
    </tr>
    <tr>
      <th>Surprise(%)</th>
      <td>0.3620</td>
      <td>0.6171</td>
      <td>1.0000</td>
      <td>0.4397</td>
    </tr>
    <tr>
      <th>Returns</th>
      <td>-0.2239</td>
      <td>-0.0615</td>
      <td>0.4397</td>
      <td>1.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="plot-the-relation-between-daily-returns-and-earnings-surprises">
<h5>Plot the relation between daily returns and earnings surprises<a class="headerlink" href="#plot-the-relation-between-daily-returns-and-earnings-surprises" title="Permalink to this heading">#</a></h5>
<p>Three options in increasing difficulty:</p>
<ol class="arabic simple">
<li><p>Scatter plot</p></li>
<li><p>Scatter plot with a best-fit line using <code class="docutils literal notranslate"><span class="pre">regplot()</span></code> from the seaborn package</p></li>
<li><p>Bar plot using <code class="docutils literal notranslate"><span class="pre">barplot()</span></code> from the seaborn package after using <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> to form five groups on earnings surprises</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">surprises</span>
    <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">__</span> <span class="o">=</span> <span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ddb8d2140998e68e00f41f701aac3893910abc69a528374a6462b885622c8173.png" src="_images/ddb8d2140998e68e00f41f701aac3893910abc69a528374a6462b885622c8173.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span> <span class="s1">&#39;Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">surprises</span><span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">__</span> <span class="o">=</span> <span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bf6fa0db63fc3e745ec9772cc7b5eeee3b544d3ce5dbc0eea55cbaaa8f83b705.png" src="_images/bf6fa0db63fc3e745ec9772cc7b5eeee3b544d3ce5dbc0eea55cbaaa8f83b705.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises</span><span class="p">[</span><span class="s1">&#39;ESQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">surprises</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ESQ&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span> <span class="s1">&#39;Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
        <span class="n">surprises</span>
        <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ESQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">__</span> <span class="o">=</span> <span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bf26a3081f2f3ae9aa5ac6ad242dafad282378b82b6c0b8634107b7b5faa580a.png" src="_images/bf26a3081f2f3ae9aa5ac6ad242dafad282378b82b6c0b8634107b7b5faa580a.png" />
</div>
</div>
<p><em><strong>There is a positive relation between announcment returns and earnings surprises!</strong></em>
Of course, to say more we need more data and to control for market movements, but this analaysis is a start!</p>
</section>
<section id="repeat-the-earnings-exercise-with-the-s-p-100-stocks">
<h5>Repeat the earnings exercise with the S&amp;P 100 stocks<a class="headerlink" href="#repeat-the-earnings-exercise-with-the-s-p-100-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/S%26P_100&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symbols</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers_2</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">symbols</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tickers_2</span>
    <span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">returns_2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>ABBV</th>
      <th>ABT</th>
      <th>ACN</th>
      <th>ADBE</th>
      <th>AIG</th>
      <th>AMD</th>
      <th>AMGN</th>
      <th>AMT</th>
      <th>AMZN</th>
      <th>...</th>
      <th>UNH</th>
      <th>UNP</th>
      <th>UPS</th>
      <th>USB</th>
      <th>V</th>
      <th>VZ</th>
      <th>WBA</th>
      <th>WFC</th>
      <th>WMT</th>
      <th>XOM</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1962-01-02 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1962-01-03 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0149</td>
    </tr>
    <tr>
      <th>1962-01-04 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0024</td>
    </tr>
    <tr>
      <th>1962-01-05 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0219</td>
    </tr>
    <tr>
      <th>1962-01-08 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0025</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 101 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">earnings_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">tickers_2</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers_2</span><span class="o">.</span><span class="n">tickers</span><span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">tickers_2</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">earnings_2</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
        <span class="n">allow_exact_matches</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ESQ&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span> <span class="s1">&#39;Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
        <span class="n">surprises_2</span>
        <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ESQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">__</span> <span class="o">=</span> <span class="n">surprises_2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements for S&amp;P 100 Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1e3e4e06c9f6bb45e17f2536aa0d95244c5e54f6917451b7174c8149d6b3dd57.png" src="_images/1e3e4e06c9f6bb45e17f2536aa0d95244c5e54f6917451b7174c8149d6b3dd57.png" />
</div>
</div>
</section>
<section id="repeat-the-earnings-exercise-with-excess-returns-of-the-s-p-100-stocks">
<h5>Repeat the earnings exercise with <em>excess returns</em> of the S&amp;P 100 Stocks<a class="headerlink" href="#repeat-the-earnings-exercise-with-excess-returns-of-the-s-p-100-stocks" title="Permalink to this heading">#</a></h5>
<p>Excess returns are returns minus market returns.
We need to add a timezone and the closing time to the market return from Fama and French.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Mkt</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span>
<span class="n">Mkt</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">Mkt</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
<span class="n">returns_3</span> <span class="o">=</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">Mkt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises_3</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">earnings_2</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">returns_3</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Excess Returns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
        <span class="n">allow_exact_matches</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ESQ&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Excess Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
        <span class="n">surprises_3</span>
        <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Excess Returns&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ESQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Excess Return (%)&#39;</span><span class="p">)</span>

<span class="n">__</span> <span class="o">=</span> <span class="n">surprises_3</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements for S&amp;P 100 Stocks</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8fe7732e2c96cf3b18b9c8213a60e89cbd79a5d8630f6e0f5fd3ee112055621a.png" src="_images/8fe7732e2c96cf3b18b9c8213a60e89cbd79a5d8630f6e0f5fd3ee112055621a.png" />
</div>
</div>
</section>
<section id="improve-your-download-function-from-above">
<h5>Improve your <code class="docutils literal notranslate"><span class="pre">download()</span></code> function from above<a class="headerlink" href="#improve-your-download-function-from-above" title="Permalink to this heading">#</a></h5>
<p>Modify <code class="docutils literal notranslate"><span class="pre">download()</span></code> to accept one or more than one ticker.
Since we will not use the advanced functionality of the tickers object that <code class="docutils literal notranslate"><span class="pre">yf.Tickers()</span></code> creates, we will use <code class="docutils literal notranslate"><span class="pre">yf.download()</span></code>.
The current version of <code class="docutils literal notranslate"><span class="pre">yf.download()</span></code> does not accept a <code class="docutils literal notranslate"><span class="pre">session=</span></code> argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">):</span>

    <span class="n">histories</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">factors</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="n">histories</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Factors&#39;</span><span class="p">],</span> <span class="n">factors</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="n">histories</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">factors</span>

        <span class="k">return</span> <span class="n">histories</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">histories</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  1 of 1 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>0.1283</td>
      <td>0.1289</td>
      <td>0.1283</td>
      <td>0.1283</td>
      <td>0.0997</td>
      <td>469033600</td>
      <td>0.0138</td>
      <td>-0.0001</td>
      <td>-0.0105</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>0.1222</td>
      <td>0.1222</td>
      <td>0.1217</td>
      <td>0.1217</td>
      <td>0.0945</td>
      <td>175884800</td>
      <td>0.0011</td>
      <td>0.0025</td>
      <td>-0.0046</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>0.1133</td>
      <td>0.1133</td>
      <td>0.1127</td>
      <td>0.1127</td>
      <td>0.0876</td>
      <td>105728000</td>
      <td>0.0071</td>
      <td>-0.0075</td>
      <td>-0.0047</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.1155</td>
      <td>0.1161</td>
      <td>0.1155</td>
      <td>0.1155</td>
      <td>0.0897</td>
      <td>86441600</td>
      <td>0.0152</td>
      <td>-0.0086</td>
      <td>-0.0034</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.1189</td>
      <td>0.1194</td>
      <td>0.1189</td>
      <td>0.1189</td>
      <td>0.0924</td>
      <td>73449600</td>
      <td>0.0041</td>
      <td>0.0022</td>
      <td>0.0126</td>
      <td>0.0006</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;AAPL TSLA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  2 of 2 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="2" halign="left">Adj Close</th>
      <th colspan="2" halign="left">Close</th>
      <th colspan="2" halign="left">High</th>
      <th colspan="2" halign="left">Low</th>
      <th colspan="2" halign="left">Open</th>
      <th colspan="2" halign="left">Volume</th>
      <th colspan="2" halign="left">Returns</th>
      <th colspan="4" halign="left">Factors</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>0.0997</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>0.1289</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>469033600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0138</td>
      <td>-0.0001</td>
      <td>-0.0105</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>0.0945</td>
      <td>NaN</td>
      <td>0.1217</td>
      <td>NaN</td>
      <td>0.1222</td>
      <td>NaN</td>
      <td>0.1217</td>
      <td>NaN</td>
      <td>0.1222</td>
      <td>NaN</td>
      <td>175884800</td>
      <td>NaN</td>
      <td>-0.0522</td>
      <td>NaN</td>
      <td>0.0011</td>
      <td>0.0025</td>
      <td>-0.0046</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>0.0876</td>
      <td>NaN</td>
      <td>0.1127</td>
      <td>NaN</td>
      <td>0.1133</td>
      <td>NaN</td>
      <td>0.1127</td>
      <td>NaN</td>
      <td>0.1133</td>
      <td>NaN</td>
      <td>105728000</td>
      <td>NaN</td>
      <td>-0.0734</td>
      <td>NaN</td>
      <td>0.0071</td>
      <td>-0.0075</td>
      <td>-0.0047</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.0897</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>0.1161</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>86441600</td>
      <td>NaN</td>
      <td>0.0248</td>
      <td>NaN</td>
      <td>0.0152</td>
      <td>-0.0086</td>
      <td>-0.0034</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.0924</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>0.1194</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>73449600</td>
      <td>NaN</td>
      <td>0.0290</td>
      <td>NaN</td>
      <td>0.0041</td>
      <td>0.0022</td>
      <td>0.0126</td>
      <td>0.0006</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_08_practice_04"></span><section id="mckinney-chapter-8-practice-wednesday-11-45-am-section-4">
<h3>McKinney Chapter 8 - Practice (Wednesday 11:45 AM, Section 4)<a class="headerlink" href="#mckinney-chapter-8-practice-wednesday-11-45-am-section-4" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 3 mean was $80%$</p></li>
<li><p>I posted project 1 to Canvas</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks">
<h5>Download data from Yahoo! Finance for BAC, C, GS, JPM, MS, and PNC and assign to data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>.<a class="headerlink" href="#download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks" title="Permalink to this heading">#</a></h5>
<p>Use <code class="docutils literal notranslate"><span class="pre">stocks.columns.names</span></code> to assign the names <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">Ticker</span></code> to the column multi index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BAC C GS JPM MS PNC&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">stocks</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  6 of 6 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="4" halign="left">Stock Splits</th>
      <th colspan="6" halign="left">Volume</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>...</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>99200</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <td>1.6366</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6406</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>47200</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>133600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>24000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>41600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 48 columns</p>
</div></div></div>
</div>
</section>
<section id="reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks-long">
<h5>Reshape <code class="docutils literal notranslate"><span class="pre">stocks</span></code> from wide to long with dates and tickers as row indexes and assign to data frame <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks-long" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks_long</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="n">stocks_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>Dividends</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Stock Splits</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>99200.0000</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <th>BAC</th>
      <td>1.6366</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>47200.0000</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>133600.0000</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>24000.0000</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>41600.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks-long">
<h5>Add daily returns for each stock to data frames <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks-long" title="Permalink to this heading">#</a></h5>
<p>Name the returns variable <code class="docutils literal notranslate"><span class="pre">Returns</span></code>, and maintain all multi indexes.
<em>Hint:</em> Use <code class="docutils literal notranslate"><span class="pre">pd.MultiIndex()</span></code> to create a multi index for the the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]])</span>
<span class="n">stocks</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="4" halign="left">Volume</th>
      <th colspan="6" halign="left">Returns</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>...</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <td>1.6366</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6406</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 54 columns</p>
</div></div></div>
</div>
<p>The easiest way to add returns to long data frame <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> is to <code class="docutils literal notranslate"><span class="pre">.stack()</span></code> wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>!
We could sort <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> by ticker and date (to sort chronologically within each ticker), then use <code class="docutils literal notranslate"><span class="pre">.pct_change()</span></code>.
However, this approach miscalculates the first return for every ticker except for the first ticker.
The easiest and safest solution is to <code class="docutils literal notranslate"><span class="pre">.stack()</span></code> the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># see that the first return for C is wrong</span>
<span class="c1"># stocks_long[&#39;Adj Close&#39;].sort_index(level=[&#39;Ticker&#39;, &#39;Date&#39;]).pct_change().loc[(slice(None), &#39;C&#39;)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks_long</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-the-daily-benchmark-return-factors-from-ken-french-s-data-library">
<h5>Download the daily benchmark return factors from Ken French’s data library.<a class="headerlink" href="#download-the-daily-benchmark-return-factors-from-ken-french-s-data-library" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdr</span><span class="o">.</span><span class="n">famafrench</span><span class="o">.</span><span class="n">get_available_datasets</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors&#39;,
 &#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ff</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07-01</th>
      <td>0.0010</td>
      <td>-0.0025</td>
      <td>-0.0027</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-02</th>
      <td>0.0045</td>
      <td>-0.0033</td>
      <td>-0.0006</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-06</th>
      <td>0.0017</td>
      <td>0.0030</td>
      <td>-0.0039</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-07</th>
      <td>0.0009</td>
      <td>-0.0058</td>
      <td>0.0002</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-08</th>
      <td>0.0021</td>
      <td>-0.0038</td>
      <td>0.0019</td>
      <td>0.0001</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="add-the-daily-benchmark-return-factors-to-stocks-and-stocks-long">
<h5>Add the daily benchmark return factors to <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#add-the-daily-benchmark-return-factors-to-stocks-and-stocks-long" title="Permalink to this heading">#</a></h5>
<p>For the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>, use the outer index name <code class="docutils literal notranslate"><span class="pre">Factors</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Factors&#39;</span><span class="p">],</span> <span class="n">ff</span><span class="p">])</span>
<span class="n">stocks</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="6" halign="left">Returns</th>
      <th colspan="4" halign="left">Factors</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>...</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0074</td>
      <td>-0.0039</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <td>1.6366</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6406</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0030</td>
      <td>-0.0037</td>
      <td>0.0022</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0108</td>
      <td>-0.0019</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0088</td>
      <td>-0.0050</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <td>1.6311</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0115</td>
      <td>-0.0018</td>
      <td>0.0064</td>
      <td>0.0002</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 58 columns</p>
</div></div></div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">.join()</span></code> even though <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> has a multi index.
<em><strong>Note that re-running a “self join” can create duplicate columns.</strong></em>
We should be careful to run self joins only once!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks_long</span> <span class="o">=</span> <span class="n">stocks_long</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
<span class="n">stocks_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>Dividends</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Stock Splits</th>
      <th>Volume</th>
      <th>Returns</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>99200.0000</td>
      <td>NaN</td>
      <td>-0.0074</td>
      <td>-0.0039</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <th>BAC</th>
      <td>1.6366</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>47200.0000</td>
      <td>0.0034</td>
      <td>-0.0030</td>
      <td>-0.0037</td>
      <td>0.0022</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>133600.0000</td>
      <td>-0.0034</td>
      <td>-0.0108</td>
      <td>-0.0019</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>24000.0000</td>
      <td>0.0000</td>
      <td>-0.0088</td>
      <td>-0.0050</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <th>BAC</th>
      <td>1.6311</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>41600.0000</td>
      <td>0.0000</td>
      <td>-0.0115</td>
      <td>-0.0018</td>
      <td>0.0064</td>
      <td>0.0002</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">download()</span></code> that accepts tickers and returns a wide data frame of returns with the daily benchmark return factors.<a class="headerlink" href="#write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors" title="Permalink to this heading">#</a></h5>
<p><em><strong>See advanced solution below.</strong></em>
I had planned this as an in-class exercise, but decided to spend more time on the earnings surprise exercise.</p>
</section>
<section id="download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings">
<h5>Download earnings per share for the stocks in <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and combine to a long data frame <code class="docutils literal notranslate"><span class="pre">earnings</span></code>.<a class="headerlink" href="#download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings" title="Permalink to this heading">#</a></h5>
<p>Use the <code class="docutils literal notranslate"><span class="pre">.earnings_dates</span></code> method described <a class="reference external" href="https://pypi.org/project/yfinance/">here</a>.
Use <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code> to combine the result of each the <code class="docutils literal notranslate"><span class="pre">.earnings_date</span></code> data frames and assign them to a new data frame <code class="docutils literal notranslate"><span class="pre">earnings</span></code>.
Name the row indexes <code class="docutils literal notranslate"><span class="pre">Ticker</span></code> and <code class="docutils literal notranslate"><span class="pre">Date</span></code> and swap to match the order of the row index in <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># some students had to update yfinance to use the .earnings_dates atrtibute</span>
<span class="c1"># %pip install -U yfinance</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="s1">&#39;BAC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
    </tr>
    <tr>
      <th>Earnings Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-01-11 08:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-10-17 08:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">earnings</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">earnings</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-01-11 08:00:00-05:00</th>
      <th>BAC</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-10-17 08:00:00-04:00</th>
      <th>BAC</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="combine-earnings-with-the-returns-from-stocks-long">
<h5>Combine <code class="docutils literal notranslate"><span class="pre">earnings</span></code> with the returns from <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#combine-earnings-with-the-returns-from-stocks-long" title="Permalink to this heading">#</a></h5>
<p><em><strong>It is easier to leave <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> as-is and work with slices <code class="docutils literal notranslate"><span class="pre">returns</span></code> and <code class="docutils literal notranslate"><span class="pre">returns_long</span></code>.</strong></em>
Use the <code class="docutils literal notranslate"><span class="pre">tz_localize('America/New_York')</span></code> method add time zone information back to <code class="docutils literal notranslate"><span class="pre">returns.index</span></code> and use <code class="docutils literal notranslate"><span class="pre">pd.to_timedelta(16,</span> <span class="pre">unit='h')</span></code> to set time to the market close in New York City.
Use <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_asof.html"><code class="docutils literal notranslate"><span class="pre">pd.merge_asof()</span></code></a> to match earnings announcement dates and times to appropriate return periods.
For example, if a firm announces earnings after the close at 5 PM on February 7, we want to match the return period from 4 PM on February 7 to 4 PM on February 8.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">]</span>
<span class="n">returns</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
<span class="n">returns_long</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span>
<span class="n">returns_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Returns</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-22 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0034</td>
    </tr>
    <tr>
      <th>1973-02-23 16:00:00-05:00</th>
      <th>BAC</th>
      <td>-0.0034</td>
    </tr>
    <tr>
      <th>1973-02-26 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1973-02-27 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1973-02-28 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">earnings</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">returns_long</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
        <span class="n">allow_exact_matches</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">surprises</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
      <th>Returns</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-14 03:00:00-04:00</th>
      <th>GS</th>
      <td>10.2200</td>
      <td>18.6000</td>
      <td>0.8194</td>
      <td>0.0234</td>
    </tr>
    <tr>
      <th>2021-04-16 03:00:00-04:00</th>
      <th>MS</th>
      <td>1.7000</td>
      <td>2.1900</td>
      <td>0.2890</td>
      <td>-0.0276</td>
    </tr>
    <tr>
      <th>2021-07-13 03:00:00-04:00</th>
      <th>GS</th>
      <td>10.2400</td>
      <td>15.0200</td>
      <td>0.4668</td>
      <td>-0.0119</td>
    </tr>
    <tr>
      <th>2021-07-15 03:00:00-04:00</th>
      <th>MS</th>
      <td>1.6500</td>
      <td>1.8500</td>
      <td>0.1185</td>
      <td>0.0018</td>
    </tr>
    <tr>
      <th>2021-10-14 03:00:00-04:00</th>
      <th>MS</th>
      <td>1.6900</td>
      <td>1.9800</td>
      <td>0.1751</td>
      <td>0.0248</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
      <th>Returns</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>EPS Estimate</th>
      <td>1.0000</td>
      <td>0.9444</td>
      <td>0.3620</td>
      <td>-0.2239</td>
    </tr>
    <tr>
      <th>Reported EPS</th>
      <td>0.9444</td>
      <td>1.0000</td>
      <td>0.6171</td>
      <td>-0.0615</td>
    </tr>
    <tr>
      <th>Surprise(%)</th>
      <td>0.3620</td>
      <td>0.6171</td>
      <td>1.0000</td>
      <td>0.4397</td>
    </tr>
    <tr>
      <th>Returns</th>
      <td>-0.2239</td>
      <td>-0.0615</td>
      <td>0.4397</td>
      <td>1.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
    </tr>
    <tr>
      <th>Earnings Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-01-17 11:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2024-01-17 08:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-10-13 11:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-10-13 08:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-07-14 11:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-07-14 08:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-04-14 11:00:00-04:00</th>
      <td>1.6700</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-04-14 08:00:00-04:00</th>
      <td>1.6700</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-01-13 03:00:00-05:00</th>
      <td>1.1400</td>
      <td>1.1600</td>
      <td>0.0149</td>
    </tr>
    <tr>
      <th>2022-10-14 04:00:00-04:00</th>
      <td>1.4200</td>
      <td>1.6300</td>
      <td>0.1471</td>
    </tr>
    <tr>
      <th>2022-07-15 04:00:00-04:00</th>
      <td>1.6800</td>
      <td>2.1900</td>
      <td>0.3020</td>
    </tr>
    <tr>
      <th>2022-04-14 04:00:00-04:00</th>
      <td>1.5500</td>
      <td>2.0200</td>
      <td>0.3058</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="plot-the-relation-between-daily-returns-and-earnings-surprises">
<h5>Plot the relation between daily returns and earnings surprises<a class="headerlink" href="#plot-the-relation-between-daily-returns-and-earnings-surprises" title="Permalink to this heading">#</a></h5>
<p>Three options in increasing difficulty:</p>
<ol class="arabic simple">
<li><p>Scatter plot</p></li>
<li><p>Scatter plot with a best-fit line using <code class="docutils literal notranslate"><span class="pre">regplot()</span></code> from the seaborn package</p></li>
<li><p>Bar plot using <code class="docutils literal notranslate"><span class="pre">barplot()</span></code> from the seaborn package after using <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> to form five groups on earnings surprises</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">surprises</span>
    <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">__</span> <span class="o">=</span> <span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ddb8d2140998e68e00f41f701aac3893910abc69a528374a6462b885622c8173.png" src="_images/ddb8d2140998e68e00f41f701aac3893910abc69a528374a6462b885622c8173.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span> <span class="s1">&#39;Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">surprises</span><span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">__</span> <span class="o">=</span> <span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2659346e1958bfdceffab52180fae7b67d8867e7bbcd6492e94d7882e034cb83.png" src="_images/2659346e1958bfdceffab52180fae7b67d8867e7bbcd6492e94d7882e034cb83.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises</span><span class="p">[</span><span class="s1">&#39;ESQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">surprises</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ESQ&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span> <span class="s1">&#39;Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
        <span class="n">surprises</span>
        <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ESQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">__</span> <span class="o">=</span> <span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c4d4d23a0843ae749360981cd673e7eea2624bc04efa2986c45a1b9f2f328dde.png" src="_images/c4d4d23a0843ae749360981cd673e7eea2624bc04efa2986c45a1b9f2f328dde.png" />
</div>
</div>
<p><em><strong>There is a positive relation between announcment returns and earnings surprises!</strong></em>
Of course, to say more we need more data and to control for market movements, but this analaysis is a start!</p>
</section>
<section id="repeat-the-earnings-exercise-with-the-s-p-100-stocks">
<h5>Repeat the earnings exercise with the S&amp;P 100 stocks<a class="headerlink" href="#repeat-the-earnings-exercise-with-the-s-p-100-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/S%26P_100&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symbols</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers_2</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">symbols</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tickers_2</span>
    <span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">returns_2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>ABBV</th>
      <th>ABT</th>
      <th>ACN</th>
      <th>ADBE</th>
      <th>AIG</th>
      <th>AMD</th>
      <th>AMGN</th>
      <th>AMT</th>
      <th>AMZN</th>
      <th>...</th>
      <th>UNH</th>
      <th>UNP</th>
      <th>UPS</th>
      <th>USB</th>
      <th>V</th>
      <th>VZ</th>
      <th>WBA</th>
      <th>WFC</th>
      <th>WMT</th>
      <th>XOM</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1962-01-02 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1962-01-03 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0149</td>
    </tr>
    <tr>
      <th>1962-01-04 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0024</td>
    </tr>
    <tr>
      <th>1962-01-05 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0219</td>
    </tr>
    <tr>
      <th>1962-01-08 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0025</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 101 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">earnings_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">tickers_2</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers_2</span><span class="o">.</span><span class="n">tickers</span><span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">tickers_2</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">earnings_2</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
        <span class="n">allow_exact_matches</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ESQ&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span> <span class="s1">&#39;Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
        <span class="n">surprises_2</span>
        <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ESQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">__</span> <span class="o">=</span> <span class="n">surprises_2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements for S&amp;P 100 Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/81ce56b56ef7415cd6a8c5cff6aa043d4c00ed3e73f278041ecda4c5b0c33692.png" src="_images/81ce56b56ef7415cd6a8c5cff6aa043d4c00ed3e73f278041ecda4c5b0c33692.png" />
</div>
</div>
</section>
<section id="repeat-the-earnings-exercise-with-excess-returns-of-the-s-p-100-stocks">
<h5>Repeat the earnings exercise with <em>excess returns</em> of the S&amp;P 100 Stocks<a class="headerlink" href="#repeat-the-earnings-exercise-with-excess-returns-of-the-s-p-100-stocks" title="Permalink to this heading">#</a></h5>
<p>Excess returns are returns minus market returns.
We need to add a timezone and the closing time to the market return from Fama and French.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Mkt</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span>
<span class="n">Mkt</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">Mkt</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
<span class="n">returns_3</span> <span class="o">=</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">Mkt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises_3</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">earnings_2</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">returns_3</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Excess Returns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
        <span class="n">allow_exact_matches</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ESQ&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Excess Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
        <span class="n">surprises_3</span>
        <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Excess Returns&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ESQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Excess Return (%)&#39;</span><span class="p">)</span>

<span class="n">__</span> <span class="o">=</span> <span class="n">surprises_3</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements for S&amp;P 100 Stocks</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d07eabf2bb46f6242d93f191be3eb6675d51d0ab36f934152934937aa1f5d7be.png" src="_images/d07eabf2bb46f6242d93f191be3eb6675d51d0ab36f934152934937aa1f5d7be.png" />
</div>
</div>
</section>
<section id="improve-your-download-function-from-above">
<h5>Improve your <code class="docutils literal notranslate"><span class="pre">download()</span></code> function from above<a class="headerlink" href="#improve-your-download-function-from-above" title="Permalink to this heading">#</a></h5>
<p>Modify <code class="docutils literal notranslate"><span class="pre">download()</span></code> to accept one or more than one ticker.
Since we will not use the advanced functionality of the tickers object that <code class="docutils literal notranslate"><span class="pre">yf.Tickers()</span></code> creates, we will use <code class="docutils literal notranslate"><span class="pre">yf.download()</span></code>.
The current version of <code class="docutils literal notranslate"><span class="pre">yf.download()</span></code> does not accept a <code class="docutils literal notranslate"><span class="pre">session=</span></code> argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">):</span>

    <span class="n">histories</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">factors</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="n">histories</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Factors&#39;</span><span class="p">],</span> <span class="n">factors</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="n">histories</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">factors</span>

        <span class="k">return</span> <span class="n">histories</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">histories</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  1 of 1 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>0.1283</td>
      <td>0.1289</td>
      <td>0.1283</td>
      <td>0.1283</td>
      <td>0.0997</td>
      <td>469033600</td>
      <td>0.0138</td>
      <td>-0.0001</td>
      <td>-0.0105</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>0.1222</td>
      <td>0.1222</td>
      <td>0.1217</td>
      <td>0.1217</td>
      <td>0.0945</td>
      <td>175884800</td>
      <td>0.0011</td>
      <td>0.0025</td>
      <td>-0.0046</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>0.1133</td>
      <td>0.1133</td>
      <td>0.1127</td>
      <td>0.1127</td>
      <td>0.0876</td>
      <td>105728000</td>
      <td>0.0071</td>
      <td>-0.0075</td>
      <td>-0.0047</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.1155</td>
      <td>0.1161</td>
      <td>0.1155</td>
      <td>0.1155</td>
      <td>0.0897</td>
      <td>86441600</td>
      <td>0.0152</td>
      <td>-0.0086</td>
      <td>-0.0034</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.1189</td>
      <td>0.1194</td>
      <td>0.1189</td>
      <td>0.1189</td>
      <td>0.0924</td>
      <td>73449600</td>
      <td>0.0041</td>
      <td>0.0022</td>
      <td>0.0126</td>
      <td>0.0006</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;AAPL TSLA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  2 of 2 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="2" halign="left">Adj Close</th>
      <th colspan="2" halign="left">Close</th>
      <th colspan="2" halign="left">High</th>
      <th colspan="2" halign="left">Low</th>
      <th colspan="2" halign="left">Open</th>
      <th colspan="2" halign="left">Volume</th>
      <th colspan="2" halign="left">Returns</th>
      <th colspan="4" halign="left">Factors</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>0.0997</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>0.1289</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>469033600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0138</td>
      <td>-0.0001</td>
      <td>-0.0105</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>0.0945</td>
      <td>NaN</td>
      <td>0.1217</td>
      <td>NaN</td>
      <td>0.1222</td>
      <td>NaN</td>
      <td>0.1217</td>
      <td>NaN</td>
      <td>0.1222</td>
      <td>NaN</td>
      <td>175884800</td>
      <td>NaN</td>
      <td>-0.0522</td>
      <td>NaN</td>
      <td>0.0011</td>
      <td>0.0025</td>
      <td>-0.0046</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>0.0876</td>
      <td>NaN</td>
      <td>0.1127</td>
      <td>NaN</td>
      <td>0.1133</td>
      <td>NaN</td>
      <td>0.1127</td>
      <td>NaN</td>
      <td>0.1133</td>
      <td>NaN</td>
      <td>105728000</td>
      <td>NaN</td>
      <td>-0.0734</td>
      <td>NaN</td>
      <td>0.0071</td>
      <td>-0.0075</td>
      <td>-0.0047</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.0897</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>0.1161</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>86441600</td>
      <td>NaN</td>
      <td>0.0248</td>
      <td>NaN</td>
      <td>0.0152</td>
      <td>-0.0086</td>
      <td>-0.0034</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.0924</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>0.1194</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>73449600</td>
      <td>NaN</td>
      <td>0.0290</td>
      <td>NaN</td>
      <td>0.0041</td>
      <td>0.0022</td>
      <td>0.0126</td>
      <td>0.0006</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
</section>
<span id="document-mckinney_08_practice_02"></span><section id="mckinney-chapter-8-practice-wednesday-2-45-pm-section-2">
<h3>McKinney Chapter 8 - Practice (Wednesday 2:45 PM, Section 2)<a class="headerlink" href="#mckinney-chapter-8-practice-wednesday-2-45-pm-section-2" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 3 mean was $\approx 80%$</p></li>
<li><p>I posted project 1 to Canvas</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks">
<h5>Download data from Yahoo! Finance for BAC, C, GS, JPM, MS, and PNC and assign to data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>.<a class="headerlink" href="#download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks" title="Permalink to this heading">#</a></h5>
<p>Use <code class="docutils literal notranslate"><span class="pre">stocks.columns.names</span></code> to assign the names <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">Ticker</span></code> to the column multi index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BAC C GS JPM MS PNC&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
<span class="n">stocks</span> <span class="o">=</span> <span class="n">tickers</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="4" halign="left">Stock Splits</th>
      <th colspan="6" halign="left">Volume</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>...</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>99200.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <td>1.6260</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6406</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>47200.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>133600.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>24000.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>41600.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 48 columns</p>
</div></div></div>
</div>
</section>
<section id="reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks-long">
<h5>Reshape <code class="docutils literal notranslate"><span class="pre">stocks</span></code> from wide to long with dates and tickers as row indexes and assign to data frame <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks-long" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>Dividends</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Stock Splits</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>99200.0000</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <th>BAC</th>
      <td>1.6260</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>47200.0000</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>133600.0000</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>24000.0000</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>41600.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Variable</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1973-02-21</th>
      <th>Adj Close</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Close</th>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Dividends</th>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>High</th>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Low</th>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks_long</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="n">stocks_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>Dividends</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Stock Splits</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>99200.0000</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <th>BAC</th>
      <td>1.6260</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>47200.0000</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>133600.0000</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>24000.0000</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>41600.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks-long">
<h5>Add daily returns for each stock to data frames <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks-long" title="Permalink to this heading">#</a></h5>
<p>Name the returns variable <code class="docutils literal notranslate"><span class="pre">Returns</span></code>, and maintain all multi indexes.
<em>Hint:</em> Use <code class="docutils literal notranslate"><span class="pre">pd.MultiIndex()</span></code> to create a multi index for the the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]])</span>
<span class="n">stocks</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="4" halign="left">Volume</th>
      <th colspan="6" halign="left">Returns</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>...</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <td>1.6260</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6406</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 54 columns</p>
</div></div></div>
</div>
<p>The easiest way to add returns to long data frame <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> is to <code class="docutils literal notranslate"><span class="pre">.stack()</span></code> wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>!
We could sort <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> by ticker and date (to sort chronologically within each ticker), then use <code class="docutils literal notranslate"><span class="pre">.pct_change()</span></code>.
However, this approach miscalculates the first return for every ticker except for the first ticker.
The easiest and safest solution is to <code class="docutils literal notranslate"><span class="pre">.stack()</span></code> the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># see that the first return for C is wrong</span>
<span class="c1"># stocks_long[&#39;Adj Close&#39;].sort_index(level=[&#39;Ticker&#39;, &#39;Date&#39;]).pct_change().loc[(slice(None), &#39;C&#39;)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks_long</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-the-daily-benchmark-return-factors-from-ken-french-s-data-library">
<h5>Download the daily benchmark return factors from Ken French’s data library.<a class="headerlink" href="#download-the-daily-benchmark-return-factors-from-ken-french-s-data-library" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdr</span><span class="o">.</span><span class="n">famafrench</span><span class="o">.</span><span class="n">get_available_datasets</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors&#39;,
 &#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ff</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07-01</th>
      <td>0.0010</td>
      <td>-0.0025</td>
      <td>-0.0027</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-02</th>
      <td>0.0045</td>
      <td>-0.0033</td>
      <td>-0.0006</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-06</th>
      <td>0.0017</td>
      <td>0.0030</td>
      <td>-0.0039</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-07</th>
      <td>0.0009</td>
      <td>-0.0058</td>
      <td>0.0002</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>1926-07-08</th>
      <td>0.0021</td>
      <td>-0.0038</td>
      <td>0.0019</td>
      <td>0.0001</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="add-the-daily-benchmark-return-factors-to-stocks-and-stocks-long">
<h5>Add the daily benchmark return factors to <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#add-the-daily-benchmark-return-factors-to-stocks-and-stocks-long" title="Permalink to this heading">#</a></h5>
<p>For the wide data frame <code class="docutils literal notranslate"><span class="pre">stocks</span></code>, use the outer index name <code class="docutils literal notranslate"><span class="pre">Factors</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Factors&#39;</span><span class="p">],</span> <span class="n">ff</span><span class="p">])</span>
<span class="n">stocks</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span>
<span class="n">stocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="6" halign="left">Returns</th>
      <th colspan="4" halign="left">Factors</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>...</th>
      <th>BAC</th>
      <th>C</th>
      <th>GS</th>
      <th>JPM</th>
      <th>MS</th>
      <th>PNC</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0074</td>
      <td>-0.0039</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <td>1.6260</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6406</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0030</td>
      <td>-0.0037</td>
      <td>0.0022</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.0034</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0108</td>
      <td>-0.0019</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0088</td>
      <td>-0.0050</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <td>1.6206</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.6250</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0115</td>
      <td>-0.0018</td>
      <td>0.0064</td>
      <td>0.0002</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 58 columns</p>
</div></div></div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">.join()</span></code> even though <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> has a multi index.
<em><strong>Note that re-running a “self join” can create duplicate columns.</strong></em>
We should be careful to run self joins only once!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks_long</span> <span class="o">=</span> <span class="n">stocks_long</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
<span class="n">stocks_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>Dividends</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Stock Splits</th>
      <th>Volume</th>
      <th>Returns</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-21</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>99200.0000</td>
      <td>NaN</td>
      <td>-0.0074</td>
      <td>-0.0039</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-22</th>
      <th>BAC</th>
      <td>1.6260</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>4.6406</td>
      <td>0.0000</td>
      <td>47200.0000</td>
      <td>0.0034</td>
      <td>-0.0030</td>
      <td>-0.0037</td>
      <td>0.0022</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-23</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>133600.0000</td>
      <td>-0.0034</td>
      <td>-0.0108</td>
      <td>-0.0019</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-26</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>24000.0000</td>
      <td>0.0000</td>
      <td>-0.0088</td>
      <td>-0.0050</td>
      <td>0.0054</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>1973-02-27</th>
      <th>BAC</th>
      <td>1.6206</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>4.6250</td>
      <td>0.0000</td>
      <td>41600.0000</td>
      <td>0.0000</td>
      <td>-0.0115</td>
      <td>-0.0018</td>
      <td>0.0064</td>
      <td>0.0002</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors">
<h5>Write a function <code class="docutils literal notranslate"><span class="pre">download()</span></code> that accepts tickers and returns a wide data frame of returns with the daily benchmark return factors.<a class="headerlink" href="#write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors" title="Permalink to this heading">#</a></h5>
<p><em><strong>See advanced solution below.</strong></em>
I had planned this as an in-class exercise, but decided to spend more time on the earnings surprise exercise.</p>
</section>
<section id="download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings">
<h5>Download earnings per share for the stocks in <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and combine to a long data frame <code class="docutils literal notranslate"><span class="pre">earnings</span></code>.<a class="headerlink" href="#download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings" title="Permalink to this heading">#</a></h5>
<p>Use the <code class="docutils literal notranslate"><span class="pre">.earnings_dates</span></code> method described <a class="reference external" href="https://pypi.org/project/yfinance/">here</a>.
Use <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code> to combine the result of each the <code class="docutils literal notranslate"><span class="pre">.earnings_date</span></code> data frames and assign them to a new data frame <code class="docutils literal notranslate"><span class="pre">earnings</span></code>.
Name the row indexes <code class="docutils literal notranslate"><span class="pre">Ticker</span></code> and <code class="docutils literal notranslate"><span class="pre">Date</span></code> and swap to match the order of the row index in <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># some students had to update yfinance to use the .earnings_dates atrtibute</span>
<span class="c1"># %pip install -U yfinance</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="s1">&#39;BAC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
    </tr>
    <tr>
      <th>Earnings Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-01-11 08:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-10-17 08:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">earnings</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">tickers</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">earnings</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-01-11 08:00:00-05:00</th>
      <th>BAC</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-10-17 08:00:00-04:00</th>
      <th>BAC</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="combine-earnings-with-the-returns-from-stocks-long">
<h5>Combine <code class="docutils literal notranslate"><span class="pre">earnings</span></code> with the returns from <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code>.<a class="headerlink" href="#combine-earnings-with-the-returns-from-stocks-long" title="Permalink to this heading">#</a></h5>
<p><em><strong>It is easier to leave <code class="docutils literal notranslate"><span class="pre">stocks</span></code> and <code class="docutils literal notranslate"><span class="pre">stocks_long</span></code> as-is and work with slices <code class="docutils literal notranslate"><span class="pre">returns</span></code> and <code class="docutils literal notranslate"><span class="pre">returns_long</span></code>.</strong></em>
Use the <code class="docutils literal notranslate"><span class="pre">tz_localize('America/New_York')</span></code> method add time zone information back to <code class="docutils literal notranslate"><span class="pre">returns.index</span></code> and use <code class="docutils literal notranslate"><span class="pre">pd.to_timedelta(16,</span> <span class="pre">unit='h')</span></code> to set time to the market close in New York City.
Use <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_asof.html"><code class="docutils literal notranslate"><span class="pre">pd.merge_asof()</span></code></a> to match earnings announcement dates and times to appropriate return periods.
For example, if a firm announces earnings after the close at 5 PM on February 7, we want to match the return period from 4 PM on February 7 to 4 PM on February 8.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">]</span>
<span class="n">returns</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
<span class="n">returns_long</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span>
<span class="n">returns_long</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Returns</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1973-02-22 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0034</td>
    </tr>
    <tr>
      <th>1973-02-23 16:00:00-05:00</th>
      <th>BAC</th>
      <td>-0.0034</td>
    </tr>
    <tr>
      <th>1973-02-26 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1973-02-27 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1973-02-28 16:00:00-05:00</th>
      <th>BAC</th>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">earnings</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">returns_long</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
        <span class="n">allow_exact_matches</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">surprises</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
      <th>Returns</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-14 03:00:00-04:00</th>
      <th>GS</th>
      <td>10.2200</td>
      <td>18.6000</td>
      <td>0.8194</td>
      <td>0.0234</td>
    </tr>
    <tr>
      <th>2021-04-16 03:00:00-04:00</th>
      <th>MS</th>
      <td>1.7000</td>
      <td>2.1900</td>
      <td>0.2890</td>
      <td>-0.0276</td>
    </tr>
    <tr>
      <th>2021-07-13 03:00:00-04:00</th>
      <th>GS</th>
      <td>10.2400</td>
      <td>15.0200</td>
      <td>0.4668</td>
      <td>-0.0119</td>
    </tr>
    <tr>
      <th>2021-07-15 03:00:00-04:00</th>
      <th>MS</th>
      <td>1.6500</td>
      <td>1.8500</td>
      <td>0.1185</td>
      <td>0.0018</td>
    </tr>
    <tr>
      <th>2021-10-14 03:00:00-04:00</th>
      <th>MS</th>
      <td>1.6900</td>
      <td>1.9800</td>
      <td>0.1751</td>
      <td>0.0248</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
      <th>Returns</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>EPS Estimate</th>
      <td>1.0000</td>
      <td>0.9444</td>
      <td>0.3620</td>
      <td>-0.2142</td>
    </tr>
    <tr>
      <th>Reported EPS</th>
      <td>0.9444</td>
      <td>1.0000</td>
      <td>0.6171</td>
      <td>-0.0615</td>
    </tr>
    <tr>
      <th>Surprise(%)</th>
      <td>0.3620</td>
      <td>0.6171</td>
      <td>1.0000</td>
      <td>0.4397</td>
    </tr>
    <tr>
      <th>Returns</th>
      <td>-0.2142</td>
      <td>-0.0615</td>
      <td>0.4397</td>
      <td>1.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="plot-the-relation-between-daily-returns-and-earnings-surprises">
<h5>Plot the relation between daily returns and earnings surprises<a class="headerlink" href="#plot-the-relation-between-daily-returns-and-earnings-surprises" title="Permalink to this heading">#</a></h5>
<p>Three options in increasing difficulty:</p>
<ol class="arabic simple">
<li><p>Scatter plot</p></li>
<li><p>Scatter plot with a best-fit line using <code class="docutils literal notranslate"><span class="pre">regplot()</span></code> from the seaborn package</p></li>
<li><p>Bar plot using <code class="docutils literal notranslate"><span class="pre">barplot()</span></code> from the seaborn package after using <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> to form five groups on earnings surprises</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">surprises</span>
    <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">__</span> <span class="o">=</span> <span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6036190385fcfd813d2f320098a9f90ae11625e3bb4f1e32f1104d20aaa25966.png" src="_images/6036190385fcfd813d2f320098a9f90ae11625e3bb4f1e32f1104d20aaa25966.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span> <span class="s1">&#39;Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">surprises</span><span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">__</span> <span class="o">=</span> <span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dc1ca221051ce4ce030134b7024344be192a02c46806937ccd8cd7f2947c9654.png" src="_images/dc1ca221051ce4ce030134b7024344be192a02c46806937ccd8cd7f2947c9654.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises</span><span class="p">[</span><span class="s1">&#39;ESQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">surprises</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ESQ&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span> <span class="s1">&#39;Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
        <span class="n">surprises</span>
        <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ESQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">__</span> <span class="o">=</span> <span class="n">surprises</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a80d0270dc1479b187d29731d35f264e28734c5b7c6dce2c31830f489c01a710.png" src="_images/a80d0270dc1479b187d29731d35f264e28734c5b7c6dce2c31830f489c01a710.png" />
</div>
</div>
<p><em><strong>There is a positive relation between announcment returns and earnings surprises!</strong></em>
Of course, to say more we need more data and to control for market movements, but this analaysis is a start!</p>
</section>
<section id="repeat-the-earnings-exercise-with-the-s-p-100-stocks">
<h5>Repeat the earnings exercise with the S&amp;P 100 stocks<a class="headerlink" href="#repeat-the-earnings-exercise-with-the-s-p-100-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/S%26P_100&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symbols</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers_2</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">symbols</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tickers_2</span>
    <span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">returns_2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>ABBV</th>
      <th>ABT</th>
      <th>ACN</th>
      <th>ADBE</th>
      <th>AIG</th>
      <th>AMD</th>
      <th>AMGN</th>
      <th>AMT</th>
      <th>AMZN</th>
      <th>...</th>
      <th>UNH</th>
      <th>UNP</th>
      <th>UPS</th>
      <th>USB</th>
      <th>V</th>
      <th>VZ</th>
      <th>WBA</th>
      <th>WFC</th>
      <th>WMT</th>
      <th>XOM</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1962-01-02 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1962-01-03 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0149</td>
    </tr>
    <tr>
      <th>1962-01-04 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0024</td>
    </tr>
    <tr>
      <th>1962-01-05 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0219</td>
    </tr>
    <tr>
      <th>1962-01-08 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0025</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 101 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">earnings_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">tickers_2</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">earnings_dates</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers_2</span><span class="o">.</span><span class="n">tickers</span><span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">tickers_2</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">earnings_2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>EPS Estimate</th>
      <th>Reported EPS</th>
      <th>Surprise(%)</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">AAPL</th>
      <th>2024-01-31 16:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2024-01-31 05:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-10-25 06:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-07-26 16:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2023-04-26 06:00:00-04:00</th>
      <td>1.4300</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">earnings_2</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
        <span class="n">allow_exact_matches</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ESQ&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span> <span class="s1">&#39;Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
        <span class="n">surprises_2</span>
        <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ESQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Return (%)&#39;</span><span class="p">)</span>

<span class="n">__</span> <span class="o">=</span> <span class="n">surprises_2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements for S&amp;P 100 Stocks </span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/55dd04017f0e88f20e021110b03dcd8f474ab8365abd21c508a3586830e1b664.png" src="_images/55dd04017f0e88f20e021110b03dcd8f474ab8365abd21c508a3586830e1b664.png" />
</div>
</div>
</section>
<section id="repeat-the-earnings-exercise-with-excess-returns-of-the-s-p-100-stocks">
<h5>Repeat the earnings exercise with <em>excess returns</em> of the S&amp;P 100 Stocks<a class="headerlink" href="#repeat-the-earnings-exercise-with-excess-returns-of-the-s-p-100-stocks" title="Permalink to this heading">#</a></h5>
<p>Excess returns are returns minus market returns.
We need to add a timezone and the closing time to the market return from Fama and French.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Mkt</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span>
<span class="n">Mkt</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">Mkt</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
<span class="n">returns_3</span> <span class="o">=</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">Mkt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surprises_3</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">earnings_2</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">returns_3</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Excess Returns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">]),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
        <span class="n">allow_exact_matches</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ESQ&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Excess Returns&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span>
        <span class="n">surprises_3</span>
        <span class="p">[[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;Excess Returns&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ESQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Surprise(%)&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Earnings Suprise Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Announcement Excess Return (%)&#39;</span><span class="p">)</span>

<span class="n">__</span> <span class="o">=</span> <span class="n">surprises_3</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Earnings Announcements for S&amp;P 100 Stocks</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">__</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">%B %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/04b2e7f0e79a9ade61cd3035cee7ac3cc2afe13377ce408628b1e0f53124d2c4.png" src="_images/04b2e7f0e79a9ade61cd3035cee7ac3cc2afe13377ce408628b1e0f53124d2c4.png" />
</div>
</div>
</section>
<section id="improve-your-download-function-from-above">
<h5>Improve your <code class="docutils literal notranslate"><span class="pre">download()</span></code> function from above<a class="headerlink" href="#improve-your-download-function-from-above" title="Permalink to this heading">#</a></h5>
<p>Modify <code class="docutils literal notranslate"><span class="pre">download()</span></code> to accept one or more than one ticker.
Since we will not use the advanced functionality of the tickers object that <code class="docutils literal notranslate"><span class="pre">yf.Tickers()</span></code> creates, we will use <code class="docutils literal notranslate"><span class="pre">yf.download()</span></code>.
The current version of <code class="docutils literal notranslate"><span class="pre">yf.download()</span></code> does not accept a <code class="docutils literal notranslate"><span class="pre">session=</span></code> argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">):</span>

    <span class="n">histories</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">factors</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="n">histories</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Factors&#39;</span><span class="p">],</span> <span class="n">factors</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="n">histories</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">factors</span>

        <span class="k">return</span> <span class="n">histories</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">histories</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">histories</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  1 of 1 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>0.1283</td>
      <td>0.1289</td>
      <td>0.1283</td>
      <td>0.1283</td>
      <td>0.0997</td>
      <td>469033600</td>
      <td>0.0138</td>
      <td>-0.0001</td>
      <td>-0.0105</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>0.1222</td>
      <td>0.1222</td>
      <td>0.1217</td>
      <td>0.1217</td>
      <td>0.0945</td>
      <td>175884800</td>
      <td>0.0011</td>
      <td>0.0025</td>
      <td>-0.0046</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>0.1133</td>
      <td>0.1133</td>
      <td>0.1127</td>
      <td>0.1127</td>
      <td>0.0876</td>
      <td>105728000</td>
      <td>0.0071</td>
      <td>-0.0075</td>
      <td>-0.0047</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.1155</td>
      <td>0.1161</td>
      <td>0.1155</td>
      <td>0.1155</td>
      <td>0.0897</td>
      <td>86441600</td>
      <td>0.0152</td>
      <td>-0.0086</td>
      <td>-0.0034</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.1189</td>
      <td>0.1194</td>
      <td>0.1189</td>
      <td>0.1189</td>
      <td>0.0924</td>
      <td>73449600</td>
      <td>0.0041</td>
      <td>0.0022</td>
      <td>0.0126</td>
      <td>0.0006</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;AAPL TSLA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  2 of 2 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="2" halign="left">Adj Close</th>
      <th colspan="2" halign="left">Close</th>
      <th colspan="2" halign="left">High</th>
      <th colspan="2" halign="left">Low</th>
      <th colspan="2" halign="left">Open</th>
      <th colspan="2" halign="left">Volume</th>
      <th colspan="2" halign="left">Returns</th>
      <th colspan="4" halign="left">Factors</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>TSLA</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>0.0997</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>0.1289</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>469033600</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0138</td>
      <td>-0.0001</td>
      <td>-0.0105</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>0.0945</td>
      <td>NaN</td>
      <td>0.1217</td>
      <td>NaN</td>
      <td>0.1222</td>
      <td>NaN</td>
      <td>0.1217</td>
      <td>NaN</td>
      <td>0.1222</td>
      <td>NaN</td>
      <td>175884800</td>
      <td>NaN</td>
      <td>-0.0522</td>
      <td>NaN</td>
      <td>0.0011</td>
      <td>0.0025</td>
      <td>-0.0046</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>0.0876</td>
      <td>NaN</td>
      <td>0.1127</td>
      <td>NaN</td>
      <td>0.1133</td>
      <td>NaN</td>
      <td>0.1127</td>
      <td>NaN</td>
      <td>0.1133</td>
      <td>NaN</td>
      <td>105728000</td>
      <td>NaN</td>
      <td>-0.0734</td>
      <td>NaN</td>
      <td>0.0071</td>
      <td>-0.0075</td>
      <td>-0.0047</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.0897</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>0.1161</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>86441600</td>
      <td>NaN</td>
      <td>0.0248</td>
      <td>NaN</td>
      <td>0.0152</td>
      <td>-0.0086</td>
      <td>-0.0034</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.0924</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>0.1194</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>73449600</td>
      <td>NaN</td>
      <td>0.0290</td>
      <td>NaN</td>
      <td>0.0041</td>
      <td>0.0022</td>
      <td>0.0126</td>
      <td>0.0006</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-mckinney_10_lecture"></span><section id="mckinney-chapter-10-data-aggregation-and-group-operations">
<h2>McKinney Chapter 10 - Data Aggregation and Group Operations<a class="headerlink" href="#mckinney-chapter-10-data-aggregation-and-group-operations" title="Permalink to this heading">#</a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h3>
<p>Chapter 10 of Wes McKinney’s <a class="reference external" href="https://wesmckinney.com/book/"><em>Python for Data Analysis</em></a> discusses groupby operations, which are the pandas equivalent of Excel pivot tables.
Pivot tables help us calculate statistics (e.g., sum, mean, and median) for one set of variables by groups of other variables (e.g., weekday or ticker).
For example, we could use a pivot table to calculate mean daily stock returns by weekday.</p>
<p>We will focus on:</p>
<ol class="arabic simple">
<li><p>Using <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> to group by columns, indexes, and functions</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">.agg()</span></code> to aggregate multiple functions</p></li>
<li><p>Using pivot tables as an alternative to <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code></p></li>
</ol>
<p><em><strong>Note:</strong></em>
Indented block quotes are from McKinney unless otherwise indicated.
The section numbers here differ from McKinney because we will only discuss some topics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="groupby-mechanics">
<h3>GroupBy Mechanics<a class="headerlink" href="#groupby-mechanics" title="Permalink to this heading">#</a></h3>
<p>“Split-apply-combine” is an excellent way to describe and visualize pandas groupby operations.</p>
<blockquote>
<div><p>Hadley Wickham, an author of many popular packages for the R programming
language, coined the term split-apply-combine for describing group operations. In the
first stage of the process, data contained in a pandas object, whether a Series, DataFrame, or otherwise, is split into groups based on one or more keys that you provide.
The splitting is performed on a particular axis of an object. For example, a DataFrame
can be grouped on its rows (axis=0) or its columns (axis=1). Once this is done, a
function is applied to each group, producing a new value. Finally, the results of all
those function applications are combined into a result object. The form of the resulting object will usually depend on what’s being done to the data. See Figure 10-1 for a
mockup of a simple group aggregation.</p>
</div></blockquote>
<p>Figure 10-1 visualizes a split-apply-combine operation that:</p>
<ol class="arabic simple">
<li><p>Splits by the <code class="docutils literal notranslate"><span class="pre">key</span></code> column (i.e., “groups by <code class="docutils literal notranslate"><span class="pre">key</span></code>”)</p></li>
<li><p>Applies the sum operation to the <code class="docutils literal notranslate"><span class="pre">data</span></code> column (i.e., “and sums <code class="docutils literal notranslate"><span class="pre">data</span></code>”)</p></li>
<li><p>Combines the grouped sums</p></li>
</ol>
<p>I describe this operation as “sum the <code class="docutils literal notranslate"><span class="pre">data</span></code> column by groups formed on the <code class="docutils literal notranslate"><span class="pre">key</span></code> column.”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key1&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;key2&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;data1&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
                   <span class="s1">&#39;data2&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">)})</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key1</th>
      <th>key2</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>a</td>
      <td>one</td>
      <td>0.4967</td>
      <td>-0.2341</td>
    </tr>
    <tr>
      <th>1</th>
      <td>a</td>
      <td>two</td>
      <td>-0.1383</td>
      <td>1.5792</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b</td>
      <td>one</td>
      <td>0.6477</td>
      <td>0.7674</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b</td>
      <td>two</td>
      <td>1.5230</td>
      <td>-0.4695</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>one</td>
      <td>-0.2342</td>
      <td>0.5426</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Here is one way to calculate the means of <code class="docutils literal notranslate"><span class="pre">data1</span></code> by groups formed on <code class="docutils literal notranslate"><span class="pre">key1</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0414
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0854
</pre></div>
</div>
</div>
</div>
<p>We can do this calculation more quickly!</p>
<ol class="arabic simple">
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method to group by <code class="docutils literal notranslate"><span class="pre">key1</span></code></p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> method to sum <code class="docutils literal notranslate"><span class="pre">data1</span></code> within each value of <code class="docutils literal notranslate"><span class="pre">key1</span></code></p></li>
</ol>
<p>Note that without the <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> method, pandas only sets up the grouped object, which can accept the <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">])</span>
<span class="n">grouped</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;pandas.core.groupby.generic.SeriesGroupBy object at 0x7f7fbf0ccca0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>key1
a   0.0414
b   1.0854
Name: data1, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We can can chain the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> and <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> methods!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>key1
a   0.0414
b   1.0854
Name: data1, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>If we prefer our result as a dataframe instead of a series, we can wrap <code class="docutils literal notranslate"><span class="pre">data1</span></code> with two sets of square brackets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;data1&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>data1</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.0414</td>
    </tr>
    <tr>
      <th>b</th>
      <td>1.0854</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can group by more than one variable.
We get a hierarchical row index (or row multi-index) when we group by more than one variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">means</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;key2&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">means</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>key1  key2
a     one     0.1313
      two    -0.1383
b     one     0.6477
      two     1.5230
Name: data1, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.unstack()</span></code> method if we want to use both rows and columns to organize data.
Recall the <code class="docutils literal notranslate"><span class="pre">.unstack()</span></code> method un-stacks the inner index level (i.e., <code class="docutils literal notranslate"><span class="pre">level</span> <span class="pre">=</span> <span class="pre">-1</span></code>) by default so that <code class="docutils literal notranslate"><span class="pre">key2</span></code> values become the columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">means</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>key2</th>
      <th>one</th>
      <th>two</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.1313</td>
      <td>-0.1383</td>
    </tr>
    <tr>
      <th>b</th>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The grouping variables can be columns in the data frame we want to group with the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method.
Our grouping variables are typically columns in the data frame we want to group, so this syntax is more compact and easier to understand.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>data1</th>
      <th>data2</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.0414</td>
      <td>0.6292</td>
    </tr>
    <tr>
      <th>b</th>
      <td>1.0854</td>
      <td>0.1490</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;key1&#39;</span><span class="p">,</span> <span class="s1">&#39;key2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>data1</th>
      <th>data2</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>one</th>
      <td>0.1313</td>
      <td>0.1542</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.1383</td>
      <td>1.5792</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>one</th>
      <td>0.6477</td>
      <td>0.7674</td>
    </tr>
    <tr>
      <th>two</th>
      <td>1.5230</td>
      <td>-0.4695</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can use tab completion to reminder ourselves of methods we can apply to grouped series and data frames.</p>
<section id="iterating-over-groups">
<h4>Iterating Over Groups<a class="headerlink" href="#iterating-over-groups" title="Permalink to this heading">#</a></h4>
<p>We can iterate over groups, too, because the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method generates a sequence of tuples.
Each tuples contains the value(s) of the grouping variable(s) and its chunk of the dataframe.
McKinney provides two loops to show how to iterate over groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a
  key1 key2   data1   data2
0    a  one  0.4967 -0.2341
1    a  two -0.1383  1.5792
4    a  one -0.2342  0.5426
b
  key1 key2  data1   data2
2    b  one 0.6477  0.7674
3    b  two 1.5230 -0.4695
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">),</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;key1&#39;</span><span class="p">,</span> <span class="s1">&#39;key2&#39;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">((</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">),</span> <span class="n">group</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;a&#39;, &#39;one&#39;)
  key1 key2   data1   data2
0    a  one  0.4967 -0.2341
4    a  one -0.2342  0.5426
(&#39;a&#39;, &#39;two&#39;)
  key1 key2   data1  data2
1    a  two -0.1383 1.5792
(&#39;b&#39;, &#39;one&#39;)
  key1 key2  data1  data2
2    b  one 0.6477 0.7674
(&#39;b&#39;, &#39;two&#39;)
  key1 key2  data1   data2
3    b  two 1.5230 -0.4695
</pre></div>
</div>
</div>
</div>
</section>
<section id="selecting-a-column-or-subset-of-columns">
<h4>Selecting a Column or Subset of Columns<a class="headerlink" href="#selecting-a-column-or-subset-of-columns" title="Permalink to this heading">#</a></h4>
<p>We preview the idea of grouping an entire dataframe above.
However, I want to explain McKinney’s use of the phrase “syntactic sugar.”
Here is the context:</p>
<blockquote>
<div><p>Indexing a GroupBy object created from a DataFrame with a column name or array
of column names has the effect of column subsetting for aggregation. This means
that:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)[[</span><span class="s1">&#39;data2&#39;</span><span class="p">]]</span>
</pre></div>
</div>
<p>are syntactic sugar for</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[[</span><span class="s1">&#39;data2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
<p>“Syntactic sugar” makes code easier to type or read without adding functionality.
It makes code “sweeter” for humans to type or read by making it more concise or clear.
The implication is that syntactic sugar makes code faster to type/read but does make code faster to execute.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;key1&#39;</span><span class="p">,</span> <span class="s1">&#39;key2&#39;</span><span class="p">])[[</span><span class="s1">&#39;data2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>data2</th>
    </tr>
    <tr>
      <th>key1</th>
      <th>key2</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>one</th>
      <td>0.1542</td>
    </tr>
    <tr>
      <th>two</th>
      <td>1.5792</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>one</th>
      <td>0.7674</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.4695</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="grouping-with-functions">
<h4>Grouping with Functions<a class="headerlink" href="#grouping-with-functions" title="Permalink to this heading">#</a></h4>
<p>We can also group with functions.
Below, we group with the <code class="docutils literal notranslate"><span class="pre">len</span></code> function, which calculates the length of the first names in the row index.
We could instead add a helper column to <code class="docutils literal notranslate"><span class="pre">people</span></code>, but it is easier to pass a function to <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">people</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> 
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">],</span> 
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Joe&#39;</span><span class="p">,</span> <span class="s1">&#39;Steve&#39;</span><span class="p">,</span> <span class="s1">&#39;Wes&#39;</span><span class="p">,</span> <span class="s1">&#39;Jim&#39;</span><span class="p">,</span> <span class="s1">&#39;Travis&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">people</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Joe</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
      <td>-0.2342</td>
    </tr>
    <tr>
      <th>Steve</th>
      <td>-0.2341</td>
      <td>1.5792</td>
      <td>0.7674</td>
      <td>-0.4695</td>
      <td>0.5426</td>
    </tr>
    <tr>
      <th>Wes</th>
      <td>-0.4634</td>
      <td>-0.4657</td>
      <td>0.2420</td>
      <td>-1.9133</td>
      <td>-1.7249</td>
    </tr>
    <tr>
      <th>Jim</th>
      <td>-0.5623</td>
      <td>-1.0128</td>
      <td>0.3142</td>
      <td>-0.9080</td>
      <td>-1.4123</td>
    </tr>
    <tr>
      <th>Travis</th>
      <td>1.4656</td>
      <td>-0.2258</td>
      <td>0.0675</td>
      <td>-1.4247</td>
      <td>-0.5444</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">people</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>-0.5290</td>
      <td>-1.6168</td>
      <td>1.2039</td>
      <td>-1.2983</td>
      <td>-3.3714</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-0.2341</td>
      <td>1.5792</td>
      <td>0.7674</td>
      <td>-0.4695</td>
      <td>0.5426</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1.4656</td>
      <td>-0.2258</td>
      <td>0.0675</td>
      <td>-1.4247</td>
      <td>-0.5444</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can mix functions, lists, dictionaries, etc. that we pass to <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">]</span>
<span class="n">people</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="nb">len</span><span class="p">,</span> <span class="n">key_list</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">3</th>
      <th>one</th>
      <td>-0.4634</td>
      <td>-0.4657</td>
      <td>0.2420</td>
      <td>-1.9133</td>
      <td>-1.7249</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.5623</td>
      <td>-1.0128</td>
      <td>0.3142</td>
      <td>-0.9080</td>
      <td>-1.4123</td>
    </tr>
    <tr>
      <th>5</th>
      <th>one</th>
      <td>-0.2341</td>
      <td>1.5792</td>
      <td>0.7674</td>
      <td>-0.4695</td>
      <td>0.5426</td>
    </tr>
    <tr>
      <th>6</th>
      <th>two</th>
      <td>1.4656</td>
      <td>-0.2258</td>
      <td>0.0675</td>
      <td>-1.4247</td>
      <td>-0.5444</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Joe&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;Jim&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">}</span>
<span class="n">people</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="nb">len</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">3</th>
      <th>a</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
      <td>-0.2342</td>
    </tr>
    <tr>
      <th>b</th>
      <td>-0.5623</td>
      <td>-1.0128</td>
      <td>0.3142</td>
      <td>-0.9080</td>
      <td>-1.4123</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d_2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Joe&#39;</span><span class="p">:</span> <span class="s1">&#39;Cool&#39;</span><span class="p">,</span> <span class="s1">&#39;Jim&#39;</span><span class="p">:</span> <span class="s1">&#39;Nerd&#39;</span><span class="p">,</span> <span class="s1">&#39;Travis&#39;</span><span class="p">:</span> <span class="s1">&#39;Cool&#39;</span><span class="p">}</span>
<span class="n">people</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="nb">len</span><span class="p">,</span> <span class="n">d_2</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>a</th>
      <th>b</th>
      <th>c</th>
      <th>d</th>
      <th>e</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">3</th>
      <th>Cool</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
      <td>-0.2342</td>
    </tr>
    <tr>
      <th>Nerd</th>
      <td>-0.5623</td>
      <td>-1.0128</td>
      <td>0.3142</td>
      <td>-0.9080</td>
      <td>-1.4123</td>
    </tr>
    <tr>
      <th>6</th>
      <th>Cool</th>
      <td>1.4656</td>
      <td>-0.2258</td>
      <td>0.0675</td>
      <td>-1.4247</td>
      <td>-0.5444</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="grouping-by-index-levels">
<h4>Grouping by Index Levels<a class="headerlink" href="#grouping-by-index-levels" title="Permalink to this heading">#</a></h4>
<p>We can also group by index levels.
We can specify index levels by either level number or name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([[</span><span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="s1">&#39;JP&#39;</span><span class="p">,</span> <span class="s1">&#39;JP&#39;</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
                                    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cty&#39;</span><span class="p">,</span> <span class="s1">&#39;tenor&#39;</span><span class="p">])</span>
<span class="n">hier_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

<span class="n">hier_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>cty</th>
      <th colspan="3" halign="left">US</th>
      <th colspan="2" halign="left">JP</th>
    </tr>
    <tr>
      <th>tenor</th>
      <th>1</th>
      <th>3</th>
      <th>5</th>
      <th>1</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.1109</td>
      <td>-1.1510</td>
      <td>0.3757</td>
      <td>-0.6006</td>
      <td>-0.2917</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.6017</td>
      <td>1.8523</td>
      <td>-0.0135</td>
      <td>-1.0577</td>
      <td>0.8225</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-1.2208</td>
      <td>0.2089</td>
      <td>-1.9597</td>
      <td>-1.3282</td>
      <td>0.1969</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.7385</td>
      <td>0.1714</td>
      <td>-0.1156</td>
      <td>-0.3011</td>
      <td>-1.4785</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hier_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;cty&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>cty</th>
      <th>JP</th>
      <th>US</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hier_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;cty&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>cty</th>
      <th>JP</th>
      <th>US</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hier_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;tenor&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>tenor</th>
      <th>1</th>
      <th>3</th>
      <th>5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>2</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="data-aggregation">
<h3>Data Aggregation<a class="headerlink" href="#data-aggregation" title="Permalink to this heading">#</a></h3>
<p>Table 10-1 provides the optimized groupby methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">count</span></code>: Number of non-NA values in the group</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sum</span></code>: Sum of non-NA values</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mean</span></code>: Mean of non-NA values</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">median</span></code>: Arithmetic median of non-NA values</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">std</span></code>, <code class="docutils literal notranslate"><span class="pre">var</span></code>: Unbiased (n – 1 denominator) standard deviation and variance</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code>: Minimum and maximum of non-NA values</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prod</span></code>: Product of non-NA values</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">first</span></code>, <code class="docutils literal notranslate"><span class="pre">last</span></code>: First and last non-NA values</p></li>
</ul>
<p>These optimized methods are fast and efficient, but pandas lets us use other, non-optimized methods.
First, any series method is available.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>key1
a   0.3697
b   1.4355
Name: data1, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Second, we can write our own functions and pass them to the <code class="docutils literal notranslate"><span class="pre">.agg()</span></code> method.
These functions should accept an array and returns a single value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">max_minus_min</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">,</span> <span class="s1">&#39;data1&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key1</th>
      <th>key2</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>a</td>
      <td>one</td>
      <td>-0.2342</td>
      <td>0.5426</td>
    </tr>
    <tr>
      <th>1</th>
      <td>a</td>
      <td>two</td>
      <td>-0.1383</td>
      <td>1.5792</td>
    </tr>
    <tr>
      <th>0</th>
      <td>a</td>
      <td>one</td>
      <td>0.4967</td>
      <td>-0.2341</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b</td>
      <td>one</td>
      <td>0.6477</td>
      <td>0.7674</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b</td>
      <td>two</td>
      <td>1.5230</td>
      <td>-0.4695</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">max_minus_min</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>key1
a   0.7309
b   0.8753
Name: data1, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Some other methods work, too, even if they are do not aggregate an array to a single value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>3.0000</td>
      <td>0.0414</td>
      <td>0.3972</td>
      <td>-0.2342</td>
      <td>-0.1862</td>
      <td>-0.1383</td>
      <td>0.1792</td>
      <td>0.4967</td>
    </tr>
    <tr>
      <th>b</th>
      <td>2.0000</td>
      <td>1.0854</td>
      <td>0.6190</td>
      <td>0.6477</td>
      <td>0.8665</td>
      <td>1.0854</td>
      <td>1.3042</td>
      <td>1.5230</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="column-wise-and-multiple-function-application">
<h4>Column-Wise and Multiple Function Application<a class="headerlink" href="#column-wise-and-multiple-function-application" title="Permalink to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">.agg()</span></code> methods provides two more handy features:</p>
<ol class="arabic simple">
<li><p>We can pass multiple functions to operate on all of the columns</p></li>
<li><p>We can pass specific functions to operate on specific columns</p></li>
</ol>
<p>Here is an example with multiple functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>median</th>
      <th>min</th>
      <th>max</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.0414</td>
      <td>-0.1383</td>
      <td>-0.2342</td>
      <td>0.4967</td>
    </tr>
    <tr>
      <th>b</th>
      <td>1.0854</td>
      <td>1.0854</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)[[</span><span class="s1">&#39;data1&#39;</span><span class="p">,</span> <span class="s1">&#39;data2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="4" halign="left">data1</th>
      <th colspan="4" halign="left">data2</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>median</th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
      <th>min</th>
      <th>max</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.0414</td>
      <td>-0.1383</td>
      <td>-0.2342</td>
      <td>0.4967</td>
      <td>0.6292</td>
      <td>0.5426</td>
      <td>-0.2341</td>
      <td>1.5792</td>
    </tr>
    <tr>
      <th>b</th>
      <td>1.0854</td>
      <td>1.0854</td>
      <td>0.6477</td>
      <td>1.5230</td>
      <td>0.1490</td>
      <td>0.1490</td>
      <td>-0.4695</td>
      <td>0.7674</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>What if I wanted to calculate the mean of <code class="docutils literal notranslate"><span class="pre">data1</span></code> and the median of <code class="docutils literal notranslate"><span class="pre">data2</span></code> by <code class="docutils literal notranslate"><span class="pre">key1</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="s1">&#39;median&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>data1</th>
      <th>data2</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.0414</td>
      <td>0.5426</td>
    </tr>
    <tr>
      <th>b</th>
      <td>1.0854</td>
      <td>0.1490</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>What if I wanted to calculate the mean <em>and standard deviation</em> of <code class="docutils literal notranslate"><span class="pre">data1</span></code> and the median of <code class="docutils literal notranslate"><span class="pre">data2</span></code> by <code class="docutils literal notranslate"><span class="pre">key1</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="s1">&#39;median&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left">data1</th>
      <th>data2</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>median</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.0414</td>
      <td>0.3972</td>
      <td>0.5426</td>
    </tr>
    <tr>
      <th>b</th>
      <td>1.0854</td>
      <td>0.6190</td>
      <td>0.1490</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="apply-general-split-apply-combine">
<h3>Apply: General split-apply-combine<a class="headerlink" href="#apply-general-split-apply-combine" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.agg()</span></code> method aggrates an array to a single value.
We can use the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method for more general calculations.</p>
<p>We can combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> and <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> methods to:</p>
<ol class="arabic simple">
<li><p>Split a dataframe by grouping variables</p></li>
<li><p>Call the applied function on each chunk of the original dataframe</p></li>
<li><p>Recombine the output of the applied function</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">top</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;data1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>key1</th>
      <th>key2</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <th>4</th>
      <td>a</td>
      <td>one</td>
      <td>-0.2342</td>
      <td>0.5426</td>
    </tr>
    <tr>
      <th>b</th>
      <th>2</th>
      <td>b</td>
      <td>one</td>
      <td>0.6477</td>
      <td>0.7674</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;data1&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>key1</th>
      <th>key2</th>
      <th>data1</th>
      <th>data2</th>
    </tr>
    <tr>
      <th>key1</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">a</th>
      <th>4</th>
      <td>a</td>
      <td>one</td>
      <td>-0.2342</td>
      <td>0.5426</td>
    </tr>
    <tr>
      <th>1</th>
      <td>a</td>
      <td>two</td>
      <td>-0.1383</td>
      <td>1.5792</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">b</th>
      <th>2</th>
      <td>b</td>
      <td>one</td>
      <td>0.6477</td>
      <td>0.7674</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b</td>
      <td>two</td>
      <td>1.5230</td>
      <td>-0.4695</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="pivot-tables-and-cross-tabulation">
<h3>Pivot Tables and Cross-Tabulation<a class="headerlink" href="#pivot-tables-and-cross-tabulation" title="Permalink to this heading">#</a></h3>
<p>Above we manually made pivot tables with the <code class="docutils literal notranslate"><span class="pre">groupby()</span></code>, <code class="docutils literal notranslate"><span class="pre">.agg()</span></code>, <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> and <code class="docutils literal notranslate"><span class="pre">.unstack()</span></code> methods.
pandas provides a literal interpreation of Excel-style pivot tables with the <code class="docutils literal notranslate"><span class="pre">.pivot_table()</span></code> method and the <code class="docutils literal notranslate"><span class="pre">pandas.pivot_table()</span></code> function.
These also provide row and column totals via “margins”.
It is worthwhile to read-through the <code class="docutils literal notranslate"><span class="pre">.pivot_table()</span></code> docstring several times.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;^GSPC ^DJI ^IXIC ^FTSE ^N225 ^HSI&#39;</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Index&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">ind</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-12-30 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1928-01-03 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.7600</td>
      <td>17.7600</td>
      <td>17.7600</td>
      <td>17.7600</td>
      <td>17.7600</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1928-01-04 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.7200</td>
      <td>17.7200</td>
      <td>17.7200</td>
      <td>17.7200</td>
      <td>17.7200</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1928-01-05 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.5500</td>
      <td>17.5500</td>
      <td>17.5500</td>
      <td>17.5500</td>
      <td>17.5500</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1928-01-06 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The default aggregation function for <code class="docutils literal notranslate"><span class="pre">.pivot_table()</span></code> is <code class="docutils literal notranslate"><span class="pre">mean</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2015&#39;</span><span class="p">:]</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>^DJI</th>
      <td>25452.9459</td>
      <td>25452.9459</td>
      <td>25592.6645</td>
      <td>25297.7994</td>
      <td>25450.0882</td>
      <td>309385044.8349</td>
    </tr>
    <tr>
      <th>^FTSE</th>
      <td>6978.1045</td>
      <td>6978.1045</td>
      <td>7019.7872</td>
      <td>6934.9874</td>
      <td>6977.4345</td>
      <td>805027770.8861</td>
    </tr>
    <tr>
      <th>^GSPC</th>
      <td>2998.5095</td>
      <td>2998.5095</td>
      <td>3014.9221</td>
      <td>2979.8820</td>
      <td>2998.1779</td>
      <td>4017399821.2018</td>
    </tr>
    <tr>
      <th>^HSI</th>
      <td>25086.5497</td>
      <td>25086.5497</td>
      <td>25250.8833</td>
      <td>24913.3281</td>
      <td>25102.2198</td>
      <td>1986284344.3556</td>
    </tr>
    <tr>
      <th>^IXIC</th>
      <td>8588.6746</td>
      <td>8588.6746</td>
      <td>8647.5013</td>
      <td>8521.5014</td>
      <td>8587.8332</td>
      <td>3064169027.3571</td>
    </tr>
    <tr>
      <th>^N225</th>
      <td>22464.4354</td>
      <td>22464.4354</td>
      <td>22583.6795</td>
      <td>22337.3847</td>
      <td>22466.5559</td>
      <td>95184340.3827</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2015&#39;</span><span class="p">:]</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Index&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>^DJI</th>
      <td>25410.0293</td>
      <td>25410.0293</td>
      <td>25551.5605</td>
      <td>25243.8809</td>
      <td>25388.0801</td>
      <td>295530000.0000</td>
    </tr>
    <tr>
      <th>^FTSE</th>
      <td>7117.8999</td>
      <td>7117.8999</td>
      <td>7157.6001</td>
      <td>7075.3000</td>
      <td>7117.2500</td>
      <td>761379050.0000</td>
    </tr>
    <tr>
      <th>^GSPC</th>
      <td>2808.4800</td>
      <td>2808.4800</td>
      <td>2821.2400</td>
      <td>2794.9900</td>
      <td>2809.3999</td>
      <td>3811730000.0000</td>
    </tr>
    <tr>
      <th>^HSI</th>
      <td>25246.0049</td>
      <td>25246.0049</td>
      <td>25426.9102</td>
      <td>25065.5693</td>
      <td>25274.1494</td>
      <td>1823411600.0000</td>
    </tr>
    <tr>
      <th>^IXIC</th>
      <td>7725.5898</td>
      <td>7725.5898</td>
      <td>7760.8301</td>
      <td>7665.2998</td>
      <td>7702.0498</td>
      <td>2263640000.0000</td>
    </tr>
    <tr>
      <th>^N225</th>
      <td>21847.0352</td>
      <td>21847.0352</td>
      <td>21955.6143</td>
      <td>21732.5146</td>
      <td>21863.8301</td>
      <td>80850000.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can use
<code class="docutils literal notranslate"><span class="pre">values</span></code> to select specific variables,
<code class="docutils literal notranslate"><span class="pre">pd.Grouper()</span></code> to sample different date windows,
and
<code class="docutils literal notranslate"><span class="pre">aggfunc</span></code> to select specific aggregation functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ind</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2015&#39;</span><span class="p">:]</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
        <span class="n">values</span><span class="o">=</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">),</span>
        <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Index&#39;</span><span class="p">,</span>
        <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="6" halign="left">min</th>
      <th colspan="6" halign="left">max</th>
    </tr>
    <tr>
      <th>Index</th>
      <th>^DJI</th>
      <th>^FTSE</th>
      <th>^GSPC</th>
      <th>^HSI</th>
      <th>^IXIC</th>
      <th>^N225</th>
      <th>^DJI</th>
      <th>^FTSE</th>
      <th>^GSPC</th>
      <th>^HSI</th>
      <th>^IXIC</th>
      <th>^N225</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-12-31 00:00:00+00:00</th>
      <td>15666.4404</td>
      <td>5874.1001</td>
      <td>1867.6100</td>
      <td>20556.5996</td>
      <td>4506.4902</td>
      <td>16795.9609</td>
      <td>18312.3906</td>
      <td>7104.0000</td>
      <td>2130.8201</td>
      <td>28442.7500</td>
      <td>5218.8599</td>
      <td>20868.0293</td>
    </tr>
    <tr>
      <th>2016-12-31 00:00:00+00:00</th>
      <td>15660.1797</td>
      <td>5537.0000</td>
      <td>1829.0800</td>
      <td>18319.5801</td>
      <td>4266.8398</td>
      <td>14952.0195</td>
      <td>19974.6191</td>
      <td>7142.7998</td>
      <td>2271.7200</td>
      <td>24099.6992</td>
      <td>5487.4399</td>
      <td>19494.5293</td>
    </tr>
    <tr>
      <th>2017-12-31 00:00:00+00:00</th>
      <td>19732.4004</td>
      <td>7099.2002</td>
      <td>2257.8301</td>
      <td>22134.4707</td>
      <td>5429.0801</td>
      <td>18335.6309</td>
      <td>24837.5098</td>
      <td>7687.7998</td>
      <td>2690.1599</td>
      <td>30003.4902</td>
      <td>6994.7598</td>
      <td>22939.1797</td>
    </tr>
    <tr>
      <th>2018-12-31 00:00:00+00:00</th>
      <td>21792.1992</td>
      <td>6584.7002</td>
      <td>2351.1001</td>
      <td>24585.5293</td>
      <td>6192.9199</td>
      <td>19155.7402</td>
      <td>26828.3906</td>
      <td>7877.5000</td>
      <td>2930.7500</td>
      <td>33154.1211</td>
      <td>8109.6899</td>
      <td>24270.6191</td>
    </tr>
    <tr>
      <th>2019-12-31 00:00:00+00:00</th>
      <td>22686.2207</td>
      <td>6692.7002</td>
      <td>2447.8899</td>
      <td>25064.3594</td>
      <td>6463.5000</td>
      <td>19561.9609</td>
      <td>28645.2598</td>
      <td>7686.6001</td>
      <td>3240.0200</td>
      <td>30157.4902</td>
      <td>9022.3896</td>
      <td>24066.1191</td>
    </tr>
    <tr>
      <th>2020-12-31 00:00:00+00:00</th>
      <td>18591.9297</td>
      <td>4993.8999</td>
      <td>2237.3999</td>
      <td>21696.1309</td>
      <td>6860.6699</td>
      <td>16552.8301</td>
      <td>30606.4805</td>
      <td>7674.6001</td>
      <td>3756.0701</td>
      <td>29056.4199</td>
      <td>12899.4199</td>
      <td>27568.1504</td>
    </tr>
    <tr>
      <th>2021-12-31 00:00:00+00:00</th>
      <td>29982.6191</td>
      <td>6407.5000</td>
      <td>3700.6499</td>
      <td>22744.8594</td>
      <td>12609.1602</td>
      <td>27013.2500</td>
      <td>36488.6289</td>
      <td>7420.7002</td>
      <td>4793.0601</td>
      <td>31084.9395</td>
      <td>16057.4404</td>
      <td>30670.0996</td>
    </tr>
    <tr>
      <th>2022-12-31 00:00:00+00:00</th>
      <td>28725.5098</td>
      <td>6826.2002</td>
      <td>3577.0300</td>
      <td>14687.0195</td>
      <td>10213.2900</td>
      <td>24717.5293</td>
      <td>36799.6484</td>
      <td>7672.3999</td>
      <td>4796.5601</td>
      <td>24965.5508</td>
      <td>15832.7998</td>
      <td>29332.1602</td>
    </tr>
    <tr>
      <th>2023-12-31 00:00:00+00:00</th>
      <td>32930.0781</td>
      <td>7554.1001</td>
      <td>3808.1001</td>
      <td>20145.2891</td>
      <td>10305.2402</td>
      <td>25716.8594</td>
      <td>34302.6094</td>
      <td>8012.5000</td>
      <td>4179.7598</td>
      <td>22688.9004</td>
      <td>12200.8203</td>
      <td>27696.4395</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<div class="toctree-wrapper compound">
<span id="document-mckinney_10_practice"></span><section id="mckinney-chapter-10-practice-blank">
<h3>McKinney Chapter 10 - Practice (Blank)<a class="headerlink" href="#mckinney-chapter-10-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="replicate-the-following-pivot-table-output-with-groupby">
<h5>Replicate the following <code class="docutils literal notranslate"><span class="pre">.pivot_table()</span></code> output with <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code><a class="headerlink" href="#replicate-the-following-pivot-table-output-with-groupby" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;^GSPC ^DJI ^IXIC ^FTSE ^N225 ^HSI&#39;</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Index&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ind</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2015&#39;</span><span class="p">:]</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
        <span class="n">values</span><span class="o">=</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">),</span>
        <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Index&#39;</span><span class="p">,</span>
        <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="6" halign="left">min</th>
      <th colspan="6" halign="left">max</th>
    </tr>
    <tr>
      <th>Index</th>
      <th>^DJI</th>
      <th>^FTSE</th>
      <th>^GSPC</th>
      <th>^HSI</th>
      <th>^IXIC</th>
      <th>^N225</th>
      <th>^DJI</th>
      <th>^FTSE</th>
      <th>^GSPC</th>
      <th>^HSI</th>
      <th>^IXIC</th>
      <th>^N225</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-12-31 00:00:00+00:00</th>
      <td>15666.4404</td>
      <td>5874.1001</td>
      <td>1867.6100</td>
      <td>20556.5996</td>
      <td>4506.4902</td>
      <td>16795.9609</td>
      <td>18312.3906</td>
      <td>7104.0000</td>
      <td>2130.8201</td>
      <td>28442.7500</td>
      <td>5218.8599</td>
      <td>20868.0293</td>
    </tr>
    <tr>
      <th>2016-12-31 00:00:00+00:00</th>
      <td>15660.1797</td>
      <td>5537.0000</td>
      <td>1829.0800</td>
      <td>18319.5801</td>
      <td>4266.8398</td>
      <td>14952.0195</td>
      <td>19974.6191</td>
      <td>7142.7998</td>
      <td>2271.7200</td>
      <td>24099.6992</td>
      <td>5487.4399</td>
      <td>19494.5293</td>
    </tr>
    <tr>
      <th>2017-12-31 00:00:00+00:00</th>
      <td>19732.4004</td>
      <td>7099.2002</td>
      <td>2257.8301</td>
      <td>22134.4707</td>
      <td>5429.0801</td>
      <td>18335.6309</td>
      <td>24837.5098</td>
      <td>7687.7998</td>
      <td>2690.1599</td>
      <td>30003.4902</td>
      <td>6994.7598</td>
      <td>22939.1797</td>
    </tr>
    <tr>
      <th>2018-12-31 00:00:00+00:00</th>
      <td>21792.1992</td>
      <td>6584.7002</td>
      <td>2351.1001</td>
      <td>24585.5293</td>
      <td>6192.9199</td>
      <td>19155.7402</td>
      <td>26828.3906</td>
      <td>7877.5000</td>
      <td>2930.7500</td>
      <td>33154.1211</td>
      <td>8109.6899</td>
      <td>24270.6191</td>
    </tr>
    <tr>
      <th>2019-12-31 00:00:00+00:00</th>
      <td>22686.2207</td>
      <td>6692.7002</td>
      <td>2447.8899</td>
      <td>25064.3594</td>
      <td>6463.5000</td>
      <td>19561.9609</td>
      <td>28645.2598</td>
      <td>7686.6001</td>
      <td>3240.0200</td>
      <td>30157.4902</td>
      <td>9022.3896</td>
      <td>24066.1191</td>
    </tr>
    <tr>
      <th>2020-12-31 00:00:00+00:00</th>
      <td>18591.9297</td>
      <td>4993.8999</td>
      <td>2237.3999</td>
      <td>21696.1309</td>
      <td>6860.6699</td>
      <td>16552.8301</td>
      <td>30606.4805</td>
      <td>7674.6001</td>
      <td>3756.0701</td>
      <td>29056.4199</td>
      <td>12899.4199</td>
      <td>27568.1504</td>
    </tr>
    <tr>
      <th>2021-12-31 00:00:00+00:00</th>
      <td>29982.6191</td>
      <td>6407.5000</td>
      <td>3700.6499</td>
      <td>22744.8594</td>
      <td>12609.1602</td>
      <td>27013.2500</td>
      <td>36488.6289</td>
      <td>7420.7002</td>
      <td>4793.0601</td>
      <td>31084.9395</td>
      <td>16057.4404</td>
      <td>30670.0996</td>
    </tr>
    <tr>
      <th>2022-12-31 00:00:00+00:00</th>
      <td>28725.5098</td>
      <td>6826.2002</td>
      <td>3577.0300</td>
      <td>14687.0195</td>
      <td>10213.2900</td>
      <td>24717.5293</td>
      <td>36799.6484</td>
      <td>7672.3999</td>
      <td>4796.5601</td>
      <td>24965.5508</td>
      <td>15832.7998</td>
      <td>29332.1602</td>
    </tr>
    <tr>
      <th>2023-12-31 00:00:00+00:00</th>
      <td>32930.0781</td>
      <td>7554.1001</td>
      <td>3808.1001</td>
      <td>20145.2891</td>
      <td>10305.2402</td>
      <td>25716.8594</td>
      <td>34302.6094</td>
      <td>8012.5000</td>
      <td>4179.7598</td>
      <td>22688.9004</td>
      <td>12200.8203</td>
      <td>27696.4395</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="calulate-the-mean-and-standard-deviation-of-returns-by-ticker-for-the-matana-msft-aapl-tsla-amzn-nvda-and-goog-stocks">
<h5>Calulate the mean and standard deviation of returns by ticker for the MATANA (MSFT, AAPL, TSLA, AMZN, NVDA, and GOOG) stocks<a class="headerlink" href="#calulate-the-mean-and-standard-deviation-of-returns-by-ticker-for-the-matana-msft-aapl-tsla-amzn-nvda-and-goog-stocks" title="Permalink to this heading">#</a></h5>
<p>Consider only dates with complete returns data.
Try this calculation with wide and long data frames, and confirm your results are the same.</p>
</section>
<section id="calculate-the-mean-and-standard-deviation-of-returns-and-the-maximum-of-closing-prices-by-ticker-for-the-matana-stocks">
<h5>Calculate the mean and standard deviation of returns and the maximum of closing prices by ticker for the MATANA stocks<a class="headerlink" href="#calculate-the-mean-and-standard-deviation-of-returns-and-the-maximum-of-closing-prices-by-ticker-for-the-matana-stocks" title="Permalink to this heading">#</a></h5>
<p>Again, consider only dates with complete returns data.
Try this calculation with wide and long data frames, and confirm your results are the same.</p>
</section>
<section id="calculate-monthly-means-and-volatilities-for-spy-and-goog-returns">
<h5>Calculate monthly means and volatilities for SPY and GOOG returns<a class="headerlink" href="#calculate-monthly-means-and-volatilities-for-spy-and-goog-returns" title="Permalink to this heading">#</a></h5>
</section>
<section id="plot-the-monthly-means-and-volatilities-from-the-previous-exercise">
<h5>Plot the monthly means and volatilities from the previous exercise<a class="headerlink" href="#plot-the-monthly-means-and-volatilities-from-the-previous-exercise" title="Permalink to this heading">#</a></h5>
</section>
<section id="assign-the-dow-jones-stocks-to-five-portfolios-based-on-their-monthly-volatility">
<h5>Assign the Dow Jones stocks to five portfolios based on their monthly volatility<a class="headerlink" href="#assign-the-dow-jones-stocks-to-five-portfolios-based-on-their-monthly-volatility" title="Permalink to this heading">#</a></h5>
<p>First, we need to download Dow Jones stock data and calculate daily returns.
Use data from 2019 through today.</p>
</section>
<section id="plot-the-time-series-volatilities-of-these-five-portfolios">
<h5>Plot the time-series volatilities of these five portfolios<a class="headerlink" href="#plot-the-time-series-volatilities-of-these-five-portfolios" title="Permalink to this heading">#</a></h5>
<p>How do these portfolio volatilies compare to (1) each other and (2) the mean volatility of their constituent stocks?</p>
</section>
<section id="calculate-the-mean-monthly-correlation-between-the-dow-jones-stocks">
<h5>Calculate the <em>mean</em> monthly correlation between the Dow Jones stocks<a class="headerlink" href="#calculate-the-mean-monthly-correlation-between-the-dow-jones-stocks" title="Permalink to this heading">#</a></h5>
<p>Drop duplicate correlations and self correlations (i.e., correlation between AAPL and AAPL), which are 1, by definition.</p>
</section>
<section id="is-market-volatility-higher-during-wars">
<h5>Is market volatility higher during wars?<a class="headerlink" href="#is-market-volatility-higher-during-wars" title="Permalink to this heading">#</a></h5>
<p>Here is some guidance:</p>
<ol class="arabic simple">
<li><p>Download the daily factor data from Ken French’s website</p></li>
<li><p>Calculate daily market returns by summing the market risk premium and risk-free rates (<code class="docutils literal notranslate"><span class="pre">Mkt-RF</span></code> and <code class="docutils literal notranslate"><span class="pre">RF</span></code>, respectively)</p></li>
<li><p>Calculate the volatility (standard deviation) of daily returns <em>every month</em> by combining <code class="docutils literal notranslate"><span class="pre">pd.Grouper()</span></code> and <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code>)</p></li>
<li><p>Multiply by $\sqrt{252}$ to annualize these volatilities of daily returns</p></li>
<li><p>Plot these annualized volatilities</p></li>
</ol>
<p>Is market volatility higher during wars?
Consider the following dates:</p>
<ol class="arabic simple">
<li><p>WWII: December 1941 to September 1945</p></li>
<li><p>Korean War: 1950 to 1953</p></li>
<li><p>Viet Nam War: 1959 to 1975</p></li>
<li><p>Gulf War: 1990 to 1991</p></li>
<li><p>War in Afghanistan: 2001 to 2021</p></li>
</ol>
</section>
</section>
</section>
<span id="document-mckinney_10_practice_all"></span><section id="mckinney-chapter-10-practice-all-sections">
<h3>McKinney Chapter 10 - Practice (All Sections)<a class="headerlink" href="#mckinney-chapter-10-practice-all-sections" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="replicate-the-following-pivot-table-output-with-groupby">
<h5>Replicate the following <code class="docutils literal notranslate"><span class="pre">.pivot_table()</span></code> output with <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code><a class="headerlink" href="#replicate-the-following-pivot-table-output-with-groupby" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;^GSPC ^DJI ^IXIC ^FTSE ^N225 ^HSI&#39;</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Index&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">ind</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Adj Close</th>
      <th>Close</th>
      <th>High</th>
      <th>Low</th>
      <th>Open</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-12-30 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1928-01-03 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.7600</td>
      <td>17.7600</td>
      <td>17.7600</td>
      <td>17.7600</td>
      <td>17.7600</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1928-01-04 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.7200</td>
      <td>17.7200</td>
      <td>17.7200</td>
      <td>17.7200</td>
      <td>17.7200</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1928-01-05 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.5500</td>
      <td>17.5500</td>
      <td>17.5500</td>
      <td>17.5500</td>
      <td>17.5500</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1928-01-06 05:00:00+00:00</th>
      <th>^GSPC</th>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>17.6600</td>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ind</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2015&#39;</span><span class="p">:]</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
        <span class="n">values</span><span class="o">=</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">),</span>
        <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Index&#39;</span><span class="p">,</span>
        <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="6" halign="left">min</th>
      <th colspan="6" halign="left">max</th>
    </tr>
    <tr>
      <th>Index</th>
      <th>^DJI</th>
      <th>^FTSE</th>
      <th>^GSPC</th>
      <th>^HSI</th>
      <th>^IXIC</th>
      <th>^N225</th>
      <th>^DJI</th>
      <th>^FTSE</th>
      <th>^GSPC</th>
      <th>^HSI</th>
      <th>^IXIC</th>
      <th>^N225</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-12-31 00:00:00+00:00</th>
      <td>15666.4404</td>
      <td>5874.1001</td>
      <td>1867.6100</td>
      <td>20556.5996</td>
      <td>4506.4902</td>
      <td>16795.9609</td>
      <td>18312.3906</td>
      <td>7104.0000</td>
      <td>2130.8201</td>
      <td>28442.7500</td>
      <td>5218.8599</td>
      <td>20868.0293</td>
    </tr>
    <tr>
      <th>2016-12-31 00:00:00+00:00</th>
      <td>15660.1797</td>
      <td>5537.0000</td>
      <td>1829.0800</td>
      <td>18319.5801</td>
      <td>4266.8398</td>
      <td>14952.0195</td>
      <td>19974.6191</td>
      <td>7142.7998</td>
      <td>2271.7200</td>
      <td>24099.6992</td>
      <td>5487.4399</td>
      <td>19494.5293</td>
    </tr>
    <tr>
      <th>2017-12-31 00:00:00+00:00</th>
      <td>19732.4004</td>
      <td>7099.2002</td>
      <td>2257.8301</td>
      <td>22134.4707</td>
      <td>5429.0801</td>
      <td>18335.6309</td>
      <td>24837.5098</td>
      <td>7687.7998</td>
      <td>2690.1599</td>
      <td>30003.4902</td>
      <td>6994.7598</td>
      <td>22939.1797</td>
    </tr>
    <tr>
      <th>2018-12-31 00:00:00+00:00</th>
      <td>21792.1992</td>
      <td>6584.7002</td>
      <td>2351.1001</td>
      <td>24585.5293</td>
      <td>6192.9199</td>
      <td>19155.7402</td>
      <td>26828.3906</td>
      <td>7877.5000</td>
      <td>2930.7500</td>
      <td>33154.1211</td>
      <td>8109.6899</td>
      <td>24270.6191</td>
    </tr>
    <tr>
      <th>2019-12-31 00:00:00+00:00</th>
      <td>22686.2207</td>
      <td>6692.7002</td>
      <td>2447.8899</td>
      <td>25064.3594</td>
      <td>6463.5000</td>
      <td>19561.9609</td>
      <td>28645.2598</td>
      <td>7686.6001</td>
      <td>3240.0200</td>
      <td>30157.4902</td>
      <td>9022.3896</td>
      <td>24066.1191</td>
    </tr>
    <tr>
      <th>2020-12-31 00:00:00+00:00</th>
      <td>18591.9297</td>
      <td>4993.8999</td>
      <td>2237.3999</td>
      <td>21696.1309</td>
      <td>6860.6699</td>
      <td>16552.8301</td>
      <td>30606.4805</td>
      <td>7674.6001</td>
      <td>3756.0701</td>
      <td>29056.4199</td>
      <td>12899.4199</td>
      <td>27568.1504</td>
    </tr>
    <tr>
      <th>2021-12-31 00:00:00+00:00</th>
      <td>29982.6191</td>
      <td>6407.5000</td>
      <td>3700.6499</td>
      <td>22744.8594</td>
      <td>12609.1602</td>
      <td>27013.2500</td>
      <td>36488.6289</td>
      <td>7420.7002</td>
      <td>4793.0601</td>
      <td>31084.9395</td>
      <td>16057.4404</td>
      <td>30670.0996</td>
    </tr>
    <tr>
      <th>2022-12-31 00:00:00+00:00</th>
      <td>28725.5098</td>
      <td>6826.2002</td>
      <td>3577.0300</td>
      <td>14687.0195</td>
      <td>10213.2900</td>
      <td>24717.5293</td>
      <td>36799.6484</td>
      <td>7672.3999</td>
      <td>4796.5601</td>
      <td>24965.5508</td>
      <td>15832.7998</td>
      <td>29332.1602</td>
    </tr>
    <tr>
      <th>2023-12-31 00:00:00+00:00</th>
      <td>32930.0781</td>
      <td>7554.1001</td>
      <td>3808.1001</td>
      <td>20145.2891</td>
      <td>10305.2402</td>
      <td>25716.8594</td>
      <td>34302.6094</td>
      <td>8014.2998</td>
      <td>4179.7598</td>
      <td>22688.9004</td>
      <td>12200.8203</td>
      <td>27696.4395</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Here is the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> solution!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ind</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2015&#39;</span><span class="p">:,</span> <span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">),</span> <span class="s1">&#39;Index&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="6" halign="left">min</th>
      <th colspan="6" halign="left">max</th>
    </tr>
    <tr>
      <th>Index</th>
      <th>^DJI</th>
      <th>^FTSE</th>
      <th>^GSPC</th>
      <th>^HSI</th>
      <th>^IXIC</th>
      <th>^N225</th>
      <th>^DJI</th>
      <th>^FTSE</th>
      <th>^GSPC</th>
      <th>^HSI</th>
      <th>^IXIC</th>
      <th>^N225</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-12-31 00:00:00+00:00</th>
      <td>15666.4404</td>
      <td>5874.1001</td>
      <td>1867.6100</td>
      <td>20556.5996</td>
      <td>4506.4902</td>
      <td>16795.9609</td>
      <td>18312.3906</td>
      <td>7104.0000</td>
      <td>2130.8201</td>
      <td>28442.7500</td>
      <td>5218.8599</td>
      <td>20868.0293</td>
    </tr>
    <tr>
      <th>2016-12-31 00:00:00+00:00</th>
      <td>15660.1797</td>
      <td>5537.0000</td>
      <td>1829.0800</td>
      <td>18319.5801</td>
      <td>4266.8398</td>
      <td>14952.0195</td>
      <td>19974.6191</td>
      <td>7142.7998</td>
      <td>2271.7200</td>
      <td>24099.6992</td>
      <td>5487.4399</td>
      <td>19494.5293</td>
    </tr>
    <tr>
      <th>2017-12-31 00:00:00+00:00</th>
      <td>19732.4004</td>
      <td>7099.2002</td>
      <td>2257.8301</td>
      <td>22134.4707</td>
      <td>5429.0801</td>
      <td>18335.6309</td>
      <td>24837.5098</td>
      <td>7687.7998</td>
      <td>2690.1599</td>
      <td>30003.4902</td>
      <td>6994.7598</td>
      <td>22939.1797</td>
    </tr>
    <tr>
      <th>2018-12-31 00:00:00+00:00</th>
      <td>21792.1992</td>
      <td>6584.7002</td>
      <td>2351.1001</td>
      <td>24585.5293</td>
      <td>6192.9199</td>
      <td>19155.7402</td>
      <td>26828.3906</td>
      <td>7877.5000</td>
      <td>2930.7500</td>
      <td>33154.1211</td>
      <td>8109.6899</td>
      <td>24270.6191</td>
    </tr>
    <tr>
      <th>2019-12-31 00:00:00+00:00</th>
      <td>22686.2207</td>
      <td>6692.7002</td>
      <td>2447.8899</td>
      <td>25064.3594</td>
      <td>6463.5000</td>
      <td>19561.9609</td>
      <td>28645.2598</td>
      <td>7686.6001</td>
      <td>3240.0200</td>
      <td>30157.4902</td>
      <td>9022.3896</td>
      <td>24066.1191</td>
    </tr>
    <tr>
      <th>2020-12-31 00:00:00+00:00</th>
      <td>18591.9297</td>
      <td>4993.8999</td>
      <td>2237.3999</td>
      <td>21696.1309</td>
      <td>6860.6699</td>
      <td>16552.8301</td>
      <td>30606.4805</td>
      <td>7674.6001</td>
      <td>3756.0701</td>
      <td>29056.4199</td>
      <td>12899.4199</td>
      <td>27568.1504</td>
    </tr>
    <tr>
      <th>2021-12-31 00:00:00+00:00</th>
      <td>29982.6191</td>
      <td>6407.5000</td>
      <td>3700.6499</td>
      <td>22744.8594</td>
      <td>12609.1602</td>
      <td>27013.2500</td>
      <td>36488.6289</td>
      <td>7420.7002</td>
      <td>4793.0601</td>
      <td>31084.9395</td>
      <td>16057.4404</td>
      <td>30670.0996</td>
    </tr>
    <tr>
      <th>2022-12-31 00:00:00+00:00</th>
      <td>28725.5098</td>
      <td>6826.2002</td>
      <td>3577.0300</td>
      <td>14687.0195</td>
      <td>10213.2900</td>
      <td>24717.5293</td>
      <td>36799.6484</td>
      <td>7672.3999</td>
      <td>4796.5601</td>
      <td>24965.5508</td>
      <td>15832.7998</td>
      <td>29332.1602</td>
    </tr>
    <tr>
      <th>2023-12-31 00:00:00+00:00</th>
      <td>32930.0781</td>
      <td>7554.1001</td>
      <td>3808.1001</td>
      <td>20145.2891</td>
      <td>10305.2402</td>
      <td>25716.8594</td>
      <td>34302.6094</td>
      <td>8014.2998</td>
      <td>4179.7598</td>
      <td>22688.9004</td>
      <td>12200.8203</td>
      <td>27696.4395</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="calulate-the-mean-and-standard-deviation-of-returns-by-ticker-for-the-matana-msft-aapl-tsla-amzn-nvda-and-goog-stocks">
<h5>Calulate the mean and standard deviation of returns by ticker for the MATANA (MSFT, AAPL, TSLA, AMZN, NVDA, and GOOG) stocks<a class="headerlink" href="#calulate-the-mean-and-standard-deviation-of-returns-by-ticker-for-the-matana-msft-aapl-tsla-amzn-nvda-and-goog-stocks" title="Permalink to this heading">#</a></h5>
<p>Consider only dates with complete returns data.
Try this calculation with wide and long data frames, and confirm your results are the same.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matana</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;MSFT AAPL TSLA AMZN NVDA GOOG&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
    <span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">matana</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.0011</td>
      <td>0.0011</td>
      <td>0.0008</td>
      <td>0.0010</td>
      <td>0.0018</td>
      <td>0.0022</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0180</td>
      <td>0.0208</td>
      <td>0.0172</td>
      <td>0.0165</td>
      <td>0.0281</td>
      <td>0.0362</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.0011</td>
      <td>0.0011</td>
      <td>0.0008</td>
      <td>0.0010</td>
      <td>0.0018</td>
      <td>0.0022</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0180</td>
      <td>0.0208</td>
      <td>0.0172</td>
      <td>0.0165</td>
      <td>0.0281</td>
      <td>0.0362</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]),</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>    
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-mean-and-standard-deviation-of-returns-and-the-maximum-of-closing-prices-by-ticker-for-the-matana-stocks">
<h5>Calculate the mean and standard deviation of returns and the maximum of closing prices by ticker for the MATANA stocks<a class="headerlink" href="#calculate-the-mean-and-standard-deviation-of-returns-and-the-maximum-of-closing-prices-by-ticker-for-the-matana-stocks" title="Permalink to this heading">#</a></h5>
<p>Again, consider only dates with complete returns data.
Try this calculation with wide and long data frames, and confirm your results are the same.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">matana</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]])</span>
<span class="n">matana</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">matana</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">matana</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Returns&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="s1">&#39;Close&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="2" halign="left">Returns</th>
      <th>Close</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>max</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AAPL</th>
      <td>0.0011</td>
      <td>0.0180</td>
      <td>182.0100</td>
    </tr>
    <tr>
      <th>AMZN</th>
      <td>0.0011</td>
      <td>0.0208</td>
      <td>186.5705</td>
    </tr>
    <tr>
      <th>GOOG</th>
      <td>0.0008</td>
      <td>0.0172</td>
      <td>150.7090</td>
    </tr>
    <tr>
      <th>MSFT</th>
      <td>0.0010</td>
      <td>0.0165</td>
      <td>343.1100</td>
    </tr>
    <tr>
      <th>NVDA</th>
      <td>0.0018</td>
      <td>0.0281</td>
      <td>333.7600</td>
    </tr>
    <tr>
      <th>TSLA</th>
      <td>0.0022</td>
      <td>0.0362</td>
      <td>409.9700</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="calculate-monthly-means-and-volatilities-for-spy-and-goog-returns">
<h5>Calculate monthly means and volatilities for SPY and GOOG returns<a class="headerlink" href="#calculate-monthly-means-and-volatilities-for-spy-and-goog-returns" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spy_goog</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;SPY GOOG&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
    <span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">spy_goog</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="2" halign="left">Adj Close</th>
      <th>Capital Gains</th>
      <th colspan="2" halign="left">Close</th>
      <th colspan="2" halign="left">Dividends</th>
      <th colspan="2" halign="left">High</th>
      <th colspan="2" halign="left">Low</th>
      <th colspan="2" halign="left">Open</th>
      <th colspan="2" halign="left">Stock Splits</th>
      <th colspan="2" halign="left">Volume</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>GOOG</th>
      <th>SPY</th>
      <th>SPY</th>
      <th>GOOG</th>
      <th>SPY</th>
      <th>GOOG</th>
      <th>SPY</th>
      <th>GOOG</th>
      <th>SPY</th>
      <th>GOOG</th>
      <th>SPY</th>
      <th>GOOG</th>
      <th>SPY</th>
      <th>GOOG</th>
      <th>SPY</th>
      <th>GOOG</th>
      <th>SPY</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-01-29 00:00:00-05:00</th>
      <td>NaN</td>
      <td>25.2182</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>43.9375</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>43.9688</td>
      <td>NaN</td>
      <td>43.7500</td>
      <td>NaN</td>
      <td>43.9688</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>1003200</td>
    </tr>
    <tr>
      <th>1993-02-01 00:00:00-05:00</th>
      <td>NaN</td>
      <td>25.3976</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>44.2500</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>44.2500</td>
      <td>NaN</td>
      <td>43.9688</td>
      <td>NaN</td>
      <td>43.9688</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>480500</td>
    </tr>
    <tr>
      <th>1993-02-02 00:00:00-05:00</th>
      <td>NaN</td>
      <td>25.4514</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>44.3438</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>44.3750</td>
      <td>NaN</td>
      <td>44.1250</td>
      <td>NaN</td>
      <td>44.2188</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>201300</td>
    </tr>
    <tr>
      <th>1993-02-03 00:00:00-05:00</th>
      <td>NaN</td>
      <td>25.7204</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>44.8125</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>44.8438</td>
      <td>NaN</td>
      <td>44.3750</td>
      <td>NaN</td>
      <td>44.4062</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>529400</td>
    </tr>
    <tr>
      <th>1993-02-04 00:00:00-05:00</th>
      <td>NaN</td>
      <td>25.8280</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>45.0000</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>45.0938</td>
      <td>NaN</td>
      <td>44.4688</td>
      <td>NaN</td>
      <td>44.9688</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>531500</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spy_goog_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">spy_goog</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;1993-02&#39;</span><span class="p">:</span><span class="s1">&#39;2023-01&#39;</span><span class="p">,</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">spy_goog_m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Ticker</th>
      <th colspan="2" halign="left">GOOG</th>
      <th colspan="2" halign="left">SPY</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean</th>
      <th>std</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-02-28 00:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0002</td>
      <td>0.0081</td>
    </tr>
    <tr>
      <th>1993-03-31 00:00:00-05:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0010</td>
      <td>0.0071</td>
    </tr>
    <tr>
      <th>1993-04-30 00:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.0012</td>
      <td>0.0074</td>
    </tr>
    <tr>
      <th>1993-05-31 00:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0014</td>
      <td>0.0071</td>
    </tr>
    <tr>
      <th>1993-06-30 00:00:00-04:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0002</td>
      <td>0.0060</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-09-30 00:00:00-04:00</th>
      <td>-0.0058</td>
      <td>0.0198</td>
      <td>-0.0045</td>
      <td>0.0151</td>
    </tr>
    <tr>
      <th>2022-10-31 00:00:00-04:00</th>
      <td>-0.0003</td>
      <td>0.0300</td>
      <td>0.0039</td>
      <td>0.0176</td>
    </tr>
    <tr>
      <th>2022-11-30 00:00:00-05:00</th>
      <td>0.0038</td>
      <td>0.0316</td>
      <td>0.0027</td>
      <td>0.0176</td>
    </tr>
    <tr>
      <th>2022-12-31 00:00:00-05:00</th>
      <td>-0.0062</td>
      <td>0.0173</td>
      <td>-0.0028</td>
      <td>0.0113</td>
    </tr>
    <tr>
      <th>2023-01-31 00:00:00-05:00</th>
      <td>0.0061</td>
      <td>0.0216</td>
      <td>0.0031</td>
      <td>0.0105</td>
    </tr>
  </tbody>
</table>
<p>360 rows × 4 columns</p>
</div></div></div>
</div>
</section>
<section id="plot-the-monthly-means-and-volatilities-from-the-previous-exercise">
<h5>Plot the monthly means and volatilities from the previous exercise<a class="headerlink" href="#plot-the-monthly-means-and-volatilities-from-the-previous-exercise" title="Permalink to this heading">#</a></h5>
<p>Here is a first go!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spy_goog_m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&lt;AxesSubplot:xlabel=&#39;Date&#39;&gt;, &lt;AxesSubplot:xlabel=&#39;Date&#39;&gt;,
       &lt;AxesSubplot:xlabel=&#39;Date&#39;&gt;, &lt;AxesSubplot:xlabel=&#39;Date&#39;&gt;],
      dtype=object)
</pre></div>
</div>
<img alt="_images/57ce4aabcb7cfc753ea0f95ee6806e0dbb999e12ffb4af1fd46c7047a562fb1a.png" src="_images/57ce4aabcb7cfc753ea0f95ee6806e0dbb999e12ffb4af1fd46c7047a562fb1a.png" />
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">plt.subplots()</span></code> to better organize these plots.
Here <code class="docutils literal notranslate"><span class="pre">.plt.subplots()</span></code> creates a tuple of empty axes and assign it to <code class="docutils literal notranslate"><span class="pre">ax</span></code>.
Then we can use the <code class="docutils literal notranslate"><span class="pre">ax=</span></code> argument to assign each plot to each axes.
I suggest ou pick up these tricks as you go instead of trying to read and memorize the matplotlib manual before you have a very specific task as hand.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">spy_goog_m</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Mean of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">spy_goog_m</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;SD of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Means and Standard Deviations of Daily Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/868bfa68c2f523b4db7ae547dfdcbc018f186587bcb1c9775c41bed5d95a5395.png" src="_images/868bfa68c2f523b4db7ae547dfdcbc018f186587bcb1c9775c41bed5d95a5395.png" />
</div>
</div>
</section>
<section id="assign-the-dow-jones-stocks-to-five-portfolios-based-on-their-monthly-volatility">
<h5>Assign the Dow Jones stocks to five portfolios based on their monthly volatility<a class="headerlink" href="#assign-the-dow-jones-stocks-to-five-portfolios-based-on-their-monthly-volatility" title="Permalink to this heading">#</a></h5>
<p>First, we need to download Dow Jones stock data and calculate daily returns.
Use data from 2020 through today.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dj</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">wiki</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
    <span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here I add daily returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">dj</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]])</span>
<span class="n">dj</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">dj</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Here I add the monthly volatility to all the days in each month for each ticker.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Volatility&#39;</span><span class="p">],</span> <span class="n">dj</span><span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">]])</span>
<span class="n">dj</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">dj</span><span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;std&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here I assign stocks to portfolios based on their volatility.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1, 1, 2, 2, 3, 3, 4, 4, 5, 5])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">],</span> <span class="n">dj</span><span class="p">[</span><span class="s1">&#39;Volatility&#39;</span><span class="p">]])</span>
<span class="n">dj</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">dj</span><span class="p">[</span><span class="s1">&#39;Volatility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-time-series-volatilities-of-these-five-portfolios">
<h5>Plot the time-series volatilities of these five portfolios<a class="headerlink" href="#plot-the-time-series-volatilities-of-these-five-portfolios" title="Permalink to this heading">#</a></h5>
<p>How do these portfolio volatilies compare to (1) each other and (2) the mean volatility of their constituent stocks?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">dj</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">),</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Returns&#39;</span><span class="p">:</span> <span class="s1">&#39;Volatility&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="c1"># drop missing port.</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Portfolio</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span> <span class="c1"># w/o missing portf., can convert to integer</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="p">[</span><span class="s1">&#39;Volatility&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Volatility of Five Portfolios Formed on Volatility&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/66a0cea06b6089c3a7fc11433679caabe29ea557c14803edaa812da94ebaefb1.png" src="_images/66a0cea06b6089c3a7fc11433679caabe29ea557c14803edaa812da94ebaefb1.png" />
</div>
</div>
</section>
<section id="calculate-the-mean-monthly-correlation-between-the-dow-jones-stocks">
<h5>Calculate the <em>mean</em> monthly correlation between the Dow Jones stocks<a class="headerlink" href="#calculate-the-mean-monthly-correlation-between-the-dow-jones-stocks" title="Permalink to this heading">#</a></h5>
<p>Drop duplicate correlations and self correlations (i.e., correlation between AAPL and AAPL), which are 1, by definition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mu_rho</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">rhos</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
    <span class="n">tril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">rhos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">rhos</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">tril</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tril</span> <span class="o">!=</span> <span class="mf">1.</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">dj</span>
    <span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">mu_rho</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Correlation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Correlations of Dow-Jones Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2a3e82ea052ce3d0d0c56a8fa05c20dd36cd1b32d8f92a60cf56a84d4aaa9006.png" src="_images/2a3e82ea052ce3d0d0c56a8fa05c20dd36cd1b32d8f92a60cf56a84d4aaa9006.png" />
</div>
</div>
</section>
<section id="is-market-volatility-higher-during-wars">
<h5>Is market volatility higher during wars?<a class="headerlink" href="#is-market-volatility-higher-during-wars" title="Permalink to this heading">#</a></h5>
<p>Here is some guidance:</p>
<ol class="arabic simple">
<li><p>Download the daily factor data from Ken French’s website</p></li>
<li><p>Calculate daily market returns by summing the market risk premium and risk-free rates (<code class="docutils literal notranslate"><span class="pre">Mkt-RF</span></code> and <code class="docutils literal notranslate"><span class="pre">RF</span></code>, respectively)</p></li>
<li><p>Calculate the volatility (standard deviation) of daily returns <em>every month</em> by combining <code class="docutils literal notranslate"><span class="pre">pd.Grouper()</span></code> and <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code>)</p></li>
<li><p>Multiply by $\sqrt{252}$ to annualize these volatilities of daily returns</p></li>
<li><p>Plot these annualized volatilities</p></li>
</ol>
<p>Is market volatility higher during wars?
Consider the following dates:</p>
<ol class="arabic simple">
<li><p>WWII: December 1941 to September 1945</p></li>
<li><p>Korean War: 1950 to 1953</p></li>
<li><p>Viet Nam War: 1959 to 1975</p></li>
<li><p>Gulf War: 1990 to 1991</p></li>
<li><p>War in Afghanistan: 2001 to 2021</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdr</span><span class="o">.</span><span class="n">famafrench</span><span class="o">.</span><span class="n">get_available_datasets</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors&#39;,
 &#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_all</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Mkt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Mkt&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># adds vertical bands for U.S. wars</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="s1">&#39;1941-12&#39;</span><span class="p">,</span> <span class="s1">&#39;1945-09&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;WWII&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;1941-12&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="s1">&#39;1950&#39;</span><span class="p">,</span> <span class="s1">&#39;1953&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Korean&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;1950&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="s1">&#39;1959&#39;</span><span class="p">,</span> <span class="s1">&#39;1975&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Vietnam&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;1959&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="s1">&#39;1990&#39;</span><span class="p">,</span> <span class="s1">&#39;1991&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Gulf I&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;1990&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="s1">&#39;2001&#39;</span><span class="p">,</span> <span class="s1">&#39;2021&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Afghanistan&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;2001&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Volatility of U.S. Market&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5cd98e18bb8a9624d0b83e25c2c67f24eb070943b5d8d7e8d624d2b17bec4673.png" src="_images/5cd98e18bb8a9624d0b83e25c2c67f24eb070943b5d8d7e8d624d2b17bec4673.png" />
</div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-mckinney_11_lecture"></span><section id="mckinney-chapter-11-time-series">
<h2>McKinney Chapter 11 - Time Series<a class="headerlink" href="#mckinney-chapter-11-time-series" title="Permalink to this heading">#</a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h3>
<p>Chapter 11 of Wes McKinney’s <a class="reference external" href="https://wesmckinney.com/book/"><em>Python for Data Analysis</em></a> discusses time series and panel data, which is where pandas <em><strong>shines</strong></em>.
We will use these time series and panel tools every day for the rest of the course.</p>
<p>We will focus on:</p>
<ol class="arabic simple">
<li><p>Slicing a data frame or series by date or date range</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> to create leads and lags of variables</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> to change the frequency of variables</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> to aggregate data over rolling windows</p></li>
</ol>
<p><em><strong>Note:</strong></em>
Indented block quotes are from McKinney unless otherwise indicated.
The section numbers here differ from McKinney because we will only discuss some topics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>McKinney provides an excellent introduction to the concept of time series and panel data:</p>
<blockquote>
<div><p>Time series data is an important form of structured data in many different fields, such
as finance, economics, ecology, neuroscience, and physics. Anything that is observed
or measured at many points in time forms a time series. Many time series are fixed
frequency, which is to say that data points occur at regular intervals according to some
rule, such as every 15 seconds, every 5 minutes, or once per month. Time series can
also be irregular without a fixed unit of time or offset between units. How you mark
and refer to time series data depends on the application, and you may have one of the
following:</p>
<ul class="simple">
<li><p>Timestamps, specific instants in time</p></li>
<li><p>Fixed periods, such as the month January 2007 or the full year 2010</p></li>
<li><p>Intervals of time, indicated by a start and end timestamp. Periods can be thought
of as special cases of intervals</p></li>
<li><p>Experiment or elapsed time; each timestamp is a measure of time relative to a
particular start time (e.g., the diameter of a cookie baking each second since
being placed in the oven)</p></li>
</ul>
<p>In this chapter, I am mainly concerned with time series in the first three categories,
though many of the techniques can be applied to experimental time series where the
index may be an integer or floating-point number indicating elapsed time from the
start of the experiment. The simplest and most widely used kind of time series are
those indexed by timestamp.
323</p>
<p>pandas provides many built-in time series tools and data algorithms. You can effi‐
ciently work with very large time series and easily slice and dice, aggregate, and
resample irregular- and fixed-frequency time series. Some of these tools are especially
useful for financial and economics applications, but you could certainly use them to
analyze server log data, too.</p>
</div></blockquote>
</section>
<section id="time-series-basics">
<h3>Time Series Basics<a class="headerlink" href="#time-series-basics" title="Permalink to this heading">#</a></h3>
<p>Let us create a time series to play with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="n">dates</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> 
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> 
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> 
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="n">ts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2011-01-02    0.4967
2011-01-05   -0.1383
2011-01-07    0.6477
2011-01-08    1.5230
2011-01-10   -0.2342
2011-01-12   -0.2341
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Note that pandas converts the <code class="docutils literal notranslate"><span class="pre">datetime</span></code> objects to a pandas <code class="docutils literal notranslate"><span class="pre">DatetimeIndex</span></code> object and a single index value is a <code class="docutils literal notranslate"><span class="pre">Timestamp</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2011-01-02&#39;, &#39;2011-01-05&#39;, &#39;2011-01-07&#39;, &#39;2011-01-08&#39;,
               &#39;2011-01-10&#39;, &#39;2011-01-12&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=None)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2011-01-02 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<p>Recall that arithmetic operations between pandas objects automatically align on indexes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2011-01-02    0.4967
2011-01-07    0.6477
2011-01-10   -0.2342
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">+</span> <span class="n">ts</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2011-01-02    0.9934
2011-01-05       NaN
2011-01-07    1.2954
2011-01-08       NaN
2011-01-10   -0.4683
2011-01-12       NaN
dtype: float64
</pre></div>
</div>
</div>
</div>
<section id="indexing-selection-subsetting">
<h4>Indexing, Selection, Subsetting<a class="headerlink" href="#indexing-selection-subsetting" title="Permalink to this heading">#</a></h4>
<p>We can use date and time labels to select data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stamp</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">stamp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2011-01-07 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="p">[</span><span class="n">stamp</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.6476885381006925
</pre></div>
</div>
</div>
</div>
<p>pandas uses unambiguous date strings to select data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="p">[</span><span class="s1">&#39;1/10/2011&#39;</span><span class="p">]</span> <span class="c1"># M/D/YYYY</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.23415337472333597
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="p">[</span><span class="s1">&#39;20110110&#39;</span><span class="p">]</span> <span class="c1"># YYYYMMDD</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.23415337472333597
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="p">[</span><span class="s1">&#39;2011-01-10&#39;</span><span class="p">]</span> <span class="c1"># YYYY-MM-DD</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.23415337472333597
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="p">[</span><span class="s1">&#39;10-Jan-2011&#39;</span><span class="p">]</span> <span class="c1"># D-Mon-YYYY</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.23415337472333597
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="p">[</span><span class="s1">&#39;Jan-10-2011&#39;</span><span class="p">]</span> <span class="c1"># Mon-D-YYYY</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.23415337472333597
</pre></div>
</div>
</div>
</div>
<p>But do not use U.K.-style dates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ts[&#39;10/1/2011&#39;] # D/M/YYYY</span>
</pre></div>
</div>
</div>
</div>
<p>Here is a longer time series for longer slices.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">longer_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>

<span class="n">longer_ts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-01    0.4967
2000-01-02   -0.1383
2000-01-03    0.6477
2000-01-04    1.5230
2000-01-05   -0.2342
               ...  
2002-09-22   -0.2811
2002-09-23    1.7977
2002-09-24    0.6408
2002-09-25   -0.5712
2002-09-26    0.5726
Freq: D, Length: 1000, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We can pass a year-month to slice all of the observations in May of 2001.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">longer_ts</span><span class="p">[</span><span class="s1">&#39;2001-05&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2001-05-01   -0.6466
2001-05-02   -1.0815
2001-05-03    1.6871
2001-05-04    0.8816
2001-05-05   -0.0080
2001-05-06    1.4799
2001-05-07    0.0774
2001-05-08   -0.8613
2001-05-09    1.5231
2001-05-10    0.5389
2001-05-11   -1.0372
2001-05-12   -0.1903
2001-05-13   -0.8756
2001-05-14   -1.3828
2001-05-15    0.9262
2001-05-16    1.9094
2001-05-17   -1.3986
2001-05-18    0.5630
2001-05-19   -0.6506
2001-05-20   -0.4871
2001-05-21   -0.5924
2001-05-22   -0.8640
2001-05-23    0.0485
2001-05-24   -0.8310
2001-05-25    0.2705
2001-05-26   -0.0502
2001-05-27   -0.2389
2001-05-28   -0.9076
2001-05-29   -0.5768
2001-05-30    0.7554
2001-05-31    0.5009
Freq: D, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We can also pass a year to slice all observations in 2001.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">longer_ts</span><span class="p">[</span><span class="s1">&#39;2001&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2001-01-01    0.2241
2001-01-02    0.0126
2001-01-03    0.0977
2001-01-04   -0.7730
2001-01-05    0.0245
               ...  
2001-12-27    0.0184
2001-12-28    0.3476
2001-12-29   -0.5398
2001-12-30   -0.7783
2001-12-31    0.1958
Freq: D, Length: 365, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>If we sort our data chronologically, we can also slice with a range of date strings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="p">[</span><span class="s1">&#39;1/6/2011&#39;</span><span class="p">:</span><span class="s1">&#39;1/10/2011&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2011-01-07    0.6477
2011-01-08    1.5230
2011-01-10   -0.2342
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>To use date slices, our data should be sorted by the date index, as above.
The following code works as though our data were sorted, but raises a warning that it will not work in future versions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts2</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>

<span class="n">ts2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2011-01-10   -0.2342
2011-01-12   -0.2341
2011-01-05   -0.1383
2011-01-02    0.4967
2011-01-07    0.6477
2011-01-08    1.5230
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The following behavior is “deprecated”, meaning it will eventually go away and we should not rely up on it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts2</span><span class="p">[</span><span class="s1">&#39;1/6/2011&#39;</span><span class="p">:</span><span class="s1">&#39;1/11/2011&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_259324/1099700163.py:1: FutureWarning: Value based partial slicing on non-monotonic DatetimeIndexes with non-existing keys is deprecated and will raise a KeyError in a future Version.
  ts2[&#39;1/6/2011&#39;:&#39;1/11/2011&#39;]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2011-01-10   -0.2342
2011-01-07    0.6477
2011-01-08    1.5230
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts2</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()[</span><span class="s1">&#39;1/6/2011&#39;</span><span class="p">:</span><span class="s1">&#39;1/11/2011&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2011-01-07    0.6477
2011-01-08    1.5230
2011-01-10   -0.2342
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>To be clear, a range of date strings is inclusive on both ends.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">longer_ts</span><span class="p">[</span><span class="s1">&#39;1/6/2001&#39;</span><span class="p">:</span><span class="s1">&#39;1/11/2001&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2001-01-06    0.4980
2001-01-07    1.4511
2001-01-08    0.9593
2001-01-09    2.1532
2001-01-10   -0.7673
2001-01-11    0.8723
Freq: D, dtype: float64
</pre></div>
</div>
</div>
</div>
<p><em><strong>Recall, if we modify a slice, we modify the original series or dataframe.</strong></em></p>
<blockquote>
<div><p>Remember that slicing in this manner produces views on the source time series like slicing NumPy arrays. This means that no data is copied and modifications on the slice will be reflected in the original data.</p>
</div></blockquote>
</section>
<section id="time-series-with-duplicate-indices">
<h4>Time Series with Duplicate Indices<a class="headerlink" href="#time-series-with-duplicate-indices" title="Permalink to this heading">#</a></h4>
<p>Most data in this course will be well-formed with one observation per datetime for series or one observation per individual per datetime for dataframes.
However, you may later receive poorly-formed data with duplicate observations.
The toy data in series <code class="docutils literal notranslate"><span class="pre">dup_ts</span></code> has three observations on February 2nd.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="s1">&#39;1/2/2000&#39;</span><span class="p">,</span> <span class="s1">&#39;1/2/2000&#39;</span><span class="p">,</span> <span class="s1">&#39;1/2/2000&#39;</span><span class="p">,</span> <span class="s1">&#39;1/3/2000&#39;</span><span class="p">])</span>
<span class="n">dup_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="n">dup_ts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-01    0
2000-01-02    1
2000-01-02    2
2000-01-02    3
2000-01-03    4
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.is_unique</span></code> property tells us if an index is unique.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dup_ts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dup_ts</span><span class="p">[</span><span class="s1">&#39;1/3/2000&#39;</span><span class="p">]</span>  <span class="c1"># not duplicated</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dup_ts</span><span class="p">[</span><span class="s1">&#39;1/2/2000&#39;</span><span class="p">]</span>  <span class="c1"># duplicated</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-02    1
2000-01-02    2
2000-01-02    3
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>The solution to duplicate data depends on the context.
For example, we may want the mean of all observations on a given date.
The <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code>  method can help us here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped</span> <span class="o">=</span> <span class="n">dup_ts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-01   0.0000
2000-01-02   2.0000
2000-01-03   4.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-01    0
2000-01-02    3
2000-01-03    4
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Or we may want the number of observations on each date.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-01    1
2000-01-02    3
2000-01-03    1
dtype: int64
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="date-ranges-frequencies-and-shifting">
<h3>Date Ranges, Frequencies, and Shifting<a class="headerlink" href="#date-ranges-frequencies-and-shifting" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>Generic time series in pandas are assumed to be irregular; that is, they have no fixed frequency. For many applications this is sufficient. However, it’s often desirable to work relative to a fixed frequency, such as daily, monthly, or every 15 minutes, even if that means introducing missing values into a time series. Fortunately pandas has a full suite of standard time series frequencies and tools for resampling, inferring frequencies, and generating fixed-frequency date ranges.</p>
</div></blockquote>
<p>We will skip the sections on creating date ranges or different frequencies so we can focus on shifting data.</p>
<section id="shifting-leading-and-lagging-data">
<h4>Shifting (Leading and Lagging) Data<a class="headerlink" href="#shifting-leading-and-lagging-data" title="Permalink to this heading">#</a></h4>
<p><em><strong>Shifting is an important feature!</strong></em>
Shifting is moving data backward (or forward) through time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>

<span class="n">ts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-31    0.4967
2000-02-29   -0.1383
2000-03-31    0.6477
2000-04-30    1.5230
Freq: M, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>If we pass a positive integer $N$ to the <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> method:</p>
<ol class="arabic simple">
<li><p>The date index remains the same</p></li>
<li><p>Values are shifted down $N$ observations</p></li>
</ol>
<p>“Lag” might be a better name than “shift” since a postive 2 makes the value at any timestamp the value from 2 timestamps above (earlier, since most time-series data are chronological).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="c1"># if we do not specify &quot;periods&quot;, pandas assumes 1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-31       NaN
2000-02-29    0.4967
2000-03-31   -0.1383
2000-04-30    0.6477
Freq: M, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-31       NaN
2000-02-29       NaN
2000-03-31    0.4967
2000-04-30   -0.1383
Freq: M, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>If we pass a <em>negative</em> integer $N$ to the <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> method, values are shifted <em>up</em> $N$ observations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-31   0.6477
2000-02-29   1.5230
2000-03-31      NaN
2000-04-30      NaN
Freq: M, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We will almost never shift with negative values (i.e., we will almost never bring forward values from the future) to prevent look-ahead bias.
We do not want to assume that financial market participants have access to future data.
Our most common shift will be to compute the percent change from one period to the next.
We can calculate the percent change two ways.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-31       NaN
2000-02-29   -1.2784
2000-03-31   -5.6844
2000-04-30    1.3515
Freq: M, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span> <span class="o">/</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-31       NaN
2000-02-29   -1.2784
2000-03-31   -5.6844
2000-04-30    1.3515
Freq: M, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">a</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
    <span class="n">b</span><span class="o">=</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span> <span class="o">/</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(),</span>
    <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>Two observations on the percent change calculations above:</p>
<ol class="arabic simple">
<li><p>The first percent change is NaN (missing) because there is no previous value to change from</p></li>
<li><p>The default <code class="docutils literal notranslate"><span class="pre">periods</span></code> argument for <code class="docutils literal notranslate"><span class="pre">.shift()</span></code>  and <code class="docutils literal notranslate"><span class="pre">.pct_change()</span></code> is 1</p></li>
</ol>
<p>The naive shift examples above shift by a number of observations, without considering timestamps or their frequencies.
As a result, timestamps are unchanged and values shift down (positive <code class="docutils literal notranslate"><span class="pre">periods</span></code> argument) or up (negative <code class="docutils literal notranslate"><span class="pre">periods</span></code> argument).
However, we can also pass the <code class="docutils literal notranslate"><span class="pre">freq</span></code> argument to respect the timestamps.
With the <code class="docutils literal notranslate"><span class="pre">freq</span></code> argument, timestamps shift by a multiple (specified by the <code class="docutils literal notranslate"><span class="pre">periods</span></code> argument) of datetime intervals (specified by the <code class="docutils literal notranslate"><span class="pre">freq</span></code> argument).
Note that the examples below generate new datetime indexes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-31    0.4967
2000-02-29   -0.1383
2000-03-31    0.6477
2000-04-30    1.5230
Freq: M, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-03-31    0.4967
2000-04-30   -0.1383
2000-05-31    0.6477
2000-06-30    1.5230
Freq: M, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-02-03    0.4967
2000-03-03   -0.1383
2000-04-03    0.6477
2000-05-03    1.5230
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">M</span></code> is already months, so <code class="docutils literal notranslate"><span class="pre">T</span></code> is minutes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;90T&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-31 01:30:00    0.4967
2000-02-29 01:30:00   -0.1383
2000-03-31 01:30:00    0.6477
2000-04-30 01:30:00    1.5230
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="shifting-dates-with-offsets">
<h4>Shifting dates with offsets<a class="headerlink" href="#shifting-dates-with-offsets" title="Permalink to this heading">#</a></h4>
<p>We can also shift timestamps to the beginning or end of a period or interval.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas.tseries.offsets</span> <span class="kn">import</span> <span class="n">Day</span><span class="p">,</span> <span class="n">MonthEnd</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<span class="n">now</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">Day</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2011-11-20 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 0 is for move to the end of the month, but never leave the month</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2011-11-30 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 1 is for move to the end of the month, if already at end, move to the next end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2011-11-30 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2011-12-31 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<p>Date offsets can help us align data for presentation or merging.
<em><strong>But, be careful!</strong></em>
The default argument is 1, but we typically want 0.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2021-10-31 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2021-10-31 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2021-10-31 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2021-11-30 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="resampling-and-frequency-conversion">
<h3>Resampling and Frequency Conversion<a class="headerlink" href="#resampling-and-frequency-conversion" title="Permalink to this heading">#</a></h3>
<p><em><strong>Resampling is an important feature!</strong></em></p>
<blockquote>
<div><p>Resampling refers to the process of converting a time series from one frequency to
another. Aggregating higher frequency data to lower frequency is called
downsampling, while converting lower frequency to higher frequency is called upsampling. Not
all resampling falls into either of these categories; for example, converting W-WED
(weekly on Wednesday) to W-FRI is neither upsampling nor downsampling.</p>
</div></blockquote>
<p>We can resample both series and data frames.
The <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method syntax is similar to the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method syntax.
This similarity is because <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> is syntactic sugar for <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code>.</p>
<section id="downsampling">
<h4>Downsampling<a class="headerlink" href="#downsampling" title="Permalink to this heading">#</a></h4>
<blockquote>
<div><p>Aggregating data to a regular, lower frequency is a pretty normal time series task. The
data you’re aggregating doesn’t need to be fixed frequently; the desired frequency
defines bin edges that are used to slice the time series into pieces to aggregate. For
example, to convert to monthly, ‘M’ or ‘BM’, you need to chop up the data into
one-month intervals. Each interval is said to be half-open; a data point can only belong to
one interval, and the union of the intervals must make up the whole time frame.
There are a couple things to think about when using resample to downsample data:</p>
<ul class="simple">
<li><p>Which side of each interval is closed</p></li>
<li><p>How to label each aggregated bin, either with the start of the interval or the end</p></li>
</ul>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">ts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-01 00:00:00     0
2000-01-01 00:01:00     1
2000-01-01 00:02:00     2
2000-01-01 00:03:00     3
2000-01-01 00:04:00     4
2000-01-01 00:05:00     5
2000-01-01 00:06:00     6
2000-01-01 00:07:00     7
2000-01-01 00:08:00     8
2000-01-01 00:09:00     9
2000-01-01 00:10:00    10
2000-01-01 00:11:00    11
Freq: T, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>We can aggregate the one-minute frequency data above to a five-minute frequency.
Resampling requires and aggregation method, and here McKinney chooses the <code class="docutils literal notranslate"><span class="pre">.sum()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;5min&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-01 00:00:00    10
2000-01-01 00:05:00    35
2000-01-01 00:10:00    21
Freq: 5T, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Two observations about the previous resampling example:</p>
<ol class="arabic simple">
<li><p>For minute-frequency resampling, the default is that the new data are labeled by the left edge of the resampling interval</p></li>
<li><p>For minute-frequency resampling, the default is that the left edge is closed (included) and the right edge is open (excluded)</p></li>
</ol>
<p>As a result, the first value of 10 at midnight is the sum of values at midnight and to the right of midnight, not including the value at 00:05 (i.e., $10 = 0+1+2+3+4$ at 00:00 and $35 = 5+6+7+8+9$  at 00:05).
We can use the <code class="docutils literal notranslate"><span class="pre">closed</span></code> and <code class="docutils literal notranslate"><span class="pre">label</span></code> arguments to change this behavior.</p>
<p>In finance, we prefer <code class="docutils literal notranslate"><span class="pre">closed='right'</span></code> and <code class="docutils literal notranslate"><span class="pre">label='right'</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;5min&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000-01-01 00:00:00     0
2000-01-01 00:05:00    15
2000-01-01 00:10:00    40
2000-01-01 00:15:00    11
Freq: 5T, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Mixed combinations of <code class="docutils literal notranslate"><span class="pre">closed</span></code> and <code class="docutils literal notranslate"><span class="pre">label</span></code> are possible but confusing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;5min&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1999-12-31 23:55:00     0
2000-01-01 00:00:00    15
2000-01-01 00:05:00    40
2000-01-01 00:10:00    11
Freq: 5T, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>These defaults for minute-frequency data may seem odd, but any choice is arbitrary.
I suggest you do the following when you use the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method:</p>
<ol class="arabic simple">
<li><p>Read the docstring</p></li>
<li><p>Check your output</p></li>
</ol>
<p>pandas (and the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method) are mature and widely used, so the defaults are typically reasonable.</p>
</section>
<section id="upsampling-and-interpolation">
<h4>Upsampling and Interpolation<a class="headerlink" href="#upsampling-and-interpolation" title="Permalink to this heading">#</a></h4>
<p>To downsample (i.e., resample from higher frequency to lower frequency), we have to choose an aggregation method (e.g., <code class="docutils literal notranslate"><span class="pre">.mean()</span></code>, <code class="docutils literal notranslate"><span class="pre">.sum()</span></code>, <code class="docutils literal notranslate"><span class="pre">.first()</span></code>, or <code class="docutils literal notranslate"><span class="pre">.last()</span></code>).
To upsample (i.e., resample from lower frequency to higher frequency), we do not have to choose an aggregation method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                     <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;W-WED&#39;</span><span class="p">),</span>
                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">,</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">])</span>

<span class="n">frame</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Colorado</th>
      <th>Texas</th>
      <th>New York</th>
      <th>Ohio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-01-05</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-12</th>
      <td>-0.2342</td>
      <td>-0.2341</td>
      <td>1.5792</td>
      <td>0.7674</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">.asfreq()</span></code> method to convert to the new frequency “as is”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_daily</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">asfreq</span><span class="p">()</span>

<span class="n">df_daily</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Colorado</th>
      <th>Texas</th>
      <th>New York</th>
      <th>Ohio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-01-05</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-08</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-09</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-10</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-11</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-12</th>
      <td>-0.2342</td>
      <td>-0.2341</td>
      <td>1.5792</td>
      <td>0.7674</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We do not <em>have</em> to choose an aggregation (disaggregation?) method, but we may want to choose a method to fill in the missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Colorado</th>
      <th>Texas</th>
      <th>New York</th>
      <th>Ohio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-01-05</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-06</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-07</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-08</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-09</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-10</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-11</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-12</th>
      <td>-0.2342</td>
      <td>-0.2341</td>
      <td>1.5792</td>
      <td>0.7674</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Colorado</th>
      <th>Texas</th>
      <th>New York</th>
      <th>Ohio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-01-05</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-06</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-07</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-08</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-09</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-10</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-11</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2000-01-12</th>
      <td>-0.2342</td>
      <td>-0.2341</td>
      <td>1.5792</td>
      <td>0.7674</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;W-THU&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Colorado</th>
      <th>Texas</th>
      <th>New York</th>
      <th>Ohio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-01-06</th>
      <td>0.4967</td>
      <td>-0.1383</td>
      <td>0.6477</td>
      <td>1.5230</td>
    </tr>
    <tr>
      <th>2000-01-13</th>
      <td>-0.2342</td>
      <td>-0.2341</td>
      <td>1.5792</td>
      <td>0.7674</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="moving-window-functions">
<h3>Moving Window Functions<a class="headerlink" href="#moving-window-functions" title="Permalink to this heading">#</a></h3>
<p><em><strong>Moving window (or rolling window) functions are one of the neatest features of pandas, and we will frequently use moving window functions.</strong></em>
We will use data similar, but not identical, to the book data.
<em><strong>We must remove the timezone if we want to merge with Fama-French data.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">Tickers</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
    <span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="3" halign="left">Adj Close</th>
      <th>Capital Gains</th>
      <th colspan="3" halign="left">Close</th>
      <th colspan="3" halign="left">Dividends</th>
      <th>...</th>
      <th>Low</th>
      <th colspan="3" halign="left">Open</th>
      <th colspan="3" halign="left">Stock Splits</th>
      <th colspan="3" halign="left">Volume</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>AAPL</th>
      <th>MSFT</th>
      <th>SPY</th>
      <th>SPY</th>
      <th>AAPL</th>
      <th>MSFT</th>
      <th>SPY</th>
      <th>AAPL</th>
      <th>MSFT</th>
      <th>SPY</th>
      <th>...</th>
      <th>SPY</th>
      <th>AAPL</th>
      <th>MSFT</th>
      <th>SPY</th>
      <th>AAPL</th>
      <th>MSFT</th>
      <th>SPY</th>
      <th>AAPL</th>
      <th>MSFT</th>
      <th>SPY</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>0.0997</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.1283</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>469033600</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>0.0945</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1217</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.1222</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>175884800</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>0.0876</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1127</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.1133</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>105728000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.0897</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.1155</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>86441600</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.0924</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.1189</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>73449600</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 25 columns</p>
</div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method is similar to the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> and <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> methods.
The <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method accepts a window-width and requires an aggregation method.
The next example calculates and plots the 252-trading day moving average of AAPL’s price alongside the daily price.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aapl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2012&#39;</span><span class="p">:,</span> <span class="p">(</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">,</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">)]</span>
<span class="n">aapl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">aapl</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;252 Trading Day Mean&#39;</span><span class="p">)</span> <span class="c1"># min_periods defaults to 252</span>
<span class="n">aapl</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s1">&#39;365D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;365 Calendar Day Mean&#39;</span><span class="p">)</span> <span class="c1"># min_periods defaults to 1</span>
<span class="n">aapl</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Calendar Year Mean&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;AAPL Adjusted Close ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison of Rolling and Resampling Means&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/73306499bfed819657f6608b4c2fc4b0b074c7dbb1219a1d79291a0d258024ae.png" src="_images/73306499bfed819657f6608b4c2fc4b0b074c7dbb1219a1d79291a0d258024ae.png" />
</div>
</div>
<p>Two observations:</p>
<ol class="arabic simple">
<li><p>If we pass the window-width as an integer, the window-width is based on the number of observations and ignores time stamps</p></li>
<li><p>If we pass the window-width as an integer, the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method requires that number of observations for all windows (i.e., note that the moving average starts 251 trading days after the first daily price</p></li>
</ol>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">min_periods</span></code> argument to allow incomplete windows.
For integer window widths, <code class="docutils literal notranslate"><span class="pre">min_periods</span> <span class="pre">defaults</span></code> to the given integer window width.
For string date offsets, <code class="docutils literal notranslate"><span class="pre">min_periods</span> <span class="pre">defaults</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p>
<section id="binary-moving-window-functions">
<h4>Binary Moving Window Functions<a class="headerlink" href="#binary-moving-window-functions" title="Permalink to this heading">#</a></h4>
<p>Binary moving window functions accept two inputs.
The most common example is the rolling correlation between two returns series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

<span class="n">returns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>MSFT</th>
      <th>SPY</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>-0.0522</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>-0.0734</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.0248</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.0290</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">126</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Correlation(AAPL, SPY)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Rolling Correlation between AAPL and SPY</span><span class="se">\n</span><span class="s1"> (126-Day Window w/ 100-Day Minimum)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b70bab101a835c6d363dea9990d1fe4a40dfa16554097fbc77efeb1775d784da.png" src="_images/b70bab101a835c6d363dea9990d1fe4a40dfa16554097fbc77efeb1775d784da.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">[[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">126</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Correlation with SPY&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Rolling Correlation with SPY</span><span class="se">\n</span><span class="s1"> (126-Day Window w/ 100-Day Minimum)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9c0b888b16fbfe7a5c50183037a64f8369a508e910bf4aad8d1a485830894dbf.png" src="_images/9c0b888b16fbfe7a5c50183037a64f8369a508e910bf4aad8d1a485830894dbf.png" />
</div>
</div>
</section>
<section id="user-defined-moving-window-functions">
<h4>User-Defined Moving Window Functions<a class="headerlink" href="#user-defined-moving-window-functions" title="Permalink to this heading">#</a></h4>
<p>Finally, we can define our own moving window functions and use the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method to apply them
However, note that <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> will be much slower than the the optimized moving window functions (e.g., <code class="docutils literal notranslate"><span class="pre">.mean()</span></code>, <code class="docutils literal notranslate"><span class="pre">.std()</span></code>, etc.).</p>
<p>McKinney provides an abstract example here, but we will discuss a simpler example that calculates rolling volatility.
Also, calculating rolling volatility with the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method provides us a chance to benchmark it against the optimized version.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> <span class="c1"># annualize and convert to percent</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Rolling Volatility</span><span class="se">\n</span><span class="s1"> (252-Day Window w/ 252-Day Minimum)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b08139df980f12c04bebffed82b1e46447b329c989e36b2d32c5137f9b6461ef.png" src="_images/b08139df980f12c04bebffed82b1e46447b329c989e36b2d32c5137f9b6461ef.png" />
</div>
</div>
<p>Do not be afraid to use <code class="docutils literal notranslate"><span class="pre">.apply()</span></code>, but realize that <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> is typically 1000-times slower than the pre-built method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> returns[&#39;AAPL&#39;].rolling(252).apply(np.std)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>571 ms ± 3.68 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> returns[&#39;AAPL&#39;].rolling(252).std()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>230 µs ± 8.46 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-mckinney_11_practice"></span><section id="mckinney-chapter-11-practice-blank">
<h3>McKinney Chapter 11 - Practice (Blank)<a class="headerlink" href="#mckinney-chapter-11-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="which-are-larger-overnight-or-intraday-returns">
<h5>Which are larger, overnight or intraday returns?<a class="headerlink" href="#which-are-larger-overnight-or-intraday-returns" title="Permalink to this heading">#</a></h5>
<p>Yahoo! Finance provides easy acces to high-quality open, high, low, close (OHLC) and adjusted close price data.
However, Yahoo! Finance does not provide overnight or instraday returns directly.
Therefore, we need to use math to decompose daily returns into overnight and intraday returns.</p>
<p>Daily returns are defined as (adjusted) closing price to (adjusted) closing price returns.
Therefore, daily returns consist of overnight returns compounded with the intraday returns from the next day $(1 + R_{daily}) = (1 + R_{overnight}) \times (1 + R_{intraday})$ which we can rearrange to calculate overnight returns as $\frac{1 + R_{daily}}{1 + R_{intraday}} - 1 = R_{overnight}$.</p>
<p>We can calculate daily and intraday returns from Yahoo! Finance data as $R_{daily} = \frac{Adj\ Close_{t} - Adj\ Close_{t-1}}{Adj\ Close_{t-1}}$ and $R_{intraday} = \frac{Close - Open}{Open}$.</p>
<p>Compare the following for the SPY ETF:</p>
<ol class="arabic simple">
<li><p>Cumulative returns with all available data</p></li>
<li><p>Total returns for each calendar year</p></li>
<li><p>Total returns over rolling 252-trading-day windows</p></li>
<li><p>Total returns over rolling 12-months windows after calculating monthly returns</p></li>
<li><p>Sharpe Ratios for each calendar year</p></li>
</ol>
<section id="cumulative-returns-with-all-available-data">
<h6>Cumulative returns with all available data<a class="headerlink" href="#cumulative-returns-with-all-available-data" title="Permalink to this heading">#</a></h6>
</section>
<section id="total-returns-for-each-calendar-year">
<h6>Total returns for each calendar year<a class="headerlink" href="#total-returns-for-each-calendar-year" title="Permalink to this heading">#</a></h6>
</section>
<section id="total-returns-over-rolling-252-trading-day-windows">
<h6>Total returns over rolling 252-trading-day windows<a class="headerlink" href="#total-returns-over-rolling-252-trading-day-windows" title="Permalink to this heading">#</a></h6>
</section>
<section id="total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns">
<h6>Total returns over rolling 12-months windows after calculating monthly returns<a class="headerlink" href="#total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns" title="Permalink to this heading">#</a></h6>
</section>
<section id="sharpe-ratios-for-each-calendar-year">
<h6>Sharpe Ratios for each calendar year<a class="headerlink" href="#sharpe-ratios-for-each-calendar-year" title="Permalink to this heading">#</a></h6>
</section>
</section>
<section id="calculate-rolling-betas">
<h5>Calculate rolling betas<a class="headerlink" href="#calculate-rolling-betas" title="Permalink to this heading">#</a></h5>
<p>Calculate rolling capital asset pricing model (CAPM) betas for the MATANA stocks.</p>
<p>The CAPM says the risk premium on a stock depends on the risk-free rate, beta, and the risk premium on the market: $E(R_{stock}) = R_f + \beta_{stock} \times (E(R_{market}) - R_f)$.
We can calculate CAPM betas as: $\beta_{stock} = \frac{Cov(R_{stock} - R_f, R_{market} - R_f)}{Var(R_{market} - R_f)}$.</p>
</section>
<section id="calculate-rolling-sharpe-ratios">
<h5>Calculate rolling Sharpe Ratios<a class="headerlink" href="#calculate-rolling-sharpe-ratios" title="Permalink to this heading">#</a></h5>
<p>Calculate rolling Sharpe Ratios for the MATANA stocks.</p>
<p>The Sharpe Ratio is often used to evaluate fund managers.
The Sharpe Ratio is $SR_i = \frac{\overline{R_i - R_f}}{\sigma}$, where $\overline{R_i-R_f}$ is mean fund return relative to the risk-free rate over some period and $\sigma$ is the standard deviation of $R_i-R_f$ over the same period.
While the Sharpe Ratio is typically used for funds, we can apply it to a single stock to test our knowledge of the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.
Calculate and plot the one-year rolling Sharpe Ratio for the MATANA stocks using all available daily data.</p>
</section>
<section id="does-more-frequent-rebalancing-increase-or-decrease-returns">
<h5>Does more frequent rebalancing increase or decrease returns?<a class="headerlink" href="#does-more-frequent-rebalancing-increase-or-decrease-returns" title="Permalink to this heading">#</a></h5>
<p>Compare decade-total returns for the following rebalancing frequencies:</p>
<ol class="arabic simple">
<li><p>Daily rebalancing</p></li>
<li><p>Monthly rebalancing</p></li>
<li><p>Annual rebalancing</p></li>
<li><p>Decade rebalancing</p></li>
</ol>
<p>Use equally-weighted portfolios of industry-level daily returns from French’s website: <code class="docutils literal notranslate"><span class="pre">'17_Industry_Portfolios_daily'</span></code>.</p>
</section>
</section>
</section>
<span id="document-mckinney_11_practice_03"></span><section id="mckinney-chapter-11-practice-monday-2-45-pm-section-3">
<h3>McKinney Chapter 11 - Practice (Monday 2:45 PM, Section 3)<a class="headerlink" href="#mckinney-chapter-11-practice-monday-2-45-pm-section-3" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 4 - mean was $87%$</p></li>
<li><p>Project 1 and Teammates Reviews on Friday at 11:59 PM</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
</pre></div>
</div>
</div>
</div>
<section id="which-are-larger-overnight-or-intraday-returns">
<h5>Which are larger, overnight or intraday returns?<a class="headerlink" href="#which-are-larger-overnight-or-intraday-returns" title="Permalink to this heading">#</a></h5>
<p>Yahoo! Finance provides easy acces to high-quality open, high, low, close (OHLC) and adjusted close price data.
However, Yahoo! Finance does not provide overnight or instraday returns directly.
Therefore, we need to use math to decompose daily returns into overnight and intraday returns.</p>
<p>Daily returns are defined as (adjusted) closing price to (adjusted) closing price returns.
Therefore, daily returns consist of overnight returns compounded with the intraday returns from the next day $(1 + R_{daily}) = (1 + R_{overnight}) \times (1 + R_{intraday})$ which we can rearrange to calculate overnight returns as $\frac{1 + R_{daily}}{1 + R_{intraday}} - 1 = R_{overnight}$.</p>
<p>We can calculate daily and intraday returns from Yahoo! Finance data as $R_{daily} = \frac{Adj\ Close_{t} - Adj\ Close_{t-1}}{Adj\ Close_{t-1}}$ and $R_{intraday} = \frac{Close - Open}{Open}$.</p>
<p>Compare the following for the SPY ETF:</p>
<ol class="arabic simple">
<li><p>Cumulative returns with all available data</p></li>
<li><p>Total returns for each calendar year</p></li>
<li><p>Total returns over rolling 252-trading-day windows</p></li>
<li><p>Total returns over rolling 12-months windows after calculating monthly returns</p></li>
<li><p>Sharpe Ratios for each calendar year</p></li>
</ol>
<section id="intraday-and-overnight-return-decomposition">
<h6>Intraday and overnight return decomposition<a class="headerlink" href="#intraday-and-overnight-return-decomposition" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spy</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  1 of 1 completed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">spy</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="c1"># remove time zone from date index</span>
        <span class="n">Total</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span> <span class="c1"># close-to-close</span>
        <span class="n">Intraday</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># open-to-close</span>
        <span class="n">Overnight</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Intraday&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># remainder is close-to-open</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span> <span class="c1"># replace index with time-zome-less index</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="c1"># drop first day with incomplete returns</span>
    <span class="p">[[</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="s1">&#39;Intraday&#39;</span><span class="p">,</span> <span class="s1">&#39;Overnight&#39;</span><span class="p">]]</span> <span class="c1"># slice returns columns</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span> <span class="c1"># name columns axis</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="cumulative-returns-with-all-available-data">
<h5>Cumulative returns with all available data<a class="headerlink" href="#cumulative-returns-with-all-available-data" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5d313b70d512f93a5ef89e4e8703b2ff33bf3ce524a2d3d58feac73d97c54918.png" src="_images/5d313b70d512f93a5ef89e4e8703b2ff33bf3ce524a2d3d58feac73d97c54918.png" />
</div>
</div>
<p>We want to calcuate total returns at several different aggregation levels.
A helper function makes this code more compact and easier to troubleshoot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">totret</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<section id="total-returns-for-each-calendar-year">
<h6>Total returns for each calendar year<a class="headerlink" href="#total-returns-for-each-calendar-year" title="Permalink to this heading">#</a></h6>
<p>First, total returns for each calendar year.
Note, the first and last years are partial (i.e., do not include about 252 trading days).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_a</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>

<span class="n">returns_a</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Total</th>
      <th>Intraday</th>
      <th>Overnight</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993</th>
      <td>0.0871</td>
      <td>-0.0443</td>
      <td>0.1374</td>
    </tr>
    <tr>
      <th>1994</th>
      <td>0.0040</td>
      <td>-0.0774</td>
      <td>0.0881</td>
    </tr>
    <tr>
      <th>1995</th>
      <td>0.3805</td>
      <td>0.2857</td>
      <td>0.0738</td>
    </tr>
    <tr>
      <th>1996</th>
      <td>0.2250</td>
      <td>0.0236</td>
      <td>0.1968</td>
    </tr>
    <tr>
      <th>1997</th>
      <td>0.3348</td>
      <td>-0.0017</td>
      <td>0.3370</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">Calendar Year Total Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/aeab7e9e979fc7392abaeb58760bf5396929ac555716285bbe6441bbe45b13eb.png" src="_images/aeab7e9e979fc7392abaeb58760bf5396929ac555716285bbe6441bbe45b13eb.png" />
</div>
</div>
<p>We can get the same result without defining a <code class="docutils literal notranslate"><span class="pre">totret()</span></code> function, but then we use a lambda function, which can be tedious.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_a_alt</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">returns_a_alt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Total</th>
      <th>Intraday</th>
      <th>Overnight</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993</th>
      <td>0.0871</td>
      <td>-0.0443</td>
      <td>0.1374</td>
    </tr>
    <tr>
      <th>1994</th>
      <td>0.0040</td>
      <td>-0.0774</td>
      <td>0.0881</td>
    </tr>
    <tr>
      <th>1995</th>
      <td>0.3805</td>
      <td>0.2857</td>
      <td>0.0738</td>
    </tr>
    <tr>
      <th>1996</th>
      <td>0.2250</td>
      <td>0.0236</td>
      <td>0.1968</td>
    </tr>
    <tr>
      <th>1997</th>
      <td>0.3348</td>
      <td>-0.0017</td>
      <td>0.3370</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">returns_a</span><span class="p">,</span>
    <span class="n">returns_a_alt</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>If we only want the total return for <code class="docutils literal notranslate"><span class="pre">Intraday</span></code>, we can slice <code class="docutils literal notranslate"><span class="pre">returns</span></code> before we <code class="docutils literal notranslate"><span class="pre">.resample()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;Intraday&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Date
1993   -0.0443
1994   -0.0774
1995    0.2857
1996    0.0236
1997   -0.0017
Freq: A-DEC, Name: Intraday, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="total-returns-over-rolling-252-trading-day-windows">
<h6>Total returns over rolling 252-trading-day windows<a class="headerlink" href="#total-returns-over-rolling-252-trading-day-windows" title="Permalink to this heading">#</a></h6>
<p>We can repeat the total return calculation for 252-trading-day rolling windows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_r</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>

<span class="n">returns_r</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Total</th>
      <th>Intraday</th>
      <th>Overnight</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-02-01</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-03</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-04</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_r</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">252-Trading-Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b81e52c04650c8539929407e5f87ab6dbfc7c1fedb554277c6ccbbf5a53adcf3.png" src="_images/b81e52c04650c8539929407e5f87ab6dbfc7c1fedb554277c6ccbbf5a53adcf3.png" />
</div>
</div>
</section>
<section id="total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns">
<h6>Total returns over rolling 12-months windows after calculating monthly returns<a class="headerlink" href="#total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns" title="Permalink to this heading">#</a></h6>
<p>We can chain this operation!
Note the plot has the same general appearance, but is less noisy because we aggregate to monthly total returns first!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_mr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span> <span class="c1"># aggregate from daily to monthly</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span> <span class="c1"># ...calculate total returns</span>
    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="c1"># aggregate into 12-month rolling windows</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span> <span class="c1"># ...calculate total returns</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_mr</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">12-Month Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1d74ede469744e32262f36e9aa684004d2cba25347fac629fffa1ce961b3feec.png" src="_images/1d74ede469744e32262f36e9aa684004d2cba25347fac629fffa1ce961b3feec.png" />
</div>
</div>
</section>
<section id="sharpe-ratios-for-each-calendar-year">
<h6>Sharpe Ratios for each calendar year<a class="headerlink" href="#sharpe-ratios-for-each-calendar-year" title="Permalink to this heading">#</a></h6>
<p>We need the risk-free rate <code class="docutils literal notranslate"><span class="pre">RF</span></code> from Ken French’s daily benchmark factors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>I think this easiest (and fastest approach) is to:</p>
<ol class="arabic simple">
<li><p>Calculate a data frame of excess returns</p></li>
<li><p>Use an anonymous (lambda) function</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_excess</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># note axis=0 for column-wise subtraction</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpes_a</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns_excess</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="p">)</span>

<span class="n">sharpes_a</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Total</th>
      <th>Intraday</th>
      <th>Overnight</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993</th>
      <td>0.7233</td>
      <td>-0.9172</td>
      <td>2.8057</td>
    </tr>
    <tr>
      <th>1994</th>
      <td>-0.2732</td>
      <td>-1.1871</td>
      <td>0.8819</td>
    </tr>
    <tr>
      <th>1995</th>
      <td>3.1845</td>
      <td>2.5275</td>
      <td>0.4197</td>
    </tr>
    <tr>
      <th>1996</th>
      <td>1.2247</td>
      <td>-0.1691</td>
      <td>1.6658</td>
    </tr>
    <tr>
      <th>1997</th>
      <td>1.2796</td>
      <td>-0.1781</td>
      <td>2.5564</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpes_a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">Calendar Year Sharpe Ratios&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f8172c21e8cd023d83053cd9bd88c6b3e49803b9a3ee0adf753555311c6f75fe.png" src="_images/f8172c21e8cd023d83053cd9bd88c6b3e49803b9a3ee0adf753555311c6f75fe.png" />
</div>
</div>
</section>
</section>
<section id="calculate-rolling-betas">
<h5>Calculate rolling betas<a class="headerlink" href="#calculate-rolling-betas" title="Permalink to this heading">#</a></h5>
<p>Calculate rolling capital asset pricing model (CAPM) betas for the MATANA stocks.</p>
<p>The CAPM says the risk premium on a stock depends on the risk-free rate, beta, and the risk premium on the market: $E(R_{stock}) = R_f + \beta_{stock} \times (E(R_{market}) - R_f)$.
We can calculate CAPM betas as: $\beta_{stock} = \frac{Cov(R_{stock} - R_f, R_{market} - R_f)}{Var(R_{market} - R_f)}$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matana</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;MSFT AAPL TSLA AMZN NVDA GOOG&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">matana</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  6 of 6 completed
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>-0.0522</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>-0.0734</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.0248</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.0290</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>A few notes:</p>
<ol class="arabic simple">
<li><p>Here the <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function is too smart for the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.
Our <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function matches stock and market data, but may not use 252 trading days at the end of the sample.
For example, in February 2023, we can slice a 252-trading-day window from the <code class="docutils literal notranslate"><span class="pre">matana</span></code> data frame.
However, the <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function does not use January and Februrary 2023 data because they are missing from the <code class="docutils literal notranslate"><span class="pre">ff</span></code> data frame.
The easiest fix is to slice the <code class="docutils literal notranslate"><span class="pre">matana</span></code> data frame to remove 2023 data before we apply the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method and <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function are <em>very slow</em> because they slice inefficiently!
We will write faster—but uglier—code below.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">betas_1</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 14.1 s, sys: 3.57 ms, total: 14.1 s
Wall time: 14.1 s
</pre></div>
</div>
</div>
</div>
<p>Here is the fast solution, which uses the optimized <code class="docutils literal notranslate"><span class="pre">.cov()</span></code> and <code class="docutils literal notranslate"><span class="pre">.var()</span></code> to calculate the numerator and denominator for $\beta$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">cov_2</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">])</span>
<span class="n">var_2</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">betas_2</span> <span class="o">=</span> <span class="n">cov_2</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">var_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 9.54 ms, sys: 0 ns, total: 9.54 ms
Wall time: 9.03 ms
</pre></div>
</div>
</div>
</div>
<p>These solutions are identical!
Even though <code class="docutils literal notranslate"><span class="pre">beta_2</span></code> is 1000 times faster than <code class="docutils literal notranslate"><span class="pre">beta_1</span></code>, you should use the approach that makes the most sense to you!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">betas_1</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">betas_2</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">betas_1</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Betas from Daily Returns</span><span class="se">\n</span><span class="s1">252-Trading-Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e22791d627abdd8be9438a05436284c4dabaf66d191aa7299a1af0f6c87d4441.png" src="_images/e22791d627abdd8be9438a05436284c4dabaf66d191aa7299a1af0f6c87d4441.png" />
</div>
</div>
</section>
<section id="calculate-rolling-sharpe-ratios">
<h5>Calculate rolling Sharpe Ratios<a class="headerlink" href="#calculate-rolling-sharpe-ratios" title="Permalink to this heading">#</a></h5>
<p>Calculate rolling Sharpe Ratios for the MATANA stocks.</p>
<p>The Sharpe Ratio is often used to evaluate fund managers.
The Sharpe Ratio is $SR_i = \frac{\overline{R_i - R_f}}{\sigma}$, where $\overline{R_i-R_f}$ is mean fund return relative to the risk-free rate over some period and $\sigma$ is the standard deviation of $R_i-R_f$ over the same period.
While the Sharpe Ratio is typically used for funds, we can apply it to a single stock to test our knowledge of the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.
Calculate and plot the one-year rolling Sharpe Ratio for the MATANA stocks using all available daily data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ann_fac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ann_fac</span> <span class="o">*</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>See the discussion in the beta exercise above about how we can end up with a result based on fewer than 252 trading days of data because the <code class="docutils literal notranslate"><span class="pre">sharpe()</span></code> function matches the <code class="docutils literal notranslate"><span class="pre">matana</span></code> and <code class="docutils literal notranslate"><span class="pre">ff</span></code> data frames <em>after</em> the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> mehtod slices a 252 trading day window.
The simplest solution is the remove the 2023 data from the <code class="docutils literal notranslate"><span class="pre">matana</span></code> data frame before we apply the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">sharpes_1</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 6.35 s, sys: 0 ns, total: 6.35 s
Wall time: 6.35 s
</pre></div>
</div>
</div>
</div>
<p>Here is the fast solution, which:</p>
<ol class="arabic simple">
<li><p>Uses the <code class="docutils literal notranslate"><span class="pre">.sub()</span></code> method to calculate excess returns</p></li>
<li><p>Then uses the optimized <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods to calculate the numerator and denominator for the Sharpe Ratios</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_2</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">std_2</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">sharpes_2</span> <span class="o">=</span> <span class="n">mean_2</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">std_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">sharpes_1</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">sharpes_2</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpes_1</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratios from Daily Returns</span><span class="se">\n</span><span class="s1">252-Trading-Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1e88030c2fe69e86f6bfbf839a93d52d41e5af5a1e288c401bc22751840eba9d.png" src="_images/1e88030c2fe69e86f6bfbf839a93d52d41e5af5a1e288c401bc22751840eba9d.png" />
</div>
</div>
</section>
<section id="does-more-frequent-rebalancing-increase-or-decrease-returns">
<h5>Does more frequent rebalancing increase or decrease returns?<a class="headerlink" href="#does-more-frequent-rebalancing-increase-or-decrease-returns" title="Permalink to this heading">#</a></h5>
<p>Compare decade-total returns for the following rebalancing frequencies:</p>
<ol class="arabic simple">
<li><p>Daily rebalancing</p></li>
<li><p>Monthly rebalancing</p></li>
<li><p>Annual rebalancing</p></li>
<li><p>Decade rebalancing</p></li>
</ol>
<p>Use equally-weighted portfolios of industry-level daily returns from French’s website: <code class="docutils literal notranslate"><span class="pre">'17_Industry_Portfolios_daily'</span></code>.</p>
<p><em><strong>This exercise is a little early, and we will revisit later in the course!</strong></em></p>
</section>
</section>
</section>
<span id="document-mckinney_11_practice_04"></span><section id="mckinney-chapter-11-practice-wednesday-11-45-am-section-4">
<h3>McKinney Chapter 11 - Practice (Wednesday 11:45 AM, Section 4)<a class="headerlink" href="#mckinney-chapter-11-practice-wednesday-11-45-am-section-4" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 4 mean was $87%$</p></li>
<li><p>Team Project 1 and Teammates Review 1 are due at 11:59 PM on Friday</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="which-are-larger-overnight-or-intraday-returns">
<h5>Which are larger, overnight or intraday returns?<a class="headerlink" href="#which-are-larger-overnight-or-intraday-returns" title="Permalink to this heading">#</a></h5>
<p>Yahoo! Finance provides easy acces to high-quality open, high, low, close (OHLC) and adjusted close price data.
However, Yahoo! Finance does not provide overnight or instraday returns directly.
Therefore, we need to use math to decompose daily returns into overnight and intraday returns.</p>
<p>Daily returns are defined as (adjusted) closing price to (adjusted) closing price returns.
Therefore, daily returns consist of overnight returns compounded with the intraday returns from the next day $(1 + R_{daily}) = (1 + R_{overnight}) \times (1 + R_{intraday})$ which we can rearrange to calculate overnight returns as $\frac{1 + R_{daily}}{1 + R_{intraday}} - 1 = R_{overnight}$.</p>
<p>We can calculate daily and intraday returns from Yahoo! Finance data as $R_{daily} = \frac{Adj\ Close_{t} - Adj\ Close_{t-1}}{Adj\ Close_{t-1}}$ and $R_{intraday} = \frac{Close - Open}{Open}$.</p>
<p>Compare the following for the SPY ETF:</p>
<ol class="arabic simple">
<li><p>Cumulative returns with all available data</p></li>
<li><p>Total returns for each calendar year</p></li>
<li><p>Total returns over rolling 252-trading-day windows</p></li>
<li><p>Total returns over rolling 12-months windows after calculating monthly returns
. Sharpe Ratios for each calendar year</p></li>
</ol>
<section id="cumulative-returns-with-all-available-data">
<h6>Cumulative returns with all available data<a class="headerlink" href="#cumulative-returns-with-all-available-data" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spy</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  1 of 1 completed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">spy</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">Total</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
        <span class="n">Intraday</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">Overnight</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Intraday&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">[[</span><span class="s1">&#39;Intraday&#39;</span><span class="p">,</span> <span class="s1">&#39;Overnight&#39;</span><span class="p">,</span> <span class="s1">&#39;Total&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">returns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Intraday</th>
      <th>Overnight</th>
      <th>Total</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-02-01</th>
      <td>0.0064</td>
      <td>0.0007</td>
      <td>0.0071</td>
    </tr>
    <tr>
      <th>1993-02-02</th>
      <td>0.0028</td>
      <td>-0.0007</td>
      <td>0.0021</td>
    </tr>
    <tr>
      <th>1993-02-03</th>
      <td>0.0091</td>
      <td>0.0014</td>
      <td>0.0106</td>
    </tr>
    <tr>
      <th>1993-02-04</th>
      <td>0.0007</td>
      <td>0.0035</td>
      <td>0.0042</td>
    </tr>
    <tr>
      <th>1993-02-05</th>
      <td>0.0000</td>
      <td>-0.0007</td>
      <td>-0.0007</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>Return</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Intraday</th>
      <td>7575.0000</td>
      <td>0.0000</td>
      <td>0.0097</td>
      <td>-0.0899</td>
      <td>-0.0042</td>
      <td>0.0004</td>
      <td>0.0047</td>
      <td>0.0930</td>
    </tr>
    <tr>
      <th>Overnight</th>
      <td>7575.0000</td>
      <td>0.0004</td>
      <td>0.0068</td>
      <td>-0.1045</td>
      <td>-0.0021</td>
      <td>0.0006</td>
      <td>0.0032</td>
      <td>0.0613</td>
    </tr>
    <tr>
      <th>Total</th>
      <td>7575.0000</td>
      <td>0.0004</td>
      <td>0.0119</td>
      <td>-0.1094</td>
      <td>-0.0045</td>
      <td>0.0007</td>
      <td>0.0059</td>
      <td>0.1452</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/334bda14ee5bf292e99376bcadc26355b70b90822e6f8dc561e433c7dbe0fea6.png" src="_images/334bda14ee5bf292e99376bcadc26355b70b90822e6f8dc561e433c7dbe0fea6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">totret</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="total-returns-for-each-calendar-year">
<h6>Total returns for each calendar year<a class="headerlink" href="#total-returns-for-each-calendar-year" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_a</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can use an anonymous (lambda) function to calculate total returns, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">returns_a</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">counts_a</span></code> to remove years with too few observations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counts_a</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_a</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">counts_a</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">250</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">Calendar Year Total Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d36763091bd2da5b0bd7f190769e61d1c512f41a0bbe68f89792e899b181c8d9.png" src="_images/d36763091bd2da5b0bd7f190769e61d1c512f41a0bbe68f89792e899b181c8d9.png" />
</div>
</div>
<hr class="docutils" />
<p>What is the difference between <em>cumulative</em> and <em>total</em> return?</p>
<ul class="simple">
<li><p>Total return is the return for the entire holding period, or one value for a range of dates</p></li>
<li><p>Cumulative returns is the total return at every single date in a range of dates</p></li>
</ul>
<p>Total Returns:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14.652961029877108
</pre></div>
</div>
</div>
</div>
<p>Cumulative Returns:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Date
1993-02-01    0.0071
1993-02-02    0.0092
1993-02-03    0.0199
1993-02-04    0.0242
1993-02-05    0.0235
               ...  
2023-02-23   14.8877
2023-02-24   14.7180
2023-02-27   14.7715
2023-02-28   14.7132
2023-03-01   14.6530
Name: Total, Length: 7575, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="total-returns-over-rolling-252-trading-day-windows">
<h6>Total returns over rolling 252-trading-day windows<a class="headerlink" href="#total-returns-over-rolling-252-trading-day-windows" title="Permalink to this heading">#</a></h6>
<p>We can repeat the total return calculation for 252-trading-day rolling windows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_r</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>

<span class="n">returns_r</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Intraday</th>
      <th>Overnight</th>
      <th>Total</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-02-01</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-03</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-04</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_r</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">252-Trading-Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8263a05ad89fb0e64368c006d13dd94c0dfb41bc8644ae40ee0f5557dde0d9eb.png" src="_images/8263a05ad89fb0e64368c006d13dd94c0dfb41bc8644ae40ee0f5557dde0d9eb.png" />
</div>
</div>
</section>
<section id="total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns">
<h6>Total returns over rolling 12-months windows after calculating monthly returns<a class="headerlink" href="#total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns" title="Permalink to this heading">#</a></h6>
<p>We can chain this operation!
Note the plot has the same general appearance, but is less noisy because we aggregate to monthly total returns first!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_mr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span> <span class="c1"># aggregate from daily to monthly</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span> <span class="c1"># ...calculate total returns</span>
    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="c1"># aggregate into 12-month rolling windows</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span> <span class="c1"># ...calculate total returns</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_mr</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">12-Month Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/68b3a799c69710aba3b785cdfe0b97208ccdd5253837ff4d1912809d8a0e5109.png" src="_images/68b3a799c69710aba3b785cdfe0b97208ccdd5253837ff4d1912809d8a0e5109.png" />
</div>
</div>
</section>
<section id="sharpe-ratios-for-each-calendar-year">
<h6>Sharpe Ratios for each calendar year<a class="headerlink" href="#sharpe-ratios-for-each-calendar-year" title="Permalink to this heading">#</a></h6>
<p>We need the risk-free rate <code class="docutils literal notranslate"><span class="pre">RF</span></code> from Ken French’s daily benchmark factors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>I think this easiest (and fastest approach) is to:</p>
<ol class="arabic simple">
<li><p>Calculate a data frame of excess returns</p></li>
<li><p>Use an anonymous (lambda) function</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_excess</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># note axis=0 for column-wise subtraction</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpes_a</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns_excess</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="p">)</span>

<span class="n">sharpes_a</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Intraday</th>
      <th>Overnight</th>
      <th>Total</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993</th>
      <td>-0.9172</td>
      <td>2.8058</td>
      <td>0.7233</td>
    </tr>
    <tr>
      <th>1994</th>
      <td>-1.1871</td>
      <td>0.8819</td>
      <td>-0.2732</td>
    </tr>
    <tr>
      <th>1995</th>
      <td>2.5275</td>
      <td>0.4197</td>
      <td>3.1845</td>
    </tr>
    <tr>
      <th>1996</th>
      <td>-0.1691</td>
      <td>1.6658</td>
      <td>1.2247</td>
    </tr>
    <tr>
      <th>1997</th>
      <td>-0.1781</td>
      <td>2.5564</td>
      <td>1.2796</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpes_a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">Calendar Year Sharpe Ratios&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7a0daea46b562bb3d445b9d30abf98b5d7aa24e837cacf360629ff41f861503b.png" src="_images/7a0daea46b562bb3d445b9d30abf98b5d7aa24e837cacf360629ff41f861503b.png" />
</div>
</div>
</section>
</section>
<section id="calculate-rolling-betas">
<h5>Calculate rolling betas<a class="headerlink" href="#calculate-rolling-betas" title="Permalink to this heading">#</a></h5>
<p>Calculate rolling capital asset pricing model (CAPM) betas for the MATANA stocks.</p>
<p>The CAPM says the risk premium on a stock depends on the risk-free rate, beta, and the risk premium on the market: $E(R_{stock}) = R_f + \beta_{stock} \times (E(R_{market}) - R_f)$.
We can calculate CAPM betas as: $\beta_{stock} = \frac{Cov(R_{stock} - R_f, R_{market} - R_f)}{Var(R_{market} - R_f)}$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matana</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;MSFT AAPL TSLA AMZN NVDA GOOG&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">matana</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>-0.0522</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>-0.0734</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.0248</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.0290</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>A few notes:</p>
<ol class="arabic simple">
<li><p>Here the <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function is too smart for the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.
Our <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function matches stock and market data, but may not use 252 trading days at the end of the sample.
For example, in February 2023, we can slice a 252-trading-day window from the <code class="docutils literal notranslate"><span class="pre">matana</span></code> data frame.
However, the <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function does not use January and Februrary 2023 data because they are missing from the <code class="docutils literal notranslate"><span class="pre">ff</span></code> data frame.
The easiest fix is to slice the <code class="docutils literal notranslate"><span class="pre">matana</span></code> data frame to remove 2023 data before we apply the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method and <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function are <em>very slow</em> because they slice inefficiently!
We will write faster—but uglier—code below.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">betas_1</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wall time: 24.8 s
</pre></div>
</div>
</div>
</div>
<p>Here is the fast solution, which uses the optimized <code class="docutils literal notranslate"><span class="pre">.cov()</span></code> and <code class="docutils literal notranslate"><span class="pre">.var()</span></code> to calculate the numerator and denominator for $\beta$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">cov_2</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">])</span>
<span class="n">var_2</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">betas_2</span> <span class="o">=</span> <span class="n">cov_2</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">var_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wall time: 20.9 ms
</pre></div>
</div>
</div>
</div>
<p>These solutions are identical!
Even though <code class="docutils literal notranslate"><span class="pre">beta_2</span></code> is 1000 times faster than <code class="docutils literal notranslate"><span class="pre">beta_1</span></code>, you should use the approach that makes the most sense to you!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">betas_1</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">betas_2</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">betas_1</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Betas from Daily Returns</span><span class="se">\n</span><span class="s1">252-Trading-Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fa254b5f87bdfba6bd42ce01883937d07ef250c9d46e61931b206d4369c814f6.png" src="_images/fa254b5f87bdfba6bd42ce01883937d07ef250c9d46e61931b206d4369c814f6.png" />
</div>
</div>
</section>
<section id="calculate-rolling-sharpe-ratios">
<h5>Calculate rolling Sharpe Ratios<a class="headerlink" href="#calculate-rolling-sharpe-ratios" title="Permalink to this heading">#</a></h5>
<p>Calculate rolling Sharpe Ratios for the MATANA stocks.</p>
<p>The Sharpe Ratio is often used to evaluate fund managers.
The Sharpe Ratio is $SR_i = \frac{\overline{R_i - R_f}}{\sigma}$, where $\overline{R_i-R_f}$ is mean fund return relative to the risk-free rate over some period and $\sigma$ is the standard deviation of $R_i-R_f$ over the same period.
While the Sharpe Ratio is typically used for funds, we can apply it to a single stock to test our knowledge of the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.
Calculate and plot the one-year rolling Sharpe Ratio for the MATANA stocks using all available daily data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ann_fac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ann_fac</span> <span class="o">*</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>See the discussion in the beta exercise above about how we can end up with a result based on fewer than 252 trading days of data because the <code class="docutils literal notranslate"><span class="pre">sharpe()</span></code> function matches the <code class="docutils literal notranslate"><span class="pre">matana</span></code> and <code class="docutils literal notranslate"><span class="pre">ff</span></code> data frames <em>after</em> the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> mehtod slices a 252 trading day window.
The simplest solution is the remove the 2023 data from the <code class="docutils literal notranslate"><span class="pre">matana</span></code> data frame before we apply the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">sharpes_1</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wall time: 13 s
</pre></div>
</div>
</div>
</div>
<p>Here is the fast solution, which:</p>
<ol class="arabic simple">
<li><p>Uses the <code class="docutils literal notranslate"><span class="pre">.sub()</span></code> method to calculate excess returns</p></li>
<li><p>Then uses the optimized <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods to calculate the numerator and denominator for the Sharpe Ratios</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_2</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">std_2</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">sharpes_2</span> <span class="o">=</span> <span class="n">mean_2</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">std_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">sharpes_1</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">sharpes_2</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpes_1</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratios from Daily Returns</span><span class="se">\n</span><span class="s1">252-Trading-Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1d57bfaf9da951ace6159176d2c88cb345d6b95e852f5a06f7ad29b49a82f99d.png" src="_images/1d57bfaf9da951ace6159176d2c88cb345d6b95e852f5a06f7ad29b49a82f99d.png" />
</div>
</div>
</section>
<section id="does-more-frequent-rebalancing-increase-or-decrease-returns">
<h5>Does more frequent rebalancing increase or decrease returns?<a class="headerlink" href="#does-more-frequent-rebalancing-increase-or-decrease-returns" title="Permalink to this heading">#</a></h5>
<p>Compare decade-total returns for the following rebalancing frequencies:</p>
<ol class="arabic simple">
<li><p>Daily rebalancing</p></li>
<li><p>Monthly rebalancing</p></li>
<li><p>Annual rebalancing</p></li>
<li><p>Decade rebalancing</p></li>
</ol>
<p>Use equally-weighted portfolios of industry-level daily returns from French’s website: <code class="docutils literal notranslate"><span class="pre">'17_Industry_Portfolios_daily'</span></code>.</p>
<p><em><strong>This exercise is a little early, and we will revisit later in the course!</strong></em></p>
</section>
</section>
</section>
<span id="document-mckinney_11_practice_02"></span><section id="mckinney-chapter-11-practice-wednesday-2-45-pm-section-2">
<h3>McKinney Chapter 11 - Practice (Wednesday 2:45 PM, Section 2)<a class="headerlink" href="#mckinney-chapter-11-practice-wednesday-2-45-pm-section-2" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 4 mean was $87%$</p></li>
<li><p>Project 1 and Teammates Review 1 at due Friday at 11:59 PM</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="which-are-larger-overnight-or-intraday-returns">
<h5>Which are larger, overnight or intraday returns?<a class="headerlink" href="#which-are-larger-overnight-or-intraday-returns" title="Permalink to this heading">#</a></h5>
<p>Yahoo! Finance provides easy acces to high-quality open, high, low, close (OHLC) and adjusted close price data.
However, Yahoo! Finance does not provide overnight or instraday returns directly.
Therefore, we need to use math to decompose daily returns into overnight and intraday returns.</p>
<p>Daily returns are defined as (adjusted) closing price to (adjusted) closing price returns.
Therefore, daily returns consist of overnight returns compounded with the intraday returns from the next day $(1 + R_{daily}) = (1 + R_{overnight}) \times (1 + R_{intraday})$ which we can rearrange to calculate overnight returns as $\frac{1 + R_{daily}}{1 + R_{intraday}} - 1 = R_{overnight}$.</p>
<p>We can calculate daily and intraday returns from Yahoo! Finance data as $R_{daily} = \frac{Adj\ Close_{t} - Adj\ Close_{t-1}}{Adj\ Close_{t-1}}$ and $R_{intraday} = \frac{Close - Open}{Open}$.</p>
<p>Compare the following for the SPY ETF:</p>
<ol class="arabic simple">
<li><p>Cumulative returns with all available data</p></li>
<li><p>Total returns for each calendar year</p></li>
<li><p>Total returns over rolling 252-trading-day windows</p></li>
<li><p>Total returns over rolling 12-months windows after calculating monthly returns</p></li>
<li><p>Sharpe Ratios for each calendar year</p></li>
</ol>
<section id="cumulative-returns-with-all-available-data">
<h6>Cumulative returns with all available data<a class="headerlink" href="#cumulative-returns-with-all-available-data" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spy</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">spy</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">Total</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
        <span class="n">Intraday</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">Overnight</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Intraday&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">[[</span><span class="s1">&#39;Intraday&#39;</span><span class="p">,</span> <span class="s1">&#39;Overnight&#39;</span><span class="p">,</span> <span class="s1">&#39;Total&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">returns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Intraday</th>
      <th>Overnight</th>
      <th>Total</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-02-01</th>
      <td>0.0064</td>
      <td>0.0007</td>
      <td>0.0071</td>
    </tr>
    <tr>
      <th>1993-02-02</th>
      <td>0.0028</td>
      <td>-0.0007</td>
      <td>0.0021</td>
    </tr>
    <tr>
      <th>1993-02-03</th>
      <td>0.0091</td>
      <td>0.0014</td>
      <td>0.0106</td>
    </tr>
    <tr>
      <th>1993-02-04</th>
      <td>0.0007</td>
      <td>0.0035</td>
      <td>0.0042</td>
    </tr>
    <tr>
      <th>1993-02-05</th>
      <td>0.0000</td>
      <td>-0.0007</td>
      <td>-0.0007</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Return
Intraday       1.2913
Overnight   1445.3413
Total       1465.2966
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Return
Intraday    0.0049
Overnight   0.0384
Total       0.0434
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4637dc5fc25d64889a953edb1af421e4e54de699eb4b79cdcedfaf0f259297a1.png" src="_images/4637dc5fc25d64889a953edb1af421e4e54de699eb4b79cdcedfaf0f259297a1.png" />
</div>
</div>
</section>
<section id="total-returns-for-each-calendar-year">
<h6>Total returns for each calendar year<a class="headerlink" href="#total-returns-for-each-calendar-year" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">totret</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_a</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">.count()</span></code> to remove years with too few observations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counts_a</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_a</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">counts_a</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">250</span> <span class="p">]</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">Calendar Year Total Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2e2e24a0c13573a77d5d424c1fa0b0a8d52191dc859ea5d9dae85afca7da1ea5.png" src="_images/2e2e24a0c13573a77d5d424c1fa0b0a8d52191dc859ea5d9dae85afca7da1ea5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">returns_a</span><span class="p">[</span><span class="s1">&#39;Overnight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">returns_a</span><span class="p">[</span><span class="s1">&#39;Intraday&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7096774193548387
</pre></div>
</div>
</div>
</div>
</section>
<section id="total-returns-over-rolling-252-trading-day-windows">
<h6>Total returns over rolling 252-trading-day windows<a class="headerlink" href="#total-returns-over-rolling-252-trading-day-windows" title="Permalink to this heading">#</a></h6>
<p>We can repeat the total return calculation for 252-trading-day rolling windows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_r</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>

<span class="n">returns_r</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Intraday</th>
      <th>Overnight</th>
      <th>Total</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-02-01</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-02</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-03</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-04</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1993-02-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_r</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">252-Trading-Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c9b1c36c6c7d1cbb6121e5ff94e880ecce649bcdc60454fb0588acff52405002.png" src="_images/c9b1c36c6c7d1cbb6121e5ff94e880ecce649bcdc60454fb0588acff52405002.png" />
</div>
</div>
</section>
<section id="total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns">
<h6>Total returns over rolling 12-months windows after calculating monthly returns<a class="headerlink" href="#total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns" title="Permalink to this heading">#</a></h6>
<p>We can chain this operation!
Note the plot has the same general appearance, but is less noisy because we aggregate to monthly total returns first!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_mr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span> <span class="c1"># aggregate from daily to monthly</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span> <span class="c1"># ...calculate total returns</span>
    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="c1"># aggregate into 12-month rolling windows</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span> <span class="c1"># ...calculate total returns</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_mr</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">12-Month Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6e8c1d08b6f6d57e8ab0d326196e4260bb87f18741f3423ae4362abdc0b2c9e9.png" src="_images/6e8c1d08b6f6d57e8ab0d326196e4260bb87f18741f3423ae4362abdc0b2c9e9.png" />
</div>
</div>
</section>
<section id="sharpe-ratios-for-each-calendar-year">
<h6>Sharpe Ratios for each calendar year<a class="headerlink" href="#sharpe-ratios-for-each-calendar-year" title="Permalink to this heading">#</a></h6>
<p>We need the risk-free rate <code class="docutils literal notranslate"><span class="pre">RF</span></code> from Ken French’s daily benchmark factors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>I think this easiest (and fastest approach) is to:</p>
<ol class="arabic simple">
<li><p>Calculate a data frame of excess returns</p></li>
<li><p>Use an anonymous (lambda) function</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_excess</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># note axis=0 for column-wise subtraction</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpes_a</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns_excess</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="p">)</span>

<span class="n">sharpes_a</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Return</th>
      <th>Intraday</th>
      <th>Overnight</th>
      <th>Total</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993</th>
      <td>-0.9172</td>
      <td>2.8057</td>
      <td>0.7233</td>
    </tr>
    <tr>
      <th>1994</th>
      <td>-1.1871</td>
      <td>0.8819</td>
      <td>-0.2732</td>
    </tr>
    <tr>
      <th>1995</th>
      <td>2.5275</td>
      <td>0.4197</td>
      <td>3.1845</td>
    </tr>
    <tr>
      <th>1996</th>
      <td>-0.1691</td>
      <td>1.6658</td>
      <td>1.2247</td>
    </tr>
    <tr>
      <th>1997</th>
      <td>-0.1781</td>
      <td>2.5565</td>
      <td>1.2796</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpes_a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intraday and Overnight Return Decomposition</span><span class="se">\n</span><span class="s1">Calendar Year Sharpe Ratios&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7a0daea46b562bb3d445b9d30abf98b5d7aa24e837cacf360629ff41f861503b.png" src="_images/7a0daea46b562bb3d445b9d30abf98b5d7aa24e837cacf360629ff41f861503b.png" />
</div>
</div>
</section>
</section>
<section id="calculate-rolling-betas">
<h5>Calculate rolling betas<a class="headerlink" href="#calculate-rolling-betas" title="Permalink to this heading">#</a></h5>
<p>Calculate rolling capital asset pricing model (CAPM) betas for the MATANA stocks.</p>
<p>The CAPM says the risk premium on a stock depends on the risk-free rate, beta, and the risk premium on the market: $E(R_{stock}) = R_f + \beta_{stock} \times (E(R_{market}) - R_f)$.
We can calculate CAPM betas as: $\beta_{stock} = \frac{Cov(R_{stock} - R_f, R_{market} - R_f)}{Var(R_{market} - R_f)}$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matana</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;MSFT AAPL TSLA AMZN NVDA GOOG&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">matana</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>-0.0522</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>-0.0734</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.0248</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.0290</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>A few notes:</p>
<ol class="arabic simple">
<li><p>Here the <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function is too smart for the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.
Our <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function matches stock and market data, but may not use 252 trading days at the end of the sample.
For example, in February 2023, we can slice a 252-trading-day window from the <code class="docutils literal notranslate"><span class="pre">matana</span></code> data frame.
However, the <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function does not use January and Februrary 2023 data because they are missing from the <code class="docutils literal notranslate"><span class="pre">ff</span></code> data frame.
The easiest fix is to slice the <code class="docutils literal notranslate"><span class="pre">matana</span></code> data frame to remove 2023 data before we apply the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method and <code class="docutils literal notranslate"><span class="pre">beta()</span></code> function are <em>very slow</em> because they slice inefficiently!
We will write faster—but uglier—code below.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">betas_1</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wall time: 24.4 s
</pre></div>
</div>
</div>
</div>
<p>Here is the fast solution, which uses the optimized <code class="docutils literal notranslate"><span class="pre">.cov()</span></code> and <code class="docutils literal notranslate"><span class="pre">.var()</span></code> to calculate the numerator and denominator for $\beta$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">cov_2</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">])</span>
<span class="n">var_2</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">betas_2</span> <span class="o">=</span> <span class="n">cov_2</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">var_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wall time: 30.9 ms
</pre></div>
</div>
</div>
</div>
<p>These solutions are identical!
Even though <code class="docutils literal notranslate"><span class="pre">beta_2</span></code> is 1000 times faster than <code class="docutils literal notranslate"><span class="pre">beta_1</span></code>, you should use the approach that makes the most sense to you!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">betas_1</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">betas_2</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">betas_1</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Betas from Daily Returns</span><span class="se">\n</span><span class="s1">252-Trading-Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0614bba1237a3dd35963b0a5594b60145b782cd7979b90672df38df363f6ef61.png" src="_images/0614bba1237a3dd35963b0a5594b60145b782cd7979b90672df38df363f6ef61.png" />
</div>
</div>
</section>
<section id="calculate-rolling-sharpe-ratios">
<h5>Calculate rolling Sharpe Ratios<a class="headerlink" href="#calculate-rolling-sharpe-ratios" title="Permalink to this heading">#</a></h5>
<p>Calculate rolling Sharpe Ratios for the MATANA stocks.</p>
<p>The Sharpe Ratio is often used to evaluate fund managers.
The Sharpe Ratio is $SR_i = \frac{\overline{R_i - R_f}}{\sigma}$, where $\overline{R_i-R_f}$ is mean fund return relative to the risk-free rate over some period and $\sigma$ is the standard deviation of $R_i-R_f$ over the same period.
While the Sharpe Ratio is typically used for funds, we can apply it to a single stock to test our knowledge of the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.
Calculate and plot the one-year rolling Sharpe Ratio for the MATANA stocks using all available daily data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ann_fac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ann_fac</span> <span class="o">*</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>See the discussion in the beta exercise above about how we can end up with a result based on fewer than 252 trading days of data because the <code class="docutils literal notranslate"><span class="pre">sharpe()</span></code> function matches the <code class="docutils literal notranslate"><span class="pre">matana</span></code> and <code class="docutils literal notranslate"><span class="pre">ff</span></code> data frames <em>after</em> the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> mehtod slices a 252 trading day window.
The simplest solution is the remove the 2023 data from the <code class="docutils literal notranslate"><span class="pre">matana</span></code> data frame before we apply the <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">sharpes_1</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wall time: 12.3 s
</pre></div>
</div>
</div>
</div>
<p>Here is the fast solution, which:</p>
<ol class="arabic simple">
<li><p>Uses the <code class="docutils literal notranslate"><span class="pre">.sub()</span></code> method to calculate excess returns</p></li>
<li><p>Then uses the optimized <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> and <code class="docutils literal notranslate"><span class="pre">.std()</span></code> methods to calculate the numerator and denominator for the Sharpe Ratios</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_2</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">std_2</span> <span class="o">=</span> <span class="n">matana</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">sharpes_2</span> <span class="o">=</span> <span class="n">mean_2</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">std_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">sharpes_1</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">sharpes_2</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sharpes_1</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratios from Daily Returns</span><span class="se">\n</span><span class="s1">252-Trading-Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9e2712e079320e7f44e37d6c7d85689ebf4e5c2c409bbb4e25223614a8b66a97.png" src="_images/9e2712e079320e7f44e37d6c7d85689ebf4e5c2c409bbb4e25223614a8b66a97.png" />
</div>
</div>
</section>
<section id="does-more-frequent-rebalancing-increase-or-decrease-returns">
<h5>Does more frequent rebalancing increase or decrease returns?<a class="headerlink" href="#does-more-frequent-rebalancing-increase-or-decrease-returns" title="Permalink to this heading">#</a></h5>
<p>Compare decade-total returns for the following rebalancing frequencies:</p>
<ol class="arabic simple">
<li><p>Daily rebalancing</p></li>
<li><p>Monthly rebalancing</p></li>
<li><p>Annual rebalancing</p></li>
<li><p>Decade rebalancing</p></li>
</ol>
<p>Use equally-weighted portfolios of industry-level daily returns from French’s website: <code class="docutils literal notranslate"><span class="pre">'17_Industry_Portfolios_daily'</span></code>.</p>
<p><em><strong>This exercise is a little early, and we will revisit later in the course!</strong></em></p>
</section>
</section>
</section>
</div>
</section>
<span id="document-herron_02_lecture"></span><section id="herron-topic-2-trading-strategies">
<h2>Herron Topic 2 - Trading Strategies<a class="headerlink" href="#herron-topic-2-trading-strategies" title="Permalink to this heading">#</a></h2>
<p>This notebook covers trading strategies based on technical analysis in three parts:</p>
<ol class="arabic simple">
<li><p>What is technical analysis?</p></li>
<li><p>Why might trading strategies based on technical analysis work (or not work)?</p></li>
<li><p>Implement a simple moving average (SMA) trading strategy</p></li>
</ol>
<p>I based this lecture notebook on <a class="reference external" href="https://book.ivo-welch.info/read/source5.mba/12-effbehav.pdf">chapter 12 of Ivo Welch’s (free) <em>Corporate Finance</em> textbook</a> and chapter 2 of <a class="reference external" href="https://onesearch.library.northeastern.edu/permalink/01NEU_INST/i2gqis/alma9952082522901401">Eryk Lewinson’s <em>Python for Finance Cookbook</em></a>.
The practice notebook will cover several other trading strategies based on technical analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="what-is-technical-analysis">
<h3>What is technical analysis?<a class="headerlink" href="#what-is-technical-analysis" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Technical_analysis">Technical analysis</a> is a methodology that analyzes past market data (e.g., past prices and volume) in an attempt to forecast future price movements.
If technical analysis can predict future price movements, the market is not weak-form efficient.
Ivo Welch provides the three degrees of market efficiency in section 12.2 of <a class="reference external" href="https://book.ivo-welch.info/read/source5.mba/12-effbehav.pdf">chapter 12 of his (free) <em>Corporate Finance</em> textbook</a>:</p>
<blockquote>
<div><p>The Traditional Classification
The traditional definition of market efficiency focuses on information. In the traditional classification, market efficiency comes in one of three primary degrees: weak,
semi-strong, and strong.</p>
<p><strong>Weak market efficiency</strong> says that all information in past prices is reflected in today’s
stock prices so that technical analysis (trading based solely on historical price
patterns) cannot be used to beat the market. Put differently, the market is the
best technical analyst.</p>
<p><strong>Semistrong market efficiency</strong> says that all public information is reflected in today’s
stock prices, so that neither fundamental trading (based on underlying firm
fundamentals, such as cash flows or discount rates) nor technical analysis can
be used to beat the market. Put differently, the market is both the best technical
and the best fundamental analyst.</p>
<p><strong>Strong market efficiency</strong> says that all information, both public and private, is reflected in today’s stock prices, so that nothing — not even private insider
information — can be used to beat the market. Put differently, the market is
the best analyst and cannot be beat.</p>
<p>In this traditional classification, all finance professors
most U.S. financial markets are not strong-form efficient: Insider trading may be
illegal, but it works. However, there are still arguments as to which markets are only
semi-strong-form efficient or even only weak-form efficient.</p>
</div></blockquote>
<p>Section 12.2 goes on to provide Welch’s own taxonomy of true, firm, mild, and nonbelievers in market efficiency.
Chapter 12 summarizes market efficiency, classical finance, behavioral finance, arbitrage, limits to arbitrage, and their consequences for managers and investors.
We will focus on technical analysis in this notebook, but chapter 12 is excellent.</p>
</section>
<section id="why-might-trading-strategies-based-on-technical-analysis-work-or-not">
<h3>Why might trading strategies based on technical analysis work or not?<a class="headerlink" href="#why-might-trading-strategies-based-on-technical-analysis-work-or-not" title="Permalink to this heading">#</a></h3>
<section id="work">
<h4>…Work?<a class="headerlink" href="#work" title="Permalink to this heading">#</a></h4>
<p>Technical analysis relies on a few ideas:</p>
<ol class="arabic simple">
<li><p>Market prices and volume reflect all relevant information, so we can focus on past prices and volume instead of fundamentals and news.</p></li>
<li><p>Market prices move in trends and patterns driven by market participants.</p></li>
<li><p>These trends and patterns tend to repeat themselves because market participants create them.</p></li>
</ol>
</section>
<section id="or-not">
<h4>…Or Not?<a class="headerlink" href="#or-not" title="Permalink to this heading">#</a></h4>
<p>The logic above is reasonable.
However, if past market prices reflect all relevant information, they should also reflect any prices trends they predict.
Therefore, any patterns should be self-defeating, and market prices should follow <a class="reference external" href="https://en.wikipedia.org/wiki/Random_walk_hypothesis">a random walk</a>.
As well, the signal-to-noise ratio in market prices is high!
Still, technical analysis provides an opportunity to learn how to implement and back-test trading strategies in Python.</p>
<section id="a-random-walk">
<h5>A Random Walk<a class="headerlink" href="#a-random-walk" title="Permalink to this heading">#</a></h5>
<p>In a random walk, the price tomorrow equals the price today plus a tiny drift plus noise.
In math terms, a random walk is $P_{t} = \rho P_{t-1} + m P_{t-1} + \varepsilon$, where $m$ is a small drift term and $E[\varepsilon] = 0$.
If $\rho &gt; 1$, prices would quickly increase, and, if $\rho &lt; 1$, prices would quickly decrease.
Let us examine the historical record.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Mkt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ff</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
      <th>Mkt</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07-01</th>
      <td>0.0010</td>
      <td>-0.0025</td>
      <td>-0.0027</td>
      <td>0.0001</td>
      <td>0.0011</td>
    </tr>
    <tr>
      <th>1926-07-02</th>
      <td>0.0045</td>
      <td>-0.0033</td>
      <td>-0.0006</td>
      <td>0.0001</td>
      <td>0.0046</td>
    </tr>
    <tr>
      <th>1926-07-06</th>
      <td>0.0017</td>
      <td>0.0030</td>
      <td>-0.0039</td>
      <td>0.0001</td>
      <td>0.0018</td>
    </tr>
    <tr>
      <th>1926-07-07</th>
      <td>0.0009</td>
      <td>-0.0058</td>
      <td>0.0002</td>
      <td>0.0001</td>
      <td>0.0010</td>
    </tr>
    <tr>
      <th>1926-07-08</th>
      <td>0.0021</td>
      <td>-0.0038</td>
      <td>0.0019</td>
      <td>0.0001</td>
      <td>0.0022</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can use market returns to impute market prices relative to the last day of June 1926.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

<span class="n">price</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Date
2022-12-23   9266.3996
2022-12-27   9220.6236
2022-12-28   9108.6852
2022-12-29   9280.4750
2022-12-30   9261.5429
Name: Mkt, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Imputed Market Prices</span><span class="se">\n</span><span class="s1">Assuming $1 on the Last Day of June 1926&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Imputed Market Price ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/74bcadb8c1c6207545ff28a0384a656c7173b0d1bde628305a9a10ce18b15a66.png" src="_images/74bcadb8c1c6207545ff28a0384a656c7173b0d1bde628305a9a10ce18b15a66.png" />
</div>
</div>
<p>We need lagged prices to estimate $\rho$.
We will add 10 lags of $P$ to help us understand the relation between past and future prices.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price_lags</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">price</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)],</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Lag </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">price_lags</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Price</th>
      <th>Lag 0</th>
      <th>Lag 1</th>
      <th>Lag 2</th>
      <th>Lag 3</th>
      <th>Lag 4</th>
      <th>Lag 5</th>
      <th>Lag 6</th>
      <th>Lag 7</th>
      <th>Lag 8</th>
      <th>Lag 9</th>
      <th>Lag 10</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07-01</th>
      <td>1.0011</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1926-07-02</th>
      <td>1.0057</td>
      <td>1.0011</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1926-07-06</th>
      <td>1.0075</td>
      <td>1.0057</td>
      <td>1.0011</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1926-07-07</th>
      <td>1.0085</td>
      <td>1.0075</td>
      <td>1.0057</td>
      <td>1.0011</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1926-07-08</th>
      <td>1.0107</td>
      <td>1.0085</td>
      <td>1.0075</td>
      <td>1.0057</td>
      <td>1.0011</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">price_lags</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">corr</span><span class="p">()</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Lag 0&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Correlations with Imputed Market Price&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Correlation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/eac89e8ff5500058d692b5612039ae3acfea74fe994cd182cee82f9787c996a8.png" src="_images/eac89e8ff5500058d692b5612039ae3acfea74fe994cd182cee82f9787c996a8.png" />
</div>
</div>
<p>But these are <em>pairwise</em> correlations.
If we estimate <em>conditional</em> correlations, we see that all the price information is in the first lag!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">price_lags</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s1">&#39;Lag 0&#39;</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">_</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Lag 0&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;HAC&#39;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxlags&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
<span class="n">fit</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>          <td>Lag 0</td>      <th>  R-squared:         </th>  <td>   1.000</td>  
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th>  <td>   1.000</td>  
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th>  <td>1.505e+06</td> 
</tr>
<tr>
  <th>Date:</th>             <td>Mon, 13 Mar 2023</td> <th>  Prob (F-statistic):</th>   <td>  0.00</td>   
</tr>
<tr>
  <th>Time:</th>                 <td>14:11:49</td>     <th>  Log-Likelihood:    </th> <td>-1.1988e+05</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td> 25389</td>      <th>  AIC:               </th>  <td>2.398e+05</td> 
</tr>
<tr>
  <th>Df Residuals:</th>          <td> 25378</td>      <th>  BIC:               </th>  <td>2.399e+05</td> 
</tr>
<tr>
  <th>Df Model:</th>              <td>    10</td>      <th>                     </th>      <td> </td>     
</tr>
<tr>
  <th>Covariance Type:</th>         <td>HAC</td>       <th>                     </th>      <td> </td>     
</tr>
</table>
<table class="simpletable">
<tr>
     <td></td>       <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>const</th>  <td>    0.1325</td> <td>    0.155</td> <td>    0.854</td> <td> 0.393</td> <td>   -0.171</td> <td>    0.436</td>
</tr>
<tr>
  <th>Lag 1</th>  <td>    0.9377</td> <td>    0.037</td> <td>   25.613</td> <td> 0.000</td> <td>    0.866</td> <td>    1.009</td>
</tr>
<tr>
  <th>Lag 2</th>  <td>    0.0918</td> <td>    0.064</td> <td>    1.445</td> <td> 0.148</td> <td>   -0.033</td> <td>    0.216</td>
</tr>
<tr>
  <th>Lag 3</th>  <td>   -0.0359</td> <td>    0.041</td> <td>   -0.880</td> <td> 0.379</td> <td>   -0.116</td> <td>    0.044</td>
</tr>
<tr>
  <th>Lag 4</th>  <td>   -0.0331</td> <td>    0.046</td> <td>   -0.714</td> <td> 0.475</td> <td>   -0.124</td> <td>    0.058</td>
</tr>
<tr>
  <th>Lag 5</th>  <td>    0.0473</td> <td>    0.042</td> <td>    1.122</td> <td> 0.262</td> <td>   -0.035</td> <td>    0.130</td>
</tr>
<tr>
  <th>Lag 6</th>  <td>   -0.0676</td> <td>    0.045</td> <td>   -1.504</td> <td> 0.133</td> <td>   -0.156</td> <td>    0.020</td>
</tr>
<tr>
  <th>Lag 7</th>  <td>    0.1294</td> <td>    0.052</td> <td>    2.478</td> <td> 0.013</td> <td>    0.027</td> <td>    0.232</td>
</tr>
<tr>
  <th>Lag 8</th>  <td>   -0.1415</td> <td>    0.059</td> <td>   -2.400</td> <td> 0.016</td> <td>   -0.257</td> <td>   -0.026</td>
</tr>
<tr>
  <th>Lag 9</th>  <td>    0.1608</td> <td>    0.050</td> <td>    3.236</td> <td> 0.001</td> <td>    0.063</td> <td>    0.258</td>
</tr>
<tr>
  <th>Lag 10</th> <td>   -0.0887</td> <td>    0.034</td> <td>   -2.576</td> <td> 0.010</td> <td>   -0.156</td> <td>   -0.021</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>17230.148</td> <th>  Durbin-Watson:     </th>  <td>   1.995</td>  
</tr>
<tr>
  <th>Prob(Omnibus):</th>  <td> 0.000</td>   <th>  Jarque-Bera (JB):  </th> <td>6700094.359</td>
</tr>
<tr>
  <th>Skew:</th>           <td>-2.073</td>   <th>  Prob(JB):          </th>  <td>    0.00</td>  
</tr>
<tr>
  <th>Kurtosis:</th>       <td>82.475</td>   <th>  Cond. No.          </th>  <td>8.09e+03</td>  
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors are heteroscedasticity and autocorrelation robust (HAC) using 10 lags and without small sample correction<br/>[2] The condition number is large, 8.09e+03. This might indicate that there are<br/>strong multicollinearity or other numerical problems.</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">price_lags</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
    <span class="n">height</span><span class="o">=</span><span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
    <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">fit</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Conditional Correlations with Imputed Market Price</span><span class="se">\n</span><span class="s1">Bars Indicate $\pm 2$ Standard Errors&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Conditional Correlation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/987afc9d4034d1d563d4820055e62ac2b57f72da7a88925775f24682af7908f2.png" src="_images/987afc9d4034d1d563d4820055e62ac2b57f72da7a88925775f24682af7908f2.png" />
</div>
</div>
</section>
<section id="signal-to-noise-ratio">
<h5>Signal-to-Noise Ratio<a class="headerlink" href="#signal-to-noise-ratio" title="Permalink to this heading">#</a></h5>
<p>Recall, we can express a random walk as $P_{t} = \rho P_{t-1} + m P_{t-1} + \varepsilon_t$.
Since $\rho = 1$, we can subtract $P_{t-1}$ from both sides, then divide by $P_{t-1}$ on both sides.
This transformation expresses a random walk in terms of returns: $r_{t-1,t} = m + e_t$, where $E[e_t] = 0$ and $SD[e_t] = s$, so $E[r_{t-1, t}] = m$.
We can think of the signal-to-noise ratio as $\frac{m}{s}$.
How high is this ratio?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Here $m$ is about 4 basis points per day!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0004
</pre></div>
</div>
</div>
</div>
<p>However, $s$ is about 108 basis points per day!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0108
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">/</span><span class="n">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0386
</pre></div>
</div>
</div>
</div>
<p>Means grow linearly with time, while standard deviations growth with the square-root of time.
Therefore, even with a 1 basis point signal, we need a lot of data to make sure this 1 basis point signal is real!
For example, if we want $\sqrt{t} \times \frac{1}{s} \geq 2$, we need $t \geq \left(2 \times \frac{s}{1} \right)^2$ days!
Even with market noise, which is diversified and low, we need more than 100 years of data!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">s</span> <span class="o">/</span> <span class="mf">0.0001</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">365</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>128.4479
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="implement-a-simple-moving-average-sma-trading-strategy">
<h3>Implement a simple moving average (SMA) trading strategy<a class="headerlink" href="#implement-a-simple-moving-average-sma-trading-strategy" title="Permalink to this heading">#</a></h3>
<p>One goal of technical analysis is to “buy low, and sell high”.
The $n$-day SMA reduces noise in market prices, removing market fluctuations and providing estimates of “true” prices.
Market prices below their SMA might be buying opportunities, and market prices below their SMA might be selling opportunities.
Here, we will implement a long-only 20-day SMA (SMA(20)) strategy with Bitcoin:</p>
<ol class="arabic simple">
<li><p>Buy when the closing price crosses SMA(20) from below</p></li>
<li><p>Sell when the closing price crosses SMA(20) from above</p></li>
<li><p>No short-selling</p></li>
</ol>
<p>Because we will not sell short, we can simplify this strategy to “long if above SMA(20), otherwise neutral”.
First, we will need Bitcoin returns data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BTC-USD&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">btc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2014-09-17</th>
      <td>465.8640</td>
      <td>468.1740</td>
      <td>452.4220</td>
      <td>457.3340</td>
      <td>457.3340</td>
      <td>21056800</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2014-09-18</th>
      <td>456.8600</td>
      <td>456.8600</td>
      <td>413.1040</td>
      <td>424.4400</td>
      <td>424.4400</td>
      <td>34483200</td>
      <td>-0.0719</td>
    </tr>
    <tr>
      <th>2014-09-19</th>
      <td>424.1030</td>
      <td>427.8350</td>
      <td>384.5320</td>
      <td>394.7960</td>
      <td>394.7960</td>
      <td>37919700</td>
      <td>-0.0698</td>
    </tr>
    <tr>
      <th>2014-09-20</th>
      <td>394.6730</td>
      <td>423.2960</td>
      <td>389.8830</td>
      <td>408.9040</td>
      <td>408.9040</td>
      <td>36863600</td>
      <td>0.0357</td>
    </tr>
    <tr>
      <th>2014-09-21</th>
      <td>408.0850</td>
      <td>412.4260</td>
      <td>393.1810</td>
      <td>398.8210</td>
      <td>398.8210</td>
      <td>26580100</td>
      <td>-0.0247</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Next we:</p>
<ol class="arabic simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">.rolling(20).mean()</span></code> to add a <code class="docutils literal notranslate"><span class="pre">SMA20</span></code> column containing SMA(20) to our <code class="docutils literal notranslate"><span class="pre">btc</span></code> data frame</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">np.select()</span></code> to add a <code class="docutils literal notranslate"><span class="pre">Position</span></code> column containing:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">1</span></code> (long) when the adjusted close is greater than SMA(20)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code> (neutral) when the adjusted close is less than (or equal to) SMA(20)</p></li>
<li><p>We could use <code class="docutils literal notranslate"><span class="pre">np.where()</span></code> instead of <code class="docutils literal notranslate"><span class="pre">np.select()</span></code>, but using <code class="docutils literal notranslate"><span class="pre">np.select()</span></code> provides a more flexible framework for more complex examples</p></li>
<li><p><strong>We use <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> to compare yesterday’s closing prices, avoiding a look-ahead bias</strong></p></li>
</ol>
</li>
<li><p>Add a <code class="docutils literal notranslate"><span class="pre">Strategy</span></code> column containing:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Return</span></code> if <code class="docutils literal notranslate"><span class="pre">Position</span> <span class="pre">==</span> <span class="pre">1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code> if <code class="docutils literal notranslate"><span class="pre">Position</span> <span class="pre">==</span> <span class="pre">0</span></code></p></li>
<li><p>We could earn the risk-free rate instead of 0 percent, but earning 0 percent simplifies this example</p></li>
</ol>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">btc</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">SMA20</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(),</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">btc</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
      <th>SMA20</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-09</th>
      <td>21720.0801</td>
      <td>21802.7168</td>
      <td>20210.3066</td>
      <td>20363.0215</td>
      <td>20363.0215</td>
      <td>30364664171</td>
      <td>-0.0624</td>
      <td>23198.9943</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2023-03-10</th>
      <td>20367.0020</td>
      <td>20370.5957</td>
      <td>19628.2539</td>
      <td>20187.2441</td>
      <td>20187.2441</td>
      <td>39578257695</td>
      <td>-0.0086</td>
      <td>22976.2927</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>0.0221</td>
      <td>22791.5311</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>0.0742</td>
      <td>22658.2711</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22178.5801</td>
      <td>24427.3906</td>
      <td>21918.1992</td>
      <td>24229.8164</td>
      <td>24229.8164</td>
      <td>54919491584</td>
      <td>0.0932</td>
      <td>22647.9442</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>I find it helpful to plot <code class="docutils literal notranslate"><span class="pre">Adj</span> <span class="pre">Close</span></code>, <code class="docutils literal notranslate"><span class="pre">SMA20</span></code>, and <code class="docutils literal notranslate"><span class="pre">Position</span></code> for a sort window with one or more crossings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">btc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2023-02&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:]</span>
<span class="n">_</span><span class="p">[[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">,</span> <span class="s1">&#39;SMA20&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;BTC-USD ($)&#39;</span><span class="p">)</span>
<span class="n">_</span><span class="p">[[</span><span class="s1">&#39;Position&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Bitcoin SMA(20) Strategy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b1c6220705b1230b69ccf69d0f0ef53cc41b2587a3049a7a2219d61dcf4d0adc.png" src="_images/b1c6220705b1230b69ccf69d0f0ef53cc41b2587a3049a7a2219d61dcf4d0adc.png" />
</div>
</div>
<p>We can compare the long-run performance of buy-and-hold and SMA(20).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0cad2f7d1526ceebabe827f97c13ba848fbb804f644aca517c641836eded983d.png" src="_images/0cad2f7d1526ceebabe827f97c13ba848fbb804f644aca517c641836eded983d.png" />
</div>
</div>
<p>What about the rolling and full-sample Sharpe Ratios of these two strategies?
For simplicity, we will assume $R_F = 0$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc</span>
    <span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratios for 252 Trading Day Rolling Windows&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/80eda870eabd782d081806c4e7e4861495b9e691a8beac56ad81eec443090200.png" src="_images/80eda870eabd782d081806c4e7e4861495b9e691a8beac56ad81eec443090200.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc</span>
    <span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sharpe Ratio
Buy-And-Hold   0.8868
SMA(20)        1.1869
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>In the practice notebook, we will dig deeper on this strategy and others.</p>
</section>
<div class="toctree-wrapper compound">
<span id="document-herron_02_practice"></span><section id="herron-topic-2-practice-blank">
<h3>Herron Topic 2 - Practice (Blank)<a class="headerlink" href="#herron-topic-2-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="implement-the-sma-20-strategy-with-bitcoin-from-the-lecture-notebook">
<h5>Implement the SMA(20) strategy with Bitcoin from the lecture notebook<a class="headerlink" href="#implement-the-sma-20-strategy-with-bitcoin-from-the-lecture-notebook" title="Permalink to this heading">#</a></h5>
<p>Try to create the <code class="docutils literal notranslate"><span class="pre">btc</span></code> data frame in one code cell with one assignment (i.e., one <code class="docutils literal notranslate"><span class="pre">=</span></code>).</p>
</section>
<section id="how-does-sma-20-outperform-buy-and-hold-with-this-sample">
<h5>How does SMA(20) outperform buy-and-hold with this sample?<a class="headerlink" href="#how-does-sma-20-outperform-buy-and-hold-with-this-sample" title="Permalink to this heading">#</a></h5>
<p>Consider the following:</p>
<ol class="arabic simple">
<li><p>Does SMA(20) avoid the worst performing days? How many of the worst 20 days does SMA(20) avoid? Try the <code class="docutils literal notranslate"><span class="pre">.sort_values()</span></code> or <code class="docutils literal notranslate"><span class="pre">.nlargest()</span></code> method.</p></li>
<li><p>Does SMA(20) preferentially avoid low-return days? Try to combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method and <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> function.</p></li>
<li><p>Does SMA(20) preferentially avoid high-volatility days? Try to combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method and <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> function.</p></li>
</ol>
</section>
<section id="implement-the-sma-20-strategy-with-the-market-factor-from-french">
<h5>Implement the SMA(20) strategy with the market factor from French<a class="headerlink" href="#implement-the-sma-20-strategy-with-the-market-factor-from-french" title="Permalink to this heading">#</a></h5>
<p>We need to impute a market price before we calculate SMA(20).</p>
</section>
<section id="how-often-does-sma-20-outperform-buy-and-hold-with-10-year-rolling-windows">
<h5>How often does SMA(20) outperform buy-and-hold with 10-year rolling windows?<a class="headerlink" href="#how-often-does-sma-20-outperform-buy-and-hold-with-10-year-rolling-windows" title="Permalink to this heading">#</a></h5>
</section>
<section id="implement-a-long-only-bb-20-2-strategy-with-bitcoin">
<h5>Implement a long-only BB(20, 2) strategy with Bitcoin<a class="headerlink" href="#implement-a-long-only-bb-20-2-strategy-with-bitcoin" title="Permalink to this heading">#</a></h5>
<p>More on Bollinger Bands <a class="reference external" href="https://www.bollingerbands.com/bollinger-bands">here</a> and <a class="reference external" href="https://www.bollingerbands.com/bollinger-band-rules">here</a>.
In short, Bollinger Bands are bands around a trend, typically defined in terms of simple moving averages and volatilities.
Here, long-only BB(20, 2) implies we have upper and lower bands at 2 standard deviations above and below SMA(20):</p>
<ol class="arabic simple">
<li><p>Buy when the closing price crosses LB(20) from below, where LB(20) is SMA(20) minus 2 sigma</p></li>
<li><p>Sell when the closing price crosses UB(20) from above, where UB(20) is SMA(20) plus 2 sigma</p></li>
<li><p>No short-selling</p></li>
</ol>
<p>The long-only BB(20, 2) is more difficult to implement than the long-only SMA(20) because we need to track buys and sells.
For example, if the closing price is between LB(20) and BB(20), we need to know if our last trade was a buy or a sell.
Further, if the closing price is below LB(20), we can still be long because we sell when the closing price crosses UB(20) from above.</p>
</section>
<section id="implement-a-long-short-rsi-14-strategy-with-bitcoin">
<h5>Implement a long-short RSI(14) strategy with Bitcoin<a class="headerlink" href="#implement-a-long-short-rsi-14-strategy-with-bitcoin" title="Permalink to this heading">#</a></h5>
<p>From <a class="reference external" href="https://www.fidelity.com/learning-center/trading-investing/technical-analysis/technical-indicator-guide/rsi">Fidelity</a>:</p>
<blockquote>
<div><p>The Relative Strength Index (RSI), developed by J. Welles Wilder, is a momentum oscillator that measures the speed and change of price movements. The RSI oscillates between zero and 100. Traditionally the RSI is considered overbought when above 70 and oversold when below 30. Signals can be generated by looking for divergences and failure swings. RSI can also be used to identify the general trend.</p>
</div></blockquote>
<p>Here is the RSI formula: $RSI(n) = 100 - \frac{100}{1 + RS(n)}$, where $RS(n) = \frac{SMA(U, n)}{SMA(D, n)}$.
For “up days”, $U = \Delta Adj\ Close$ and $D = 0$, and, for “down days”, $U = 0$ and $D = - \Delta Adj\ Close$.
Therefore, $U$ and $D$ are always non-negative.
We can learn more about RSI <a class="reference external" href="https://en.wikipedia.org/wiki/Relative_strength_index">here</a>.</p>
<p>We will implement a long-short RSI(14) as follows:</p>
<ol class="arabic simple">
<li><p>Enter a long position when  the RSI crosses 30 from below, and exit the position when the RSI crosses 50 from below</p></li>
<li><p>Enter a short position when the RSI crosses 70 from above, and exit the position when the RSI crosses 50 from above</p></li>
</ol>
</section>
</section>
</section>
<span id="document-herron_02_practice_03"></span><section id="herron-topic-2-practice-monday-2-45-pm-section-3">
<h3>Herron Topic 2 - Practice (Monday 2:45 PM, Section 3)<a class="headerlink" href="#herron-topic-2-practice-monday-2-45-pm-section-3" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>I will finish grading projects this week/weekend</p></li>
<li><p>Quiz 5 due Friday at 11:59 PM</p>
<ul>
<li><p>A handful of students have submitted identical quizzes</p></li>
<li><p>Quizzes are individual efforts</p></li>
<li><p>Do not assume it is hard to for me to compare quiz and project submissions</p></li>
</ul>
</li>
<li><p>DataCamp 20,000 XP due <em>next</em> Friday at 11:59 PM</p></li>
<li><p>Attendance and participation account for 5% of your grade</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="implement-the-sma-20-strategy-with-bitcoin-from-the-lecture-notebook">
<h5>Implement the SMA(20) strategy with Bitcoin from the lecture notebook<a class="headerlink" href="#implement-the-sma-20-strategy-with-bitcoin-from-the-lecture-notebook" title="Permalink to this heading">#</a></h5>
<p>Try to create the <code class="docutils literal notranslate"><span class="pre">btc</span></code> data frame in one code cell with one assignment (i.e., one <code class="docutils literal notranslate"><span class="pre">=</span></code>).</p>
<p><em><strong>After class, I wrapped this chained operation into a function named <code class="docutils literal notranslate"><span class="pre">sma()</span></code>.</strong></em>
This will make it easier to try different windows and separate the trading strategies in this notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BTC-USD&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">btc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2014-09-17</th>
      <td>465.8640</td>
      <td>468.1740</td>
      <td>452.4220</td>
      <td>457.3340</td>
      <td>457.3340</td>
      <td>21056800</td>
    </tr>
    <tr>
      <th>2014-09-18</th>
      <td>456.8600</td>
      <td>456.8600</td>
      <td>413.1040</td>
      <td>424.4400</td>
      <td>424.4400</td>
      <td>34483200</td>
    </tr>
    <tr>
      <th>2014-09-19</th>
      <td>424.1030</td>
      <td>427.8350</td>
      <td>384.5320</td>
      <td>394.7960</td>
      <td>394.7960</td>
      <td>37919700</td>
    </tr>
    <tr>
      <th>2014-09-20</th>
      <td>394.6730</td>
      <td>423.2960</td>
      <td>389.8830</td>
      <td>408.9040</td>
      <td>408.9040</td>
      <td>36863600</td>
    </tr>
    <tr>
      <th>2014-09-21</th>
      <td>408.0850</td>
      <td>412.4260</td>
      <td>393.1810</td>
      <td>398.8210</td>
      <td>398.8210</td>
      <td>26580100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
            <span class="n">SMA20</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">condlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(),</span> 
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
                <span class="p">],</span>
                <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span>
                    <span class="mi">1</span><span class="p">,</span> 
                    <span class="mi">0</span>
                <span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">),</span>
            <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span> <span class="o">=</span> <span class="n">btc</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sma</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">btc_sma</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
      <th>SMA20</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>0.0221</td>
      <td>22791.5311</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>0.0742</td>
      <td>22658.2711</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22156.4062</td>
      <td>24550.8379</td>
      <td>21918.1992</td>
      <td>24197.5332</td>
      <td>24197.5332</td>
      <td>49466362688</td>
      <td>0.0918</td>
      <td>22646.3301</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>24201.7656</td>
      <td>26514.7168</td>
      <td>24081.1836</td>
      <td>24746.0742</td>
      <td>24746.0742</td>
      <td>54622230164</td>
      <td>0.0227</td>
      <td>22674.1916</td>
      <td>1.0000</td>
      <td>0.0227</td>
    </tr>
    <tr>
      <th>2023-03-15</th>
      <td>24734.6523</td>
      <td>25169.7305</td>
      <td>24048.3516</td>
      <td>24617.3047</td>
      <td>24617.3047</td>
      <td>44081737728</td>
      <td>-0.0052</td>
      <td>22707.6822</td>
      <td>1.0000</td>
      <td>-0.0052</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc_sma</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0465375d524760e8f7e6f5cf74e7afd4fb8b2e32201f977ff1caf134a14848b0.png" src="_images/0465375d524760e8f7e6f5cf74e7afd4fb8b2e32201f977ff1caf134a14848b0.png" />
</div>
</div>
</section>
<section id="how-does-sma-20-outperform-buy-and-hold-with-this-sample">
<h5>How does SMA(20) outperform buy-and-hold with this sample?<a class="headerlink" href="#how-does-sma-20-outperform-buy-and-hold-with-this-sample" title="Permalink to this heading">#</a></h5>
<p>Consider the following:</p>
<ol class="arabic simple">
<li><p>Does SMA(20) avoid the worst performing days? How many of the worst 20 days does SMA(20) avoid? Try the <code class="docutils literal notranslate"><span class="pre">.sort_values()</span></code> or <code class="docutils literal notranslate"><span class="pre">.nlargest()</span></code> method.</p></li>
<li><p>Does SMA(20) preferentially avoid low-return days? Try to combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method and <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> function.</p></li>
<li><p>Does SMA(20) preferentially avoid high-volatility days? Try to combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method and <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> function.</p></li>
</ol>
<p>By chance, the SMA(20) strategy avoids all but three of the worst days.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Position
0.0000      17
1.0000       3
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>However, SMA(20) does not avoid the best days, again by chance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Position
0.0000      10
1.0000      10
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>The SMA(20) strategy has a slight edge in picking high-return days, again by chance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc_sma</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">q5_return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;q5_return&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Return Bin (1 is Lowest, 5 is Highest)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Days Strategy is Long Bitcoin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Position by Return Bin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/77fcce6036e279a25a7c191e860fc4caa4bd9ab43c234b7935bfcdb356dabc6a.png" src="_images/77fcce6036e279a25a7c191e860fc4caa4bd9ab43c234b7935bfcdb356dabc6a.png" />
</div>
</div>
<p>However, the SMA(20) <em>does</em> avoid the high volatility days that create <a class="reference external" href="https://www.kitces.com/blog/volatility-drag-variance-drain-mean-arithmetic-vs-geometric-average-investment-returns/">volatility drag</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc_sma</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Volatility</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
        <span class="n">q5_volatility</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Volatility&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;q5_volatility&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;63-Day Rolling Volatility Bin (1 is Lowest, 5 is Highest)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Days Strategy is Long Bitcoin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Position by 63-Day Rolling Volatility Bin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/63059ddf0e219dc18f519507934fef116e57ea00861bca604dcdc2281f99d135.png" src="_images/63059ddf0e219dc18f519507934fef116e57ea00861bca604dcdc2281f99d135.png" />
</div>
</div>
<p>Recall that $Arith\ Mean \approx Geom\ Mean + \frac{\sigma^2}{2}$, so avoiding high volatility (high variance) days, reduced the drag on the  cumulative returns that intermediate-term and long-term investors care about!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc_sma</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="s1">&#39;Volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="s1">&#39;Arith Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;lambda_0&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;Geom Mean&#39;</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Volatility</th>
      <th>Arith Mean</th>
      <th>Geom Mean</th>
    </tr>
    <tr>
      <th>Position</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0000</th>
      <td>4.1518</td>
      <td>0.0433</td>
      <td>-0.0452</td>
    </tr>
    <tr>
      <th>1.0000</th>
      <td>3.4901</td>
      <td>0.3553</td>
      <td>0.2952</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="implement-the-sma-20-strategy-with-the-market-factor-from-french">
<h5>Implement the SMA(20) strategy with the market factor from French<a class="headerlink" href="#implement-the-sma-20-strategy-with-the-market-factor-from-french" title="Permalink to this heading">#</a></h5>
<p>We need to impute a market price before we calculate SMA(20).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Mkt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span>
        <span class="n">Price</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_sma</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ff</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Price&#39;</span><span class="p">:</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sma</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ff_sma</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
      <th>Mkt</th>
      <th>Adj Close</th>
      <th>Return</th>
      <th>SMA20</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-12-23</th>
      <td>0.0051</td>
      <td>-0.0060</td>
      <td>0.0115</td>
      <td>0.0002</td>
      <td>0.0053</td>
      <td>9266.3996</td>
      <td>0.0053</td>
      <td>9515.5406</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>-0.0051</td>
      <td>-0.0073</td>
      <td>0.0142</td>
      <td>0.0002</td>
      <td>-0.0049</td>
      <td>9220.6236</td>
      <td>-0.0049</td>
      <td>9497.8127</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>-0.0123</td>
      <td>-0.0025</td>
      <td>-0.0029</td>
      <td>0.0002</td>
      <td>-0.0121</td>
      <td>9108.6852</td>
      <td>-0.0121</td>
      <td>9475.2827</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>0.0187</td>
      <td>0.0127</td>
      <td>-0.0107</td>
      <td>0.0002</td>
      <td>0.0189</td>
      <td>9280.4750</td>
      <td>0.0189</td>
      <td>9446.3627</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>-0.0022</td>
      <td>0.0011</td>
      <td>-0.0003</td>
      <td>0.0002</td>
      <td>-0.0020</td>
      <td>9261.5429</td>
      <td>-0.0020</td>
      <td>9416.5159</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ff_sma</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested in Market at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/131e3565948329ffbfb65b3360199ffe069c47f7c99b79b2edd04f4debb4d99e.png" src="_images/131e3565948329ffbfb65b3360199ffe069c47f7c99b79b2edd04f4debb4d99e.png" />
</div>
</div>
</section>
<section id="how-often-does-sma-20-outperform-buy-and-hold-with-10-year-rolling-windows">
<h5>How often does SMA(20) outperform buy-and-hold with 10-year rolling windows?<a class="headerlink" href="#how-often-does-sma-20-outperform-buy-and-hold-with-10-year-rolling-windows" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_sma</span>
    <span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Investments for Rolling 10-Year Holding Periods &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9f8dc1a1b39e0f46b1d4fda08ef1b2a8f7ae3e2ae45f32a52dcfe96994401f08.png" src="_images/9f8dc1a1b39e0f46b1d4fda08ef1b2a8f7ae3e2ae45f32a52dcfe96994401f08.png" />
</div>
</div>
<p>In the previous example, SMA(20) looks amazing!
But over many shorter holding periods, we see the two are comparable.
This is largely because the SMA(20) strategy <em>by pure chance</em> avoids big market draw downs!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Position</th>
      <th>Return</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1987-10-19</th>
      <td>0.0000</td>
      <td>-0.1741</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2020-03-16</th>
      <td>0.0000</td>
      <td>-0.1199</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1929-10-29</th>
      <td>0.0000</td>
      <td>-0.1199</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1929-10-28</th>
      <td>0.0000</td>
      <td>-0.1127</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1929-11-06</th>
      <td>0.0000</td>
      <td>-0.0973</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2020-03-12</th>
      <td>0.0000</td>
      <td>-0.0962</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1933-07-21</th>
      <td>0.0000</td>
      <td>-0.0921</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2008-12-01</th>
      <td>1.0000</td>
      <td>-0.0895</td>
      <td>-0.0895</td>
    </tr>
    <tr>
      <th>2008-10-15</th>
      <td>0.0000</td>
      <td>-0.0878</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1933-07-20</th>
      <td>1.0000</td>
      <td>-0.0849</td>
      <td>-0.0849</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>SMA(20) also avoids the up days.
However, for this sample, missing the extreme down days helps more than missing the extreme updays hurts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Position</th>
      <th>Return</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1933-03-15</th>
      <td>0.0000</td>
      <td>0.1576</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1929-10-30</th>
      <td>0.0000</td>
      <td>0.1218</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2008-10-13</th>
      <td>0.0000</td>
      <td>0.1135</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1931-10-06</th>
      <td>0.0000</td>
      <td>0.1116</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1932-09-21</th>
      <td>0.0000</td>
      <td>0.1096</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2008-10-28</th>
      <td>0.0000</td>
      <td>0.0977</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2020-03-24</th>
      <td>0.0000</td>
      <td>0.0935</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2020-03-13</th>
      <td>0.0000</td>
      <td>0.0897</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1939-09-05</th>
      <td>1.0000</td>
      <td>0.0879</td>
      <td>0.0879</td>
    </tr>
    <tr>
      <th>1937-10-20</th>
      <td>0.0000</td>
      <td>0.0867</td>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can also think about this problem by decade.
If we want to get proper calendar decades (instead of 10-year periods that start in 1926), we combine <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> with an anonymous function that converts the date-time index to a proper calendar decade.
Again, we see that SMA(20) and buy-and-hold trade wins, but SMA(20) wins bigs in the 1930s!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_sma</span>
    <span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">year</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Decade&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Investments Add End of 10-Year Holding Periods &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/262e708684b1109abef3e7de77a33f6ae09019d5b276baf05ba5dcbda2c924e9.png" src="_images/262e708684b1109abef3e7de77a33f6ae09019d5b276baf05ba5dcbda2c924e9.png" />
</div>
</div>
<p>In fact, buy-and-hold outperforms SMA(20) is we start in 1950.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ff_sma</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;1950&#39;</span><span class="p">:,</span> <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested in Market at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/de32325d6c5dda85fff71b12216bc00bdfbe78f65cb56ebc4cf40d6abd840d13.png" src="_images/de32325d6c5dda85fff71b12216bc00bdfbe78f65cb56ebc4cf40d6abd840d13.png" />
</div>
</div>
</section>
<section id="implement-a-long-only-bb-20-2-strategy-with-bitcoin">
<h5>Implement a long-only BB(20, 2) strategy with Bitcoin<a class="headerlink" href="#implement-a-long-only-bb-20-2-strategy-with-bitcoin" title="Permalink to this heading">#</a></h5>
<p>More on Bollinger Bands <a class="reference external" href="https://www.bollingerbands.com/bollinger-bands">here</a> and <a class="reference external" href="https://www.bollingerbands.com/bollinger-band-rules">here</a>.
In short, Bollinger Bands are bands around a trend, typically defined in terms of simple moving averages and volatilities.
Here, long-only BB(20, 2) implies we have upper and lower bands at 2 standard deviations above and below SMA(20):</p>
<ol class="arabic simple">
<li><p>Buy when the closing price crosses LB(20) from below, where LB(20) is SMA(20) minus 2 sigma</p></li>
<li><p>Sell when the closing price crosses UB(20) from above, where UB(20) is SMA(20) plus 2 sigma</p></li>
<li><p>No short-selling</p></li>
</ol>
<p>The long-only BB(20, 2) is more difficult to implement than the long-only SMA(20) because we need to track buys and sells.
For example, if the closing price is between LB(20) and BB(20), we need to know if our last trade was a buy or a sell.
Further, if the closing price is below LB(20), we can still be long because we sell when the closing price crosses UB(20) from above.</p>
<p><em><strong>After class, I wrapped this chained operation into a function named <code class="docutils literal notranslate"><span class="pre">bb()</span></code>.</strong></em>
This will make it easier to try different windows and separate the trading strategies in this notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bb</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
            <span class="n">SMA</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">SMV</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="n">LB</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMV&#39;</span><span class="p">],</span>
            <span class="n">UB</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMV&#39;</span><span class="p">],</span>
            <span class="n">Position_with_nan</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">condlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;LB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;LB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> 
                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;UB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;UB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
                <span class="p">],</span>
                <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span>
                    <span class="mi">1</span><span class="p">,</span> 
                    <span class="mi">0</span>
                <span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">),</span>
            <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position_with_nan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">),</span>
            <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_bb</span> <span class="o">=</span> <span class="n">btc</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>

<span class="n">btc_bb</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Date</th>
      <th>Return</th>
      <th>SMA</th>
      <th>SMV</th>
      <th>LB</th>
      <th>UB</th>
      <th>Position_with_nan</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>2023-03-11</td>
      <td>0.0221</td>
      <td>22791.5311</td>
      <td>1305.1707</td>
      <td>20181.1896</td>
      <td>25401.8725</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0221</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>2023-03-12</td>
      <td>0.0742</td>
      <td>22658.2711</td>
      <td>1219.4207</td>
      <td>20219.4297</td>
      <td>25097.1125</td>
      <td>1.0000</td>
      <td>1.0000</td>
      <td>0.0742</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22156.4062</td>
      <td>24550.8379</td>
      <td>21918.1992</td>
      <td>24197.5332</td>
      <td>24197.5332</td>
      <td>49466362688</td>
      <td>2023-03-13</td>
      <td>0.0918</td>
      <td>22646.3301</td>
      <td>1202.1395</td>
      <td>20242.0510</td>
      <td>25050.6091</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0918</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>24201.7656</td>
      <td>26514.7168</td>
      <td>24081.1836</td>
      <td>24746.0742</td>
      <td>24746.0742</td>
      <td>54622230164</td>
      <td>2023-03-14</td>
      <td>0.0227</td>
      <td>22674.1916</td>
      <td>1245.4486</td>
      <td>20183.2944</td>
      <td>25165.0888</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0227</td>
    </tr>
    <tr>
      <th>2023-03-15</th>
      <td>24734.6523</td>
      <td>25169.7305</td>
      <td>24048.3516</td>
      <td>24617.3047</td>
      <td>24617.3047</td>
      <td>44081737728</td>
      <td>2023-03-15</td>
      <td>-0.0052</td>
      <td>22707.6822</td>
      <td>1289.7095</td>
      <td>20128.2632</td>
      <td>25287.1013</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>-0.0052</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc_bb</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;BB(20, 2)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1712840168ce637c11b63aaf384533ed9deb985f91ac37aa6e4cf240669a1e8e.png" src="_images/1712840168ce637c11b63aaf384533ed9deb985f91ac37aa6e4cf240669a1e8e.png" />
</div>
</div>
<p>For an asset that we know has large positive returns over the sample, “time in the market” beats “timing the market”.</p>
</section>
<section id="implement-a-long-short-rsi-14-strategy-with-bitcoin">
<h5>Implement a long-short RSI(14) strategy with Bitcoin<a class="headerlink" href="#implement-a-long-short-rsi-14-strategy-with-bitcoin" title="Permalink to this heading">#</a></h5>
<p>From <a class="reference external" href="https://www.fidelity.com/learning-center/trading-investing/technical-analysis/technical-indicator-guide/rsi">Fidelity</a>:</p>
<blockquote>
<div><p>The Relative Strength Index (RSI), developed by J. Welles Wilder, is a momentum oscillator that measures the speed and change of price movements. The RSI oscillates between zero and 100. Traditionally the RSI is considered overbought when above 70 and oversold when below 30. Signals can be generated by looking for divergences and failure swings. RSI can also be used to identify the general trend.</p>
</div></blockquote>
<p>Here is the RSI formula: $RSI(n) = 100 - \frac{100}{1 + RS(n)}$, where $RS(n) = \frac{SMA(U, n)}{SMA(D, n)}$.
For “up days”, $U = \Delta Adj\ Close$ and $D = 0$, and, for “down days”, $U = 0$ and $D = - \Delta Adj\ Close$.
Therefore, $U$ and $D$ are always non-negative.
We can learn more about RSI <a class="reference external" href="https://en.wikipedia.org/wiki/Relative_strength_index">here</a>.</p>
<p>We will implement a long-short RSI(14) as follows:</p>
<ol class="arabic simple">
<li><p>Enter a long position when  the RSI crosses 30 from below, and exit the position when the RSI crosses 50 from below</p></li>
<li><p>Enter a short position when the RSI crosses 70 from above, and exit the position when the RSI crosses 50 from above</p></li>
</ol>
<p><em><strong>After class, I replace the <code class="docutils literal notranslate"><span class="pre">np.where()</span></code> for <code class="docutils literal notranslate"><span class="pre">U</span></code> and <code class="docutils literal notranslate"><span class="pre">D</span></code> with <code class="docutils literal notranslate"><span class="pre">np.select()</span></code> for (1) consistency and (2) to better handle missing observations.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">mb</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="mi">70</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
        <span class="n">Diff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(),</span>
        <span class="n">U</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">D</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">SMAU</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">SMAD</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMAU&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMAD&#39;</span><span class="p">],</span>
        <span class="n">RSI</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RS&#39;</span><span class="p">]),</span>
        <span class="n">Position_with_nan</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lb</span><span class="p">),</span> 
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">mb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="p">),</span>
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ub</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ub</span><span class="p">),</span> 
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">mb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mb</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span>
                <span class="mi">1</span><span class="p">,</span> 
                <span class="mi">0</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="mi">0</span>
            <span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position_with_nan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">),</span>
        <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_rsi</span> <span class="o">=</span> <span class="n">rsi</span><span class="p">(</span><span class="n">btc</span><span class="p">)</span>

<span class="n">btc_rsi</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
      <th>Diff</th>
      <th>U</th>
      <th>D</th>
      <th>SMAU</th>
      <th>SMAD</th>
      <th>RS</th>
      <th>RSI</th>
      <th>Position_with_nan</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>0.0221</td>
      <td>445.1660</td>
      <td>445.1660</td>
      <td>0.0000</td>
      <td>100.8832</td>
      <td>282.5236</td>
      <td>0.3571</td>
      <td>26.3123</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0221</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>0.0742</td>
      <td>1531.5391</td>
      <td>1531.5391</td>
      <td>0.0000</td>
      <td>182.7190</td>
      <td>282.5236</td>
      <td>0.6467</td>
      <td>39.2739</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0742</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22156.4062</td>
      <td>24550.8379</td>
      <td>21918.1992</td>
      <td>24197.5332</td>
      <td>24197.5332</td>
      <td>49466362688</td>
      <td>0.0918</td>
      <td>2033.5840</td>
      <td>2033.5840</td>
      <td>0.0000</td>
      <td>327.9750</td>
      <td>279.7849</td>
      <td>1.1722</td>
      <td>53.9646</td>
      <td>1.0000</td>
      <td>1.0000</td>
      <td>0.0918</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>24201.7656</td>
      <td>26514.7168</td>
      <td>24081.1836</td>
      <td>24746.0742</td>
      <td>24746.0742</td>
      <td>54622230164</td>
      <td>0.0227</td>
      <td>548.5410</td>
      <td>548.5410</td>
      <td>0.0000</td>
      <td>367.1565</td>
      <td>252.9622</td>
      <td>1.4514</td>
      <td>59.2075</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-15</th>
      <td>24734.6523</td>
      <td>25169.7305</td>
      <td>24048.3516</td>
      <td>24617.3047</td>
      <td>24617.3047</td>
      <td>44081737728</td>
      <td>-0.0052</td>
      <td>-128.7695</td>
      <td>0.0000</td>
      <td>128.7695</td>
      <td>331.4996</td>
      <td>262.1600</td>
      <td>1.2645</td>
      <td>55.8400</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc_rsi</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;RSI(14)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7a408772ea36fc857aee85128d3c0797cc8766924aa0789e89e26ae642d598d7.png" src="_images/7a408772ea36fc857aee85128d3c0797cc8766924aa0789e89e26ae642d598d7.png" />
</div>
</div>
<p>We can compare all three!
Shorting Bitcoin has been dangerous, as the poor returns on RSI(14) show!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">btc_sma</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">btc_bb</span><span class="p">[[</span><span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_BB&#39;</span><span class="p">),</span> 
    <span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">btc_rsi</span><span class="p">[[</span><span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_RSI&#39;</span><span class="p">),</span> 
    <span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>


<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>
            <span class="p">{</span>
                <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Strategy_BB&#39;</span><span class="p">:</span> <span class="s1">&#39;BB(20, 2)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Strategy_RSI&#39;</span><span class="p">:</span> <span class="s1">&#39;RSI(14)&#39;</span><span class="p">,</span>
            <span class="p">}</span>
           <span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bca6fe8a2ee1156bf6d412f316c36d0be9567385beaf9e1190a825a35bc69504.png" src="_images/bca6fe8a2ee1156bf6d412f316c36d0be9567385beaf9e1190a825a35bc69504.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-herron_02_practice_04"></span><section id="herron-topic-2-practice-monday-11-45-am-section-4">
<h3>Herron Topic 2 - Practice (Monday 11:45 AM, Section 4)<a class="headerlink" href="#herron-topic-2-practice-monday-11-45-am-section-4" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>I will finish grading projects this week/weekend</p></li>
<li><p>Quiz 5 due ~~Friday at 11:59 PM~~ Sunday at 11:59 PM</p>
<ul>
<li><p>A handful of students have submitted identical quizzes</p></li>
<li><p>Quizzes are individual efforts</p></li>
<li><p>Do not assume it is hard to for me to compare quiz and project submissions</p></li>
</ul>
</li>
<li><p>DataCamp 20,000 XP due <em>next</em> Friday at 11:59 PM</p></li>
<li><p>Attendance and participation account for 5% of your grade</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="implement-the-sma-20-strategy-with-bitcoin-from-the-lecture-notebook">
<h5>Implement the SMA(20) strategy with Bitcoin from the lecture notebook<a class="headerlink" href="#implement-the-sma-20-strategy-with-bitcoin-from-the-lecture-notebook" title="Permalink to this heading">#</a></h5>
<p>~~Try to create the <code class="docutils literal notranslate"><span class="pre">btc</span></code> data frame in one code cell with one assignment (i.e., one <code class="docutils literal notranslate"><span class="pre">=</span></code>).~~
<em><strong>Write a function <code class="docutils literal notranslate"><span class="pre">sma()</span></code> that accepts a data frame <code class="docutils literal notranslate"><span class="pre">df</span></code> and window size <code class="docutils literal notranslate"><span class="pre">n</span></code>.
Use your <code class="docutils literal notranslate"><span class="pre">sma()</span></code> function to implement the SMA(20) strategy and assign it to data frame <code class="docutils literal notranslate"><span class="pre">btc_sma</span></code>.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BTC-USD&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">btc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2014-09-17</th>
      <td>465.8640</td>
      <td>468.1740</td>
      <td>452.4220</td>
      <td>457.3340</td>
      <td>457.3340</td>
      <td>21056800</td>
    </tr>
    <tr>
      <th>2014-09-18</th>
      <td>456.8600</td>
      <td>456.8600</td>
      <td>413.1040</td>
      <td>424.4400</td>
      <td>424.4400</td>
      <td>34483200</td>
    </tr>
    <tr>
      <th>2014-09-19</th>
      <td>424.1030</td>
      <td>427.8350</td>
      <td>384.5320</td>
      <td>394.7960</td>
      <td>394.7960</td>
      <td>37919700</td>
    </tr>
    <tr>
      <th>2014-09-20</th>
      <td>394.6730</td>
      <td>423.2960</td>
      <td>389.8830</td>
      <td>408.9040</td>
      <td>408.9040</td>
      <td>36863600</td>
    </tr>
    <tr>
      <th>2014-09-21</th>
      <td>408.0850</td>
      <td>412.4260</td>
      <td>393.1810</td>
      <td>398.8210</td>
      <td>398.8210</td>
      <td>26580100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
            <span class="n">SMA</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">condlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(),</span> 
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
                <span class="p">],</span>
                <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span>
                    <span class="mi">1</span><span class="p">,</span> 
                    <span class="mi">0</span>
                <span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">),</span>
            <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span> <span class="o">=</span> <span class="n">btc</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sma</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">btc_sma</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
      <th>SMA</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>0.0221</td>
      <td>22791.5311</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>0.0742</td>
      <td>22658.2711</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22156.4062</td>
      <td>24550.8379</td>
      <td>21918.1992</td>
      <td>24197.5332</td>
      <td>24197.5332</td>
      <td>49466362688</td>
      <td>0.0918</td>
      <td>22646.3301</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>24201.7656</td>
      <td>26514.7168</td>
      <td>24081.1836</td>
      <td>24746.0742</td>
      <td>24746.0742</td>
      <td>54622230164</td>
      <td>0.0227</td>
      <td>22674.1916</td>
      <td>1.0000</td>
      <td>0.0227</td>
    </tr>
    <tr>
      <th>2023-03-15</th>
      <td>24734.6523</td>
      <td>25169.7305</td>
      <td>24048.3516</td>
      <td>24617.3047</td>
      <td>24617.3047</td>
      <td>44081737728</td>
      <td>-0.0052</td>
      <td>22707.6822</td>
      <td>1.0000</td>
      <td>-0.0052</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc_sma</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0465375d524760e8f7e6f5cf74e7afd4fb8b2e32201f977ff1caf134a14848b0.png" src="_images/0465375d524760e8f7e6f5cf74e7afd4fb8b2e32201f977ff1caf134a14848b0.png" />
</div>
</div>
</section>
<section id="how-does-sma-20-outperform-buy-and-hold-with-this-sample">
<h5>How does SMA(20) outperform buy-and-hold with this sample?<a class="headerlink" href="#how-does-sma-20-outperform-buy-and-hold-with-this-sample" title="Permalink to this heading">#</a></h5>
<p>Consider the following:</p>
<ol class="arabic simple">
<li><p>Does SMA(20) avoid the worst performing days? How many of the worst 20 days does SMA(20) avoid? Try the <code class="docutils literal notranslate"><span class="pre">.sort_values()</span></code> or <code class="docutils literal notranslate"><span class="pre">.nlargest()</span></code> method.</p></li>
<li><p>Does SMA(20) preferentially avoid low-return days? Try to combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method and <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> function.</p></li>
<li><p>Does SMA(20) preferentially avoid high-volatility days? Try to combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method and <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> function.</p></li>
</ol>
<p>By chance, the SMA(20) strategy avoids all but three of the worst days.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Position
0.0000      17
1.0000       3
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>However, SMA(20) does not avoid the best days, again by chance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Position
0.0000      10
1.0000      10
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>The SMA(20) strategy has a slight edge in picking high-return days, again by chance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc_sma</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">q5_return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;q5_return&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Return Bin (1 is Lowest, 5 is Highest)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Days Strategy is Long Bitcoin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Position by Return Bin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/77fcce6036e279a25a7c191e860fc4caa4bd9ab43c234b7935bfcdb356dabc6a.png" src="_images/77fcce6036e279a25a7c191e860fc4caa4bd9ab43c234b7935bfcdb356dabc6a.png" />
</div>
</div>
<p>However, the SMA(20) <em>does</em> avoid the high volatility days that create <a class="reference external" href="https://www.kitces.com/blog/volatility-drag-variance-drain-mean-arithmetic-vs-geometric-average-investment-returns/">volatility drag</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc_sma</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Volatility</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
        <span class="n">q5_volatility</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Volatility&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;q5_volatility&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;63-Day Rolling Volatility Bin (1 is Lowest, 5 is Highest)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Days Strategy is Long Bitcoin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Position by 63-Day Rolling Volatility Bin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/63059ddf0e219dc18f519507934fef116e57ea00861bca604dcdc2281f99d135.png" src="_images/63059ddf0e219dc18f519507934fef116e57ea00861bca604dcdc2281f99d135.png" />
</div>
</div>
<p>Recall that $Arith\ Mean \approx Geom\ Mean + \frac{\sigma^2}{2}$, so avoiding high volatility (high variance) days, reduced the drag on the  cumulative returns that intermediate-term and long-term investors care about!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc_sma</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="s1">&#39;Volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="s1">&#39;Arith Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;lambda_0&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;Geom Mean&#39;</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Volatility</th>
      <th>Arith Mean</th>
      <th>Geom Mean</th>
    </tr>
    <tr>
      <th>Position</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0000</th>
      <td>4.1518</td>
      <td>0.0433</td>
      <td>-0.0452</td>
    </tr>
    <tr>
      <th>1.0000</th>
      <td>3.4901</td>
      <td>0.3553</td>
      <td>0.2952</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="implement-the-sma-20-strategy-with-the-market-factor-from-french">
<h5>Implement the SMA(20) strategy with the market factor from French<a class="headerlink" href="#implement-the-sma-20-strategy-with-the-market-factor-from-french" title="Permalink to this heading">#</a></h5>
<p>We need to impute a market price before we calculate SMA(20).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Mkt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span>
        <span class="n">Price</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_sma</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ff</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Price&#39;</span><span class="p">:</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sma</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ff_sma</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
      <th>Mkt</th>
      <th>Adj Close</th>
      <th>Return</th>
      <th>SMA</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-12-23</th>
      <td>0.0051</td>
      <td>-0.0060</td>
      <td>0.0115</td>
      <td>0.0002</td>
      <td>0.0053</td>
      <td>9266.3996</td>
      <td>0.0053</td>
      <td>9515.5406</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>-0.0051</td>
      <td>-0.0073</td>
      <td>0.0142</td>
      <td>0.0002</td>
      <td>-0.0049</td>
      <td>9220.6236</td>
      <td>-0.0049</td>
      <td>9497.8127</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>-0.0123</td>
      <td>-0.0025</td>
      <td>-0.0029</td>
      <td>0.0002</td>
      <td>-0.0121</td>
      <td>9108.6852</td>
      <td>-0.0121</td>
      <td>9475.2827</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>0.0187</td>
      <td>0.0127</td>
      <td>-0.0107</td>
      <td>0.0002</td>
      <td>0.0189</td>
      <td>9280.4750</td>
      <td>0.0189</td>
      <td>9446.3627</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>-0.0022</td>
      <td>0.0011</td>
      <td>-0.0003</td>
      <td>0.0002</td>
      <td>-0.0020</td>
      <td>9261.5429</td>
      <td>-0.0020</td>
      <td>9416.5159</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ff_sma</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested in Market at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/131e3565948329ffbfb65b3360199ffe069c47f7c99b79b2edd04f4debb4d99e.png" src="_images/131e3565948329ffbfb65b3360199ffe069c47f7c99b79b2edd04f4debb4d99e.png" />
</div>
</div>
</section>
<section id="how-often-does-sma-20-outperform-buy-and-hold-with-10-year-rolling-windows">
<h5>How often does SMA(20) outperform buy-and-hold with 10-year rolling windows?<a class="headerlink" href="#how-often-does-sma-20-outperform-buy-and-hold-with-10-year-rolling-windows" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_sma</span>
    <span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Investments for Rolling 10-Year Holding Periods &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9f8dc1a1b39e0f46b1d4fda08ef1b2a8f7ae3e2ae45f32a52dcfe96994401f08.png" src="_images/9f8dc1a1b39e0f46b1d4fda08ef1b2a8f7ae3e2ae45f32a52dcfe96994401f08.png" />
</div>
</div>
<p>In the previous example, SMA(20) looks amazing!
But over many shorter holding periods, we see the two are comparable.
This is largely because the SMA(20) strategy <em>by pure chance</em> avoids big market draw downs!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Position</th>
      <th>Return</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1987-10-19</th>
      <td>0.0000</td>
      <td>-0.1741</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2020-03-16</th>
      <td>0.0000</td>
      <td>-0.1199</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1929-10-29</th>
      <td>0.0000</td>
      <td>-0.1199</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1929-10-28</th>
      <td>0.0000</td>
      <td>-0.1127</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1929-11-06</th>
      <td>0.0000</td>
      <td>-0.0973</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2020-03-12</th>
      <td>0.0000</td>
      <td>-0.0962</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1933-07-21</th>
      <td>0.0000</td>
      <td>-0.0921</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2008-12-01</th>
      <td>1.0000</td>
      <td>-0.0895</td>
      <td>-0.0895</td>
    </tr>
    <tr>
      <th>2008-10-15</th>
      <td>0.0000</td>
      <td>-0.0878</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1933-07-20</th>
      <td>1.0000</td>
      <td>-0.0849</td>
      <td>-0.0849</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>SMA(20) also avoids the up days.
However, for this sample, missing the extreme down days helps more than missing the extreme updays hurts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Position</th>
      <th>Return</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1933-03-15</th>
      <td>0.0000</td>
      <td>0.1576</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1929-10-30</th>
      <td>0.0000</td>
      <td>0.1218</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2008-10-13</th>
      <td>0.0000</td>
      <td>0.1135</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1931-10-06</th>
      <td>0.0000</td>
      <td>0.1116</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1932-09-21</th>
      <td>0.0000</td>
      <td>0.1096</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2008-10-28</th>
      <td>0.0000</td>
      <td>0.0977</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2020-03-24</th>
      <td>0.0000</td>
      <td>0.0935</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2020-03-13</th>
      <td>0.0000</td>
      <td>0.0897</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1939-09-05</th>
      <td>1.0000</td>
      <td>0.0879</td>
      <td>0.0879</td>
    </tr>
    <tr>
      <th>1937-10-20</th>
      <td>0.0000</td>
      <td>0.0867</td>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can also think about this problem by decade.
If we want to get proper calendar decades (instead of 10-year periods that start in 1926), we combine <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> with an anonymous function that converts the date-time index to a proper calendar decade.
Again, we see that SMA(20) and buy-and-hold trade wins, but SMA(20) wins bigs in the 1930s!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_sma</span>
    <span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">year</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Decade&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Investments Add End of 10-Year Holding Periods &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/262e708684b1109abef3e7de77a33f6ae09019d5b276baf05ba5dcbda2c924e9.png" src="_images/262e708684b1109abef3e7de77a33f6ae09019d5b276baf05ba5dcbda2c924e9.png" />
</div>
</div>
<p>In fact, buy-and-hold outperforms SMA(20) is we start in 1950.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ff_sma</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;1950&#39;</span><span class="p">:,</span> <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested in Market at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/de32325d6c5dda85fff71b12216bc00bdfbe78f65cb56ebc4cf40d6abd840d13.png" src="_images/de32325d6c5dda85fff71b12216bc00bdfbe78f65cb56ebc4cf40d6abd840d13.png" />
</div>
</div>
</section>
<section id="implement-a-long-only-bb-20-2-strategy-with-bitcoin">
<h5>Implement a long-only BB(20, 2) strategy with Bitcoin<a class="headerlink" href="#implement-a-long-only-bb-20-2-strategy-with-bitcoin" title="Permalink to this heading">#</a></h5>
<p>More on Bollinger Bands <a class="reference external" href="https://www.bollingerbands.com/bollinger-bands">here</a> and <a class="reference external" href="https://www.bollingerbands.com/bollinger-band-rules">here</a>.
In short, Bollinger Bands are bands around a trend, typically defined in terms of simple moving averages and volatilities.
Here, long-only BB(20, 2) implies we have upper and lower bands at 2 standard deviations above and below SMA(20):</p>
<ol class="arabic simple">
<li><p>Buy when the closing price crosses LB(20) from below, where LB(20) is SMA(20) minus 2 sigma</p></li>
<li><p>Sell when the closing price crosses UB(20) from above, where UB(20) is SMA(20) plus 2 sigma</p></li>
<li><p>No short-selling</p></li>
</ol>
<p>The long-only BB(20, 2) is more difficult to implement than the long-only SMA(20) because we need to track buys and sells.
For example, if the closing price is between LB(20) and BB(20), we need to know if our last trade was a buy or a sell.
Further, if the closing price is below LB(20), we can still be long because we sell when the closing price crosses UB(20) from above.</p>
<p><em><strong>Again, write a function <code class="docutils literal notranslate"><span class="pre">bb()</span></code> that accepts a data frame <code class="docutils literal notranslate"><span class="pre">df</span></code>, window size <code class="docutils literal notranslate"><span class="pre">n</span></code>, and number of standard deviations <code class="docutils literal notranslate"><span class="pre">m</span></code>.
Use your <code class="docutils literal notranslate"><span class="pre">bb()</span></code> function to implement the BB(20, 2) strategy and assign it to data frame <code class="docutils literal notranslate"><span class="pre">btc_bb</span></code>.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bb</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
            <span class="n">SMA</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">SMV</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="n">UB</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMV&#39;</span><span class="p">],</span>
            <span class="n">LB</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMV&#39;</span><span class="p">],</span>
            <span class="n">Position_with_nan</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">condlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;LB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;LB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> 
                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;UB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;UB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> 
                <span class="p">],</span>
                <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span>
                    <span class="mi">1</span><span class="p">,</span> 
                    <span class="mi">0</span>
                <span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">),</span>
            <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position_with_nan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">),</span>
            <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_bb</span> <span class="o">=</span> <span class="n">btc</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>

<span class="n">btc_bb</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
      <th>SMA</th>
      <th>SMV</th>
      <th>UB</th>
      <th>LB</th>
      <th>Position_with_nan</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>0.0221</td>
      <td>22791.5311</td>
      <td>1305.1707</td>
      <td>25401.8725</td>
      <td>20181.1896</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0221</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>0.0742</td>
      <td>22658.2711</td>
      <td>1219.4207</td>
      <td>25097.1125</td>
      <td>20219.4297</td>
      <td>1.0000</td>
      <td>1.0000</td>
      <td>0.0742</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22156.4062</td>
      <td>24550.8379</td>
      <td>21918.1992</td>
      <td>24197.5332</td>
      <td>24197.5332</td>
      <td>49466362688</td>
      <td>0.0918</td>
      <td>22646.3301</td>
      <td>1202.1395</td>
      <td>25050.6091</td>
      <td>20242.0510</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0918</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>24201.7656</td>
      <td>26514.7168</td>
      <td>24081.1836</td>
      <td>24746.0742</td>
      <td>24746.0742</td>
      <td>54622230164</td>
      <td>0.0227</td>
      <td>22674.1916</td>
      <td>1245.4486</td>
      <td>25165.0888</td>
      <td>20183.2944</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0227</td>
    </tr>
    <tr>
      <th>2023-03-15</th>
      <td>24734.6523</td>
      <td>25169.7305</td>
      <td>24048.3516</td>
      <td>24617.3047</td>
      <td>24617.3047</td>
      <td>44081737728</td>
      <td>-0.0052</td>
      <td>22707.6822</td>
      <td>1289.7095</td>
      <td>25287.1013</td>
      <td>20128.2632</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>-0.0052</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc_bb</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;BB(20, 2)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1712840168ce637c11b63aaf384533ed9deb985f91ac37aa6e4cf240669a1e8e.png" src="_images/1712840168ce637c11b63aaf384533ed9deb985f91ac37aa6e4cf240669a1e8e.png" />
</div>
</div>
<p>For an asset that we know has large positive returns over the sample, “time in the market” beats “timing the market”.</p>
</section>
<section id="implement-a-long-short-rsi-14-strategy-with-bitcoin">
<h5>Implement a long-short RSI(14) strategy with Bitcoin<a class="headerlink" href="#implement-a-long-short-rsi-14-strategy-with-bitcoin" title="Permalink to this heading">#</a></h5>
<p>From <a class="reference external" href="https://www.fidelity.com/learning-center/trading-investing/technical-analysis/technical-indicator-guide/rsi">Fidelity</a>:</p>
<blockquote>
<div><p>The Relative Strength Index (RSI), developed by J. Welles Wilder, is a momentum oscillator that measures the speed and change of price movements. The RSI oscillates between zero and 100. Traditionally the RSI is considered overbought when above 70 and oversold when below 30. Signals can be generated by looking for divergences and failure swings. RSI can also be used to identify the general trend.</p>
</div></blockquote>
<p>Here is the RSI formula: $RSI(n) = 100 - \frac{100}{1 + RS(n)}$, where $RS(n) = \frac{SMA(U, n)}{SMA(D, n)}$.
For “up days”, $U = \Delta Adj\ Close$ and $D = 0$, and, for “down days”, $U = 0$ and $D = - \Delta Adj\ Close$.
Therefore, $U$ and $D$ are always non-negative.
We can learn more about RSI <a class="reference external" href="https://en.wikipedia.org/wiki/Relative_strength_index">here</a>.</p>
<p>We will implement a long-short RSI(14) as follows:</p>
<ol class="arabic simple">
<li><p>Enter a long position when  the RSI crosses 30 from below, and exit the position when the RSI crosses 50 from below</p></li>
<li><p>Enter a short position when the RSI crosses 70 from above, and exit the position when the RSI crosses 50 from above</p></li>
</ol>
<p><em><strong>Again, write a function <code class="docutils literal notranslate"><span class="pre">rsi()</span></code> that accepts a data frame <code class="docutils literal notranslate"><span class="pre">df</span></code>, window size <code class="docutils literal notranslate"><span class="pre">n</span></code>, and boundary percentiles <code class="docutils literal notranslate"><span class="pre">lb</span></code>, <code class="docutils literal notranslate"><span class="pre">mb</span></code>, and <code class="docutils literal notranslate"><span class="pre">ub</span></code>.
Use your <code class="docutils literal notranslate"><span class="pre">rsi()</span></code> function to implement the RSI strategy and assign it to data frame <code class="docutils literal notranslate"><span class="pre">btc_rsi</span></code>.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">mb</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="mi">70</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
        <span class="n">Diff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(),</span>
        <span class="n">U</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">D</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">SMAU</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">SMAD</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMAU&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMAD&#39;</span><span class="p">],</span>
        <span class="n">RSI</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RS&#39;</span><span class="p">]),</span>
        <span class="n">Position_with_nan</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lb</span><span class="p">),</span> 
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">mb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="p">),</span>
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ub</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ub</span><span class="p">),</span> 
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">mb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mb</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span>
                <span class="mi">1</span><span class="p">,</span> 
                <span class="mi">0</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="mi">0</span>
            <span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position_with_nan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">),</span>
        <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_rsi</span> <span class="o">=</span> <span class="n">rsi</span><span class="p">(</span><span class="n">btc</span><span class="p">)</span>

<span class="n">btc_rsi</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
      <th>Diff</th>
      <th>U</th>
      <th>D</th>
      <th>SMAU</th>
      <th>SMAD</th>
      <th>RS</th>
      <th>RSI</th>
      <th>Position_with_nan</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>0.0221</td>
      <td>445.1660</td>
      <td>445.1660</td>
      <td>0.0000</td>
      <td>100.8832</td>
      <td>282.5236</td>
      <td>0.3571</td>
      <td>26.3123</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0221</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>0.0742</td>
      <td>1531.5391</td>
      <td>1531.5391</td>
      <td>0.0000</td>
      <td>182.7190</td>
      <td>282.5236</td>
      <td>0.6467</td>
      <td>39.2739</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0742</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22156.4062</td>
      <td>24550.8379</td>
      <td>21918.1992</td>
      <td>24197.5332</td>
      <td>24197.5332</td>
      <td>49466362688</td>
      <td>0.0918</td>
      <td>2033.5840</td>
      <td>2033.5840</td>
      <td>0.0000</td>
      <td>327.9750</td>
      <td>279.7849</td>
      <td>1.1722</td>
      <td>53.9646</td>
      <td>1.0000</td>
      <td>1.0000</td>
      <td>0.0918</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>24201.7656</td>
      <td>26514.7168</td>
      <td>24081.1836</td>
      <td>24746.0742</td>
      <td>24746.0742</td>
      <td>54622230164</td>
      <td>0.0227</td>
      <td>548.5410</td>
      <td>548.5410</td>
      <td>0.0000</td>
      <td>367.1565</td>
      <td>252.9622</td>
      <td>1.4514</td>
      <td>59.2075</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-15</th>
      <td>24734.6523</td>
      <td>25169.7305</td>
      <td>24048.3516</td>
      <td>24617.3047</td>
      <td>24617.3047</td>
      <td>44081737728</td>
      <td>-0.0052</td>
      <td>-128.7695</td>
      <td>0.0000</td>
      <td>128.7695</td>
      <td>331.4996</td>
      <td>262.1600</td>
      <td>1.2645</td>
      <td>55.8400</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc_rsi</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;RSI(14)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7a408772ea36fc857aee85128d3c0797cc8766924aa0789e89e26ae642d598d7.png" src="_images/7a408772ea36fc857aee85128d3c0797cc8766924aa0789e89e26ae642d598d7.png" />
</div>
</div>
<p>We can compare all three!
Shorting Bitcoin has been dangerous, as the poor returns on RSI(14) show!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">btc_sma</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">btc_bb</span><span class="p">[[</span><span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_BB&#39;</span><span class="p">),</span> 
    <span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">btc_rsi</span><span class="p">[[</span><span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_RSI&#39;</span><span class="p">),</span> 
    <span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>


<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>
            <span class="p">{</span>
                <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Strategy_BB&#39;</span><span class="p">:</span> <span class="s1">&#39;BB(20, 2)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Strategy_RSI&#39;</span><span class="p">:</span> <span class="s1">&#39;RSI(14)&#39;</span><span class="p">,</span>
            <span class="p">}</span>
           <span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bca6fe8a2ee1156bf6d412f316c36d0be9567385beaf9e1190a825a35bc69504.png" src="_images/bca6fe8a2ee1156bf6d412f316c36d0be9567385beaf9e1190a825a35bc69504.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-herron_02_practice_02"></span><section id="herron-topic-2-practice-wednesday-2-45-pm-section-2">
<h3>Herron Topic 2 - Practice (Wednesday 2:45 PM, Section 2)<a class="headerlink" href="#herron-topic-2-practice-wednesday-2-45-pm-section-2" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>I will finish grading projects this week/weekend</p></li>
<li><p>Quiz 5 due ~~Friday~~ Sunday at 11:59 PM</p>
<ul>
<li><p>A handful of students have submitted identical quizzes</p></li>
<li><p>Quizzes are individual efforts</p></li>
<li><p>Do not assume it is hard to for me to compare quiz and project submissions</p></li>
</ul>
</li>
<li><p>DataCamp 20,000 XP due <em>next</em> Friday at 11:59 PM</p></li>
<li><p>Attendance and participation account for 5% of your grade</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="implement-the-sma-20-strategy-with-bitcoin-from-the-lecture-notebook">
<h5>Implement the SMA(20) strategy with Bitcoin from the lecture notebook<a class="headerlink" href="#implement-the-sma-20-strategy-with-bitcoin-from-the-lecture-notebook" title="Permalink to this heading">#</a></h5>
<p>~~Try to create the <code class="docutils literal notranslate"><span class="pre">btc</span></code> data frame in one code cell with one assignment (i.e., one <code class="docutils literal notranslate"><span class="pre">=</span></code>).~~
<em><strong>Write a function <code class="docutils literal notranslate"><span class="pre">sma()</span></code> that accepts a data frame <code class="docutils literal notranslate"><span class="pre">df</span></code> and window size <code class="docutils literal notranslate"><span class="pre">n</span></code>.
Use your <code class="docutils literal notranslate"><span class="pre">sma()</span></code> function to implement the SMA(20) strategy and assign it to data frame <code class="docutils literal notranslate"><span class="pre">btc_sma</span></code>.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BTC-USD&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">btc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2014-09-17</th>
      <td>465.8640</td>
      <td>468.1740</td>
      <td>452.4220</td>
      <td>457.3340</td>
      <td>457.3340</td>
      <td>21056800</td>
    </tr>
    <tr>
      <th>2014-09-18</th>
      <td>456.8600</td>
      <td>456.8600</td>
      <td>413.1040</td>
      <td>424.4400</td>
      <td>424.4400</td>
      <td>34483200</td>
    </tr>
    <tr>
      <th>2014-09-19</th>
      <td>424.1030</td>
      <td>427.8350</td>
      <td>384.5320</td>
      <td>394.7960</td>
      <td>394.7960</td>
      <td>37919700</td>
    </tr>
    <tr>
      <th>2014-09-20</th>
      <td>394.6730</td>
      <td>423.2960</td>
      <td>389.8830</td>
      <td>408.9040</td>
      <td>408.9040</td>
      <td>36863600</td>
    </tr>
    <tr>
      <th>2014-09-21</th>
      <td>408.0850</td>
      <td>412.4260</td>
      <td>393.1810</td>
      <td>398.8210</td>
      <td>398.8210</td>
      <td>26580100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
            <span class="n">SMA</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">condlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(),</span> 
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
                <span class="p">],</span>
                <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span>
                    <span class="mi">1</span><span class="p">,</span> 
                    <span class="mi">0</span>
                <span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">),</span>
            <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span> <span class="o">=</span> <span class="n">btc</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sma</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">btc_sma</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
      <th>SMA</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>0.0221</td>
      <td>22791.5311</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>0.0742</td>
      <td>22658.2711</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22156.4062</td>
      <td>24550.8379</td>
      <td>21918.1992</td>
      <td>24197.5332</td>
      <td>24197.5332</td>
      <td>49466362688</td>
      <td>0.0918</td>
      <td>22646.3301</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>24201.7656</td>
      <td>26514.7168</td>
      <td>24081.1836</td>
      <td>24746.0742</td>
      <td>24746.0742</td>
      <td>54622230164</td>
      <td>0.0227</td>
      <td>22674.1916</td>
      <td>1.0000</td>
      <td>0.0227</td>
    </tr>
    <tr>
      <th>2023-03-15</th>
      <td>24734.6523</td>
      <td>25169.7305</td>
      <td>24048.3516</td>
      <td>24617.3047</td>
      <td>24617.3047</td>
      <td>44081737728</td>
      <td>-0.0052</td>
      <td>22707.6822</td>
      <td>1.0000</td>
      <td>-0.0052</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc_sma</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0465375d524760e8f7e6f5cf74e7afd4fb8b2e32201f977ff1caf134a14848b0.png" src="_images/0465375d524760e8f7e6f5cf74e7afd4fb8b2e32201f977ff1caf134a14848b0.png" />
</div>
</div>
</section>
<section id="how-does-sma-20-outperform-buy-and-hold-with-this-sample">
<h5>How does SMA(20) outperform buy-and-hold with this sample?<a class="headerlink" href="#how-does-sma-20-outperform-buy-and-hold-with-this-sample" title="Permalink to this heading">#</a></h5>
<p>Consider the following:</p>
<ol class="arabic simple">
<li><p>Does SMA(20) avoid the worst performing days? How many of the worst 20 days does SMA(20) avoid? Try the <code class="docutils literal notranslate"><span class="pre">.sort_values()</span></code> or <code class="docutils literal notranslate"><span class="pre">.nlargest()</span></code> method.</p></li>
<li><p>Does SMA(20) preferentially avoid low-return days? Try to combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method and <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> function.</p></li>
<li><p>Does SMA(20) preferentially avoid high-volatility days? Try to combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method and <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> function.</p></li>
</ol>
<p>By chance, the SMA(20) strategy avoids all but three of the worst days.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Position
0.0000      17
1.0000       3
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>However, SMA(20) does not avoid the best days, again by chance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Position
0.0000      10
1.0000      10
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_sma</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="2" halign="left">Return</th>
      <th colspan="2" halign="left">Strategy</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean</th>
      <th>std</th>
    </tr>
    <tr>
      <th>Position</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0000</th>
      <td>0.0004</td>
      <td>0.0415</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1.0000</th>
      <td>0.0036</td>
      <td>0.0349</td>
      <td>0.0036</td>
      <td>0.0349</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The SMA(20) strategy has a slight edge in picking high-return days, again by chance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc_sma</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">q5_return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;q5_return&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Return Bin (1 is Lowest, 5 is Highest)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Days Strategy is Long Bitcoin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Position by Return Bin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/77fcce6036e279a25a7c191e860fc4caa4bd9ab43c234b7935bfcdb356dabc6a.png" src="_images/77fcce6036e279a25a7c191e860fc4caa4bd9ab43c234b7935bfcdb356dabc6a.png" />
</div>
</div>
<p>However, the SMA(20) <em>does</em> avoid the high volatility days that create <a class="reference external" href="https://www.kitces.com/blog/volatility-drag-variance-drain-mean-arithmetic-vs-geometric-average-investment-returns/">volatility drag</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc_sma</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Volatility</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
        <span class="n">q5_volatility</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Volatility&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;q5_volatility&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;63-Day Rolling Volatility Bin (1 is Lowest, 5 is Highest)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Days Strategy is Long Bitcoin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Position by 63-Day Rolling Volatility Bin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/63059ddf0e219dc18f519507934fef116e57ea00861bca604dcdc2281f99d135.png" src="_images/63059ddf0e219dc18f519507934fef116e57ea00861bca604dcdc2281f99d135.png" />
</div>
</div>
<p>Recall that $Arith\ Mean \approx Geom\ Mean + \frac{\sigma^2}{2}$, so avoiding high volatility (high variance) days, reduced the drag on the  cumulative returns that intermediate-term and long-term investors care about!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">btc_sma</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="s1">&#39;Volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="s1">&#39;Arith Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;lambda_0&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;Geom Mean&#39;</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Volatility</th>
      <th>Arith Mean</th>
      <th>Geom Mean</th>
    </tr>
    <tr>
      <th>Position</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0000</th>
      <td>4.1518</td>
      <td>0.0433</td>
      <td>-0.0452</td>
    </tr>
    <tr>
      <th>1.0000</th>
      <td>3.4901</td>
      <td>0.3553</td>
      <td>0.2952</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="implement-the-sma-20-strategy-with-the-market-factor-from-french">
<h5>Implement the SMA(20) strategy with the market factor from French<a class="headerlink" href="#implement-the-sma-20-strategy-with-the-market-factor-from-french" title="Permalink to this heading">#</a></h5>
<p>We need to impute a market price before we calculate SMA(20).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Mkt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span>
        <span class="n">Price</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_sma</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ff</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Price&#39;</span><span class="p">:</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">sma</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ff_sma</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
      <th>Mkt</th>
      <th>Adj Close</th>
      <th>Return</th>
      <th>SMA</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-12-23</th>
      <td>0.0051</td>
      <td>-0.0060</td>
      <td>0.0115</td>
      <td>0.0002</td>
      <td>0.0053</td>
      <td>9266.3996</td>
      <td>0.0053</td>
      <td>9515.5406</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>-0.0051</td>
      <td>-0.0073</td>
      <td>0.0142</td>
      <td>0.0002</td>
      <td>-0.0049</td>
      <td>9220.6236</td>
      <td>-0.0049</td>
      <td>9497.8127</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>-0.0123</td>
      <td>-0.0025</td>
      <td>-0.0029</td>
      <td>0.0002</td>
      <td>-0.0121</td>
      <td>9108.6852</td>
      <td>-0.0121</td>
      <td>9475.2827</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>0.0187</td>
      <td>0.0127</td>
      <td>-0.0107</td>
      <td>0.0002</td>
      <td>0.0189</td>
      <td>9280.4750</td>
      <td>0.0189</td>
      <td>9446.3627</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>-0.0022</td>
      <td>0.0011</td>
      <td>-0.0003</td>
      <td>0.0002</td>
      <td>-0.0020</td>
      <td>9261.5429</td>
      <td>-0.0020</td>
      <td>9416.5159</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ff_sma</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested in Market at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/131e3565948329ffbfb65b3360199ffe069c47f7c99b79b2edd04f4debb4d99e.png" src="_images/131e3565948329ffbfb65b3360199ffe069c47f7c99b79b2edd04f4debb4d99e.png" />
</div>
</div>
</section>
<section id="how-often-does-sma-20-outperform-buy-and-hold-with-10-year-rolling-windows">
<h5>How often does SMA(20) outperform buy-and-hold with 10-year rolling windows?<a class="headerlink" href="#how-often-does-sma-20-outperform-buy-and-hold-with-10-year-rolling-windows" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_sma</span>
    <span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Investments for Rolling 10-Year Holding Periods &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9f8dc1a1b39e0f46b1d4fda08ef1b2a8f7ae3e2ae45f32a52dcfe96994401f08.png" src="_images/9f8dc1a1b39e0f46b1d4fda08ef1b2a8f7ae3e2ae45f32a52dcfe96994401f08.png" />
</div>
</div>
<p>In the previous example, SMA(20) looks amazing!
But over many shorter holding periods, we see the two are comparable.
This is largely because the SMA(20) strategy <em>by pure chance</em> avoids big market draw downs!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Position</th>
      <th>Return</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1987-10-19</th>
      <td>0.0000</td>
      <td>-0.1741</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2020-03-16</th>
      <td>0.0000</td>
      <td>-0.1199</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1929-10-29</th>
      <td>0.0000</td>
      <td>-0.1199</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1929-10-28</th>
      <td>0.0000</td>
      <td>-0.1127</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1929-11-06</th>
      <td>0.0000</td>
      <td>-0.0973</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2020-03-12</th>
      <td>0.0000</td>
      <td>-0.0962</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1933-07-21</th>
      <td>0.0000</td>
      <td>-0.0921</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>2008-12-01</th>
      <td>1.0000</td>
      <td>-0.0895</td>
      <td>-0.0895</td>
    </tr>
    <tr>
      <th>2008-10-15</th>
      <td>0.0000</td>
      <td>-0.0878</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>1933-07-20</th>
      <td>1.0000</td>
      <td>-0.0849</td>
      <td>-0.0849</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>SMA(20) also avoids the up days.
However, for this sample, missing the extreme down days helps more than missing the extreme updays hurts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_sma</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Position</th>
      <th>Return</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1933-03-15</th>
      <td>0.0000</td>
      <td>0.1576</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1929-10-30</th>
      <td>0.0000</td>
      <td>0.1218</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2008-10-13</th>
      <td>0.0000</td>
      <td>0.1135</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1931-10-06</th>
      <td>0.0000</td>
      <td>0.1116</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1932-09-21</th>
      <td>0.0000</td>
      <td>0.1096</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2008-10-28</th>
      <td>0.0000</td>
      <td>0.0977</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2020-03-24</th>
      <td>0.0000</td>
      <td>0.0935</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2020-03-13</th>
      <td>0.0000</td>
      <td>0.0897</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>1939-09-05</th>
      <td>1.0000</td>
      <td>0.0879</td>
      <td>0.0879</td>
    </tr>
    <tr>
      <th>1937-10-20</th>
      <td>0.0000</td>
      <td>0.0867</td>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can also think about this problem by decade.
If we want to get proper calendar decades (instead of 10-year periods that start in 1926), we combine <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> with an anonymous function that converts the date-time index to a proper calendar decade.
Again, we see that SMA(20) and buy-and-hold trade wins, but SMA(20) wins bigs in the 1930s!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_sma</span>
    <span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">year</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Decade&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Investments Add End of 10-Year Holding Periods &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/262e708684b1109abef3e7de77a33f6ae09019d5b276baf05ba5dcbda2c924e9.png" src="_images/262e708684b1109abef3e7de77a33f6ae09019d5b276baf05ba5dcbda2c924e9.png" />
</div>
</div>
<p>In fact, buy-and-hold outperforms SMA(20) is we start in 1950.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ff_sma</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;1950&#39;</span><span class="p">:,</span> <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested in Market at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/de32325d6c5dda85fff71b12216bc00bdfbe78f65cb56ebc4cf40d6abd840d13.png" src="_images/de32325d6c5dda85fff71b12216bc00bdfbe78f65cb56ebc4cf40d6abd840d13.png" />
</div>
</div>
</section>
<section id="implement-a-long-only-bb-20-2-strategy-with-bitcoin">
<h5>Implement a long-only BB(20, 2) strategy with Bitcoin<a class="headerlink" href="#implement-a-long-only-bb-20-2-strategy-with-bitcoin" title="Permalink to this heading">#</a></h5>
<p>More on Bollinger Bands <a class="reference external" href="https://www.bollingerbands.com/bollinger-bands">here</a> and <a class="reference external" href="https://www.bollingerbands.com/bollinger-band-rules">here</a>.
In short, Bollinger Bands are bands around a trend, typically defined in terms of simple moving averages and volatilities.
Here, long-only BB(20, 2) implies we have upper and lower bands at 2 standard deviations above and below SMA(20):</p>
<ol class="arabic simple">
<li><p>Buy when the closing price crosses LB(20) from below, where LB(20) is SMA(20) minus 2 sigma</p></li>
<li><p>Sell when the closing price crosses UB(20) from above, where UB(20) is SMA(20) plus 2 sigma</p></li>
<li><p>No short-selling</p></li>
</ol>
<p>The long-only BB(20, 2) is more difficult to implement than the long-only SMA(20) because we need to track buys and sells.
For example, if the closing price is between LB(20) and BB(20), we need to know if our last trade was a buy or a sell.
Further, if the closing price is below LB(20), we can still be long because we sell when the closing price crosses UB(20) from above.</p>
<p><em><strong>Again, write a function <code class="docutils literal notranslate"><span class="pre">bb()</span></code> that accepts a data frame <code class="docutils literal notranslate"><span class="pre">df</span></code>, window size <code class="docutils literal notranslate"><span class="pre">n</span></code>, and number of standard deviations <code class="docutils literal notranslate"><span class="pre">m</span></code>.
Use your <code class="docutils literal notranslate"><span class="pre">bb()</span></code> function to implement the BB(20, 2) strategy and assign it to data frame <code class="docutils literal notranslate"><span class="pre">btc_bb</span></code>.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bb</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
            <span class="n">SMA</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">SMV</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="n">UB</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMV&#39;</span><span class="p">],</span>
            <span class="n">LB</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMA&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMV&#39;</span><span class="p">],</span>
            <span class="n">Position_with_nan</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">condlist</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;LB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;LB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> 
                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;UB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;UB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="p">],</span>
                <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span>
                    <span class="mi">1</span><span class="p">,</span> 
                    <span class="mi">0</span>
                <span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">),</span>
            <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position_with_nan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">),</span>
            <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_bb</span> <span class="o">=</span> <span class="n">btc</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">btc_bb</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
      <th>SMA</th>
      <th>SMV</th>
      <th>UB</th>
      <th>LB</th>
      <th>Position_with_nan</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>0.0221</td>
      <td>22791.5311</td>
      <td>1305.1707</td>
      <td>25401.8725</td>
      <td>20181.1896</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0221</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>0.0742</td>
      <td>22658.2711</td>
      <td>1219.4207</td>
      <td>25097.1125</td>
      <td>20219.4297</td>
      <td>1.0000</td>
      <td>1.0000</td>
      <td>0.0742</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22156.4062</td>
      <td>24550.8379</td>
      <td>21918.1992</td>
      <td>24197.5332</td>
      <td>24197.5332</td>
      <td>49466362688</td>
      <td>0.0918</td>
      <td>22646.3301</td>
      <td>1202.1395</td>
      <td>25050.6091</td>
      <td>20242.0510</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0918</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>24201.7656</td>
      <td>26514.7168</td>
      <td>24081.1836</td>
      <td>24746.0742</td>
      <td>24746.0742</td>
      <td>54622230164</td>
      <td>0.0227</td>
      <td>22674.1916</td>
      <td>1245.4486</td>
      <td>25165.0888</td>
      <td>20183.2944</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0227</td>
    </tr>
    <tr>
      <th>2023-03-15</th>
      <td>24734.6523</td>
      <td>25169.7305</td>
      <td>24048.3516</td>
      <td>24617.3047</td>
      <td>24617.3047</td>
      <td>44081737728</td>
      <td>-0.0052</td>
      <td>22707.6822</td>
      <td>1289.7095</td>
      <td>25287.1013</td>
      <td>20128.2632</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>-0.0052</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc_bb</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;BB(20, 2)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1712840168ce637c11b63aaf384533ed9deb985f91ac37aa6e4cf240669a1e8e.png" src="_images/1712840168ce637c11b63aaf384533ed9deb985f91ac37aa6e4cf240669a1e8e.png" />
</div>
</div>
<p>For an asset that we know has large positive returns over the sample, “time in the market” beats “timing the market”.</p>
</section>
<section id="implement-a-long-short-rsi-14-strategy-with-bitcoin">
<h5>Implement a long-short RSI(14) strategy with Bitcoin<a class="headerlink" href="#implement-a-long-short-rsi-14-strategy-with-bitcoin" title="Permalink to this heading">#</a></h5>
<p>From <a class="reference external" href="https://www.fidelity.com/learning-center/trading-investing/technical-analysis/technical-indicator-guide/rsi">Fidelity</a>:</p>
<blockquote>
<div><p>The Relative Strength Index (RSI), developed by J. Welles Wilder, is a momentum oscillator that measures the speed and change of price movements. The RSI oscillates between zero and 100. Traditionally the RSI is considered overbought when above 70 and oversold when below 30. Signals can be generated by looking for divergences and failure swings. RSI can also be used to identify the general trend.</p>
</div></blockquote>
<p>Here is the RSI formula: $RSI(n) = 100 - \frac{100}{1 + RS(n)}$, where $RS(n) = \frac{SMA(U, n)}{SMA(D, n)}$.
For “up days”, $U = \Delta Adj\ Close$ and $D = 0$, and, for “down days”, $U = 0$ and $D = - \Delta Adj\ Close$.
Therefore, $U$ and $D$ are always non-negative.
We can learn more about RSI <a class="reference external" href="https://en.wikipedia.org/wiki/Relative_strength_index">here</a>.</p>
<p>We will implement a long-short RSI(14) as follows:</p>
<ol class="arabic simple">
<li><p>Enter a long position when  the RSI crosses 30 from below, and exit the position when the RSI crosses 50 from below</p></li>
<li><p>Enter a short position when the RSI crosses 70 from above, and exit the position when the RSI crosses 50 from above</p></li>
</ol>
<p><em><strong>Again, write a function <code class="docutils literal notranslate"><span class="pre">rsi()</span></code> that accepts a data frame <code class="docutils literal notranslate"><span class="pre">df</span></code>, window size <code class="docutils literal notranslate"><span class="pre">n</span></code>, and boundary percentiles <code class="docutils literal notranslate"><span class="pre">lb</span></code>, <code class="docutils literal notranslate"><span class="pre">mb</span></code>, and <code class="docutils literal notranslate"><span class="pre">ub</span></code>.
Use your <code class="docutils literal notranslate"><span class="pre">rsi()</span></code> function to implement the RSI strategy and assign it to data frame <code class="docutils literal notranslate"><span class="pre">btc_rsi</span></code>.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">mb</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="mi">70</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Return</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(),</span>
        <span class="n">Diff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(),</span>
        <span class="n">U</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">D</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">SMAU</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">SMAD</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMAU&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SMAD&#39;</span><span class="p">],</span>
        <span class="n">RSI</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RS&#39;</span><span class="p">]),</span>
        <span class="n">Position_with_nan</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">condlist</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lb</span><span class="p">),</span> 
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">mb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="p">),</span>
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ub</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ub</span><span class="p">),</span> 
                <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">mb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mb</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">choicelist</span><span class="o">=</span><span class="p">[</span>
                <span class="mi">1</span><span class="p">,</span> 
                <span class="mi">0</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="mi">0</span>
            <span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position_with_nan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">),</span>
        <span class="n">Strategy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">btc_rsi</span> <span class="o">=</span> <span class="n">rsi</span><span class="p">(</span><span class="n">btc</span><span class="p">)</span>

<span class="n">btc_rsi</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
      <th>Diff</th>
      <th>U</th>
      <th>D</th>
      <th>SMAU</th>
      <th>SMAD</th>
      <th>RS</th>
      <th>RSI</th>
      <th>Position_with_nan</th>
      <th>Position</th>
      <th>Strategy</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-11</th>
      <td>20187.8770</td>
      <td>20792.5254</td>
      <td>20068.6602</td>
      <td>20632.4102</td>
      <td>20632.4102</td>
      <td>30180288176</td>
      <td>0.0221</td>
      <td>445.1660</td>
      <td>445.1660</td>
      <td>0.0000</td>
      <td>100.8832</td>
      <td>282.5236</td>
      <td>0.3571</td>
      <td>26.3123</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0221</td>
    </tr>
    <tr>
      <th>2023-03-12</th>
      <td>20628.0293</td>
      <td>22185.0312</td>
      <td>20448.8066</td>
      <td>22163.9492</td>
      <td>22163.9492</td>
      <td>29279035521</td>
      <td>0.0742</td>
      <td>1531.5391</td>
      <td>1531.5391</td>
      <td>0.0000</td>
      <td>182.7190</td>
      <td>282.5236</td>
      <td>0.6467</td>
      <td>39.2739</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>0.0742</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>22156.4062</td>
      <td>24550.8379</td>
      <td>21918.1992</td>
      <td>24197.5332</td>
      <td>24197.5332</td>
      <td>49466362688</td>
      <td>0.0918</td>
      <td>2033.5840</td>
      <td>2033.5840</td>
      <td>0.0000</td>
      <td>327.9750</td>
      <td>279.7849</td>
      <td>1.1722</td>
      <td>53.9646</td>
      <td>1.0000</td>
      <td>1.0000</td>
      <td>0.0918</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>24201.7656</td>
      <td>26514.7168</td>
      <td>24081.1836</td>
      <td>24746.0742</td>
      <td>24746.0742</td>
      <td>54622230164</td>
      <td>0.0227</td>
      <td>548.5410</td>
      <td>548.5410</td>
      <td>0.0000</td>
      <td>367.1565</td>
      <td>252.9622</td>
      <td>1.4514</td>
      <td>59.2075</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>2023-03-15</th>
      <td>24734.6523</td>
      <td>25169.7305</td>
      <td>24048.3516</td>
      <td>24617.3047</td>
      <td>24617.3047</td>
      <td>44081737728</td>
      <td>-0.0052</td>
      <td>-128.7695</td>
      <td>0.0000</td>
      <td>128.7695</td>
      <td>331.4996</td>
      <td>262.1600</td>
      <td>1.2645</td>
      <td>55.8400</td>
      <td>NaN</td>
      <td>0.0000</td>
      <td>-0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">btc_rsi</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;RSI(14)&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7a408772ea36fc857aee85128d3c0797cc8766924aa0789e89e26ae642d598d7.png" src="_images/7a408772ea36fc857aee85128d3c0797cc8766924aa0789e89e26ae642d598d7.png" />
</div>
</div>
<p>We can compare all three!
Shorting Bitcoin has been dangerous, as the poor returns on RSI(14) show!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">btc_sma</span><span class="p">[[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">btc_bb</span><span class="p">[[</span><span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_BB&#39;</span><span class="p">),</span> 
    <span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">btc_rsi</span><span class="p">[[</span><span class="s1">&#39;Strategy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_RSI&#39;</span><span class="p">),</span> 
    <span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>


<span class="p">(</span>
    <span class="n">_</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>
            <span class="p">{</span>
                <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy-And-Hold&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;SMA(20)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Strategy_BB&#39;</span><span class="p">:</span> <span class="s1">&#39;BB(20, 2)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Strategy_RSI&#39;</span><span class="p">:</span> <span class="s1">&#39;RSI(14)&#39;</span><span class="p">,</span>
            <span class="p">}</span>
           <span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of $1 Invested at Close on </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bca6fe8a2ee1156bf6d412f316c36d0be9567385beaf9e1190a825a35bc69504.png" src="_images/bca6fe8a2ee1156bf6d412f316c36d0be9567385beaf9e1190a825a35bc69504.png" />
</div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-herron_03_lecture"></span><section id="herron-topic-3-multifactor-models">
<h2>Herron Topic 3 - Multifactor Models<a class="headerlink" href="#herron-topic-3-multifactor-models" title="Permalink to this heading">#</a></h2>
<p>This notebook covers multifactor models, emphasizing the capital asset pricing model (CAPM) and the Fama-French three-factor model (FF3).
Ivo Welch provides a high-level review of the CAPM and multifactor models in <a class="reference external" href="https://book.ivo-welch.info/read/source5.mba/10-capm.pdf">Chapter 10 of his free <em>Corporate Finance</em> textbook</a>.
The <a class="reference external" href="https://en.wikipedia.org/wiki/Capital_asset_pricing_model">Wikipedia page for the CAPM</a> is surprisingly good and includes its assumptions and shortcomings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="the-capital-asset-pricing-model-capm">
<h3>The Capital Asset Pricing Model (CAPM)<a class="headerlink" href="#the-capital-asset-pricing-model-capm" title="Permalink to this heading">#</a></h3>
<p>The CAPM explains the relation between non-diversifiable risk and expected return, and it has applications throughout finance.
We use the CAPM to estimate costs of capital in corporate finance, assemble portfolios with a given risk-return tradeoff in portfolio management, and estimate expected rates of return in investment analysis.
The formula for the CAPM is $E(R_i) = R_F + \beta_i [E(R_M) - R_F]$, where:</p>
<ol class="arabic simple">
<li><p>$R_F$ is the risk-free rate of return,</p></li>
<li><p>$\beta_i$ is the measure of non-diversifiable risk for asset $i$, and</p></li>
<li><p>$E(R_M)$ is the expected rate of return on the market.</p></li>
</ol>
<p>Here, $\beta_i$ measures asset $i$’s risk exposure or sensitivity to market returns.
The value-weighted mean of $\beta_i$’s is 1 by construction, but a range of values is possible:</p>
<ol class="arabic simple">
<li><p>$\beta_i &lt; -1$: Asset $i$ moves in the opposite direction as the market, in larger magnitudes</p></li>
<li><p>$-1 \leq \beta_i &lt; 0$: Asset $i$ moves in the opposite direction as the market</p></li>
<li><p>$\beta_i = 0$: Asset $i$ has no correlation between with the market</p></li>
<li><p>$0 &lt; \beta_i \leq 1$: Asset $i$ moves in the same direction as the market, in smaller magnitudes</p></li>
<li><p>$\beta_i = 1$: Asset $i$ moves in the same direction with the same magnitude as the market</p></li>
<li><p>$\beta_i &gt; 1$: Asset $i$ moves in the same direction as the market, in larger magnitudes</p></li>
</ol>
<section id="beta-estimation">
<h4>$\beta$ Estimation<a class="headerlink" href="#beta-estimation" title="Permalink to this heading">#</a></h4>
<p>We can use three (equivalent) approaches to estimate $\beta_i$:</p>
<ol class="arabic simple">
<li><p>From covariance and variance as $\beta_i = \frac{Cov(R_i - R_F, R_M - R_F)}{Var(R_M - R_F)}$</p></li>
<li><p>From correlation and standard deviations as $\beta_i = \rho_{i, M} \cdot \frac{\sigma_i}{\sigma_M}$, where all statistics use <em>excess</em> returns (i.e., $R_i-R_F$ and $R_M-R_F$)</p></li>
<li><p>From a linear regression of $R_i-R_F$ on $R_M-R_F$</p></li>
</ol>
<p>The first two approaches are computationally simpler.
However, the third approach also estimates the intercept $\alpha$ and goodness-of-fit statistics.
We can use Apple (AAPL) to convince ourselves these three approaches are equivalent.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>Note, we will leave returns in percent to make it easier to interpret our regression output!</strong></em>
Leaving returns in percent does not affect the $\beta$s (slopes) but makes the $\alpha$ (intercept) easier to interpret by removing two leading zeros.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aapl</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">Ri</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">aapl</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Ri</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-08</th>
      <td>152.8100</td>
      <td>153.4700</td>
      <td>151.8300</td>
      <td>152.8700</td>
      <td>152.8700</td>
      <td>47204800</td>
      <td>0.8377</td>
    </tr>
    <tr>
      <th>2023-03-09</th>
      <td>153.5600</td>
      <td>154.5400</td>
      <td>150.2300</td>
      <td>150.5900</td>
      <td>150.5900</td>
      <td>53833600</td>
      <td>-1.4915</td>
    </tr>
    <tr>
      <th>2023-03-10</th>
      <td>150.2100</td>
      <td>150.9400</td>
      <td>147.6100</td>
      <td>148.5000</td>
      <td>148.5000</td>
      <td>68524400</td>
      <td>-1.3879</td>
    </tr>
    <tr>
      <th>2023-03-13</th>
      <td>147.8100</td>
      <td>153.1400</td>
      <td>147.7000</td>
      <td>150.4700</td>
      <td>150.4700</td>
      <td>84457100</td>
      <td>1.3266</td>
    </tr>
    <tr>
      <th>2023-03-14</th>
      <td>151.2800</td>
      <td>153.4000</td>
      <td>150.1000</td>
      <td>152.5900</td>
      <td>152.5900</td>
      <td>73628400</td>
      <td>1.4089</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aapl</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">aapl</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">RiRF</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Ri&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">:</span> <span class="s1">&#39;MktRF&#39;</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aapl</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Ri</th>
      <th>MktRF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
      <th>RiRF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1980-12-12</th>
      <td>0.1283</td>
      <td>0.1289</td>
      <td>0.1283</td>
      <td>0.1283</td>
      <td>0.0997</td>
      <td>469033600</td>
      <td>NaN</td>
      <td>1.3800</td>
      <td>-0.0100</td>
      <td>-1.0500</td>
      <td>0.0590</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1980-12-15</th>
      <td>0.1222</td>
      <td>0.1222</td>
      <td>0.1217</td>
      <td>0.1217</td>
      <td>0.0945</td>
      <td>175884800</td>
      <td>-5.2170</td>
      <td>0.1100</td>
      <td>0.2500</td>
      <td>-0.4600</td>
      <td>0.0590</td>
      <td>-5.2760</td>
    </tr>
    <tr>
      <th>1980-12-16</th>
      <td>0.1133</td>
      <td>0.1133</td>
      <td>0.1127</td>
      <td>0.1127</td>
      <td>0.0876</td>
      <td>105728000</td>
      <td>-7.3398</td>
      <td>0.7100</td>
      <td>-0.7500</td>
      <td>-0.4700</td>
      <td>0.0590</td>
      <td>-7.3988</td>
    </tr>
    <tr>
      <th>1980-12-17</th>
      <td>0.1155</td>
      <td>0.1161</td>
      <td>0.1155</td>
      <td>0.1155</td>
      <td>0.0897</td>
      <td>86441600</td>
      <td>2.4751</td>
      <td>1.5200</td>
      <td>-0.8600</td>
      <td>-0.3400</td>
      <td>0.0590</td>
      <td>2.4161</td>
    </tr>
    <tr>
      <th>1980-12-18</th>
      <td>0.1189</td>
      <td>0.1194</td>
      <td>0.1189</td>
      <td>0.1189</td>
      <td>0.0924</td>
      <td>73449600</td>
      <td>2.8993</td>
      <td>0.4100</td>
      <td>0.2200</td>
      <td>1.2600</td>
      <td>0.0590</td>
      <td>2.8403</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="covariance-and-variance">
<h5>Covariance and Variance<a class="headerlink" href="#covariance-and-variance" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vcv</span> <span class="o">=</span> <span class="n">aapl</span><span class="p">[[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span> <span class="s1">&#39;RiRF&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">vcv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MktRF</th>
      <th>RiRF</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MktRF</th>
      <td>1.2441</td>
      <td>1.5706</td>
    </tr>
    <tr>
      <th>RiRF</th>
      <td>1.5706</td>
      <td>7.9996</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Apple beta from cov/var: </span><span class="si">{</span><span class="n">vcv</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span> <span class="s1">&#39;RiRF&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">vcv</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span> <span class="s1">&#39;MktRF&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Apple beta from cov/var: 1.2625
</pre></div>
</div>
</div>
</div>
</section>
<section id="correlation-and-standard-deviations">
<h5>Correlation and Standard Deviations<a class="headerlink" href="#correlation-and-standard-deviations" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">aapl</span><span class="p">[[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span> <span class="s1">&#39;RiRF&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">_</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">_</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rho:</span><span class="se">\n</span><span class="si">{</span><span class="n">rho</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">sigma:</span><span class="se">\n</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>rho:
       MktRF   RiRF
MktRF 1.0000 0.4979
RiRF  0.4979 1.0000

sigma:
MktRF   1.1154
RiRF    2.8284
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Apple beta from rho and sigmas: </span><span class="si">{</span><span class="n">rho</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span> <span class="s1">&#39;RiRF&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;RiRF&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Apple beta from rho and sigmas: 1.2625
</pre></div>
</div>
</div>
</div>
</section>
<section id="linear-regression">
<h5>Linear Regression<a class="headerlink" href="#linear-regression" title="Permalink to this heading">#</a></h5>
<p>We will use the statsmodels package to estimate linear.
I typically use the formula application programming interface (API).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<p>With statsmodels (and most Python model estimation packages), we have three steps:</p>
<ol class="arabic simple">
<li><p>Specify the model</p></li>
<li><p>Fit the model</p></li>
<li><p>Summarize the model</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;RiRF ~ MktRF&#39;</span><span class="p">,</span> <span class="n">aapl</span><span class="p">)</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>          <td>RiRF</td>       <th>  R-squared:         </th> <td>   0.248</td> 
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.248</td> 
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   3493.</td> 
</tr>
<tr>
  <th>Date:</th>             <td>Wed, 15 Mar 2023</td> <th>  Prob (F-statistic):</th>  <td>  0.00</td>  
</tr>
<tr>
  <th>Time:</th>                 <td>11:20:50</td>     <th>  Log-Likelihood:    </th> <td> -24556.</td> 
</tr>
<tr>
  <th>No. Observations:</th>      <td> 10602</td>      <th>  AIC:               </th> <td>4.912e+04</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td> 10600</td>      <th>  BIC:               </th> <td>4.913e+04</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     1</td>      <th>                     </th>     <td> </td>    
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>    
</tr>
</table>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>    0.0520</td> <td>    0.024</td> <td>    2.180</td> <td> 0.029</td> <td>    0.005</td> <td>    0.099</td>
</tr>
<tr>
  <th>MktRF</th>     <td>    1.2625</td> <td>    0.021</td> <td>   59.105</td> <td> 0.000</td> <td>    1.221</td> <td>    1.304</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>3126.527</td> <th>  Durbin-Watson:     </th>  <td>   1.917</td> 
</tr>
<tr>
  <th>Prob(Omnibus):</th>  <td> 0.000</td>  <th>  Jarque-Bera (JB):  </th> <td>313356.303</td>
</tr>
<tr>
  <th>Skew:</th>           <td>-0.376</td>  <th>  Prob(JB):          </th>  <td>    0.00</td> 
</tr>
<tr>
  <th>Kurtosis:</th>       <td>29.623</td>  <th>  Cond. No.          </th>  <td>    1.12</td> 
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept   0.0520
MktRF       1.2625
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Apple beta from linear regression: </span><span class="si">{</span><span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Apple beta from linear regression: 1.2625
</pre></div>
</div>
</div>
</div>
<p>We can chain these operations, but it often makes sense to save the intermediate results (i.e., <code class="docutils literal notranslate"><span class="pre">model</span></code> and <code class="docutils literal notranslate"><span class="pre">fit</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;RiRF ~ MktRF&#39;</span><span class="p">,</span> <span class="n">aapl</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>          <td>RiRF</td>       <th>  R-squared:         </th> <td>   0.248</td> 
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.248</td> 
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   3493.</td> 
</tr>
<tr>
  <th>Date:</th>             <td>Wed, 15 Mar 2023</td> <th>  Prob (F-statistic):</th>  <td>  0.00</td>  
</tr>
<tr>
  <th>Time:</th>                 <td>11:22:03</td>     <th>  Log-Likelihood:    </th> <td> -24556.</td> 
</tr>
<tr>
  <th>No. Observations:</th>      <td> 10602</td>      <th>  AIC:               </th> <td>4.912e+04</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td> 10600</td>      <th>  BIC:               </th> <td>4.913e+04</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     1</td>      <th>                     </th>     <td> </td>    
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>    
</tr>
</table>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>    0.0520</td> <td>    0.024</td> <td>    2.180</td> <td> 0.029</td> <td>    0.005</td> <td>    0.099</td>
</tr>
<tr>
  <th>MktRF</th>     <td>    1.2625</td> <td>    0.021</td> <td>   59.105</td> <td> 0.000</td> <td>    1.221</td> <td>    1.304</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>3126.527</td> <th>  Durbin-Watson:     </th>  <td>   1.917</td> 
</tr>
<tr>
  <th>Prob(Omnibus):</th>  <td> 0.000</td>  <th>  Jarque-Bera (JB):  </th> <td>313356.303</td>
</tr>
<tr>
  <th>Skew:</th>           <td>-0.376</td>  <th>  Prob(JB):          </th>  <td>    0.00</td> 
</tr>
<tr>
  <th>Kurtosis:</th>       <td>29.623</td>  <th>  Cond. No.          </th>  <td>    1.12</td> 
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
</section>
</section>
<section id="beta-visualization">
<h4>$\beta$ Visualization<a class="headerlink" href="#beta-visualization" title="Permalink to this heading">#</a></h4>
<p>We can visualize Apple’s $\beta$, using seaborn’s <code class="docutils literal notranslate"><span class="pre">regplot()</span></code> to add a best-fit line.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<p>We can write a couple of function to more easily make prettier plots.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">label_beta</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">vcv</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">vcv</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;RiRF&#39;</span><span class="p">,</span> <span class="s1">&#39;MktRF&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">vcv</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span> <span class="s1">&#39;MktRF&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$\beta=$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s1"> 0.4f</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">label_dates</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;from </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">aapl</span><span class="p">[[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span> <span class="s1">&#39;RiRF&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;RiRF&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">_</span><span class="p">,</span>
    <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">label_beta</span><span class="p">)}</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Market Excess Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Stock Excess Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\beta$ Plot with Daily Returns for Apple&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">_</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">label_dates</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/70f54012e0434ce15f5a2f9de33f71bd8037e968d7632c4980609b77d5aeda32.png" src="_images/70f54012e0434ce15f5a2f9de33f71bd8037e968d7632c4980609b77d5aeda32.png" />
</div>
</div>
<p>We see a strong relation between Apple and market (excess) returns, but there is a lot of unexplained variation in Apple (excess) returns.
The best practice is to estimate $\beta$ with one to three years of daily data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">aapl</span><span class="p">[[</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span> <span class="s1">&#39;RiRF&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">504</span><span class="p">:]</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;MktRF&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;RiRF&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">_</span><span class="p">,</span>
    <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">label_beta</span><span class="p">)}</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Market Excess Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Stock Excess Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\beta$ Plot with Daily Returns for Apple&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">_</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">label_dates</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/88fd45dd288580e7e60f902f88cd4886ff3a0a5248c45b61a95baab10b7672da.png" src="_images/88fd45dd288580e7e60f902f88cd4886ff3a0a5248c45b61a95baab10b7672da.png" />
</div>
</div>
</section>
<section id="the-security-market-line-sml">
<h4>The Security Market Line (SML)<a class="headerlink" href="#the-security-market-line-sml" title="Permalink to this heading">#</a></h4>
<p>The SML is a visualization of the CAPM.
We can think of $E(R_i) = R_F +  \beta_i [E(R_M) - R_F]$ as $y = b + mx$, where:</p>
<ol class="arabic simple">
<li><p>The equity premium $E(R_M) - R_F$ is the slope $m$ of the SML, and</p></li>
<li><p>The risk-free rate of return $R_F$ is its intercept $b$.</p></li>
</ol>
<p>We will explore the SML more in the practice notebook.</p>
</section>
<section id="how-well-does-the-capm-work">
<h4>How well does the CAPM work?<a class="headerlink" href="#how-well-does-the-capm-work" title="Permalink to this heading">#</a></h4>
<p>The CAPM <em>appears</em> to work well as a single-period model.
We can see this with portfolios formed on $\beta$ from Ken French.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_beta</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_BETA&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ff_beta</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on BETA
-------------------------

This file was created by CMPT_BETA_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BETA. The portfolios are constructed at the end of June. Beta is estimated using monthly returns for the past 60 months (requiring at least 24 months with non-missing returns). Beta is estimated using the Scholes-Williams method. Annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2023 Kenneth R. French

  0 : Value Weighted Returns -- Monthly (715 rows x 15 cols)
  1 : Equal Weighted Returns -- Monthly (715 rows x 15 cols)
  2 : Value Weighted Returns -- Annual from January to December (59 rows x 15 cols)
  3 : Equal Weighted Returns -- Annual from January to December (59 rows x 15 cols)
  4 : Number of Firms in Portfolios (715 rows x 15 cols)
  5 : Average Firm Size (715 rows x 15 cols)
  6 : Value-Weighted Average of Prior Beta (60 rows x 15 cols)
</pre></div>
</div>
</div>
</div>
<p>This file contains seven data frames.
We want the data frame at <code class="docutils literal notranslate"><span class="pre">[2]</span></code>, which contains the annual returns on two sets of portfolios formed on the previous year’s $\beta$s.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_beta</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo 20</th>
      <th>Qnt 2</th>
      <th>Qnt 3</th>
      <th>Qnt 4</th>
      <th>Hi 20</th>
      <th>Lo 10</th>
      <th>Dec 2</th>
      <th>Dec 3</th>
      <th>Dec 4</th>
      <th>Dec 5</th>
      <th>Dec 6</th>
      <th>Dec 7</th>
      <th>Dec 8</th>
      <th>Dec 9</th>
      <th>Hi 10</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1964</th>
      <td>16.8700</td>
      <td>19.7500</td>
      <td>17.6600</td>
      <td>8.7300</td>
      <td>12.5500</td>
      <td>24.7000</td>
      <td>13.5900</td>
      <td>20.2700</td>
      <td>19.0100</td>
      <td>19.7900</td>
      <td>15.6800</td>
      <td>9.7900</td>
      <td>8.2300</td>
      <td>13.6000</td>
      <td>11.6600</td>
    </tr>
    <tr>
      <th>1965</th>
      <td>8.7200</td>
      <td>6.9800</td>
      <td>15.4000</td>
      <td>24.8800</td>
      <td>49.6700</td>
      <td>12.4400</td>
      <td>6.7600</td>
      <td>10.0200</td>
      <td>5.2500</td>
      <td>13.7100</td>
      <td>17.1100</td>
      <td>20.7000</td>
      <td>28.2800</td>
      <td>42.0700</td>
      <td>57.7300</td>
    </tr>
    <tr>
      <th>1966</th>
      <td>-9.2500</td>
      <td>-12.1700</td>
      <td>-9.1000</td>
      <td>-2.7300</td>
      <td>-2.2000</td>
      <td>-9.4300</td>
      <td>-9.4400</td>
      <td>-12.5700</td>
      <td>-12.1600</td>
      <td>-7.5000</td>
      <td>-10.5600</td>
      <td>-6.2200</td>
      <td>0.1800</td>
      <td>-3.3100</td>
      <td>-0.9400</td>
    </tr>
    <tr>
      <th>1967</th>
      <td>13.4300</td>
      <td>22.0600</td>
      <td>31.9500</td>
      <td>42.7900</td>
      <td>51.1500</td>
      <td>8.9200</td>
      <td>18.6400</td>
      <td>22.7900</td>
      <td>21.6500</td>
      <td>31.1100</td>
      <td>34.1600</td>
      <td>40.5700</td>
      <td>44.4000</td>
      <td>41.6100</td>
      <td>59.7800</td>
    </tr>
    <tr>
      <th>1968</th>
      <td>15.8100</td>
      <td>9.1200</td>
      <td>13.6400</td>
      <td>14.4300</td>
      <td>24.2400</td>
      <td>18.4800</td>
      <td>12.8400</td>
      <td>14.5100</td>
      <td>5.8400</td>
      <td>12.6600</td>
      <td>14.7500</td>
      <td>19.0800</td>
      <td>10.5400</td>
      <td>23.2500</td>
      <td>25.2900</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can plot the mean annual return on each of the five portfolios in the first set of portflios.
We do not need to annualize these numbers because they are the means of annual returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ff_beta</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">_</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Annual Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Mean Returns on Portfolios Formed on $\beta$&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;from </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a4dfd01df876026fdb8bd64889b4b3fc7115a9e32b9d9dc60827524aac22a6d3.png" src="_images/a4dfd01df876026fdb8bd64889b4b3fc7115a9e32b9d9dc60827524aac22a6d3.png" />
</div>
</div>
<p>We can think of the plot above as a binned plot of the SML.
The x axis above is an ordinal measure of $\beta$, and the y axis above is the mean return.
Recall the slope of the SML is the market risk premium.
If the market risk premium is too low, then high $\beta$ stocks do not have high enough returns.
We can see this failure of the CAPM by plotting long-term or cumulative returns on these five portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ff_beta</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">_</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value of \$1 Investment (\$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Value of \$1 Investments in Portfolios Formed on $\beta$&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;from </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6743a28600fcf5b73b79da81775497415ced999087ed3744371c9492089e4799.png" src="_images/6743a28600fcf5b73b79da81775497415ced999087ed3744371c9492089e4799.png" />
</div>
</div>
<p>In the plot above, the highest-$\beta$ portfolio has the lowest cumulative returns!
The log scale masks a lot of variation, too!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ff_beta</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">_</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value of \$1 Investment (\$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Value of \$1 Investments in Portfolios Formed on $\beta$&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;from </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/52874944cf95ce6bddd2862f4104c2453ad24608fa7bc643b9c626c455e224dc.png" src="_images/52874944cf95ce6bddd2862f4104c2453ad24608fa7bc643b9c626c455e224dc.png" />
</div>
</div>
<p>If the CAPM does not work well, especially over the horizons we use it for (e.g., capital budgeting), why do we continue to learn it?</p>
<ol class="arabic simple">
<li><p>The CAPM works well <em>across</em> asset classes. We will explore this more in the practice notebook.</p></li>
<li><p>The CAPM intuition that diversification matters is correct and important</p></li>
<li><p>The CAPM assigns high costs of capital to high-$\beta$ projects (i.e., high-risk projects), which is a hidden benefit</p></li>
<li><p>In practice, everyone uses the CAPM</p></li>
</ol>
<p>Ivo Welch provides a more complete discussion in section 10.5 of <a class="reference external" href="https://book.ivo-welch.info/read/source5.mba/10-capm.pdf">chapter 10 of this his free <em>Corporate Finance</em> textbook</a>.</p>
</section>
</section>
<section id="multifactor-models">
<h3>Multifactor Models<a class="headerlink" href="#multifactor-models" title="Permalink to this heading">#</a></h3>
<p>Another shortcoming of the CAPM is that it fails to explain the returns on portfolios formed on size (market capitalization) and value (book-to-market equity ratio), which we will explore in the practice notebook.
These shortcomings have led to an explosion in multifactor models, which we will explore here.</p>
<section id="the-fama-french-three-factor-model">
<h4>The Fama-French Three-Factor Model<a class="headerlink" href="#the-fama-french-three-factor-model" title="Permalink to this heading">#</a></h4>
<p>Fama and French (1993) expand the CAPM by adding two additional factors to explain the excess returns on size and value.
The size factor, SMB or small-minus-big, is a diversified portfolio that measures the excess returns of  small market cap. stocks over large market cap. stocks.
The value factor, HML of high-minus-low, is a diversified portfolio that measures the excess returns of high book-to-market stocks over low  high book-to-market stocks.
We typically call this model the “Fama-French three-factor model” and express it as: $E(R_i) = R_F + \alpha + \beta_{M} [E(R_M) - R_M)] + \beta_{SMB} SMB + \beta_{HML} HML$.
There are two common uses for the three-factor model:</p>
<ol class="arabic simple">
<li><p>Use the coefficient estimate on the intercept (i.e., $\alpha$,  often called “Jensen’s $\alpha$”) as a risk-adjusted performance measure. If $\alpha$ is positive and statistically significant, we may attribute fund performance to manager skill.</p></li>
<li><p>Use the remaining coefficient estimates to evaluate how the fund manager generates returns. If the regression $R^2$ is high, we may replace the fund manager with the factor itself.</p></li>
</ol>
<p>We can use the Fama-French three-factor model to evaluate Warren Buffett at Berkshire Hathaway (BRK-A).
We will focus on the first three-years of easily available returns because Buffett had a larger edge when BRK was much smaller.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brk</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BRK-A&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">Ri</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">RiRF</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Ri&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">:</span> <span class="s1">&#39;MktRF&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s1">&#39;RiRF ~ MktRF + SMB + HML&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">brk</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">756</span><span class="p">])</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>          <td>RiRF</td>       <th>  R-squared:         </th> <td>   0.053</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.049</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   13.91</td>
</tr>
<tr>
  <th>Date:</th>             <td>Wed, 15 Mar 2023</td> <th>  Prob (F-statistic):</th> <td>7.81e-09</td>
</tr>
<tr>
  <th>Time:</th>                 <td>11:35:00</td>     <th>  Log-Likelihood:    </th> <td> -1208.9</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>   755</td>      <th>  AIC:               </th> <td>   2426.</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td>   751</td>      <th>  BIC:               </th> <td>   2444.</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     3</td>      <th>                     </th>     <td> </td>   
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>   
</tr>
</table>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>    0.0801</td> <td>    0.044</td> <td>    1.809</td> <td> 0.071</td> <td>   -0.007</td> <td>    0.167</td>
</tr>
<tr>
  <th>MktRF</th>     <td>    0.3484</td> <td>    0.075</td> <td>    4.643</td> <td> 0.000</td> <td>    0.201</td> <td>    0.496</td>
</tr>
<tr>
  <th>SMB</th>       <td>    0.4021</td> <td>    0.093</td> <td>    4.302</td> <td> 0.000</td> <td>    0.219</td> <td>    0.586</td>
</tr>
<tr>
  <th>HML</th>       <td>    0.0907</td> <td>    0.125</td> <td>    0.724</td> <td> 0.469</td> <td>   -0.155</td> <td>    0.336</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>118.864</td> <th>  Durbin-Watson:     </th> <td>   1.797</td> 
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.000</td>  <th>  Jarque-Bera (JB):  </th> <td>1308.034</td> 
</tr>
<tr>
  <th>Skew:</th>          <td> 0.284</td>  <th>  Prob(JB):          </th> <td>9.20e-285</td>
</tr>
<tr>
  <th>Kurtosis:</th>      <td> 9.423</td>  <th>  Cond. No.          </th> <td>    3.51</td> 
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<p>The $\alpha$ above seems small, but this is a <em>daily</em> value.
We can multiple $\alpha$ by 252 to annualize it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Buffet&#39;s annualized alpha in the early 1980s: </span><span class="si">{</span><span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Buffet&#39;s annualized alpha in the early 1980s: 20.1836
</pre></div>
</div>
</div>
</div>
<p>We will explore rolling $\alpha$s and $\beta$s in the practice notebook using <code class="docutils literal notranslate"><span class="pre">RollingOLS()</span></code> from <code class="docutils literal notranslate"><span class="pre">statsmodels.regression.rolling</span></code>.</p>
</section>
<section id="the-four-factor-and-five-factor-models">
<h4>The Four-Factor and Five-Factor Models<a class="headerlink" href="#the-four-factor-and-five-factor-models" title="Permalink to this heading">#</a></h4>
<p>There are literally hundreds of published factors!
However, many of them have little explanatory power, in or out of sample.
Two more factor models that have explanatory power, economic intuition, and widespread adoption are the four-factor model and five-factor model.</p>
<p>The four-factor model adds a momentum factor to the Fama-French three-factor model.
The momentum factor is a diversified portfolio that measures the excess returns of winner stocks over the loser stocks over the past 12 months.
The momentum factor is often called UMD for up-minus-down or WML for winners-minus-losers.
French stores the momentum factor in a different file because Fama and French are skeptical of momentum as a foundational risk factor.</p>
<p>The five-factor model adds profitability and investment policy factors.
The profitability factor, RMW or robust-minus-weak, measures the excess returns of stocks with high profits over those with low profits.
The investment policy factor, CMA or conservative-minus-aggressive, measures the excess returns of stocks with low corporate investment (conservative) over those with high corporate investment (aggressive).</p>
<p>We will explore the four-factor and five-factor models in the practice notebook.</p>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-herron_03_practice"></span><section id="herron-topic-3-practice-blank">
<h3>Herron Topic 3 - Practice (Blank)<a class="headerlink" href="#herron-topic-3-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="plot-the-security-market-line-sml-for-a-variety-of-asset-classes">
<h5>Plot the security market line (SML) for a variety of asset classes<a class="headerlink" href="#plot-the-security-market-line-sml-for-a-variety-of-asset-classes" title="Permalink to this heading">#</a></h5>
<p>Use the past three years of daily data for the following exhange traded funds (ETFs):</p>
<ol class="arabic simple">
<li><p>SPY (SPDR—Standard and Poor’s Depository Receipts—ETF for the S&amp;P 500 index)</p></li>
<li><p>BIL (SPDR ETF for 1-3 month Treasury bills)</p></li>
<li><p>GLD (SPDR ETF for gold)</p></li>
<li><p>JNK (SPDR ETF for high-yield debt)</p></li>
<li><p>MDY (SPDR ETF for S&amp;P 400 mid-cap index)</p></li>
<li><p>SLY (SPDR ETF for S&amp;P 600 small-cap index)</p></li>
<li><p>SPBO (SPDR ETF for corporate bonds)</p></li>
<li><p>SPMB (SPDR ETF for mortgage-backed securities)</p></li>
<li><p>SPTL (SPDR ETF for long-term Treasury bonds)</p></li>
</ol>
</section>
<section id="plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks">
<h5>Plot the SML for the Dow Jones Industrial Average (DJIA) stocks<a class="headerlink" href="#plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>Use the past three years of daily returns data for the stocks listed on the <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">DJIA Wikipedia page</a>.
Compare the DJIA SML to the asset class SML above.</p>
</section>
<section id="plot-the-sml-for-the-five-portfolios-formed-on-beta">
<h5>Plot the SML for the five portfolios formed on beta<a class="headerlink" href="#plot-the-sml-for-the-five-portfolios-formed-on-beta" title="Permalink to this heading">#</a></h5>
<p>Download data for portfolios formed on $\beta$ (<code class="docutils literal notranslate"><span class="pre">Portfolios_Formed_on_BETA</span></code>) from Ken French.
For the value-weighted portfolios, plot realized returns versus $\beta$.
These data should elements <code class="docutils literal notranslate"><span class="pre">[2]</span></code> and <code class="docutils literal notranslate"><span class="pre">[6]</span></code>, respectively.</p>
</section>
<section id="estimate-the-capm-beta-s-on-several-levered-and-inverse-exchange-traded-funds-etfs">
<h5>Estimate the CAPM $\beta$s on several levered and inverse exchange traded funds (ETFs)<a class="headerlink" href="#estimate-the-capm-beta-s-on-several-levered-and-inverse-exchange-traded-funds-etfs" title="Permalink to this heading">#</a></h5>
<p>Try the following ETFs:</p>
<ol class="arabic simple">
<li><p>SPY</p></li>
<li><p>UPRO</p></li>
<li><p>SPXU</p></li>
</ol>
<p>Can you determine what these products do from the data alone?
Estimate $\beta$s and plot cumulative returns.
You may want to pick short periods of time with large market swings.</p>
</section>
<section id="explore-the-size-factor">
<h5>Explore the size factor<a class="headerlink" href="#explore-the-size-factor" title="Permalink to this heading">#</a></h5>
<section id="estimate-alpha-s-for-the-ten-portfolios-formed-on-size">
<h6>Estimate $\alpha$s for the ten portfolios formed on size<a class="headerlink" href="#estimate-alpha-s-for-the-ten-portfolios-formed-on-size" title="Permalink to this heading">#</a></h6>
<p>Academics started researching size-based portfolios in the early 1980s, so you may want to focus on the pre-1980 sample.</p>
</section>
<section id="are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month">
<h6>Are the returns on these ten portfolios formed on size concentrated in a specific month?<a class="headerlink" href="#are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month" title="Permalink to this heading">#</a></h6>
</section>
<section id="compare-the-size-factor-to-the-market-factor">
<h6>Compare the size factor to the market factor<a class="headerlink" href="#compare-the-size-factor-to-the-market-factor" title="Permalink to this heading">#</a></h6>
<p>You may want to consider mean excess returns by decade.</p>
</section>
</section>
<section id="repeat-the-exercises-above-with-the-value-factor">
<h5>Repeat the exercises above with the value factor<a class="headerlink" href="#repeat-the-exercises-above-with-the-value-factor" title="Permalink to this heading">#</a></h5>
</section>
<section id="repeat-the-exercises-above-with-the-momentum-factor">
<h5>Repeat the exercises above with the momentum factor<a class="headerlink" href="#repeat-the-exercises-above-with-the-momentum-factor" title="Permalink to this heading">#</a></h5>
<p>You may find it helpful to consider the worst months and years for the momentum factor.</p>
</section>
<section id="plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway">
<h5>Plot the coefficient estimates from a rolling Fama-French three-factor model for Berkshire Hathaway<a class="headerlink" href="#plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway" title="Permalink to this heading">#</a></h5>
<p>Use a three-year window with daily returns.
How has Buffett’s $\alpha$ and $\beta$s changed over the past four decades?</p>
</section>
<section id="use-the-three-four-and-five-factor-models-to-determine-how-the-arkk-innovation-etf-generates-returns">
<h5>Use the three-, four-, and five-factor models to determine how the ARKK Innovation ETF generates returns<a class="headerlink" href="#use-the-three-four-and-five-factor-models-to-determine-how-the-arkk-innovation-etf-generates-returns" title="Permalink to this heading">#</a></h5>
</section>
</section>
</section>
<span id="document-herron_03_practice_03"></span><section id="herron-topic-3-practice-monday-2-45-pm-section-3">
<h3>Herron Topic 3 - Practice (Monday 2:45 PM, Section 3)<a class="headerlink" href="#herron-topic-3-practice-monday-2-45-pm-section-3" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Team Project 1 grades posted</p>
<ul>
<li><p>Mean of 81% and median of 84%</p></li>
<li><p>100% on Teammates reviews pushes mean to 84%, which is about the target</p></li>
<li><p>Overall course mean is 86%, so I would curve up overall course grades about 4% if posted grades today, much more at the low end</p></li>
<li><p>However, I cannot commit to a curve today</p></li>
</ul>
</li>
<li><p>20,000 XP on DataCamp due by 11:59 PM on Friday</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-the-security-market-line-sml-for-a-variety-of-asset-classes">
<h5>Plot the security market line (SML) for a variety of asset classes<a class="headerlink" href="#plot-the-security-market-line-sml-for-a-variety-of-asset-classes" title="Permalink to this heading">#</a></h5>
<p>Use the past three years of daily data for the following exhange traded funds (ETFs):</p>
<ol class="arabic simple">
<li><p>SPY (SPDR—Standard and Poor’s Depository Receipts—ETF for the S&amp;P 500 index)</p></li>
<li><p>BIL (SPDR ETF for 1-3 month Treasury bills)</p></li>
<li><p>GLD (SPDR ETF for gold)</p></li>
<li><p>JNK (SPDR ETF for high-yield debt)</p></li>
<li><p>MDY (SPDR ETF for S&amp;P 400 mid-cap index)</p></li>
<li><p>SLY (SPDR ETF for S&amp;P 600 small-cap index)</p></li>
<li><p>SPBO (SPDR ETF for corporate bonds)</p></li>
<li><p>SPMB (SPDR ETF for mortgage-backed securities)</p></li>
<li><p>SPTL (SPDR ETF for long-term Treasury bonds)</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;SPY BIL GLD JNK MDY SLY SPBO SPMB SPTL&#39;</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">ann</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mul</span> <span class="o">*</span> <span class="n">ann</span> <span class="o">*</span> <span class="n">ri</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date_range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_1</span> <span class="o">=</span> <span class="n">etf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span>
<span class="n">_2</span> <span class="o">=</span> <span class="n">_1</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">beta</span><span class="p">])</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Statistic&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_2</span><span class="p">[[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="c1"># use a for-loop to add tickers</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Security Market Line (SML) for Exchange Traded Funds (ETFs)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;for Daily Returns from &#39;</span> <span class="o">+</span> <span class="n">_1</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">date_range</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/65593fe6e057815dbfbaafe719da3e10322b83eb93691fa4d88b93840bf40803.png" src="_images/65593fe6e057815dbfbaafe719da3e10322b83eb93691fa4d88b93840bf40803.png" />
</div>
</div>
<p><em><strong>Note the asset-class ETFs fit the SML very well!</strong></em></p>
</section>
<section id="plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks">
<h5>Plot the SML for the Dow Jones Industrial Average (DJIA) stocks<a class="headerlink" href="#plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>Use the past three years of daily returns data for the stocks listed on the <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">DJIA Wikipedia page</a>.
Compare the DJIA SML to the asset class SML above.</p>
<p>We can re-use out code from above!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">djia</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="n">wiki</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_1</span> <span class="o">=</span> <span class="n">djia</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span>
<span class="n">_2</span> <span class="o">=</span> <span class="n">_1</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">beta</span><span class="p">])</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Statistic&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_2</span><span class="p">[[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="c1"># use a for-loop to add tickers</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Security Market Line (SML) for Dow-Jones Stocks</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;for Daily Returns from &#39;</span> <span class="o">+</span> <span class="n">_1</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">date_range</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/06e3ad3ac2dec671848acc3550782bfdbdff169ebe62e70f0356fb4b6f862195.png" src="_images/06e3ad3ac2dec671848acc3550782bfdbdff169ebe62e70f0356fb4b6f862195.png" />
</div>
</div>
<p><em><strong>Note the SML is flatter and the fit is poorer for single stocks (even large ones) relative to ETFs.</strong></em></p>
</section>
<section id="plot-the-sml-for-the-five-portfolios-formed-on-beta">
<h5>Plot the SML for the five portfolios formed on beta<a class="headerlink" href="#plot-the-sml-for-the-five-portfolios-formed-on-beta" title="Permalink to this heading">#</a></h5>
<p>Download data for portfolios formed on $\beta$ (<code class="docutils literal notranslate"><span class="pre">Portfolios_Formed_on_BETA</span></code>) from Ken French.
For the value-weighted portfolios, plot realized returns versus $\beta$.
These data should elements <code class="docutils literal notranslate"><span class="pre">[2]</span></code> and <code class="docutils literal notranslate"><span class="pre">[6]</span></code>, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_BETA&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">beta_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on BETA
-------------------------

This file was created by CMPT_BETA_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BETA. The portfolios are constructed at the end of June. Beta is estimated using monthly returns for the past 60 months (requiring at least 24 months with non-missing returns). Beta is estimated using the Scholes-Williams method. Annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2023 Kenneth R. French

  0 : Value Weighted Returns -- Monthly (715 rows x 15 cols)
  1 : Equal Weighted Returns -- Monthly (715 rows x 15 cols)
  2 : Value Weighted Returns -- Annual from January to December (59 rows x 15 cols)
  3 : Equal Weighted Returns -- Annual from January to December (59 rows x 15 cols)
  4 : Number of Firms in Portfolios (715 rows x 15 cols)
  5 : Average Firm Size (715 rows x 15 cols)
  6 : Value-Weighted Average of Prior Beta (60 rows x 15 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 20&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 20&#39;</span><span class="p">]</span>

<span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">beta_0</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(),</span> <span class="c1"># betas</span>
            <span class="n">beta_0</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span> <span class="c1"># value-weighted returns</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span> <span class="s1">&#39;Return&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Statistic&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\beta$ Portfolio&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Annual Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Security Market Line (SML) for $\beta$ Portfolios&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">for Annual Returns from </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3cc2f6d6c6d11051afe30a1f1b241f1730895599f868e9aa8ac68a643b101066.png" src="_images/3cc2f6d6c6d11051afe30a1f1b241f1730895599f868e9aa8ac68a643b101066.png" />
</div>
</div>
<p>With a wider range of stock $\beta$s, we see the SML is <em>flat</em>!
Or at least flatter than we expect.</p>
</section>
<section id="estimate-the-capm-beta-s-on-several-levered-and-inverse-exchange-traded-funds-etfs">
<h5>Estimate the CAPM $\beta$s on several levered and inverse exchange traded funds (ETFs)<a class="headerlink" href="#estimate-the-capm-beta-s-on-several-levered-and-inverse-exchange-traded-funds-etfs" title="Permalink to this heading">#</a></h5>
<p>Try the following ETFs:</p>
<ol class="arabic simple">
<li><p>SPY</p></li>
<li><p>UPRO</p></li>
<li><p>SPXU</p></li>
</ol>
<p>Can you determine what these products do from the data alone?
Estimate $\beta$s and plot cumulative returns.
You may want to pick short periods of time with large market swings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;SPY UPRO SPXU&#39;</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\beta$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
SPXU   -2.8660
SPY     0.9586
UPRO    2.8814
Name: $\beta$, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$s&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from Daily Returns from </span><span class="si">{</span><span class="n">etf_2</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e704518cf36499e9d04b29af9257d6cb57f3a78cdd8fbda4550483071f8896d4.png" src="_images/e704518cf36499e9d04b29af9257d6cb57f3a78cdd8fbda4550483071f8896d4.png" />
</div>
</div>
<p>UPRO is a tripled-levered S&amp;P 500 ETF,
SPY is an S&amp;P 500 ETF,
and
SPXU is an <em>inverse</em> triple-levered S&amp;P 500 ETF.
More on levered and inverse ETFs <a class="reference external" href="https://www.schwab.com/learn/story/what-are-leveraged-inverse-etfs-etns-how-do-they-work">here</a>.</p>
</section>
<section id="explore-the-size-factor">
<h5>Explore the size factor<a class="headerlink" href="#explore-the-size-factor" title="Permalink to this heading">#</a></h5>
<section id="estimate-alpha-s-for-the-ten-portfolios-formed-on-size">
<h6>Estimate $\alpha$s for the ten portfolios formed on size<a class="headerlink" href="#estimate-alpha-s-for-the-ten-portfolios-formed-on-size" title="Permalink to this heading">#</a></h6>
<p>Academics started researching size-based portfolios in the early 1980s, so you may want to focus on the pre-1980 sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">size_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_ME&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">size_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2023 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1159 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1159 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (96 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (96 rows x 19 cols)
  4 : Number of Firms in Portfolios (1159 rows x 19 cols)
  5 : Average Firm Size (1159 rows x 19 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_m</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>In class, I used <code class="docutils literal notranslate"><span class="pre">size_0[0]</span></code> for value-weighted returns. To exaggerate the $\alpha$ of small stock strategies, I will use equal-weighted returns here.</strong></em>
Equal-weighted portfolio assign higher weights to small stocks, and lower weights to large stocks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 10&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 5&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 6&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 7&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 8&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 10&#39;</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">size_0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">joined</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo 10</th>
      <th>Dec 2</th>
      <th>Dec 3</th>
      <th>Dec 4</th>
      <th>Dec 5</th>
      <th>Dec 6</th>
      <th>Dec 7</th>
      <th>Dec 8</th>
      <th>Dec 9</th>
      <th>Hi 10</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07</th>
      <td>-1.4200</td>
      <td>0.2900</td>
      <td>-0.1500</td>
      <td>0.8800</td>
      <td>1.4500</td>
      <td>1.8500</td>
      <td>1.6300</td>
      <td>1.3800</td>
      <td>3.3800</td>
      <td>3.2900</td>
      <td>2.9600</td>
      <td>-2.5600</td>
      <td>-2.4300</td>
      <td>0.2200</td>
    </tr>
    <tr>
      <th>1926-08</th>
      <td>4.6100</td>
      <td>2.5900</td>
      <td>4.0300</td>
      <td>3.2400</td>
      <td>2.6600</td>
      <td>4.6700</td>
      <td>1.5400</td>
      <td>1.6300</td>
      <td>0.9800</td>
      <td>3.7000</td>
      <td>2.6400</td>
      <td>-1.1700</td>
      <td>3.8200</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1926-09</th>
      <td>0.9100</td>
      <td>-1.8700</td>
      <td>-2.2700</td>
      <td>-0.8400</td>
      <td>0.1200</td>
      <td>-0.0700</td>
      <td>-1.5800</td>
      <td>0.6400</td>
      <td>-0.8600</td>
      <td>0.6700</td>
      <td>0.3600</td>
      <td>-1.4000</td>
      <td>0.1300</td>
      <td>0.2300</td>
    </tr>
    <tr>
      <th>1926-10</th>
      <td>-4.7200</td>
      <td>-1.7700</td>
      <td>-3.3600</td>
      <td>-5.0100</td>
      <td>-3.0900</td>
      <td>-2.7100</td>
      <td>-3.4500</td>
      <td>-3.2700</td>
      <td>-3.4700</td>
      <td>-2.4300</td>
      <td>-3.2400</td>
      <td>-0.0900</td>
      <td>0.7000</td>
      <td>0.3200</td>
    </tr>
    <tr>
      <th>1926-11</th>
      <td>-0.7700</td>
      <td>-0.3200</td>
      <td>-0.2900</td>
      <td>4.7900</td>
      <td>3.1700</td>
      <td>3.5800</td>
      <td>3.8000</td>
      <td>2.9500</td>
      <td>3.6100</td>
      <td>2.7000</td>
      <td>2.5300</td>
      <td>-0.1000</td>
      <td>-0.5100</td>
      <td>0.3100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;1979&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">]</span>
<span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

<span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">ports</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Size Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the standard errors, too.
The standard errors are in the <code class="docutils literal notranslate"><span class="pre">.params</span></code> attribute of our model fits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Monthly $\alpha$ (%) from CAPM&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Size Portfolio CAPM $\alpha$s for Monthly Returns&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from July 1926 through December 1979&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/589340b5d177c04f34cbd2ca1bb456a1d2dc60aa82c69e38a6d75ab46b5c3e06.png" src="_images/589340b5d177c04f34cbd2ca1bb456a1d2dc60aa82c69e38a6d75ab46b5c3e06.png" />
</div>
</div>
<p>The size effect (i.e., the CAPM $\alpha$ for small stock portfolios) appears large!
We will dig a little deeper!</p>
</section>
<section id="are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month">
<h6>Are the returns on these ten portfolios formed on size concentrated in a specific month?<a class="headerlink" href="#are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">size_0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;January&#39;</span><span class="p">,</span> <span class="s1">&#39;Not January&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted Size Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Monthly Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;When Do We Earn Size-Effect Returns?&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/58f7dd3f2070232a24cd5991e72f272cbbc4fcd99b2f1ffac6a982c4837dd184.png" src="_images/58f7dd3f2070232a24cd5991e72f272cbbc4fcd99b2f1ffac6a982c4837dd184.png" />
</div>
</div>
<p>We earn size effect returns in January!
The size effect is likely due to tax-loss harvesting in small stocks.</p>
</section>
<section id="compare-the-size-factor-to-the-market-factor">
<h6>Compare the size factor to the market factor<a class="headerlink" href="#compare-the-size-factor-to-the-market-factor" title="Permalink to this heading">#</a></h6>
<p>You may want to consider mean excess returns by decade.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span> <span class="s1">&#39;SMB&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;10Y&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;10-Year Period&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Factor&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualize Mean of Monthly Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison on Market Risk and Small Stock Premia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5f3edf7217ff43bbb287d6bd9935dc56919398a42681701ac07da0dcc08a4d8a.png" src="_images/5f3edf7217ff43bbb287d6bd9935dc56919398a42681701ac07da0dcc08a4d8a.png" />
</div>
</div>
<p>The size factor (SMB) may have $\alpha$ early in the sample, but it rarely generates outsize returns.
Plus, the size factor has returned (effectively) zero the last two decades of the sample (2006-2015 and 2016-today).</p>
</section>
</section>
<section id="repeat-the-exercises-above-with-the-value-factor">
<h5>Repeat the exercises above with the value factor<a class="headerlink" href="#repeat-the-exercises-above-with-the-value-factor" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hml_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_BE-ME&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">hml_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on BE-ME
--------------------------

This file was created by CMPT_BEME_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BE/ME. The portfolios are constructed at the end of June. BE/ME is book equity at the last fiscal year end of the prior calendar year divided by ME at the end of December of the prior year. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The portfolios use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2023 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1159 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1159 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (96 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (96 rows x 19 cols)
  4 : Number of Firms in Portfolios (1159 rows x 19 cols)
  5 : Average Firm Size (1159 rows x 19 cols)
  6 : Sum of BE / Sum of ME (97 rows x 19 cols)
  7 : Value Weight Average of BE / ME (97 rows x 19 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 10&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 5&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 6&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 7&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 8&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 10&#39;</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">hml_0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">joined</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo 10</th>
      <th>Dec 2</th>
      <th>Dec 3</th>
      <th>Dec 4</th>
      <th>Dec 5</th>
      <th>Dec 6</th>
      <th>Dec 7</th>
      <th>Dec 8</th>
      <th>Dec 9</th>
      <th>Hi 10</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07</th>
      <td>4.5200</td>
      <td>1.5300</td>
      <td>1.9900</td>
      <td>2.0700</td>
      <td>0.0700</td>
      <td>1.9600</td>
      <td>0.2300</td>
      <td>2.8800</td>
      <td>-1.4400</td>
      <td>-0.1700</td>
      <td>2.9600</td>
      <td>-2.5600</td>
      <td>-2.4300</td>
      <td>0.2200</td>
    </tr>
    <tr>
      <th>1926-08</th>
      <td>0.3400</td>
      <td>0.5100</td>
      <td>3.0000</td>
      <td>0.8100</td>
      <td>2.7900</td>
      <td>1.6600</td>
      <td>0.9600</td>
      <td>4.4900</td>
      <td>5.8100</td>
      <td>6.4800</td>
      <td>2.6400</td>
      <td>-1.1700</td>
      <td>3.8200</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1926-09</th>
      <td>0.3600</td>
      <td>-4.2500</td>
      <td>-1.1600</td>
      <td>0.8800</td>
      <td>-0.7400</td>
      <td>-1.1000</td>
      <td>-0.5000</td>
      <td>-1.4500</td>
      <td>-2.1700</td>
      <td>3.9300</td>
      <td>0.3600</td>
      <td>-1.4000</td>
      <td>0.1300</td>
      <td>0.2300</td>
    </tr>
    <tr>
      <th>1926-10</th>
      <td>-4.1200</td>
      <td>-3.8300</td>
      <td>-2.6700</td>
      <td>-2.7800</td>
      <td>-2.3100</td>
      <td>-3.9800</td>
      <td>-4.1800</td>
      <td>-2.0100</td>
      <td>-4.5800</td>
      <td>-1.8800</td>
      <td>-3.2400</td>
      <td>-0.0900</td>
      <td>0.7000</td>
      <td>0.3200</td>
    </tr>
    <tr>
      <th>1926-11</th>
      <td>4.4400</td>
      <td>0.4700</td>
      <td>1.3500</td>
      <td>4.4500</td>
      <td>3.5600</td>
      <td>1.4700</td>
      <td>3.5100</td>
      <td>3.5100</td>
      <td>2.2300</td>
      <td>2.6600</td>
      <td>2.5300</td>
      <td>-0.1000</td>
      <td>-0.5100</td>
      <td>0.3100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">]</span>

<span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

<span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">ports</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted Value Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the standard errors, too.
The standard errors are in the <code class="docutils literal notranslate"><span class="pre">.params</span></code> attribute of our model fits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Monthly $\alpha$ (%) from CAPM&#39;</span><span class="p">)</span>
<span class="c1"># plt.xticks(rotation=0)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Value Portfolio CAPM $\alpha$s for Monthly Returns&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from July 1926 through january 1979&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8fad74c42a93b4cea2c88078ade4b80a065ea5ec0510ecdb7206c2d785a22602.png" src="_images/8fad74c42a93b4cea2c88078ade4b80a065ea5ec0510ecdb7206c2d785a22602.png" />
</div>
</div>
</section>
<section id="repeat-the-exercises-above-with-the-momentum-factor">
<h5>Repeat the exercises above with the momentum factor<a class="headerlink" href="#repeat-the-exercises-above-with-the-momentum-factor" title="Permalink to this heading">#</a></h5>
<p>You may find it helpful to consider the worst months and years for the momentum factor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;10_Portfolios_Prior_12_2&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mom_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 Portfolios Prior 12 2
------------------------

This file was created by CMPT_PRIOR_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for 10 prior-return portfolios. The portfolios are constructed monthly. PRIOR_RET is from -12 to - 2. The annual returns are from January to December. Missing data are indicated by -99.99 or -999.

  0 : Average Value Weighted Returns -- Monthly (1153 rows x 10 cols)
  1 : Average Equal Weighted Returns -- Monthly (1153 rows x 10 cols)
  2 : Average Value Weighted Returns -- Annual (96 rows x 10 cols)
  3 : Average Equal Weighted Returns -- Annual (96 rows x 10 cols)
  4 : Number of Firms in Portfolios (1153 rows x 10 cols)
  5 : Average Firm Size (1153 rows x 10 cols)
  6 : Value-Weighted Average of Prior Returns (96 rows x 10 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo PRIOR&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 2&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 3&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 4&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 5&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 6&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 7&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 8&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi PRIOR&#39;</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">mom_0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">joined</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo PRIOR</th>
      <th>PRIOR 2</th>
      <th>PRIOR 3</th>
      <th>PRIOR 4</th>
      <th>PRIOR 5</th>
      <th>PRIOR 6</th>
      <th>PRIOR 7</th>
      <th>PRIOR 8</th>
      <th>PRIOR 9</th>
      <th>Hi PRIOR</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-01</th>
      <td>-0.4700</td>
      <td>1.0400</td>
      <td>4.1700</td>
      <td>2.4000</td>
      <td>-0.3100</td>
      <td>3.0800</td>
      <td>1.4800</td>
      <td>0.6400</td>
      <td>-0.5900</td>
      <td>1.1800</td>
      <td>-0.0600</td>
      <td>-0.3700</td>
      <td>4.5400</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1927-02</th>
      <td>8.4900</td>
      <td>3.8800</td>
      <td>8.3300</td>
      <td>7.5900</td>
      <td>4.7900</td>
      <td>5.4700</td>
      <td>5.4000</td>
      <td>4.3000</td>
      <td>5.7600</td>
      <td>5.5800</td>
      <td>4.1800</td>
      <td>0.0400</td>
      <td>2.9400</td>
      <td>0.2600</td>
    </tr>
    <tr>
      <th>1927-03</th>
      <td>-6.1500</td>
      <td>-5.1100</td>
      <td>-2.3800</td>
      <td>-1.6000</td>
      <td>-1.6300</td>
      <td>-1.7000</td>
      <td>0.4900</td>
      <td>-1.5300</td>
      <td>0.3700</td>
      <td>-0.7800</td>
      <td>0.1300</td>
      <td>-1.6500</td>
      <td>-2.6100</td>
      <td>0.3000</td>
    </tr>
    <tr>
      <th>1927-04</th>
      <td>2.6100</td>
      <td>-0.9300</td>
      <td>0.1000</td>
      <td>-1.2000</td>
      <td>0.0900</td>
      <td>0.4000</td>
      <td>1.2700</td>
      <td>-0.5700</td>
      <td>2.2200</td>
      <td>4.4200</td>
      <td>0.4600</td>
      <td>0.3000</td>
      <td>0.8100</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1927-05</th>
      <td>1.1200</td>
      <td>3.7300</td>
      <td>6.0100</td>
      <td>5.1700</td>
      <td>7.5500</td>
      <td>9.2700</td>
      <td>6.6100</td>
      <td>8.2100</td>
      <td>6.9100</td>
      <td>10.0000</td>
      <td>5.4400</td>
      <td>1.5300</td>
      <td>4.7300</td>
      <td>0.3000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">ports</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted Momentum Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the standard errors, too.
The standard errors are in the <code class="docutils literal notranslate"><span class="pre">.params</span></code> attribute of our model fits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Monthly $\alpha$ (%) from CAPM&#39;</span><span class="p">)</span>
<span class="c1"># plt.xticks(rotation=0)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Momentum Portfolio CAPM $\alpha$s for Monthly Returns&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from July 1926 through january 1979&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/561fb57ef0e2da2f6371ef7bcf748c3c03051c3f465b8cead6b1dd2eb3e19424.png" src="_images/561fb57ef0e2da2f6371ef7bcf748c3c03051c3f465b8cead6b1dd2eb3e19424.png" />
</div>
</div>
</section>
<section id="plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway">
<h5>Plot the coefficient estimates from a rolling Fama-French three-factor model for Berkshire Hathaway<a class="headerlink" href="#plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway" title="Permalink to this heading">#</a></h5>
<p>Use a three-year window with daily returns.
How has Buffett’s $\alpha$ and $\beta$s changed over the past four decades?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brk</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BRK-A&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.regression.rolling</span> <span class="kn">import</span> <span class="n">RollingOLS</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">RollingOLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
        <span class="n">formula</span><span class="o">=</span><span class="s1">&#39;I(R-RF) ~ Q(&quot;Mkt-RF&quot;) + SMB + HML&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">brk</span><span class="p">,</span>
        <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="mi">252</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="o">.</span><span class="n">params</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">:</span> <span class="s1">&#39;Mkt-RF&#39;</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">coefs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Intercept&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s1">&#39;Rolling Three-Factor Regressions&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Three-Year Windows with Daily Returns in Percent&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f3f7c57e9982c23fc26048b9555cbf9edabb9a944fc6dc1da29461abc007d976.png" src="_images/f3f7c57e9982c23fc26048b9555cbf9edabb9a944fc6dc1da29461abc007d976.png" />
</div>
</div>
<p>Buffett’s $\alpha$ was large, but has declined to zero.
Also, his loading on SMB (size factor) has gone from positive to negative, indicating that he has moved from small stocks to large stocks as Berkshire Hathaway has grown.</p>
</section>
<section id="use-the-three-four-and-five-factor-models-to-determine-how-the-arkk-innovation-etf-generates-returns">
<h5>Use the three-, four-, and five-factor models to determine how the ARKK Innovation ETF generates returns<a class="headerlink" href="#use-the-three-four-and-five-factor-models-to-determine-how-the-arkk-innovation-etf-generates-returns" title="Permalink to this heading">#</a></h5>
</section>
</section>
</section>
<span id="document-herron_03_practice_04"></span><section id="herron-topic-3-practice-monday-11-45-am-section-4">
<h3>Herron Topic 3 - Practice (Monday 11:45 AM, Section 4)<a class="headerlink" href="#herron-topic-3-practice-monday-11-45-am-section-4" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Team Project 1 grades posted</p>
<ul>
<li><p>Mean of 81% and median of 84%</p></li>
<li><p>100% on Teammates reviews pushes mean to 84%, which is about the target</p></li>
<li><p>Overall course mean is 86%, so I would curve up overall course grades about 4% if posted grades today, much more at the low end</p></li>
<li><p>However, I cannot commit to a curve today</p></li>
</ul>
</li>
<li><p>20,000 XP on DataCamp due by 11:59 PM on Friday</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-the-security-market-line-sml-for-a-variety-of-asset-classes">
<h5>Plot the security market line (SML) for a variety of asset classes<a class="headerlink" href="#plot-the-security-market-line-sml-for-a-variety-of-asset-classes" title="Permalink to this heading">#</a></h5>
<p>Use the past three years of daily data for the following exhange traded funds (ETFs):</p>
<ol class="arabic simple">
<li><p>SPY (SPDR—Standard and Poor’s Depository Receipts—ETF for the S&amp;P 500 index)</p></li>
<li><p>BIL (SPDR ETF for 1-3 month Treasury bills)</p></li>
<li><p>GLD (SPDR ETF for gold)</p></li>
<li><p>JNK (SPDR ETF for high-yield debt)</p></li>
<li><p>MDY (SPDR ETF for S&amp;P 400 mid-cap index)</p></li>
<li><p>SLY (SPDR ETF for S&amp;P 600 small-cap index)</p></li>
<li><p>SPBO (SPDR ETF for corporate bonds)</p></li>
<li><p>SPMB (SPDR ETF for mortgage-backed securities)</p></li>
<li><p>SPTL (SPDR ETF for long-term Treasury bonds)</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;SPY BIL GLD JNK MDY SLY SPBO SPMB SPTL&#39;</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">etf</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>BIL</th>
      <th>GLD</th>
      <th>JNK</th>
      <th>MDY</th>
      <th>SLY</th>
      <th>SPBO</th>
      <th>SPMB</th>
      <th>SPTL</th>
      <th>SPY</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-16</th>
      <td>0.0004</td>
      <td>0.0020</td>
      <td>0.0066</td>
      <td>0.0138</td>
      <td>0.0159</td>
      <td>-0.0031</td>
      <td>-0.0036</td>
      <td>-0.0088</td>
      <td>0.0175</td>
    </tr>
    <tr>
      <th>2023-03-17</th>
      <td>0.0002</td>
      <td>0.0291</td>
      <td>-0.0060</td>
      <td>-0.0228</td>
      <td>-0.0278</td>
      <td>0.0038</td>
      <td>0.0086</td>
      <td>0.0134</td>
      <td>-0.0117</td>
    </tr>
    <tr>
      <th>2023-03-20</th>
      <td>0.0001</td>
      <td>0.0004</td>
      <td>-0.0027</td>
      <td>0.0166</td>
      <td>0.0155</td>
      <td>-0.0010</td>
      <td>-0.0067</td>
      <td>-0.0081</td>
      <td>0.0096</td>
    </tr>
    <tr>
      <th>2023-03-21</th>
      <td>0.0000</td>
      <td>-0.0189</td>
      <td>0.0114</td>
      <td>0.0182</td>
      <td>0.0165</td>
      <td>0.0031</td>
      <td>-0.0036</td>
      <td>-0.0088</td>
      <td>0.0131</td>
    </tr>
    <tr>
      <th>2023-03-22</th>
      <td>0.0002</td>
      <td>0.0170</td>
      <td>0.0011</td>
      <td>-0.0254</td>
      <td>-0.0268</td>
      <td>0.0055</td>
      <td>0.0141</td>
      <td>0.0131</td>
      <td>-0.0170</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ff</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-12-23</th>
      <td>0.0051</td>
      <td>-0.0060</td>
      <td>0.0115</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>-0.0051</td>
      <td>-0.0073</td>
      <td>0.0142</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>-0.0123</td>
      <td>-0.0025</td>
      <td>-0.0029</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>0.0187</td>
      <td>0.0127</td>
      <td>-0.0107</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>-0.0022</td>
      <td>0.0011</td>
      <td>-0.0003</td>
      <td>0.0002</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">ann</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mul</span> <span class="o">*</span> <span class="n">ann</span> <span class="o">*</span> <span class="n">ri</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date_range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">etf</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span> <span class="c1"># I forget to slice to 3 years in class</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">beta</span><span class="p">])</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Statistic&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
 
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_</span><span class="p">[[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="c1"># use a for-loop to add tickers</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Security Market Line (SML) for Exchange Traded Funds (ETFs)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;for Daily Returns from &#39;</span> <span class="o">+</span> <span class="n">etf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">date_range</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3b6dd06cf96dae0129f622e33c9115bdd267739d4c089478c34f7a149757ffce.png" src="_images/3b6dd06cf96dae0129f622e33c9115bdd267739d4c089478c34f7a149757ffce.png" />
</div>
</div>
</section>
<section id="plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks">
<h5>Plot the SML for the Dow Jones Industrial Average (DJIA) stocks<a class="headerlink" href="#plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>Use the past three years of daily returns data for the stocks listed on the <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">DJIA Wikipedia page</a>.
Compare the DJIA SML to the asset class SML above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">djia</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="n">wiki</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">djia</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span> <span class="c1"># I forget to slice to 3 years in class</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">beta</span><span class="p">])</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Statistic&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
 
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_</span><span class="p">[[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="c1"># use a for-loop to add tickers</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Security Market Line (SML) for Dow-Jones Stocks</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;for Daily Returns from &#39;</span> <span class="o">+</span> <span class="n">djia</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">date_range</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c4cc55f421fd3b9df7b122f1985ba02aa080ba364eb574acf84d1f940906d8de.png" src="_images/c4cc55f421fd3b9df7b122f1985ba02aa080ba364eb574acf84d1f940906d8de.png" />
</div>
</div>
</section>
<section id="plot-the-sml-for-the-five-portfolios-formed-on-beta">
<h5>Plot the SML for the five portfolios formed on beta<a class="headerlink" href="#plot-the-sml-for-the-five-portfolios-formed-on-beta" title="Permalink to this heading">#</a></h5>
<p>Download data for portfolios formed on $\beta$ (<code class="docutils literal notranslate"><span class="pre">Portfolios_Formed_on_BETA</span></code>) from Ken French.
For the value-weighted portfolios, plot realized returns versus $\beta$.
These data should elements <code class="docutils literal notranslate"><span class="pre">[2]</span></code> and <code class="docutils literal notranslate"><span class="pre">[6]</span></code>, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta_0</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_BETA&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">beta_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on BETA
-------------------------

This file was created by CMPT_BETA_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BETA. The portfolios are constructed at the end of June. Beta is estimated using monthly returns for the past 60 months (requiring at least 24 months with non-missing returns). Beta is estimated using the Scholes-Williams method. Annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2023 Kenneth R. French

  0 : Value Weighted Returns -- Monthly (715 rows x 15 cols)
  1 : Equal Weighted Returns -- Monthly (715 rows x 15 cols)
  2 : Value Weighted Returns -- Annual from January to December (59 rows x 15 cols)
  3 : Equal Weighted Returns -- Annual from January to December (59 rows x 15 cols)
  4 : Number of Firms in Portfolios (715 rows x 15 cols)
  5 : Average Firm Size (715 rows x 15 cols)
  6 : Value-Weighted Average of Prior Beta (60 rows x 15 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 20&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 20&#39;</span><span class="p">]</span>

<span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">beta_0</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ports</span><span class="p">],</span>
            <span class="n">beta_0</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Statistic&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta Portfolio&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;Beta Portfolio&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Annual Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Security Market Line (SML) for $\beta$ Portfolios&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">for Annual Returns from </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4e73d9e17f908c1760bb04097c69c5cc6ead8ccaeff577bfbca9066bc7a3666d.png" src="_images/4e73d9e17f908c1760bb04097c69c5cc6ead8ccaeff577bfbca9066bc7a3666d.png" />
</div>
</div>
</section>
<section id="estimate-the-capm-beta-s-on-several-levered-and-inverse-exchange-traded-funds-etfs">
<h5>Estimate the CAPM $\beta$s on several levered and inverse exchange traded funds (ETFs)<a class="headerlink" href="#estimate-the-capm-beta-s-on-several-levered-and-inverse-exchange-traded-funds-etfs" title="Permalink to this heading">#</a></h5>
<p>Try the following ETFs:</p>
<ol class="arabic simple">
<li><p>SPY</p></li>
<li><p>UPRO</p></li>
<li><p>SPXU</p></li>
</ol>
<p>Can you determine what these products do from the data alone?
Estimate $\beta$s and plot cumulative returns.
You may want to pick short periods of time with large market swings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;SPY UPRO SPXU&#39;</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\beta$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
SPXU   -2.8660
SPY     0.9586
UPRO    2.8814
Name: $\beta$, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$s&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from Daily Returns from </span><span class="si">{</span><span class="n">etf_2</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e704518cf36499e9d04b29af9257d6cb57f3a78cdd8fbda4550483071f8896d4.png" src="_images/e704518cf36499e9d04b29af9257d6cb57f3a78cdd8fbda4550483071f8896d4.png" />
</div>
</div>
</section>
<section id="explore-the-size-factor">
<h5>Explore the size factor<a class="headerlink" href="#explore-the-size-factor" title="Permalink to this heading">#</a></h5>
<section id="estimate-alpha-s-for-the-ten-portfolios-formed-on-size">
<h6>Estimate $\alpha$s for the ten portfolios formed on size<a class="headerlink" href="#estimate-alpha-s-for-the-ten-portfolios-formed-on-size" title="Permalink to this heading">#</a></h6>
<p>Academics started researching size-based portfolios in the early 1980s, so you may want to focus on the pre-1980 sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">size_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_ME&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">size_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2023 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1159 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1159 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (96 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (96 rows x 19 cols)
  4 : Number of Firms in Portfolios (1159 rows x 19 cols)
  5 : Average Firm Size (1159 rows x 19 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_m</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 10&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 5&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 6&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 7&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 8&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 10&#39;</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">size_0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">joined</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo 10</th>
      <th>Dec 2</th>
      <th>Dec 3</th>
      <th>Dec 4</th>
      <th>Dec 5</th>
      <th>Dec 6</th>
      <th>Dec 7</th>
      <th>Dec 8</th>
      <th>Dec 9</th>
      <th>Hi 10</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07</th>
      <td>-1.4200</td>
      <td>0.2900</td>
      <td>-0.1500</td>
      <td>0.8800</td>
      <td>1.4500</td>
      <td>1.8500</td>
      <td>1.6300</td>
      <td>1.3800</td>
      <td>3.3800</td>
      <td>3.2900</td>
      <td>2.9600</td>
      <td>-2.5600</td>
      <td>-2.4300</td>
      <td>0.2200</td>
    </tr>
    <tr>
      <th>1926-08</th>
      <td>4.6100</td>
      <td>2.5900</td>
      <td>4.0300</td>
      <td>3.2400</td>
      <td>2.6600</td>
      <td>4.6700</td>
      <td>1.5400</td>
      <td>1.6300</td>
      <td>0.9800</td>
      <td>3.7000</td>
      <td>2.6400</td>
      <td>-1.1700</td>
      <td>3.8200</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1926-09</th>
      <td>0.9100</td>
      <td>-1.8700</td>
      <td>-2.2700</td>
      <td>-0.8400</td>
      <td>0.1200</td>
      <td>-0.0700</td>
      <td>-1.5800</td>
      <td>0.6400</td>
      <td>-0.8600</td>
      <td>0.6700</td>
      <td>0.3600</td>
      <td>-1.4000</td>
      <td>0.1300</td>
      <td>0.2300</td>
    </tr>
    <tr>
      <th>1926-10</th>
      <td>-4.7200</td>
      <td>-1.7700</td>
      <td>-3.3600</td>
      <td>-5.0100</td>
      <td>-3.0900</td>
      <td>-2.7100</td>
      <td>-3.4500</td>
      <td>-3.2700</td>
      <td>-3.4700</td>
      <td>-2.4300</td>
      <td>-3.2400</td>
      <td>-0.0900</td>
      <td>0.7000</td>
      <td>0.3200</td>
    </tr>
    <tr>
      <th>1926-11</th>
      <td>-0.7700</td>
      <td>-0.3200</td>
      <td>-0.2900</td>
      <td>4.7900</td>
      <td>3.1700</td>
      <td>3.5800</td>
      <td>3.8000</td>
      <td>2.9500</td>
      <td>3.6100</td>
      <td>2.7000</td>
      <td>2.5300</td>
      <td>-0.1000</td>
      <td>-0.5100</td>
      <td>0.3100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;I(Q(&quot;Lo 10&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>    <td>I(Q("Lo 10") - RF)</td> <th>  R-squared:         </th> <td>   0.516</td> 
</tr>
<tr>
  <th>Model:</th>                    <td>OLS</td>        <th>  Adj. R-squared:    </th> <td>   0.515</td> 
</tr>
<tr>
  <th>Method:</th>              <td>Least Squares</td>   <th>  F-statistic:       </th> <td>   1232.</td> 
</tr>
<tr>
  <th>Date:</th>              <td>Wed, 22 Mar 2023</td>  <th>  Prob (F-statistic):</th> <td>2.06e-184</td>
</tr>
<tr>
  <th>Time:</th>                  <td>18:33:05</td>      <th>  Log-Likelihood:    </th> <td> -3956.4</td> 
</tr>
<tr>
  <th>No. Observations:</th>       <td>  1159</td>       <th>  AIC:               </th> <td>   7917.</td> 
</tr>
<tr>
  <th>Df Residuals:</th>           <td>  1157</td>       <th>  BIC:               </th> <td>   7927.</td> 
</tr>
<tr>
  <th>Df Model:</th>               <td>     1</td>       <th>                     </th>     <td> </td>    
</tr>
<tr>
  <th>Covariance Type:</th>       <td>nonrobust</td>     <th>                     </th>     <td> </td>    
</tr>
</table>
<table class="simpletable">
<tr>
       <td></td>          <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>   <td>    0.5309</td> <td>    0.218</td> <td>    2.438</td> <td> 0.015</td> <td>    0.104</td> <td>    0.958</td>
</tr>
<tr>
  <th>Q("Mkt-RF")</th> <td>    1.4175</td> <td>    0.040</td> <td>   35.105</td> <td> 0.000</td> <td>    1.338</td> <td>    1.497</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>1202.137</td> <th>  Durbin-Watson:     </th>  <td>   1.894</td> 
</tr>
<tr>
  <th>Prob(Omnibus):</th>  <td> 0.000</td>  <th>  Jarque-Bera (JB):  </th> <td>102452.221</td>
</tr>
<tr>
  <th>Skew:</th>           <td> 4.798</td>  <th>  Prob(JB):          </th>  <td>    0.00</td> 
</tr>
<tr>
  <th>Kurtosis:</th>       <td>48.050</td>  <th>  Cond. No.          </th>  <td>    5.44</td> 
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;1979&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">]</span>

<span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

<span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span> 
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
        <span class="n">keys</span><span class="o">=</span><span class="n">ports</span><span class="p">,</span> 
        <span class="n">names</span><span class="o">=</span><span class="s1">&#39;Size Portfolio&#39;</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Size Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the standard errors, too.
The standard errors are in the <code class="docutils literal notranslate"><span class="pre">.params</span></code> attribute of our model fits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Monthly $\alpha$ (%) from CAPM&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Size Portfolio CAPM $\alpha$s for Monthly Returns&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from July 1926 through December 1979&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/589340b5d177c04f34cbd2ca1bb456a1d2dc60aa82c69e38a6d75ab46b5c3e06.png" src="_images/589340b5d177c04f34cbd2ca1bb456a1d2dc60aa82c69e38a6d75ab46b5c3e06.png" />
</div>
</div>
<p>The size effect (i.e., the CAPM $\alpha$ for small stock portfolios) appears large!
We will dig a little deeper!</p>
</section>
<section id="are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month">
<h6>Are the returns on these ten portfolios formed on size concentrated in a specific month?<a class="headerlink" href="#are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">size_0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;January&#39;</span><span class="p">,</span> <span class="s1">&#39;Not January&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted Size Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Monthly Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;When Do We Earn Size-Effect Returns?&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/58f7dd3f2070232a24cd5991e72f272cbbc4fcd99b2f1ffac6a982c4837dd184.png" src="_images/58f7dd3f2070232a24cd5991e72f272cbbc4fcd99b2f1ffac6a982c4837dd184.png" />
</div>
</div>
<p>We earn size effect returns in January!
The size effect is likely due to tax-loss harvesting in small stocks.</p>
</section>
<section id="compare-the-size-factor-to-the-market-factor">
<h6>Compare the size factor to the market factor<a class="headerlink" href="#compare-the-size-factor-to-the-market-factor" title="Permalink to this heading">#</a></h6>
<p>You may want to consider mean excess returns by decade.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span> <span class="s1">&#39;SMB&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;10Y&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;10-Year Period&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Factor&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualize Mean of Monthly Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison on Market Risk and Small Stock Premia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5f3edf7217ff43bbb287d6bd9935dc56919398a42681701ac07da0dcc08a4d8a.png" src="_images/5f3edf7217ff43bbb287d6bd9935dc56919398a42681701ac07da0dcc08a4d8a.png" />
</div>
</div>
<p>The size factor (SMB) may have $\alpha$ early in the sample, but it rarely generates outsize returns.
Plus, the size factor has returned (effectively) zero the last two decades of the sample (2006-2015 and 2016-today).</p>
</section>
</section>
<section id="repeat-the-exercises-above-with-the-value-factor">
<h5>Repeat the exercises above with the value factor<a class="headerlink" href="#repeat-the-exercises-above-with-the-value-factor" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hml_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_BE-ME&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">hml_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on BE-ME
--------------------------

This file was created by CMPT_BEME_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BE/ME. The portfolios are constructed at the end of June. BE/ME is book equity at the last fiscal year end of the prior calendar year divided by ME at the end of December of the prior year. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The portfolios use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2023 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1159 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1159 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (96 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (96 rows x 19 cols)
  4 : Number of Firms in Portfolios (1159 rows x 19 cols)
  5 : Average Firm Size (1159 rows x 19 cols)
  6 : Sum of BE / Sum of ME (97 rows x 19 cols)
  7 : Value Weight Average of BE / ME (97 rows x 19 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 10&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 5&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 6&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 7&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 8&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 10&#39;</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">hml_0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">joined</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo 10</th>
      <th>Dec 2</th>
      <th>Dec 3</th>
      <th>Dec 4</th>
      <th>Dec 5</th>
      <th>Dec 6</th>
      <th>Dec 7</th>
      <th>Dec 8</th>
      <th>Dec 9</th>
      <th>Hi 10</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07</th>
      <td>4.5200</td>
      <td>1.5300</td>
      <td>1.9900</td>
      <td>2.0700</td>
      <td>0.0700</td>
      <td>1.9600</td>
      <td>0.2300</td>
      <td>2.8800</td>
      <td>-1.4400</td>
      <td>-0.1700</td>
      <td>2.9600</td>
      <td>-2.5600</td>
      <td>-2.4300</td>
      <td>0.2200</td>
    </tr>
    <tr>
      <th>1926-08</th>
      <td>0.3400</td>
      <td>0.5100</td>
      <td>3.0000</td>
      <td>0.8100</td>
      <td>2.7900</td>
      <td>1.6600</td>
      <td>0.9600</td>
      <td>4.4900</td>
      <td>5.8100</td>
      <td>6.4800</td>
      <td>2.6400</td>
      <td>-1.1700</td>
      <td>3.8200</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1926-09</th>
      <td>0.3600</td>
      <td>-4.2500</td>
      <td>-1.1600</td>
      <td>0.8800</td>
      <td>-0.7400</td>
      <td>-1.1000</td>
      <td>-0.5000</td>
      <td>-1.4500</td>
      <td>-2.1700</td>
      <td>3.9300</td>
      <td>0.3600</td>
      <td>-1.4000</td>
      <td>0.1300</td>
      <td>0.2300</td>
    </tr>
    <tr>
      <th>1926-10</th>
      <td>-4.1200</td>
      <td>-3.8300</td>
      <td>-2.6700</td>
      <td>-2.7800</td>
      <td>-2.3100</td>
      <td>-3.9800</td>
      <td>-4.1800</td>
      <td>-2.0100</td>
      <td>-4.5800</td>
      <td>-1.8800</td>
      <td>-3.2400</td>
      <td>-0.0900</td>
      <td>0.7000</td>
      <td>0.3200</td>
    </tr>
    <tr>
      <th>1926-11</th>
      <td>4.4400</td>
      <td>0.4700</td>
      <td>1.3500</td>
      <td>4.4500</td>
      <td>3.5600</td>
      <td>1.4700</td>
      <td>3.5100</td>
      <td>3.5100</td>
      <td>2.2300</td>
      <td>2.6600</td>
      <td>2.5300</td>
      <td>-0.1000</td>
      <td>-0.5100</td>
      <td>0.3100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">]</span>

<span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

<span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">ports</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted Value Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the standard errors, too.
The standard errors are in the <code class="docutils literal notranslate"><span class="pre">.params</span></code> attribute of our model fits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Monthly $\alpha$ (%) from CAPM&#39;</span><span class="p">)</span>
<span class="c1"># plt.xticks(rotation=0)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Value Portfolio CAPM $\alpha$s for Monthly Returns&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from July 1926 through january 1979&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8fad74c42a93b4cea2c88078ade4b80a065ea5ec0510ecdb7206c2d785a22602.png" src="_images/8fad74c42a93b4cea2c88078ade4b80a065ea5ec0510ecdb7206c2d785a22602.png" />
</div>
</div>
</section>
<section id="repeat-the-exercises-above-with-the-momentum-factor">
<h5>Repeat the exercises above with the momentum factor<a class="headerlink" href="#repeat-the-exercises-above-with-the-momentum-factor" title="Permalink to this heading">#</a></h5>
<p>You may find it helpful to consider the worst months and years for the momentum factor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;10_Portfolios_Prior_12_2&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mom_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 Portfolios Prior 12 2
------------------------

This file was created by CMPT_PRIOR_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for 10 prior-return portfolios. The portfolios are constructed monthly. PRIOR_RET is from -12 to - 2. The annual returns are from January to December. Missing data are indicated by -99.99 or -999.

  0 : Average Value Weighted Returns -- Monthly (1153 rows x 10 cols)
  1 : Average Equal Weighted Returns -- Monthly (1153 rows x 10 cols)
  2 : Average Value Weighted Returns -- Annual (96 rows x 10 cols)
  3 : Average Equal Weighted Returns -- Annual (96 rows x 10 cols)
  4 : Number of Firms in Portfolios (1153 rows x 10 cols)
  5 : Average Firm Size (1153 rows x 10 cols)
  6 : Value-Weighted Average of Prior Returns (96 rows x 10 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo PRIOR&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 2&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 3&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 4&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 5&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 6&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 7&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 8&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi PRIOR&#39;</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">mom_0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">joined</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo PRIOR</th>
      <th>PRIOR 2</th>
      <th>PRIOR 3</th>
      <th>PRIOR 4</th>
      <th>PRIOR 5</th>
      <th>PRIOR 6</th>
      <th>PRIOR 7</th>
      <th>PRIOR 8</th>
      <th>PRIOR 9</th>
      <th>Hi PRIOR</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-01</th>
      <td>-0.4700</td>
      <td>1.0400</td>
      <td>4.1700</td>
      <td>2.4000</td>
      <td>-0.3100</td>
      <td>3.0800</td>
      <td>1.4800</td>
      <td>0.6400</td>
      <td>-0.5900</td>
      <td>1.1800</td>
      <td>-0.0600</td>
      <td>-0.3700</td>
      <td>4.5400</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1927-02</th>
      <td>8.4900</td>
      <td>3.8800</td>
      <td>8.3300</td>
      <td>7.5900</td>
      <td>4.7900</td>
      <td>5.4700</td>
      <td>5.4000</td>
      <td>4.3000</td>
      <td>5.7600</td>
      <td>5.5800</td>
      <td>4.1800</td>
      <td>0.0400</td>
      <td>2.9400</td>
      <td>0.2600</td>
    </tr>
    <tr>
      <th>1927-03</th>
      <td>-6.1500</td>
      <td>-5.1100</td>
      <td>-2.3800</td>
      <td>-1.6000</td>
      <td>-1.6300</td>
      <td>-1.7000</td>
      <td>0.4900</td>
      <td>-1.5300</td>
      <td>0.3700</td>
      <td>-0.7800</td>
      <td>0.1300</td>
      <td>-1.6500</td>
      <td>-2.6100</td>
      <td>0.3000</td>
    </tr>
    <tr>
      <th>1927-04</th>
      <td>2.6100</td>
      <td>-0.9300</td>
      <td>0.1000</td>
      <td>-1.2000</td>
      <td>0.0900</td>
      <td>0.4000</td>
      <td>1.2700</td>
      <td>-0.5700</td>
      <td>2.2200</td>
      <td>4.4200</td>
      <td>0.4600</td>
      <td>0.3000</td>
      <td>0.8100</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1927-05</th>
      <td>1.1200</td>
      <td>3.7300</td>
      <td>6.0100</td>
      <td>5.1700</td>
      <td>7.5500</td>
      <td>9.2700</td>
      <td>6.6100</td>
      <td>8.2100</td>
      <td>6.9100</td>
      <td>10.0000</td>
      <td>5.4400</td>
      <td>1.5300</td>
      <td>4.7300</td>
      <td>0.3000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">ports</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted Momentum Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the standard errors, too.
The standard errors are in the <code class="docutils literal notranslate"><span class="pre">.params</span></code> attribute of our model fits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Monthly $\alpha$ (%) from CAPM&#39;</span><span class="p">)</span>
<span class="c1"># plt.xticks(rotation=0)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Momentum Portfolio CAPM $\alpha$s for Monthly Returns&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from July 1926 through january 1979&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/561fb57ef0e2da2f6371ef7bcf748c3c03051c3f465b8cead6b1dd2eb3e19424.png" src="_images/561fb57ef0e2da2f6371ef7bcf748c3c03051c3f465b8cead6b1dd2eb3e19424.png" />
</div>
</div>
</section>
<section id="plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway">
<h5>Plot the coefficient estimates from a rolling Fama-French three-factor model for Berkshire Hathaway<a class="headerlink" href="#plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway" title="Permalink to this heading">#</a></h5>
<p>Use a three-year window with daily returns.
How has Buffett’s $\alpha$ and $\beta$s changed over the past four decades?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brk</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BRK-A&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.regression.rolling</span> <span class="kn">import</span> <span class="n">RollingOLS</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">RollingOLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
        <span class="n">formula</span><span class="o">=</span><span class="s1">&#39;I(R-RF) ~ Q(&quot;Mkt-RF&quot;) + SMB + HML&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">brk</span><span class="p">,</span>
        <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="mi">252</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="o">.</span><span class="n">params</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">:</span> <span class="s1">&#39;Mkt-RF&#39;</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">coefs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Intercept&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s1">&#39;Rolling Three-Factor Regressions&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Three-Year Windows with Daily Returns in Percent&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f3f7c57e9982c23fc26048b9555cbf9edabb9a944fc6dc1da29461abc007d976.png" src="_images/f3f7c57e9982c23fc26048b9555cbf9edabb9a944fc6dc1da29461abc007d976.png" />
</div>
</div>
<p>Buffett’s $\alpha$ was large, but has declined to zero.
Also, his loading on SMB (size factor) has gone from positive to negative, indicating that he has moved from small stocks to large stocks as Berkshire Hathaway has grown.</p>
</section>
<section id="use-the-three-four-and-five-factor-models-to-determine-how-the-arkk-innovation-etf-generates-returns">
<h5>Use the three-, four-, and five-factor models to determine how the ARKK Innovation ETF generates returns<a class="headerlink" href="#use-the-three-four-and-five-factor-models-to-determine-how-the-arkk-innovation-etf-generates-returns" title="Permalink to this heading">#</a></h5>
</section>
</section>
</section>
<span id="document-herron_03_practice_02"></span><section id="herron-topic-3-practice-wednesday-2-45-pm-section-2">
<h3>Herron Topic 3 - Practice (Wednesday 2:45 PM, Section 2)<a class="headerlink" href="#herron-topic-3-practice-wednesday-2-45-pm-section-2" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Team Project 1 grades posted</p>
<ul>
<li><p>Mean of 81% and median of 84%</p></li>
<li><p>100% on Teammates reviews pushes mean to 84%, which is about the target</p></li>
<li><p>Overall course mean is 86%, so I would curve up overall course grades about 4% if posted grades today, much more at the low end</p></li>
<li><p>However, I cannot commit to a curve today</p></li>
</ul>
</li>
<li><p>20,000 XP on DataCamp due by 11:59 PM on Friday</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">(</span><span class="n">expire_after</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-the-security-market-line-sml-for-a-variety-of-asset-classes">
<h5>Plot the security market line (SML) for a variety of asset classes<a class="headerlink" href="#plot-the-security-market-line-sml-for-a-variety-of-asset-classes" title="Permalink to this heading">#</a></h5>
<p>Use the past three years of daily data for the following exhange traded funds (ETFs):</p>
<ol class="arabic simple">
<li><p>SPY (SPDR—Standard and Poor’s Depository Receipts—ETF for the S&amp;P 500 index)</p></li>
<li><p>BIL (SPDR ETF for 1-3 month Treasury bills)</p></li>
<li><p>GLD (SPDR ETF for gold)</p></li>
<li><p>JNK (SPDR ETF for high-yield debt)</p></li>
<li><p>MDY (SPDR ETF for S&amp;P 400 mid-cap index)</p></li>
<li><p>SLY (SPDR ETF for S&amp;P 600 small-cap index)</p></li>
<li><p>SPBO (SPDR ETF for corporate bonds)</p></li>
<li><p>SPMB (SPDR ETF for mortgage-backed securities)</p></li>
<li><p>SPTL (SPDR ETF for long-term Treasury bonds)</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;BIL&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">,</span> <span class="s1">&#39;JNK&#39;</span><span class="p">,</span> <span class="s1">&#39;MDY&#39;</span><span class="p">,</span> <span class="s1">&#39;SLY&#39;</span><span class="p">,</span> <span class="s1">&#39;SPBO&#39;</span><span class="p">,</span> <span class="s1">&#39;SPMB&#39;</span><span class="p">,</span> <span class="s1">&#39;SPTL&#39;</span><span class="p">]</span>

<span class="n">etf</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">etf</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>BIL</th>
      <th>GLD</th>
      <th>JNK</th>
      <th>MDY</th>
      <th>SLY</th>
      <th>SPBO</th>
      <th>SPMB</th>
      <th>SPTL</th>
      <th>SPY</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-16</th>
      <td>0.0004</td>
      <td>0.0020</td>
      <td>0.0066</td>
      <td>0.0138</td>
      <td>0.0159</td>
      <td>-0.0031</td>
      <td>-0.0036</td>
      <td>-0.0088</td>
      <td>0.0175</td>
    </tr>
    <tr>
      <th>2023-03-17</th>
      <td>0.0002</td>
      <td>0.0291</td>
      <td>-0.0060</td>
      <td>-0.0228</td>
      <td>-0.0278</td>
      <td>0.0038</td>
      <td>0.0086</td>
      <td>0.0134</td>
      <td>-0.0117</td>
    </tr>
    <tr>
      <th>2023-03-20</th>
      <td>0.0001</td>
      <td>0.0004</td>
      <td>-0.0027</td>
      <td>0.0166</td>
      <td>0.0155</td>
      <td>-0.0010</td>
      <td>-0.0067</td>
      <td>-0.0081</td>
      <td>0.0096</td>
    </tr>
    <tr>
      <th>2023-03-21</th>
      <td>0.0000</td>
      <td>-0.0189</td>
      <td>0.0114</td>
      <td>0.0182</td>
      <td>0.0165</td>
      <td>0.0031</td>
      <td>-0.0036</td>
      <td>-0.0088</td>
      <td>0.0131</td>
    </tr>
    <tr>
      <th>2023-03-22</th>
      <td>0.0002</td>
      <td>0.0170</td>
      <td>0.0011</td>
      <td>-0.0254</td>
      <td>-0.0268</td>
      <td>0.0055</td>
      <td>0.0141</td>
      <td>0.0131</td>
      <td>-0.0170</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ff</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-12-23</th>
      <td>0.0051</td>
      <td>-0.0060</td>
      <td>0.0115</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>-0.0051</td>
      <td>-0.0073</td>
      <td>0.0142</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>-0.0123</td>
      <td>-0.0025</td>
      <td>-0.0029</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>0.0187</td>
      <td>0.0127</td>
      <td>-0.0107</td>
      <td>0.0002</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>-0.0022</td>
      <td>0.0011</td>
      <td>-0.0003</td>
      <td>0.0002</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">ann</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mul</span> <span class="o">*</span> <span class="n">ann</span> <span class="o">*</span> <span class="n">ri</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">date_range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">etf</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span> <span class="c1"># I forget to slice to 3 years in class</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">beta</span><span class="p">])</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Statistic&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
 
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_</span><span class="p">[[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="c1"># use a for-loop to add tickers</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Security Market Line (SML) for Exchange Traded Funds (ETFs)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;for Daily Returns from &#39;</span> <span class="o">+</span> <span class="n">etf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">date_range</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/82d4e71dc5728c1deb211e0155d73a42aad3ff04065c726109c6621637cd9c44.png" src="_images/82d4e71dc5728c1deb211e0155d73a42aad3ff04065c726109c6621637cd9c44.png" />
</div>
</div>
</section>
<section id="plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks">
<h5>Plot the SML for the Dow Jones Industrial Average (DJIA) stocks<a class="headerlink" href="#plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>Use the past three years of daily returns data for the stocks listed on the <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">DJIA Wikipedia page</a>.
Compare the DJIA SML to the asset class SML above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">djia</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="n">wiki</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">djia</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span> <span class="c1"># I forget to slice to 3 years in class</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">beta</span><span class="p">])</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Statistic&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
 
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_</span><span class="p">[[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="c1"># use a for-loop to add tickers</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean of Daily Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Security Market Line (SML) for Dow-Jones Stocks</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;for Daily Returns from &#39;</span> <span class="o">+</span> <span class="n">djia</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">756</span><span class="p">:]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">date_range</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ed5f8cc5ec3bfb78503eb0e92e9a8258d466e02a363bb897cf79bc4aab5eae85.png" src="_images/ed5f8cc5ec3bfb78503eb0e92e9a8258d466e02a363bb897cf79bc4aab5eae85.png" />
</div>
</div>
</section>
<section id="plot-the-sml-for-the-five-portfolios-formed-on-beta">
<h5>Plot the SML for the five portfolios formed on beta<a class="headerlink" href="#plot-the-sml-for-the-five-portfolios-formed-on-beta" title="Permalink to this heading">#</a></h5>
<p>Download data for portfolios formed on $\beta$ (<code class="docutils literal notranslate"><span class="pre">Portfolios_Formed_on_BETA</span></code>) from Ken French.
For the value-weighted portfolios, plot realized returns versus $\beta$.
These data should elements <code class="docutils literal notranslate"><span class="pre">[2]</span></code> and <code class="docutils literal notranslate"><span class="pre">[6]</span></code>, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta_0</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_BETA&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">beta_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on BETA
-------------------------

This file was created by CMPT_BETA_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BETA. The portfolios are constructed at the end of June. Beta is estimated using monthly returns for the past 60 months (requiring at least 24 months with non-missing returns). Beta is estimated using the Scholes-Williams method. Annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2023 Kenneth R. French

  0 : Value Weighted Returns -- Monthly (715 rows x 15 cols)
  1 : Equal Weighted Returns -- Monthly (715 rows x 15 cols)
  2 : Value Weighted Returns -- Annual from January to December (59 rows x 15 cols)
  3 : Equal Weighted Returns -- Annual from January to December (59 rows x 15 cols)
  4 : Number of Firms in Portfolios (715 rows x 15 cols)
  5 : Average Firm Size (715 rows x 15 cols)
  6 : Value-Weighted Average of Prior Beta (60 rows x 15 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 20&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 20&#39;</span><span class="p">]</span>

<span class="n">_</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">beta_0</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ports</span><span class="p">],</span>
            <span class="n">beta_0</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
        <span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Statistic&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta Portfolio&#39;</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;Beta Portfolio&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Annual Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Security Market Line (SML) for $\beta$ Portfolios&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">for Annual Returns from </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/53cce4d26126ae5a7a6b04889446920d598e05e8c0b14f8795b3323c0f9c98a9.png" src="_images/53cce4d26126ae5a7a6b04889446920d598e05e8c0b14f8795b3323c0f9c98a9.png" />
</div>
</div>
</section>
<section id="estimate-the-capm-beta-s-on-several-levered-and-inverse-exchange-traded-funds-etfs">
<h5>Estimate the CAPM $\beta$s on several levered and inverse exchange traded funds (ETFs)<a class="headerlink" href="#estimate-the-capm-beta-s-on-several-levered-and-inverse-exchange-traded-funds-etfs" title="Permalink to this heading">#</a></h5>
<p>Try the following ETFs:</p>
<ol class="arabic simple">
<li><p>SPY</p></li>
<li><p>UPRO</p></li>
<li><p>SPXU</p></li>
</ol>
<p>Can you determine what these products do from the data alone?
Estimate $\beta$s and plot cumulative returns.
You may want to pick short periods of time with large market swings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
        <span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;SPY UPRO SPXU&#39;</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\beta$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ticker
SPXU   -2.8660
SPY     0.9586
UPRO    2.8814
Name: $\beta$, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">etf_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Capital Asset Pricing Model (CAPM) $\beta$s&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from Daily Returns from </span><span class="si">{</span><span class="n">etf_2</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e704518cf36499e9d04b29af9257d6cb57f3a78cdd8fbda4550483071f8896d4.png" src="_images/e704518cf36499e9d04b29af9257d6cb57f3a78cdd8fbda4550483071f8896d4.png" />
</div>
</div>
</section>
<section id="explore-the-size-factor">
<h5>Explore the size factor<a class="headerlink" href="#explore-the-size-factor" title="Permalink to this heading">#</a></h5>
<section id="estimate-alpha-s-for-the-ten-portfolios-formed-on-size">
<h6>Estimate $\alpha$s for the ten portfolios formed on size<a class="headerlink" href="#estimate-alpha-s-for-the-ten-portfolios-formed-on-size" title="Permalink to this heading">#</a></h6>
<p>Academics started researching size-based portfolios in the early 1980s, so you may want to focus on the pre-1980 sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">size_0</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_ME&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">size_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2023 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1159 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1159 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (96 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (96 rows x 19 cols)
  4 : Number of Firms in Portfolios (1159 rows x 19 cols)
  5 : Average Firm Size (1159 rows x 19 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>F-F Research Data Factors
-------------------------

This file was created by CMPT_ME_BEME_RETS using the 202301 CRSP database. The 1-month TBill return is from Ibbotson and Associates, Inc. Copyright 2023 Kenneth R. French

  0 : (1159 rows x 4 cols)
  1 : Annual Factors: January-December (96 rows x 4 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 10&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 5&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 6&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 7&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 8&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 10&#39;</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">size_0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">joined</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo 10</th>
      <th>Dec 2</th>
      <th>Dec 3</th>
      <th>Dec 4</th>
      <th>Dec 5</th>
      <th>Dec 6</th>
      <th>Dec 7</th>
      <th>Dec 8</th>
      <th>Dec 9</th>
      <th>Hi 10</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07</th>
      <td>-1.4200</td>
      <td>0.2900</td>
      <td>-0.1500</td>
      <td>0.8800</td>
      <td>1.4500</td>
      <td>1.8500</td>
      <td>1.6300</td>
      <td>1.3800</td>
      <td>3.3800</td>
      <td>3.2900</td>
      <td>2.9600</td>
      <td>-2.5600</td>
      <td>-2.4300</td>
      <td>0.2200</td>
    </tr>
    <tr>
      <th>1926-08</th>
      <td>4.6100</td>
      <td>2.5900</td>
      <td>4.0300</td>
      <td>3.2400</td>
      <td>2.6600</td>
      <td>4.6700</td>
      <td>1.5400</td>
      <td>1.6300</td>
      <td>0.9800</td>
      <td>3.7000</td>
      <td>2.6400</td>
      <td>-1.1700</td>
      <td>3.8200</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1926-09</th>
      <td>0.9100</td>
      <td>-1.8700</td>
      <td>-2.2700</td>
      <td>-0.8400</td>
      <td>0.1200</td>
      <td>-0.0700</td>
      <td>-1.5800</td>
      <td>0.6400</td>
      <td>-0.8600</td>
      <td>0.6700</td>
      <td>0.3600</td>
      <td>-1.4000</td>
      <td>0.1300</td>
      <td>0.2300</td>
    </tr>
    <tr>
      <th>1926-10</th>
      <td>-4.7200</td>
      <td>-1.7700</td>
      <td>-3.3600</td>
      <td>-5.0100</td>
      <td>-3.0900</td>
      <td>-2.7100</td>
      <td>-3.4500</td>
      <td>-3.2700</td>
      <td>-3.4700</td>
      <td>-2.4300</td>
      <td>-3.2400</td>
      <td>-0.0900</td>
      <td>0.7000</td>
      <td>0.3200</td>
    </tr>
    <tr>
      <th>1926-11</th>
      <td>-0.7700</td>
      <td>-0.3200</td>
      <td>-0.2900</td>
      <td>4.7900</td>
      <td>3.1700</td>
      <td>3.5800</td>
      <td>3.8000</td>
      <td>2.9500</td>
      <td>3.6100</td>
      <td>2.7000</td>
      <td>2.5300</td>
      <td>-0.1000</td>
      <td>-0.5100</td>
      <td>0.3100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;I(Q(&quot;Lo 10&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;1979&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>    <td>I(Q("Lo 10") - RF)</td> <th>  R-squared:         </th> <td>   0.539</td> 
</tr>
<tr>
  <th>Model:</th>                    <td>OLS</td>        <th>  Adj. R-squared:    </th> <td>   0.539</td> 
</tr>
<tr>
  <th>Method:</th>              <td>Least Squares</td>   <th>  F-statistic:       </th> <td>   749.7</td> 
</tr>
<tr>
  <th>Date:</th>              <td>Wed, 22 Mar 2023</td>  <th>  Prob (F-statistic):</th> <td>7.47e-110</td>
</tr>
<tr>
  <th>Time:</th>                  <td>18:33:07</td>      <th>  Log-Likelihood:    </th> <td> -2305.1</td> 
</tr>
<tr>
  <th>No. Observations:</th>       <td>   642</td>       <th>  AIC:               </th> <td>   4614.</td> 
</tr>
<tr>
  <th>Df Residuals:</th>           <td>   640</td>       <th>  BIC:               </th> <td>   4623.</td> 
</tr>
<tr>
  <th>Df Model:</th>               <td>     1</td>       <th>                     </th>     <td> </td>    
</tr>
<tr>
  <th>Covariance Type:</th>       <td>nonrobust</td>     <th>                     </th>     <td> </td>    
</tr>
</table>
<table class="simpletable">
<tr>
       <td></td>          <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>   <td>    0.9283</td> <td>    0.349</td> <td>    2.661</td> <td> 0.008</td> <td>    0.243</td> <td>    1.613</td>
</tr>
<tr>
  <th>Q("Mkt-RF")</th> <td>    1.6043</td> <td>    0.059</td> <td>   27.381</td> <td> 0.000</td> <td>    1.489</td> <td>    1.719</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>611.504</td> <th>  Durbin-Watson:     </th> <td>   1.972</td> 
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.000</td>  <th>  Jarque-Bera (JB):  </th> <td>27321.130</td>
</tr>
<tr>
  <th>Skew:</th>          <td> 4.189</td>  <th>  Prob(JB):          </th> <td>    0.00</td> 
</tr>
<tr>
  <th>Kurtosis:</th>      <td>33.841</td>  <th>  Cond. No.          </th> <td>    5.99</td> 
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;1979&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">]</span>

<span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

<span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span> 
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
        <span class="n">keys</span><span class="o">=</span><span class="n">ports</span><span class="p">,</span> 
        <span class="n">names</span><span class="o">=</span><span class="s1">&#39;Size Portfolio&#39;</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Size Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the standard errors, too.
The standard errors are in the <code class="docutils literal notranslate"><span class="pre">.params</span></code> attribute of our model fits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Monthly $\alpha$ (%) from CAPM&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Size Portfolio CAPM $\alpha$s for Monthly Returns&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from July 1926 through December 1979&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/589340b5d177c04f34cbd2ca1bb456a1d2dc60aa82c69e38a6d75ab46b5c3e06.png" src="_images/589340b5d177c04f34cbd2ca1bb456a1d2dc60aa82c69e38a6d75ab46b5c3e06.png" />
</div>
</div>
<p>The size effect (i.e., the CAPM $\alpha$ for small stock portfolios) appears large!
We will dig a little deeper!</p>
</section>
<section id="are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month">
<h6>Are the returns on these ten portfolios formed on size concentrated in a specific month?<a class="headerlink" href="#are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">size_0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;January&#39;</span><span class="p">,</span> <span class="s1">&#39;Not January&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted Size Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Monthly Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;When Do We Earn Size-Effect Returns?&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/58f7dd3f2070232a24cd5991e72f272cbbc4fcd99b2f1ffac6a982c4837dd184.png" src="_images/58f7dd3f2070232a24cd5991e72f272cbbc4fcd99b2f1ffac6a982c4837dd184.png" />
</div>
</div>
<p>We earn size effect returns in January!
The size effect is likely due to tax-loss harvesting in small stocks.</p>
</section>
<section id="compare-the-size-factor-to-the-market-factor">
<h6>Compare the size factor to the market factor<a class="headerlink" href="#compare-the-size-factor-to-the-market-factor" title="Permalink to this heading">#</a></h6>
<p>You may want to consider mean excess returns by decade.</p>
<p>You may want to consider mean excess returns by decade.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span> <span class="s1">&#39;SMB&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;10Y&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;10-Year Period&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Factor&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualize Mean of Monthly Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison on Market Risk and Small Stock Premia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5f3edf7217ff43bbb287d6bd9935dc56919398a42681701ac07da0dcc08a4d8a.png" src="_images/5f3edf7217ff43bbb287d6bd9935dc56919398a42681701ac07da0dcc08a4d8a.png" />
</div>
</div>
<p>The size factor (SMB) may have $\alpha$ early in the sample, but it rarely generates outsize returns.
Plus, the size factor has returned (effectively) zero the last two decades of the sample (2006-2015 and 2016-today).</p>
</section>
</section>
<section id="repeat-the-exercises-above-with-the-value-factor">
<h5>Repeat the exercises above with the value factor<a class="headerlink" href="#repeat-the-exercises-above-with-the-value-factor" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hml_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolios_Formed_on_BE-ME&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">hml_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Portfolios Formed on BE-ME
--------------------------

This file was created by CMPT_BEME_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BE/ME. The portfolios are constructed at the end of June. BE/ME is book equity at the last fiscal year end of the prior calendar year divided by ME at the end of December of the prior year. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The portfolios use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2023 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1159 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1159 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (96 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (96 rows x 19 cols)
  4 : Number of Firms in Portfolios (1159 rows x 19 cols)
  5 : Average Firm Size (1159 rows x 19 cols)
  6 : Sum of BE / Sum of ME (97 rows x 19 cols)
  7 : Value Weight Average of BE / ME (97 rows x 19 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 10&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 5&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 6&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 7&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 8&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 10&#39;</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">hml_0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">joined</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo 10</th>
      <th>Dec 2</th>
      <th>Dec 3</th>
      <th>Dec 4</th>
      <th>Dec 5</th>
      <th>Dec 6</th>
      <th>Dec 7</th>
      <th>Dec 8</th>
      <th>Dec 9</th>
      <th>Hi 10</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07</th>
      <td>4.5200</td>
      <td>1.5300</td>
      <td>1.9900</td>
      <td>2.0700</td>
      <td>0.0700</td>
      <td>1.9600</td>
      <td>0.2300</td>
      <td>2.8800</td>
      <td>-1.4400</td>
      <td>-0.1700</td>
      <td>2.9600</td>
      <td>-2.5600</td>
      <td>-2.4300</td>
      <td>0.2200</td>
    </tr>
    <tr>
      <th>1926-08</th>
      <td>0.3400</td>
      <td>0.5100</td>
      <td>3.0000</td>
      <td>0.8100</td>
      <td>2.7900</td>
      <td>1.6600</td>
      <td>0.9600</td>
      <td>4.4900</td>
      <td>5.8100</td>
      <td>6.4800</td>
      <td>2.6400</td>
      <td>-1.1700</td>
      <td>3.8200</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1926-09</th>
      <td>0.3600</td>
      <td>-4.2500</td>
      <td>-1.1600</td>
      <td>0.8800</td>
      <td>-0.7400</td>
      <td>-1.1000</td>
      <td>-0.5000</td>
      <td>-1.4500</td>
      <td>-2.1700</td>
      <td>3.9300</td>
      <td>0.3600</td>
      <td>-1.4000</td>
      <td>0.1300</td>
      <td>0.2300</td>
    </tr>
    <tr>
      <th>1926-10</th>
      <td>-4.1200</td>
      <td>-3.8300</td>
      <td>-2.6700</td>
      <td>-2.7800</td>
      <td>-2.3100</td>
      <td>-3.9800</td>
      <td>-4.1800</td>
      <td>-2.0100</td>
      <td>-4.5800</td>
      <td>-1.8800</td>
      <td>-3.2400</td>
      <td>-0.0900</td>
      <td>0.7000</td>
      <td>0.3200</td>
    </tr>
    <tr>
      <th>1926-11</th>
      <td>4.4400</td>
      <td>0.4700</td>
      <td>1.3500</td>
      <td>4.4500</td>
      <td>3.5600</td>
      <td>1.4700</td>
      <td>3.5100</td>
      <td>3.5100</td>
      <td>2.2300</td>
      <td>2.6600</td>
      <td>2.5300</td>
      <td>-0.1000</td>
      <td>-0.5100</td>
      <td>0.3100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">]</span>

<span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

<span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">ports</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted Value Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the standard errors, too.
The standard errors are in the <code class="docutils literal notranslate"><span class="pre">.params</span></code> attribute of our model fits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Monthly $\alpha$ (%) from CAPM&#39;</span><span class="p">)</span>
<span class="c1"># plt.xticks(rotation=0)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Value Portfolio CAPM $\alpha$s for Monthly Returns&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from July 1926 through january 1979&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8fad74c42a93b4cea2c88078ade4b80a065ea5ec0510ecdb7206c2d785a22602.png" src="_images/8fad74c42a93b4cea2c88078ade4b80a065ea5ec0510ecdb7206c2d785a22602.png" />
</div>
</div>
</section>
<section id="repeat-the-exercises-above-with-the-momentum-factor">
<h5>Repeat the exercises above with the momentum factor<a class="headerlink" href="#repeat-the-exercises-above-with-the-momentum-factor" title="Permalink to this heading">#</a></h5>
<p>You may find it helpful to consider the worst months and years for the momentum factor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;10_Portfolios_Prior_12_2&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mom_0</span><span class="p">[</span><span class="s1">&#39;DESCR&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 Portfolios Prior 12 2
------------------------

This file was created by CMPT_PRIOR_RETS using the 202301 CRSP database. It contains value- and equal-weighted returns for 10 prior-return portfolios. The portfolios are constructed monthly. PRIOR_RET is from -12 to - 2. The annual returns are from January to December. Missing data are indicated by -99.99 or -999.

  0 : Average Value Weighted Returns -- Monthly (1153 rows x 10 cols)
  1 : Average Equal Weighted Returns -- Monthly (1153 rows x 10 cols)
  2 : Average Value Weighted Returns -- Annual (96 rows x 10 cols)
  3 : Average Equal Weighted Returns -- Annual (96 rows x 10 cols)
  4 : Number of Firms in Portfolios (1153 rows x 10 cols)
  5 : Average Firm Size (1153 rows x 10 cols)
  6 : Value-Weighted Average of Prior Returns (96 rows x 10 cols)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo PRIOR&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 2&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 3&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 4&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 5&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 6&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 7&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 8&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIOR 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi PRIOR&#39;</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">mom_0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ports</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">joined</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo PRIOR</th>
      <th>PRIOR 2</th>
      <th>PRIOR 3</th>
      <th>PRIOR 4</th>
      <th>PRIOR 5</th>
      <th>PRIOR 6</th>
      <th>PRIOR 7</th>
      <th>PRIOR 8</th>
      <th>PRIOR 9</th>
      <th>Hi PRIOR</th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-01</th>
      <td>-0.4700</td>
      <td>1.0400</td>
      <td>4.1700</td>
      <td>2.4000</td>
      <td>-0.3100</td>
      <td>3.0800</td>
      <td>1.4800</td>
      <td>0.6400</td>
      <td>-0.5900</td>
      <td>1.1800</td>
      <td>-0.0600</td>
      <td>-0.3700</td>
      <td>4.5400</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1927-02</th>
      <td>8.4900</td>
      <td>3.8800</td>
      <td>8.3300</td>
      <td>7.5900</td>
      <td>4.7900</td>
      <td>5.4700</td>
      <td>5.4000</td>
      <td>4.3000</td>
      <td>5.7600</td>
      <td>5.5800</td>
      <td>4.1800</td>
      <td>0.0400</td>
      <td>2.9400</td>
      <td>0.2600</td>
    </tr>
    <tr>
      <th>1927-03</th>
      <td>-6.1500</td>
      <td>-5.1100</td>
      <td>-2.3800</td>
      <td>-1.6000</td>
      <td>-1.6300</td>
      <td>-1.7000</td>
      <td>0.4900</td>
      <td>-1.5300</td>
      <td>0.3700</td>
      <td>-0.7800</td>
      <td>0.1300</td>
      <td>-1.6500</td>
      <td>-2.6100</td>
      <td>0.3000</td>
    </tr>
    <tr>
      <th>1927-04</th>
      <td>2.6100</td>
      <td>-0.9300</td>
      <td>0.1000</td>
      <td>-1.2000</td>
      <td>0.0900</td>
      <td>0.4000</td>
      <td>1.2700</td>
      <td>-0.5700</td>
      <td>2.2200</td>
      <td>4.4200</td>
      <td>0.4600</td>
      <td>0.3000</td>
      <td>0.8100</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1927-05</th>
      <td>1.1200</td>
      <td>3.7300</td>
      <td>6.0100</td>
      <td>5.1700</td>
      <td>7.5500</td>
      <td>9.2700</td>
      <td>6.6100</td>
      <td>8.2100</td>
      <td>6.9100</td>
      <td>10.0000</td>
      <td>5.4400</td>
      <td>1.5300</td>
      <td>4.7300</td>
      <td>0.3000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&quot;) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">joined</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="n">ports</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted Momentum Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the standard errors, too.
The standard errors are in the <code class="docutils literal notranslate"><span class="pre">.params</span></code> attribute of our model fits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ses</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Monthly $\alpha$ (%) from CAPM&#39;</span><span class="p">)</span>
<span class="c1"># plt.xticks(rotation=0)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Momentum Portfolio CAPM $\alpha$s for Monthly Returns&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from July 1926 through january 1979&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/561fb57ef0e2da2f6371ef7bcf748c3c03051c3f465b8cead6b1dd2eb3e19424.png" src="_images/561fb57ef0e2da2f6371ef7bcf748c3c03051c3f465b8cead6b1dd2eb3e19424.png" />
</div>
</div>
</section>
<section id="plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway">
<h5>Plot the coefficient estimates from a rolling Fama-French three-factor model for Berkshire Hathaway<a class="headerlink" href="#plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway" title="Permalink to this heading">#</a></h5>
<p>Use a three-year window with daily returns.
How has Buffett’s $\alpha$ and $\beta$s changed over the past four decades?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brk</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;BRK-A&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
            <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.regression.rolling</span> <span class="kn">import</span> <span class="n">RollingOLS</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">RollingOLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
        <span class="n">formula</span><span class="o">=</span><span class="s1">&#39;I(R-RF) ~ Q(&quot;Mkt-RF&quot;) + SMB + HML&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">brk</span><span class="p">,</span>
        <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="mi">252</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="o">.</span><span class="n">params</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">:</span> <span class="s1">&#39;Mkt-RF&#39;</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">coefs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Intercept&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s1">&#39;Rolling Three-Factor Regressions&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Three-Year Windows with Daily Returns in Percent&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f3f7c57e9982c23fc26048b9555cbf9edabb9a944fc6dc1da29461abc007d976.png" src="_images/f3f7c57e9982c23fc26048b9555cbf9edabb9a944fc6dc1da29461abc007d976.png" />
</div>
</div>
<p>Buffett’s $\alpha$ was large, but has declined to zero.
Also, his loading on SMB (size factor) has gone from positive to negative, indicating that he has moved from small stocks to large stocks as Berkshire Hathaway has grown.</p>
</section>
<section id="use-the-three-four-and-five-factor-models-to-determine-how-the-arkk-innovation-etf-generates-returns">
<h5>Use the three-, four-, and five-factor models to determine how the ARKK Innovation ETF generates returns<a class="headerlink" href="#use-the-three-four-and-five-factor-models-to-determine-how-the-arkk-innovation-etf-generates-returns" title="Permalink to this heading">#</a></h5>
</section>
</section>
</section>
</div>
</section>
<span id="document-herron_04_lecture"></span><section id="herron-topic-4-portfolio-optimization">
<h2>Herron Topic 4 - Portfolio Optimization<a class="headerlink" href="#herron-topic-4-portfolio-optimization" title="Permalink to this heading">#</a></h2>
<p>This notebook covers portfolio optimization.
I have not found a perfect reference that combines portfolio optimization and Python, but here are two references that I find useful:</p>
<ol class="arabic simple">
<li><p>Ivo Welch discusses the mathematics and finance of portfolio optimization in <a class="reference external" href="https://book.ivo-welch.info/bookg.pdf#chapter.12">Chapter 12 of his draft textbook on investments</a>.</p></li>
<li><p>Eryk Lewinson provides Python code for portfolio optimization in chapter 7 of his <a class="reference external" href="https://onesearch.library.northeastern.edu/permalink/01NEU_INST/i2gqis/alma9952082522901401"><em>Python for Finance Cookbook</em></a>, but he uses several packages that are either non-free or abandoned.</p></li>
</ol>
<p>In this notebook, we will:</p>
<ol class="arabic simple">
<li><p>Review the $\frac{1}{n}$ portfolio (or equal-weighted portfolio) from <a class="reference internal" href="_introduction.html#document-herron_01_lecture"><span class="doc std std-doc">Herron Topic 1</span></a></p></li>
<li><p>Use SciPy’s <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function to:</p>
<ol class="arabic simple">
<li><p>Find the minimum variance portfolio</p></li>
<li><p>Find the (mean-variance) efficient frontier</p></li>
</ol>
</li>
</ol>
<p>In the practice notebook, we will use SciPy’s <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function to achieve any objective.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="the-frac-1-n-portfolio">
<h3>The $\frac{1}{n}$ Portfolio<a class="headerlink" href="#the-frac-1-n-portfolio" title="Permalink to this heading">#</a></h3>
<p>We first saw the $\frac{1}{n}$ portfolio (or equal-weighted portfolio) in <a class="reference internal" href="_introduction.html#document-herron_01_lecture"><span class="doc std std-doc">Herron Topic 1</span></a>.
In the $\frac{1}{n}$ portfolio, each of $n$ assets receives an equal portfolio weight $w_i = \frac{1}{n}$.
While the $\frac{1}{n}$ strategy seems too simple to be useful, DeMiguel, Garlappi, and Uppal (2007) show that it is difficult to beat $\frac{1}{n}$ strategy, even with more advanced strategies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="s1">&#39;MSFT AAPL TSLA AMZN NVDA GOOG&#39;</span>

<span class="n">matana</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">matana</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Variable</th>
      <th colspan="6" halign="left">Adj Close</th>
      <th colspan="4" halign="left">Close</th>
      <th>...</th>
      <th colspan="4" halign="left">Open</th>
      <th colspan="6" halign="left">Volume</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>...</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-03-20</th>
      <td>157.4000</td>
      <td>97.7100</td>
      <td>101.9300</td>
      <td>272.2300</td>
      <td>259.0000</td>
      <td>183.2500</td>
      <td>157.4000</td>
      <td>97.7100</td>
      <td>101.9300</td>
      <td>272.2300</td>
      <td>...</td>
      <td>101.0600</td>
      <td>276.9800</td>
      <td>256.1500</td>
      <td>178.0800</td>
      <td>73641400</td>
      <td>62388900.0000</td>
      <td>26033900.0000</td>
      <td>43466600.0000</td>
      <td>43274700.0000</td>
      <td>129684400.0000</td>
    </tr>
    <tr>
      <th>2023-03-21</th>
      <td>159.2800</td>
      <td>100.6100</td>
      <td>105.8400</td>
      <td>273.7800</td>
      <td>261.9900</td>
      <td>197.5800</td>
      <td>159.2800</td>
      <td>100.6100</td>
      <td>105.8400</td>
      <td>273.7800</td>
      <td>...</td>
      <td>101.9800</td>
      <td>274.8800</td>
      <td>261.8000</td>
      <td>188.2800</td>
      <td>73938300</td>
      <td>58597300.0000</td>
      <td>33122800.0000</td>
      <td>34558700.0000</td>
      <td>54740800.0000</td>
      <td>153391400.0000</td>
    </tr>
    <tr>
      <th>2023-03-22</th>
      <td>157.8300</td>
      <td>98.7000</td>
      <td>104.2200</td>
      <td>272.2900</td>
      <td>264.6800</td>
      <td>191.1500</td>
      <td>157.8300</td>
      <td>98.7000</td>
      <td>104.2200</td>
      <td>272.2900</td>
      <td>...</td>
      <td>105.1400</td>
      <td>273.4000</td>
      <td>264.2500</td>
      <td>199.3000</td>
      <td>75701800</td>
      <td>57475400.0000</td>
      <td>32336900.0000</td>
      <td>34873300.0000</td>
      <td>79729500.0000</td>
      <td>150376400.0000</td>
    </tr>
    <tr>
      <th>2023-03-23</th>
      <td>158.9300</td>
      <td>98.7100</td>
      <td>106.2600</td>
      <td>277.6600</td>
      <td>271.9100</td>
      <td>192.2200</td>
      <td>158.9300</td>
      <td>98.7100</td>
      <td>106.2600</td>
      <td>277.6600</td>
      <td>...</td>
      <td>105.8900</td>
      <td>277.9400</td>
      <td>271.1500</td>
      <td>195.2600</td>
      <td>67572500</td>
      <td>57491000.0000</td>
      <td>31369800.0000</td>
      <td>36590300.0000</td>
      <td>56377300.0000</td>
      <td>143865300.0000</td>
    </tr>
    <tr>
      <th>2023-03-24</th>
      <td>158.9300</td>
      <td>97.4100</td>
      <td>105.6050</td>
      <td>278.5400</td>
      <td>266.2550</td>
      <td>189.4000</td>
      <td>158.9300</td>
      <td>97.4100</td>
      <td>105.6050</td>
      <td>278.5400</td>
      <td>...</td>
      <td>105.7400</td>
      <td>277.2400</td>
      <td>270.3100</td>
      <td>191.6500</td>
      <td>26073408</td>
      <td>26008374.0000</td>
      <td>12005487.0000</td>
      <td>12500555.0000</td>
      <td>24673779.0000</td>
      <td>63328036.0000</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 36 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">matana</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">252</span><span class="p">):]</span>

<span class="n">returns</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0015</td>
      <td>0.0003</td>
      <td>0.0010</td>
      <td>0.0011</td>
      <td>0.0025</td>
      <td>0.0032</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0206</td>
      <td>0.0243</td>
      <td>0.0207</td>
      <td>0.0191</td>
      <td>0.0334</td>
      <td>0.0421</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.0801</td>
      <td>-0.1405</td>
      <td>-0.0963</td>
      <td>-0.0772</td>
      <td>-0.0947</td>
      <td>-0.2106</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0101</td>
      <td>-0.0132</td>
      <td>-0.0097</td>
      <td>-0.0096</td>
      <td>-0.0172</td>
      <td>-0.0208</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0012</td>
      <td>0.0005</td>
      <td>0.0015</td>
      <td>0.0007</td>
      <td>0.0032</td>
      <td>0.0021</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0141</td>
      <td>0.0127</td>
      <td>0.0117</td>
      <td>0.0120</td>
      <td>0.0230</td>
      <td>0.0251</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1047</td>
      <td>0.1354</td>
      <td>0.0874</td>
      <td>0.0823</td>
      <td>0.1433</td>
      <td>0.1964</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Before we revisit the advanced techniques from <a class="reference internal" href="_introduction.html#document-herron_01_lecture"><span class="doc std std-doc">Herron Topic 1</span></a>, we can calculate $\frac{1}{n}$ portfolio returns manually, where $R_P = \frac{\sum_{i}^{n} R_i}{n}$
Since our weights are constant (i.e., do not change over time), we rebalance our portfolio every return period.
If we have daily data, rebalance daily.
If we have monthly data, we rebalance monthly, and so on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">p1</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   756.0000
mean      0.0016
std       0.0218
min      -0.0782
25%      -0.0113
50%       0.0021
75%       0.0149
max       0.0980
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Recall from <a class="reference internal" href="_introduction.html#document-herron_01_lecture"><span class="doc std std-doc">Herron Topic 1</span></a> we have two better options:</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">.mean(axis=1)</span></code> method for the $\frac{1}{n}$ portfolio</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">.dot(weights)</span></code> method where <code class="docutils literal notranslate"><span class="pre">weights</span></code> is a pandas series or NumPy array of portfolio weights, allowing different weights for each asset</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p2</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">p2</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   756.0000
mean      0.0016
std       0.0218
min      -0.0782
25%      -0.0113
50%       0.0021
75%       0.0149
max       0.0980
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
<span class="n">p3</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

<span class="n">p3</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   756.0000
mean      0.0016
std       0.0218
min      -0.0782
25%      -0.0113
50%       0.0021
75%       0.0149
max       0.0980
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.describe()</span></code> method provides summary statistics for data, letting us make quick comparisons.
However, we should use <code class="docutils literal notranslate"><span class="pre">np.allclose()</span></code> if we want to be sure that <code class="docutils literal notranslate"><span class="pre">p1</span></code>, <code class="docutils literal notranslate"><span class="pre">p2</span></code>, and <code class="docutils literal notranslate"><span class="pre">p3</span></code> are similar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>Here is a simple example to help understand the <code class="docutils literal notranslate"><span class="pre">.dot()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">silly_n</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">silly_R</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">silly_n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">silly_n</span><span class="p">))</span>
<span class="n">silly_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;silly_n:</span><span class="se">\n</span><span class="si">{</span><span class="n">silly_n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s1">&#39;silly_R:</span><span class="se">\n</span><span class="si">{</span><span class="n">silly_R</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s1">&#39;silly_w:</span><span class="se">\n</span><span class="si">{</span><span class="n">silly_w</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>silly_n:
3

silly_R:
   0  1  2
0  0  1  2
1  3  4  5

silly_w:
[0.3333 0.3333 0.3333]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">silly_R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">silly_w</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0   1.0000
1   4.0000
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Under the hood, Python and the <code class="docutils literal notranslate"><span class="pre">.dot()</span></code> method (effectively) do the following calculation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">silly_R</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;Row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: &#39;</span><span class="p">,</span>
        <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">w</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1"> * </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">silly_w</span><span class="p">,</span> <span class="n">row</span><span class="p">)]),</span>
        <span class="s1">&#39; = &#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">silly_R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">silly_w</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Row 0:  0.33 * 0 + 0.33 * 1 + 0.33 * 2  =  1.00
Row 1:  0.33 * 3 + 0.33 * 4 + 0.33 * 5  =  4.00
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="scipy-s-minimize-function">
<h3>SciPy’s <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> Function<a class="headerlink" href="#scipy-s-minimize-function" title="Permalink to this heading">#</a></h3>
<section id="a-crash-course-in-scipy-s-minimize-function">
<h4>A Crash Course in SciPy’s <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> Function<a class="headerlink" href="#a-crash-course-in-scipy-s-minimize-function" title="Permalink to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function from SciPy’s <code class="docutils literal notranslate"><span class="pre">optimize</span></code> module finds the input array <code class="docutils literal notranslate"><span class="pre">x</span></code> that minimizes the output of the function <code class="docutils literal notranslate"><span class="pre">fun</span></code>.
The <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function uses optimization techniques that are outside this course, but you can consider these optimization techniques to be sophisticated trial and error.</p>
<p>Here are the most common arguments we will pass to the <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function:</p>
<ol class="arabic simple">
<li><p>We pass our first guess for input array <code class="docutils literal notranslate"><span class="pre">x</span></code> to argument <code class="docutils literal notranslate"><span class="pre">x0=</span></code>.</p></li>
<li><p>We pass additional arguments for function <code class="docutils literal notranslate"><span class="pre">fun</span></code> as a tuple to argument <code class="docutils literal notranslate"><span class="pre">args=</span></code>.</p></li>
<li><p>We pass lower and upper bounds on <code class="docutils literal notranslate"><span class="pre">x</span></code> as a tuple of tuples to argument <code class="docutils literal notranslate"><span class="pre">bounds=</span></code>.</p></li>
<li><p>We constrain our results with a tuple of dictionaries of functions to argument <code class="docutils literal notranslate"><span class="pre">contraints=</span></code>.</p></li>
</ol>
<p>Here is a simple example that minimizes the function <code class="docutils literal notranslate"><span class="pre">quadratic()</span></code> that accepts arguments <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">a</span></code> and returns $y = (x - a)^2$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sco</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">quadratic</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quadratic</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quadratic</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>25
</pre></div>
</div>
</div>
</div>
<p>It is helpful to plot $y = (x - a)$ first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">quadratic</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y = (x - 5)^2$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e5601187c4449bd165c85037d0df5deb0354cd30b9879456bbf596624e883c93.png" src="_images/e5601187c4449bd165c85037d0df5deb0354cd30b9879456bbf596624e883c93.png" />
</div>
</div>
<p>The minimum output of <code class="docutils literal notranslate"><span class="pre">quadratic()</span></code> occurs at $x=5$ if we do not use bounds or constraints, even if we start far away from $x=5$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">quadratic</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2001</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      fun: 2.0392713450495178e-16
 hess_inv: array([[0.5]])
      jac: array([-1.3659e-08])
  message: &#39;Optimization terminated successfully.&#39;
     nfev: 18
      nit: 4
     njev: 9
   status: 0
  success: True
        x: array([5.])
</pre></div>
</div>
</div>
</div>
<p>The minimum output of <code class="docutils literal notranslate"><span class="pre">quadratic()</span></code> occurs at $x=6$ if we bound <code class="docutils literal notranslate"><span class="pre">x</span></code> between 6 and 10 (i.e., $6 \leq x \leq 10$).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">quadratic</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2001</span><span class="p">]),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">),)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      fun: 1.0
 hess_inv: &lt;1x1 LbfgsInvHessProduct with dtype=float64&gt;
      jac: array([2.])
  message: &#39;CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL&#39;
     nfev: 4
      nit: 1
     njev: 2
   status: 0
  success: True
        x: array([6.])
</pre></div>
</div>
</div>
</div>
<p>The minimum output of <code class="docutils literal notranslate"><span class="pre">quadratic()</span></code> occurs at $x=6$, again, if we constrain <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">-</span> <span class="pre">6</span></code> to be non-negative.
We use bounds to limit the search space directly, and we use constraints to limit the search space indirectly based on a formula.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">quadratic</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2001</span><span class="p">]),</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">6</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 1.0000000000000018
     jac: array([2.])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 6
     nit: 3
    njev: 3
  status: 0
 success: True
       x: array([6.])
</pre></div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">args=</span></code> argument to pass additional arguments to <code class="docutils literal notranslate"><span class="pre">fun</span></code>.
For example, we change the <code class="docutils literal notranslate"><span class="pre">a=</span></code> argument in <code class="docutils literal notranslate"><span class="pre">quadratic()</span></code> from the default of <code class="docutils literal notranslate"><span class="pre">a=5</span></code> to <code class="docutils literal notranslate"><span class="pre">a=20</span></code> with <code class="docutils literal notranslate"><span class="pre">args=(20,)</span></code>.
Note that <code class="docutils literal notranslate"><span class="pre">args=</span></code> expects a tuple, so we need a trailing comma <code class="docutils literal notranslate"><span class="pre">,</span></code> if we have one argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">quadratic</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,),</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2001</span><span class="p">]),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      fun: 7.090392030754976e-17
 hess_inv: array([[0.5]])
      jac: array([-1.9397e-09])
  message: &#39;Optimization terminated successfully.&#39;
     nfev: 18
      nit: 4
     njev: 9
   status: 0
  success: True
        x: array([20.])
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-minimum-variance-portfolio">
<h4>The Minimum Variance Portfolio<a class="headerlink" href="#the-minimum-variance-portfolio" title="Permalink to this heading">#</a></h4>
<p>We can find the minimum variance portfolio with <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function from SciPy’s <code class="docutils literal notranslate"><span class="pre">optimize</span></code> module.
The <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function with vary an input array <code class="docutils literal notranslate"><span class="pre">x</span></code> (starting from argument <code class="docutils literal notranslate"><span class="pre">x0=</span></code>) to minimize the objective function <code class="docutils literal notranslate"><span class="pre">fun=</span></code> subject to the bounds and constraints in <code class="docutils literal notranslate"><span class="pre">bounds=</span></code> and <code class="docutils literal notranslate"><span class="pre">constraints=</span></code>.
We will define a function <code class="docutils literal notranslate"><span class="pre">port_vol()</span></code> to calculate portfolio volatility.
The first argument to <code class="docutils literal notranslate"><span class="pre">port_vol()</span></code> must be the input array <code class="docutils literal notranslate"><span class="pre">x</span></code> that the <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function searches over.
For clarity, we will call this first argument <code class="docutils literal notranslate"><span class="pre">x</span></code>, but the argument’s name is not important.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_vol</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We will eventually need a mean portfolio return function, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ppy</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_mv</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_vol</span><span class="p">,</span> <span class="c1"># objective function that we minimize</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># initial portfolio weights</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span> <span class="c1"># additional arguments to our objective function</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span> <span class="c1"># bounds limit the search space for each portfolio weights</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">res_mv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.28980781598721805
     jac: array([0.2903, 0.29  , 0.2894, 0.2897, 0.397 , 0.3458])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 56
     nit: 8
    njev: 8
  status: 0
 success: True
       x: array([3.0827e-01, 0.0000e+00, 2.3112e-01, 4.6061e-01, 7.4593e-17,
       0.0000e+00])
</pre></div>
</div>
</div>
</div>
<p>What are the attributes of this minimum variance portfolio?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_port_res</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">ppy</span> <span class="o">*</span> <span class="n">rp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">rp</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tgt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">er</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">er</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">return</span> <span class="nb">print</span><span class="p">(</span>
        <span class="n">title</span><span class="p">,</span>
        <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span>
        <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Performance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span>
        <span class="s1">&#39;Return:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mu</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Volatility:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sigma</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sharpe Ratio:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sr</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">sr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Weights&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> 
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_r</span><span class="si">}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_w</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">_r</span><span class="p">,</span> <span class="n">_w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">w</span><span class="p">)]),</span>
        <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_port_res</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="n">res_mv</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Minimum Variance Portfolio&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Minimum Variance Portfolio
==========================

Performance
--------------------------
Return:             0.2984
Volatility:         0.2898

Weights
--------------------------
AAPL:               0.3083
AMZN:               0.0000
GOOG:               0.2311
MSFT:               0.4606
NVDA:               0.0000
TSLA:               0.0000
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-mean-variance-efficient-frontier">
<h4>The (Mean-Variance) Efficient Frontier<a class="headerlink" href="#the-mean-variance-efficient-frontier" title="Permalink to this heading">#</a></h4>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function to map the efficient frontier.
Here is a basic outline:</p>
<ol class="arabic simple">
<li><p>Create a NumPy array <code class="docutils literal notranslate"><span class="pre">tret</span></code> of target returns</p></li>
<li><p>Create an empty list <code class="docutils literal notranslate"><span class="pre">res_ef</span></code> of <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> results</p></li>
<li><p>Loop over <code class="docutils literal notranslate"><span class="pre">tret</span></code>, passing each as a constraint to the <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> function</p></li>
<li><p>Append each <code class="docutils literal notranslate"><span class="pre">minimize()</span></code> result to <code class="docutils literal notranslate"><span class="pre">res_ef</span></code></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tret</span> <span class="o">=</span> <span class="mi">252</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">25</span><span class="p">)</span>

<span class="n">tret</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.076 , 0.1061, 0.1362, 0.1663, 0.1964, 0.2266, 0.2567, 0.2868,
       0.3169, 0.347 , 0.3772, 0.4073, 0.4374, 0.4675, 0.4976, 0.5277,
       0.5579, 0.588 , 0.6181, 0.6482, 0.6783, 0.7085, 0.7386, 0.7687,
       0.7988])
</pre></div>
</div>
</div>
</div>
<p>We will loop over these target returns, finding the minimum variance portfolio for each target return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_ef</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tret</span><span class="p">:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">port_vol</span><span class="p">,</span> <span class="c1"># minimize portfolio volatility</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># initial portfolio weights</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span> <span class="c1"># additional arguments to fun, in order</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span> <span class="c1"># bounds limit the search space for each portfolio weight</span>
        <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># constrain sum of weights to one</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">port_mean</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="p">}</span> <span class="c1"># constrains portfolio mean return to the target return</span>

        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">res_ef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>List <code class="docutils literal notranslate"><span class="pre">res_ef</span></code> contains the results of all 25 minimum-variance portfolios.
For example, <code class="docutils literal notranslate"><span class="pre">res_ef[0]</span></code> is the minimum variance portfolio for the lowest target return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_ef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.38644121151979843
     jac: array([0.2148, 0.3864, 0.2244, 0.2158, 0.3411, 0.3183])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 21
     nit: 3
    njev: 3
  status: 0
 success: True
       x: array([0.0000e+00, 1.0000e+00, 0.0000e+00, 2.9160e-11, 0.0000e+00,
       5.2856e-17])
</pre></div>
</div>
</div>
</div>
<p>I typically check that all portfolio volatility minimization succeeds.
If a portfolio volatility minimization fails, we should check our function, bounds, and constraints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_ef</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> 
</pre></div>
</div>
</div>
</div>
<p>We can combine the target returns and volatilities into a data frame <code class="docutils literal notranslate"><span class="pre">ef</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s1">&#39;tret&#39;</span><span class="p">:</span> <span class="n">tret</span><span class="p">,</span>
        <span class="s1">&#39;tvol&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_ef</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">ef</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tret</th>
      <th>tvol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0760</td>
      <td>0.3864</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.1061</td>
      <td>0.3609</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.1362</td>
      <td>0.3388</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.1663</td>
      <td>0.3207</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.1964</td>
      <td>0.3073</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ef</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;tvol&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;tret&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;Efficient Frontier&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">for </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> 
    <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">252</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7e347d0b73f704ed78b2f892bc9af615815f989047da46c70f384f666f59f176.png" src="_images/7e347d0b73f704ed78b2f892bc9af615815f989047da46c70f384f666f59f176.png" />
</div>
</div>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-herron_04_practice"></span><section id="herron-topic-4-practice-blank">
<h3>Herron Topic 4 - Practice (Blank)<a class="headerlink" href="#herron-topic-4-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<p>Note that <code class="docutils literal notranslate"><span class="pre">sco.minimize()</span></code> finds <em>minimums</em>, so you need to minimize the <em>negative</em> Sharpe Ratio.</p>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but allow short weights up to 10% on each stock<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock" title="Permalink to this heading">#</a></h5>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but allow total short weights of up to 30%<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30" title="Permalink to this heading">#</a></h5>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but do not allow any weight to exceed 30% in magnitude<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude" title="Permalink to this heading">#</a></h5>
</section>
<section id="find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the minimum 95% Value at Risk (Var) portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<p>More on VaR <a class="reference external" href="https://en.wikipedia.org/wiki/Value_at_risk">here</a>.</p>
</section>
<section id="find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the minimum maximum draw down portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
</section>
<section id="find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks">
<h5>Find the minimum maximum draw down portfolio with all available data for the current Dow-Jones Industrial Average (DJIA) stocks<a class="headerlink" href="#find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>You can find the <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">DJIA tickers on Wikipedia</a>.</p>
</section>
<section id="plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks">
<h5>Plot the (mean-variance) efficient frontier with all available data for the current the DJIA stocks<a class="headerlink" href="#plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks" title="Permalink to this heading">#</a></h5>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks">
<h5>Find the maximum Sharpe Ratio portfolio with all available data for the current the DJIA stocks<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks" title="Permalink to this heading">#</a></h5>
</section>
<section id="compare-the-frac-1-n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks">
<h5>Compare the $\frac{1}{n}$ and maximum Sharpe Ratio portfolios with all available data for the current DJIA stocks<a class="headerlink" href="#compare-the-frac-1-n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>Use all but the last 252 trading days to estimate the maximum Sharpe Ratio portfolio weights.
Then use the last 252 trading days of data to compare the $\frac{1}{n}$  maximum Sharpe Ratio portfolios.</p>
</section>
</section>
</section>
<span id="document-herron_04_practice_03"></span><section id="herron-topic-4-practice-monday-2-45-pm-section-3">
<h3>Herron Topic 4 - Practice (Monday 2:45 PM, Section 3)<a class="headerlink" href="#herron-topic-4-practice-monday-2-45-pm-section-3" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 6 this week</p>
<ul>
<li><p>I will post it at about 6 PM on Wednesday, 3/31</p></li>
<li><p>It will be due by 11:59 PM on Friday, 3/31</p></li>
</ul>
</li>
<li><p>Please complete the week ten survey</p>
<ul>
<li><p>I am considering dropping a topic to allow more in-class group work and easier access to me</p></li>
<li><p>I am also curious why the quantitative courses are less popular this summer</p></li>
<li><p>Please complete by 11:59 PM on Friday, 3/31</p></li>
<li><p><em><strong>The week ten survey is anonymous and voluntary</strong></em></p></li>
</ul>
</li>
<li><p>I will post project 2 as soon as I can</p></li>
<li><p>Assessment exam</p>
<ul>
<li><p>20 questions multiple on Canvas</p></li>
<li><p><em><strong>You must be in the class room</strong></em></p></li>
<li><p>No specific studying, but I suggest putting core course resources on your laptop (e.g., notes and PowerPoints)</p></li>
</ul>
</li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sco</span>
</pre></div>
</div>
</div>
</div>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<p><em><strong>Note that <code class="docutils literal notranslate"><span class="pre">sco.minimize()</span></code> finds minimums, so we need to minimize the negative Sharpe Ratio.</strong></em></p>
<p>The following code downloads data for the MATANA stocks and assigns daily decimal returns from 2020 through 2022 to data frame <code class="docutils literal notranslate"><span class="pre">returns</span></code>.
We will stop in 2022 to make it easier to compare our results, whether we use the risk-free rate or value-weighted market portfolio as our benchmark or not.
Recall, the Fama and French benchmark factors are only available with a lag, and are only available through December 2022 as I type.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="s1">&#39;MSFT AAPL TSLA AMZN NVDA GOOG&#39;</span>

<span class="n">matana</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">matana</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span>
<span class="n">returns</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0011</td>
      <td>0.0002</td>
      <td>0.0006</td>
      <td>0.0008</td>
      <td>0.0018</td>
      <td>0.0030</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0233</td>
      <td>0.0246</td>
      <td>0.0217</td>
      <td>0.0219</td>
      <td>0.0352</td>
      <td>0.0455</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.1286</td>
      <td>-0.1405</td>
      <td>-0.1110</td>
      <td>-0.1474</td>
      <td>-0.1845</td>
      <td>-0.2106</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0110</td>
      <td>-0.0129</td>
      <td>-0.0097</td>
      <td>-0.0097</td>
      <td>-0.0177</td>
      <td>-0.0215</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0006</td>
      <td>0.0006</td>
      <td>0.0012</td>
      <td>0.0007</td>
      <td>0.0029</td>
      <td>0.0020</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0142</td>
      <td>0.0123</td>
      <td>0.0114</td>
      <td>0.0123</td>
      <td>0.0222</td>
      <td>0.0251</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1198</td>
      <td>0.1354</td>
      <td>0.0940</td>
      <td>0.1422</td>
      <td>0.1716</td>
      <td>0.1989</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">,</span> <span class="n">tgt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    x: portfolio weights</span>
<span class="sd">    r: data frame of returns</span>
<span class="sd">    ppy: periods per year for annualization</span>
<span class="sd">    tgt: target or benchmark</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># portfolio return</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="c1"># portfolio excess return</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">er</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="c1"># portfolio Sharpe Ratio</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_sharpe_neg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">,</span> <span class="n">tgt</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># want eq constraint to = 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.0891990698266503
     jac: array([ 1.1642e-04,  3.6243e-01,  1.1961e-01,  6.4995e-02,  4.9071e-04,
       -2.5976e-04])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 63
     nit: 9
    njev: 9
  status: 0
 success: True
       x: array([6.6102e-02, 8.1640e-17, 7.1991e-17, 0.0000e+00, 3.1307e-01,
       6.2083e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0891990698266503
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but allow short weights up to 10% on each stock<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_2</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mf">.1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># want eq constraint to = 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.1368990608896157
     jac: array([0.041 , 0.3444, 0.1157, 0.0727, 0.041 , 0.041 ])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 63
     nit: 9
    njev: 9
  status: 0
 success: True
       x: array([ 0.2997, -0.1   , -0.1   , -0.1   ,  0.3745,  0.6258])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Long Only&#39;</span><span class="p">:</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> 
            <span class="s1">&#39;Up to 10% Short per Stock&#39;</span><span class="p">:</span><span class="n">res_sharpe_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison Max. Sharpe Ratio Portfolio Weights&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/004163d333021c4843934510f0bca8e93ff174a2d8ca8aae95ac07868ddfaaea.png" src="_images/004163d333021c4843934510f0bca8e93ff174a2d8ca8aae95ac07868ddfaaea.png" />
</div>
</div>
<p>By relaxing the long-only constrain (via changes to <code class="docutils literal notranslate"><span class="pre">bounds=</span></code>), the weights on AMZN, GOOG, and MSFT go from zero to -10%.
Also, the Sharpe Ratio increases because we relax a binding constraint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0891990698266503
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1368990608896157
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but allow total short weights of up to 30%<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30" title="Permalink to this heading">#</a></h5>
<p>We can find the negative values in a NumPy array as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span>
<span class="n">x_neg</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All Values: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="se">\n</span><span class="s1">Negative Values: </span><span class="si">{</span><span class="n">x_neg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>All Values: [-5 -4 -3 -2 -1  0  1  2  3  4]
Negative Values: [-5 -4 -3 -2 -1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_3</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">1.3</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># want eq constraint to = 0</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">}</span> <span class="c1"># want ineq constraint to &gt;= 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.1826812160909803
     jac: array([0.0782, 0.336 , 0.1519, 0.1096, 0.0773, 0.0773])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 100
     nit: 10
    njev: 10
  status: 0
 success: True
       x: array([ 3.5659e-01, -3.0000e-01, -7.2559e-10,  1.7959e-05,  3.4963e-01,
        5.9376e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Long Only&#39;</span><span class="p">:</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> 
            <span class="s1">&#39;Up to 30% Short Total&#39;</span><span class="p">:</span><span class="n">res_sharpe_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison Max. Sharpe Ratio Portfolios&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9191ee6b277076599561ec2ccfc4e2c05a524e1504c24b98f5dfcbe9c357f2a1.png" src="_images/9191ee6b277076599561ec2ccfc4e2c05a524e1504c24b98f5dfcbe9c357f2a1.png" />
</div>
</div>
<p>Again, by relaxing the long-only constrain, the weights on AMZN, GOOG, and MSFT go from zero to -10%.
Also, the Sharpe Ratio increases because we relax a binding constraints.
The Sharpe Ratio is higher here than in the previous exercise, but this will not always be the case, since we relax different constraints here and in the previous exercise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0891990698266503
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1826812160909803
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but do not allow any weight to exceed 30% in magnitude<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude" title="Permalink to this heading">#</a></h5>
<p>We can do this easily with <code class="docutils literal notranslate"><span class="pre">bounds=</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_4</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># want eq constraint to = 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.0342974862116496
     jac: array([ 0.1105,  0.5249,  0.2314,  0.176 ,  0.0964, -0.2655])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 21
     nit: 3
    njev: 3
  status: 0
 success: True
       x: array([3.0000e-01, 0.0000e+00, 1.0408e-17, 1.0000e-01, 3.0000e-01,
       3.0000e-01])
</pre></div>
</div>
</div>
</div>
<p><em><strong>I removed the version that achieved the same result with constraints, because it did not work the same on different computers.</strong></em>
I cannot find documentation for why this solution fails, but I suspect using the <code class="docutils literal notranslate"><span class="pre">.max()</span></code> method in a constraint makes convergence slower because changes to non-max values in <code class="docutils literal notranslate"><span class="pre">x</span></code> do not change the constraint function output.</p>
</section>
<section id="find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the minimum 95% Value at Risk (Var) portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<p>More on VaR <a class="reference external" href="https://en.wikipedia.org/wiki/Value_at_risk">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_var_neg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">port_var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_var_1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_var_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_var_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.03592250509338485
     jac: array([0.0359, 0.0419, 0.037 , 0.0385, 0.0275, 0.0416])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 45
     nit: 5
    njev: 5
  status: 0
 success: True
       x: array([1.8180e-01, 1.4369e-01, 2.2517e-01, 2.4347e-01, 2.0587e-01,
       2.6479e-17])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_var_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.03592250509338485
</pre></div>
</div>
</div>
</div>
<p>It might be helpful to slightly change then minimum VaR portfolio weights to show that we minimized VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tweak</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tweak</span><span class="p">(</span><span class="n">res_var_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.03622949371096426
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the minimum maximum draw down portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">cum_max</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">draw_down</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_max</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span> <span class="o">/</span> <span class="n">cum_max</span>
    <span class="k">return</span> <span class="n">draw_down</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_dd_1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_draw_down_max</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_dd_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.2973739393829374
     jac: array([0.2865, 0.5131, 0.4028, 0.2927, 0.5359, 0.7698])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 164
     nit: 19
    njev: 19
  status: 0
 success: True
       x: array([6.8105e-01, 5.4865e-16, 2.2106e-15, 3.1895e-01, 4.8634e-16,
       5.7586e-16])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_dd_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.2974
</pre></div>
</div>
</div>
</div>
<p>Again. it might be helpful to slightly change then minimum VaR portfolio weights to show that we minimized VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tweak</span><span class="p">(</span><span class="n">res_dd_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3065
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks">
<h5>Find the minimum maximum draw down portfolio with all available data for the current Dow-Jones Industrial Average (DJIA) stocks<a class="headerlink" href="#find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>You can find the <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">DJIA tickers on Wikipedia</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">djia</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">wiki</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">returns_2</span> <span class="o">=</span> <span class="n">djia</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">returns_2</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMGN</th>
      <th>AXP</th>
      <th>BA</th>
      <th>CAT</th>
      <th>CRM</th>
      <th>CSCO</th>
      <th>CVX</th>
      <th>DIS</th>
      <th>DOW</th>
      <th>...</th>
      <th>MRK</th>
      <th>MSFT</th>
      <th>NKE</th>
      <th>PG</th>
      <th>TRV</th>
      <th>UNH</th>
      <th>V</th>
      <th>VZ</th>
      <th>WBA</th>
      <th>WMT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>...</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
      <td>954.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0013</td>
      <td>0.0006</td>
      <td>0.0007</td>
      <td>-0.0001</td>
      <td>0.0009</td>
      <td>0.0001</td>
      <td>0.0002</td>
      <td>0.0009</td>
      <td>0.0000</td>
      <td>0.0006</td>
      <td>...</td>
      <td>0.0006</td>
      <td>0.0010</td>
      <td>0.0006</td>
      <td>0.0006</td>
      <td>0.0007</td>
      <td>0.0010</td>
      <td>0.0005</td>
      <td>-0.0001</td>
      <td>-0.0001</td>
      <td>0.0006</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0218</td>
      <td>0.0167</td>
      <td>0.0259</td>
      <td>0.0350</td>
      <td>0.0211</td>
      <td>0.0258</td>
      <td>0.0192</td>
      <td>0.0244</td>
      <td>0.0226</td>
      <td>0.0260</td>
      <td>...</td>
      <td>0.0153</td>
      <td>0.0202</td>
      <td>0.0221</td>
      <td>0.0143</td>
      <td>0.0193</td>
      <td>0.0198</td>
      <td>0.0194</td>
      <td>0.0126</td>
      <td>0.0220</td>
      <td>0.0150</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.1286</td>
      <td>-0.0826</td>
      <td>-0.1482</td>
      <td>-0.2385</td>
      <td>-0.1428</td>
      <td>-0.1589</td>
      <td>-0.1373</td>
      <td>-0.2212</td>
      <td>-0.1316</td>
      <td>-0.2166</td>
      <td>...</td>
      <td>-0.0986</td>
      <td>-0.1474</td>
      <td>-0.1281</td>
      <td>-0.0874</td>
      <td>-0.2080</td>
      <td>-0.1728</td>
      <td>-0.1355</td>
      <td>-0.0674</td>
      <td>-0.1281</td>
      <td>-0.1138</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0093</td>
      <td>-0.0073</td>
      <td>-0.0108</td>
      <td>-0.0149</td>
      <td>-0.0100</td>
      <td>-0.0121</td>
      <td>-0.0083</td>
      <td>-0.0093</td>
      <td>-0.0109</td>
      <td>-0.0122</td>
      <td>...</td>
      <td>-0.0066</td>
      <td>-0.0088</td>
      <td>-0.0098</td>
      <td>-0.0055</td>
      <td>-0.0077</td>
      <td>-0.0078</td>
      <td>-0.0089</td>
      <td>-0.0057</td>
      <td>-0.0099</td>
      <td>-0.0061</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0010</td>
      <td>0.0002</td>
      <td>0.0004</td>
      <td>-0.0010</td>
      <td>0.0009</td>
      <td>0.0004</td>
      <td>0.0003</td>
      <td>0.0007</td>
      <td>-0.0004</td>
      <td>0.0002</td>
      <td>...</td>
      <td>0.0003</td>
      <td>0.0011</td>
      <td>0.0007</td>
      <td>0.0010</td>
      <td>0.0018</td>
      <td>0.0010</td>
      <td>0.0012</td>
      <td>0.0000</td>
      <td>-0.0002</td>
      <td>0.0005</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0135</td>
      <td>0.0080</td>
      <td>0.0114</td>
      <td>0.0143</td>
      <td>0.0116</td>
      <td>0.0134</td>
      <td>0.0091</td>
      <td>0.0112</td>
      <td>0.0100</td>
      <td>0.0138</td>
      <td>...</td>
      <td>0.0084</td>
      <td>0.0111</td>
      <td>0.0115</td>
      <td>0.0075</td>
      <td>0.0092</td>
      <td>0.0094</td>
      <td>0.0097</td>
      <td>0.0058</td>
      <td>0.0101</td>
      <td>0.0071</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1198</td>
      <td>0.1090</td>
      <td>0.2188</td>
      <td>0.2432</td>
      <td>0.1033</td>
      <td>0.2604</td>
      <td>0.1337</td>
      <td>0.2274</td>
      <td>0.1441</td>
      <td>0.2091</td>
      <td>...</td>
      <td>0.0837</td>
      <td>0.1422</td>
      <td>0.1553</td>
      <td>0.1201</td>
      <td>0.1329</td>
      <td>0.1280</td>
      <td>0.1384</td>
      <td>0.0721</td>
      <td>0.1260</td>
      <td>0.1171</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 30 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_dd_2</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_draw_down_max</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="p">,),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns_2</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_dd_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.14672468509782907
     jac: array([0.1248, 0.2206, 0.3222, 0.757 , 0.3871, 0.2441, 0.2924, 0.4504,
       0.3766, 0.7404, 0.3316, 0.247 , 0.2301, 0.2645, 0.2266, 0.1252,
       0.3681, 0.1685, 0.2405, 0.2484, 0.2348, 0.1306, 0.3488, 0.1296,
       0.3978, 0.2202, 0.1876, 0.171 , 0.22  , 0.1148])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 452
     nit: 14
    njev: 14
  status: 0
 success: True
       x: array([5.2593e-18, 1.4610e-02, 3.4999e-17, 1.3552e-17, 8.6975e-17,
       2.6923e-03, 2.9377e-18, 4.5178e-17, 2.6362e-18, 2.8238e-19,
       8.5599e-17, 3.8562e-19, 1.2979e-17, 9.1035e-18, 1.0157e-17,
       1.4280e-01, 6.8501e-17, 2.8469e-17, 2.7362e-17, 4.4210e-17,
       1.9194e-01, 1.3857e-01, 1.6587e-17, 3.3822e-17, 2.6444e-17,
       3.5995e-17, 0.0000e+00, 1.1371e-01, 1.0140e-16, 3.9568e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_dd_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1467
</pre></div>
</div>
</div>
</div>
<p>Again. it might be helpful to slightly change then minimum VaR portfolio weights to show that we minimized VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tweak</span><span class="p">(</span><span class="n">res_dd_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1535
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks">
<h5>Plot the (mean-variance) efficient frontier with all available data for the current the DJIA stocks<a class="headerlink" href="#plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>The range of target returns in <code class="docutils literal notranslate"><span class="pre">tret</span></code> span from the minimum to the maximum mean single-stock returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">tret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">_</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will loop over these target returns, finding the minimum variance portfolio for each target return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_vol</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ppy</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_ef</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tret</span><span class="p">:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">port_vol</span><span class="p">,</span> <span class="c1"># minimize portfolio volatility</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># initial portfolio weights</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span> <span class="c1"># additional arguments to fun, in order</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span> <span class="c1"># bounds limit the search space for each portfolio weight</span>
        <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># constrain sum of weights to one</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">port_mean</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="p">}</span> <span class="c1"># constrains portfolio mean return to the target return</span>

        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">res_ef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>List <code class="docutils literal notranslate"><span class="pre">res_ef</span></code> contains the results of all 25 minimum-variance portfolios.
For example, <code class="docutils literal notranslate"><span class="pre">res_ef[0]</span></code> is the minimum variance portfolio for the lowest target return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_ef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.39340634182496936
     jac: array([0.2109, 0.112 , 0.2034, 0.242 , 0.1532, 0.1866, 0.1751, 0.1646,
       0.1595, 0.1857, 0.186 , 0.1659, 0.1516, 0.1489, 0.3934, 0.0812,
       0.1762, 0.0979, 0.1063, 0.1259, 0.0721, 0.2056, 0.1586, 0.0962,
       0.1303, 0.1379, 0.163 , 0.0718, 0.1416, 0.0877])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 63
     nit: 2
    njev: 2
  status: 0
 success: True
       x: array([0.0000e+00, 6.5646e-12, 1.4979e-11, 0.0000e+00, 0.0000e+00,
       0.0000e+00, 0.0000e+00, 0.0000e+00, 8.6573e-12, 1.3497e-12,
       5.6112e-12, 6.4123e-12, 0.0000e+00, 1.3199e-11, 1.0000e+00,
       0.0000e+00, 0.0000e+00, 9.4935e-12, 0.0000e+00, 0.0000e+00,
       0.0000e+00, 0.0000e+00, 8.8827e-12, 0.0000e+00, 0.0000e+00,
       0.0000e+00, 2.4949e-12, 8.0527e-12, 2.2320e-12, 5.6294e-12])
</pre></div>
</div>
</div>
</div>
<p>I typically check that all portfolio volatility minimization succeeds.
If a portfolio volatility minimization fails, we should check our function, bounds, and constraints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_ef</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> 
</pre></div>
</div>
</div>
</div>
<p>We can combine the target returns and volatilities into a data frame <code class="docutils literal notranslate"><span class="pre">ef</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s1">&#39;tret&#39;</span><span class="p">:</span> <span class="n">tret</span><span class="p">,</span>
        <span class="s1">&#39;tvol&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_ef</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">ef</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tret</th>
      <th>tvol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.0814</td>
      <td>0.3934</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.0640</td>
      <td>0.2313</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.0466</td>
      <td>0.1906</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.0292</td>
      <td>0.1832</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.0117</td>
      <td>0.1773</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ef</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;tvol&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;tret&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;Efficient Frontier for Dow-Jones Industrial Average Stocks&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> 
    <span class="n">returns_2</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
    <span class="n">returns_2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">252</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e5867a76dfc7c654c2b4f0ef5f5c02b0270e4e589d65c147c4f33893740deef9.png" src="_images/e5867a76dfc7c654c2b4f0ef5f5c02b0270e4e589d65c147c4f33893740deef9.png" />
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks">
<h5>Find the maximum Sharpe Ratio portfolio with all available data for the current the DJIA stocks<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_6</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># want eq constraint to = 0</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_6</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.092759027029442
</pre></div>
</div>
</div>
</div>
</section>
<section id="compare-the-frac-1-n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks">
<h5>Compare the $\frac{1}{n}$ and maximum Sharpe Ratio portfolios with all available data for the current DJIA stocks<a class="headerlink" href="#compare-the-frac-1-n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>Use all but the last 252 trading days to estimate the maximum Sharpe Ratio portfolio weights.
Then use the last 252 trading days of data to compare the $\frac{1}{n}$  maximum Sharpe Ratio portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_x</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">252</span><span class="p">],</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># want eq constraint to = 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="k">assert</span> <span class="n">res_sharpe_x</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span>
<span class="c1"># res_sharpe_x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">res_sharpe_x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maximum Sharpe Ratio&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Equal Weight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Portfolio Weights for Dow-Jones Industrial Average Stocks&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b191669025532c59a146a0130d6d2041907f6e9199cd8d603be86812a5a44281.png" src="_images/b191669025532c59a146a0130d6d2041907f6e9199cd8d603be86812a5a44281.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">252</span><span class="p">],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.63277447434889
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">252</span><span class="p">],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8019384916171576
</pre></div>
</div>
</div>
</div>
<p>Out of sample:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">252</span><span class="p">:],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.7218303076039226
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">252</span><span class="p">:],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.2615614328449418
</pre></div>
</div>
</div>
</div>
<p>It is hard to beat the $\frac{1}{n}$ portfolio because mean returns (and covariances) are hard to predict!</p>
</section>
</section>
</section>
<span id="document-herron_04_practice_04"></span><section id="herron-topic-4-practice-wednesday-11-45-am-section-4">
<h3>Herron Topic 4 - Practice (Wednesday 11:45 AM, Section 4)<a class="headerlink" href="#herron-topic-4-practice-wednesday-11-45-am-section-4" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 6 this week</p>
<ul>
<li><p>I will post it at about 6 PM on Wednesday, 3/31</p></li>
<li><p>It will be due by 11:59 PM on Friday, 3/31</p></li>
</ul>
</li>
<li><p>Please complete the week ten survey</p>
<ul>
<li><p>I am considering dropping a topic to allow more in-class group work and easier access to me</p></li>
<li><p>I am also curious why the quantitative courses are less popular this summer</p></li>
<li><p>Please complete by 11:59 PM on Friday, 3/31</p></li>
<li><p><em><strong>The week ten survey is anonymous and voluntary</strong></em></p></li>
</ul>
</li>
<li><p>I will post project 2 as soon as I can</p></li>
<li><p>Assessment exam</p>
<ul>
<li><p>20 questions multiple on Canvas</p></li>
<li><p>You must be in the room</p></li>
<li><p>No specific studying, but I suggest putting core course resources on your laptop (e.g., notes and PowerPoints)</p></li>
</ul>
</li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sco</span>
</pre></div>
</div>
</div>
</div>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<p><em><strong>Note that <code class="docutils literal notranslate"><span class="pre">sco.minimize()</span></code> finds minimums, so we need to minimize the negative Sharpe Ratio.</strong></em></p>
<p>The following code downloads data for the MATANA stocks and assigns daily decimal returns from 2020 through 2022 to data frame <code class="docutils literal notranslate"><span class="pre">returns</span></code>.
We will stop in 2022 to make it easier to compare our results, whether we use the risk-free rate or value-weighted market portfolio as our benchmark or not.
Recall, the Fama and French benchmark factors are only available with a lag, and are only available through December 2022 as I type.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="s1">&#39;MSFT AAPL TSLA AMZN NVDA GOOG&#39;</span>

<span class="n">matana</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">matana</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span>
<span class="n">returns</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0011</td>
      <td>0.0002</td>
      <td>0.0006</td>
      <td>0.0008</td>
      <td>0.0018</td>
      <td>0.0030</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0233</td>
      <td>0.0246</td>
      <td>0.0217</td>
      <td>0.0219</td>
      <td>0.0352</td>
      <td>0.0455</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.1286</td>
      <td>-0.1405</td>
      <td>-0.1110</td>
      <td>-0.1474</td>
      <td>-0.1845</td>
      <td>-0.2106</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0110</td>
      <td>-0.0129</td>
      <td>-0.0097</td>
      <td>-0.0097</td>
      <td>-0.0177</td>
      <td>-0.0215</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0006</td>
      <td>0.0006</td>
      <td>0.0012</td>
      <td>0.0007</td>
      <td>0.0029</td>
      <td>0.0020</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0142</td>
      <td>0.0123</td>
      <td>0.0114</td>
      <td>0.0123</td>
      <td>0.0222</td>
      <td>0.0251</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1198</td>
      <td>0.1354</td>
      <td>0.0940</td>
      <td>0.1422</td>
      <td>0.1716</td>
      <td>0.1989</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    x: portfolio weights (must be first arg to use with sco.minimize())</span>
<span class="sd">    r: data frame of portfolio returns</span>
<span class="sd">    tgt: target or benchmark for Sharpe Ratio</span>
<span class="sd">    ppy: return periods per year</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">er</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_sharpe_neg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">ppy</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># eq constraints are driven to 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.0891990229341466
     jac: array([ 1.1644e-04,  3.6243e-01,  1.1961e-01,  6.4995e-02,  4.9078e-04,
       -2.5971e-04])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 63
     nit: 9
    njev: 9
  status: 0
 success: True
       x: array([6.6101e-02, 3.5779e-17, 4.3043e-17, 7.2642e-18, 3.1307e-01,
       6.2083e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0891990229341466
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but allow short weights up to 10% on each stock<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_2</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span> <span class="c1"># short up to 5 stocks 10%, then long the other stock 150%</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># eq constraints are driven to 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.1368990243538257
     jac: array([0.041 , 0.3444, 0.1157, 0.0727, 0.041 , 0.041 ])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 63
     nit: 9
    njev: 9
  status: 0
 success: True
       x: array([ 0.2997, -0.1   , -0.1   , -0.1   ,  0.3745,  0.6258])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Long Only&#39;</span><span class="p">:</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> 
            <span class="s1">&#39;Up to 10% Short per Stock&#39;</span><span class="p">:</span><span class="n">res_sharpe_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison Max. Sharpe Ratio Portfolio Weights&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/004163d333021c4843934510f0bca8e93ff174a2d8ca8aae95ac07868ddfaaea.png" src="_images/004163d333021c4843934510f0bca8e93ff174a2d8ca8aae95ac07868ddfaaea.png" />
</div>
</div>
<p>By relaxing the long-only constrain (via changes to <code class="docutils literal notranslate"><span class="pre">bounds=</span></code>), the weights on AMZN, GOOG, and MSFT go from zero to -10%.
Also, the Sharpe Ratio increases because we relax a binding constraint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0891990229341466
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1368990243538257
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but allow total short weights of up to 30%<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30" title="Permalink to this heading">#</a></h5>
<p>We can find the negative values in a NumPy array as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span>
<span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-3, -2, -1])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_3</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">1.3</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span> <span class="c1"># short up to 5 stocks 10%, then long the other stock 150%</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># eq constraints are driven to 0</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">}</span> <span class="c1"># ineq constraints must be non-negative</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.1826806520985051
     jac: array([0.0784, 0.3361, 0.152 , 0.1097, 0.0773, 0.0772])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 100
     nit: 10
    njev: 10
  status: 0
 success: True
       x: array([ 3.5706e-01, -3.0000e-01, -4.1390e-09,  1.8703e-05,  3.4943e-01,
        5.9349e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Long Only&#39;</span><span class="p">:</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> 
            <span class="s1">&#39;Up to 30% Short Total&#39;</span><span class="p">:</span><span class="n">res_sharpe_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison Max. Sharpe Ratio Portfolios&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9191ee6b277076599561ec2ccfc4e2c05a524e1504c24b98f5dfcbe9c357f2a1.png" src="_images/9191ee6b277076599561ec2ccfc4e2c05a524e1504c24b98f5dfcbe9c357f2a1.png" />
</div>
</div>
<p>Again, by relaxing the long-only constrain, the weights on AMZN, GOOG, and MSFT go from zero to -10%.
Also, the Sharpe Ratio increases because we relax a binding constraints.
The Sharpe Ratio is higher here than in the previous exercise, but this will not always be the case, since we relax different constraints here and in the previous exercise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0891990229341466
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1826806520985051
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but do not allow any weight to exceed 30% in magnitude<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_4</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># want eq constraint to = 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.0
     jac: array([0., 0., 0., 0., 0., 0.])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 7
     nit: 1
    njev: 1
  status: 0
 success: True
       x: array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the minimum 95% Value at Risk (Var) portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<p>More on VaR <a class="reference external" href="https://en.wikipedia.org/wiki/Value_at_risk">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_var_neg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">port_var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_var_1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_var_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_var_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.03592251751051852
     jac: array([0.0359, 0.0419, 0.037 , 0.0385, 0.0275, 0.0416])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 45
     nit: 5
    njev: 5
  status: 0
 success: True
       x: array([1.8180e-01, 1.4369e-01, 2.2517e-01, 2.4347e-01, 2.0587e-01,
       4.4129e-19])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_var_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.03592251751051852
</pre></div>
</div>
</div>
</div>
<p>It might be helpful to slightly change then minimum VaR portfolio weights to show that we minimized VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tweak</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tweak</span><span class="p">(</span><span class="n">res_var_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.036229497993286966
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the minimum maximum draw down portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">cum_max</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">draw_down</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_max</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span> <span class="o">/</span> <span class="n">cum_max</span>
    <span class="k">return</span> <span class="n">draw_down</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_dd_1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_draw_down_max</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_dd_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.2973740650996654
     jac: array([0.2865, 0.5131, 0.4028, 0.2927, 0.5359, 0.7698])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 164
     nit: 19
    njev: 19
  status: 0
 success: True
       x: array([6.8105e-01, 3.7577e-16, 1.3585e-16, 3.1895e-01, 7.7695e-16,
       7.2563e-16])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_dd_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.2974
</pre></div>
</div>
</div>
</div>
<p>Again. it might be helpful to slightly change then minimum VaR portfolio weights to show that we minimized VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tweak</span><span class="p">(</span><span class="n">res_dd_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3065
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks">
<h5>Find the minimum maximum draw down portfolio with all available data for the current Dow-Jones Industrial Average (DJIA) stocks<a class="headerlink" href="#find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>You can find the <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">DJIA tickers on Wikipedia</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="n">djia</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">returns_2</span> <span class="o">=</span> <span class="n">djia</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span>
<span class="n">returns_2</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMGN</th>
      <th>AXP</th>
      <th>BA</th>
      <th>CAT</th>
      <th>CRM</th>
      <th>CSCO</th>
      <th>CVX</th>
      <th>DIS</th>
      <th>DOW</th>
      <th>...</th>
      <th>MRK</th>
      <th>MSFT</th>
      <th>NKE</th>
      <th>PG</th>
      <th>TRV</th>
      <th>UNH</th>
      <th>V</th>
      <th>VZ</th>
      <th>WBA</th>
      <th>WMT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>...</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0011</td>
      <td>0.0004</td>
      <td>0.0007</td>
      <td>0.0000</td>
      <td>0.0010</td>
      <td>0.0001</td>
      <td>0.0003</td>
      <td>0.0011</td>
      <td>-0.0004</td>
      <td>0.0005</td>
      <td>...</td>
      <td>0.0006</td>
      <td>0.0008</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0007</td>
      <td>0.0011</td>
      <td>0.0004</td>
      <td>-0.0003</td>
      <td>-0.0002</td>
      <td>0.0004</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0233</td>
      <td>0.0176</td>
      <td>0.0286</td>
      <td>0.0383</td>
      <td>0.0224</td>
      <td>0.0278</td>
      <td>0.0199</td>
      <td>0.0268</td>
      <td>0.0241</td>
      <td>0.0272</td>
      <td>...</td>
      <td>0.0161</td>
      <td>0.0219</td>
      <td>0.0238</td>
      <td>0.0152</td>
      <td>0.0210</td>
      <td>0.0208</td>
      <td>0.0211</td>
      <td>0.0132</td>
      <td>0.0231</td>
      <td>0.0162</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.1286</td>
      <td>-0.0826</td>
      <td>-0.1482</td>
      <td>-0.2385</td>
      <td>-0.1428</td>
      <td>-0.1589</td>
      <td>-0.1373</td>
      <td>-0.2212</td>
      <td>-0.1316</td>
      <td>-0.2166</td>
      <td>...</td>
      <td>-0.0986</td>
      <td>-0.1474</td>
      <td>-0.1281</td>
      <td>-0.0874</td>
      <td>-0.2080</td>
      <td>-0.1728</td>
      <td>-0.1355</td>
      <td>-0.0674</td>
      <td>-0.1096</td>
      <td>-0.1138</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0110</td>
      <td>-0.0080</td>
      <td>-0.0130</td>
      <td>-0.0173</td>
      <td>-0.0106</td>
      <td>-0.0137</td>
      <td>-0.0085</td>
      <td>-0.0108</td>
      <td>-0.0123</td>
      <td>-0.0124</td>
      <td>...</td>
      <td>-0.0073</td>
      <td>-0.0097</td>
      <td>-0.0104</td>
      <td>-0.0060</td>
      <td>-0.0087</td>
      <td>-0.0080</td>
      <td>-0.0099</td>
      <td>-0.0061</td>
      <td>-0.0104</td>
      <td>-0.0067</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0006</td>
      <td>-0.0003</td>
      <td>0.0004</td>
      <td>-0.0014</td>
      <td>0.0010</td>
      <td>0.0005</td>
      <td>0.0000</td>
      <td>0.0008</td>
      <td>-0.0012</td>
      <td>-0.0002</td>
      <td>...</td>
      <td>0.0000</td>
      <td>0.0007</td>
      <td>0.0000</td>
      <td>0.0008</td>
      <td>0.0017</td>
      <td>0.0011</td>
      <td>0.0007</td>
      <td>-0.0002</td>
      <td>-0.0007</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0142</td>
      <td>0.0081</td>
      <td>0.0123</td>
      <td>0.0152</td>
      <td>0.0123</td>
      <td>0.0149</td>
      <td>0.0093</td>
      <td>0.0133</td>
      <td>0.0106</td>
      <td>0.0142</td>
      <td>...</td>
      <td>0.0084</td>
      <td>0.0123</td>
      <td>0.0123</td>
      <td>0.0075</td>
      <td>0.0101</td>
      <td>0.0095</td>
      <td>0.0106</td>
      <td>0.0054</td>
      <td>0.0107</td>
      <td>0.0077</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1198</td>
      <td>0.1090</td>
      <td>0.2188</td>
      <td>0.2432</td>
      <td>0.1033</td>
      <td>0.2604</td>
      <td>0.1337</td>
      <td>0.2274</td>
      <td>0.1441</td>
      <td>0.2091</td>
      <td>...</td>
      <td>0.0837</td>
      <td>0.1422</td>
      <td>0.1553</td>
      <td>0.1201</td>
      <td>0.1329</td>
      <td>0.1280</td>
      <td>0.1384</td>
      <td>0.0721</td>
      <td>0.1260</td>
      <td>0.1171</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 30 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_dd_2</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_draw_down_max</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="p">,),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns_2</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_dd_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.1452611244311275
     jac: array([0.1974, 0.064 , 0.2211, 0.2242, 0.1603, 0.0966, 0.162 , 0.1158,
       0.2333, 0.1664, 0.1609, 0.1217, 0.0695, 0.0094, 0.2134, 0.0657,
       0.1275, 0.0835, 0.0717, 0.1171, 0.0113, 0.1175, 0.1914, 0.1776,
       0.0756, 0.1588, 0.1089, 0.0882, 0.1333, 0.2522])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 879
     nit: 27
    njev: 27
  status: 0
 success: True
       x: array([7.4317e-17, 2.6652e-02, 4.9022e-17, 0.0000e+00, 8.4813e-17,
       4.0861e-17, 0.0000e+00, 4.8595e-19, 8.3224e-17, 4.6493e-20,
       2.0382e-17, 1.0975e-16, 7.4798e-20, 1.2327e-17, 3.6385e-17,
       1.3723e-01, 7.9003e-17, 2.1395e-19, 5.0830e-17, 0.0000e+00,
       1.9045e-01, 1.3055e-01, 2.6484e-17, 3.0680e-17, 3.8500e-17,
       3.7442e-19, 2.4126e-17, 1.2647e-01, 0.0000e+00, 3.8864e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_dd_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1453
</pre></div>
</div>
</div>
</div>
<p>Again. it might be helpful to slightly change then minimum VaR portfolio weights to show that we minimized VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tweak</span><span class="p">(</span><span class="n">res_dd_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1519
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks">
<h5>Plot the (mean-variance) efficient frontier with all available data for the current the DJIA stocks<a class="headerlink" href="#plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>The range of target returns in <code class="docutils literal notranslate"><span class="pre">tret</span></code> span from the minimum to the maximum mean single-stock returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">tret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">_</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will loop over these target returns, finding the minimum variance portfolio for each target return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_vol</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ppy</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_ef</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tret</span><span class="p">:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">port_vol</span><span class="p">,</span> <span class="c1"># minimize portfolio volatility</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># initial portfolio weights</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span> <span class="c1"># additional arguments to fun, in order</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span> <span class="c1"># bounds limit the search space for each portfolio weight</span>
        <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># constrain sum of weights to one</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">port_mean</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="p">}</span> <span class="c1"># constrains portfolio mean return to the target return</span>

        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">res_ef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>List <code class="docutils literal notranslate"><span class="pre">res_ef</span></code> contains the results of all 25 minimum-variance portfolios.
For example, <code class="docutils literal notranslate"><span class="pre">res_ef[0]</span></code> is the minimum variance portfolio for the lowest target return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_ef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.4206024526789833
     jac: array([0.226 , 0.1289, 0.2273, 0.2753, 0.1603, 0.2102, 0.1879, 0.1846,
       0.1792, 0.1971, 0.2016, 0.1831, 0.1662, 0.1612, 0.4206, 0.0915,
       0.1934, 0.1133, 0.122 , 0.1283, 0.0833, 0.2267, 0.1728, 0.1111,
       0.1504, 0.1597, 0.1808, 0.0838, 0.154 , 0.0955])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 93
     nit: 3
    njev: 3
  status: 0
 success: True
       x: array([1.7984e-15, 1.9459e-15, 0.0000e+00, 0.0000e+00, 3.1500e-15,
       0.0000e+00, 0.0000e+00, 9.2610e-16, 0.0000e+00, 0.0000e+00,
       6.8625e-16, 0.0000e+00, 0.0000e+00, 0.0000e+00, 1.0000e+00,
       0.0000e+00, 0.0000e+00, 0.0000e+00, 1.4480e-15, 0.0000e+00,
       0.0000e+00, 0.0000e+00, 1.0790e-15, 0.0000e+00, 1.1208e-15,
       0.0000e+00, 1.2956e-16, 5.8070e-16, 0.0000e+00, 0.0000e+00])
</pre></div>
</div>
</div>
</div>
<p>I typically check that all portfolio volatility minimization succeeds.
If a portfolio volatility minimization fails, we should check our function, bounds, and constraints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_ef</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> 
</pre></div>
</div>
</div>
</div>
<p>We can combine the target returns and volatilities into a data frame <code class="docutils literal notranslate"><span class="pre">ef</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s1">&#39;tret&#39;</span><span class="p">:</span> <span class="n">tret</span><span class="p">,</span>
        <span class="s1">&#39;tvol&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_ef</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">ef</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tret</th>
      <th>tvol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.1535</td>
      <td>0.4206</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.1358</td>
      <td>0.3435</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.1181</td>
      <td>0.2757</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.1004</td>
      <td>0.2253</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.0827</td>
      <td>0.2027</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ef</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;tvol&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;tret&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;Efficient Frontier for Dow-Jones Industrial Average Stocks&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> 
    <span class="n">returns_2</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
    <span class="n">returns_2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">252</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/43956a28cfa168eb1d249195f6a0fa16932abafc198ea4b80a17b3280a195942.png" src="_images/43956a28cfa168eb1d249195f6a0fa16932abafc198ea4b80a17b3280a195942.png" />
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks">
<h5>Find the maximum Sharpe Ratio portfolio with all available data for the current the DJIA stocks<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_6</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># want eq constraint to = 0</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_6</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.44191670887963796
</pre></div>
</div>
</div>
</div>
</section>
<section id="compare-the-frac-1-n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks">
<h5>Compare the $\frac{1}{n}$ and maximum Sharpe Ratio portfolios with all available data for the current DJIA stocks<a class="headerlink" href="#compare-the-frac-1-n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>Use all but the last 252 trading days to estimate the maximum Sharpe Ratio portfolio weights.
Then use the last 252 trading days of data to compare the $\frac{1}{n}$  maximum Sharpe Ratio portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_x</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2021&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns_2</span><span class="p">],</span> <span class="c1"># short up to 5 stocks 10%, then long the other stock 150%</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># eq constraints are driven to 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.45101908912907
     jac: array([-3.3379e-05,  7.1544e-01,  3.6336e-01,  1.5581e+00, -5.4866e-05,
        2.6187e-01,  3.1877e-01,  6.4522e-01,  6.0754e-01,  5.1480e-01,
        2.2540e-02, -2.8282e-05,  4.4621e-01,  4.4353e-01,  1.1298e+00,
        2.2024e-01,  4.9128e-01,  3.9944e-01,  2.4492e-01,  4.7485e-01,
        6.0061e-01,  3.6554e-04, -1.0265e-03,  1.1015e-01,  4.1630e-01,
        1.2803e-02,  6.8370e-01,  5.0606e-01,  5.0418e-01,  1.4875e-01])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 218
     nit: 7
    njev: 7
  status: 0
 success: True
       x: array([5.1283e-01, 0.0000e+00, 4.7142e-17, 7.0902e-16, 1.0012e-02,
       0.0000e+00, 1.5765e-16, 1.1636e-16, 0.0000e+00, 0.0000e+00,
       0.0000e+00, 2.5708e-01, 0.0000e+00, 0.0000e+00, 1.2567e-15,
       0.0000e+00, 0.0000e+00, 0.0000e+00, 0.0000e+00, 1.7025e-16,
       4.7163e-18, 1.7922e-01, 4.0854e-02, 0.0000e+00, 7.3800e-17,
       0.0000e+00, 3.5034e-16, 1.1696e-17, 2.2730e-16, 0.0000e+00])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">res_sharpe_x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maximum Sharpe Ratio&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Equal Weight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Portfolio Weights for Dow-Jones Industrial Average Stocks&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ed3faa8fc73c2e844f027f25089fe052145d884b806b964b4e67bef53f91593e.png" src="_images/ed3faa8fc73c2e844f027f25089fe052145d884b806b964b4e67bef53f91593e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2022&#39;</span><span class="p">],</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.753001293587445
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2022&#39;</span><span class="p">],</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.25436552600712903
</pre></div>
</div>
</div>
</div>
<p>It is hard to beat the $\frac{1}{n}$ portfolio because mean returns (and covariances) are hard to predict!</p>
<hr class="docutils" />
<p>What if we picked a different period?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns_3</span> <span class="o">=</span> <span class="n">djia</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2010&#39;</span><span class="p">:</span><span class="s1">&#39;2019&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_xp1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_3</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;2017&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns_3</span><span class="p">],</span> <span class="c1"># short up to 5 stocks 10%, then long the other stock 150%</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># eq constraints are driven to 0</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_xp1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.731278080433011
     jac: array([ 8.2898e-04,  1.7132e-01,  6.2183e-01,  6.6705e-04,  5.1273e-01,
        5.8156e-02,  7.1817e-01,  5.8716e-01,  2.4546e-01,  1.0825e+00,
       -6.6045e-04,  2.9742e-01,  7.8327e-01,  3.4385e-01,  1.2937e-02,
        6.9605e-01,  2.2715e-01, -5.5020e-04,  2.2086e-01,  4.1068e-01,
        2.3549e-01,  9.3803e-02,  1.7122e-01,  1.2081e-01,  9.5281e-04,
       -6.2662e-04, -7.7012e-04,  3.4866e-01,  5.7884e-02])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 273
     nit: 9
    njev: 9
  status: 0
 success: True
       x: array([1.1385e-01, 3.4971e-16, 5.0862e-16, 7.1293e-02, 0.0000e+00,
       1.4777e-18, 0.0000e+00, 3.7423e-17, 1.6828e-16, 3.6013e-16,
       3.1237e-01, 1.3929e-16, 0.0000e+00, 2.2603e-17, 1.0282e-16,
       2.0842e-16, 1.6927e-16, 2.0434e-01, 6.9230e-17, 3.2044e-17,
       8.4599e-17, 1.3271e-16, 5.6371e-17, 2.0042e-16, 2.3077e-01,
       5.2373e-02, 1.5005e-02, 5.5219e-17, 7.0648e-17])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">returns_3</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">res_sharpe_xp1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maximum Sharpe Ratio&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Equal Weight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Portfolio Weights for Dow-Jones Industrial Average Stocks&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from </span><span class="si">{</span><span class="n">returns_3</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns_3</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d1b7fb21fa5827c49ea187152662da7786148c1cccd535eb399fd6eda3421d9e.png" src="_images/d1b7fb21fa5827c49ea187152662da7786148c1cccd535eb399fd6eda3421d9e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_xp1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_3</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2018&#39;</span><span class="p">:</span><span class="s1">&#39;2019&#39;</span><span class="p">],</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0491764710165667
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">returns_3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_3</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2018&#39;</span><span class="p">:</span><span class="s1">&#39;2019&#39;</span><span class="p">],</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9908235050926001
</pre></div>
</div>
</div>
</div>
<p>It is hard to beat the $\frac{1}{n}$ portfolio!
The $\frac{1}{n}$ portfolio is hard to beat because return means and covariances are hard to predict!</p>
</section>
</section>
</section>
<span id="document-herron_04_practice_02"></span><section id="herron-topic-4-practice-wednesday-2-45-pm-section-2">
<h3>Herron Topic 4 - Practice (Wednesday 2:45 PM, Section 2)<a class="headerlink" href="#herron-topic-4-practice-wednesday-2-45-pm-section-2" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 6 this week</p>
<ul>
<li><p>I will post it at about 6 PM on Wednesday, 3/31</p></li>
<li><p>It will be due by 11:59 PM on Friday, 3/31</p></li>
</ul>
</li>
<li><p>Please complete the week ten survey</p>
<ul>
<li><p>I am considering dropping a topic to allow more in-class group work and easier access to me</p></li>
<li><p>I am also curious why the quantitative courses are less popular this summer</p></li>
<li><p>Please complete by 11:59 PM on Friday, 3/31</p></li>
<li><p><em><strong>The week ten survey is anonymous and voluntary</strong></em></p></li>
</ul>
</li>
<li><p>I will post project 2 as soon as I can</p></li>
<li><p>Assessment exam</p>
<ul>
<li><p>20 questions multiple on Canvas</p></li>
<li><p>You must be in the room</p></li>
<li><p>No specific studying, but I suggest putting core course resources on your laptop (e.g., notes and PowerPoints)</p></li>
</ul>
</li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sco</span>
</pre></div>
</div>
</div>
</div>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-calendar-years">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three calendar years<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-calendar-years" title="Permalink to this heading">#</a></h5>
<p><em><strong>Note that <code class="docutils literal notranslate"><span class="pre">sco.minimize()</span></code> finds minimums, so we need to minimize the negative Sharpe Ratio.</strong></em></p>
<p>The following code downloads data for the MATANA stocks and assigns daily decimal returns from 2020 through 2022 to data frame <code class="docutils literal notranslate"><span class="pre">returns</span></code>.
We will stop in 2022 to make it easier to compare our results, whether we use the risk-free rate or value-weighted market portfolio as our benchmark or not.
Recall, the Fama and French benchmark factors are only available with a lag, and are only available through December 2022 as I type.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="s1">&#39;MSFT AAPL TSLA AMZN NVDA GOOG&#39;</span>

<span class="n">matana</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">matana</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span>
<span class="n">returns</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>GOOG</th>
      <th>MSFT</th>
      <th>NVDA</th>
      <th>TSLA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0011</td>
      <td>0.0002</td>
      <td>0.0006</td>
      <td>0.0008</td>
      <td>0.0018</td>
      <td>0.0030</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0233</td>
      <td>0.0246</td>
      <td>0.0217</td>
      <td>0.0219</td>
      <td>0.0352</td>
      <td>0.0455</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.1286</td>
      <td>-0.1405</td>
      <td>-0.1110</td>
      <td>-0.1474</td>
      <td>-0.1845</td>
      <td>-0.2106</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0110</td>
      <td>-0.0129</td>
      <td>-0.0097</td>
      <td>-0.0097</td>
      <td>-0.0177</td>
      <td>-0.0215</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0006</td>
      <td>0.0006</td>
      <td>0.0012</td>
      <td>0.0007</td>
      <td>0.0029</td>
      <td>0.0020</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0142</td>
      <td>0.0123</td>
      <td>0.0114</td>
      <td>0.0123</td>
      <td>0.0222</td>
      <td>0.0251</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1198</td>
      <td>0.1354</td>
      <td>0.0940</td>
      <td>0.1422</td>
      <td>0.1716</td>
      <td>0.1989</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">er</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_sharpe_neg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">ppy</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_ew</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_ew</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">get_ew</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># eq constraint met when equal to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.0891990431411531
     jac: array([ 1.1602e-04,  3.6243e-01,  1.1961e-01,  6.4995e-02,  4.9046e-04,
       -2.5962e-04])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 63
     nit: 9
    njev: 9
  status: 0
 success: True
       x: array([6.6101e-02, 2.5912e-17, 0.0000e+00, 0.0000e+00, 3.1307e-01,
       6.2083e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0891990431411531
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but allow short weights up to 10% on each stock<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_2</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">get_ew</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># eq constraint met when equal to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.1368989996984662
     jac: array([0.041 , 0.3444, 0.1157, 0.0727, 0.041 , 0.041 ])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 63
     nit: 9
    njev: 9
  status: 0
 success: True
       x: array([ 0.2997, -0.1   , -0.1   , -0.1   ,  0.3745,  0.6258])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Long Only&#39;</span><span class="p">:</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> 
            <span class="s1">&#39;Up to 10% Short per Stock&#39;</span><span class="p">:</span><span class="n">res_sharpe_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison Max. Sharpe Ratio Portfolio Weights&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/004163d333021c4843934510f0bca8e93ff174a2d8ca8aae95ac07868ddfaaea.png" src="_images/004163d333021c4843934510f0bca8e93ff174a2d8ca8aae95ac07868ddfaaea.png" />
</div>
</div>
<p>By relaxing the long-only constrain (via changes to <code class="docutils literal notranslate"><span class="pre">bounds=</span></code>), the weights on AMZN, GOOG, and MSFT go from zero to -10%.
Also, the Sharpe Ratio increases because we relax a binding constraint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0891990431411531
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1368989996984662
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but allow total short weights of up to 30%<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30" title="Permalink to this heading">#</a></h5>
<p>We can find the negative values in a NumPy array as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span>
<span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-3, -2, -1])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_3</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">get_ew</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># eq constraint met when = 0</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">}</span> <span class="c1"># ineq constraint met when &gt;= 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.1826810753664976
     jac: array([0.0782, 0.336 , 0.152 , 0.1096, 0.0773, 0.0773])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 100
     nit: 10
    njev: 10
  status: 0
 success: True
       x: array([ 3.5667e-01, -3.0000e-01, -1.7501e-09,  1.7759e-05,  3.4960e-01,
        5.9371e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Long Only&#39;</span><span class="p">:</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> 
            <span class="s1">&#39;Up to 30% Short Total&#39;</span><span class="p">:</span><span class="n">res_sharpe_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison Max. Sharpe Ratio Portfolios&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9191ee6b277076599561ec2ccfc4e2c05a524e1504c24b98f5dfcbe9c357f2a1.png" src="_images/9191ee6b277076599561ec2ccfc4e2c05a524e1504c24b98f5dfcbe9c357f2a1.png" />
</div>
</div>
<p>Again, by relaxing the long-only constrain, the weights on AMZN, GOOG, and MSFT go from zero to -10%.
Also, the Sharpe Ratio increases because we relax a binding constraints.
The Sharpe Ratio is higher here than in the previous exercise, but this will not always be the case, since we relax different constraints here and in the previous exercise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0891990431411531
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_3</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1826810753664976
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude">
<h5>Find the maximum Sharpe Ratio portfolio of MATANA stocks over the last three years, but do not allow any weight to exceed 30% in magnitude<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_4</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># want eq constraint to = 0</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.0
     jac: array([0., 0., 0., 0., 0., 0.])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 7
     nit: 1
    njev: 1
  status: 0
 success: True
       x: array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the minimum 95% Value at Risk (Var) portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<p>More on VaR <a class="reference external" href="https://en.wikipedia.org/wiki/Value_at_risk">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_var_neg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">port_var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_var_1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_var_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_var_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.035922474334542105
     jac: array([0.0359, 0.0419, 0.037 , 0.0385, 0.0275, 0.0416])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 45
     nit: 5
    njev: 5
  status: 0
 success: True
       x: array([1.8180e-01, 1.4369e-01, 2.2517e-01, 2.4347e-01, 2.0587e-01,
       5.2421e-20])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_var_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.035922474334542105
</pre></div>
</div>
</div>
</div>
<p>It might be helpful to slightly change then minimum VaR portfolio weights to show that we minimized VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tweak</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_var</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tweak</span><span class="p">(</span><span class="n">res_var_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.036229546375465875
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years">
<h5>Find the minimum maximum draw down portfolio of MATANA stocks over the last three years<a class="headerlink" href="#find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">cum_max</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">draw_down</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_max</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span> <span class="o">/</span> <span class="n">cum_max</span>
    <span class="k">return</span> <span class="n">draw_down</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_dd_1</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_draw_down_max</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_dd_1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.2973734368777809
     jac: array([0.2865, 0.5131, 0.4028, 0.2927, 0.5359, 0.7698])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 178
     nit: 20
    njev: 20
  status: 0
 success: True
       x: array([6.8104e-01, 9.6518e-18, 2.2588e-17, 3.1896e-01, 1.2995e-17,
       3.4603e-18])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_dd_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.2974
</pre></div>
</div>
</div>
</div>
<p>Again. it might be helpful to slightly change then minimum VaR portfolio weights to show that we minimized VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tweak</span><span class="p">(</span><span class="n">res_dd_1</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">r</span><span class="o">=</span><span class="n">returns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3065
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks">
<h5>Find the minimum maximum draw down portfolio with all available data for the current Dow-Jones Industrial Average (DJIA) stocks<a class="headerlink" href="#find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>You can find the <a class="reference external" href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">DJIA tickers on Wikipedia</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wiki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average&#39;</span><span class="p">)</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="n">djia</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">returns_2</span> <span class="o">=</span> <span class="n">djia</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span>
<span class="n">returns_2</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>AAPL</th>
      <th>AMGN</th>
      <th>AXP</th>
      <th>BA</th>
      <th>CAT</th>
      <th>CRM</th>
      <th>CSCO</th>
      <th>CVX</th>
      <th>DIS</th>
      <th>DOW</th>
      <th>...</th>
      <th>MRK</th>
      <th>MSFT</th>
      <th>NKE</th>
      <th>PG</th>
      <th>TRV</th>
      <th>UNH</th>
      <th>V</th>
      <th>VZ</th>
      <th>WBA</th>
      <th>WMT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>...</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
      <td>756.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0011</td>
      <td>0.0004</td>
      <td>0.0007</td>
      <td>0.0000</td>
      <td>0.0010</td>
      <td>0.0001</td>
      <td>0.0003</td>
      <td>0.0011</td>
      <td>-0.0004</td>
      <td>0.0005</td>
      <td>...</td>
      <td>0.0006</td>
      <td>0.0008</td>
      <td>0.0005</td>
      <td>0.0005</td>
      <td>0.0007</td>
      <td>0.0011</td>
      <td>0.0004</td>
      <td>-0.0003</td>
      <td>-0.0002</td>
      <td>0.0004</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0233</td>
      <td>0.0176</td>
      <td>0.0286</td>
      <td>0.0383</td>
      <td>0.0224</td>
      <td>0.0278</td>
      <td>0.0199</td>
      <td>0.0268</td>
      <td>0.0241</td>
      <td>0.0272</td>
      <td>...</td>
      <td>0.0161</td>
      <td>0.0219</td>
      <td>0.0238</td>
      <td>0.0152</td>
      <td>0.0210</td>
      <td>0.0208</td>
      <td>0.0211</td>
      <td>0.0132</td>
      <td>0.0231</td>
      <td>0.0162</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.1286</td>
      <td>-0.0826</td>
      <td>-0.1482</td>
      <td>-0.2385</td>
      <td>-0.1428</td>
      <td>-0.1589</td>
      <td>-0.1373</td>
      <td>-0.2212</td>
      <td>-0.1316</td>
      <td>-0.2166</td>
      <td>...</td>
      <td>-0.0986</td>
      <td>-0.1474</td>
      <td>-0.1281</td>
      <td>-0.0874</td>
      <td>-0.2080</td>
      <td>-0.1728</td>
      <td>-0.1355</td>
      <td>-0.0674</td>
      <td>-0.1096</td>
      <td>-0.1138</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0110</td>
      <td>-0.0080</td>
      <td>-0.0130</td>
      <td>-0.0173</td>
      <td>-0.0106</td>
      <td>-0.0137</td>
      <td>-0.0085</td>
      <td>-0.0108</td>
      <td>-0.0123</td>
      <td>-0.0124</td>
      <td>...</td>
      <td>-0.0073</td>
      <td>-0.0097</td>
      <td>-0.0104</td>
      <td>-0.0060</td>
      <td>-0.0087</td>
      <td>-0.0080</td>
      <td>-0.0099</td>
      <td>-0.0061</td>
      <td>-0.0104</td>
      <td>-0.0067</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0006</td>
      <td>-0.0003</td>
      <td>0.0004</td>
      <td>-0.0014</td>
      <td>0.0010</td>
      <td>0.0005</td>
      <td>0.0000</td>
      <td>0.0008</td>
      <td>-0.0012</td>
      <td>-0.0002</td>
      <td>...</td>
      <td>0.0000</td>
      <td>0.0007</td>
      <td>0.0000</td>
      <td>0.0008</td>
      <td>0.0017</td>
      <td>0.0011</td>
      <td>0.0007</td>
      <td>-0.0002</td>
      <td>-0.0007</td>
      <td>0.0001</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0142</td>
      <td>0.0081</td>
      <td>0.0123</td>
      <td>0.0152</td>
      <td>0.0123</td>
      <td>0.0149</td>
      <td>0.0093</td>
      <td>0.0133</td>
      <td>0.0106</td>
      <td>0.0142</td>
      <td>...</td>
      <td>0.0084</td>
      <td>0.0123</td>
      <td>0.0123</td>
      <td>0.0075</td>
      <td>0.0101</td>
      <td>0.0095</td>
      <td>0.0106</td>
      <td>0.0054</td>
      <td>0.0107</td>
      <td>0.0077</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1198</td>
      <td>0.1090</td>
      <td>0.2188</td>
      <td>0.2432</td>
      <td>0.1033</td>
      <td>0.2604</td>
      <td>0.1337</td>
      <td>0.2274</td>
      <td>0.1441</td>
      <td>0.2091</td>
      <td>...</td>
      <td>0.0837</td>
      <td>0.1422</td>
      <td>0.1553</td>
      <td>0.1201</td>
      <td>0.1329</td>
      <td>0.1280</td>
      <td>0.1384</td>
      <td>0.0721</td>
      <td>0.1260</td>
      <td>0.1171</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 30 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_dd_2</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_draw_down_max</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="p">,),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">returns_2</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># minimize drives &quot;eq&quot; constraints to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_dd_2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.14526116917692314
     jac: array([0.1974, 0.064 , 0.2211, 0.2242, 0.1603, 0.0966, 0.162 , 0.1158,
       0.2333, 0.1664, 0.1609, 0.1217, 0.0695, 0.0094, 0.2134, 0.0657,
       0.1275, 0.0835, 0.0717, 0.1171, 0.0113, 0.1175, 0.1914, 0.1776,
       0.0756, 0.1588, 0.1089, 0.0882, 0.1333, 0.2522])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 879
     nit: 27
    njev: 27
  status: 0
 success: True
       x: array([8.5088e-17, 2.6650e-02, 0.0000e+00, 1.9963e-17, 4.8467e-17,
       4.6527e-18, 1.4882e-17, 5.6870e-17, 1.4465e-16, 1.0899e-16,
       1.6653e-18, 2.1579e-18, 4.2017e-17, 3.0508e-17, 7.0291e-17,
       1.3723e-01, 3.8140e-17, 3.8649e-17, 2.6616e-17, 4.6360e-17,
       1.9045e-01, 1.3055e-01, 7.8858e-17, 1.1369e-18, 2.2045e-18,
       2.0718e-17, 1.0429e-17, 1.2647e-01, 9.0356e-17, 3.8864e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_dd_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1453
</pre></div>
</div>
</div>
</div>
<p>Again. it might be helpful to slightly change then minimum VaR portfolio weights to show that we minimized VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_draw_down_max</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tweak</span><span class="p">(</span><span class="n">res_dd_2</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1519
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks">
<h5>Plot the (mean-variance) efficient frontier with all available data for the current the DJIA stocks<a class="headerlink" href="#plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>The range of target returns in <code class="docutils literal notranslate"><span class="pre">tret</span></code> span from the minimum to the maximum mean single-stock returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">tret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">_</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will loop over these target returns, finding the minimum variance portfolio for each target return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_vol</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">port_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ppy</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_ef</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tret</span><span class="p">:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">port_vol</span><span class="p">,</span> <span class="c1"># minimize portfolio volatility</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># initial portfolio weights</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span> <span class="c1"># additional arguments to fun, in order</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span> <span class="c1"># bounds limit the search space for each portfolio weight</span>
        <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># constrain sum of weights to one</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">port_mean</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="p">}</span> <span class="c1"># constrains portfolio mean return to the target return</span>

        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">res_ef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>List <code class="docutils literal notranslate"><span class="pre">res_ef</span></code> contains the results of all 25 minimum-variance portfolios.
For example, <code class="docutils literal notranslate"><span class="pre">res_ef[0]</span></code> is the minimum variance portfolio for the lowest target return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_ef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: 0.42060231866698816
     jac: array([0.226 , 0.1289, 0.2273, 0.2753, 0.1603, 0.2102, 0.1879, 0.1846,
       0.1792, 0.1971, 0.2016, 0.1831, 0.1662, 0.1612, 0.4206, 0.0915,
       0.1934, 0.1133, 0.122 , 0.1283, 0.0833, 0.2267, 0.1728, 0.1111,
       0.1504, 0.1597, 0.1808, 0.0838, 0.154 , 0.0955])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 62
     nit: 2
    njev: 2
  status: 0
 success: True
       x: array([0.0000e+00, 2.3870e-15, 4.9336e-15, 1.2490e-16, 5.4123e-16,
       9.8532e-16, 0.0000e+00, 0.0000e+00, 1.2915e-07, 0.0000e+00,
       0.0000e+00, 2.1858e-15, 0.0000e+00, 0.0000e+00, 1.0000e+00,
       0.0000e+00, 0.0000e+00, 1.2282e-15, 7.4246e-16, 2.4980e-15,
       1.0408e-15, 0.0000e+00, 2.2204e-16, 3.0531e-16, 1.2906e-15,
       0.0000e+00, 0.0000e+00, 2.4980e-16, 0.0000e+00, 0.0000e+00])
</pre></div>
</div>
</div>
</div>
<p>I typically check that all portfolio volatility minimization succeeds.
If a portfolio volatility minimization fails, we should check our function, bounds, and constraints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_ef</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> 
</pre></div>
</div>
</div>
</div>
<p>We can combine the target returns and volatilities into a data frame <code class="docutils literal notranslate"><span class="pre">ef</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s1">&#39;tret&#39;</span><span class="p">:</span> <span class="n">tret</span><span class="p">,</span>
        <span class="s1">&#39;tvol&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_ef</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">ef</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tret</th>
      <th>tvol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.1535</td>
      <td>0.4206</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.1358</td>
      <td>0.3435</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.1181</td>
      <td>0.2757</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.1004</td>
      <td>0.2253</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.0827</td>
      <td>0.2027</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ef</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;tvol&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;tret&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Mean Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;Efficient Frontier for Dow-Jones Industrial Average Stocks&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%B %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> 
    <span class="n">returns_2</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
    <span class="n">returns_2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">252</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2fa0e7ee8aaa8a5c63c9b4d6ad2f9c62b0e8921eb649922944b307b8f6be9fc0.png" src="_images/2fa0e7ee8aaa8a5c63c9b4d6ad2f9c62b0e8921eb649922944b307b8f6be9fc0.png" />
</div>
</div>
</section>
<section id="find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks">
<h5>Find the maximum Sharpe Ratio portfolio with all available data for the current the DJIA stocks<a class="headerlink" href="#find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_6</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># want eq constraint to = 0</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res_sharpe_6</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">returns_2</span><span class="p">,</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4419167465321825
</pre></div>
</div>
</div>
</div>
</section>
<section id="compare-the-frac-1-n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks">
<h5>Compare the $\frac{1}{n}$ and maximum Sharpe Ratio portfolios with all available data for the current DJIA stocks<a class="headerlink" href="#compare-the-frac-1-n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks" title="Permalink to this heading">#</a></h5>
<p>Use all but the last 252 trading days to estimate the maximum Sharpe Ratio portfolio weights.
Then use the last 252 trading days of data to compare the $\frac{1}{n}$  maximum Sharpe Ratio portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_sharpe_x</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">port_sharpe_neg</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">get_ew</span><span class="p">(</span><span class="n">returns_2</span><span class="p">),</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:</span><span class="s1">&#39;2021&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">returns_2</span><span class="p">],</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># eq constraint met when equal to zero</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">res_sharpe_x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     fun: -1.451019869956015
     jac: array([-3.3244e-05,  7.1544e-01,  3.6336e-01,  1.5581e+00, -5.4896e-05,
        2.6187e-01,  3.1877e-01,  6.4522e-01,  6.0754e-01,  5.1480e-01,
        2.2540e-02, -2.8297e-05,  4.4621e-01,  4.4353e-01,  1.1298e+00,
        2.2024e-01,  4.9128e-01,  3.9944e-01,  2.4492e-01,  4.7485e-01,
        6.0061e-01,  3.6570e-04, -1.0264e-03,  1.1015e-01,  4.1630e-01,
        1.2804e-02,  6.8370e-01,  5.0606e-01,  5.0418e-01,  1.4876e-01])
 message: &#39;Optimization terminated successfully&#39;
    nfev: 218
     nit: 7
    njev: 7
  status: 0
 success: True
       x: array([5.1283e-01, 7.3929e-17, 0.0000e+00, 0.0000e+00, 1.0011e-02,
       6.1795e-16, 1.2347e-15, 0.0000e+00, 0.0000e+00, 4.7353e-16,
       3.4684e-16, 2.5709e-01, 0.0000e+00, 4.1536e-16, 0.0000e+00,
       5.3411e-17, 2.8629e-16, 6.5371e-17, 8.9074e-17, 2.4575e-16,
       8.2074e-17, 1.7922e-01, 4.0854e-02, 3.3561e-16, 2.8254e-16,
       3.0830e-16, 0.0000e+00, 0.0000e+00, 0.0000e+00, 0.0000e+00])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">returns_2</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">res_sharpe_x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maximum Sharpe Ratio&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Equal Weight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Weight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Portfolio Weights for Dow-Jones Industrial Average Stocks&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">from </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">returns_2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%b %d, %Y</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ed3faa8fc73c2e844f027f25089fe052145d884b806b964b4e67bef53f91593e.png" src="_images/ed3faa8fc73c2e844f027f25089fe052145d884b806b964b4e67bef53f91593e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">res_sharpe_x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2022&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.7530020412398378
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_sharpe</span><span class="p">(</span><span class="n">get_ew</span><span class="p">(</span><span class="n">returns_2</span><span class="p">),</span> <span class="n">returns_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2022&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">252</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.25436549146826076
</pre></div>
</div>
</div>
</div>
<p>It is hard to beat the $\frac{1}{n}$ portfolio because mean returns (and covariances) are hard to predict!</p>
<hr class="docutils" />
<p>Side discussion on the <code class="docutils literal notranslate"><span class="pre">.dot()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="n">get_ew</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">weights</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">transpose</span><span class="p">()),</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">returns</span> <span class="o">@</span> <span class="n">weights</span><span class="p">,</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">weights</span> <span class="o">@</span> <span class="n">returns</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span>
    <span class="n">returns</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-herron_05_lecture"></span><section id="herron-topic-5-simulations">
<h2>Herron Topic 5 - Simulations<a class="headerlink" href="#herron-topic-5-simulations" title="Permalink to this heading">#</a></h2>
<p>In finance, we typically perform simulations with <a class="reference external" href="https://en.wikipedia.org/wiki/Monte_Carlo_method">Monte Carlo methods</a>.
Monte Carlo methods are used throughout science, engineering, and mathematics, and they are especially useful in finance due to the randomness of asset prices.
This lecture notebook provides an introduction to <a class="reference external" href="https://en.wikipedia.org/wiki/Monte_Carlo_methods_in_finance">Monte Carlo methods in finance</a>.</p>
<p>The basic idea behind Monte Carlo methods in finance is to create many possible paths of financial variables (e.g., stock prices, interest rates, exchange rates) based on their historical behavior, statistical properties, and any other relevant factors.
We use these paths to simulate the performance of financial instruments or portfolios, and then we aggregate these results to estimate metrics of interest.
This approach helps us model and analyze complex financial problems that may be difficult or impossible to solve analytically.</p>
<p>We could spend a semester (or more) on simulations and Monte Carlo methods.
In this lecture notebook, we will limit our focus to:</p>
<ol class="arabic simple">
<li><p>Option pricing: Monte Carlo methods can be used to estimate the fair value of financial derivatives, such as options and warrants. By simulating the potential future paths of the underlying asset and calculating the payoffs of the derivative at each path, the expected payoff can be computed and discounted to present value to determine the option’s price.</p></li>
<li><p>Value at Risk (VaR): Monte Carlo simulations can be used to compute VaR, a widely used risk management metric that estimates the potential loss in the value of a portfolio over a specific time horizon, given a certain level of confidence (e.g., 95% or 99%). By simulating numerous scenarios and observing the distribution of potential losses, the VaR can be calculated as the threshold below which a certain percentage of losses fall.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 2
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="option-pricing">
<h3>Option Pricing<a class="headerlink" href="#option-pricing" title="Permalink to this heading">#</a></h3>
<p>We can use Monte Carlo methods to value stock options.
First, we simulate several hundred or thousand possible (but random) price paths for the underlying stock.
Then, we calculate the payoff for each path.
On some paths, the option will expire “in the money” with $S_T &gt; K$ and pay $S_T - K$.
On other paths, the option will expire “out of the money” with $S_T &lt; K$ and pay 0.
We average these payoffs and discount them to today.
The present value of these payoffs is the option price.
This is an illustrative example, and there is a lot of depth to <a class="reference external" href="https://en.wikipedia.org/wiki/Monte_Carlo_methods_for_option_pricing">Monte Carlo methods for option pricing</a>.</p>
<section id="simulating-stock-prices">
<h4>Simulating Stock Prices<a class="headerlink" href="#simulating-stock-prices" title="Permalink to this heading">#</a></h4>
<p>We can simulate stock prices with the following stochastic differential equation (SDE) for Geometric Brownian Motion (GBM): $dS = \mu S dt + \sigma S dW_t$.
GBM does not account for mean-reversion and time-dependent volatility.
So GBM is often used for stocks and not for bond prices, which tend to display long-term reversion to the face value.
In the GBM SDE:</p>
<ol class="arabic simple">
<li><p>$S$ is the stock price</p></li>
<li><p>$\mu$ is the drift coefficient (i.e., instantaneous expected return)</p></li>
<li><p>$\sigma$ is the diffusion coefficient (i.e., volatility of the drift)</p></li>
<li><p>$W_t$ is the Wiener Process or Brownian Motion</p></li>
</ol>
<p>The GBM SDE has a closed-form solution: $S(t) = S_0 \exp\left(\left(\mu - \frac{1}{2}\sigma^2\right)t + \sigma W_t\right)$.
We can apply this closed form solution recursively: $S(t_{i+1}) = S(t_i) \exp\left(\left(\mu - \frac{1}{2}\sigma^2\right)(t_{i+1} - t_i) + \sigma \sqrt{t_{i+1} - t_i} Z_{i+1}\right)$.
Here, $Z_i$ is a Standard Normal random variable ($dW_t$ are independent and normally distributed) and $i = 0, \ldots, T-1$ is the time index.</p>
<p>We can use this closed form solution to simulate stock prices for AAPL.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aapl</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">Return</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aapl</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
      <th>Return</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>10674.00</td>
      <td>10674.00</td>
      <td>10674.00</td>
      <td>10674.00</td>
      <td>10674.00</td>
      <td>10674.00</td>
      <td>10673.00</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>17.35</td>
      <td>17.55</td>
      <td>17.16</td>
      <td>17.36</td>
      <td>16.67</td>
      <td>325931256.70</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>std</th>
      <td>36.64</td>
      <td>37.09</td>
      <td>36.22</td>
      <td>36.68</td>
      <td>36.33</td>
      <td>337395659.86</td>
      <td>0.03</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.05</td>
      <td>0.05</td>
      <td>0.05</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>0.00</td>
      <td>-0.52</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.29</td>
      <td>0.30</td>
      <td>0.28</td>
      <td>0.29</td>
      <td>0.24</td>
      <td>119995300.00</td>
      <td>-0.01</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.49</td>
      <td>0.50</td>
      <td>0.48</td>
      <td>0.49</td>
      <td>0.41</td>
      <td>213094000.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>16.90</td>
      <td>17.10</td>
      <td>16.72</td>
      <td>16.94</td>
      <td>14.73</td>
      <td>405541500.00</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>max</th>
      <td>182.63</td>
      <td>182.94</td>
      <td>179.12</td>
      <td>182.01</td>
      <td>180.68</td>
      <td>7421640800.00</td>
      <td>0.33</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We will use returns from 2021 to predict prices in 2022.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">aapl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2021&#39;</span><span class="p">]</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">aapl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We will use the following function to simulate price paths.
Throughout this lecture notebook, we will use one-trading-day steps (i.e., <code class="docutils literal notranslate"><span class="pre">dt=1</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_gbm</span><span class="p">(</span><span class="n">S_0</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to simulate stock prices following Geometric Brownian Motion (GBM).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    S_0 : float</span>
<span class="sd">        Initial stock price</span>
<span class="sd">    mu : float</span>
<span class="sd">        Drift coefficient</span>
<span class="sd">    sigma : float</span>
<span class="sd">        Diffusion coefficient</span>
<span class="sd">    n_steps : int</span>
<span class="sd">        Length of the forecast horizon in time increments, so T = n_steps * dt</span>
<span class="sd">    dt : int</span>
<span class="sd">        Time increment, typically one day</span>
<span class="sd">    seed : int</span>
<span class="sd">        Random seed for reproducibility</span>

<span class="sd">    Returns</span>
<span class="sd">    -----------</span>
<span class="sd">    S_t : np.ndarray</span>
<span class="sd">        Array (length: n_steps + 1) of simulated prices</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">dW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">n_steps</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">dW</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
    
    <span class="n">S_t</span> <span class="o">=</span> <span class="n">S_0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">mu</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span>
    <span class="n">S_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">S_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">S_0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">S_t</span>
</pre></div>
</div>
</div>
</div>
<p>Now we will simulate price paths.
Here is one simulated price path:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulate_gbm</span><span class="p">(</span>
    <span class="n">S_0</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">mu</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
    <span class="n">sigma</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
    <span class="n">n_steps</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([176.28, 177.85, 177.65, 179.67, 184.24, 183.76, 183.27, 188.1 ,
       190.6 , 189.39, 191.22, 190.03, 188.83, 189.76, 184.3 , 179.53,
       178.13, 175.49, 176.55, 174.21, 170.55, 174.73, 174.29, 174.66,
       170.95, 169.67, 170.14, 167.25, 168.43, 167.01, 166.42, 165.02,
       170.1 , 170.24, 167.6 , 169.97, 166.9 , 167.63, 162.68, 159.47,
       160.14, 162.19, 162.8 , 162.68, 162.07, 158.5 , 156.87, 155.9 ,
       158.69, 159.72, 155.5 , 156.46, 155.68, 154.18, 155.85, 158.57,
       161.09, 159.14, 158.53, 159.53, 162.18, 161.13, 160.83, 158.2 ,
       155.41, 157.58, 161.16, 161.15, 163.9 , 165.01, 163.51, 164.62,
       168.85, 168.94, 173.35, 166.49, 168.85, 169.26, 168.64, 169.06,
       164.01, 163.61, 164.71, 168.78, 167.58, 165.63, 164.49, 167.07,
       168.11, 166.89, 168.43, 168.86, 171.65, 169.93, 169.23, 168.37,
       164.69, 165.64, 166.5 , 166.69, 166.25, 162.74, 161.83, 161.13,
       159.27, 159.03, 160.22, 165.24, 165.87, 166.72, 166.7 , 161.89,
       162.  , 162.32, 168.94, 168.61, 169.59, 169.68, 166.75, 169.97,
       172.18, 174.53, 172.22, 176.27, 172.59, 174.38, 180.72, 178.1 ,
       176.7 , 177.16, 175.94, 171.87, 172.23, 169.54, 171.  , 168.71,
       173.08, 171.13, 170.44, 172.83, 169.68, 170.47, 174.21, 170.02,
       170.7 , 171.58, 173.9 , 170.71, 167.36, 168.92, 169.9 , 170.75,
       171.87, 170.21, 171.02, 172.  , 170.24, 175.52, 177.03, 173.91,
       175.91, 173.41, 175.76, 179.2 , 177.08, 179.98, 181.35, 183.92,
       189.72, 189.18, 187.14, 184.72, 182.55, 182.52, 183.7 , 184.7 ,
       187.33, 187.56, 192.12, 191.52, 200.15, 202.35, 199.84, 196.69,
       198.41, 197.92, 200.38, 202.09, 202.07, 199.6 , 195.08, 193.91,
       196.76, 197.64, 193.99, 194.73, 196.12, 193.61, 194.28, 194.67,
       191.38, 192.67, 194.59, 198.16, 201.7 , 197.57, 194.87, 196.67,
       198.48, 200.31, 213.12, 215.28, 219.41, 222.97, 225.52, 224.64,
       227.59, 225.06, 224.46, 222.98, 223.5 , 232.08, 225.56, 228.26,
       222.75, 221.33, 225.41, 225.88, 222.3 , 220.03, 222.64, 220.32,
       221.31, 221.7 , 219.66, 227.47, 230.01, 223.  , 223.89, 221.8 ,
       225.04, 222.48, 222.31, 224.32, 227.66, 223.61, 222.67, 221.24,
       219.2 , 225.64, 227.33, 223.07])
</pre></div>
</div>
</div>
</div>
<p>We will combine <code class="docutils literal notranslate"><span class="pre">simulate_gbm()</span></code> with a list comprehension and <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code> to simulate many price paths.
To simplify this combination, we will write a helper function <code class="docutils literal notranslate"><span class="pre">simulate_gbm_series()</span></code> that:</p>
<ol class="arabic simple">
<li><p>Returns a series</p></li>
<li><p>Helps us vary the <code class="docutils literal notranslate"><span class="pre">seed</span></code> argument</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_gbm_series</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">):</span>
    <span class="n">S_t</span> <span class="o">=</span> <span class="n">simulate_gbm</span><span class="p">(</span>
        <span class="n">S_0</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">mu</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">S_t</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">S_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">simulate_gbm_series</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span> <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)],</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">keys</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Simulation&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">S_t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Simulation</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>90</th>
      <th>91</th>
      <th>92</th>
      <th>93</th>
      <th>94</th>
      <th>95</th>
      <th>96</th>
      <th>97</th>
      <th>98</th>
      <th>99</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-12-31</th>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>...</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
    </tr>
    <tr>
      <th>2022-01-03</th>
      <td>181.45</td>
      <td>181.05</td>
      <td>175.30</td>
      <td>181.52</td>
      <td>176.60</td>
      <td>177.70</td>
      <td>175.59</td>
      <td>181.24</td>
      <td>176.72</td>
      <td>176.47</td>
      <td>...</td>
      <td>175.84</td>
      <td>174.78</td>
      <td>177.11</td>
      <td>181.07</td>
      <td>178.55</td>
      <td>174.62</td>
      <td>176.66</td>
      <td>171.64</td>
      <td>177.79</td>
      <td>176.07</td>
    </tr>
    <tr>
      <th>2022-01-04</th>
      <td>182.80</td>
      <td>179.50</td>
      <td>175.33</td>
      <td>182.97</td>
      <td>178.19</td>
      <td>176.96</td>
      <td>177.82</td>
      <td>180.10</td>
      <td>179.98</td>
      <td>175.85</td>
      <td>...</td>
      <td>175.39</td>
      <td>172.06</td>
      <td>178.16</td>
      <td>184.44</td>
      <td>183.09</td>
      <td>173.20</td>
      <td>176.71</td>
      <td>170.66</td>
      <td>182.64</td>
      <td>182.08</td>
    </tr>
    <tr>
      <th>2022-01-05</th>
      <td>185.84</td>
      <td>178.19</td>
      <td>169.69</td>
      <td>183.45</td>
      <td>175.59</td>
      <td>184.08</td>
      <td>178.62</td>
      <td>180.39</td>
      <td>174.71</td>
      <td>172.95</td>
      <td>...</td>
      <td>173.94</td>
      <td>170.75</td>
      <td>176.28</td>
      <td>190.75</td>
      <td>181.24</td>
      <td>174.32</td>
      <td>175.06</td>
      <td>168.84</td>
      <td>185.75</td>
      <td>183.09</td>
    </tr>
    <tr>
      <th>2022-01-06</th>
      <td>192.75</td>
      <td>175.38</td>
      <td>174.33</td>
      <td>178.31</td>
      <td>177.72</td>
      <td>183.54</td>
      <td>176.28</td>
      <td>181.74</td>
      <td>171.11</td>
      <td>173.10</td>
      <td>...</td>
      <td>171.94</td>
      <td>170.18</td>
      <td>169.30</td>
      <td>192.36</td>
      <td>186.53</td>
      <td>176.16</td>
      <td>176.24</td>
      <td>171.73</td>
      <td>183.87</td>
      <td>187.17</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-12-23</th>
      <td>264.37</td>
      <td>309.02</td>
      <td>209.29</td>
      <td>243.87</td>
      <td>280.98</td>
      <td>228.05</td>
      <td>238.47</td>
      <td>208.71</td>
      <td>217.12</td>
      <td>253.82</td>
      <td>...</td>
      <td>239.90</td>
      <td>350.58</td>
      <td>237.84</td>
      <td>239.82</td>
      <td>211.79</td>
      <td>240.60</td>
      <td>222.35</td>
      <td>183.09</td>
      <td>213.59</td>
      <td>252.19</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>269.20</td>
      <td>307.19</td>
      <td>210.77</td>
      <td>252.25</td>
      <td>279.95</td>
      <td>227.38</td>
      <td>235.26</td>
      <td>207.00</td>
      <td>213.48</td>
      <td>260.27</td>
      <td>...</td>
      <td>233.63</td>
      <td>350.19</td>
      <td>239.30</td>
      <td>241.52</td>
      <td>213.10</td>
      <td>241.15</td>
      <td>226.32</td>
      <td>184.40</td>
      <td>213.79</td>
      <td>251.71</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>266.04</td>
      <td>316.44</td>
      <td>212.71</td>
      <td>256.82</td>
      <td>276.97</td>
      <td>225.13</td>
      <td>239.62</td>
      <td>206.86</td>
      <td>212.20</td>
      <td>256.62</td>
      <td>...</td>
      <td>237.98</td>
      <td>348.81</td>
      <td>243.23</td>
      <td>238.31</td>
      <td>212.25</td>
      <td>233.59</td>
      <td>236.23</td>
      <td>186.87</td>
      <td>211.93</td>
      <td>249.90</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>260.22</td>
      <td>310.31</td>
      <td>211.81</td>
      <td>257.77</td>
      <td>275.77</td>
      <td>226.87</td>
      <td>239.04</td>
      <td>202.55</td>
      <td>212.04</td>
      <td>259.85</td>
      <td>...</td>
      <td>242.62</td>
      <td>363.57</td>
      <td>240.01</td>
      <td>239.94</td>
      <td>211.93</td>
      <td>229.14</td>
      <td>238.43</td>
      <td>180.97</td>
      <td>208.95</td>
      <td>251.67</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>262.65</td>
      <td>308.94</td>
      <td>211.09</td>
      <td>265.15</td>
      <td>276.65</td>
      <td>226.59</td>
      <td>243.48</td>
      <td>202.23</td>
      <td>214.07</td>
      <td>262.42</td>
      <td>...</td>
      <td>237.68</td>
      <td>372.17</td>
      <td>242.60</td>
      <td>239.73</td>
      <td>205.42</td>
      <td>229.94</td>
      <td>237.87</td>
      <td>183.23</td>
      <td>213.77</td>
      <td>249.60</td>
    </tr>
  </tbody>
</table>
<p>252 rows × 100 columns</p>
</div></div></div>
</div>
<p>Below, we prefix the simulated price path column names with <code class="docutils literal notranslate"><span class="pre">_</span></code> to hide them from the legend.
However, this feature triggers a warning <em>100 times</em>!
We will suppress these 100 warnings with the warnings package.
Generally, we should avoid suppressing warnings, however it is the easiest option here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="n">S_t</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">S_t</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">aapl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">S_t</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Price ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Apple Simulated and Observed Prices&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Trained from </span><span class="si">{</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y-%m-%d</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y-%m-%d</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/72b966d79a0e359e38ea7033254ccf1979dd347e703223a9ed6c6ddf877bdd54.png" src="_images/72b966d79a0e359e38ea7033254ccf1979dd347e703223a9ed6c6ddf877bdd54.png" />
</div>
</div>
</section>
<section id="pricing-options">
<h4>Pricing Options<a class="headerlink" href="#pricing-options" title="Permalink to this heading">#</a></h4>
<p>We can use simulated price paths to price options!
We will use the Black and Scholes (1973) formula as a benchmark.
Black and Scholes (1973) provide a closed form (analytic) solution to price European options.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">price_bs</span><span class="p">(</span><span class="n">S_0</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;call&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function used for calculating the price of European options using the analytical form of the Black-Scholes model.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    S_0 : float</span>
<span class="sd">        Initial stock price</span>
<span class="sd">    K : float</span>
<span class="sd">        Strike price</span>
<span class="sd">    T : float</span>
<span class="sd">        Time to expiration in days</span>
<span class="sd">    r : float</span>
<span class="sd">        Daily risk-free rate</span>
<span class="sd">    sigma : float</span>
<span class="sd">        Standard deviation of daily stock returns</span>
<span class="sd">    type : str</span>
<span class="sd">        Type of the option. Allowable: [&#39;call&#39;, &#39;put&#39;]</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -----------</span>
<span class="sd">    option_premium : float</span>
<span class="sd">        The premium on the option calculated using the Black-Scholes model</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S_0</span> <span class="o">/</span> <span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">S_0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;put&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">S_0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Wrong input for type!&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">val</span>
</pre></div>
</div>
</div>
</div>
<p>We can use the AAPL parameters above to price a European call option on AAPL stock.
We will calculate its price at the end of 2021 with an expiration at the end of 2022, assuming a 5% risk-free rate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">S_0</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">/</span><span class="mi">252</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">S_0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>176.27622985839844
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">price_bs</span><span class="p">(</span>
    <span class="n">S_0</span><span class="o">=</span><span class="n">S_0</span><span class="p">,</span>
    <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">,</span>
    <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
    <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
    <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Black and Scholes (1973) option price: </span><span class="si">{</span><span class="n">_</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Black and Scholes (1973) option price: 81.21
</pre></div>
</div>
</div>
</div>
<p>To simulate the Black and Scholes (1973) option price, we must simulate AAPL prices with the same 5% risk-free rate as the drift.
We will write a new helper function to use the same inputs as above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_gbm_series</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">S_0</span><span class="o">=</span><span class="n">S_0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">):</span>
    <span class="n">S_t</span> <span class="o">=</span> <span class="n">simulate_gbm</span><span class="p">(</span>
        <span class="n">S_0</span><span class="o">=</span><span class="n">S_0</span><span class="p">,</span>
        <span class="n">mu</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">S_t</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<p>We will simulate more price paths to increase the precision of out option price.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">10_000</span>

<span class="n">S_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">simulate_gbm_series</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span> <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)],</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">keys</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Simulation&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">S_t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Simulation</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>9990</th>
      <th>9991</th>
      <th>9992</th>
      <th>9993</th>
      <th>9994</th>
      <th>9995</th>
      <th>9996</th>
      <th>9997</th>
      <th>9998</th>
      <th>9999</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-12-31</th>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>...</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
      <td>176.28</td>
    </tr>
    <tr>
      <th>2022-01-03</th>
      <td>181.27</td>
      <td>180.87</td>
      <td>175.13</td>
      <td>181.34</td>
      <td>176.43</td>
      <td>177.52</td>
      <td>175.42</td>
      <td>181.06</td>
      <td>176.54</td>
      <td>176.29</td>
      <td>...</td>
      <td>178.14</td>
      <td>175.95</td>
      <td>174.19</td>
      <td>173.95</td>
      <td>172.99</td>
      <td>172.26</td>
      <td>173.57</td>
      <td>176.58</td>
      <td>177.60</td>
      <td>174.86</td>
    </tr>
    <tr>
      <th>2022-01-04</th>
      <td>182.44</td>
      <td>179.15</td>
      <td>174.99</td>
      <td>182.61</td>
      <td>177.84</td>
      <td>176.61</td>
      <td>177.47</td>
      <td>179.75</td>
      <td>179.63</td>
      <td>175.50</td>
      <td>...</td>
      <td>177.45</td>
      <td>176.81</td>
      <td>175.57</td>
      <td>176.18</td>
      <td>171.43</td>
      <td>171.36</td>
      <td>178.19</td>
      <td>175.19</td>
      <td>176.40</td>
      <td>176.52</td>
    </tr>
    <tr>
      <th>2022-01-05</th>
      <td>185.30</td>
      <td>177.67</td>
      <td>169.19</td>
      <td>182.91</td>
      <td>175.08</td>
      <td>183.54</td>
      <td>178.09</td>
      <td>179.85</td>
      <td>174.20</td>
      <td>172.44</td>
      <td>...</td>
      <td>180.20</td>
      <td>175.37</td>
      <td>176.23</td>
      <td>174.00</td>
      <td>167.70</td>
      <td>169.66</td>
      <td>180.88</td>
      <td>175.69</td>
      <td>176.73</td>
      <td>176.66</td>
    </tr>
    <tr>
      <th>2022-01-06</th>
      <td>191.99</td>
      <td>174.70</td>
      <td>173.65</td>
      <td>177.61</td>
      <td>177.02</td>
      <td>182.82</td>
      <td>175.59</td>
      <td>181.03</td>
      <td>170.43</td>
      <td>172.42</td>
      <td>...</td>
      <td>183.12</td>
      <td>176.18</td>
      <td>175.12</td>
      <td>176.93</td>
      <td>167.96</td>
      <td>172.82</td>
      <td>182.73</td>
      <td>176.78</td>
      <td>172.54</td>
      <td>175.32</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-12-23</th>
      <td>207.42</td>
      <td>242.46</td>
      <td>164.21</td>
      <td>191.34</td>
      <td>220.46</td>
      <td>178.93</td>
      <td>187.11</td>
      <td>163.75</td>
      <td>170.35</td>
      <td>199.15</td>
      <td>...</td>
      <td>156.18</td>
      <td>165.90</td>
      <td>137.42</td>
      <td>252.22</td>
      <td>144.24</td>
      <td>129.41</td>
      <td>242.87</td>
      <td>204.14</td>
      <td>194.58</td>
      <td>186.51</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>211.01</td>
      <td>240.78</td>
      <td>165.21</td>
      <td>197.72</td>
      <td>219.43</td>
      <td>178.22</td>
      <td>184.40</td>
      <td>162.25</td>
      <td>167.33</td>
      <td>204.00</td>
      <td>...</td>
      <td>160.32</td>
      <td>164.82</td>
      <td>138.60</td>
      <td>255.43</td>
      <td>145.55</td>
      <td>133.71</td>
      <td>241.07</td>
      <td>205.05</td>
      <td>187.88</td>
      <td>192.04</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>208.33</td>
      <td>247.79</td>
      <td>166.57</td>
      <td>201.11</td>
      <td>216.88</td>
      <td>176.29</td>
      <td>187.63</td>
      <td>161.99</td>
      <td>166.16</td>
      <td>200.95</td>
      <td>...</td>
      <td>158.05</td>
      <td>164.04</td>
      <td>139.88</td>
      <td>259.64</td>
      <td>146.61</td>
      <td>131.03</td>
      <td>240.96</td>
      <td>213.31</td>
      <td>191.79</td>
      <td>192.79</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>203.57</td>
      <td>242.75</td>
      <td>165.70</td>
      <td>201.65</td>
      <td>215.73</td>
      <td>177.48</td>
      <td>187.00</td>
      <td>158.45</td>
      <td>165.87</td>
      <td>203.28</td>
      <td>...</td>
      <td>156.62</td>
      <td>164.92</td>
      <td>139.07</td>
      <td>262.25</td>
      <td>144.18</td>
      <td>128.91</td>
      <td>242.47</td>
      <td>217.28</td>
      <td>187.56</td>
      <td>189.87</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>205.27</td>
      <td>241.45</td>
      <td>164.97</td>
      <td>207.22</td>
      <td>216.20</td>
      <td>177.08</td>
      <td>190.29</td>
      <td>158.04</td>
      <td>167.30</td>
      <td>205.09</td>
      <td>...</td>
      <td>156.43</td>
      <td>164.43</td>
      <td>134.79</td>
      <td>268.96</td>
      <td>140.79</td>
      <td>130.94</td>
      <td>244.51</td>
      <td>223.76</td>
      <td>187.76</td>
      <td>192.34</td>
    </tr>
  </tbody>
</table>
<p>252 rows × 10000 columns</p>
</div></div></div>
</div>
<p>We can compare this price to a simulated price.
The payoff on the call option is $S_T - K$ or $0$, whichever is higher.
The price of the option is the present value of the mean payoff, discounted at the risk-free rate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">payoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">S_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">K</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">payoff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulated option price: </span><span class="si">{</span><span class="n">_</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simulated option price: 81.92
</pre></div>
</div>
</div>
</div>
<p>The option prices do not match exactly.
However, we can simulate more price paths to bring our simulated option price closer to the analytic solution.</p>
</section>
</section>
<section id="estimating-value-at-risk-using-monte-carlo">
<h3>Estimating Value-at-Risk using Monte Carlo<a class="headerlink" href="#estimating-value-at-risk-using-monte-carlo" title="Permalink to this heading">#</a></h3>
<p>Value-at-Risk (VaR) measures the risk associated with a portfolio
VaR reports the worst expected loss, at a given level of confidence, over a certain horizon under normal market conditions.
For example, say the 1-day 95% VaR of our portfolio is $100.
This implies that that 95% of the time (under normal market conditions), we should not lose more than \$100 over one day.
We typically present VaR as a positive value, so a VaR of $100 implies a loss of less than $100.</p>
<p>We can calculate VaR several ways, including:</p>
<ul class="simple">
<li><p>Parametric Approach (Variance-Covariance)</p></li>
<li><p>Historical Simulation Approach</p></li>
<li><p>Monte Carlo simulations</p></li>
</ul>
<p>We only consider the last method to calculate the 1-day VaR of an portfolio of 20 shares each of META and GOOG.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GOOG&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">]</span>
<span class="n">shares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n_sims</span> <span class="o">=</span> <span class="mi">10_000</span>
</pre></div>
</div>
</div>
</div>
<p>However, we will download all data from Yahoo! Finance and subset our data later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">Date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we calculate daily returns during 2022.
Choosing the window to define “normal market conditions” is part art, part science, and beyod the scope of this lecture notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2022&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>GOOG</th>
      <th>META</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-01-03</th>
      <td>0.00</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>2022-01-04</th>
      <td>-0.00</td>
      <td>-0.01</td>
    </tr>
    <tr>
      <th>2022-01-05</th>
      <td>-0.05</td>
      <td>-0.04</td>
    </tr>
    <tr>
      <th>2022-01-06</th>
      <td>-0.00</td>
      <td>0.03</td>
    </tr>
    <tr>
      <th>2022-01-07</th>
      <td>-0.00</td>
      <td>-0.00</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-12-23</th>
      <td>0.02</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>-0.02</td>
      <td>-0.01</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>-0.02</td>
      <td>-0.01</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>0.03</td>
      <td>0.04</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>-0.00</td>
      <td>0.00</td>
    </tr>
  </tbody>
</table>
<p>251 rows × 2 columns</p>
</div></div></div>
</div>
<p>We will need the variance-covariance matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov_mat</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>

<span class="n">cov_mat</span> <span class="o">*</span> <span class="mi">1_000_000</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Ticker</th>
      <th>GOOG</th>
      <th>META</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>GOOG</th>
      <td>596.48</td>
      <td>674.26</td>
    </tr>
    <tr>
      <th>META</th>
      <td>674.26</td>
      <td>1638.50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We will use the variance-covariance matrix to calculate the Cholesky decomposition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chol_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>

<span class="n">chol_mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.02, 0.  ],
       [0.03, 0.03]])
</pre></div>
</div>
</div>
</div>
<p>The Cholesky decomposition helps us generate random variables with the same variance and covariance as the observed data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_sims</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">correlated_rv</span> <span class="o">=</span> <span class="p">(</span><span class="n">chol_mat</span> <span class="o">@</span> <span class="n">rv</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">correlated_rv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.04,  0.05],
       [ 0.02,  0.02],
       [-0.02, -0.04],
       ...,
       [-0.04,  0.01],
       [-0.  , -0.09],
       [-0.02,  0.  ]])
</pre></div>
</div>
</div>
</div>
<p>These random variables have a variance-covariance matrix similar to the real data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">correlated_rv</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  <span class="o">*</span> <span class="mi">1_000_000</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 597.18,  685.37],
       [ 685.37, 1647.31]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">correlated_rv</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">correlated_rv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.02, 0.02])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.16, -0.32])
</pre></div>
</div>
</div>
</div>
<p>Here are the parameters for the simulated price paths:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">S_0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2021&#39;</span><span class="p">,</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">P_0</span> <span class="o">=</span> <span class="n">S_0</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">shares</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate terminal prices using the GBM formula above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">S_T</span> <span class="o">=</span> <span class="n">S_0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">correlated_rv</span><span class="p">)</span>

<span class="n">S_T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[144.79, 336.82],
       [144.74, 336.38],
       [144.61, 335.63],
       ...,
       [144.53, 336.3 ],
       [144.65, 334.95],
       [144.6 , 336.2 ]])
</pre></div>
</div>
</div>
</div>
<p>Calculate terminal portfolio values and returns.
Note that these are dollar values, since VaR is typically expressed in dollar values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">P_T</span> <span class="o">=</span> <span class="n">S_T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">shares</span><span class="p">)</span>

<span class="n">P_T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([9632.23, 9622.51, 9604.65, ..., 9616.48, 9592.05, 9615.98])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">P_diff</span> <span class="o">=</span> <span class="n">P_T</span> <span class="o">-</span> <span class="n">P_0</span>

<span class="n">P_diff</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 11.64,   1.92, -15.94, ...,  -4.11, -28.54,  -4.61])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">P_diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-4.376750155672959
</pre></div>
</div>
</div>
</div>
<p>Next, we calculate VaR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">P_diff</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;1-day VaR with </span><span class="si">{</span><span class="mi">100</span><span class="o">-</span><span class="n">x</span><span class="si">}</span><span class="s1">% confidence: $</span><span class="si">{</span><span class="o">-</span><span class="n">y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1-day VaR with 99.99% confidence: $48.02
1-day VaR with 99.95% confidence: $44.65
1-day VaR with 99.9% confidence: $42.63
</pre></div>
</div>
</div>
</div>
<p>Finally, we will plot VaR:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">P_diff</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of 1-Day Changes in Portfolio Value</span><span class="se">\n</span><span class="s1"> from </span><span class="si">{</span><span class="n">n_sims</span><span class="si">}</span><span class="s1"> Simulations&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">var</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">var</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;99% 1-Day VaR&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;1-Day Change in Portfolio Value ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bf986aec5eb57850436872d90b758d098940c93b27c249ef2621ab4d88d9af03.png" src="_images/bf986aec5eb57850436872d90b758d098940c93b27c249ef2621ab4d88d9af03.png" />
</div>
</div>
</section>
<div class="toctree-wrapper compound">
<span id="document-herron_05_practice"></span><section id="herron-topic-5-practice-blank">
<h3>Herron Topic 5 - Practice (Blank)<a class="headerlink" href="#herron-topic-5-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 2
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="estimate-pi-by-simulating-darts-thrown-at-a-dart-board">
<h5>Estimate $\pi$ by simulating darts thrown at a dart board<a class="headerlink" href="#estimate-pi-by-simulating-darts-thrown-at-a-dart-board" title="Permalink to this heading">#</a></h5>
<p><em>Hints:</em>
Select random $x$s and $y$s such that $-r \leq x \leq +r$ and $-r \leq x \leq +r$.
Darts are on the board if $x^2 + y^2 \leq r^2$.
The area of the circlular board is $\pi r^2$, and the area of square around the board is $(2r)^2 = 4r^2$.
The fraction $f$ of darts on the board is the same as the ratio of circle area to square area, so $f = \frac{\pi r^2}{4 r^2}$.</p>
</section>
<section id="simulate-your-wealth-w-t-by-randomly-sampling-market-returns">
<h5>Simulate your wealth $W_T$ by randomly sampling market returns<a class="headerlink" href="#simulate-your-wealth-w-t-by-randomly-sampling-market-returns" title="Permalink to this heading">#</a></h5>
<p>Use monthly market returns from the French Data Library.
Only invest one cash flow $W_0$, and plot the distribution of $W_T$.</p>
</section>
<section id="repeat-the-exercise-above-but-add-end-of-month-investments-c-t">
<h5>Repeat the exercise above but add end-of-month investments $C_t$<a class="headerlink" href="#repeat-the-exercise-above-but-add-end-of-month-investments-c-t" title="Permalink to this heading">#</a></h5>
</section>
</section>
</section>
<span id="document-herron_05_practice_03"></span><section id="herron-topic-5-practice-monday-2-45-pm-section-3">
<h3>Herron Topic 5 - Practice (Monday 2:45 PM, Section 3)<a class="headerlink" href="#herron-topic-5-practice-monday-2-45-pm-section-3" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Due dates</p>
<ul>
<li><p>Team project 2 is due by 11:59 PM on Wednesday, 4/26</p></li>
<li><p>Teammates review 2 is due by 11:59 PM on Wednesday, 4/26</p></li>
<li><p>30,000 DataCamp XP are due by 11:59 PM on <em>Friday, 4/28</em></p></li>
<li><p>TRACE course evaluations are due by 11:59 PM on <em>Friday, 4/28</em></p></li>
</ul>
</li>
<li><p><em><strong>TRACE course evaluations are optional (and anonymous), but I value your feedback!</strong></em></p>
<ul>
<li><p>I always find student feedback useful, and I read and re-read it!</p></li>
<li><p>I tweak my courses every semester based on student feedback!</p></li>
<li><p>Your feedback does not have to be perfect to be useful!</p></li>
<li><p>If you had a magic wand, what would you change about my course and approach?</p></li>
</ul>
</li>
<li><p>This week and next, we can discuss whatever topics you want, including simulations and team project 2</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 2
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="estimate-pi-by-simulating-darts-thrown-at-a-dart-board">
<h5>Estimate $\pi$ by simulating darts thrown at a dart board<a class="headerlink" href="#estimate-pi-by-simulating-darts-thrown-at-a-dart-board" title="Permalink to this heading">#</a></h5>
<p><em>Hints:</em>
Select random $x$s and $y$s such that $-r \leq x \leq +r$ and $-r \leq x \leq +r$.
Darts are on the board if $x^2 + y^2 \leq r^2$.
The area of the circlular board is $\pi r^2$, and the area of square around the board is $(2r)^2 = 4r^2$.
The fraction $f$ of darts on the board is the same as the ratio of circle area to square area, so $f = \frac{\pi r^2}{4 r^2}$.</p>
<p>First we throw darts at the board.
Darts with $x^2 + y^2 \leq r^2$ are on the board.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">throw_darts</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">r</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> 
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">board</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">throw_darts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>x</th>
      <th>y</th>
      <th>board</th>
    </tr>
    <tr>
      <th>n</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.25</td>
      <td>0.90</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.46</td>
      <td>0.20</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.69</td>
      <td>-0.69</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.88</td>
      <td>0.73</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.20</td>
      <td>0.42</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9995</th>
      <td>0.15</td>
      <td>0.52</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9996</th>
      <td>-0.82</td>
      <td>-0.01</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9997</th>
      <td>0.80</td>
      <td>0.75</td>
      <td>False</td>
    </tr>
    <tr>
      <th>9998</th>
      <td>-0.91</td>
      <td>-0.39</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9999</th>
      <td>-0.11</td>
      <td>-0.66</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>10000 rows × 3 columns</p>
</div></div></div>
</div>
<p>Next, we visualize these darts with a scatter plot.
Seaborn’s <code class="docutils literal notranslate"><span class="pre">scatterplot()</span></code> helps color darts by location (i.e., on or off board).
The <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> method lets us send the output of the <code class="docutils literal notranslate"><span class="pre">.assign()</span></code> method to <code class="docutils literal notranslate"><span class="pre">sns.scatterplot()</span></code> without assigning a temporary data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">throw_darts</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Location</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;board&#39;</span><span class="p">],</span> <span class="s1">&#39;On Board&#39;</span><span class="p">,</span> <span class="s1">&#39;Off Board&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Location&#39;</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Simulated Dart Throws&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9c8f487cc54cb77b787ccddc2740c30d5e0ca308ad208d8bdfe30ab6f0ed140e.png" src="_images/9c8f487cc54cb77b787ccddc2740c30d5e0ca308ad208d8bdfe30ab6f0ed140e.png" />
</div>
</div>
<p>Finally, we use the hint above to estimate $\pi$.
The hint above says $f = \frac{\pi r^2}{4 r^2}$, where $f$ is the fraction of darts on the board.
Therefore, $\pi = \frac{4fr^2}{r^2} = 4f$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">10_000</span>
<span class="n">pi</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">throw_darts</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)[</span><span class="s2">&quot;board&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimate of pi based on </span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> darts: </span><span class="si">{</span><span class="n">pi</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimate of pi based on 10,000 darts: 3.1544
</pre></div>
</div>
</div>
</div>
<p>We increase the precision of our $\pi$ estimate by increasing the number of simulated darts $n$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">throw_darts</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)[</span><span class="s2">&quot;board&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimate of pi based on </span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s1">&lt;9,.0f</span><span class="si">}</span><span class="s1"> darts: </span><span class="si">{</span><span class="n">pi</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimate of pi based on 1         darts: 4.0000
Estimate of pi based on 10        darts: 3.2000
Estimate of pi based on 100       darts: 3.0400
Estimate of pi based on 1,000     darts: 3.1040
Estimate of pi based on 10,000    darts: 3.1544
Estimate of pi based on 100,000   darts: 3.1468
Estimate of pi based on 1,000,000 darts: 3.1420
</pre></div>
</div>
</div>
</div>
</section>
<section id="simulate-your-wealth-w-t-by-randomly-sampling-market-returns">
<h5>Simulate your wealth $W_T$ by randomly sampling market returns<a class="headerlink" href="#simulate-your-wealth-w-t-by-randomly-sampling-market-returns" title="Permalink to this heading">#</a></h5>
<p>Use monthly market returns from the French Data Library.
Only invest one cash flow $W_0$, and plot the distribution of $W_T$.</p>
<p>First, we download data from the French Data Library.
We convert these returns from percent to decimal to simplify compounding.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">mkt</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;mkt&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we write a couple of helper functions.
The <code class="docutils literal notranslate"><span class="pre">get_sample()</span></code> function draws one random sample of <code class="docutils literal notranslate"><span class="pre">n</span></code> observations from returns series <code class="docutils literal notranslate"><span class="pre">x</span></code>.
This sample provides one simulated return history.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">BDay</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">x</span>
        <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_axis</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n</span><span class="p">))</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_samples()</span></code> function calls the <code class="docutils literal notranslate"><span class="pre">get_sample()</span></code> function <code class="docutils literal notranslate"><span class="pre">m</span></code> times to simulate <code class="docutils literal notranslate"><span class="pre">m</span></code> return histories.
The <code class="docutils literal notranslate"><span class="pre">get_samples()</span></code> function combines these <code class="docutils literal notranslate"><span class="pre">m</span></code> return histories into one data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_samples</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">get_sample</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
            <span class="n">names</span><span class="o">=</span><span class="s1">&#39;Sample&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we use these helper functions to simulate 10,000 return histories of 10,000 trading days each.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkts</span> <span class="o">=</span> <span class="n">get_samples</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mkt</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">)</span>

<span class="n">mkts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Sample</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>9990</th>
      <th>9991</th>
      <th>9992</th>
      <th>9993</th>
      <th>9994</th>
      <th>9995</th>
      <th>9996</th>
      <th>9997</th>
      <th>9998</th>
      <th>9999</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-01-02</th>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>2023-01-03</th>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.02</td>
    </tr>
    <tr>
      <th>2023-01-04</th>
      <td>-0.03</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.03</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>...</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.02</td>
    </tr>
    <tr>
      <th>2023-01-05</th>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.02</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>...</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>0.03</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>2023-01-06</th>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>...</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.02</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2050-05-15</th>
      <td>0.02</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>...</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.02</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>-0.04</td>
    </tr>
    <tr>
      <th>2050-05-16</th>
      <td>0.01</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.02</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>2050-05-17</th>
      <td>-0.02</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.02</td>
      <td>-0.00</td>
    </tr>
    <tr>
      <th>2050-05-18</th>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.03</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
    </tr>
    <tr>
      <th>2050-05-19</th>
      <td>0.01</td>
      <td>-0.02</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.01</td>
    </tr>
  </tbody>
</table>
<p>10000 rows × 10000 columns</p>
</div></div></div>
</div>
<p>We compound daily returns $R_t$ to find future wealth $W_T$, so $W_T = W_0 \times (1 + R_1) \times (1 + R_2) \times \cdots \times (1 + R_T)$.
We use the <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> method to compound the daily returns in data frame <code class="docutils literal notranslate"><span class="pre">mkts</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_0</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">W_t</span> <span class="o">=</span> <span class="n">W_0</span> <span class="o">*</span> <span class="n">mkts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We visualize terminal wealth $W_T$ with a cumulative distribution plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$W_T$ where $W_0 = $&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;\$</span><span class="si">{</span><span class="n">W_0</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Cumulative Distribution of $W_T$&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">after </span><span class="si">{</span><span class="n">W_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> Trading Days&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0211c97349d8ed9941ef650fa751fb416ffaa07a7972ee92543d9abd864642d2.png" src="_images/0211c97349d8ed9941ef650fa751fb416ffaa07a7972ee92543d9abd864642d2.png" />
</div>
</div>
<p>The plot above shows the cumulative distribution of $W_T$, suggesting we expect $W_T$ greater than about $17 million for about 75% of samples.</p>
<p>The plot above may be difficult to read and interpret because $W_T$ has large outliers.
The <code class="docutils literal notranslate"><span class="pre">.describe()</span></code> method provides few salient values of $W_T$.
We convert $W_T$ from dollars to millions of dollars with <code class="docutils literal notranslate"><span class="pre">.div(1_000_000)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   10000.00
mean       64.75
std       101.61
min         0.56
25%        17.56
50%        36.11
75%        74.11
max      3330.53
Name: 2050-05-19 00:00:00, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="repeat-the-exercise-above-but-add-end-of-month-investments-c-t">
<h5>Repeat the exercise above but add end-of-month investments $C_t$<a class="headerlink" href="#repeat-the-exercise-above-but-add-end-of-month-investments-c-t" title="Permalink to this heading">#</a></h5>
<p>We can use the same data frame <code class="docutils literal notranslate"><span class="pre">mkts</span></code> of simulated market returns.
However, need to consider end-of-month investments of $C_t$.
The easiest approach is to aggregate the daily market returns in <code class="docutils literal notranslate"><span class="pre">mkts</span></code> to monthly market returns in data frame <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code>.
The last month in <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code> is not complete (i.e., fewer than about 21 trading days), so we drop is with <code class="docutils literal notranslate"><span class="pre">.iloc[:-1]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkts_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkts</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The wealth at time $t$ is $W_t$ and depends on:</p>
<ol class="arabic simple">
<li><p>The wealth at the end of the previous month $W_{t-1}$</p></li>
<li><p>The return over the previous month $R_t$ (recall we label returns by their right edge)</p></li>
<li><p>The end-of-month investment $C_t$</p></li>
</ol>
<p>Putting it all togther: $W_t = W_{t-1} \times (1 + R_t) + C_t$</p>
<p>We have to loop over the monthly returns in <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code> because we have to combine compounded returns and cash flows.
The <code class="docutils literal notranslate"><span class="pre">iterrows()</span></code> methods provides an easy way to iterate (loop) over the rows in <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C_t</span> <span class="o">=</span> <span class="mi">1_000</span>
<span class="n">W_0</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">W_last</span> <span class="o">=</span> <span class="n">W_0</span>
<span class="n">W_t</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mkts_m</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">W_last</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">W_last</span> <span class="o">+</span> <span class="n">C_t</span>
    <span class="n">W_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W_last</span><span class="p">)</span>

<span class="n">W_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="n">W_t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">mkts_m</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We repeat the cumulative distribution of wealth plot and descriptive statistics from above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;$W_T$ where $W_0 = $&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;\$</span><span class="si">{</span><span class="n">W_0</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> 
    <span class="sa">r</span><span class="s1">&#39; and  $C_t = $&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;\$</span><span class="si">{</span><span class="n">C_t</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Cumulative Distribution of $W_T$&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">after </span><span class="si">{</span><span class="n">W_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> Trading Months&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6d78aab7a506358bd5a775b38f3ef6930893fe48e082ff3b0dfee6a188e7bc80.png" src="_images/6d78aab7a506358bd5a775b38f3ef6930893fe48e082ff3b0dfee6a188e7bc80.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   10000.00
mean       69.20
std       106.22
min         0.94
25%        19.59
50%        39.27
75%        79.69
max      3467.92
Name: 2050-04, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The plot above shows the cumulative distribution of $W_T$, suggesting we expect $W_T$ greater than about \$20 million for about 75% of samples.
Note, even though we deposit $1,000 per month for almost 40 years, we do not gain much wealth over the previous example with only a lump sum!
Start saving early!</p>
</section>
</section>
</section>
<span id="document-herron_05_practice_04"></span><section id="herron-topic-5-practice-wednesday-11-45-am-section-4">
<h3>Herron Topic 5 - Practice (Wednesday 11:45 AM, Section 4)<a class="headerlink" href="#herron-topic-5-practice-wednesday-11-45-am-section-4" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Due dates</p>
<ul>
<li><p>Team project 2 is due by 11:59 PM on Wednesday, 4/26</p></li>
<li><p>Teammates review 2 is due by 11:59 PM on Wednesday, 4/26</p></li>
<li><p>30,000 DataCamp XP are due by 11:59 PM on <em>Friday, 4/28</em></p></li>
<li><p>TRACE course evaluations are due by 11:59 PM on <em>Friday, 4/28</em></p></li>
</ul>
</li>
<li><p><em><strong>TRACE course evaluations are optional (and anonymous), but I value your feedback!</strong></em></p>
<ul>
<li><p>I always find student feedback useful, and I read and re-read it!</p></li>
<li><p>I tweak my courses every semester based on student feedback!</p></li>
<li><p>Your feedback does not have to be perfect to be useful!</p></li>
<li><p>If you had a magic wand, what would you change about my course and approach?</p></li>
</ul>
</li>
<li><p>This week and next, we can discuss whatever topics you want, including simulations and team project 2</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 2
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="estimate-pi-by-simulating-darts-thrown-at-a-dart-board">
<h5>Estimate $\pi$ by simulating darts thrown at a dart board<a class="headerlink" href="#estimate-pi-by-simulating-darts-thrown-at-a-dart-board" title="Permalink to this heading">#</a></h5>
<p><em>Hints:</em>
Select random $x$s and $y$s such that $-r \leq x \leq +r$ and $-r \leq x \leq +r$.
Darts are on the board if $x^2 + y^2 \leq r^2$.
The area of the circlular board is $\pi r^2$, and the area of square around the board is $(2r)^2 = 4r^2$.
The fraction $f$ of darts on the board is the same as the ratio of circle area to square area, so $f = \frac{\pi r^2}{4 r^2}$.</p>
<p>First we throw darts at the board.
Darts with $x^2 + y^2 \leq r^2$ are on the board.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">throw_darts</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">r</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> 
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">board</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">throw_darts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>x</th>
      <th>y</th>
      <th>board</th>
    </tr>
    <tr>
      <th>n</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.25</td>
      <td>0.90</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.46</td>
      <td>0.20</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.69</td>
      <td>-0.69</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.88</td>
      <td>0.73</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.20</td>
      <td>0.42</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9995</th>
      <td>0.15</td>
      <td>0.52</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9996</th>
      <td>-0.82</td>
      <td>-0.01</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9997</th>
      <td>0.80</td>
      <td>0.75</td>
      <td>False</td>
    </tr>
    <tr>
      <th>9998</th>
      <td>-0.91</td>
      <td>-0.39</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9999</th>
      <td>-0.11</td>
      <td>-0.66</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>10000 rows × 3 columns</p>
</div></div></div>
</div>
<p>Next, we visualize these darts with a scatter plot.
Seaborn’s <code class="docutils literal notranslate"><span class="pre">scatterplot()</span></code> helps color darts by location (i.e., on or off board).
The <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> method lets us send the output of the <code class="docutils literal notranslate"><span class="pre">.assign()</span></code> method to <code class="docutils literal notranslate"><span class="pre">sns.scatterplot()</span></code> without assigning a temporary data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">throw_darts</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Location</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;board&#39;</span><span class="p">],</span> <span class="s1">&#39;On Board&#39;</span><span class="p">,</span> <span class="s1">&#39;Off Board&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Location&#39;</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Simulated Dart Throws&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9c8f487cc54cb77b787ccddc2740c30d5e0ca308ad208d8bdfe30ab6f0ed140e.png" src="_images/9c8f487cc54cb77b787ccddc2740c30d5e0ca308ad208d8bdfe30ab6f0ed140e.png" />
</div>
</div>
<p>Finally, we use the hint above to estimate $\pi$.
The hint above says $f = \frac{\pi r^2}{4 r^2}$, where $f$ is the fraction of darts on the board.
Therefore, $\pi = \frac{4fr^2}{r^2} = 4f$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">10_000</span>
<span class="n">pi</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">throw_darts</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)[</span><span class="s2">&quot;board&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimate of pi based on </span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> darts: </span><span class="si">{</span><span class="n">pi</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimate of pi based on 10,000 darts: 3.1544
</pre></div>
</div>
</div>
</div>
<p>We increase the precision of our $\pi$ estimate by increasing the number of simulated darts $n$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">throw_darts</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)[</span><span class="s2">&quot;board&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimate of pi based on </span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s1">&lt;9,.0f</span><span class="si">}</span><span class="s1"> darts: </span><span class="si">{</span><span class="n">pi</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimate of pi based on 1         darts: 4.0000
Estimate of pi based on 10        darts: 3.2000
Estimate of pi based on 100       darts: 3.0400
Estimate of pi based on 1,000     darts: 3.1040
Estimate of pi based on 10,000    darts: 3.1544
Estimate of pi based on 100,000   darts: 3.1468
Estimate of pi based on 1,000,000 darts: 3.1420
</pre></div>
</div>
</div>
</div>
</section>
<section id="simulate-your-wealth-w-t-by-randomly-sampling-market-returns">
<h5>Simulate your wealth $W_T$ by randomly sampling market returns<a class="headerlink" href="#simulate-your-wealth-w-t-by-randomly-sampling-market-returns" title="Permalink to this heading">#</a></h5>
<p>Use monthly market returns from the French Data Library.
Only invest one cash flow $W_0$, and plot the distribution of $W_T$.</p>
<p>First, we download data from the French Data Library.
We convert these returns from percent to decimal to simplify compounding.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">mkt</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;mkt&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we write a couple of helper functions.
The <code class="docutils literal notranslate"><span class="pre">get_sample()</span></code> function draws one random sample of <code class="docutils literal notranslate"><span class="pre">n</span></code> observations from returns series <code class="docutils literal notranslate"><span class="pre">x</span></code>.
This sample provides one simulated return history.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">BDay</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">x</span>
        <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_axis</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n</span><span class="p">))</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_samples()</span></code> function calls the <code class="docutils literal notranslate"><span class="pre">get_sample()</span></code> function <code class="docutils literal notranslate"><span class="pre">m</span></code> times to simulate <code class="docutils literal notranslate"><span class="pre">m</span></code> return histories.
The <code class="docutils literal notranslate"><span class="pre">get_samples()</span></code> function combines these <code class="docutils literal notranslate"><span class="pre">m</span></code> return histories into one data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_samples</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">get_sample</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
            <span class="n">names</span><span class="o">=</span><span class="s1">&#39;Sample&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we use these helper functions to simulate 10,000 return histories of 10,000 trading days each.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkts</span> <span class="o">=</span> <span class="n">get_samples</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mkt</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">)</span>

<span class="n">mkts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Sample</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>9990</th>
      <th>9991</th>
      <th>9992</th>
      <th>9993</th>
      <th>9994</th>
      <th>9995</th>
      <th>9996</th>
      <th>9997</th>
      <th>9998</th>
      <th>9999</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-01-02</th>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>2023-01-03</th>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.02</td>
    </tr>
    <tr>
      <th>2023-01-04</th>
      <td>-0.03</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.03</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>...</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.02</td>
    </tr>
    <tr>
      <th>2023-01-05</th>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.02</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>...</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>0.03</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>2023-01-06</th>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>...</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.02</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2050-05-15</th>
      <td>0.02</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>...</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.02</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>-0.04</td>
    </tr>
    <tr>
      <th>2050-05-16</th>
      <td>0.01</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.02</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>2050-05-17</th>
      <td>-0.02</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.02</td>
      <td>-0.00</td>
    </tr>
    <tr>
      <th>2050-05-18</th>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.03</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
    </tr>
    <tr>
      <th>2050-05-19</th>
      <td>0.01</td>
      <td>-0.02</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.01</td>
    </tr>
  </tbody>
</table>
<p>10000 rows × 10000 columns</p>
</div></div></div>
</div>
<p>We compound daily returns $R_t$ to find future wealth $W_T$, so $W_T = W_0 \times (1 + R_1) \times (1 + R_2) \times \cdots \times (1 + R_T)$.
We use the <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> method to compound the daily returns in data frame <code class="docutils literal notranslate"><span class="pre">mkts</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_0</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">W_t</span> <span class="o">=</span> <span class="n">W_0</span> <span class="o">*</span> <span class="n">mkts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We visualize terminal wealth $W_T$ with a cumulative distribution plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$W_T$ where $W_0 = $&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;\$</span><span class="si">{</span><span class="n">W_0</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Cumulative Distribution of $W_T$&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">after </span><span class="si">{</span><span class="n">W_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> Trading Days&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0211c97349d8ed9941ef650fa751fb416ffaa07a7972ee92543d9abd864642d2.png" src="_images/0211c97349d8ed9941ef650fa751fb416ffaa07a7972ee92543d9abd864642d2.png" />
</div>
</div>
<p>The plot above shows the cumulative distribution of $W_T$, suggesting we expect $W_T$ greater than about $17 million for about 75% of samples.</p>
<p>The plot above may be difficult to read and interpret because $W_T$ has large outliers.
The <code class="docutils literal notranslate"><span class="pre">.describe()</span></code> method provides few salient values of $W_T$.
We convert $W_T$ from dollars to millions of dollars with <code class="docutils literal notranslate"><span class="pre">.div(1_000_000)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   10000.00
mean       64.75
std       101.61
min         0.56
25%        17.56
50%        36.11
75%        74.11
max      3330.53
Name: 2050-05-19 00:00:00, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="repeat-the-exercise-above-but-add-end-of-month-investments-c-t">
<h5>Repeat the exercise above but add end-of-month investments $C_t$<a class="headerlink" href="#repeat-the-exercise-above-but-add-end-of-month-investments-c-t" title="Permalink to this heading">#</a></h5>
<p>We can use the same data frame <code class="docutils literal notranslate"><span class="pre">mkts</span></code> of simulated market returns.
However, need to consider end-of-month investments of $C_t$.
The easiest approach is to aggregate the daily market returns in <code class="docutils literal notranslate"><span class="pre">mkts</span></code> to monthly market returns in data frame <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code>.
The last month in <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code> is not complete (i.e., fewer than about 21 trading days), so we drop is with <code class="docutils literal notranslate"><span class="pre">.iloc[:-1]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkts_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkts</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The wealth at time $t$ is $W_t$ and depends on:</p>
<ol class="arabic simple">
<li><p>The wealth at the end of the previous month $W_{t-1}$</p></li>
<li><p>The return over the previous month $R_t$ (recall we label returns by their right edge)</p></li>
<li><p>The end-of-month investment $C_t$</p></li>
</ol>
<p>Putting it all togther: $W_t = W_{t-1} \times (1 + R_t) + C_t$</p>
<p>We have to loop over the monthly returns in <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code> because we have to combine compounded returns and cash flows.
The <code class="docutils literal notranslate"><span class="pre">iterrows()</span></code> methods provides an easy way to iterate (loop) over the rows in <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C_t</span> <span class="o">=</span> <span class="mi">1_000</span>
<span class="n">W_0</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">W_last</span> <span class="o">=</span> <span class="n">W_0</span>
<span class="n">W_t</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mkts_m</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">W_last</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">W_last</span> <span class="o">+</span> <span class="n">C_t</span>
    <span class="n">W_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W_last</span><span class="p">)</span>

<span class="n">W_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="n">W_t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">mkts_m</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We repeat the cumulative distribution of wealth plot and descriptive statistics from above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;$W_T$ where $W_0 = $&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;\$</span><span class="si">{</span><span class="n">W_0</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> 
    <span class="sa">r</span><span class="s1">&#39; and  $C_t = $&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;\$</span><span class="si">{</span><span class="n">C_t</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Cumulative Distribution of $W_T$&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">after </span><span class="si">{</span><span class="n">W_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> Trading Months&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6d78aab7a506358bd5a775b38f3ef6930893fe48e082ff3b0dfee6a188e7bc80.png" src="_images/6d78aab7a506358bd5a775b38f3ef6930893fe48e082ff3b0dfee6a188e7bc80.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   10000.00
mean       69.20
std       106.22
min         0.94
25%        19.59
50%        39.27
75%        79.69
max      3467.92
Name: 2050-04, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The plot above shows the cumulative distribution of $W_T$, suggesting we expect $W_T$ greater than about \$20 million for about 75% of samples.
Note, even though we deposit $1,000 per month for almost 40 years, we do not gain much wealth over the previous example with only a lump sum!
Start saving early!</p>
</section>
</section>
</section>
<span id="document-herron_05_practice_02"></span><section id="herron-topic-5-practice-wednesday-2-45-pm-section-2">
<h3>Herron Topic 5 - Practice (Wednesday 2:45 PM, Section 2)<a class="headerlink" href="#herron-topic-5-practice-wednesday-2-45-pm-section-2" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Due dates</p>
<ul>
<li><p>Team project 2 is due by 11:59 PM on Wednesday, 4/26</p></li>
<li><p>Teammates review 2 is due by 11:59 PM on Wednesday, 4/26</p></li>
<li><p>30,000 DataCamp XP are due by 11:59 PM on <em>Friday, 4/28</em></p></li>
<li><p>TRACE course evaluations are due by 11:59 PM on <em>Friday, 4/28</em></p></li>
</ul>
</li>
<li><p><em><strong>TRACE course evaluations are optional (and anonymous), but I value your feedback!</strong></em></p>
<ul>
<li><p>I always find student feedback useful, and I read and re-read it!</p></li>
<li><p>I tweak my courses every semester based on student feedback!</p></li>
<li><p>Your feedback does not have to be perfect to be useful!</p></li>
<li><p>If you had a magic wand, what would you change about my course and approach?</p></li>
</ul>
</li>
<li><p>This week and next, we can discuss whatever topics you want, including simulations and team project 2</p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 2
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="estimate-pi-by-simulating-darts-thrown-at-a-dart-board">
<h5>Estimate $\pi$ by simulating darts thrown at a dart board<a class="headerlink" href="#estimate-pi-by-simulating-darts-thrown-at-a-dart-board" title="Permalink to this heading">#</a></h5>
<p><em>Hints:</em>
Select random $x$s and $y$s such that $-r \leq x \leq +r$ and $-r \leq x \leq +r$.
Darts are on the board if $x^2 + y^2 \leq r^2$.
The area of the circlular board is $\pi r^2$, and the area of square around the board is $(2r)^2 = 4r^2$.
The fraction $f$ of darts on the board is the same as the ratio of circle area to square area, so $f = \frac{\pi r^2}{4 r^2}$.</p>
<p>First we throw darts at the board.
Darts with $x^2 + y^2 \leq r^2$ are on the board.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">throw_darts</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">r</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> 
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">board</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">throw_darts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>x</th>
      <th>y</th>
      <th>board</th>
    </tr>
    <tr>
      <th>n</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.25</td>
      <td>0.90</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.46</td>
      <td>0.20</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.69</td>
      <td>-0.69</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.88</td>
      <td>0.73</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.20</td>
      <td>0.42</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9995</th>
      <td>0.15</td>
      <td>0.52</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9996</th>
      <td>-0.82</td>
      <td>-0.01</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9997</th>
      <td>0.80</td>
      <td>0.75</td>
      <td>False</td>
    </tr>
    <tr>
      <th>9998</th>
      <td>-0.91</td>
      <td>-0.39</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9999</th>
      <td>-0.11</td>
      <td>-0.66</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>10000 rows × 3 columns</p>
</div></div></div>
</div>
<p>Next, we visualize these darts with a scatter plot.
Seaborn’s <code class="docutils literal notranslate"><span class="pre">scatterplot()</span></code> helps color darts by location (i.e., on or off board).
The <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> method lets us send the output of the <code class="docutils literal notranslate"><span class="pre">.assign()</span></code> method to <code class="docutils literal notranslate"><span class="pre">sns.scatterplot()</span></code> without assigning a temporary data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">throw_darts</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Location</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;board&#39;</span><span class="p">],</span> <span class="s1">&#39;On Board&#39;</span><span class="p">,</span> <span class="s1">&#39;Off Board&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Location&#39;</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Simulated Dart Throws&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9c8f487cc54cb77b787ccddc2740c30d5e0ca308ad208d8bdfe30ab6f0ed140e.png" src="_images/9c8f487cc54cb77b787ccddc2740c30d5e0ca308ad208d8bdfe30ab6f0ed140e.png" />
</div>
</div>
<p>Finally, we use the hint above to estimate $\pi$.
The hint above says $f = \frac{\pi r^2}{4 r^2}$, where $f$ is the fraction of darts on the board.
Therefore, $\pi = \frac{4fr^2}{r^2} = 4f$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">10_000</span>
<span class="n">pi</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">throw_darts</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)[</span><span class="s2">&quot;board&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimate of pi based on </span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> darts: </span><span class="si">{</span><span class="n">pi</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimate of pi based on 10,000 darts: 3.1544
</pre></div>
</div>
</div>
</div>
<p>We increase the precision of our $\pi$ estimate by increasing the number of simulated darts $n$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">throw_darts</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)[</span><span class="s2">&quot;board&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimate of pi based on </span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s1">&lt;9,.0f</span><span class="si">}</span><span class="s1"> darts: </span><span class="si">{</span><span class="n">pi</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimate of pi based on 1         darts: 4.0000
Estimate of pi based on 10        darts: 3.2000
Estimate of pi based on 100       darts: 3.0400
Estimate of pi based on 1,000     darts: 3.1040
Estimate of pi based on 10,000    darts: 3.1544
Estimate of pi based on 100,000   darts: 3.1468
Estimate of pi based on 1,000,000 darts: 3.1420
</pre></div>
</div>
</div>
</div>
</section>
<section id="simulate-your-wealth-w-t-by-randomly-sampling-market-returns">
<h5>Simulate your wealth $W_T$ by randomly sampling market returns<a class="headerlink" href="#simulate-your-wealth-w-t-by-randomly-sampling-market-returns" title="Permalink to this heading">#</a></h5>
<p>Use monthly market returns from the French Data Library.
Only invest one cash flow $W_0$, and plot the distribution of $W_T$.</p>
<p>First, we download data from the French Data Library.
We convert these returns from percent to decimal to simplify compounding.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">mkt</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">[</span><span class="s1">&#39;mkt&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we write a couple of helper functions.
The <code class="docutils literal notranslate"><span class="pre">get_sample()</span></code> function draws one random sample of <code class="docutils literal notranslate"><span class="pre">n</span></code> observations from returns series <code class="docutils literal notranslate"><span class="pre">x</span></code>.
This sample provides one simulated return history.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">BDay</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">x</span>
        <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_axis</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n</span><span class="p">))</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_samples()</span></code> function calls the <code class="docutils literal notranslate"><span class="pre">get_sample()</span></code> function <code class="docutils literal notranslate"><span class="pre">m</span></code> times to simulate <code class="docutils literal notranslate"><span class="pre">m</span></code> return histories.
The <code class="docutils literal notranslate"><span class="pre">get_samples()</span></code> function combines these <code class="docutils literal notranslate"><span class="pre">m</span></code> return histories into one data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_samples</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">get_sample</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
            <span class="n">names</span><span class="o">=</span><span class="s1">&#39;Sample&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we use these helper functions to simulate 10,000 return histories of 10,000 trading days each.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkts</span> <span class="o">=</span> <span class="n">get_samples</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mkt</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10_000</span><span class="p">)</span>

<span class="n">mkts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Sample</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>9990</th>
      <th>9991</th>
      <th>9992</th>
      <th>9993</th>
      <th>9994</th>
      <th>9995</th>
      <th>9996</th>
      <th>9997</th>
      <th>9998</th>
      <th>9999</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-01-02</th>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>2023-01-03</th>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.02</td>
    </tr>
    <tr>
      <th>2023-01-04</th>
      <td>-0.03</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.03</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>...</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.02</td>
    </tr>
    <tr>
      <th>2023-01-05</th>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.02</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>...</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>0.03</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>2023-01-06</th>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>...</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.02</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2050-05-15</th>
      <td>0.02</td>
      <td>-0.01</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>...</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.02</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>-0.04</td>
    </tr>
    <tr>
      <th>2050-05-16</th>
      <td>0.01</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.01</td>
      <td>-0.01</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.02</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>2050-05-17</th>
      <td>-0.02</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.02</td>
      <td>-0.00</td>
    </tr>
    <tr>
      <th>2050-05-18</th>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.03</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>-0.00</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
    </tr>
    <tr>
      <th>2050-05-19</th>
      <td>0.01</td>
      <td>-0.02</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>0.01</td>
      <td>-0.01</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>-0.00</td>
      <td>-0.01</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>-0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>0.01</td>
    </tr>
  </tbody>
</table>
<p>10000 rows × 10000 columns</p>
</div></div></div>
</div>
<p>We compound daily returns $R_t$ to find future wealth $W_T$, so $W_T = W_0 \times (1 + R_1) \times (1 + R_2) \times \cdots \times (1 + R_T)$.
We use the <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> method to compound the daily returns in data frame <code class="docutils literal notranslate"><span class="pre">mkts</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_0</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">W_t</span> <span class="o">=</span> <span class="n">W_0</span> <span class="o">*</span> <span class="n">mkts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We visualize terminal wealth $W_T$ with a cumulative distribution plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$W_T$ where $W_0 = $&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;\$</span><span class="si">{</span><span class="n">W_0</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Cumulative Distribution of $W_T$&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">after </span><span class="si">{</span><span class="n">W_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> Trading Days&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0211c97349d8ed9941ef650fa751fb416ffaa07a7972ee92543d9abd864642d2.png" src="_images/0211c97349d8ed9941ef650fa751fb416ffaa07a7972ee92543d9abd864642d2.png" />
</div>
</div>
<p>The plot above shows the cumulative distribution of $W_T$, suggesting we expect $W_T$ greater than about $17 million for about 75% of samples.</p>
<p>The plot above may be difficult to read and interpret because $W_T$ has large outliers.
The <code class="docutils literal notranslate"><span class="pre">.describe()</span></code> method provides few salient values of $W_T$.
We convert $W_T$ from dollars to millions of dollars with <code class="docutils literal notranslate"><span class="pre">.div(1_000_000)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   10000.00
mean       64.75
std       101.61
min         0.56
25%        17.56
50%        36.11
75%        74.11
max      3330.53
Name: 2050-05-19 00:00:00, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="repeat-the-exercise-above-but-add-end-of-month-investments-c-t">
<h5>Repeat the exercise above but add end-of-month investments $C_t$<a class="headerlink" href="#repeat-the-exercise-above-but-add-end-of-month-investments-c-t" title="Permalink to this heading">#</a></h5>
<p>We can use the same data frame <code class="docutils literal notranslate"><span class="pre">mkts</span></code> of simulated market returns.
However, need to consider end-of-month investments of $C_t$.
The easiest approach is to aggregate the daily market returns in <code class="docutils literal notranslate"><span class="pre">mkts</span></code> to monthly market returns in data frame <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code>.
The last month in <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code> is not complete (i.e., fewer than about 21 trading days), so we drop is with <code class="docutils literal notranslate"><span class="pre">.iloc[:-1]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkts_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkts</span>
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">prod</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The wealth at time $t$ is $W_t$ and depends on:</p>
<ol class="arabic simple">
<li><p>The wealth at the end of the previous month $W_{t-1}$</p></li>
<li><p>The return over the previous month $R_t$ (recall we label returns by their right edge)</p></li>
<li><p>The end-of-month investment $C_t$</p></li>
</ol>
<p>Putting it all togther: $W_t = W_{t-1} \times (1 + R_t) + C_t$</p>
<p>We have to loop over the monthly returns in <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code> because we have to combine compounded returns and cash flows.
The <code class="docutils literal notranslate"><span class="pre">iterrows()</span></code> methods provides an easy way to iterate (loop) over the rows in <code class="docutils literal notranslate"><span class="pre">mkts_m</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C_t</span> <span class="o">=</span> <span class="mi">1_000</span>
<span class="n">W_0</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">W_last</span> <span class="o">=</span> <span class="n">W_0</span>
<span class="n">W_t</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mkts_m</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">W_last</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">W_last</span> <span class="o">+</span> <span class="n">C_t</span>
    <span class="n">W_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W_last</span><span class="p">)</span>

<span class="n">W_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="n">W_t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">mkts_m</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We repeat the cumulative distribution of wealth plot and descriptive statistics from above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;$W_T$ where $W_0 = $&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;\$</span><span class="si">{</span><span class="n">W_0</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> 
    <span class="sa">r</span><span class="s1">&#39; and  $C_t = $&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;\$</span><span class="si">{</span><span class="n">C_t</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;Cumulative Distribution of $W_T$&#39;</span> <span class="o">+</span> 
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">after </span><span class="si">{</span><span class="n">W_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> Trading Months&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6d78aab7a506358bd5a775b38f3ef6930893fe48e082ff3b0dfee6a188e7bc80.png" src="_images/6d78aab7a506358bd5a775b38f3ef6930893fe48e082ff3b0dfee6a188e7bc80.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_t</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   10000.00
mean       69.20
std       106.22
min         0.94
25%        19.59
50%        39.27
75%        79.69
max      3467.92
Name: 2050-04, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The plot above shows the cumulative distribution of $W_T$, suggesting we expect $W_T$ greater than about \$20 million for about 75% of samples.
Note, even though we deposit $1,000 per month for almost 40 years, we do not gain much wealth over the previous example with only a lump sum!
Start saving early!</p>
</section>
</section>
</section>
</div>
</section>
<span id="document-herron_06_lecture"></span><section id="herron-topic-6-size-value-and-momentum-investing">
<h2>Herron Topic 6 - Size, Value, and Momentum Investing<a class="headerlink" href="#herron-topic-6-size-value-and-momentum-investing" title="Permalink to this heading">#</a></h2>
<p>This lecture notebook covers momentum investing, and the practice notebook will apply the tools we learn in this notebook to size and value investing.
Here, we will learn:</p>
<ol class="arabic simple">
<li><p>What is momentum investing?</p></li>
<li><p>How to use Center for Research in Security Prices (CRSP) data, which is survivorship bias free</p></li>
<li><p>How to implement and evaluate a momentum strategy</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="what-is-momentum-investing">
<h3>What is momentum investing?<a class="headerlink" href="#what-is-momentum-investing" title="Permalink to this heading">#</a></h3>
<p>From page 13 of <a class="reference external" href="https://book.ivo-welch.info/read/source5.mba/12-effbehav.pdf">chapter 12</a> of Ivo Welch’s free corporate finance textbook (<em><strong>emphasis added</strong></em>):</p>
<blockquote>
<div><p>The second-most important factor anomaly was the momentum investing strategy.
<em><strong>Momentum investing strategies require going long in stocks that have increased
greatly over the last year, and going short in stocks that have decreased greatly.</strong></em>
(It requires a few more contortions, but this is a reasonable characterization.) As
with value, behavioral finance researchers were quick to adopt momentum as a
consequence of investor psychology. They also developed plenty of theories that
argued about how the psychology of investors could explain momentum.</p>
<p>Yet over the last 17 years, Ken French’s data suggests that the average rate of Momentum has been mostly
return on the momentum investment strategy was — drumroll — 0.03% with a
standard deviation of 23.8%. This rate of return is statistically and economically
insignificant. Momentum investing also had the unpleasant aspect of sudden nasty
risk. It lost 83 cents for every dollar invested in 2009</p>
</div></blockquote>
</section>
<section id="crsp-data">
<h3>CRSP Data<a class="headerlink" href="#crsp-data" title="Permalink to this heading">#</a></h3>
<p>We typically use Yahoo! Finance data in class because these data are easy to download and use.
However, Yahoo! Finance only provides data for listed (active) public companies.
When public companies delist, Yahoo! Finance removes their data from its website and application programming interfaces (APIs).
Companies delist for various reasons, including failures, poor performance, buyouts, and acquisitions.
Failures and poor performance are generally associated with large negative returns before delisting.
Buyouts and acquisitions are generally associated with large positive returns before delisting.
Regardless of the reason for delisting, delisted company data are unavailable from Yahoo! Finance.
Because delistings are not randomly assigned and typically related to past performance, we cannot ignore them.
If we ignore delistings, we create a <a class="reference external" href="https://en.wikipedia.org/wiki/Survivorship_bias">survivorship bias</a>:</p>
<blockquote>
<div><p>Survivorship bias, survival bias or immortal time bias is the logical error of concentrating on the people or things that made it past some selection process and overlooking those that did not, typically because of their lack of visibility. This can lead to incorrect conclusions regarding that which (or those who) didn’t make it.</p>
<p>Survivorship bias is a form of selection bias that can lead to overly optimistic beliefs because multiple failures are overlooked, such as when companies that no longer exist are excluded from analyses of financial performance. It can also lead to the false belief that the successes in a group have some special property, rather than just coincidence as in correlation “proves” causality. For example, if 3 of the 5 students with their state’s highest college GPAs went to the same high school, it might lead to the notion (which the institution may even capitalize on through advertising) that their high school offers an excellent education even though it’s actually due to their school being the largest in their state. Therefore, by comparing the average GPA of all of the school’s students — not just the ones who made the top-five selection process — to state averages, one could better assess the school’s quality (not quantity).</p>
<p>Another kind of survivorship bias would involve thinking that an incident was not all that dangerous because the only people who were involved in the incident who can speak about it are those who survived it. Even if one knew that some people are dead, they would not have their voice to add to the conversation, leading to bias in the conversation.</p>
</div></blockquote>
<p>We should always be on the lookout for survivorship bias!
Here is my favorite survivorship bias joke:</p>
<p><img alt="XKCD 1827" src="https://imgs.xkcd.com/comics/survivorship_bias.png" /></p>
<p>To avoid a survivorship bias, we will use survivorship-bias-free data from the <a class="reference external" href="https://www.crsp.org/">Center for Research in Security Prices (CRSP)</a>.
CRSP data include delisted stocks and are used by academics and institutional investors to research and backtest trading strategies.
Download the CRSP data file <code class="docutils literal notranslate"><span class="pre">crsp.csv</span></code> from Canvas, and put it in the same folder as this notebook.
Then, we can read and clean the CRSP data file as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">filepath_or_buffer</span><span class="o">=</span><span class="s1">&#39;crsp.csv&#39;</span><span class="p">,</span>
        <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
        <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="c1"># CRSP uses letter codes to provide additional information, which we can ignore</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">))</span> <span class="c1"># returns span a month, so I prefer to work with periods instead of dates</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The CRSP data files contains a small subset of all available CRSP data:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PERMNO</span></code> indicates permanent security identifiers, which is more reliable than tickers, which may change or be re-used by a different firm</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">date</span></code> indicates the last trading day of the month, which we convert to a year-month “period”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SHRCD</span></code> indicates share classes (e.g., A, B, and preferred), which I filtered to values of 10 or 11</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PRC</span></code> indicates the closing price on the last trading day of the month, and <code class="docutils literal notranslate"><span class="pre">PRC</span></code> is negative if it is the mean of the bid and ask prices instead of a price from an observed trade</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RET</span></code> indicates the holding period return as a simple return, including dividends</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SHROUT</span></code> indicates the number of shares outstanding in thousands (e.g., a <code class="docutils literal notranslate"><span class="pre">SHROUT</span></code> value of 1,000 indicates 1,000,000 shares)</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>SHRCD</th>
      <th>PRC</th>
      <th>RET</th>
      <th>SHROUT</th>
    </tr>
    <tr>
      <th>PERMNO</th>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">10000</th>
      <th>1986-01</th>
      <td>10</td>
      <td>-4.3750</td>
      <td>NaN</td>
      <td>3680.0000</td>
    </tr>
    <tr>
      <th>1986-02</th>
      <td>10</td>
      <td>-3.2500</td>
      <td>-0.2571</td>
      <td>3680.0000</td>
    </tr>
    <tr>
      <th>1986-03</th>
      <td>10</td>
      <td>-4.4375</td>
      <td>0.3654</td>
      <td>3680.0000</td>
    </tr>
    <tr>
      <th>1986-04</th>
      <td>10</td>
      <td>-4.0000</td>
      <td>-0.0986</td>
      <td>3793.0000</td>
    </tr>
    <tr>
      <th>1986-05</th>
      <td>10</td>
      <td>-3.1094</td>
      <td>-0.2227</td>
      <td>3793.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>These CRSP data are de-duplicated, but we should double-check for duplicate PERMNO-date pairs with the <code class="docutils literal notranslate"><span class="pre">.duplicated()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">crsp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>For fun, we can use these data to count the number of listed stocks each month and plot the trend of publicly listed stocks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)[</span><span class="s1">&#39;PRC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Publicly Listed Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time Series of the Number of Publicly Listed Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/06d274e77f5598275a25b58eda28b21f1f3fa77afa6386f506d66dfb80ec3216.png" src="_images/06d274e77f5598275a25b58eda28b21f1f3fa77afa6386f506d66dfb80ec3216.png" />
</div>
</div>
</section>
<section id="implement-a-momentum-investing-strategy">
<h3>Implement a Momentum Investing Strategy<a class="headerlink" href="#implement-a-momentum-investing-strategy" title="Permalink to this heading">#</a></h3>
<p>We will implement a momentum investing strategy with 1-month holding periods of equal-weighted portfolios formed on total returns from month -12 through month -2.
For example, at the start of January in year $t$, we assign stocks to 10 portfolios based on their total returns from January in year $t-1$ through November in year $t-1$.
Portfolio 1 has the lowest trailing returns, and portfolio 10 has the highest trailing returns.
We do not use the returns in month -1 for portfolio assignment because they would contaminate our portfolio returns with <a class="reference external" href="https://www.investopedia.com/ask/answers/013015/whats-difference-between-bidask-spread-and-bidask-bounce.asp">bid-ask bounce</a>.
For example, in our example above, we do not use returns from December in year $t-1$ to assign stocks to portfolios at the start of January in year $t$.</p>
<section id="calculate-1-month-and-11-month-returns">
<h4>Calculate 1-Month and 11-Month Returns<a class="headerlink" href="#calculate-1-month-and-11-month-returns" title="Permalink to this heading">#</a></h4>
<p>We will assign 1-month returns in month 0 to data frame <code class="docutils literal notranslate"><span class="pre">ret_1m</span></code>.
This calculation is easier in the wide format, but we will later use the long format.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_1m</span> <span class="o">=</span> <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;RET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>

<span class="n">ret_1m</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-08</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.0229</td>
      <td>0.1004</td>
      <td>NaN</td>
      <td>-0.0400</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.3474</td>
      <td>NaN</td>
      <td>-0.0725</td>
    </tr>
    <tr>
      <th>2022-09</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.2009</td>
      <td>-0.1376</td>
      <td>NaN</td>
      <td>-0.0051</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.4297</td>
      <td>NaN</td>
      <td>-0.0376</td>
    </tr>
    <tr>
      <th>2022-10</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.2599</td>
      <td>0.1406</td>
      <td>NaN</td>
      <td>0.0607</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.3562</td>
      <td>NaN</td>
      <td>-0.1422</td>
    </tr>
    <tr>
      <th>2022-11</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0803</td>
      <td>0.2021</td>
      <td>NaN</td>
      <td>0.0228</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.1212</td>
      <td>NaN</td>
      <td>-0.1443</td>
    </tr>
    <tr>
      <th>2022-12</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.0349</td>
      <td>-0.0473</td>
      <td>NaN</td>
      <td>-0.0108</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.3423</td>
      <td>NaN</td>
      <td>-0.3673</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>We will assign 11-month returns from month -12 to month -2 to data frame <code class="docutils literal notranslate"><span class="pre">ret_11m</span></code>.
The <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code> method does not have a <code class="docutils literal notranslate"><span class="pre">.prod()</span></code> method, so we will sum log returns instead of compounding simple returns, which speeds up our calculation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_11m</span> <span class="o">=</span> <span class="n">ret_1m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expm1</span><span class="p">)</span>

<span class="n">ret_11m</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-08</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.4788</td>
      <td>-0.0132</td>
      <td>NaN</td>
      <td>-0.0321</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.5058</td>
      <td>NaN</td>
      <td>0.0662</td>
    </tr>
    <tr>
      <th>2022-09</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.5697</td>
      <td>-0.1320</td>
      <td>NaN</td>
      <td>-0.0960</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.8298</td>
      <td>NaN</td>
      <td>-0.2857</td>
    </tr>
    <tr>
      <th>2022-10</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.3902</td>
      <td>-0.0169</td>
      <td>NaN</td>
      <td>-0.0224</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.6610</td>
      <td>NaN</td>
      <td>-0.4037</td>
    </tr>
    <tr>
      <th>2022-11</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.4342</td>
      <td>0.0929</td>
      <td>NaN</td>
      <td>-0.0113</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.5934</td>
      <td>NaN</td>
      <td>-0.4473</td>
    </tr>
    <tr>
      <th>2022-12</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>-0.4112</td>
      <td>0.2067</td>
      <td>NaN</td>
      <td>0.0760</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.3578</td>
      <td>NaN</td>
      <td>-0.6055</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>We should always check our work!
If we were to use this code in a production environment (i.e., run it frequently to make decisions), we would add <a class="reference external" href="https://en.wikipedia.org/wiki/Unit_testing">unit tests</a> to check our work.
We can use <code class="docutils literal notranslate"><span class="pre">PERMNO</span></code> 10010 to (very lightly) check our work.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">a</span><span class="o">=</span><span class="n">ret_1m</span><span class="p">[</span><span class="mi">10010</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">b</span><span class="o">=</span><span class="n">ret_11m</span><span class="p">[</span><span class="mi">10010</span><span class="p">],</span>
    <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="assign-stocks-to-portfolios-based-on-11-month-returns">
<h4>Assign Stocks to Portfolios Based on 11-Month Returns<a class="headerlink" href="#assign-stocks-to-portfolios-based-on-11-month-returns" title="Permalink to this heading">#</a></h4>
<p>We will use <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> to assign stocks to portfolios based on their 11-month trailing returns.
Here is a simple example that uses <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> to assign the values 0 to 24 to 10 portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 1,  1,  1,  2,  2,  3,  3,  3,  4,  4,  5,  5,  5,  6,  6,  7,  7,
        8,  8,  8,  9,  9, 10, 10, 10])
</pre></div>
</div>
</div>
</div>
<p>We will save these portfolio assignments to data frame <code class="docutils literal notranslate"><span class="pre">port_11m</span></code>.
The <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> function errs if we try to cut an array of all missing values, so we will use <code class="docutils literal notranslate"><span class="pre">.dropna(how='all')</span></code> to drop rows with all missing values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_11m</span> <span class="o">=</span> <span class="n">ret_11m</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">port_11m</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-08</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>3.0000</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-09</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>3.0000</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>6.0000</td>
    </tr>
    <tr>
      <th>2022-10</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>4.0000</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.0000</td>
      <td>NaN</td>
      <td>4.0000</td>
    </tr>
    <tr>
      <th>2022-11</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>4.0000</td>
      <td>9.0000</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>4.0000</td>
    </tr>
    <tr>
      <th>2022-12</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>4.0000</td>
      <td>9.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.0000</td>
      <td>NaN</td>
      <td>2.0000</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>Again. we should check our output, here with the last row of data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">a</span><span class="o">=</span><span class="n">port_11m</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">b</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ret_11m</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="combine-returns-and-portfolio-assignments">
<h4>Combine Returns and Portfolio Assignments<a class="headerlink" href="#combine-returns-and-portfolio-assignments" title="Permalink to this heading">#</a></h4>
<p>Next, we will use <code class="docutils literal notranslate"><span class="pre">pd.concat(axis=1)</span></code> to match returns and portfolio assignments.
We must <code class="docutils literal notranslate"><span class="pre">.shift(2)</span></code> the 11-month returns and portfolios assignments to avoid a look-ahead bias and drop month -1 returns.</p>
<ol class="arabic simple">
<li><p>The first shift makes sure we do not use contemporaneous returns to assign stocks to portfolios (i.e., otherwise the portfolio ranking and portfolio returns would overlap).</p></li>
<li><p>The second shift avoids mechanical correlations between returns one month and the next (i.e., bid-ask bounce and market microstructure noise).</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_0</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">ret_1m</span><span class="p">,</span> <span class="n">ret_11m</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">port_11m</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Return_Trailing&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;PERMNO&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Portfolio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_0</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Return</th>
      <th>Return_Trailing</th>
      <th>Portfolio</th>
    </tr>
    <tr>
      <th>date</th>
      <th>PERMNO</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1927-01</th>
      <th>10022</th>
      <td>-0.0759</td>
      <td>0.1182</td>
      <td>8</td>
    </tr>
    <tr>
      <th>10030</th>
      <td>0.0095</td>
      <td>0.0093</td>
      <td>6</td>
    </tr>
    <tr>
      <th>10057</th>
      <td>-0.0510</td>
      <td>-0.5918</td>
      <td>1</td>
    </tr>
    <tr>
      <th>10073</th>
      <td>0.0946</td>
      <td>-0.4286</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10081</th>
      <td>-0.0750</td>
      <td>-0.4194</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="evaluate-performance">
<h4>Evaluate Performance<a class="headerlink" href="#evaluate-performance" title="Permalink to this heading">#</a></h4>
<p>Is there a relation between returns from month -12 to month -2 and return in month 0?
We can use the <code class="docutils literal notranslate"><span class="pre">.corr()</span></code> to estimate this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_0</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Return</th>
      <th>Return_Trailing</th>
    </tr>
    <tr>
      <th>Variable</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Return</th>
      <td>1.0000</td>
      <td>0.0036</td>
    </tr>
    <tr>
      <th>Return_Trailing</th>
      <td>0.0036</td>
      <td>1.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This correlation is very weak!
But we expect we correlations based on pervious course topics.
We can try again with log returns, which may reduce the noise from outliers.
Recall $R_{Log} = log(1 + R_{Simple})$, which we can quickly implement with <code class="docutils literal notranslate"><span class="pre">.pipe(np.log1p)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_0</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>Return</th>
      <th>Return_Trailing</th>
    </tr>
    <tr>
      <th>Variable</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Return</th>
      <td>1.0000</td>
      <td>0.0486</td>
    </tr>
    <tr>
      <th>Return_Trailing</th>
      <td>0.0486</td>
      <td>1.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The correlation of log returns is larger, but still low because single-stock returns are noisy!
We can reduce this noise with portfolios formed on trailing returns.
We will equally weight the returns in each portfolio using <code class="docutils literal notranslate"><span class="pre">.mean()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mom_0</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Portfolio</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-01</th>
      <td>-0.0006</td>
      <td>0.0149</td>
      <td>0.0407</td>
      <td>0.0378</td>
      <td>0.0009</td>
      <td>0.0150</td>
      <td>0.0124</td>
      <td>0.0076</td>
      <td>-0.0044</td>
      <td>0.0126</td>
    </tr>
    <tr>
      <th>1927-02</th>
      <td>0.0641</td>
      <td>0.0484</td>
      <td>0.0866</td>
      <td>0.0745</td>
      <td>0.0480</td>
      <td>0.0547</td>
      <td>0.0561</td>
      <td>0.0403</td>
      <td>0.0579</td>
      <td>0.0541</td>
    </tr>
    <tr>
      <th>1927-03</th>
      <td>-0.0530</td>
      <td>-0.0381</td>
      <td>-0.0243</td>
      <td>-0.0408</td>
      <td>-0.0192</td>
      <td>-0.0201</td>
      <td>0.0108</td>
      <td>-0.0084</td>
      <td>-0.0058</td>
      <td>0.0012</td>
    </tr>
    <tr>
      <th>1927-04</th>
      <td>0.0207</td>
      <td>-0.0085</td>
      <td>-0.0054</td>
      <td>-0.0061</td>
      <td>0.0002</td>
      <td>-0.0032</td>
      <td>0.0137</td>
      <td>0.0030</td>
      <td>0.0307</td>
      <td>0.0421</td>
    </tr>
    <tr>
      <th>1927-05</th>
      <td>0.0069</td>
      <td>0.0353</td>
      <td>0.0604</td>
      <td>0.0635</td>
      <td>0.0700</td>
      <td>0.0950</td>
      <td>0.0796</td>
      <td>0.0838</td>
      <td>0.0803</td>
      <td>0.0886</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Next, we will plot the mean return for each portfolio.
We will convert these equal-weighted portfolio returns to percent, but leave them as monthly values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Monthly Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Momentum Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Performance of Momentum Investing&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mean Monthly Returns on Equal-Weighted Portfolios&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Formed on Months -12 to Month -2 Returns&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/45567aafbd0029384da805cd24632f5baa386cc58327d94e276e33fda75dad94.png" src="_images/45567aafbd0029384da805cd24632f5baa386cc58327d94e276e33fda75dad94.png" />
</div>
</div>
<p>Above, we see about a 75 basis point spread between the returns on portfolios 1 and 10, suggesting that momemtum investing generates excess returns.
We should also consider cumulative returns over holding periods longer than one month.
Next, we will plot the values of $1 invested in each portfolio.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value of \$1 Invested (\$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Performance of Momentum Investing&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value of $1 Invested in Equal-Weighted Portfolios&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Formed on Months -12 to Month -2 Returns&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2bfffe7ca96a6b5edd134bc8cf156762b68708f303dae84f9907c26ff8201781.png" src="_images/2bfffe7ca96a6b5edd134bc8cf156762b68708f303dae84f9907c26ff8201781.png" />
</div>
</div>
<p>Finally, we can estimate capital asset pricing model (CAPM) and Fama-French four-factor model (FF4) regressions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span>
<span class="p">)</span>

<span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RF</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07</th>
      <td>2.9600</td>
      <td>-2.5600</td>
      <td>-2.4300</td>
      <td>0.2200</td>
    </tr>
    <tr>
      <th>1926-08</th>
      <td>2.6400</td>
      <td>-1.1700</td>
      <td>3.8200</td>
      <td>0.2500</td>
    </tr>
    <tr>
      <th>1926-09</th>
      <td>0.3600</td>
      <td>-1.4000</td>
      <td>0.1300</td>
      <td>0.2300</td>
    </tr>
    <tr>
      <th>1926-10</th>
      <td>-3.2400</td>
      <td>-0.0900</td>
      <td>0.7000</td>
      <td>0.3200</td>
    </tr>
    <tr>
      <th>1926-11</th>
      <td>2.5300</td>
      <td>-0.1000</td>
      <td>-0.5100</td>
      <td>0.3100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_mom</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Momentum_Factor&#39;</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">)</span>
<span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mom</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-01</th>
      <td>0.3600</td>
    </tr>
    <tr>
      <th>1927-02</th>
      <td>-2.1400</td>
    </tr>
    <tr>
      <th>1927-03</th>
      <td>3.6100</td>
    </tr>
    <tr>
      <th>1927-04</th>
      <td>4.3000</td>
    </tr>
    <tr>
      <th>1927-05</th>
      <td>3.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">capm</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;I(Q(</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">) - RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">capm</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mom_ew</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">mom_ew</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">bses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">mom_ew</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">],</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">bses</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Equal-Weighted Monthly Alpha (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Momentum Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Performance of Momentum Investing&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">CAPM Alphas for Equal-Weighted Portfolios&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Formed on Months -12 to Month -2 Returns&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5a425b8630149006931e0cdfa23505979e83b45ef4f1ab66db93b19bb3105618.png" src="_images/5a425b8630149006931e0cdfa23505979e83b45ef4f1ab66db93b19bb3105618.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ff4</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;I(Q(</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">) - RF) ~ Q(&quot;Mkt-RF&quot;) + SMB + HML + Mom&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">ff4</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mom_ew</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">mom_ew</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">bses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">mom_ew</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">],</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">bses</span><span class="p">[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Equal-Weighted Monthly Alpha (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Momentum Portfolio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Performance of Momentum Investing&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">FF4 Alphas for Equal-Weighted Portfolios&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Formed on Months -12 to Month -2 Returns&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/515b74f596ee84d7c5796e7d3fec3d27c9044122c882246431d59e97623e1d54.png" src="_images/515b74f596ee84d7c5796e7d3fec3d27c9044122c882246431d59e97623e1d54.png" />
</div>
</div>
<p>In the FF4 model above, the alphas are abnormally large because we use equal-weighted portfolios, which overweight small stocks.
Because these portfolios overweight small stocks, these alphas make be associated with liquidity and difficult to earn at scale.
In the practice notebook, we will explore value-weighted portfolios and size investing strategies.</p>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-herron_06_practice"></span><section id="herron-topic-6-practice-blank">
<h3>Herron Topic 6 - Practice (Blank)<a class="headerlink" href="#herron-topic-6-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="reimplement-the-equal-weighted-momentum-investing-strategy-from-the-lecture-notebook">
<h5>Reimplement the equal-weighted momentum investing strategy from the lecture notebook<a class="headerlink" href="#reimplement-the-equal-weighted-momentum-investing-strategy-from-the-lecture-notebook" title="Permalink to this heading">#</a></h5>
<p>Try to use a few cells and temporary variables as you can (i.e., perform calculations inside <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code>).</p>
</section>
<section id="add-a-long-short-portfolio-that-is-long-portfolio-10-and-short-portfolio-1">
<h5>Add a long-short portfolio that is long portfolio 10 and short portfolio 1<a class="headerlink" href="#add-a-long-short-portfolio-that-is-long-portfolio-10-and-short-portfolio-1" title="Permalink to this heading">#</a></h5>
<p>Call this long-short portfolio UMD.
What are the best and worst months for portfolios 1, 10, and UMD?</p>
</section>
<section id="what-are-the-sharpe-ratios-on-these-11-portfolios">
<h5>What are the Sharpe Ratios on these 11 portfolios?<a class="headerlink" href="#what-are-the-sharpe-ratios-on-these-11-portfolios" title="Permalink to this heading">#</a></h5>
</section>
<section id="implement-a-value-weighted-momentum-investing-strategy">
<h5>Implement a value-weighted momentum investing strategy<a class="headerlink" href="#implement-a-value-weighted-momentum-investing-strategy" title="Permalink to this heading">#</a></h5>
<p>Assign this strategy to data frame <code class="docutils literal notranslate"><span class="pre">mom_vw</span></code>, and include long-short portfolio UMD</p>
</section>
<section id="what-are-the-capm-and-ff4-alphas-for-these-value-weighted-portfolios">
<h5>What are the CAPM and FF4 alphas for these value-weighted portfolios?<a class="headerlink" href="#what-are-the-capm-and-ff4-alphas-for-these-value-weighted-portfolios" title="Permalink to this heading">#</a></h5>
</section>
<section id="what-are-the-sharpe-ratios-for-these-value-weighted-portfolios">
<h5>What are the Sharpe Ratios for these value-weighted portfolios?<a class="headerlink" href="#what-are-the-sharpe-ratios-for-these-value-weighted-portfolios" title="Permalink to this heading">#</a></h5>
</section>
<section id="implement-an-equal-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month">
<h5>Implement an equal-weighted size investing strategy based on market capitalization at the start of each month<a class="headerlink" href="#implement-an-equal-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month" title="Permalink to this heading">#</a></h5>
</section>
<section id="implement-a-value-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month">
<h5>Implement a value-weighted size investing strategy based on market capitalization at the start of each month<a class="headerlink" href="#implement-a-value-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month" title="Permalink to this heading">#</a></h5>
</section>
</section>
</section>
<span id="document-herron_06_practice_03"></span><section id="herron-topic-6-practice-monday-2-45-pm-section-3">
<h3>Herron Topic 6 - Practice (Monday 2:45 PM, Section 3)<a class="headerlink" href="#herron-topic-6-practice-monday-2-45-pm-section-3" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 6 mean and median were about ~~90% and 96%~~  92% and 100%</p>
<ul>
<li><p>Please see the solution on Canvas and let me know if you have any questions</p></li>
<li><p>Gradescope shows which hidden tests you missed</p></li>
<li><p>I recently widened the tolerance on two hidden tests to give full credit if you minimized variance instead of volatility</p></li>
</ul>
</li>
<li><p>I posted <a class="reference internal" href="_introduction.html#document-project_02"><span class="doc std std-doc">project 2</span></a> about Bitcoin and gold as inflation and market risk hedges</p></li>
<li><p>Next week (week of 4/10) is the assessment exam</p>
<ul>
<li><p>MSFQ students must take it for 5% of overall course grade</p></li>
<li><p>Non-MSQF students do not take it and weight their grades by only 95%</p></li>
<li><p>20 multiple choice questions on the 6 core courses (corporate finance, investments, math, data analytics, empirical methods, and derivatives)</p></li>
<li><p><em><strong>You must be in the classroom during your assigned date and time to take the MSFQ assessment exam</strong></em></p></li>
<li><p>If there is interest, we will discuss five stylized facts of asset returns after the MSFQ assessment exam</p></li>
<li><p>We will also have our final quiz, quiz 7</p></li>
</ul>
</li>
<li><p>The following week (week of 4/17) we will discuss Herron topic 5 (simulations)</p>
<ul>
<li><p>I will record a lecture video and complete a practice notebook</p></li>
<li><p>But we will reserve class time for group work</p></li>
<li><p>The class voted about 2-to-1 not to drop a topic, so this is a compromise, given that Monday is Patriot’s Day holiday</p></li>
</ul>
</li>
<li><p>The following week (week of 4/24) we will reserve class time for group work</p>
<ul>
<li><p>Project 2 is due Wednesday, 4/26, at 11:59 PM</p></li>
<li><p>Teammates Review 2 is due Wednesday, 4/26, at 11:59 PM</p></li>
<li><p>30,000 DataCamp XP are due Friday, 4/28, at 11:59 PM</p></li>
</ul>
</li>
<li><p><em><strong>Somewhere in there, please reserve 10 minutes to complete a TRACE review for this course</strong></em></p>
<ul>
<li><p>I cannot make you complete TRACE reviews</p></li>
<li><p>But they are very helpful</p></li>
<li><p>I change my courses every semester, hopefully for the better, based on TRACE reviews</p></li>
</ul>
</li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="reimplement-the-equal-weighted-momentum-investing-strategy-from-the-lecture-notebook">
<h5>Reimplement the equal-weighted momentum investing strategy from the lecture notebook<a class="headerlink" href="#reimplement-the-equal-weighted-momentum-investing-strategy-from-the-lecture-notebook" title="Permalink to this heading">#</a></h5>
<p>Try to use a few cells and temporary variables as you can (i.e., perform calculations inside <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">filepath_or_buffer</span><span class="o">=</span><span class="s1">&#39;crsp.csv&#39;</span><span class="p">,</span>
        <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
        <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="c1"># we can ignore returns coded as A, B, or C</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">),</span> <span class="c1"># I prefer periods to dates for monthly data</span>
        <span class="n">ME</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;PRC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SHROUT&#39;</span><span class="p">]</span> <span class="c1"># market value of equity in thousands of dollars</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Please the <a class="reference internal" href="_introduction.html#document-herron_06_lecture"><span class="doc std std-doc">Herron Topic 6 lecture notebook</span></a> for variable definitions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>SHRCD</th>
      <th>PRC</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>ME</th>
    </tr>
    <tr>
      <th>PERMNO</th>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">10000</th>
      <th>1986-01</th>
      <td>10</td>
      <td>-4.3750</td>
      <td>NaN</td>
      <td>3680.0000</td>
      <td>16100.0000</td>
    </tr>
    <tr>
      <th>1986-02</th>
      <td>10</td>
      <td>-3.2500</td>
      <td>-0.2571</td>
      <td>3680.0000</td>
      <td>11960.0000</td>
    </tr>
    <tr>
      <th>1986-03</th>
      <td>10</td>
      <td>-4.4375</td>
      <td>0.3654</td>
      <td>3680.0000</td>
      <td>16330.0000</td>
    </tr>
    <tr>
      <th>1986-04</th>
      <td>10</td>
      <td>-4.0000</td>
      <td>-0.0986</td>
      <td>3793.0000</td>
      <td>15172.0000</td>
    </tr>
    <tr>
      <th>1986-05</th>
      <td>10</td>
      <td>-3.1094</td>
      <td>-0.2227</td>
      <td>3793.0000</td>
      <td>11793.8783</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Variable</th>
      <th>SHRCD</th>
      <th>PRC</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>ME</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>3794898.0000</td>
      <td>3692827.0000</td>
      <td>3664978.0000</td>
      <td>3791120.0000</td>
      <td>3692827.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>10.7392</td>
      <td>31.8232</td>
      <td>0.0115</td>
      <td>44254.7485</td>
      <td>1822175.8177</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.4390</td>
      <td>1835.1071</td>
      <td>0.1799</td>
      <td>249579.2094</td>
      <td>16811017.1404</td>
    </tr>
    <tr>
      <th>min</th>
      <td>10.0000</td>
      <td>-1832.5000</td>
      <td>-0.9957</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>10.0000</td>
      <td>1.8750</td>
      <td>-0.0648</td>
      <td>2288.0000</td>
      <td>16949.2500</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>11.0000</td>
      <td>11.0000</td>
      <td>0.0000</td>
      <td>7336.0000</td>
      <td>73164.0000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>11.0000</td>
      <td>25.8000</td>
      <td>0.0700</td>
      <td>25600.0000</td>
      <td>403080.1875</td>
    </tr>
    <tr>
      <th>max</th>
      <td>11.0000</td>
      <td>528921.0000</td>
      <td>24.0000</td>
      <td>29206400.0000</td>
      <td>2902368140.5592</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To implement a momentum strategy, we need:</p>
<ol class="arabic simple">
<li><p>1-month returns, which are the returns we receive for each holding period</p></li>
<li><p>11-month returns, which are the returns (from month -12 to month -2) that we use to rank stocks and assign to momentum portfolios</p></li>
<li><p>Momentum portfolio assignments based on 11-month trailing returns</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_1m</span> <span class="o">=</span> <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;RET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>There is not a <code class="docutils literal notranslate"><span class="pre">.prod()</span></code> method for <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code>, so the fastest way to calculate 11-month rolling returns is to:</p>
<ol class="arabic simple">
<li><p>Convert simple returns to log returns with <code class="docutils literal notranslate"><span class="pre">.pipe(np.log1p)</span></code></p></li>
<li><p>Calculate 11-month rolling <em>log</em> returns with <code class="docutils literal notranslate"><span class="pre">.rolling(11).sum()</span></code></p></li>
<li><p>Convert log returns to simple returns with <code class="docutils literal notranslate"><span class="pre">.pipe(np.expm1)</span></code></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_11m</span> <span class="o">=</span> <span class="n">ret_1m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expm1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we use <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> to assign <code class="docutils literal notranslate"><span class="pre">ret_11m</span></code> to ten momentum portfolios.
Here is a simple example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9])
</pre></div>
</div>
</div>
</div>
<p>Here are the momentum portfolios:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_11m</span> <span class="o">=</span> <span class="n">ret_11m</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Short-term reversal, momentum, and long-term reversal represent distinct aspects of asset price behavior that have been observed and documented in the financial markets. As a researcher, I am particularly interested in understanding the underlying factors that contribute to these market anomalies and their implications for trading strategies and portfolio management.</p>
<p>Short-term reversal captures the tendency of asset prices to reverse direction in a brief period, typically days to weeks. This phenomenon can be associated with market overreactions to news events, temporary liquidity constraints, or other transient factors. Astute investors may capitalize on these short-term reversals by adopting a contrarian approach, buying assets that have recently underperformed and selling those that have outperformed.</p>
<p>Momentum represents the persistence of asset price trends over a short to medium-term horizon, typically ranging from 3 to 12 months. This market anomaly suggests that assets with strong recent performance continue to outperform, while poorly performing assets continue to underperform. Momentum can be linked to factors such as investors’ behavioral biases, positive feedback trading, and herd mentality. To exploit momentum, investors may adopt a trend-following strategy, buying assets with strong recent performance and selling those with weak performance.</p>
<p>Long-term reversal, often referred to as mean reversion, is the tendency of asset prices to revert to their long-term average or fundamental value over an extended period, typically several years. This phenomenon is thought to result from market participants gradually recognizing and correcting mispricing, leading to price adjustments. Investors following a long-term reversal strategy may focus on assets with extreme valuation levels, buying undervalued assets and selling overvalued ones, with the expectation that prices will eventually revert to their long-term mean.</p>
<p><em><strong>To avoid short-term reversal, we skip one month between 11-month returns and portfolio formation.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ret_1m</span><span class="p">,</span> <span class="c1"># holding period return</span>
            <span class="n">ret_11m</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="c1"># trailing returns</span>
            <span class="n">port_11m</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="c1"># portfolio assignment based on trailing return</span>
            <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># beginning-of-month market value of equity</span>
        <span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailing Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailing ME&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Portfolio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mom</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># simple mean is an equal-weighted portfolio return</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Mom &#39;</span><span class="p">)</span> <span class="c1"># simplifies regression specifications below</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Portfolio</th>
      <th>Mom 1</th>
      <th>Mom 2</th>
      <th>Mom 3</th>
      <th>Mom 4</th>
      <th>Mom 5</th>
      <th>Mom 6</th>
      <th>Mom 7</th>
      <th>Mom 8</th>
      <th>Mom 9</th>
      <th>Mom 10</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-01</th>
      <td>-0.0006</td>
      <td>0.0149</td>
      <td>0.0425</td>
      <td>0.0378</td>
      <td>0.0009</td>
      <td>0.0150</td>
      <td>0.0124</td>
      <td>0.0076</td>
      <td>-0.0044</td>
      <td>0.0126</td>
    </tr>
    <tr>
      <th>1927-02</th>
      <td>0.0641</td>
      <td>0.0484</td>
      <td>0.0866</td>
      <td>0.0745</td>
      <td>0.0436</td>
      <td>0.0547</td>
      <td>0.0561</td>
      <td>0.0403</td>
      <td>0.0579</td>
      <td>0.0541</td>
    </tr>
    <tr>
      <th>1927-03</th>
      <td>-0.0530</td>
      <td>-0.0381</td>
      <td>-0.0243</td>
      <td>-0.0408</td>
      <td>-0.0192</td>
      <td>-0.0201</td>
      <td>0.0097</td>
      <td>-0.0084</td>
      <td>-0.0058</td>
      <td>0.0012</td>
    </tr>
    <tr>
      <th>1927-04</th>
      <td>0.0230</td>
      <td>-0.0085</td>
      <td>-0.0054</td>
      <td>-0.0061</td>
      <td>0.0002</td>
      <td>-0.0032</td>
      <td>0.0138</td>
      <td>0.0030</td>
      <td>0.0323</td>
      <td>0.0421</td>
    </tr>
    <tr>
      <th>1927-05</th>
      <td>0.0069</td>
      <td>0.0353</td>
      <td>0.0604</td>
      <td>0.0536</td>
      <td>0.0700</td>
      <td>0.0950</td>
      <td>0.0796</td>
      <td>0.0838</td>
      <td>0.0803</td>
      <td>0.0886</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We see a (nearly) monotonic relation between momentum portfolios (based on trailing 11-month returns) and holding period returns!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Monthly Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Strategy</span><span class="se">\n</span><span class="s1"> Equal-Weighted Portfolios</span><span class="se">\n</span><span class="s1">Formed on Months -12 to -2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dcee11a00fc596db568bc2b9d9a59c1ad3c930ab1393a44d9ab81f82af9fe5b0.png" src="_images/dcee11a00fc596db568bc2b9d9a59c1ad3c930ab1393a44d9ab81f82af9fe5b0.png" />
</div>
</div>
<p>This relation is stronger when we consider long-term, buy-and-hold returns!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value of $1 Investment ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Strategy</span><span class="se">\n</span><span class="s1"> Equal-Weighted Portfolios</span><span class="se">\n</span><span class="s1">Formed on Months -12 to -2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/926694910f626f471321b9624464058f45fc236a7e4ba5d6cd066f7a37832bd1.png" src="_images/926694910f626f471321b9624464058f45fc236a7e4ba5d6cd066f7a37832bd1.png" />
</div>
</div>
</section>
<section id="add-a-long-short-portfolio-that-is-long-portfolio-10-and-short-portfolio-1">
<h5>Add a long-short portfolio that is long portfolio 10 and short portfolio 1<a class="headerlink" href="#add-a-long-short-portfolio-that-is-long-portfolio-10-and-short-portfolio-1" title="Permalink to this heading">#</a></h5>
<p>Call this long-short portfolio UMD.
What are the best and worst months for portfolios 1, 10, and UMD?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span> <span class="o">=</span> <span class="n">mom_ew</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">UMD</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mom 10&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mom 1&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The worst month for the long-short portfolio is during the Great Depression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="p">[</span><span class="s1">&#39;UMD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Period(&#39;1932-08&#39;, &#39;M&#39;)
</pre></div>
</div>
</div>
</div>
<p>Momentum strategies appear to generate large absolute returns.
However, long-short momentum strategies are occasionally wiped out by large market recoveries, that the short side of the portfolio does not survive in practice.
During downturns, the short side of the portfolio (i.e., the loser stocks) has a high beta.
When the market unexpectedly and quickly recovers, the exaggerated recovery in the high-beta stocks wipes out the long-short portfolio.
For example, if we invest $1 in the long-short portfolio at the end of 1929, the long-short portfolio is effectively wiped out during August 1932.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;1930&#39;</span><span class="p">:</span><span class="s1">&#39;1932&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Mom 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Mom 10&#39;</span><span class="p">,</span> <span class="s1">&#39;UMD&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value of $1 Investment ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Strategy</span><span class="se">\n</span><span class="s1"> Equal-Weighted Portfolios</span><span class="se">\n</span><span class="s1">Formed on Months -12 to -2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4162e1d75dbe30fb44095151c1aa1734e90e085b17d4b8236c0f127dd64e09f2.png" src="_images/4162e1d75dbe30fb44095151c1aa1734e90e085b17d4b8236c0f127dd64e09f2.png" />
</div>
</div>
</section>
<section id="what-are-the-capm-and-ff4-alphas-for-these-equal-weighted-portfolios">
<h5>What are the CAPM and FF4 alphas for these equal-weighted portfolios?<a class="headerlink" href="#what-are-the-capm-and-ff4-alphas-for-these-equal-weighted-portfolios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>After class, I made the following code more repeatable.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">capm</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot;)-RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_mom</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Momentum_Factor&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mom&#39;</span><span class="p">]</span> <span class="c1"># we need to rename the Mom factor to remove leading and trailing whitespace</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function accepts a data frame of returns and factors data, a factor model regression function name, and number $n$ for the first $n$ columns in the data frame.
The factor model regression function must return a statsmodel model.
The <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function returns a data frame of coefficient estimates and standard errors.
We can use the <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function to quickly apply a factor model regression function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_coefs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="n">n</span><span class="p">]]</span>
    <span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">ses</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">coefs</span><span class="p">,</span> <span class="n">ses</span><span class="p">],</span> 
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Coef&#39;</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">],</span> 
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Statistic&#39;</span><span class="p">],</span> 
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">plot_alpha()</span></code> function accepts the output of the <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function and plots portfolio alphas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_alpha</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span>
    <span class="n">_</span><span class="p">[</span><span class="s1">&#39;Coef&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">_</span><span class="p">[</span><span class="s1">&#39;SE&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Monthly Alpha (%)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can look at the output of <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code>, but I typically will chain these functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Statistic</th>
      <th colspan="2" halign="left">Coef</th>
      <th colspan="2" halign="left">SE</th>
    </tr>
    <tr>
      <th>Variable</th>
      <th>Intercept</th>
      <th>Q("Mkt-RF")</th>
      <th>Intercept</th>
      <th>Q("Mkt-RF")</th>
    </tr>
    <tr>
      <th>Portfolio</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Mom 1</th>
      <td>-0.2642</td>
      <td>1.6488</td>
      <td>0.2364</td>
      <td>0.0438</td>
    </tr>
    <tr>
      <th>Mom 2</th>
      <td>-0.2485</td>
      <td>1.4625</td>
      <td>0.1550</td>
      <td>0.0287</td>
    </tr>
    <tr>
      <th>Mom 3</th>
      <td>-0.1499</td>
      <td>1.3130</td>
      <td>0.1170</td>
      <td>0.0216</td>
    </tr>
    <tr>
      <th>Mom 4</th>
      <td>0.0747</td>
      <td>1.2729</td>
      <td>0.1071</td>
      <td>0.0198</td>
    </tr>
    <tr>
      <th>Mom 5</th>
      <td>0.1002</td>
      <td>1.1657</td>
      <td>0.0874</td>
      <td>0.0162</td>
    </tr>
    <tr>
      <th>Mom 6</th>
      <td>0.2728</td>
      <td>1.1267</td>
      <td>0.0786</td>
      <td>0.0146</td>
    </tr>
    <tr>
      <th>Mom 7</th>
      <td>0.3420</td>
      <td>1.0899</td>
      <td>0.0778</td>
      <td>0.0144</td>
    </tr>
    <tr>
      <th>Mom 8</th>
      <td>0.4860</td>
      <td>1.0698</td>
      <td>0.0794</td>
      <td>0.0147</td>
    </tr>
    <tr>
      <th>Mom 9</th>
      <td>0.5828</td>
      <td>1.0881</td>
      <td>0.0882</td>
      <td>0.0163</td>
    </tr>
    <tr>
      <th>Mom 10</th>
      <td>0.7466</td>
      <td>1.1711</td>
      <td>0.1273</td>
      <td>0.0236</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The beauty of chaining these functions is:</p>
<ol class="arabic simple">
<li><p>We have all calculations in one cell, eliminating the need to track many “off screen” calculations in other cells</p></li>
<li><p>We do not create intermediate data frames, eliminating the need to name and track many data frames</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5e1e913e1de9ed0d78aede753ac097b65b1979e747744da61ed4e7ca405d0adc.png" src="_images/5e1e913e1de9ed0d78aede753ac097b65b1979e747744da61ed4e7ca405d0adc.png" />
</div>
</div>
<p>The momentum strategy has a large, positive, statistically significant alpha, suggesting it is a source of risk-adjusted returns (i.e., returns not associated with risk).
However, we saw above that momentum occasionally crashes, suggesting that the momentum strategy has risk.
We will investigate this with the Fama-French Four-Factor model, which add size, value, and momentum factors.
Once we consider SMB, HML, and Mom risk factors, we see:</p>
<ol class="arabic simple">
<li><p>The relation between returns and momentum portfolios is much weaker and not monotonic</p></li>
<li><p>The statistical significance of the alpha coefficient estimates is much lower.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ff4</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot;)-RF) ~ Q(&quot;Mkt-RF&quot;) + SMB + HML + Mom&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/49d58b0e8f4a15b5f64c08669380a620a5477c654dbd2bd39d8fe61718b6edb4.png" src="_images/49d58b0e8f4a15b5f64c08669380a620a5477c654dbd2bd39d8fe61718b6edb4.png" />
</div>
</div>
<p>A more extreme test is to only consider the last 20 years of returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">240</span><span class="p">:]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/61e94dbb15479ee32c7ad18ef05875f96952d508778d361dacb6f9ec0d32fdaa.png" src="_images/61e94dbb15479ee32c7ad18ef05875f96952d508778d361dacb6f9ec0d32fdaa.png" />
</div>
</div>
</section>
<section id="what-are-the-sharpe-ratios-on-these-11-portfolios">
<h5>What are the Sharpe Ratios on these 11 portfolios?<a class="headerlink" href="#what-are-the-sharpe-ratios-on-these-11-portfolios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">er</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Sharpe Ratios for Momentum Strategy Relative to RF&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e3f863714a8690aab96231d2252fbc1266e1eb8df9a55c92216420269382a89e.png" src="_images/e3f863714a8690aab96231d2252fbc1266e1eb8df9a55c92216420269382a89e.png" />
</div>
</div>
</section>
<section id="implement-a-value-weighted-momentum-investing-strategy">
<h5>Implement a value-weighted momentum investing strategy<a class="headerlink" href="#implement-a-value-weighted-momentum-investing-strategy" title="Permalink to this heading">#</a></h5>
<p>Assign this strategy to data frame <code class="docutils literal notranslate"><span class="pre">mom_vw</span></code>, and include long-short portfolio UMD</p>
<p>We can replace the <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> method, which calculates simple means (i.e., equal-weighted means), with the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method and <code class="docutils literal notranslate"><span class="pre">np.average()</span></code> function, which has a <code class="docutils literal notranslate"><span class="pre">weights=</span></code> argument and calculates weighted means.
We weight portfolio returns by the beginning-of-month marker value of equity in the <code class="docutils literal notranslate"><span class="pre">Trailing</span> <span class="pre">ME</span></code> column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mom</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Trailing ME&#39;</span><span class="p">]))</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Mom &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-are-the-capm-and-ff4-alphas-for-these-value-weighted-portfolios">
<h5>What are the CAPM and FF4 alphas for these value-weighted portfolios?<a class="headerlink" href="#what-are-the-capm-and-ff4-alphas-for-these-value-weighted-portfolios" title="Permalink to this heading">#</a></h5>
<p>The alphas for the value-weighted momentum portfolios are generally smaller in magnitude than for the equal-weighted momentum portfolios.
Equal-weighted portfolios over-weight small stocks relative to value-weighted portfolios, and we expect most anomalies to be stronger in small stocks because small stocks are more difficult for institutional investors to  invest in at scale.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ced34c2a1d5da1a44cb646030a067d3e0a7d3f3faa565e7aa4f78e1952078890.png" src="_images/ced34c2a1d5da1a44cb646030a067d3e0a7d3f3faa565e7aa4f78e1952078890.png" />
</div>
</div>
<p>The momentum strategy falls apart once we consider the Fama-French Four-Factor model with value-weighted portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/66e40b5dd92b6085cded9eeb7d2c959f470ca8560f6630174d8dc1235085e3d4.png" src="_images/66e40b5dd92b6085cded9eeb7d2c959f470ca8560f6630174d8dc1235085e3d4.png" />
</div>
</div>
</section>
<section id="what-are-the-sharpe-ratios-for-these-value-weighted-portfolios">
<h5>What are the Sharpe Ratios for these value-weighted portfolios?<a class="headerlink" href="#what-are-the-sharpe-ratios-for-these-value-weighted-portfolios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Sharpe Ratios for Momentum Strategy Relative to RF&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed on Months -12 to -2&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f7a171cb8d4193690488883353b1ad5d1c1208f33f2581c2d2f6b793b9526043.png" src="_images/f7a171cb8d4193690488883353b1ad5d1c1208f33f2581c2d2f6b793b9526043.png" />
</div>
</div>
</section>
<section id="implement-an-equal-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june">
<h5>Implement an equal-weighted size investing strategy based on market capitalization ~~at the start of each month~~ from the previous June<a class="headerlink" href="#implement-an-equal-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june" title="Permalink to this heading">#</a></h5>
<p><em><strong>To show how to form portfolios at lower frequencies, I change this task to form portfolios once a year based on market capitalization from the previous June.</strong></em>
We will assign stocks to portfolios based on market capitalization (i.e., size or the market value of equity) each June and use these portfolio assignments from July through the following June.
That is, we rank in June of year $t$, then hold them in portfolios from July in year $t$ through June in year $t+1$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span> <span class="o">=</span> <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>59400.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1927-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>59400.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1928-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>57675.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1929-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>57900.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1930-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>30900.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>Next we assign portfolios on these June market capitalizations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1927-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1928-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1929-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1930-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>Note, we want to use these portfolio assignments from July through June, so we need to <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> with <code class="docutils literal notranslate"><span class="pre">freq='1M'</span></code>, which shifts the index one month instead of shifting the values one row.
Because we only have June data, a one-row shift is a one-year shift instead of a one-month shift.
We also need to up sample our June data to monthly date with <code class="docutils literal notranslate"><span class="pre">.resample('M')</span></code> and the <code class="docutils literal notranslate"><span class="pre">.ffill()</span></code> method.
Because we only want to fill forward 12 months, we use <code class="docutils literal notranslate"><span class="pre">.ffill(limit=12)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-03</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-04</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>6.0000</td>
      <td>4.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>We can combine the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code>, <code class="docutils literal notranslate"><span class="pre">.shift()</span></code>, <code class="docutils literal notranslate"><span class="pre">.resample()</span></code>, and <code class="docutils literal notranslate"><span class="pre">.fill()</span></code> methods into one operation when we combine the returns, trailing market capitalization, and portfolio assignments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ret_1m</span><span class="p">,</span>
            <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="n">me_june</span>
                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailing ME&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Portfolio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Return</th>
      <th>Trailing ME</th>
      <th>Portfolio</th>
    </tr>
    <tr>
      <th>date</th>
      <th>PERMNO</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1926-07</th>
      <th>10022</th>
      <td>0.2400</td>
      <td>10000.0000</td>
      <td>5</td>
    </tr>
    <tr>
      <th>10030</th>
      <td>0.0211</td>
      <td>19402.5000</td>
      <td>6</td>
    </tr>
    <tr>
      <th>10057</th>
      <td>0.0078</td>
      <td>4031.2500</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10073</th>
      <td>0.0729</td>
      <td>1656.0000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>10081</th>
      <td>0.0156</td>
      <td>9536.0000</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_ew</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">me</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;ME &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8872db5b249404c8e14edbab82f5358ec876d78ae3ef3d65305b1190711b891a.png" src="_images/8872db5b249404c8e14edbab82f5358ec876d78ae3ef3d65305b1190711b891a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/da1a5df44d3d573abd9b0e06810182e2faf2d6075d7ba52d9720be73ab245739.png" src="_images/da1a5df44d3d573abd9b0e06810182e2faf2d6075d7ba52d9720be73ab245739.png" />
</div>
</div>
<p>If we had more time to dig into the size investing strategy, we would find:</p>
<ol class="arabic simple">
<li><p>The alpha is concentrated in January due to tax loss harvesting, where investors sell their losers in December and buy them back in January to earn a tax deduction</p></li>
<li><p>The smallest stocks in the ME 1 portfolio are tiny, making them impractical for institutional investors and allowing the anomaly to persist (because these stocks are small and illiquid, the size factor does not try to explain away their alpha)</p></li>
</ol>
<p>We can quickly see the point 2 above by plotting the mean marker capitalization for each portfolio.
This analysis is “quick and dirty” because we have not inflation adjusted these values.
Still, we quickly see that the ME 10 stocks are 1,000 times larger than the ME 1 stocks, on average.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">me</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Trailing ME&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;ME &#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Market Value of Equity (Nominal U.S. Dollars)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Market Value of Stocks in ME Portfolios&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9912623f731b1538e1491a458598c59c8be346a294d6d950902f235fd10a843d.png" src="_images/9912623f731b1538e1491a458598c59c8be346a294d6d950902f235fd10a843d.png" />
</div>
</div>
</section>
<section id="implement-a-value-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june">
<h5>Implement a value-weighted size investing strategy based on market capitalization ~~at the start of each month~~ from the previous June<a class="headerlink" href="#implement-a-value-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june" title="Permalink to this heading">#</a></h5>
<p>With value-weighted portfolios, the size investing strategy alphas disappear!
The alpha disappears because value-weighted portfolios down weight the smallest of the smallest stocks that made the size investing strategy appear to be returns not explained by risk.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_vw</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">me</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Trailing ME&#39;</span><span class="p">]))</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;ME &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3f1ab9c29b78dcf3f973dbae288263b3138d8bf9faea23b8554377f0023b8978.png" src="_images/3f1ab9c29b78dcf3f973dbae288263b3138d8bf9faea23b8554377f0023b8978.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8e1d15ddfe810ce7dbb2eed7e8f77fe665b0dbd55e16bed2bd257f7354616cac.png" src="_images/8e1d15ddfe810ce7dbb2eed7e8f77fe665b0dbd55e16bed2bd257f7354616cac.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-herron_06_practice_04"></span><section id="herron-topic-6-practice-wednesday-11-45-am-section-4">
<h3>Herron Topic 6 - Practice (Wednesday 11:45 AM, Section 4)<a class="headerlink" href="#herron-topic-6-practice-wednesday-11-45-am-section-4" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 6 mean and median were about ~~90% and 96%~~  92% and 100%</p>
<ul>
<li><p>Please see the solution on Canvas and let me know if you have any questions</p></li>
<li><p>Gradescope shows which hidden tests you missed</p></li>
<li><p>I recently widened the tolerance on two hidden tests to give full credit if you minimized variance instead of volatility</p></li>
</ul>
</li>
<li><p>I posted <a class="reference internal" href="_introduction.html#document-project_02"><span class="doc std std-doc">project 2</span></a> about Bitcoin and gold as inflation and market risk hedges</p></li>
<li><p>Next week (week of 4/10) is the assessment exam</p>
<ul>
<li><p>MSFQ students must take it for 5% of overall course grade</p></li>
<li><p>Non-MSQF students do not take it and weight their grades by only 95%</p></li>
<li><p>20 multiple choice questions on the 6 core courses (corporate finance, investments, math, data analytics, empirical methods, and derivatives)</p></li>
<li><p><em><strong>You must be in the classroom during your assigned date and time to take the MSFQ assessment exam</strong></em></p></li>
<li><p>If there is interest, we will discuss five stylized facts of asset returns after the MSFQ assessment exam</p></li>
<li><p>We will also have our final quiz, quiz 7</p></li>
</ul>
</li>
<li><p>The following week (week of 4/17) we will discuss Herron topic 5 (simulations)</p>
<ul>
<li><p>I will record a lecture video and complete a practice notebook</p></li>
<li><p>But we will reserve class time for group work</p></li>
<li><p>The class voted about 2-to-1 not to drop a topic, so this is a compromise, given that Monday is Patriot’s Day holiday</p></li>
</ul>
</li>
<li><p>The following week (week of 4/24) we will reserve class time for group work</p>
<ul>
<li><p>Project 2 is due Wednesday, 4/26, at 11:59 PM</p></li>
<li><p>Teammates Review 2 is due Wednesday, 4/26, at 11:59 PM</p></li>
<li><p>30,000 DataCamp XP are due Friday, 4/28, at 11:59 PM</p></li>
</ul>
</li>
<li><p><em><strong>Somewhere in there, please reserve 10 minutes to complete a TRACE review for this course</strong></em></p>
<ul>
<li><p>I cannot make you complete TRACE reviews</p></li>
<li><p>But they are very helpful</p></li>
<li><p>I change my courses every semester, hopefully for the better, based on TRACE reviews</p></li>
</ul>
</li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="reimplement-the-equal-weighted-momentum-investing-strategy-from-the-lecture-notebook">
<h5>Reimplement the equal-weighted momentum investing strategy from the lecture notebook<a class="headerlink" href="#reimplement-the-equal-weighted-momentum-investing-strategy-from-the-lecture-notebook" title="Permalink to this heading">#</a></h5>
<p>Try to use a few cells and temporary variables as you can (i.e., perform calculations inside <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">filepath_or_buffer</span><span class="o">=</span><span class="s1">&#39;crsp.csv&#39;</span><span class="p">,</span>
        <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
        <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="c1"># CRSP uses letter codes to provide additional information, which we can ignore</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">),</span> <span class="c1"># returns span a month, so I prefer to work with periods instead of dates</span>
        <span class="n">ME</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;PRC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SHROUT&#39;</span><span class="p">]</span> <span class="c1"># market value of equity in thousands of dollars</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Please the <a class="reference internal" href="_introduction.html#document-herron_06_lecture"><span class="doc std std-doc">Herron Topic 6 lecture notebook</span></a> for variable definitions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>SHRCD</th>
      <th>PRC</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>ME</th>
    </tr>
    <tr>
      <th>PERMNO</th>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">10000</th>
      <th>1986-01</th>
      <td>10</td>
      <td>-4.3750</td>
      <td>NaN</td>
      <td>3680.0000</td>
      <td>16100.0000</td>
    </tr>
    <tr>
      <th>1986-02</th>
      <td>10</td>
      <td>-3.2500</td>
      <td>-0.2571</td>
      <td>3680.0000</td>
      <td>11960.0000</td>
    </tr>
    <tr>
      <th>1986-03</th>
      <td>10</td>
      <td>-4.4375</td>
      <td>0.3654</td>
      <td>3680.0000</td>
      <td>16330.0000</td>
    </tr>
    <tr>
      <th>1986-04</th>
      <td>10</td>
      <td>-4.0000</td>
      <td>-0.0986</td>
      <td>3793.0000</td>
      <td>15172.0000</td>
    </tr>
    <tr>
      <th>1986-05</th>
      <td>10</td>
      <td>-3.1094</td>
      <td>-0.2227</td>
      <td>3793.0000</td>
      <td>11793.8783</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To implement a momentum strategy, we need:</p>
<ol class="arabic simple">
<li><p>1-month returns, which are the returns we receive for each holding period</p></li>
<li><p>11-month returns, which are the returns (from month -12 to month -2) that we use to rank stocks and assign to momentum portfolios</p></li>
<li><p>Momentum portfolio assignments based on 11-month trailing returns</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_1m</span> <span class="o">=</span> <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;RET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>There is not a <code class="docutils literal notranslate"><span class="pre">.prod()</span></code> method for <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code>, so the fastest way to calculate 11-month rolling returns is to:</p>
<ol class="arabic simple">
<li><p>Convert simple returns to log returns with <code class="docutils literal notranslate"><span class="pre">.pipe(np.log1p)</span></code></p></li>
<li><p>Calculate 11-month rolling <em>log</em> returns with <code class="docutils literal notranslate"><span class="pre">.rolling(11).sum()</span></code></p></li>
<li><p>Convert log returns to simple returns with <code class="docutils literal notranslate"><span class="pre">.pipe(np.expm1)</span></code></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_11m</span> <span class="o">=</span> <span class="n">ret_1m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expm1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we use <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> to assign <code class="docutils literal notranslate"><span class="pre">ret_11m</span></code> to ten momentum portfolios.
Here is a simple example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">q</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
      dtype=int64)
</pre></div>
</div>
</div>
</div>
<p>Here are the momentum portfolios:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_11m</span> <span class="o">=</span> <span class="n">ret_11m</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Short-term reversal, momentum, and long-term reversal represent distinct aspects of asset price behavior that have been observed and documented in the financial markets. As a researcher, I am particularly interested in understanding the underlying factors that contribute to these market anomalies and their implications for trading strategies and portfolio management.</p>
<p>Short-term reversal captures the tendency of asset prices to reverse direction in a brief period, typically days to weeks. This phenomenon can be associated with market overreactions to news events, temporary liquidity constraints, or other transient factors. Astute investors may capitalize on these short-term reversals by adopting a contrarian approach, buying assets that have recently underperformed and selling those that have outperformed.</p>
<p>Momentum represents the persistence of asset price trends over a short to medium-term horizon, typically ranging from 3 to 12 months. This market anomaly suggests that assets with strong recent performance continue to outperform, while poorly performing assets continue to underperform. Momentum can be linked to factors such as investors’ behavioral biases, positive feedback trading, and herd mentality. To exploit momentum, investors may adopt a trend-following strategy, buying assets with strong recent performance and selling those with weak performance.</p>
<p>Long-term reversal, often referred to as mean reversion, is the tendency of asset prices to revert to their long-term average or fundamental value over an extended period, typically several years. This phenomenon is thought to result from market participants gradually recognizing and correcting mispricing, leading to price adjustments. Investors following a long-term reversal strategy may focus on assets with extreme valuation levels, buying undervalued assets and selling overvalued ones, with the expectation that prices will eventually revert to their long-term mean.</p>
<p><em><strong>To avoid short-term reversal, we skip one month between 11-month returns and portfolio formation.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ret_1m</span><span class="p">,</span>
            <span class="n">ret_11m</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">port_11m</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailing Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailing ME&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Portfolio</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mom</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Mom &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Portfolio</th>
      <th>Mom 1</th>
      <th>Mom 2</th>
      <th>Mom 3</th>
      <th>Mom 4</th>
      <th>Mom 5</th>
      <th>Mom 6</th>
      <th>Mom 7</th>
      <th>Mom 8</th>
      <th>Mom 9</th>
      <th>Mom 10</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-01</th>
      <td>-0.0006</td>
      <td>0.0149</td>
      <td>0.0425</td>
      <td>0.0378</td>
      <td>0.0009</td>
      <td>0.0150</td>
      <td>0.0124</td>
      <td>0.0076</td>
      <td>-0.0044</td>
      <td>0.0126</td>
    </tr>
    <tr>
      <th>1927-02</th>
      <td>0.0641</td>
      <td>0.0484</td>
      <td>0.0866</td>
      <td>0.0745</td>
      <td>0.0436</td>
      <td>0.0547</td>
      <td>0.0561</td>
      <td>0.0403</td>
      <td>0.0579</td>
      <td>0.0541</td>
    </tr>
    <tr>
      <th>1927-03</th>
      <td>-0.0530</td>
      <td>-0.0381</td>
      <td>-0.0243</td>
      <td>-0.0408</td>
      <td>-0.0192</td>
      <td>-0.0201</td>
      <td>0.0097</td>
      <td>-0.0084</td>
      <td>-0.0058</td>
      <td>0.0012</td>
    </tr>
    <tr>
      <th>1927-04</th>
      <td>0.0230</td>
      <td>-0.0085</td>
      <td>-0.0054</td>
      <td>-0.0061</td>
      <td>0.0002</td>
      <td>-0.0032</td>
      <td>0.0138</td>
      <td>0.0030</td>
      <td>0.0323</td>
      <td>0.0421</td>
    </tr>
    <tr>
      <th>1927-05</th>
      <td>0.0069</td>
      <td>0.0353</td>
      <td>0.0604</td>
      <td>0.0536</td>
      <td>0.0700</td>
      <td>0.0950</td>
      <td>0.0796</td>
      <td>0.0838</td>
      <td>0.0803</td>
      <td>0.0886</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We see a (nearly) monotonic relation between momentum portfolios (based on trailing 11-month returns) and holding period returns!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Monthly Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Strategy</span><span class="se">\n</span><span class="s1"> Equal-Weighted Portfolios</span><span class="se">\n</span><span class="s1">Formed on Months -12 to -2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;Portfolio&#39;&gt;
</pre></div>
</div>
<img alt="_images/9a2633b50c7a88523b27b196fefcfafd510d1f41f67efa8cf4263f504fe84fbe.png" src="_images/9a2633b50c7a88523b27b196fefcfafd510d1f41f67efa8cf4263f504fe84fbe.png" />
</div>
</div>
<p>This relation is stronger when we consider long-term, buy-and-hold returns!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value of $1 Investment ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Strategy</span><span class="se">\n</span><span class="s1"> Equal-Weighted Portfolios</span><span class="se">\n</span><span class="s1">Formed on Months -12 to -2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
<img alt="_images/ccabedf7af49b0007b47bea1b17251766a377ee7ca50d2f5a6cd203be10e48ac.png" src="_images/ccabedf7af49b0007b47bea1b17251766a377ee7ca50d2f5a6cd203be10e48ac.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_mom</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Momentum_Factor&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="add-a-long-short-portfolio-that-is-long-portfolio-10-and-short-portfolio-1">
<h5>Add a long-short portfolio that is long portfolio 10 and short portfolio 1<a class="headerlink" href="#add-a-long-short-portfolio-that-is-long-portfolio-10-and-short-portfolio-1" title="Permalink to this heading">#</a></h5>
<p>Call this long-short portfolio UMD.
What are the best and worst months for portfolios 1, 10, and UMD?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span> <span class="o">=</span> <span class="n">mom_ew</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">UMD</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mom 10&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mom 1&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The worst month for the long-short portfolio is during the Great Depression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="p">[</span><span class="s1">&#39;UMD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Period(&#39;1932-08&#39;, &#39;M&#39;)
</pre></div>
</div>
</div>
</div>
<p>Momentum strategies appear to generate large absolute returns.
However, long-short momentum strategies are occasionally wiped out by large market recoveries, that the short side of the portfolio does not survive in practice.
During downturns, the short side of the portfolio (i.e., the loser stocks) has a high beta.
When the market unexpectedly and quickly recovers, the exaggerated recovery in the high-beta stocks wipes out the long-short portfolio.
For example, if we invest $1 in the long-short portfolio at the end of 1929, the long-short portfolio is effectively wiped out during August 1932.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;1930&#39;</span><span class="p">:</span><span class="s1">&#39;1932&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Mom 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Mom 10&#39;</span><span class="p">,</span> <span class="s1">&#39;UMD&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value of $1 Investment ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Strategy</span><span class="se">\n</span><span class="s1"> Equal-Weighted Portfolios</span><span class="se">\n</span><span class="s1">Formed on Months -12 to -2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4162e1d75dbe30fb44095151c1aa1734e90e085b17d4b8236c0f127dd64e09f2.png" src="_images/4162e1d75dbe30fb44095151c1aa1734e90e085b17d4b8236c0f127dd64e09f2.png" />
</div>
</div>
</section>
<section id="what-are-the-capm-and-ff4-alphas-for-these-equal-weighted-portfolios">
<h5>What are the CAPM and FF4 alphas for these equal-weighted portfolios?<a class="headerlink" href="#what-are-the-capm-and-ff4-alphas-for-these-equal-weighted-portfolios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>After class, I made the following code more repeatable.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">capm</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot;)-RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_mom</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Momentum_Factor&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mom&#39;</span><span class="p">]</span> <span class="c1"># we need to rename the Mom factor to remove leading and trailing whitespace</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function accepts a data frame of returns and factors data, a factor model regression function name, and number $n$ for the first $n$ columns in the data frame.
The factor model regression function must return a statsmodel model.
The <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function returns a data frame of coefficient estimates and standard errors.
We can use the <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function to quickly apply a factor model regression function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_coefs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="n">n</span><span class="p">]]</span>
    <span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">ses</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">coefs</span><span class="p">,</span> <span class="n">ses</span><span class="p">],</span> 
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Coef&#39;</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">],</span> 
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Statistic&#39;</span><span class="p">],</span> 
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">plot_alpha()</span></code> function accepts the output of the <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function and plots portfolio alphas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_alpha</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span>
    <span class="n">_</span><span class="p">[</span><span class="s1">&#39;Coef&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">_</span><span class="p">[</span><span class="s1">&#39;SE&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Monthly Alpha (%)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can look at the output of <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code>, but I typically will chain these functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Statistic</th>
      <th colspan="2" halign="left">Coef</th>
      <th colspan="2" halign="left">SE</th>
    </tr>
    <tr>
      <th>Variable</th>
      <th>Intercept</th>
      <th>Q("Mkt-RF")</th>
      <th>Intercept</th>
      <th>Q("Mkt-RF")</th>
    </tr>
    <tr>
      <th>Portfolio</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Mom 1</th>
      <td>-0.2642</td>
      <td>1.6488</td>
      <td>0.2364</td>
      <td>0.0438</td>
    </tr>
    <tr>
      <th>Mom 2</th>
      <td>-0.2485</td>
      <td>1.4625</td>
      <td>0.1550</td>
      <td>0.0287</td>
    </tr>
    <tr>
      <th>Mom 3</th>
      <td>-0.1499</td>
      <td>1.3130</td>
      <td>0.1170</td>
      <td>0.0216</td>
    </tr>
    <tr>
      <th>Mom 4</th>
      <td>0.0747</td>
      <td>1.2729</td>
      <td>0.1071</td>
      <td>0.0198</td>
    </tr>
    <tr>
      <th>Mom 5</th>
      <td>0.1002</td>
      <td>1.1657</td>
      <td>0.0874</td>
      <td>0.0162</td>
    </tr>
    <tr>
      <th>Mom 6</th>
      <td>0.2728</td>
      <td>1.1267</td>
      <td>0.0786</td>
      <td>0.0146</td>
    </tr>
    <tr>
      <th>Mom 7</th>
      <td>0.3420</td>
      <td>1.0899</td>
      <td>0.0778</td>
      <td>0.0144</td>
    </tr>
    <tr>
      <th>Mom 8</th>
      <td>0.4860</td>
      <td>1.0698</td>
      <td>0.0794</td>
      <td>0.0147</td>
    </tr>
    <tr>
      <th>Mom 9</th>
      <td>0.5828</td>
      <td>1.0881</td>
      <td>0.0882</td>
      <td>0.0163</td>
    </tr>
    <tr>
      <th>Mom 10</th>
      <td>0.7466</td>
      <td>1.1711</td>
      <td>0.1273</td>
      <td>0.0236</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The beauty of chaining these functions is:</p>
<ol class="arabic simple">
<li><p>We have all calculations in one cell, eliminating the need to track many “off screen” calculations in other cells</p></li>
<li><p>We do not create intermediate data frames, eliminating the need to name and track many data frames</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5e1e913e1de9ed0d78aede753ac097b65b1979e747744da61ed4e7ca405d0adc.png" src="_images/5e1e913e1de9ed0d78aede753ac097b65b1979e747744da61ed4e7ca405d0adc.png" />
</div>
</div>
<p>The momentum strategy has a large, positive, statistically significant alpha, suggesting it is a source of risk-adjusted returns (i.e., returns not associated with risk).
However, we saw above that momentum occasionally crashes, suggesting that the momentum strategy has risk.
We will investigate this with the Fama-French Four-Factor model, which add size, value, and momentum factors.
Once we consider SMB, HML, and Mom risk factors, we see:</p>
<ol class="arabic simple">
<li><p>The relation between returns and momentum portfolios is much weaker and not monotonic</p></li>
<li><p>The statistical significance of the alpha coefficient estimates is much lower.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ff4</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot;)-RF) ~ Q(&quot;Mkt-RF&quot;) + SMB + HML + Mom&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/49d58b0e8f4a15b5f64c08669380a620a5477c654dbd2bd39d8fe61718b6edb4.png" src="_images/49d58b0e8f4a15b5f64c08669380a620a5477c654dbd2bd39d8fe61718b6edb4.png" />
</div>
</div>
<p>A more extreme test is to only consider the last 20 years of returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">240</span><span class="p">:]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/61e94dbb15479ee32c7ad18ef05875f96952d508778d361dacb6f9ec0d32fdaa.png" src="_images/61e94dbb15479ee32c7ad18ef05875f96952d508778d361dacb6f9ec0d32fdaa.png" />
</div>
</div>
</section>
<section id="what-are-the-sharpe-ratios-on-these-11-portfolios">
<h5>What are the Sharpe Ratios on these 11 portfolios?<a class="headerlink" href="#what-are-the-sharpe-ratios-on-these-11-portfolios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">er</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Sharpe Ratios for Momentum Strategy Relative to RF&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e3f863714a8690aab96231d2252fbc1266e1eb8df9a55c92216420269382a89e.png" src="_images/e3f863714a8690aab96231d2252fbc1266e1eb8df9a55c92216420269382a89e.png" />
</div>
</div>
</section>
<section id="implement-a-value-weighted-momentum-investing-strategy">
<h5>Implement a value-weighted momentum investing strategy<a class="headerlink" href="#implement-a-value-weighted-momentum-investing-strategy" title="Permalink to this heading">#</a></h5>
<p>Assign this strategy to data frame <code class="docutils literal notranslate"><span class="pre">mom_vw</span></code>, and include long-short portfolio UMD</p>
<p>We can replace the <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> method, which calculates simple means (i.e., equal-weighted means), with the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method and <code class="docutils literal notranslate"><span class="pre">np.average()</span></code> function, which has a <code class="docutils literal notranslate"><span class="pre">weights=</span></code> argument and calculates weighted means.
We weight portfolio returns by the beginning-of-month marker value of equity in the <code class="docutils literal notranslate"><span class="pre">Trailing</span> <span class="pre">ME</span></code> column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mom</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Trailing ME&#39;</span><span class="p">]))</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Mom &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-are-the-capm-and-ff4-alphas-for-these-value-weighted-portfolios">
<h5>What are the CAPM and FF4 alphas for these value-weighted portfolios?<a class="headerlink" href="#what-are-the-capm-and-ff4-alphas-for-these-value-weighted-portfolios" title="Permalink to this heading">#</a></h5>
<p>The alphas for the value-weighted momentum portfolios are generally smaller in magnitude than for the equal-weighted momentum portfolios.
Equal-weighted portfolios over-weight small stocks relative to value-weighted portfolios, and we expect most anomalies to be stronger in small stocks because small stocks are more difficult for institutional investors to  invest in at scale.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ced34c2a1d5da1a44cb646030a067d3e0a7d3f3faa565e7aa4f78e1952078890.png" src="_images/ced34c2a1d5da1a44cb646030a067d3e0a7d3f3faa565e7aa4f78e1952078890.png" />
</div>
</div>
<p>The momentum strategy falls apart once we consider the Fama-French Four-Factor model with value-weighted portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/66e40b5dd92b6085cded9eeb7d2c959f470ca8560f6630174d8dc1235085e3d4.png" src="_images/66e40b5dd92b6085cded9eeb7d2c959f470ca8560f6630174d8dc1235085e3d4.png" />
</div>
</div>
</section>
<section id="what-are-the-sharpe-ratios-for-these-value-weighted-portfolios">
<h5>What are the Sharpe Ratios for these value-weighted portfolios?<a class="headerlink" href="#what-are-the-sharpe-ratios-for-these-value-weighted-portfolios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Sharpe Ratios for Momentum Strategy Relative to RF&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed on Months -12 to -2&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f7a171cb8d4193690488883353b1ad5d1c1208f33f2581c2d2f6b793b9526043.png" src="_images/f7a171cb8d4193690488883353b1ad5d1c1208f33f2581c2d2f6b793b9526043.png" />
</div>
</div>
</section>
<section id="implement-an-equal-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june">
<h5>Implement an equal-weighted size investing strategy based on market capitalization ~~at the start of each month~~ from the previous June<a class="headerlink" href="#implement-an-equal-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june" title="Permalink to this heading">#</a></h5>
<p><em><strong>To show how to form portfolios at lower frequencies, I change this task to form portfolios once a year based on market capitalization from the previous June.</strong></em>
We will assign stocks to portfolios based on market capitalization (i.e., size or the market value of equity) each June and use these portfolio assignments from July through the following June.
That is, we rank in June of year $t$, then hold them in portfolios from July in year $t$ through June in year $t+1$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span> <span class="o">=</span> <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>59400.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1927-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>59400.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1928-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>57675.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1929-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>57900.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1930-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>30900.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>Next we assign portfolios on these June market capitalizations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1927-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1928-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1929-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1930-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>Note, we want to use these portfolio assignments from July through June, so we need to <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> with <code class="docutils literal notranslate"><span class="pre">freq='1M'</span></code>, which shifts the index one month instead of shifting the values one row.
Because we only have June data, a one-row shift is a one-year shift instead of a one-month shift.
We also need to up sample our June data to monthly date with <code class="docutils literal notranslate"><span class="pre">.resample('M')</span></code> and the <code class="docutils literal notranslate"><span class="pre">.ffill()</span></code> method.
Because we only want to fill forward 12 months, we use <code class="docutils literal notranslate"><span class="pre">.ffill(limit=12)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-03</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-04</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>6.0000</td>
      <td>4.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>We can combine the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code>, <code class="docutils literal notranslate"><span class="pre">.shift()</span></code>, <code class="docutils literal notranslate"><span class="pre">.resample()</span></code>, and <code class="docutils literal notranslate"><span class="pre">.fill()</span></code> methods into one operation when we combine the returns, trailing market capitalization, and portfolio assignments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ret_1m</span><span class="p">,</span>
            <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="n">me_june</span>
                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailing ME&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Portfolio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Return</th>
      <th>Trailing ME</th>
      <th>Portfolio</th>
    </tr>
    <tr>
      <th>date</th>
      <th>PERMNO</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1926-07</th>
      <th>10022</th>
      <td>0.2400</td>
      <td>10000.0000</td>
      <td>5</td>
    </tr>
    <tr>
      <th>10030</th>
      <td>0.0211</td>
      <td>19402.5000</td>
      <td>6</td>
    </tr>
    <tr>
      <th>10057</th>
      <td>0.0078</td>
      <td>4031.2500</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10073</th>
      <td>0.0729</td>
      <td>1656.0000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>10081</th>
      <td>0.0156</td>
      <td>9536.0000</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_ew</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">me</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;ME &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8872db5b249404c8e14edbab82f5358ec876d78ae3ef3d65305b1190711b891a.png" src="_images/8872db5b249404c8e14edbab82f5358ec876d78ae3ef3d65305b1190711b891a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/da1a5df44d3d573abd9b0e06810182e2faf2d6075d7ba52d9720be73ab245739.png" src="_images/da1a5df44d3d573abd9b0e06810182e2faf2d6075d7ba52d9720be73ab245739.png" />
</div>
</div>
<p>If we had more time to dig into the size investing strategy, we would find:</p>
<ol class="arabic simple">
<li><p>The alpha is concentrated in January due to tax loss harvesting, where investors sell their losers in December and buy them back in January to earn a tax deduction</p></li>
<li><p>The smallest stocks in the ME 1 portfolio are tiny, making them impractical for institutional investors and allowing the anomaly to persist (because these stocks are small and illiquid, the size factor does not try to explain away their alpha)</p></li>
</ol>
<p>We can quickly see the point 2 above by plotting the mean marker capitalization for each portfolio.
This analysis is “quick and dirty” because we have not inflation adjusted these values.
Still, we quickly see that the ME 10 stocks are 1,000 times larger than the ME 1 stocks, on average.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">me</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Trailing ME&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;ME &#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Market Value of Equity (Nominal U.S. Dollars)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Market Value of Stocks in ME Portfolios&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9912623f731b1538e1491a458598c59c8be346a294d6d950902f235fd10a843d.png" src="_images/9912623f731b1538e1491a458598c59c8be346a294d6d950902f235fd10a843d.png" />
</div>
</div>
</section>
<section id="implement-a-value-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june">
<h5>Implement a value-weighted size investing strategy based on market capitalization ~~at the start of each month~~ from the previous June<a class="headerlink" href="#implement-a-value-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june" title="Permalink to this heading">#</a></h5>
<p>With value-weighted portfolios, the size investing strategy alphas disappear!
The alpha disappears because value-weighted portfolios down weight the smallest of the smallest stocks that made the size investing strategy appear to be returns not explained by risk.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_vw</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">me</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Trailing ME&#39;</span><span class="p">]))</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;ME &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3f1ab9c29b78dcf3f973dbae288263b3138d8bf9faea23b8554377f0023b8978.png" src="_images/3f1ab9c29b78dcf3f973dbae288263b3138d8bf9faea23b8554377f0023b8978.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8e1d15ddfe810ce7dbb2eed7e8f77fe665b0dbd55e16bed2bd257f7354616cac.png" src="_images/8e1d15ddfe810ce7dbb2eed7e8f77fe665b0dbd55e16bed2bd257f7354616cac.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-herron_06_practice_02"></span><section id="herron-topic-6-practice-wednesday-2-45-pm-section-2">
<h3>Herron Topic 6 - Practice (Wednesday 2:45 PM, Section 2)<a class="headerlink" href="#herron-topic-6-practice-wednesday-2-45-pm-section-2" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 6 mean and median were about ~~90% and 96%~~  92% and 100%</p>
<ul>
<li><p>Please see the solution on Canvas and let me know if you have any questions</p></li>
<li><p>Gradescope shows which hidden tests you missed</p></li>
<li><p>I recently widened the tolerance on two hidden tests to give full credit if you minimized variance instead of volatility</p></li>
</ul>
</li>
<li><p>I posted <a class="reference internal" href="_introduction.html#document-project_02"><span class="doc std std-doc">project 2</span></a> about Bitcoin and gold as inflation and market risk hedges</p></li>
<li><p>Next week (week of 4/10) is the assessment exam</p>
<ul>
<li><p>MSFQ students must take it for 5% of overall course grade</p></li>
<li><p>Non-MSQF students do not take it and weight their grades by only 95%</p></li>
<li><p>20 multiple choice questions on the 6 core courses (corporate finance, investments, math, data analytics, empirical methods, and derivatives)</p></li>
<li><p><em><strong>You must be in the classroom during your assigned date and time to take the MSFQ assessment exam</strong></em></p></li>
<li><p>If there is interest, we will discuss five stylized facts of asset returns after the MSFQ assessment exam</p></li>
<li><p>We will also have our final quiz, quiz 7</p></li>
</ul>
</li>
<li><p>The following week (week of 4/17) we will discuss Herron topic 5 (simulations)</p>
<ul>
<li><p>I will record a lecture video and complete a practice notebook</p></li>
<li><p>But we will reserve class time for group work</p></li>
<li><p>The class voted about 2-to-1 not to drop a topic, so this is a compromise, given that Monday is Patriot’s Day holiday</p></li>
</ul>
</li>
<li><p>The following week (week of 4/24) we will reserve class time for group work</p>
<ul>
<li><p>Project 2 is due Wednesday, 4/26, at 11:59 PM</p></li>
<li><p>Teammates Review 2 is due Wednesday, 4/26, at 11:59 PM</p></li>
<li><p>30,000 DataCamp XP are due Friday, 4/28, at 11:59 PM</p></li>
</ul>
</li>
<li><p><em><strong>Somewhere in there, please reserve 10 minutes to complete a TRACE review for this course</strong></em></p>
<ul>
<li><p>I cannot make you complete TRACE reviews</p></li>
<li><p>But they are very helpful</p></li>
<li><p>I change my courses every semester, hopefully for the better, based on TRACE reviews</p></li>
</ul>
</li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="reimplement-the-equal-weighted-momentum-investing-strategy-from-the-lecture-notebook">
<h5>Reimplement the equal-weighted momentum investing strategy from the lecture notebook<a class="headerlink" href="#reimplement-the-equal-weighted-momentum-investing-strategy-from-the-lecture-notebook" title="Permalink to this heading">#</a></h5>
<p>Try to use a few cells and temporary variables as you can (i.e., perform calculations inside <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">filepath_or_buffer</span><span class="o">=</span><span class="s1">&#39;crsp.csv&#39;</span><span class="p">,</span>
        <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
        <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="c1"># CRSP uses letter codes to provide additional information, which we can ignore</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">),</span> <span class="c1"># returns span a month, so I prefer to work with periods instead of dates</span>
        <span class="n">ME</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;PRC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;SHROUT&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Please the <a class="reference internal" href="_introduction.html#document-herron_06_lecture"><span class="doc std std-doc">Herron Topic 6 lecture notebook</span></a> for variable definitions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>SHRCD</th>
      <th>PRC</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>ME</th>
    </tr>
    <tr>
      <th>PERMNO</th>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">10000</th>
      <th>1986-01</th>
      <td>10</td>
      <td>-4.3750</td>
      <td>NaN</td>
      <td>3680.0000</td>
      <td>16100.0000</td>
    </tr>
    <tr>
      <th>1986-02</th>
      <td>10</td>
      <td>-3.2500</td>
      <td>-0.2571</td>
      <td>3680.0000</td>
      <td>11960.0000</td>
    </tr>
    <tr>
      <th>1986-03</th>
      <td>10</td>
      <td>-4.4375</td>
      <td>0.3654</td>
      <td>3680.0000</td>
      <td>16330.0000</td>
    </tr>
    <tr>
      <th>1986-04</th>
      <td>10</td>
      <td>-4.0000</td>
      <td>-0.0986</td>
      <td>3793.0000</td>
      <td>15172.0000</td>
    </tr>
    <tr>
      <th>1986-05</th>
      <td>10</td>
      <td>-3.1094</td>
      <td>-0.2227</td>
      <td>3793.0000</td>
      <td>11793.8783</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To implement a momentum strategy, we need:</p>
<ol class="arabic simple">
<li><p>1-month returns, which are the returns we receive for each holding period</p></li>
<li><p>11-month returns, which are the returns (from month -12 to month -2) that we use to rank stocks and assign to momentum portfolios</p></li>
<li><p>Momentum portfolio assignments based on 11-month trailing returns</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_1m</span> <span class="o">=</span> <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;RET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>There is not a <code class="docutils literal notranslate"><span class="pre">.prod()</span></code> method for <code class="docutils literal notranslate"><span class="pre">.rolling()</span></code>, so the fastest way to calculate 11-month rolling returns is to:</p>
<ol class="arabic simple">
<li><p>Convert simple returns to log returns with <code class="docutils literal notranslate"><span class="pre">.pipe(np.log1p)</span></code></p></li>
<li><p>Calculate 11-month rolling <em>log</em> returns with <code class="docutils literal notranslate"><span class="pre">.rolling(11).sum()</span></code></p></li>
<li><p>Convert log returns to simple returns with <code class="docutils literal notranslate"><span class="pre">.pipe(np.expm1)</span></code></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_11m</span> <span class="o">=</span> <span class="n">ret_1m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expm1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we use <code class="docutils literal notranslate"><span class="pre">pd.qcut()</span></code> to assign <code class="docutils literal notranslate"><span class="pre">ret_11m</span></code> to ten momentum portfolios.
Here is a simple example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">q</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1], dtype=int64)
</pre></div>
</div>
</div>
</div>
<p>Here are the momentum portfolios:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_11m</span> <span class="o">=</span> <span class="n">ret_11m</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Short-term reversal, momentum, and long-term reversal represent distinct aspects of asset price behavior that have been observed and documented in the financial markets. As a researcher, I am particularly interested in understanding the underlying factors that contribute to these market anomalies and their implications for trading strategies and portfolio management.</p>
<p>Short-term reversal captures the tendency of asset prices to reverse direction in a brief period, typically days to weeks. This phenomenon can be associated with market overreactions to news events, temporary liquidity constraints, or other transient factors. Astute investors may capitalize on these short-term reversals by adopting a contrarian approach, buying assets that have recently underperformed and selling those that have outperformed.</p>
<p>Momentum represents the persistence of asset price trends over a short to medium-term horizon, typically ranging from 3 to 12 months. This market anomaly suggests that assets with strong recent performance continue to outperform, while poorly performing assets continue to underperform. Momentum can be linked to factors such as investors’ behavioral biases, positive feedback trading, and herd mentality. To exploit momentum, investors may adopt a trend-following strategy, buying assets with strong recent performance and selling those with weak performance.</p>
<p>Long-term reversal, often referred to as mean reversion, is the tendency of asset prices to revert to their long-term average or fundamental value over an extended period, typically several years. This phenomenon is thought to result from market participants gradually recognizing and correcting mispricing, leading to price adjustments. Investors following a long-term reversal strategy may focus on assets with extreme valuation levels, buying undervalued assets and selling overvalued ones, with the expectation that prices will eventually revert to their long-term mean.</p>
<p><em><strong>To avoid short-term reversal, we skip one month between 11-month returns and portfolio formation.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ret_1m</span><span class="p">,</span> 
            <span class="n">ret_11m</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">port_11m</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="c1"># base portfolio assignments on avail. info. and avoid short-term reversal</span>
            <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailing Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailing ME&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Portfolio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Return</th>
      <th>Trailing Return</th>
      <th>Portfolio</th>
      <th>Trailing ME</th>
    </tr>
    <tr>
      <th>date</th>
      <th>PERMNO</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1927-01</th>
      <th>10022</th>
      <td>-0.0759</td>
      <td>0.1182</td>
      <td>8</td>
      <td>11424.0000</td>
    </tr>
    <tr>
      <th>10030</th>
      <td>0.0095</td>
      <td>0.0093</td>
      <td>6</td>
      <td>21450.0000</td>
    </tr>
    <tr>
      <th>10057</th>
      <td>-0.0510</td>
      <td>-0.5918</td>
      <td>1</td>
      <td>3062.5000</td>
    </tr>
    <tr>
      <th>10073</th>
      <td>0.0946</td>
      <td>-0.4286</td>
      <td>2</td>
      <td>1276.5000</td>
    </tr>
    <tr>
      <th>10081</th>
      <td>-0.0750</td>
      <td>-0.4194</td>
      <td>2</td>
      <td>5960.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mom</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Mom &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We see a (nearly) monotonic relation between momentum portfolios (based on trailing 11-month returns) and holding period returns!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Portfolio</th>
      <th>Mom 1</th>
      <th>Mom 2</th>
      <th>Mom 3</th>
      <th>Mom 4</th>
      <th>Mom 5</th>
      <th>Mom 6</th>
      <th>Mom 7</th>
      <th>Mom 8</th>
      <th>Mom 9</th>
      <th>Mom 10</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1927-01</th>
      <td>-0.0006</td>
      <td>0.0149</td>
      <td>0.0425</td>
      <td>0.0378</td>
      <td>0.0009</td>
      <td>0.0150</td>
      <td>0.0124</td>
      <td>0.0076</td>
      <td>-0.0044</td>
      <td>0.0126</td>
    </tr>
    <tr>
      <th>1927-02</th>
      <td>0.0641</td>
      <td>0.0484</td>
      <td>0.0866</td>
      <td>0.0745</td>
      <td>0.0436</td>
      <td>0.0547</td>
      <td>0.0561</td>
      <td>0.0403</td>
      <td>0.0579</td>
      <td>0.0541</td>
    </tr>
    <tr>
      <th>1927-03</th>
      <td>-0.0530</td>
      <td>-0.0381</td>
      <td>-0.0243</td>
      <td>-0.0408</td>
      <td>-0.0192</td>
      <td>-0.0201</td>
      <td>0.0097</td>
      <td>-0.0084</td>
      <td>-0.0058</td>
      <td>0.0012</td>
    </tr>
    <tr>
      <th>1927-04</th>
      <td>0.0230</td>
      <td>-0.0085</td>
      <td>-0.0054</td>
      <td>-0.0061</td>
      <td>0.0002</td>
      <td>-0.0032</td>
      <td>0.0138</td>
      <td>0.0030</td>
      <td>0.0323</td>
      <td>0.0421</td>
    </tr>
    <tr>
      <th>1927-05</th>
      <td>0.0069</td>
      <td>0.0353</td>
      <td>0.0604</td>
      <td>0.0536</td>
      <td>0.0700</td>
      <td>0.0950</td>
      <td>0.0796</td>
      <td>0.0838</td>
      <td>0.0803</td>
      <td>0.0886</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Monthly Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Strategy</span><span class="se">\n</span><span class="s1"> Equal-Weighted Portfolios</span><span class="se">\n</span><span class="s1">Formed on Months -12 to -2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;Portfolio&#39;&gt;
</pre></div>
</div>
<img alt="_images/9a2633b50c7a88523b27b196fefcfafd510d1f41f67efa8cf4263f504fe84fbe.png" src="_images/9a2633b50c7a88523b27b196fefcfafd510d1f41f67efa8cf4263f504fe84fbe.png" />
</div>
</div>
<p>This relation is stronger when we consider long-term, buy-and-hold returns!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value of $1 Investment ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Strategy</span><span class="se">\n</span><span class="s1"> Equal-Weighted Portfolios</span><span class="se">\n</span><span class="s1">Formed on Months -12 to -2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
<img alt="_images/ccabedf7af49b0007b47bea1b17251766a377ee7ca50d2f5a6cd203be10e48ac.png" src="_images/ccabedf7af49b0007b47bea1b17251766a377ee7ca50d2f5a6cd203be10e48ac.png" />
</div>
</div>
</section>
<section id="add-a-long-short-portfolio-that-is-long-portfolio-10-and-short-portfolio-1">
<h5>Add a long-short portfolio that is long portfolio 10 and short portfolio 1<a class="headerlink" href="#add-a-long-short-portfolio-that-is-long-portfolio-10-and-short-portfolio-1" title="Permalink to this heading">#</a></h5>
<p>Call this long-short portfolio UMD.
What are the best and worst months for portfolios 1, 10, and UMD?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span> <span class="o">=</span> <span class="n">mom_ew</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">UMD</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mom 10&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mom 1&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The worst month for the long-short portfolio is during the Great Depression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="p">[</span><span class="s1">&#39;UMD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Period(&#39;1932-08&#39;, &#39;M&#39;)
</pre></div>
</div>
</div>
</div>
<p>Momentum strategies appear to generate large absolute returns.
However, long-short momentum strategies are occasionally wiped out by large market recoveries, that the short side of the portfolio does not survive in practice.
During downturns, the short side of the portfolio (i.e., the loser stocks) has a high beta.
When the market unexpectedly and quickly recovers, the exaggerated recovery in the high-beta stocks wipes out the long-short portfolio.
For example, if we invest $1 in the long-short portfolio at the end of 1929, the long-short portfolio is effectively wiped out during August 1932.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;1930&#39;</span><span class="p">:</span><span class="s1">&#39;1932&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Mom 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Mom 10&#39;</span><span class="p">,</span> <span class="s1">&#39;UMD&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value of $1 Investment ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Strategy</span><span class="se">\n</span><span class="s1"> Equal-Weighted Portfolios</span><span class="se">\n</span><span class="s1">Formed on Months -12 to -2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4162e1d75dbe30fb44095151c1aa1734e90e085b17d4b8236c0f127dd64e09f2.png" src="_images/4162e1d75dbe30fb44095151c1aa1734e90e085b17d4b8236c0f127dd64e09f2.png" />
</div>
</div>
</section>
<section id="what-are-the-capm-and-ff4-alphas-for-these-equal-weighted-portfolios">
<h5>What are the CAPM and FF4 alphas for these equal-weighted portfolios?<a class="headerlink" href="#what-are-the-capm-and-ff4-alphas-for-these-equal-weighted-portfolios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>After class, I made the following code more repeatable.</strong></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">capm</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot;)-RF) ~ Q(&quot;Mkt-RF&quot;)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_0</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_mom</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Momentum_Factor&#39;</span><span class="p">,</span>
    <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>

<span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mom&#39;</span><span class="p">]</span> <span class="c1"># we need to rename the Mom factor to remove leading and trailing whitespace</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function accepts a data frame of returns and factors data, a factor model regression function name, and number $n$ for the first $n$ columns in the data frame.
The factor model regression function must return a statsmodel model.
The <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function returns a data frame of coefficient estimates and standard errors.
We can use the <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function to quickly apply a factor model regression function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_coefs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="n">n</span><span class="p">]]</span>
    <span class="n">fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">ses</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">bse</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">coefs</span><span class="p">,</span> <span class="n">ses</span><span class="p">],</span> 
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Coef&#39;</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">],</span> 
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Statistic&#39;</span><span class="p">],</span> 
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">plot_alpha()</span></code> function accepts the output of the <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code> function and plots portfolio alphas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_alpha</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;Intercept&#39;</span><span class="p">]</span>
    <span class="n">_</span><span class="p">[</span><span class="s1">&#39;Coef&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">_</span><span class="p">[</span><span class="s1">&#39;SE&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Monthly Alpha (%)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can look at the output of <code class="docutils literal notranslate"><span class="pre">get_coefs()</span></code>, but I typically will chain these functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Statistic</th>
      <th colspan="2" halign="left">Coef</th>
      <th colspan="2" halign="left">SE</th>
    </tr>
    <tr>
      <th>Variable</th>
      <th>Intercept</th>
      <th>Q("Mkt-RF")</th>
      <th>Intercept</th>
      <th>Q("Mkt-RF")</th>
    </tr>
    <tr>
      <th>Portfolio</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Mom 1</th>
      <td>-0.2642</td>
      <td>1.6488</td>
      <td>0.2364</td>
      <td>0.0438</td>
    </tr>
    <tr>
      <th>Mom 2</th>
      <td>-0.2485</td>
      <td>1.4625</td>
      <td>0.1550</td>
      <td>0.0287</td>
    </tr>
    <tr>
      <th>Mom 3</th>
      <td>-0.1499</td>
      <td>1.3130</td>
      <td>0.1170</td>
      <td>0.0216</td>
    </tr>
    <tr>
      <th>Mom 4</th>
      <td>0.0747</td>
      <td>1.2729</td>
      <td>0.1071</td>
      <td>0.0198</td>
    </tr>
    <tr>
      <th>Mom 5</th>
      <td>0.1002</td>
      <td>1.1657</td>
      <td>0.0874</td>
      <td>0.0162</td>
    </tr>
    <tr>
      <th>Mom 6</th>
      <td>0.2728</td>
      <td>1.1267</td>
      <td>0.0786</td>
      <td>0.0146</td>
    </tr>
    <tr>
      <th>Mom 7</th>
      <td>0.3420</td>
      <td>1.0899</td>
      <td>0.0778</td>
      <td>0.0144</td>
    </tr>
    <tr>
      <th>Mom 8</th>
      <td>0.4860</td>
      <td>1.0698</td>
      <td>0.0794</td>
      <td>0.0147</td>
    </tr>
    <tr>
      <th>Mom 9</th>
      <td>0.5828</td>
      <td>1.0881</td>
      <td>0.0882</td>
      <td>0.0163</td>
    </tr>
    <tr>
      <th>Mom 10</th>
      <td>0.7466</td>
      <td>1.1711</td>
      <td>0.1273</td>
      <td>0.0236</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The beauty of chaining these functions is:</p>
<ol class="arabic simple">
<li><p>We have all calculations in one cell, eliminating the need to track many “off screen” calculations in other cells</p></li>
<li><p>We do not create intermediate data frames, eliminating the need to name and track many data frames</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5e1e913e1de9ed0d78aede753ac097b65b1979e747744da61ed4e7ca405d0adc.png" src="_images/5e1e913e1de9ed0d78aede753ac097b65b1979e747744da61ed4e7ca405d0adc.png" />
</div>
</div>
<p>The momentum strategy has a large, positive, statistically significant alpha, suggesting it is a source of risk-adjusted returns (i.e., returns not associated with risk).
However, we saw above that momentum occasionally crashes, suggesting that the momentum strategy has risk.
We will investigate this with the Fama-French Four-Factor model, which add size, value, and momentum factors.
Once we consider SMB, HML, and Mom risk factors, we see:</p>
<ol class="arabic simple">
<li><p>The relation between returns and momentum portfolios is much weaker and not monotonic</p></li>
<li><p>The statistical significance of the alpha coefficient estimates is much lower.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ff4</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;I(Q(&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot;)-RF) ~ Q(&quot;Mkt-RF&quot;) + SMB + HML + Mom&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/49d58b0e8f4a15b5f64c08669380a620a5477c654dbd2bd39d8fe61718b6edb4.png" src="_images/49d58b0e8f4a15b5f64c08669380a620a5477c654dbd2bd39d8fe61718b6edb4.png" />
</div>
</div>
<p>A more extreme test is to only consider the last 20 years of returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">240</span><span class="p">:]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/61e94dbb15479ee32c7ad18ef05875f96952d508778d361dacb6f9ec0d32fdaa.png" src="_images/61e94dbb15479ee32c7ad18ef05875f96952d508778d361dacb6f9ec0d32fdaa.png" />
</div>
</div>
</section>
<section id="what-are-the-sharpe-ratios-on-these-11-portfolios">
<h5>What are the Sharpe Ratios on these 11 portfolios?<a class="headerlink" href="#what-are-the-sharpe-ratios-on-these-11-portfolios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">ppy</span><span class="p">):</span>
    <span class="n">er</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ppy</span><span class="p">)</span> <span class="o">*</span> <span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">er</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Sharpe Ratios for Momentum Strategy Relative to RF&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed on Months -12 to -2&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e3f863714a8690aab96231d2252fbc1266e1eb8df9a55c92216420269382a89e.png" src="_images/e3f863714a8690aab96231d2252fbc1266e1eb8df9a55c92216420269382a89e.png" />
</div>
</div>
</section>
<section id="implement-a-value-weighted-momentum-investing-strategy">
<h5>Implement a value-weighted momentum investing strategy<a class="headerlink" href="#implement-a-value-weighted-momentum-investing-strategy" title="Permalink to this heading">#</a></h5>
<p>Assign this strategy to data frame <code class="docutils literal notranslate"><span class="pre">mom_vw</span></code>, and include long-short portfolio UMD</p>
<p>We can replace the <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> method, which calculates simple means (i.e., equal-weighted means), with the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method and <code class="docutils literal notranslate"><span class="pre">np.average()</span></code> function, which has a <code class="docutils literal notranslate"><span class="pre">weights=</span></code> argument and calculates weighted means.
We weight portfolio returns by the beginning-of-month marker value of equity in the <code class="docutils literal notranslate"><span class="pre">Trailing</span> <span class="pre">ME</span></code> column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mom</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Trailing ME&#39;</span><span class="p">]))</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Mom &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-are-the-capm-and-ff4-alphas-for-these-value-weighted-portfolios">
<h5>What are the CAPM and FF4 alphas for these value-weighted portfolios?<a class="headerlink" href="#what-are-the-capm-and-ff4-alphas-for-these-value-weighted-portfolios" title="Permalink to this heading">#</a></h5>
<p>The alphas for the value-weighted momentum portfolios are generally smaller in magnitude than for the equal-weighted momentum portfolios.
Equal-weighted portfolios over-weight small stocks relative to value-weighted portfolios, and we expect most anomalies to be stronger in small stocks because small stocks are more difficult for institutional investors to  invest in at scale.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ced34c2a1d5da1a44cb646030a067d3e0a7d3f3faa565e7aa4f78e1952078890.png" src="_images/ced34c2a1d5da1a44cb646030a067d3e0a7d3f3faa565e7aa4f78e1952078890.png" />
</div>
</div>
<p>The momentum strategy falls apart once we consider the Fama-French Four-Factor model with value-weighted portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Momentum Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed on Months -12 to -2&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/66e40b5dd92b6085cded9eeb7d2c959f470ca8560f6630174d8dc1235085e3d4.png" src="_images/66e40b5dd92b6085cded9eeb7d2c959f470ca8560f6630174d8dc1235085e3d4.png" />
</div>
</div>
</section>
<section id="what-are-the-sharpe-ratios-for-these-value-weighted-portfolios">
<h5>What are the Sharpe Ratios for these value-weighted portfolios?<a class="headerlink" href="#what-are-the-sharpe-ratios-for-these-value-weighted-portfolios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mom_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">tgt</span><span class="o">=</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ppy</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;Sharpe Ratios for Momentum Strategy Relative to RF&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed on Months -12 to -2&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f7a171cb8d4193690488883353b1ad5d1c1208f33f2581c2d2f6b793b9526043.png" src="_images/f7a171cb8d4193690488883353b1ad5d1c1208f33f2581c2d2f6b793b9526043.png" />
</div>
</div>
</section>
<section id="implement-an-equal-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june">
<h5>Implement an equal-weighted size investing strategy based on market capitalization ~~at the start of each month~~ from the previous June<a class="headerlink" href="#implement-an-equal-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june" title="Permalink to this heading">#</a></h5>
<p><em><strong>To show how to form portfolios at lower frequencies, I change this task to form portfolios once a year based on market capitalization from the previous June.</strong></em>
We will assign stocks to portfolios based on market capitalization (i.e., size or the market value of equity) each June and use these portfolio assignments from July through the following June.
That is, we rank in June of year $t$, then hold them in portfolios from July in year $t$ through June in year $t+1$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span> <span class="o">=</span> <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>59400.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1927-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>59400.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1928-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>57675.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1929-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>57900.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1930-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>30900.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>Next we assign portfolios on these June market capitalizations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1927-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1928-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1929-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1930-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>Note, we want to use these portfolio assignments from July through June, so we need to <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> with <code class="docutils literal notranslate"><span class="pre">freq='1M'</span></code>, which shifts the index one month instead of shifting the values one row.
Because we only have June data, a one-row shift is a one-year shift instead of a one-month shift.
We also need to up sample our June data to monthly date with <code class="docutils literal notranslate"><span class="pre">.resample('M')</span></code> and the <code class="docutils literal notranslate"><span class="pre">.ffill()</span></code> method.
Because we only want to fill forward 12 months, we use <code class="docutils literal notranslate"><span class="pre">.ffill(limit=12)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_june</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>10000</th>
      <th>10001</th>
      <th>10002</th>
      <th>10003</th>
      <th>10005</th>
      <th>10006</th>
      <th>10007</th>
      <th>10008</th>
      <th>10009</th>
      <th>10010</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2022-03</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-04</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>7.0000</td>
      <td>3.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
    <tr>
      <th>2022-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>6.0000</td>
      <td>4.0000</td>
      <td>NaN</td>
      <td>8.0000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0000</td>
      <td>NaN</td>
      <td>9.0000</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26480 columns</p>
</div></div></div>
</div>
<p>We can combine the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code>, <code class="docutils literal notranslate"><span class="pre">.shift()</span></code>, <code class="docutils literal notranslate"><span class="pre">.resample()</span></code>, and <code class="docutils literal notranslate"><span class="pre">.fill()</span></code> methods into one operation when we combine the returns, trailing market capitalization, and portfolio assignments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="n">objs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ret_1m</span><span class="p">,</span>
            <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="n">me_june</span>
                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailing ME&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Portfolio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Return</th>
      <th>Trailing ME</th>
      <th>Portfolio</th>
    </tr>
    <tr>
      <th>date</th>
      <th>PERMNO</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1926-07</th>
      <th>10022</th>
      <td>0.2400</td>
      <td>10000.0000</td>
      <td>5</td>
    </tr>
    <tr>
      <th>10030</th>
      <td>0.0211</td>
      <td>19402.5000</td>
      <td>6</td>
    </tr>
    <tr>
      <th>10057</th>
      <td>0.0078</td>
      <td>4031.2500</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10073</th>
      <td>0.0729</td>
      <td>1656.0000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>10081</th>
      <td>0.0156</td>
      <td>9536.0000</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_ew</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">me</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;ME &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8872db5b249404c8e14edbab82f5358ec876d78ae3ef3d65305b1190711b891a.png" src="_images/8872db5b249404c8e14edbab82f5358ec876d78ae3ef3d65305b1190711b891a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_ew</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Equal-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/da1a5df44d3d573abd9b0e06810182e2faf2d6075d7ba52d9720be73ab245739.png" src="_images/da1a5df44d3d573abd9b0e06810182e2faf2d6075d7ba52d9720be73ab245739.png" />
</div>
</div>
<p>If we had more time to dig into the size investing strategy, we would find:</p>
<ol class="arabic simple">
<li><p>The alpha is concentrated in January due to tax loss harvesting, where investors sell their losers in December and buy them back in January to earn a tax deduction</p></li>
<li><p>The smallest stocks in the ME 1 portfolio are tiny, making them impractical for institutional investors and allowing the anomaly to persist (because these stocks are small and illiquid, the size factor does not try to explain away their alpha)</p></li>
</ol>
<p>We can quickly see the point 2 above by plotting the mean marker capitalization for each portfolio.
This analysis is “quick and dirty” because we have not inflation adjusted these values.
Still, we quickly see that the ME 10 stocks are 1,000 times larger than the ME 1 stocks, on average.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">me</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;Trailing ME&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;ME &#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Market Value of Equity (Nominal U.S. Dollars)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mean Market Value of Stocks in ME Portfolios&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9912623f731b1538e1491a458598c59c8be346a294d6d950902f235fd10a843d.png" src="_images/9912623f731b1538e1491a458598c59c8be346a294d6d950902f235fd10a843d.png" />
</div>
</div>
</section>
<section id="implement-a-value-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june">
<h5>Implement a value-weighted size investing strategy based on market capitalization ~~at the start of each month~~ from the previous June<a class="headerlink" href="#implement-a-value-weighted-size-investing-strategy-based-on-market-capitalization-at-the-start-of-each-month-from-the-previous-june" title="Permalink to this heading">#</a></h5>
<p>With value-weighted portfolios, the size investing strategy alphas disappear!
The alpha disappears because value-weighted portfolios down weight the smallest of the smallest stocks that made the size investing strategy appear to be returns not explained by risk.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_vw</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">me</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Trailing ME&#39;</span><span class="p">]))</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;ME &#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;CAPM Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3f1ab9c29b78dcf3f973dbae288263b3138d8bf9faea23b8554377f0023b8978.png" src="_images/3f1ab9c29b78dcf3f973dbae288263b3138d8bf9faea23b8554377f0023b8978.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">me_vw</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ff_0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ff_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">get_coefs</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">ff4</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_alpha</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s1">&#39;FF4 Tests of Size Strategy&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Value-Weighted Portfolios Formed June Market Value of Equity&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8e1d15ddfe810ce7dbb2eed7e8f77fe665b0dbd55e16bed2bd257f7354616cac.png" src="_images/8e1d15ddfe810ce7dbb2eed7e8f77fe665b0dbd55e16bed2bd257f7354616cac.png" />
</div>
</div>
</section>
</section>
</section>
</div>
</section>
<span id="document-herron_07_lecture"></span><section id="herron-topic-7-five-stylized-facts-of-asset-returns">
<h2>Herron Topic 7 - Five Stylized Facts of Asset Returns<a class="headerlink" href="#herron-topic-7-five-stylized-facts-of-asset-returns" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://www.tandfonline.com/doi/abs/10.1080/713665670">Rama Cont (2001)</a> provides five stylized facts of asset returns, which we will investigate with the daily market factor data from the French Data Library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
</pre></div>
</div>
</div>
</div>
<section id="returns-are-not-normally-distributed">
<h3>Returns are <em>not</em> normally distributed<a class="headerlink" href="#returns-are-not-normally-distributed" title="Permalink to this heading">#</a></h3>
<p>Daily stock returns are not normally distributed (i.e., are non-Gaussian).
Daily stock returns have:</p>
<ol class="arabic simple">
<li><p>negative skewness (large negative returns occur more often than large positive ones)</p></li>
<li><p>excess kurtosis (large magnitude returns, positive or negative, occur more often than if returns were normally distributed)</p></li>
</ol>
<p>We can show the non-normality of daily stock returns in at least two ways:</p>
<ol class="arabic simple">
<li><p>descriptive statistics (also known as summary statistics)</p></li>
<li><p>histograms</p></li>
</ol>
<section id="log-and-simple-returns">
<h4>Log and Simple Returns<a class="headerlink" href="#log-and-simple-returns" title="Permalink to this heading">#</a></h4>
<p>We will use log returns to explore this first stylized fact only.
Simple returns cannot be less than -100%, so simple returns cannot be normally distributed.
However, log returns can approach positive and negative infinity.
Note that <code class="docutils literal notranslate"><span class="pre">np.log1p(X)</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">np.log(1</span> <span class="pre">+</span> <span class="pre">X)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;logR&#39;</span><span class="p">]]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>R</th>
      <th>logR</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07-01</th>
      <td>0.0011</td>
      <td>0.0011</td>
    </tr>
    <tr>
      <th>1926-07-02</th>
      <td>0.0046</td>
      <td>0.0046</td>
    </tr>
    <tr>
      <th>1926-07-06</th>
      <td>0.0018</td>
      <td>0.0018</td>
    </tr>
    <tr>
      <th>1926-07-07</th>
      <td>0.0010</td>
      <td>0.0010</td>
    </tr>
    <tr>
      <th>1926-07-08</th>
      <td>0.0022</td>
      <td>0.0022</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-12-23</th>
      <td>0.0053</td>
      <td>0.0052</td>
    </tr>
    <tr>
      <th>2022-12-27</th>
      <td>-0.0049</td>
      <td>-0.0050</td>
    </tr>
    <tr>
      <th>2022-12-28</th>
      <td>-0.0121</td>
      <td>-0.0122</td>
    </tr>
    <tr>
      <th>2022-12-29</th>
      <td>0.0189</td>
      <td>0.0187</td>
    </tr>
    <tr>
      <th>2022-12-30</th>
      <td>-0.0020</td>
      <td>-0.0020</td>
    </tr>
  </tbody>
</table>
<p>25399 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;Simple Return&#39;</span><span class="p">,</span>
    <span class="s1">&#39;logR&#39;</span><span class="p">:</span> <span class="s1">&#39;Log Return&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Simple Return</th>
      <th>Log Return</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Simple Return</th>
      <td>1.0000</td>
      <td>0.9997</td>
    </tr>
    <tr>
      <th>Log Return</th>
      <td>0.9997</td>
      <td>1.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;logR&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison of Daily Log and Simple Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0ee11fba4ceb6cfaaa007b81e4b9aafb97ec204de3d92a4d6dcb2380b9190c79.png" src="_images/0ee11fba4ceb6cfaaa007b81e4b9aafb97ec204de3d92a4d6dcb2380b9190c79.png" />
</div>
</div>
</section>
<section id="summary-statistics">
<h4>Summary statistics<a class="headerlink" href="#summary-statistics" title="Permalink to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">.describe()</span></code> method reports mean and standard deviation (the first and second moments of the distribution) but does not report skewness and kurtosis (the third and fourth moments).
However, we can use the <code class="docutils literal notranslate"><span class="pre">.skew()</span></code> and <code class="docutils literal notranslate"><span class="pre">.kurt()</span></code> methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Simple Return</th>
      <th>Log Return</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>25399.0000</td>
      <td>25399.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0004</td>
      <td>0.0004</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0108</td>
      <td>0.0108</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.1741</td>
      <td>-0.1913</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0039</td>
      <td>-0.0039</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0008</td>
      <td>0.0007</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0051</td>
      <td>0.0051</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1576</td>
      <td>0.1464</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skewness:        </span><span class="si">{</span><span class="n">mkt</span><span class="p">[</span><span class="s2">&quot;logR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Excess Kurtosis: </span><span class="si">{</span><span class="n">mkt</span><span class="p">[</span><span class="s2">&quot;logR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Skewness:        -0.47
Excess Kurtosis: 17.32
</pre></div>
</div>
</div>
</div>
<p>Both values are zero for the normal distribution.
Kurtosis is three for the normal distribution.
However, the <code class="docutils literal notranslate"><span class="pre">.kurt()</span></code> method reports <em>excess</em> kurtosis, which is kurtosis minus three.</p>
</section>
<section id="histograms-and-density-plots">
<h4>Histograms and density plots<a class="headerlink" href="#histograms-and-density-plots" title="Permalink to this heading">#</a></h4>
<p>Histograms provide another way to see the skewness and kurtosis of daily stock returns.
We can overlay a normal distribution with the same mean and standard deviation to highlight negative skewness and excess kurtosis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">scs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">scs</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">scale</span><span class="o">=</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Log Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of Daily Log Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9aa769fa37663549d5406e5a9c470165f4aada10c6dd1dfe8976897fbfbef4ed.png" src="_images/9aa769fa37663549d5406e5a9c470165f4aada10c6dd1dfe8976897fbfbef4ed.png" />
</div>
</div>
<p>If we zoom in, we can see that returns in the left tail (large magnitude negative returns) are much more likely than if they were normally distributed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">scs</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">scale</span><span class="o">=</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Log Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of Daily Log Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/de26ff2b36337183dca69fe81c8f09696352ec8c260beb0192c02c24acf6bbd2.png" src="_images/de26ff2b36337183dca69fe81c8f09696352ec8c260beb0192c02c24acf6bbd2.png" />
</div>
</div>
</section>
</section>
<section id="return-volatility-clusters-in-time">
<h3>Return volatility clusters in time<a class="headerlink" href="#return-volatility-clusters-in-time" title="Permalink to this heading">#</a></h3>
<p>Stock return volatility varies over time, with alternating periods of low and high volatility.
We can visualize volatility clustering by plotting the time series of returns and volatility.
To reduce noise, we can plot the monthly means and standard deviations of daily returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">totret</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span> <span class="c1"># kind=&#39;period&#39; gives dates in year-months instead of year-month-days</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">totret</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>totret</th>
      <th>std</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07</th>
      <td>0.0312</td>
      <td>0.0045</td>
    </tr>
    <tr>
      <th>1926-08</th>
      <td>0.0294</td>
      <td>0.0059</td>
    </tr>
    <tr>
      <th>1926-09</th>
      <td>0.0059</td>
      <td>0.0050</td>
    </tr>
    <tr>
      <th>1926-10</th>
      <td>-0.0299</td>
      <td>0.0084</td>
    </tr>
    <tr>
      <th>1926-11</th>
      <td>0.0290</td>
      <td>0.0038</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>In the top panel, we see that there are alternating periods of low magnitude and high magnitude mean daily returns.
In the bottom panel, we see that there are alternating periods of low and high volatility.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="o">=</span> <span class="n">mkt_m</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tot. Ret. (%)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Std. Dev. (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s1">&#39;Return Volatility Clusters in Time&#39;</span> <span class="o">+</span> 
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Monthly Aggregates of Daily Returns&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2f0a599d1744d1d1cc405429795dc31267b8c445ba871d421752d6dbb810b011.png" src="_images/2f0a599d1744d1d1cc405429795dc31267b8c445ba871d421752d6dbb810b011.png" />
</div>
</div>
</section>
<section id="returns-are-not-autocorrelated">
<h3>Returns are <em>not</em> autocorrelated<a class="headerlink" href="#returns-are-not-autocorrelated" title="Permalink to this heading">#</a></h3>
<p><em><strong>Stock returns today do not predict stock returns tomorrow.</strong></em>
Stock returns are <em>not</em> autocorrelated, and stock returns on one day are not correlated with stock returns on previous days.
Therefore, we cannot predict future returns with past returns.
We can show this with an autocorrelation plot of daily stock returns (autocorrelation and serial correlation are synonyms).
The height of each line indicates the correlation coefficient ($\rho$) between returns on day 0 and lag $t$ (i.e., day $0 - t$).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">mkt_lags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">corrs</span> <span class="o">=</span> <span class="n">mkt_lags</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">serrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corrs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mkt_lags</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">corrs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">serrs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Autocorrelation of Daily Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Lag&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Autocorrelation Coefficient&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/66fa62c4057dd5ddbfb62306be1a19adcee1b7ff683abe6f9e6ca52737ea81ca.png" src="_images/66fa62c4057dd5ddbfb62306be1a19adcee1b7ff683abe6f9e6ca52737ea81ca.png" />
</div>
</div>
<p>Above, we see small autocorrelations at lags 1 and 2, suggesting some return predictability.
However, the magnitudes are small and disappear in monthly data.</p>
<p>As a side note, if we plot autocorrelations for a single security instead of the market, we typically find weak, negative autocorrelations for the 1-day lags.
However, this is due to bid-ask bounce.
About half the time, positive returns follow negative returns (and <em>vice versa</em>) if closing prices randomly alternate between the bid and ask without changes in true prices.</p>
</section>
<section id="squared-returns-are-autocorrelated-with-slowly-decaying-autocorrelation">
<h3><em>Squared</em> returns <em>are</em> autocorrelated with slowly decaying autocorrelation<a class="headerlink" href="#squared-returns-are-autocorrelated-with-slowly-decaying-autocorrelation" title="Permalink to this heading">#</a></h3>
<p>Because volatility clusters in time, squared stock returns (and the absolute values of stock returns) are autocorrelated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">mkt_lags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">corrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">mkt_lags</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">serrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corrs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mkt_lags</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">corrs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">serrs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Autocorrelation of Squared Daily Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Lag&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Autocorrelation Coefficient&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/151040f6f4f701cc38a28d2a9131d486755b375b0d522d44a4a63a93fba5aa3e.png" src="_images/151040f6f4f701cc38a28d2a9131d486755b375b0d522d44a4a63a93fba5aa3e.png" />
</div>
</div>
</section>
<section id="fisher-black-s-leverage-effect-volatility-and-returns-are-negatively-related">
<h3>Fisher Black’s leverage effect - volatility and returns are negatively related<a class="headerlink" href="#fisher-black-s-leverage-effect-volatility-and-returns-are-negatively-related" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>One of the most enduring empirical regularities in equity markets is the inverse relationship between stock prices and volatility, first documented by Black (1976) who attributed it to the effects of financial leverage. As a company’s stock price declines, it becomes more highly leveraged given a fixed level of debt outstanding, and this increase in leverage induces a higher equity-return volatility… <a class="reference external" href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1762363">(Hasanhodzic and Lo, 2011)</a></p>
</div></blockquote>
<p>We can visualize the leverage effect by plotting the monthly mean and standard deviation of daily returns.
We typically want to report <em>annualized</em> mean and volatility of returns (i.e., multiply the mean and volatility of daily returns by 252 and $\sqrt{252}$).
However, we will plot daily values here  because some annualized values would be very large when we estimate means and volatilities using only one month of data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">totret</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;totret&#39;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">mkt_m</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Total Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility of Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s1">&#39;Fisher Black</span><span class="se">\&#39;</span><span class="s1">s Leverage Effect</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> 
    <span class="s1">&#39;(Monthly Aggregates of Daily Returns)&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/904cfb22b445746e245d49174e734ba2acda7a86a7f565991ae326849767b67c.png" src="_images/904cfb22b445746e245d49174e734ba2acda7a86a7f565991ae326849767b67c.png" />
</div>
</div>
</section>
<section id="conclusion">
<h3>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this heading">#</a></h3>
<p>Financial data analysts should know that real data do not exactly behave as we learn in finance 101.</p>
<ol class="arabic simple">
<li><p>Stock returns are non-Gaussian (not normally distributed) with:</p>
<ol class="arabic simple">
<li><p>Negative skew</p></li>
<li><p>Excess kurtosis</p></li>
</ol>
</li>
<li><p>Stock return volatility clusters in time</p></li>
<li><p>Stock returns are <em>not</em> autocorrelated</p></li>
<li><p><em>However,</em> squared stock returns <em>are</em> autocorrelated</p></li>
<li><p>Stock volatility and stock returns are inversely related</p></li>
</ol>
</section>
<div class="toctree-wrapper compound">
<span id="document-herron_07_practice"></span><section id="herron-topic-7-practice-blank">
<h3>Herron Topic 7 - Practice (Blank)<a class="headerlink" href="#herron-topic-7-practice-blank" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<section id="repeat-the-comparison-of-log-and-simple-returns-with-monthly-and-annual-returns">
<h5>Repeat the comparison of log and simple returns with monthly and annual returns<a class="headerlink" href="#repeat-the-comparison-of-log-and-simple-returns-with-monthly-and-annual-returns" title="Permalink to this heading">#</a></h5>
</section>
<section id="repeat-the-autocorrelation-plot-with-monthly-returns-instead-of-daily-returns">
<h5>Repeat the autocorrelation plot with <em>monthly</em> returns instead of <em>daily</em> returns<a class="headerlink" href="#repeat-the-autocorrelation-plot-with-monthly-returns-instead-of-daily-returns" title="Permalink to this heading">#</a></h5>
</section>
<section id="plot-monthly-returns-versus-their-one-month-lag">
<h5>Plot monthly returns versus their one-month lag<a class="headerlink" href="#plot-monthly-returns-versus-their-one-month-lag" title="Permalink to this heading">#</a></h5>
</section>
<section id="repeat-the-autocorrelation-plot-with-the-absolute-value-of-daily-returns">
<h5>Repeat the autocorrelation plot with the <em>absolute value</em> of daily returns<a class="headerlink" href="#repeat-the-autocorrelation-plot-with-the-absolute-value-of-daily-returns" title="Permalink to this heading">#</a></h5>
</section>
<section id="repeat-the-leverage-effect-plot-with-lagged-returns">
<h5>Repeat the leverage effect plot with lagged returns<a class="headerlink" href="#repeat-the-leverage-effect-plot-with-lagged-returns" title="Permalink to this heading">#</a></h5>
</section>
</section>
</section>
<span id="document-herron_07_practice_03"></span><section id="herron-topic-7-practice-monday-2-45-pm-section-3">
<h3>Herron Topic 7 - Practice (Monday 2:45 PM, Section 3)<a class="headerlink" href="#herron-topic-7-practice-monday-2-45-pm-section-3" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 7 (our last quiz!) is due Friday, 4/14, at 11:59 PM</p></li>
<li><p>Week of 4/17</p>
<ul>
<li><p>I will record a lecture for Herron topic 5 on simulations and post a practice notebook</p></li>
<li><p>However, we will use class time for group work</p></li>
<li><p>This is a compromise between survey responses (1/3 wanted to drop simulations, 2/3 did not) and Monday’s holiday (Patriot’s Day)</p></li>
</ul>
</li>
<li><p>Week of 4/24</p>
<ul>
<li><p>No lecture</p></li>
<li><p>We will use class time for group work</p></li>
</ul>
</li>
<li><p>Due dates</p>
<ul>
<li><p>Project 2 at 11:59 PM on Wednesday, 4/26</p></li>
<li><p>Teammates review 2 at 11:59 PM on Wednesday, 4/26</p></li>
<li><p>30,000 DataCamp XP at 11:59 PM on Friday, 4/28</p></li>
</ul>
</li>
<li><p><em><strong>Please complete TRACE feedback on what topics, tools, and techniques you want more of</strong></em></p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;logR&#39;</span><span class="p">]]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;Simple Return&#39;</span><span class="p">,</span>
    <span class="s1">&#39;logR&#39;</span><span class="p">:</span> <span class="s1">&#39;Log Return&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<section id="repeat-the-comparison-of-log-and-simple-returns-with-monthly-and-annual-returns">
<h5>Repeat the comparison of log and simple returns with monthly and annual returns<a class="headerlink" href="#repeat-the-comparison-of-log-and-simple-returns-with-monthly-and-annual-returns" title="Permalink to this heading">#</a></h5>
<p>We could download monthly and annual data from the Ken French data library.
However, we can also use the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method to compound daily returns into monthly and annual returns.
Let us use the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method (1) for practice and (2) because the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> code is simpler and more compact than the <code class="docutils literal notranslate"><span class="pre">pdr.DataReader()</span></code> code.
We need to re-calculate the log return.
We could instead sum the daily log returns, but combining the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method with two different operations on two differ columns is complex and easily avoided here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">totret</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkt</span><span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_a</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkt</span><span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We want to repeat this plot for monthly and annual returns, so we can make out lives easier by writing a function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_compare_returns</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">labs</span><span class="o">=</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">x</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;logR&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Comparison of </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Log and Simple Returns&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">labs</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">labs</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Log and simple returns are similar for small returns.
We almost always see small daily returns, which rarely exceed 10% in magnitude.
However, at monthly frequencies, we start to see large outliers, where the similarity of log and simple returns starts to break down.</p>
<p>Recall the <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> method allows us to think “data first”.
Here <code class="docutils literal notranslate"><span class="pre">mkt_m.pipe(plot_compare_returns,</span> <span class="pre">freq='Monthly')</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">plot_compare_returns(mkt_m,</span> <span class="pre">freq='Monthly')</span></code>.
One is not better than the other, but I find it useful to think “data, then operation, then operation, …”, instead of “operation, then operation, …, then data”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_compare_returns</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Monthly&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9da6a387ba9225585f23ec07e7688582194b74a315970a52fe7835f195a9cae0.png" src="_images/9da6a387ba9225585f23ec07e7688582194b74a315970a52fe7835f195a9cae0.png" />
</div>
</div>
<p>At annual frequencies, log and simple returns can be quite different!
For example, at $R_{simple} \approx 0.6$, we see $R_{log} \approx 0.4$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_a</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_compare_returns</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/855454bf37961990bedd4c816260c33de93e0077db52c38663f212a23a1127f2.png" src="_images/855454bf37961990bedd4c816260c33de93e0077db52c38663f212a23a1127f2.png" />
</div>
</div>
</section>
<section id="repeat-the-autocorrelation-plot-with-monthly-returns-instead-of-daily-returns">
<h5>Repeat the autocorrelation plot with <em>monthly</em> returns instead of <em>daily</em> returns<a class="headerlink" href="#repeat-the-autocorrelation-plot-with-monthly-returns-instead-of-daily-returns" title="Permalink to this heading">#</a></h5>
<p>Again, we will write a function to plot these autocorrelations.</p>
</section>
<section id="plot-monthly-returns-versus-their-one-month-lag">
<h5>Plot monthly returns versus their one-month lag<a class="headerlink" href="#plot-monthly-returns-versus-their-one-month-lag" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_autocorr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labs</span><span class="o">=</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">x_lags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">corrs</span> <span class="o">=</span> <span class="n">x_lags</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">serrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corrs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_lags</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">corrs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">serrs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;Autocorrelation of </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Returns&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Lag&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Autocorrelation Coefficient&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>At the monthly horizon, return autocorrelation weakens!
All autocorrelation coefficient estimates are small and less than two standard errors away from zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_autocorr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Monthly&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/577eff5e19e19dc54941bc7a9834ee62adebb90307d7950137937ecbff02aa19.png" src="_images/577eff5e19e19dc54941bc7a9834ee62adebb90307d7950137937ecbff02aa19.png" />
</div>
</div>
<p>At the annual horizon, return autocorrelation disappears!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_a</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_autocorr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dab8e1e9e00f986ab847e9a1a2c2afdd7231c32adf286c828b84b9f47c7c3308.png" src="_images/dab8e1e9e00f986ab847e9a1a2c2afdd7231c32adf286c828b84b9f47c7c3308.png" />
</div>
</div>
</section>
<section id="repeat-the-autocorrelation-plot-with-the-absolute-value-of-daily-returns">
<h5>Repeat the autocorrelation plot with the <em>absolute value</em> of daily returns<a class="headerlink" href="#repeat-the-autocorrelation-plot-with-the-absolute-value-of-daily-returns" title="Permalink to this heading">#</a></h5>
<p>We can use our function again!
But first, we have to convert simple returns to the <em>absolute value</em> of simple returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">mkt</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_autocorr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Absolute Value of Daily&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d3d7bf9c70dc6c456097b3d68a8ee74b909e4e809e7c5da6b7afc41f17dcc8e3.png" src="_images/d3d7bf9c70dc6c456097b3d68a8ee74b909e4e809e7c5da6b7afc41f17dcc8e3.png" />
</div>
</div>
<p>Saying that “squared returns” or “the absolute value of returns” is autocorrelated is similar to saying “return magnitudes” are autocorrelated, which is similar to saying “volatility” is autocorrelated or persistent.</p>
</section>
<section id="repeat-the-leverage-effect-plot-with-lagged-returns">
<h5>Repeat the leverage effect plot with lagged returns<a class="headerlink" href="#repeat-the-leverage-effect-plot-with-lagged-returns" title="Permalink to this heading">#</a></h5>
<p>We will only make this plot, but we can still write a function!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_leverage_effect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
    <span class="p">(</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">totret</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">totret_lag</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;totret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
              <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
                  <span class="n">x</span><span class="o">=</span><span class="s1">&#39;totret_lag&#39;</span><span class="p">,</span> 
                  <span class="n">y</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> 
                  <span class="n">data</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                  <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;One-</span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Lag of Total Return (%)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility of Returns (%)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
        <span class="s1">&#39;Fisher Black</span><span class="se">\&#39;</span><span class="s1">s Leverage Effect</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> 
        <span class="sa">f</span><span class="s1">&#39;(Daily Returns Aggregated by </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_leverage_effect</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/62e7001c503c8e60917b5100d02409dcd3ccf9c7e9ece1ec61310b466678b5e4.png" src="_images/62e7001c503c8e60917b5100d02409dcd3ccf9c7e9ece1ec61310b466678b5e4.png" />
</div>
</div>
<p>Since we have the function, let use a try a few different horizons!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_leverage_effect</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Quarter&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ff976ba304a97f96d983f02f7485f56eb23bfd23cfbcfd87033ab33a9f5ccaeb.png" src="_images/ff976ba304a97f96d983f02f7485f56eb23bfd23cfbcfd87033ab33a9f5ccaeb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_leverage_effect</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/46a58722d1a1c1c4c0fdb996dbfea5e9a3cc031b37dabf1b49a0f8fae607a745.png" src="_images/46a58722d1a1c1c4c0fdb996dbfea5e9a3cc031b37dabf1b49a0f8fae607a745.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-herron_07_practice_04"></span><section id="herron-topic-7-practice-wednesday-11-45-am-section-4">
<h3>Herron Topic 7 - Practice (Wednesday 11:45 AM, Section 4)<a class="headerlink" href="#herron-topic-7-practice-wednesday-11-45-am-section-4" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 7 (our last quiz!) is due Friday, 4/14, at 11:59 PM</p></li>
<li><p>Week of 4/17</p>
<ul>
<li><p>I will record a lecture for Herron topic 5 on simulations and post a practice notebook</p></li>
<li><p>However, we will use class time for group work</p></li>
<li><p>This is a compromise between survey responses (1/3 wanted to drop simulations, 2/3 did not) and Monday’s holiday (Patriot’s Day)</p></li>
</ul>
</li>
<li><p>Week of 4/24</p>
<ul>
<li><p>No lecture</p></li>
<li><p>We will use class time for group work</p></li>
</ul>
</li>
<li><p>Due dates</p>
<ul>
<li><p>Project 2 at 11:59 PM on Wednesday, 4/26</p></li>
<li><p>Teammates review 2 at 11:59 PM on Wednesday, 4/26</p></li>
<li><p>30,000 DataCamp XP at 11:59 PM on Friday, 4/28</p></li>
</ul>
</li>
<li><p><em><strong>Please complete TRACE feedback on what topics, tools, and techniques you want more of</strong></em></p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;logR&#39;</span><span class="p">]]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;Simple Return&#39;</span><span class="p">,</span>
    <span class="s1">&#39;logR&#39;</span><span class="p">:</span> <span class="s1">&#39;Log Return&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<section id="repeat-the-comparison-of-log-and-simple-returns-with-monthly-and-annual-returns">
<h5>Repeat the comparison of log and simple returns with monthly and annual returns<a class="headerlink" href="#repeat-the-comparison-of-log-and-simple-returns-with-monthly-and-annual-returns" title="Permalink to this heading">#</a></h5>
<p>We could download monthly and annual data from the Ken French data library.
However, we can also use the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method to compound daily returns into monthly and annual returns.
Let us use the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method (1) for practice and (2) because the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> code is simpler and more compact than the <code class="docutils literal notranslate"><span class="pre">pdr.DataReader()</span></code> code.
We need to re-calculate the log return.
We could instead sum the daily log returns, but combining the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method with two different operations on two differ columns is complex and easily avoided here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">totret</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkt</span><span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_a</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkt</span><span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We want to repeat this plot for monthly and annual returns, so we can make out lives easier by writing a function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_compare_returns</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">labs</span><span class="o">=</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">x</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;logR&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Comparison of </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Log and Simple Returns&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">labs</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">labs</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Log and simple returns are similar for small returns.
We almost always see small daily returns, which rarely exceed 10% in magnitude.
However, at monthly frequencies, we start to see large outliers, where the similarity of log and simple returns starts to break down.</p>
<p>Recall the <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> method allows us to think “data first”.
Here <code class="docutils literal notranslate"><span class="pre">mkt_m.pipe(plot_compare_returns,</span> <span class="pre">freq='Monthly')</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">plot_compare_returns(mkt_m,</span> <span class="pre">freq='Monthly')</span></code>.
One is not better than the other, but I find it useful to think “data, then operation, then operation, …”, instead of “operation, then operation, …, then data”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_compare_returns</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Monthly&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9da6a387ba9225585f23ec07e7688582194b74a315970a52fe7835f195a9cae0.png" src="_images/9da6a387ba9225585f23ec07e7688582194b74a315970a52fe7835f195a9cae0.png" />
</div>
</div>
<p>At annual frequencies, log and simple returns can be quite different!
For example, at $R_{simple} \approx 0.6$, we see $R_{log} \approx 0.4$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_a</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_compare_returns</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/91cdd1a6918dd2338d6e0bca41671f9f1ec0bb9d5d3f929ce8578b058048cf54.png" src="_images/91cdd1a6918dd2338d6e0bca41671f9f1ec0bb9d5d3f929ce8578b058048cf54.png" />
</div>
</div>
</section>
<section id="repeat-the-autocorrelation-plot-with-monthly-returns-instead-of-daily-returns">
<h5>Repeat the autocorrelation plot with <em>monthly</em> returns instead of <em>daily</em> returns<a class="headerlink" href="#repeat-the-autocorrelation-plot-with-monthly-returns-instead-of-daily-returns" title="Permalink to this heading">#</a></h5>
<p>Again, we will write a function to plot these autocorrelations.</p>
</section>
<section id="plot-monthly-returns-versus-their-one-month-lag">
<h5>Plot monthly returns versus their one-month lag<a class="headerlink" href="#plot-monthly-returns-versus-their-one-month-lag" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_autocorr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labs</span><span class="o">=</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">x_lags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">corrs</span> <span class="o">=</span> <span class="n">x_lags</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">serrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corrs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_lags</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">corrs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">serrs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;Autocorrelation of </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Returns&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Lag&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Autocorrelation Coefficient&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>At the monthly horizon, return autocorrelation weakens!
All autocorrelation coefficient estimates are small and less than two standard errors away from zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_autocorr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Monthly&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e50eaaa95743b0cfbb3f396f86d62395449865d5d37837b808ec8883ec31cd3f.png" src="_images/e50eaaa95743b0cfbb3f396f86d62395449865d5d37837b808ec8883ec31cd3f.png" />
</div>
</div>
<p>At the annual horizon, return autocorrelation disappears!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_a</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_autocorr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/464841c0b36ed50158550c2c63776c49d41933e9b37ec4d568cdf332d6b0ed28.png" src="_images/464841c0b36ed50158550c2c63776c49d41933e9b37ec4d568cdf332d6b0ed28.png" />
</div>
</div>
</section>
<section id="repeat-the-autocorrelation-plot-with-the-absolute-value-of-daily-returns">
<h5>Repeat the autocorrelation plot with the <em>absolute value</em> of daily returns<a class="headerlink" href="#repeat-the-autocorrelation-plot-with-the-absolute-value-of-daily-returns" title="Permalink to this heading">#</a></h5>
<p>We can use our function again!
But first, we have to convert simple returns to the <em>absolute value</em> of simple returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">mkt</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_autocorr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Absolute Value of Daily&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cc8f241a78be63b790360cc93abd6d31ac40c11d0865e6e2dd7c866cd2d56c71.png" src="_images/cc8f241a78be63b790360cc93abd6d31ac40c11d0865e6e2dd7c866cd2d56c71.png" />
</div>
</div>
<p>Saying that “squared returns” or “the absolute value of returns” is autocorrelated is similar to saying “return magnitudes” are autocorrelated, which is similar to saying “volatility” is autocorrelated or persistent.</p>
</section>
<section id="repeat-the-leverage-effect-plot-with-lagged-returns">
<h5>Repeat the leverage effect plot with lagged returns<a class="headerlink" href="#repeat-the-leverage-effect-plot-with-lagged-returns" title="Permalink to this heading">#</a></h5>
<p>We will only make this plot, but we can still write a function!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_leverage_effect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
    <span class="p">(</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">totret</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">totret_lag</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;totret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
              <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
                  <span class="n">x</span><span class="o">=</span><span class="s1">&#39;totret_lag&#39;</span><span class="p">,</span> 
                  <span class="n">y</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> 
                  <span class="n">data</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                  <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;One-</span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Lag of Total Return (%)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility of Returns (%)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
        <span class="s1">&#39;Fisher Black</span><span class="se">\&#39;</span><span class="s1">s Leverage Effect</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> 
        <span class="sa">f</span><span class="s1">&#39;(Daily Returns Aggregated by </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_leverage_effect</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dc5d4ab1c17eac3a39783c8593ac95e7e21f3fef4a1db544511381b01cb0aac5.png" src="_images/dc5d4ab1c17eac3a39783c8593ac95e7e21f3fef4a1db544511381b01cb0aac5.png" />
</div>
</div>
<p>Since we have the function, let use a try a few different horizons!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_leverage_effect</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Quarter&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ed8fcea3fa622d1091b742e5696426cd6e1126d699f885265956cd9275417d2f.png" src="_images/ed8fcea3fa622d1091b742e5696426cd6e1126d699f885265956cd9275417d2f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_leverage_effect</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/54ee36ce8bcd7250990a5d43a889d720ffe64dc13e9132e142b04b10d0be6274.png" src="_images/54ee36ce8bcd7250990a5d43a889d720ffe64dc13e9132e142b04b10d0be6274.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-herron_07_practice_02"></span><section id="herron-topic-7-practice-wednesday-2-45-pm-section-2">
<h3>Herron Topic 7 - Practice (Wednesday 2:45 PM, Section 2)<a class="headerlink" href="#herron-topic-7-practice-wednesday-2-45-pm-section-2" title="Permalink to this heading">#</a></h3>
<section id="announcements">
<h4>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Quiz 7 (our last quiz!) is due Friday, 4/14, at 11:59 PM</p></li>
<li><p>Week of 4/17</p>
<ul>
<li><p>I will record a lecture for Herron topic 5 on simulations and post a practice notebook</p></li>
<li><p>However, we will use class time for group work</p></li>
<li><p>This is a compromise between survey responses (1/3 wanted to drop simulations, 2/3 did not) and Monday’s holiday (Patriot’s Day)</p></li>
</ul>
</li>
<li><p>Week of 4/24</p>
<ul>
<li><p>No lecture</p></li>
<li><p>We will use class time for group work</p></li>
</ul>
</li>
<li><p>Due dates</p>
<ul>
<li><p>Project 2 at 11:59 PM on Wednesday, 4/26</p></li>
<li><p>Teammates review 2 at 11:59 PM on Wednesday, 4/26</p></li>
<li><p>30,000 DataCamp XP at 11:59 PM on Friday, 4/28</p></li>
</ul>
</li>
<li><p><em><strong>Please complete TRACE feedback on what topics, tools, and techniques you want more of</strong></em></p></li>
</ul>
</section>
<section id="practice">
<h4>Practice<a class="headerlink" href="#practice" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;F-F_Research_Data_Factors_daily&#39;</span><span class="p">,</span>
        <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;logR&#39;</span><span class="p">]]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;Simple Return&#39;</span><span class="p">,</span>
    <span class="s1">&#39;logR&#39;</span><span class="p">:</span> <span class="s1">&#39;Log Return&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<section id="repeat-the-comparison-of-log-and-simple-returns-with-monthly-and-annual-returns">
<h5>Repeat the comparison of log and simple returns with monthly and annual returns<a class="headerlink" href="#repeat-the-comparison-of-log-and-simple-returns-with-monthly-and-annual-returns" title="Permalink to this heading">#</a></h5>
<p>We could download monthly and annual data from the Ken French data library.
However, we can also use the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method to compound daily returns into monthly and annual returns.
Let us use the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method (1) for practice and (2) because the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> code is simpler and more compact than the <code class="docutils literal notranslate"><span class="pre">pdr.DataReader()</span></code> code.
We need to re-calculate the log return.
We could instead sum the daily log returns, but combining the <code class="docutils literal notranslate"><span class="pre">.resample()</span></code> method with two different operations on two differ columns is complex and easily avoided here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">totret</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkt</span><span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_a</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mkt</span><span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">totret</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">logR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We want to repeat this plot for monthly and annual returns, so we can make out lives easier by writing a function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_compare_returns</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">labs</span><span class="o">=</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">x</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;logR&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Comparison of </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Log and Simple Returns&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">labs</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">labs</span><span class="p">[</span><span class="s1">&#39;logR&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Log and simple returns are similar for small returns.
We almost always see small daily returns, which rarely exceed 10% in magnitude.
However, at monthly frequencies, we start to see large outliers, where the similarity of log and simple returns starts to break down.</p>
<p>Recall the <code class="docutils literal notranslate"><span class="pre">.pipe()</span></code> method allows us to think “data first”.
Here <code class="docutils literal notranslate"><span class="pre">mkt_m.pipe(plot_compare_returns,</span> <span class="pre">freq='Monthly')</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">plot_compare_returns(mkt_m,</span> <span class="pre">freq='Monthly')</span></code>.
One is not better than the other, but I find it useful to think “data, then operation, then operation, …”, instead of “operation, then operation, …, then data”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_compare_returns</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Monthly&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9da6a387ba9225585f23ec07e7688582194b74a315970a52fe7835f195a9cae0.png" src="_images/9da6a387ba9225585f23ec07e7688582194b74a315970a52fe7835f195a9cae0.png" />
</div>
</div>
<p>At annual frequencies, log and simple returns can be quite different!
For example, at $R_{simple} \approx 0.6$, we see $R_{log} \approx 0.4$.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_a</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_compare_returns</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/91cdd1a6918dd2338d6e0bca41671f9f1ec0bb9d5d3f929ce8578b058048cf54.png" src="_images/91cdd1a6918dd2338d6e0bca41671f9f1ec0bb9d5d3f929ce8578b058048cf54.png" />
</div>
</div>
</section>
<section id="repeat-the-autocorrelation-plot-with-monthly-returns-instead-of-daily-returns">
<h5>Repeat the autocorrelation plot with <em>monthly</em> returns instead of <em>daily</em> returns<a class="headerlink" href="#repeat-the-autocorrelation-plot-with-monthly-returns-instead-of-daily-returns" title="Permalink to this heading">#</a></h5>
<p>Again, we will write a function to plot these autocorrelations.</p>
</section>
<section id="plot-monthly-returns-versus-their-one-month-lag">
<h5>Plot monthly returns versus their one-month lag<a class="headerlink" href="#plot-monthly-returns-versus-their-one-month-lag" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_autocorr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labs</span><span class="o">=</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">x_lags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">corrs</span> <span class="o">=</span> <span class="n">x_lags</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">serrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corrs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_lags</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">corrs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">serrs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;Autocorrelation of </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Returns&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Black Vertical Bars Indicate Standard Errors&#39;</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Lag&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Autocorrelation Coefficient&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>At the monthly horizon, return autocorrelation weakens!
All autocorrelation coefficient estimates are small and less than two standard errors away from zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_m</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_autocorr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Monthly&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e50eaaa95743b0cfbb3f396f86d62395449865d5d37837b808ec8883ec31cd3f.png" src="_images/e50eaaa95743b0cfbb3f396f86d62395449865d5d37837b808ec8883ec31cd3f.png" />
</div>
</div>
<p>At the annual horizon, return autocorrelation disappears!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt_a</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_autocorr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/464841c0b36ed50158550c2c63776c49d41933e9b37ec4d568cdf332d6b0ed28.png" src="_images/464841c0b36ed50158550c2c63776c49d41933e9b37ec4d568cdf332d6b0ed28.png" />
</div>
</div>
</section>
<section id="repeat-the-autocorrelation-plot-with-the-absolute-value-of-daily-returns">
<h5>Repeat the autocorrelation plot with the <em>absolute value</em> of daily returns<a class="headerlink" href="#repeat-the-autocorrelation-plot-with-the-absolute-value-of-daily-returns" title="Permalink to this heading">#</a></h5>
<p>We can use our function again!
But first, we have to convert simple returns to the <em>absolute value</em> of simple returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">mkt</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_autocorr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Absolute Value of Daily&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cc8f241a78be63b790360cc93abd6d31ac40c11d0865e6e2dd7c866cd2d56c71.png" src="_images/cc8f241a78be63b790360cc93abd6d31ac40c11d0865e6e2dd7c866cd2d56c71.png" />
</div>
</div>
<p>Saying that “squared returns” or “the absolute value of returns” is autocorrelated is similar to saying “return magnitudes” are autocorrelated, which is similar to saying “volatility” is autocorrelated or persistent.</p>
</section>
<section id="repeat-the-leverage-effect-plot-with-lagged-returns">
<h5>Repeat the leverage effect plot with lagged returns<a class="headerlink" href="#repeat-the-leverage-effect-plot-with-lagged-returns" title="Permalink to this heading">#</a></h5>
<p>We will only make this plot, but we can still write a function!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_leverage_effect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
    <span class="p">(</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">totret</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">totret_lag</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;totret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
              <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
                  <span class="n">x</span><span class="o">=</span><span class="s1">&#39;totret_lag&#39;</span><span class="p">,</span> 
                  <span class="n">y</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> 
                  <span class="n">data</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                  <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;One-</span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> Lag of Total Return (%)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility of Returns (%)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
        <span class="s1">&#39;Fisher Black</span><span class="se">\&#39;</span><span class="s1">s Leverage Effect</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> 
        <span class="sa">f</span><span class="s1">&#39;(Daily Returns Aggregated by </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_leverage_effect</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b23fd71fc13e9a18e65dcc695f8b94000cb9cfdc1ea9fbd84b5559b54166ed22.png" src="_images/b23fd71fc13e9a18e65dcc695f8b94000cb9cfdc1ea9fbd84b5559b54166ed22.png" />
</div>
</div>
<p>Since we have the function, let use a try a few different horizons!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_leverage_effect</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Quarter&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4aea303060f95e8ebc6fa066317af74180a96d10a65d6ec7eb41c225bb93b389.png" src="_images/4aea303060f95e8ebc6fa066317af74180a96d10a65d6ec7eb41c225bb93b389.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">plot_leverage_effect</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Annual&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b558f57c6bf8364ad9d969e983e09b83213e07b01e821eea53c09352d4f9c20d.png" src="_images/b558f57c6bf8364ad9d969e983e09b83213e07b01e821eea53c09352d4f9c20d.png" />
</div>
</div>
</section>
</section>
</section>
</div>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-quiz_01"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize Otter</span>
<span class="kn">import</span> <span class="nn">otter</span>
<span class="n">grader</span> <span class="o">=</span> <span class="n">otter</span><span class="o">.</span><span class="n">Notebook</span><span class="p">(</span><span class="s2">&quot;quiz_01.ipynb&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="quiz-1">
<h2>Quiz 1<a class="headerlink" href="#quiz-1" title="Permalink to this heading">#</a></h2>
<section id="instructions">
<h3>Instructions<a class="headerlink" href="#instructions" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>After you answer a question, you should run its public tests.</p></li>
<li><p>After you answer every question, you should:</p>
<ol class="arabic simple">
<li><p>Restart your kernel and clear all output</p></li>
<li><p>Run up to the last cell</p></li>
<li><p>Save your notebook</p></li>
<li><p>Run the last cell to create a .zip file for Gradescope</p></li>
<li><p>Upload this .zip file to Gradescope</p></li>
<li><p><em><strong>Make sure your local autograder results match your Gradescope autograder results</strong></em></p></li>
</ol>
</li>
<li><p>This quiz has public and hidden tests:</p>
<ol class="arabic simple">
<li><p>Public tests check if your answers are the correct types and shapes, but they may not check if your answers are exactly correct</p></li>
<li><p>Hidden tests check if your answers are exactly correct, but their results are not available until after the due date</p></li>
</ol>
</li>
<li><p>You may ask technical questions on Canvas Discussions, but the quiz is an individual effort.</p></li>
</ol>
</section>
<section id="questions">
<h3>Questions<a class="headerlink" href="#questions" title="Permalink to this heading">#</a></h3>
<section id="question-1">
<h4>Question 1<a class="headerlink" href="#question-1" title="Permalink to this heading">#</a></h4>
<p>Create a list named <code class="docutils literal notranslate"><span class="pre">list_1</span></code> that contains the squares for integers from 1 to 100.
The first and last values in <code class="docutils literal notranslate"><span class="pre">list_1</span></code> should be $1^2 = 1$ and $100^2 = 10,000$, respectively.</p>
<p><em>Points:</em> 30</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grader</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;q1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="question-2">
<h4>Question 2<a class="headerlink" href="#question-2" title="Permalink to this heading">#</a></h4>
<p>Create an integer <code class="docutils literal notranslate"><span class="pre">int_2</span></code> that contains the sum of squared integers from 1 to 100 inclusive.
This <code class="docutils literal notranslate"><span class="pre">int_2</span></code> contains the sum of the values in <code class="docutils literal notranslate"><span class="pre">list_1</span></code> from question 1.</p>
<p><em>Points:</em> 30</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grader</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;q2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="question-3">
<h4>Question 3<a class="headerlink" href="#question-3" title="Permalink to this heading">#</a></h4>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">fun_3</span></code> that sums that squares of integers between its arguments <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">stop</span></code> inclusive.
If <code class="docutils literal notranslate"><span class="pre">start=1</span></code> and <code class="docutils literal notranslate"><span class="pre">stop=2</span></code>, <code class="docutils literal notranslate"><span class="pre">fun_3</span></code> should return $1^2 + 2^2 = 1 + 4 = 5$.
If <code class="docutils literal notranslate"><span class="pre">start=1</span></code> and <code class="docutils literal notranslate"><span class="pre">stop=100</span></code>, <code class="docutils literal notranslate"><span class="pre">fun_3</span></code> should return your answer from question 2.
I will test your function at several values of <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">stop</span></code>, you may assume that <code class="docutils literal notranslate"><span class="pre">stop</span></code> is always greater than <code class="docutils literal notranslate"><span class="pre">start</span></code>.</p>
<p><em><strong>Note:</strong></em>
This question has 1 hidden test worth 10 points.
The autograder will not show you hidden test results until after the due date, and Gradescope will show your quiz score as <code class="docutils literal notranslate"><span class="pre">~/100</span></code> until after the due date.</p>
<p><em>Points:</em> 40</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fun_3</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grader</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;q3&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="submission">
<h3>Submission<a class="headerlink" href="#submission" title="Permalink to this heading">#</a></h3>
<p>Make sure you have run all cells in your notebook in order before running the cell below, so that all images/graphs appear in the output. The cell below will generate a zip file for you to submit. <strong>Please save before exporting!</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save your notebook first, then run this cell to export your submission.</span>
<span class="n">grader</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">pdf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_tests</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<span id="document-quiz_02"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize Otter</span>
<span class="kn">import</span> <span class="nn">otter</span>
<span class="n">grader</span> <span class="o">=</span> <span class="n">otter</span><span class="o">.</span><span class="n">Notebook</span><span class="p">(</span><span class="s2">&quot;quiz_02.ipynb&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="quiz-2">
<h2>Quiz 2<a class="headerlink" href="#quiz-2" title="Permalink to this heading">#</a></h2>
<section id="instructions">
<h3>Instructions<a class="headerlink" href="#instructions" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>After you answer a question, you should run its public tests.</p></li>
<li><p>After you answer every question, you should:</p>
<ol class="arabic simple">
<li><p>Restart your kernel and clear all output</p></li>
<li><p>Run up to the last cell</p></li>
<li><p>Save your notebook</p></li>
<li><p>Run the last cell to create a .zip file for Gradescope</p></li>
<li><p>Upload this .zip file to Gradescope</p></li>
<li><p><em><strong>Make sure your local autograder results match your Gradescope autograder results</strong></em></p></li>
</ol>
</li>
<li><p>This quiz has public and hidden tests:</p>
<ol class="arabic simple">
<li><p>Public tests check your answers for correct types and shapes but may not completely check your answers</p></li>
<li><p>Hidden tests completely check your answers but will not be available until after the due date</p></li>
</ol>
</li>
<li><p>You may ask technical questions on Canvas Discussions, but the quiz is an individual effort.</p></li>
</ol>
</section>
<section id="packages-and-settings">
<h3>Packages and Settings<a class="headerlink" href="#packages-and-settings" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">%</span><span class="k">precision</span> 4
</pre></div>
</div>
</div>
</div>
</section>
<section id="questions">
<h3>Questions<a class="headerlink" href="#questions" title="Permalink to this heading">#</a></h3>
<section id="question-1">
<h4>Question 1<a class="headerlink" href="#question-1" title="Permalink to this heading">#</a></h4>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">npv()</span></code> that calculates the net present value of a NumPy array of cashflows given a discount rate.
Assume the following:</p>
<ol class="arabic simple">
<li><p>Argument <code class="docutils literal notranslate"><span class="pre">c</span></code> is a NumPy array of annual cash flows, starting at $t=0$</p></li>
<li><p>Argument <code class="docutils literal notranslate"><span class="pre">r</span></code> is a float of the annual discount rate as a decimal (i.e., <code class="docutils literal notranslate"><span class="pre">r=0.1</span></code> indicates $r=10%$)</p></li>
</ol>
<p><em><strong>Note: This question has 1 hidden test worth a total of 20 points.</strong></em></p>
<p><em>Points:</em> 50</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">npv</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grader</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;q1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="question-2">
<h4>Question 2<a class="headerlink" href="#question-2" title="Permalink to this heading">#</a></h4>
<p>Write a function <code class="docutils literal notranslate"><span class="pre">totret()</span></code> that calculates the total return of a NumPy array of returns.
Assume the following:</p>
<ol class="arabic simple">
<li><p>Argument <code class="docutils literal notranslate"><span class="pre">r</span></code> is a NumPy array of decimal returns (i.e., <code class="docutils literal notranslate"><span class="pre">r</span></code>=0.1 indicates $r=10%$ and $r &gt; -100%$ for all $r$)</p></li>
<li><p>Function <code class="docutils literal notranslate"><span class="pre">totret()</span></code> should return total return as a decimal</p></li>
</ol>
<p><em><strong>Note: This question has 2 hidden tests worth a total of 20 points.</strong></em></p>
<p><em>Points:</em> 50</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">totret</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grader</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;q2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="submission">
<h3>Submission<a class="headerlink" href="#submission" title="Permalink to this heading">#</a></h3>
<p>Make sure you have run all cells in your notebook in order before running the cell below, so that all images/graphs appear in the output. The cell below will generate a zip file for you to submit. <strong>Please save before exporting!</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save your notebook first, then run this cell to export your submission.</span>
<span class="n">grader</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">pdf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_tests</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<span id="document-quiz_03"></span><section id="quiz-3">
<h2>Quiz 3<a class="headerlink" href="#quiz-3" title="Permalink to this heading">#</a></h2>
<p>Quiz 3 involves two data files.
I zipped the notebook and two data files into one file, but I cannot include zip files on this website.
Therefore, I posted this file to Canvas under <a class="reference external" href="https://northeastern.instructure.com/courses/137565/files/folder/Quiz%20Zips">Files/Quiz Zips</a>.
I linked this file from the Canvas assignment, too.
Download and extract this file, leaving the file names and relative positions as-is.</p>
</section>
<span id="document-quiz_04"></span><section id="quiz-4">
<h2>Quiz 4<a class="headerlink" href="#quiz-4" title="Permalink to this heading">#</a></h2>
<p>Quiz 4 involves one data file.
I zipped the notebook and data file into one file, but I cannot include zip files on this website.
Therefore, I posted this file to Canvas under <a class="reference external" href="https://northeastern.instructure.com/courses/137565/files/folder/Quiz%20Zips">Files/Quiz Zips</a>.
I linked this file from the Canvas assignment, too.
Download and extract this file, leaving the file names and relative positions as-is.</p>
</section>
<span id="document-quiz_05"></span><section id="quiz-5">
<h2>Quiz 5<a class="headerlink" href="#quiz-5" title="Permalink to this heading">#</a></h2>
<p>Quiz 5 involves one data file.
I zipped the notebook and data file into one file, but I cannot include zip files on this website.
Therefore, I posted this file to Canvas under <a class="reference external" href="https://northeastern.instructure.com/courses/137565/files/folder/Quiz%20Zips">Files/Quiz Zips</a>.
I linked this file from the Canvas assignment, too.
Download and extract this file, leaving the file names and relative positions as-is.</p>
</section>
<span id="document-quiz_06"></span><section id="quiz-6">
<h2>Quiz 6<a class="headerlink" href="#quiz-6" title="Permalink to this heading">#</a></h2>
<p>Quiz 6 involves one data file.
I zipped the notebook and data file into one file, but I cannot include zip files on this website.
Therefore, I posted this zip file to Canvas under <a class="reference external" href="https://northeastern.instructure.com/courses/137565/files/folder/Quiz%20Zips">Files/Quiz Zips</a>.
I linked this file from the Canvas assignment, too.
Download and extract this file, leaving any file names and relative locations as-is.</p>
</section>
<span id="document-quiz_07"></span><section id="quiz-7">
<h2>Quiz 7<a class="headerlink" href="#quiz-7" title="Permalink to this heading">#</a></h2>
<p>Quiz 7 involves one data file.
I zipped the notebook and data file into one file, but I cannot include zip files on this website.
Therefore, I posted this zip file to Canvas under <a class="reference external" href="https://northeastern.instructure.com/courses/137565/files/folder/Quiz%20Zips">Files/Quiz Zips</a>.
I linked this file from the Canvas assignment, too.
Download and extract this file, leaving any file names and relative locations as-is.</p>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-project_01"></span><section id="project-1">
<h2>Project 1<a class="headerlink" href="#project-1" title="Permalink to this heading">#</a></h2>
<p>Project 1 involves two data files.
I zipped the notebook and two data files into one file, but I cannot include zip files on this website.
Therefore, I posted this file to Canvas under <a class="reference external" href="https://northeastern.instructure.com/courses/137565/files/folder/Project%20Zips">Files/Project Zips/project_01.zip</a>.
I linked this file from the Canvas assignment, too.
Download and extract this file, leaving the file names and relative positions as-is.</p>
<div class="toctree-wrapper compound">
<span id="document-project_01_solution"></span><section id="project-1-solution">
<h3>Project 1 Solution<a class="headerlink" href="#project-1-solution" title="Permalink to this heading">#</a></h3>
</section>
<section id="purpose">
<h3>Purpose<a class="headerlink" href="#purpose" title="Permalink to this heading">#</a></h3>
<p>I have two goals for this project:</p>
<ol class="arabic simple">
<li><p>To help you master data manipulation and visualization</p></li>
<li><p>To help you understand the risk-return tradeoff for several measures of risk</p></li>
</ol>
</section>
<section id="tasks">
<h3>Tasks<a class="headerlink" href="#tasks" title="Permalink to this heading">#</a></h3>
<section id="packages-and-settings">
<h4>Packages and Settings<a class="headerlink" href="#packages-and-settings" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="o">%</span><span class="k">precision</span> 4
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data">
<h4>Data<a class="headerlink" href="#data" title="Permalink to this heading">#</a></h4>
<p>I used the following code cell to download the data for this project.
Leave this code cell commented out and use the CSV files I provided with this notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import yfinance as yf</span>
<span class="c1"># import pandas_datareader as pdr</span>
<span class="c1"># import requests_cache</span>
<span class="c1"># session = requests_cache.CachedSession(expire_after=1)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># wiki = pd.read_html(&#39;https://en.wikipedia.org/wiki/Russell_1000_Index&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># (</span>
<span class="c1">#     yf.Tickers(</span>
<span class="c1">#         tickers=wiki[2][&#39;Ticker&#39;].str.replace(pat=&#39;.&#39;, repl=&#39;-&#39;, regex=False).to_list(),</span>
<span class="c1">#         session=session</span>
<span class="c1">#     )</span>
<span class="c1">#     .history(period=&#39;max&#39;, auto_adjust=False)</span>
<span class="c1">#     .assign(Date = lambda x: x.index.tz_localize(None))</span>
<span class="c1">#     .set_index(&#39;Date&#39;)</span>
<span class="c1">#     .rename_axis(columns=[&#39;Variable&#39;, &#39;Ticker&#39;])</span>
<span class="c1">#     [&#39;Adj Close&#39;]</span>
<span class="c1">#     .pct_change()</span>
<span class="c1">#     .loc[&#39;1962&#39;:&#39;2022&#39;]</span>
<span class="c1">#     .to_csv(&#39;returns.csv&#39;)</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># (</span>
<span class="c1">#     pdr.DataReader(</span>
<span class="c1">#         name=&#39;F-F_Research_Data_Factors_daily&#39;,</span>
<span class="c1">#         data_source=&#39;famafrench&#39;,</span>
<span class="c1">#         start=&#39;1900&#39;,</span>
<span class="c1">#         session=session</span>
<span class="c1">#     )</span>
<span class="c1">#     [0]</span>
<span class="c1">#     .rename_axis(columns=&#39;Variable&#39;)</span>
<span class="c1">#     .div(100)</span>
<span class="c1">#     .loc[&#39;1962&#39;:&#39;2022&#39;]</span>
<span class="c1">#     .to_csv(&#39;ff.csv&#39;)</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
</div>
<p>Run the following code cell to read the data for this project.
The <code class="docutils literal notranslate"><span class="pre">returns.csv</span></code> file contains daily returns for the Russell 1000 stocks from 1962 through 2022, and the <code class="docutils literal notranslate"><span class="pre">ff.csv</span></code> contains daily Fama and French factors from 1962 through 2022.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;returns.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ff.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="single-stocks">
<h4>Single Stocks<a class="headerlink" href="#single-stocks" title="Permalink to this heading">#</a></h4>
<p>For this section, use the single stock returns in <code class="docutils literal notranslate"><span class="pre">returns</span></code>.
You may select years $t$ and $t+1$, but only use stocks with complete returns data for years $t$ and $t+1$.</p>
<section id="task-1-do-mean-returns-in-year-t-predict-mean-returns-in-year-t-1">
<h5>Task 1: Do mean returns in year $t$ predict mean returns in year $t+1$?<a class="headerlink" href="#task-1-do-mean-returns-in-year-t-predict-mean-returns-in-year-t-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="o">=</span> <span class="mi">2018</span>
<span class="n">time</span><span class="p">,</span> <span class="n">timep1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">ann</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mul</span> <span class="o">*</span> <span class="n">ann</span> <span class="o">*</span> <span class="n">ri</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">ann</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span> <span class="n">mul</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mul</span> <span class="o">*</span> <span class="n">ann</span> <span class="o">*</span> <span class="n">ri</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sharpe</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">ann</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ann</span> <span class="o">*</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">rm_rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]):</span>
    <span class="n">ri_rf</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ri_rf</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">rm_rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">rm_rf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ri_rf</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stats_all_ann</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">x</span>
        <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">sharpe</span><span class="p">,</span> <span class="n">beta</span><span class="p">])</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">([</span><span class="s1">&#39;Ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;Statistic&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="k">def</span> <span class="nf">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stats_corr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pct</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rho&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">x</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
                <span class="n">x</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">]},</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;All Values&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;Trim </span><span class="si">{</span><span class="n">pct</span><span class="si">}</span><span class="s1">% Outliers&#39;</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Sample&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Statistic&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">returns</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">time</span><span class="p">:</span><span class="n">timep1</span><span class="p">]</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">stats_all_ann</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>Statistic</th>
      <th colspan="2" halign="left">beta</th>
      <th colspan="2" halign="left">mean</th>
      <th colspan="2" halign="left">sharpe</th>
      <th colspan="2" halign="left">std</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>2018</th>
      <th>2019</th>
      <th>2018</th>
      <th>2019</th>
      <th>2018</th>
      <th>2019</th>
      <th>2018</th>
      <th>2019</th>
    </tr>
    <tr>
      <th>Ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A</th>
      <td>1.0995</td>
      <td>1.2094</td>
      <td>5.3336</td>
      <td>27.3691</td>
      <td>0.1305</td>
      <td>1.0312</td>
      <td>27.0755</td>
      <td>24.4681</td>
    </tr>
    <tr>
      <th>AA</th>
      <td>1.2903</td>
      <td>1.7639</td>
      <td>-60.6016</td>
      <td>-13.4767</td>
      <td>-1.3938</td>
      <td>-0.3970</td>
      <td>44.7694</td>
      <td>39.3309</td>
    </tr>
    <tr>
      <th>AAL</th>
      <td>1.3264</td>
      <td>1.5513</td>
      <td>-39.4041</td>
      <td>-3.7435</td>
      <td>-1.0287</td>
      <td>-0.1655</td>
      <td>40.0530</td>
      <td>35.5337</td>
    </tr>
    <tr>
      <th>AAP</th>
      <td>0.8528</td>
      <td>0.6426</td>
      <td>51.1971</td>
      <td>5.3710</td>
      <td>1.5344</td>
      <td>0.1220</td>
      <td>32.1921</td>
      <td>26.5124</td>
    </tr>
    <tr>
      <th>AAPL</th>
      <td>1.2410</td>
      <td>1.4751</td>
      <td>-1.4430</td>
      <td>67.1478</td>
      <td>-0.1128</td>
      <td>2.4871</td>
      <td>28.7421</td>
      <td>26.1383</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of Daily Returns (%) for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Return Predictability for Russell 1000 Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/30c30daf910fac43b106df83e10b554fde67f1d93e91fc833d9bec5dde2465b2.png" src="_images/30c30daf910fac43b106df83e10b554fde67f1d93e91fc833d9bec5dde2465b2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">stats_corr</span><span class="p">,</span> 
    <span class="n">sub</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Ann. Means of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_d17a2">
  <caption>Ann. Means of Daily Returns (%) for 2018 and 2019</caption>
  <thead>
    <tr>
      <th class="index_name level0" >Statistic</th>
      <th id="T_d17a2_level0_col0" class="col_heading level0 col0" >rho</th>
    </tr>
    <tr>
      <th class="index_name level0" >Sample</th>
      <th class="blank col0" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_d17a2_level0_row0" class="row_heading level0 row0" >All Values</th>
      <td id="T_d17a2_row0_col0" class="data row0 col0" >0.098793</td>
    </tr>
    <tr>
      <th id="T_d17a2_level0_row1" class="row_heading level0 row1" >Trim 5% Outliers</th>
      <td id="T_d17a2_row1_col0" class="data row1 col0" >-0.057586</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="task-2-does-volatility-in-year-t-predict-volatility-in-year-t-1">
<h5>Task 2: Does volatility in year $t$ predict volatility in year $t+1$?<a class="headerlink" href="#task-2-does-volatility-in-year-t-predict-volatility-in-year-t-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Vol. of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Vol. of Daily Returns (%) for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Volatility Predictability for Russell 1000 Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/334211fe16f96af2c93a1a01a48f1972c13a1b91839d07b70f2f98bf30f7b358.png" src="_images/334211fe16f96af2c93a1a01a48f1972c13a1b91839d07b70f2f98bf30f7b358.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">stats_corr</span><span class="p">,</span>
    <span class="n">sub</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Ann. Vol. of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_e3946">
  <caption>Ann. Vol. of Daily Returns (%) for 2018 and 2019</caption>
  <thead>
    <tr>
      <th class="index_name level0" >Statistic</th>
      <th id="T_e3946_level0_col0" class="col_heading level0 col0" >rho</th>
    </tr>
    <tr>
      <th class="index_name level0" >Sample</th>
      <th class="blank col0" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_e3946_level0_row0" class="row_heading level0 row0" >All Values</th>
      <td id="T_e3946_row0_col0" class="data row0 col0" >0.844335</td>
    </tr>
    <tr>
      <th id="T_e3946_level0_row1" class="row_heading level0 row1" >Trim 5% Outliers</th>
      <td id="T_e3946_row1_col0" class="data row1 col0" >0.792912</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="task-3-do-sharpe-ratios-in-year-t-predict-sharpe-ratios-in-year-t-1">
<h5>Task 3: Do Sharpe Ratios in year $t$ predict Sharpe Ratios in year $t+1$?<a class="headerlink" href="#task-3-do-sharpe-ratios-in-year-t-predict-sharpe-ratios-in-year-t-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sharpe Ratios of Daily Returns for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sharpe Ratios of Daily Returns for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio Predictability for Russell 1000 Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e3dc9052925f43561886a55396ac67bbe6c012b3e8a8169e53ac4dc7cfbd7cec.png" src="_images/e3dc9052925f43561886a55396ac67bbe6c012b3e8a8169e53ac4dc7cfbd7cec.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">stats_corr</span><span class="p">,</span> 
    <span class="n">sub</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Sharpe Ratios of Daily Returns for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_f5830">
  <caption>Sharpe Ratios of Daily Returns for 2018 and 2019</caption>
  <thead>
    <tr>
      <th class="index_name level0" >Statistic</th>
      <th id="T_f5830_level0_col0" class="col_heading level0 col0" >rho</th>
    </tr>
    <tr>
      <th class="index_name level0" >Sample</th>
      <th class="blank col0" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_f5830_level0_row0" class="row_heading level0 row0" >All Values</th>
      <td id="T_f5830_row0_col0" class="data row0 col0" >0.027713</td>
    </tr>
    <tr>
      <th id="T_f5830_level0_row1" class="row_heading level0 row1" >Trim 5% Outliers</th>
      <td id="T_f5830_row1_col0" class="data row1 col0" >0.042822</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="task-4-do-capm-betas-in-year-t-predict-capm-betas-in-year-t-1">
<h5>Task 4: Do CAPM betas in year $t$ predict CAPM betas in year $t+1$?<a class="headerlink" href="#task-4-do-capm-betas-in-year-t-predict-capm-betas-in-year-t-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beta of Daily Returns for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beta of Daily Returns for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Beta Predictability for Russell 1000 Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d2a2b7cd58b52766b7602be32ab3f9c97e0047ffa20d782aff6acc954085d755.png" src="_images/d2a2b7cd58b52766b7602be32ab3f9c97e0047ffa20d782aff6acc954085d755.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">stats_corr</span><span class="p">,</span> 
    <span class="n">sub</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Betas of Daily Returns for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_9a66e">
  <caption>Betas of Daily Returns for 2018 and 2019</caption>
  <thead>
    <tr>
      <th class="index_name level0" >Statistic</th>
      <th id="T_9a66e_level0_col0" class="col_heading level0 col0" >rho</th>
    </tr>
    <tr>
      <th class="index_name level0" >Sample</th>
      <th class="blank col0" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_9a66e_level0_row0" class="row_heading level0 row0" >All Values</th>
      <td id="T_9a66e_row0_col0" class="data row0 col0" >0.840941</td>
    </tr>
    <tr>
      <th id="T_9a66e_level0_row1" class="row_heading level0 row1" >Trim 5% Outliers</th>
      <td id="T_9a66e_row1_col0" class="data row1 col0" >0.800896</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="task-5-does-volatility-in-year-t-predict-mean-returns-in-year-t-1">
<h5>Task 5: Does volatility in year $t$ predict <em>mean returns</em> in year $t+1$?<a class="headerlink" href="#task-5-does-volatility-in-year-t-predict-mean-returns-in-year-t-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">df_1</span>
    <span class="p">[[(</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span>
    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Vol. of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of Daily Returns (%) for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Return Predictability for Russell 1000 Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/80612ca9a10798dc7f14f64e7f71af4b7fa050571db15f078fbc1409babd764d.png" src="_images/80612ca9a10798dc7f14f64e7f71af4b7fa050571db15f078fbc1409babd764d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">df_1</span>
    <span class="p">[[(</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span>
    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">stats_corr</span><span class="p">,</span> 
        <span class="n">sub</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1"> and Ann. Vol. of Daily Returns (%) for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_e376c">
  <caption>Ann. Mean of Daily Returns (%) for 2018 and Ann. Vol. of Daily Returns (%) for 2019</caption>
  <thead>
    <tr>
      <th class="index_name level0" >Statistic</th>
      <th id="T_e376c_level0_col0" class="col_heading level0 col0" >rho</th>
    </tr>
    <tr>
      <th class="index_name level0" >Sample</th>
      <th class="blank col0" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_e376c_level0_row0" class="row_heading level0 row0" >All Values</th>
      <td id="T_e376c_row0_col0" class="data row0 col0" >0.235243</td>
    </tr>
    <tr>
      <th id="T_e376c_level0_row1" class="row_heading level0 row1" >Trim 5% Outliers</th>
      <td id="T_e376c_row1_col0" class="data row1 col0" >0.119379</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="task-6-does-capm-beta-in-year-t-predict-mean-returns-in-year-t-1">
<h5>Task 6: Does CAPM beta in year $t$ predict <em>mean returns</em> in year $t+1$?<a class="headerlink" href="#task-6-does-capm-beta-in-year-t-predict-mean-returns-in-year-t-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">df_1</span>
    <span class="p">[[(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span>
    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beta of Daily Returns for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of Daily Returns (%) for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Return Predictability for Russell 1000 Stocks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/69919ea015c56e799bc9699a480a419dae146a583f0bb03b3eb7428b00dcb819.png" src="_images/69919ea015c56e799bc9699a480a419dae146a583f0bb03b3eb7428b00dcb819.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">df_1</span>
    <span class="p">[[(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span>
    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">stats_corr</span><span class="p">,</span> 
        <span class="n">sub</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1"> and Beta of Daily Returns for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_4794e">
  <caption>Ann. Mean of Daily Returns (%) for 2018 and Beta of Daily Returns for 2019</caption>
  <thead>
    <tr>
      <th class="index_name level0" >Statistic</th>
      <th id="T_4794e_level0_col0" class="col_heading level0 col0" >rho</th>
    </tr>
    <tr>
      <th class="index_name level0" >Sample</th>
      <th class="blank col0" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_4794e_level0_row0" class="row_heading level0 row0" >All Values</th>
      <td id="T_4794e_row0_col0" class="data row0 col0" >0.213337</td>
    </tr>
    <tr>
      <th id="T_4794e_level0_row1" class="row_heading level0 row1" >Trim 5% Outliers</th>
      <td id="T_4794e_row1_col0" class="data row1 col0" >0.138294</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
</section>
<section id="portfolios-i">
<h4>Portfolios I<a class="headerlink" href="#portfolios-i" title="Permalink to this heading">#</a></h4>
<p>For this section, create 100 random portfolios of 50 stocks each from the daily returns in <code class="docutils literal notranslate"><span class="pre">returns</span></code>.
Equally weight these portfolios and rebalance them daily.
Use the same stocks and years $t$ and $t+1$ as the previous section.</p>
<section id="task-7-does-volatility-in-year-t-predict-mean-returns-in-year-t-1">
<h5>Task 7: Does volatility in year $t$ predict <em>mean returns</em> in year $t+1$?<a class="headerlink" href="#task-7-does-volatility-in-year-t-predict-mean-returns-in-year-t-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_stocks</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">n_ports</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">df_2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">returns</span>
            <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">time</span><span class="p">:</span><span class="n">timep1</span><span class="p">]</span>
            <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_stocks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">i</span> 
            <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ports</span><span class="p">)</span>
        <span class="p">],</span> 
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">stats_all_ann</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">df_2</span>
    <span class="p">[[(</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span>
    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Vol. of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of Daily Returns (%) for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Return Predictability for Russell 1000 Stocks</span><span class="se">\n</span><span class="si">{</span><span class="n">n_ports</span><span class="si">}</span><span class="s1"> Random Portfolios of </span><span class="si">{</span><span class="n">n_stocks</span><span class="si">}</span><span class="s1"> Each&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/573cc03f0d0adb79613f05982c26fcdf13c9cb89357ce1216dd77d518097a36b.png" src="_images/573cc03f0d0adb79613f05982c26fcdf13c9cb89357ce1216dd77d518097a36b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">df_2</span>
    <span class="p">[[(</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span>
    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">stats_corr</span><span class="p">,</span> 
        <span class="n">sub</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1"> and Ann. Vol. of Daily Returns (%) for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_c6ede">
  <caption>Ann. Mean of Daily Returns (%) for 2018 and Ann. Vol. of Daily Returns (%) for 2019</caption>
  <thead>
    <tr>
      <th class="index_name level0" >Statistic</th>
      <th id="T_c6ede_level0_col0" class="col_heading level0 col0" >rho</th>
    </tr>
    <tr>
      <th class="index_name level0" >Sample</th>
      <th class="blank col0" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_c6ede_level0_row0" class="row_heading level0 row0" >All Values</th>
      <td id="T_c6ede_row0_col0" class="data row0 col0" >0.049628</td>
    </tr>
    <tr>
      <th id="T_c6ede_level0_row1" class="row_heading level0 row1" >Trim 5% Outliers</th>
      <td id="T_c6ede_row1_col0" class="data row1 col0" >0.105950</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<section id="comparison-of-single-stocks-and-portfolios">
<h6>Comparison of Single Stocks and Portfolios<a class="headerlink" href="#comparison-of-single-stocks-and-portfolios" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_1</span><span class="p">[[(</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Single Stocks&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Vol. of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of</span><span class="se">\n</span><span class="s1"> Daily Returns (%)</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df_2</span><span class="p">[[(</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_ports</span><span class="si">}</span><span class="s1"> Portfolios of </span><span class="si">{</span><span class="n">n_stocks</span><span class="si">}</span><span class="s1"> Each&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Return Predictability for Russell 1000 Stocks&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Vol. of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of</span><span class="se">\n</span><span class="s1"> Daily Returns (%)</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/934e9f1d711fa77c55dbb84c8cf3cf387177d54acf9e77d7110feb16fdb1a8a2.png" src="_images/934e9f1d711fa77c55dbb84c8cf3cf387177d54acf9e77d7110feb16fdb1a8a2.png" />
</div>
</div>
</section>
</section>
<section id="task-8-does-capm-beta-in-year-t-predict-mean-returns-in-year-t-1">
<h5>Task 8: Does CAPM beta in year $t$ predict <em>mean returns</em> in year $t+1$?<a class="headerlink" href="#task-8-does-capm-beta-in-year-t-predict-mean-returns-in-year-t-1" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">df_2</span>
    <span class="p">[[(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span>
    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beta of Daily Returns for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of Daily Returns (%) for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Return Predictability for Russell 1000 Stocks</span><span class="se">\n</span><span class="si">{</span><span class="n">n_ports</span><span class="si">}</span><span class="s1"> Random Portfolios of </span><span class="si">{</span><span class="n">n_stocks</span><span class="si">}</span><span class="s1"> Each&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/22203be4a07e24718f24fd49bbdf15058a9a5f5e4a3a23ade12389af335898ef.png" src="_images/22203be4a07e24718f24fd49bbdf15058a9a5f5e4a3a23ade12389af335898ef.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">df_2</span>
    <span class="p">[[(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span>
    <span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">stats_corr</span><span class="p">,</span> 
        <span class="n">sub</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Ann. Means of Daily Returns (%) for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1"> and Beta of Daily Returns for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_13355">
  <caption>Ann. Means of Daily Returns (%) for 2019 and Beta of Daily Returns for 2018</caption>
  <thead>
    <tr>
      <th class="index_name level0" >Statistic</th>
      <th id="T_13355_level0_col0" class="col_heading level0 col0" >rho</th>
    </tr>
    <tr>
      <th class="index_name level0" >Sample</th>
      <th class="blank col0" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_13355_level0_row0" class="row_heading level0 row0" >All Values</th>
      <td id="T_13355_row0_col0" class="data row0 col0" >0.030935</td>
    </tr>
    <tr>
      <th id="T_13355_level0_row1" class="row_heading level0 row1" >Trim 5% Outliers</th>
      <td id="T_13355_row1_col0" class="data row1 col0" >0.049911</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<section id="id1">
<h6>Comparison of Single Stocks and Portfolios<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_1</span><span class="p">[[(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Single Stocks&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beta of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of</span><span class="se">\n</span><span class="s1"> Daily Returns (%)</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df_2</span><span class="p">[[(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">timep1</span><span class="p">)]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timep1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_ports</span><span class="si">}</span><span class="s1"> Portfolios of </span><span class="si">{</span><span class="n">n_stocks</span><span class="si">}</span><span class="s1"> Each&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Return Predictability for Russell 1000 Stocks&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beta of Daily Returns (%) for </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ann. Mean of</span><span class="se">\n</span><span class="s1"> Daily Returns (%)</span><span class="se">\n</span><span class="s1"> for </span><span class="si">{</span><span class="n">timep1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6865e2c806fa782497cce539b1c0e31c90a652d5068966c826743b8b8d650b3f.png" src="_images/6865e2c806fa782497cce539b1c0e31c90a652d5068966c826743b8b8d650b3f.png" />
</div>
</div>
</section>
</section>
</section>
<section id="portfolios-ii">
<h4>Portfolios II<a class="headerlink" href="#portfolios-ii" title="Permalink to this heading">#</a></h4>
<p>Calculate monthly volatility and total return for <em>every stock</em> and <em>every month</em> in <code class="docutils literal notranslate"><span class="pre">returns</span></code>.
Drop stock-months with fewer than 15 returns.
Each month, assign these stocks to one of five portfolios based on their volatility during the previous month.
Equally weight these portfolios and rebalance them monthly.</p>
<section id="task-9-do-high-volatility-portfolios-have-high-mean-returns-and-sharpe-ratios">
<h5>Task 9: Do high volatility portfolios have high mean returns and Sharpe Ratios?<a class="headerlink" href="#task-9-do-high-volatility-portfolios-have-high-mean-returns-and-sharpe-ratios" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_3</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(),</span>
            <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(),</span>
            <span class="n">returns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="p">],</span> 
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;std_lag&#39;</span><span class="p">,</span> <span class="s1">&#39;count_lag&#39;</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">],</span> 
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">],</span> 
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(count_lag &gt;= 15) &amp; (count &gt;= 15)&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Portfolio</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)[</span><span class="s1">&#39;std_lag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_3</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Portfolio</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>731.0000</td>
      <td>731.0000</td>
      <td>731.0000</td>
      <td>731.0000</td>
      <td>731.0000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.0103</td>
      <td>0.0120</td>
      <td>0.0123</td>
      <td>0.0152</td>
      <td>0.0204</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0358</td>
      <td>0.0436</td>
      <td>0.0490</td>
      <td>0.0558</td>
      <td>0.0787</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.1472</td>
      <td>-0.2354</td>
      <td>-0.2503</td>
      <td>-0.2746</td>
      <td>-0.3272</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.0099</td>
      <td>-0.0117</td>
      <td>-0.0149</td>
      <td>-0.0170</td>
      <td>-0.0227</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.0132</td>
      <td>0.0151</td>
      <td>0.0157</td>
      <td>0.0174</td>
      <td>0.0182</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.0311</td>
      <td>0.0367</td>
      <td>0.0413</td>
      <td>0.0481</td>
      <td>0.0641</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.1329</td>
      <td>0.1950</td>
      <td>0.1781</td>
      <td>0.2206</td>
      <td>0.4369</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_4</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">df_3</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">ann</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
            <span class="n">df_3</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">ann</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">)),</span>
            <span class="n">df_3</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ff</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ann</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Standard Deviation&#39;</span><span class="p">,</span> <span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Statistic&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Statistic</th>
      <th>Mean</th>
      <th>Standard Deviation</th>
      <th>Sharpe Ratio</th>
    </tr>
    <tr>
      <th>Portfolio</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>12.3963</td>
      <td>12.4139</td>
      <td>0.6481</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14.3477</td>
      <td>15.0877</td>
      <td>0.6634</td>
    </tr>
    <tr>
      <th>3</th>
      <td>14.7852</td>
      <td>16.9639</td>
      <td>0.6159</td>
    </tr>
    <tr>
      <th>4</th>
      <td>18.1812</td>
      <td>19.3437</td>
      <td>0.7159</td>
    </tr>
    <tr>
      <th>5</th>
      <td>24.5168</td>
      <td>27.2776</td>
      <td>0.7387</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Portfolios Formed on Lagged Volatility</span><span class="se">\n</span><span class="s1"> for Russell 1000 Stocks from </span><span class="si">{</span><span class="n">df_3</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">df_3</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/35310c161a53b9b1614ef53e7f0bd75eb19d0cd15c21be1493cdb4a0cd16143f.png" src="_images/35310c161a53b9b1614ef53e7f0bd75eb19d0cd15c21be1493cdb4a0cd16143f.png" />
</div>
</div>
</section>
</section>
<section id="discussion">
<h4>Discussion<a class="headerlink" href="#discussion" title="Permalink to this heading">#</a></h4>
<section id="task-10-discuss-and-explain-any-limitations-of-your-analysis-above">
<h5>Task 10: Discuss and explain any limitations of your analysis above<a class="headerlink" href="#task-10-discuss-and-explain-any-limitations-of-your-analysis-above" title="Permalink to this heading">#</a></h5>
<ul class="simple">
<li><p>Selection bias</p>
<ul>
<li><p>Two years</p></li>
<li><p>Russell 1000 stocks</p></li>
</ul>
</li>
<li><p>Survivorship bias in Yahoo! Finance database</p></li>
<li><p>Could try larger portfolios and more portfolios</p></li>
<li><p>Means, volatilities, Sharpe Ratios, and $\beta$s are not the only measures of risk and return</p></li>
</ul>
</section>
</section>
</section>
<section id="criteria">
<h3>Criteria<a class="headerlink" href="#criteria" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>All tasks are worth ten points</p></li>
<li><p>Discuss and explain your findings for all ten tasks</p></li>
<li><p>Here are a few more tips</p>
<ol class="arabic simple">
<li><p><em><strong>Your goal is to convince me of your calculations and conclusions</strong></em></p></li>
<li><p>I typically find figures most convincing</p></li>
<li><p>If you use correlations, consider how a handful of outliers may affect your findings</p></li>
<li><p>Remove unnecessary code, outputs, and print statements</p></li>
<li><p>Write functions for calculations that you expect to use more than once</p></li>
<li><p><em><strong>I will not penalize code style, but I will penalize submissions that are difficult to follow or do not follow these instructions</strong></em></p></li>
</ol>
</li>
<li><p>How to submit your project</p>
<ol class="arabic simple">
<li><p>Restart your kernel, run all cells, and save your notebook</p></li>
<li><p>Export your notebook to PDF (<code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">&gt;</span> <span class="pre">Save</span> <span class="pre">And</span> <span class="pre">Export</span> <span class="pre">Notebook</span> <span class="pre">As</span> <span class="pre">...</span> <span class="pre">&gt;</span> <span class="pre">PDF</span></code> in JupyterLab)</p>
<ol class="arabic simple">
<li><p>If this export does not work, you can either (1) Install MikTeX on your laptop with the default settings or (2) use DataCamp Workspace to export your notebook to PDF</p></li>
<li><p>You do not need to re-run your notebook to export it because notebooks store output cells</p></li>
</ol>
</li>
<li><p>Upload your notebook and PDF to Canvas</p></li>
<li><p>Upload your PDF only to Gradescope and tag your teammates</p></li>
<li><p>Gradescope helps me give better feedback more quickly, but I do not consider it reliable for sharing and storing your submission files</p></li>
</ol>
</li>
</ol>
</section>
</div>
</section>
<span id="document-project_02"></span><section id="project-2">
<h2>Project 2<a class="headerlink" href="#project-2" title="Permalink to this heading">#</a></h2>
</section>
<section id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this heading">#</a></h2>
<p>This <a class="reference external" href="https://www.cnbc.com/2021/11/09/bitcoin-vs-gold-leading-gold-authorities-on-inflation-hedge-battle.html">November 2021 CNBC article</a> on Bitcoin and gold as inflation and market risk hedges motivated this project.
I have two goals for this project:</p>
<ol class="arabic simple">
<li><p>To help you master data analysis</p></li>
<li><p>To help you evaluate articles in the popular media using your data analysis skills</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="o">%</span><span class="k">precision</span> 2
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">pdr</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sco</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="tasks">
<h2>Tasks<a class="headerlink" href="#tasks" title="Permalink to this heading">#</a></h2>
<section id="task-1-do-bitcoin-and-gold-hedge-inflation-risk">
<h3>Task 1: Do Bitcoin and gold hedge inflation risk?<a class="headerlink" href="#task-1-do-bitcoin-and-gold-hedge-inflation-risk" title="Permalink to this heading">#</a></h3>
<p>Use the typical finance definition of <a class="reference external" href="https://www.investopedia.com/terms/h/hedge.asp">hedge</a>:</p>
<blockquote>
<div><p>To hedge, in finance, is to take an offsetting position in an asset or investment that reduces the price risk of an existing position. A hedge is therefore a trade that is made with the purpose of reducing the risk of adverse price movements in another asset. Normally, a hedge consists of taking the opposite position in a related security or in a derivative security based on the asset to be hedged.</p>
</div></blockquote>
<p>Here are a few suggestions:</p>
<ol class="arabic simple">
<li><p>Measure Bitcoin’s price with <a class="reference external" href="https://finance.yahoo.com/quote/BTC-USD?p=BTC-USD&amp;.tsrc=fin-srch">BTC-USD</a> and gold’s price with <a class="reference external" href="https://finance.yahoo.com/quote/GLD?p=GLD&amp;.tsrc=fin-srch">GLD</a></p></li>
<li><p>Throughout the project, assume Bitcoin and U.S. public equity markets have the same closing time</p></li>
<li><p>Measure the price level with <a class="reference external" href="https://fred.stlouisfed.org/series/PCEPI/">PCEPI</a> from the Federal Reserve Database (FRED), which is downloadable with <code class="docutils literal notranslate"><span class="pre">pdr.DataReader()</span></code></p></li>
<li><p>Measure inflation (i.e., the rate of change in the price level) as the percent change in PCEPI</p></li>
</ol>
</section>
<section id="task-2-do-bitcoin-and-gold-hedge-market-risk">
<h3>Task 2: Do Bitcoin and gold hedge market risk?<a class="headerlink" href="#task-2-do-bitcoin-and-gold-hedge-market-risk" title="Permalink to this heading">#</a></h3>
<p>Here are a few suggestions:</p>
<ol class="arabic simple">
<li><p>Estimate capital asset pricing model (CAPM) regressions for Bitcoin and gold</p></li>
<li><p>Use the daily factor data from Ken French</p></li>
</ol>
</section>
<section id="task-3-plot-the-mean-variance-efficient-frontier-of-standard-poor-s-100-index-sp100-stocks-with-and-without-bitcoin-and-gold">
<h3>Task 3: Plot the mean-variance efficient frontier of Standard &amp; Poor’s 100 Index (SP100) stocks, with and without Bitcoin and gold<a class="headerlink" href="#task-3-plot-the-mean-variance-efficient-frontier-of-standard-poor-s-100-index-sp100-stocks-with-and-without-bitcoin-and-gold" title="Permalink to this heading">#</a></h3>
<p>Here are a few suggestions:</p>
<ol class="arabic simple">
<li><p>You can learn about the SP100 stocks <a class="reference external" href="https://en.wikipedia.org/wiki/S%26P_100">here</a></p></li>
<li><p>Only consider days with complete data for Bitcoin and gold</p></li>
<li><p>Drop any stocks with shorter return histories than Bitcoin and gold</p></li>
<li><p>Assume long-only portfolios</p></li>
</ol>
</section>
<section id="task-4-find-the-maximum-sharpe-ratio-portfolio-of-sp100-stocks-with-and-without-bitcoin-and-gold">
<h3>Task 4: Find the maximum Sharpe Ratio portfolio of SP100 stocks, with and without Bitcoin and gold<a class="headerlink" href="#task-4-find-the-maximum-sharpe-ratio-portfolio-of-sp100-stocks-with-and-without-bitcoin-and-gold" title="Permalink to this heading">#</a></h3>
<p>Follow the data requirements of task 3.</p>
</section>
<section id="task-5-every-full-calendar-year-compare-the-frac-1-n-portfolio-with-the-out-of-sample-performance-of-the-previous-maximum-sharpe-ratio-portfolio">
<h3>Task 5: Every full calendar year, compare the $\frac{1}{n}$ portfolio with the out-of-sample performance of the previous maximum Sharpe Ratio portfolio<a class="headerlink" href="#task-5-every-full-calendar-year-compare-the-frac-1-n-portfolio-with-the-out-of-sample-performance-of-the-previous-maximum-sharpe-ratio-portfolio" title="Permalink to this heading">#</a></h3>
<p>Follow the data requirements of task 3.
Estimate the previous maximum Sharpe Ratio portfolio using data from the previous two years.
Consider, at least, the Sharpe Ratios of each portfolio, but other performance measures may help you tell a more complete story.</p>
</section>
<section id="task-6-what-do-you-conclude-about-bitcoin-and-gold-as-inflation-and-market-risk-hedges">
<h3>Task 6: What do you conclude about Bitcoin and gold as inflation and market risk hedges?<a class="headerlink" href="#task-6-what-do-you-conclude-about-bitcoin-and-gold-as-inflation-and-market-risk-hedges" title="Permalink to this heading">#</a></h3>
<p>What are your overall conclusions and limitations of your analysis?
What do the data suggest about the article that motivated this project?
Please see the link at the top of this notebook.</p>
</section>
</section>
<section id="criteria">
<h2>Criteria<a class="headerlink" href="#criteria" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><em><strong>Discuss and explain your findings for all 6 tasks, and be specific!</strong></em></p></li>
<li><p><em><strong>Your goal is to convince me of your calculations and conclusions</strong></em></p></li>
<li><p>All tasks are worth 16.67 points each</p></li>
<li><p>Your report should not exceed 25 pages</p></li>
<li><p>Here are more tips</p>
<ol class="arabic simple">
<li><p>Each task includes suggestions</p></li>
<li><p>I suggest you include plots and calculations for all but the last task</p></li>
<li><p>Remove unnecessary code, outputs, and print statements</p></li>
<li><p>Write functions for plots and calculations that you use more than once</p></li>
<li><p>I will not penalize code style, but I will penalize submissions that are difficult to follow or do not follow these instructions</p></li>
</ol>
</li>
<li><p>How to submit your project</p>
<ol class="arabic simple">
<li><p>Restart your kernel, run all cells, and save your notebook</p></li>
<li><p>Export your notebook to PDF (<code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">&gt;</span> <span class="pre">Save</span> <span class="pre">And</span> <span class="pre">Export</span> <span class="pre">Notebook</span> <span class="pre">As</span> <span class="pre">...</span> <span class="pre">&gt;</span> <span class="pre">PDF</span></code> in JupyterLab)</p>
<ol class="arabic simple">
<li><p>If this export does not work, you can either (1) Install MiKTeX on your laptop with default settings or (2) use DataCamp Workspace to export your notebook to PDF</p></li>
<li><p>You do not need to re-run your notebook to export it because notebooks store output cells</p></li>
</ol>
</li>
<li><p>Upload your notebook and PDF to Canvas</p></li>
<li><p>Upload your PDF only to Gradescope and tag your tasks and teammates</p></li>
<li><p>Gradescope helps me give better feedback more quickly, but it is not reliable for sharing and storing your submission files</p></li>
</ol>
</li>
</ol>
</section>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures and Practice</span></p>
<ul class="visible nav section-nav flex-column">
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_lecture">McKinney Chapter 2 - Python Language Basics, IPython, and Jupyter Notebooks</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_practice">McKinney Chapter 2 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_practice_03">McKinney Chapter 2 - Practice (Section 3, Monday 2:45 PM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_practice_04">McKinney Chapter 2 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_02_practice_02">McKinney Chapter 2 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_03_lecture">McKinney Chapter 3 - Built-In Data Structures, Functions, and Files</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_03_practice">McKinney Chapter 3 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_03_practice_04">McKinney Chapter 3 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_03_practice_02">McKinney Chapter 3 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_lecture">McKinney Chapter 4 - NumPy Basics: Arrays and Vectorized Computation</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_practice">McKinney Chapter 4 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_practice_03">McKinney Chapter 4 - Practice (Section 3, Monday 2:45 PM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_practice_04">McKinney Chapter 4 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_04_practice_02">McKinney Chapter 4 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_lecture">McKinney Chapter 5 - Getting Started with pandas</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_practice">McKinney Chapter 5 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_practice_03">McKinney Chapter 5 - Practice (Section 3, Monday 2:45 PM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_practice_04">McKinney Chapter 5 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_05_practice_02">McKinney Chapter 5 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_lecture">Herron Topic 1 - Web Data, Log and Simple Returns, and Portfolio Math</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_practice">Herron Topic 1 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_practice_03">Herron Topic 1 - Practice (Section 3, Monday 2:45 PM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_practice_04">Herron Topic 1 - Practice (Section 4, Wednesday 11:45 AM)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_01_practice_02">Herron Topic 1 - Practice (Section 2, Wednesday 2:45 PM)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_lecture">McKinney Chapter 8 - Data Wrangling: Join, Combine, and Reshape</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_practice">McKinney Chapter 8 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_practice_03">McKinney Chapter 8 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_practice_04">McKinney Chapter 8 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_08_practice_02">McKinney Chapter 8 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_10_lecture">McKinney Chapter 10 - Data Aggregation and Group Operations</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_10_practice">McKinney Chapter 10 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_10_practice_all">McKinney Chapter 10 - Practice (All Sections)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_lecture">McKinney Chapter 11 - Time Series</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_practice">McKinney Chapter 11 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_practice_03">McKinney Chapter 11 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_practice_04">McKinney Chapter 11 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-mckinney_11_practice_02">McKinney Chapter 11 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_lecture">Herron Topic 2 - Trading Strategies</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_practice">Herron Topic 2 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_practice_03">Herron Topic 2 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_practice_04">Herron Topic 2 - Practice (Monday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_02_practice_02">Herron Topic 2 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_lecture">Herron Topic 3 - Multifactor Models</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_practice">Herron Topic 3 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_practice_03">Herron Topic 3 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_practice_04">Herron Topic 3 - Practice (Monday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_03_practice_02">Herron Topic 3 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_lecture">Herron Topic 4 - Portfolio Optimization</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_practice">Herron Topic 4 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_practice_03">Herron Topic 4 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_practice_04">Herron Topic 4 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_04_practice_02">Herron Topic 4 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_lecture">Herron Topic 5 - Simulations</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_practice">Herron Topic 5 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_practice_03">Herron Topic 5 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_practice_04">Herron Topic 5 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_05_practice_02">Herron Topic 5 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_lecture">Herron Topic 6 - Size, Value, and Momentum Investing</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_practice">Herron Topic 6 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_practice_03">Herron Topic 6 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_practice_04">Herron Topic 6 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_06_practice_02">Herron Topic 6 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_lecture">Herron Topic 7 - Five Stylized Facts of Asset Returns</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_practice">Herron Topic 7 - Practice (Blank)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_practice_03">Herron Topic 7 - Practice (Monday 2:45 PM, Section 3)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_practice_04">Herron Topic 7 - Practice (Wednesday 11:45 AM, Section 4)</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-herron_07_practice_02">Herron Topic 7 - Practice (Wednesday 2:45 PM, Section 2)</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quizzes</span></p>
<ul class="nav section-nav flex-column">
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_01">Quiz 1</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_02">Quiz 2</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_03">Quiz 3</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_04">Quiz 4</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_05">Quiz 5</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_06">Quiz 6</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-quiz_07">Quiz 7</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul class="nav section-nav flex-column">
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-project_01">Project 1</a><ul class="nav section-nav flex-column">
<li class="toctree-l2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-project_01_solution">Project 1 Solution</a></li>
<li class="toctree-l2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#purpose">Purpose</a></li>
<li class="toctree-l2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#tasks">Tasks</a></li>
<li class="toctree-l2 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#criteria">Criteria</a></li>
</ul>
</li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#document-project_02">Project 2</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#purpose">Purpose</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#tasks">Tasks</a></li>
<li class="toctree-l1 nav-item toc-entry"><a class="reference internal nav-link" href="_introduction.html#criteria">Criteria</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Richard Herron
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>